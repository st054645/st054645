{"version":3,"file":"853.d641594eec93ebb852b9.chunk.js","mappings":"oIAmBA,MA2BA,EA3Be,CAACA,EAAmBC,EAAyB,MAC1D,MAAMC,EAA4BC,SAASC,cAAcH,EAAQI,MAAQ,MAAQ,UAuBjF,OAtBAH,EAAOF,UAAYA,GAAaC,EAAQK,KAAO,UAAYL,EAAQK,KAAO,IAEtEL,EAAQM,WACPN,EAAQO,cACTN,EAAOO,UAAUC,IAAI,cAGvB,OAAOR,IAGND,EAAQU,YACTT,EAAOO,UAAUC,IAAI,kBAGpBT,EAAQW,UACTV,EAAOW,aAAa,WAAY,QAG/BZ,EAAQa,MACTZ,EAAOa,QAAO,QAAKd,EAAQa,OAGtBZ,I,0DCnCM,MAAMc,UAAuB,IAC1CC,YAAYhB,GAIViB,MAAM,OAAD,QACHC,WAAW,GACRlB,IAGL,MAAMmB,EAAQC,KAAKD,MACnBA,EAAME,KAAO,MACbF,EAAMP,aAAa,WAAY,IAC/BO,EAAMG,aAAe,MAErB,IAAIC,EAAa,EACjBH,KAAKD,MAAMK,iBAAiB,SAAUC,IACpCL,KAAKD,MAAMX,UAAUkB,OAAO,SAC5BN,KAAKO,WAEL,MAAMC,EAAQR,KAAKQ,MAAMC,QAAQ,MAAO,IAAIC,MAAM,EAAG9B,EAAQ+B,QAC7DX,KAAKY,iBAAiBJ,GAEtB,MAAMG,EAASX,KAAKQ,MAAMG,OAC1B,GAAGA,IAAW/B,EAAQ+B,OACpB/B,EAAQiC,OAAOb,KAAKQ,YACf,GAAGG,IAAWR,EACnB,OAGFA,EAAaQ,Q,2DC5BJ,MAAMG,EAMnBlB,YAAsBmB,EAAkDC,GAAlD,KAAAD,mBAAAA,EAAkD,KAAAC,KAAAA,EAHjE,KAAAC,UAAY,EAIjBjB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,yBAGxB8B,OACL,OAAGnB,KAAKoB,YAAoBpB,KAAKoB,YAC1BpB,KAAKoB,YAAc,yBAAkC,CAC1DF,UAAWlB,KAAKkB,UAChBG,MAAM,EACNC,UAAU,EACVC,MAAOvB,KAAKgB,KACZQ,OAAQxB,KAAKgB,KACbS,SAAS,GAER,4BAA4BC,MAAMC,IAEnC3B,KAAK4B,UAAYD,EACjB3B,KAAK4B,UAAUxB,iBAAiB,cAAcyB,KAGX,IAA7B7B,KAAK4B,UAAUE,WAAmBD,GAAgB7B,KAAKiB,YAC1B,IAA9BjB,KAAK4B,UAAUE,WAAoBD,GAAgB7B,KAAKiB,aACvDjB,KAAK4B,UAAUG,SAAS,GACxB/B,KAAK4B,UAAUI,YAIrBhC,KAAKe,mBAAmBkB,4BAA8B,KACjDjC,KAAKe,mBAAmBmB,iBACzBlC,KAAK4B,UAAUO,aAAa,GAC5BnC,KAAK4B,UAAUQ,SAAW,EAC1BpC,KAAKiB,UAAY,GACjBjB,KAAK4B,UAAUS,SAEfrC,KAAK4B,UAAUO,cAAc,GAC7BnC,KAAK4B,UAAUQ,SAAW,GAC1BpC,KAAKiB,UAAY,EACjBjB,KAAK4B,UAAUS,SAIZ,sBAA+BV,MAInCrB,SACFN,KAAK4B,WACN5B,KAAK4B,UAAUtB,Y,2DCtDN,MAAMgC,EAWnB1C,YAAsB2C,EAAkCvB,GAAlC,KAAAuB,WAAAA,EAAkC,KAAAvB,KAAAA,EAR9C,KAAAwB,IAAM,GACN,KAAAvB,UAAY,EAQpBjB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,yBAE7B,MAAMU,EAAQwC,EAAWxC,MAEzBA,EAAMK,iBAAiB,QAAQ,KAC7BJ,KAAKyC,cAAc,MAGrB1C,EAAMK,iBAAiB,SAAUC,IAC/BL,KAAKyC,cAAcF,EAAW/B,MAAMG,WAUjC8B,cAAc9B,GACnB,IAAIX,KAAK4B,UAAW,OAGpB,IAAIc,GADJ/B,EAASgC,KAAKC,IAAIjC,EAAQ,MAGxB+B,EAAQC,KAAKE,MAAMF,KAAKC,IAAI5C,KAAKwC,IAAK7B,IAAW,IAAMX,KAAKwC,KAAO,OAEhExC,KAAK8C,gBACN9C,KAAK8C,cAAcC,MAAK,GACxB/C,KAAK8C,cAAcE,OAAOC,MAAMC,QAAU,QAG5ClD,KAAK4B,UAAUoB,OAAOC,MAAMC,QAAU,IAYtCR,EAAQ,EAIV,MAAMZ,EAAY9B,KAAKiB,UAAYyB,GAAS,EAAI,EAGhD1C,KAAK4B,UAAUO,aAAaL,GACN,IAAnB9B,KAAKiB,WAA6B,IAAVyB,GACzB1C,KAAK4B,UAAUG,SAAS,GAI1B/B,KAAKiB,UAAYyB,EAEjB1C,KAAK4B,UAAUS,OAMVlB,OACL,OAAGnB,KAAKoB,YAAoBpB,KAAKoB,YAC1BpB,KAAKoB,YAAc+B,QAAQC,IAAI,CACpC,yBAAkC,CAChClC,UAAWlB,KAAKkB,UAChBG,MAAM,EACNC,UAAU,EACVC,MAAOvB,KAAKgB,KACZQ,OAAQxB,KAAKgB,MACZ,4BAA4BU,MAAME,IACnC5B,KAAK8C,cAAgBlB,EAGjB5B,KAAKuC,WAAW/B,MAAMG,QACxBiB,EAAUS,OAGL,sBAA+BT,MAGxC,yBAAkC,CAChCV,UAAWlB,KAAKkB,UAChBG,MAAM,EACNC,UAAU,EACVC,MAAOvB,KAAKgB,KACZQ,OAAQxB,KAAKgB,MACZ,gCAAgCU,MAAMC,IACvC3B,KAAK4B,UAAYD,EAEb3B,KAAKuC,WAAW/B,MAAMG,SACxBX,KAAK4B,UAAUoB,OAAOC,MAAMC,QAAU,QAGxClD,KAAK4B,UAAUxB,iBAAiB,cAAcyB,KAIX,IAA7B7B,KAAK4B,UAAUE,WAAmBD,GAAgB7B,KAAKiB,YAC1B,IAA9BjB,KAAK4B,UAAUE,WAAoBD,GAAgB7B,KAAKiB,aACzDjB,KAAK4B,UAAUG,SAAS,GACxB/B,KAAK4B,UAAUI,SAGG,IAAjBH,GAAyC,IAAnB7B,KAAKiB,WAGzBjB,KAAK8C,gBACN9C,KAAK8C,cAAcE,OAAOC,MAAMC,QAAU,GAC1ClD,KAAK8C,cAAcT,OACnBrC,KAAK4B,UAAUoB,OAAOC,MAAMC,QAAU,WAMrC,sBAA+BvB,QAKrCrB,SACFN,KAAK4B,WAAW5B,KAAK4B,UAAUtB,SAC/BN,KAAK8C,eAAe9C,KAAK8C,cAAcxC,Y,oEC5I/B,MAAM+C,UAA2B,IAK9CzD,YAAYhB,EAA6B,IACvCiB,MAAM,OAAD,QACHC,WAAW,GACRlB,IAPA,KAAAsD,iBAAkB,EAyClB,KAAAoB,kBAAqBjD,KAC1B,OAAYA,GACZL,KAAKkC,iBAAmBlC,KAAKkC,gBAE7BlC,KAAKuD,cAAcnE,UAAUoE,OAAO,aAAcxD,KAAKkC,iBACtDlC,KAAKD,MAA2BE,KAAOD,KAAKkC,gBAAkB,OAAS,WACxElC,KAAKiC,6BAA+BjC,KAAKiC,+BArCzC,MAAMlC,EAAQC,KAAKD,MACnBA,EAAME,KAAO,WACbF,EAAMP,aAAa,WAAY,IAC/BO,EAAM0D,KAAO,qBACb1D,EAAMG,aAAe,MAUrB,MAAMwD,EAAW5E,SAASC,cAAc,SACxC2E,EAAStE,UAAUC,IAAI,YACvBqE,EAASC,UAAY,EACrBD,EAASzD,KAAO,WAChBF,EAAM6D,cAAcC,QAAQH,GAC5B3D,EAAM6D,cAAcE,aAAaJ,EAASK,YAAahE,EAAMiE,aAE7D,MAAMT,EAAgBvD,KAAKuD,cAAgBzE,SAASC,cAAc,QAClEwE,EAAcnE,UAAUC,IAAI,iBAAkB,SAE9CW,KAAKkB,UAAU9B,UAAUC,IAAI,wBAC7BW,KAAKkB,UAAUxB,OAAO6D,GAEtBA,EAAcnD,iBAAiB,QAASJ,KAAKsD,mBAC7CC,EAAcnD,iBAAiB,WAAYJ,KAAKsD,sB,2BCzC7C,SAASW,EAAaC,EAAeC,GAAY,GACtD,MAAMC,EAAO,wMAKb,GAAGD,EAAW,CACZ,MAAME,EAAMvF,SAASC,cAAc,OAQnC,OAPAsF,EAAIjF,UAAUC,IAAI,aAClBgF,EAAIC,UAAYF,EAEbF,GACDA,EAAKK,YAAYF,GAGZA,EAIT,OADAH,EAAKM,mBAAmB,YAAaJ,GAC9BF,EAAKO,iBAKP,SAASC,EAAgBR,EAAyBjF,EAAO,SAK9D,OAJAiF,EAAK9E,UAAUkB,OAAO,SAAWrB,GACjCiF,EAAK3E,UAAW,EAChB0E,EAAaC,GAEN,KACLA,EAAKI,UAAY,GACjBJ,EAAK9E,UAAUC,IAAI,SAAWJ,GAC9BiF,EAAKS,gBAAgB,a,gCAVzB,gBAA8BV,G,mGClB9B,IAAIW,EAAgB,EACL,SAASC,EACtBX,EACAY,EAAoD,KAAM3B,QAAQ4B,WAClEC,EAA8B,KAC9BnB,GAAU,EACVoB,EAAmBf,GAGnB,GAAGA,EAAKgB,cAAc,aAAc,OACpChB,EAAK9E,UAAUC,IAAI,MAEnB,IAUI8F,EAVAC,EAAItG,SAASC,cAAc,OAC/BqG,EAAEhG,UAAUC,IAAI,YAEC6E,EAAK9E,UAAUiG,SAAS,cAEvCD,EAAEhG,UAAUC,IAAI,aAGlB6E,EAAKL,EAAU,UAAY,UAAUuB,GAIrC,MAAME,EAAa,CAACC,EAAiBC,KACnC,MAAMC,EAAYC,KAAKC,MACjBzB,EAAOpF,SAASC,cAAc,OAE9B6G,EAAUhB,IAIViB,EAAgG,KAApFC,OAAOC,iBAAiBX,GAAGY,iBAAiB,qBAAqBvF,QAAQ,IAAK,IAGhG0E,EAAU,KAMR,IAAIc,EAAcP,KAAKC,MAAQF,EAC/B,MAAMS,EAAK,KAET,YAAqB,KACnBhC,EAAK5D,YAGJ0E,GAAOA,EAAMY,IAElB,GAAGK,EAAcJ,EAAU,CACzB,IAAIM,EAAQxD,KAAKH,IAAIqD,EAAWI,EAAaJ,EAAW,GACxDO,YAAW,IAAMlC,EAAK9E,UAAUC,IAAI,WAAWsD,KAAKH,IAAI2D,EAAQN,EAAW,EAAG,IAE9EO,WAAWF,EAAIC,QAEfjC,EAAK9E,UAAUC,IAAI,UACnB+G,WAAWF,EAAIL,EAAW,GAGxB,KACFC,OAAOO,oBAAoB,cAAelB,GAG5CA,EAAU,KACVmB,GAAkB,GAIpBxB,GAAYA,EAASc,GAenBE,OAAOS,uBAAsB,KAC3B,MAAMC,EAAOpB,EAAEqB,wBACfvC,EAAK9E,UAAUC,IAAI,oBAEnB,MAAMqH,EAASnB,EAAUiB,EAAKG,KACxBC,EAASpB,EAAUgB,EAAKK,IAGxB7F,EADS2B,KAAKmE,KAAK,SAACnE,KAAKoE,IAAIH,EAASJ,EAAKhF,OAAS,GAAKgF,EAAKhF,OAAS,EAAM,GAAI,SAACmB,KAAKoE,IAAIL,EAASF,EAAKjF,MAAQ,GAAKiF,EAAKjF,MAAQ,EAAM,IAIzIyF,EAAIN,EAAS1F,EAAO,EACpBiG,EAAIL,EAAS5F,EAAO,EAI1BkD,EAAKjB,MAAM1B,MAAQ2C,EAAKjB,MAAMzB,OAASR,EAAO,KAC9CkD,EAAKjB,MAAM0D,KAAOK,EAAI,KACtB9C,EAAKjB,MAAM4D,IAAMI,EAAI,KAgBrB7B,EAAE1F,OAAOwE,OAQTgD,EAAoB7G,GAAaA,EAAE8G,SAAWjD,IAChD,CAAC,SAAU,KAAKkD,SAAU/G,EAAE8G,OAAuBE,WAChD,OAAgBhH,EAAE8G,OAAuB,cAAgB/B,KAE5DH,IAAqBf,KACjB,OAAc7D,EAAE8G,OAAQlC,IAIhC,IAAIqB,GAAkB,EACtB,GAAG,IAAoB,CACrB,IAAIgB,EAAW,KACbnC,GAAWA,KAGbF,EAAiB7E,iBAAiB,cAAeC,IAC/C,IAAI,+BACF,OAIF,GAAGA,EAAEkH,QAAQ5G,OAAS,GAAK2F,GAAmBY,EAAiB7G,GAC7D,OAIFiG,GAAkB,EAElB,IAAI,QAACf,EAAO,QAAEC,GAAWnF,EAAEkH,QAAQ,GACnCjC,EAAWC,EAASC,GACpBP,EAAiB7E,iBAAiB,WAAYkH,EAAU,CAACE,MAAM,IAE/D1B,OAAO1F,iBAAiB,aAAcC,IACpCA,EAAEoH,cAAe,EACjBpH,EAAEqH,kBACFJ,IACArC,EAAiBoB,oBAAoB,WAAYiB,KAChD,CAACE,MAAM,MACT,CAACG,SAAS,SAEb1C,EAAiB7E,iBAAiB,aAAcC,IAC9C,IAAI,CAAC,EAAG,GAAG+G,SAAS/G,EAAExB,QACpB,OAGF,IAAI,+BACF,OAIF,GAAuC,MAApCoG,EAAiB2C,QAAQ/C,QAAkBqC,EAAiB7G,GAC7D,OACK,GAAGiG,EAER,YADAA,GAAkB,GAIpB,IAAI,QAACf,EAAO,QAAEC,GAAWnF,EACzBiF,EAAWC,EAASC,GACpBM,OAAO1F,iBAAiB,UAAW+E,EAAS,CAACqC,MAAM,EAAMG,SAAS,IAClE7B,OAAO1F,iBAAiB,cAAe+E,EAAS,CAACqC,MAAM,EAAMG,SAAS,MACrE,CAACA,SAAS,M,6EC1LV,MAAME,EAAa,4CACpBC,EAAS,YAETC,EAA6B,CACjC,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,EAAG,IACH,IAAK,KAGA,SAASC,EAAqBvI,GACnC,OAAOA,EAAKgB,QAAQoH,EAAY,IAAIpH,QAAQqH,EAAQ,IAiBvC,SAASG,EAAgBxI,EAAcyI,GAAW,GAC/D,OAAOC,EAAkB1I,EAAM,CAC7B2I,eAAe,EACfF,SAAAA,EACAG,YAAY,IAWT,SAASF,EAAkB1I,EAAcb,EAAoC,IAClF,MAAM0J,EAAS1J,EAAQ2J,YAAiC,MAAnB9I,EAAK+I,OAAO,GAC3CC,EAAehJ,EAMrB,OALGb,EAAQwJ,gBAAe3I,EAAOuI,EAAqBvI,IACnDb,EAAQsJ,WAAUzI,EA1BhB,SAAwBA,GAC7B,OAAOA,EAAKgB,QAAQ,iBAAkBiI,IACpC,MAAMC,EAAa,IAAYD,GAC/B,OAAOC,MAAAA,EAAAA,EAAcD,KAuBKE,CAAenJ,IACxCb,EAAQyJ,aAAY5I,EAAOA,EAAKoJ,eAChCP,IAAQ7I,EAAO,IAAMA,GACrBb,EAAQsJ,WAAUzI,GAAQ,IApCxB,SAAqBA,GAC1B,OAAOA,EAAKoJ,cAAcpI,QAAQ,YAAaiI,IAC7C,MAAMC,EAAaZ,EAAIW,GACvB,OAAOC,MAAAA,EAAAA,EAAcD,KAiCeI,CAAYL,IAC3ChJ,I,iGCnFF,MAAMsJ,EAA8D,IAAqB,YAAc,QAEvG,SAASC,EAAiB9E,EAA4BY,EAAsDlG,EAA8B,IAC/I,MAAMS,EAAMT,EAAQqK,eAAiBrK,EAAQqK,eAAe5J,IAAI6E,GAAQA,EAAK9D,iBAAiB8I,KAAKhF,GAGnGtF,EAAQuK,gBAAiB,EA4BzB9J,EAAI0J,EAAkBjE,EAAUlG,GAG3B,SAASwK,EAAiBlF,EAAmBY,EAAsDlG,GAItGsF,EAAKmC,oBAAoB0C,EAAkBjE,EAAUlG,GAIlD,SAASyK,EAAmBnF,IACjC,OAAcA,EAAM6E,K,4BClDP,SAASO,EAAWlF,GACjC,MAAMmF,EAAOzK,SAASC,cAAc,QAGpC,MAFoB,iBAAX,EAAqBwK,EAAKjF,UAAYF,EAC1CmF,EAAK7J,OAAO0E,GACVmF,E,0GCkET,MAAMC,EAAgB,IAjEtB,oBACU,KAAAC,SAGH,GACG,KAAAC,IAAM,UAAa,MACnB,KAAAC,WAAY,EAEZC,GAAGC,EAAuC/E,GAChD,IAAIgF,EAAU9J,KAAKyJ,SAASI,GAU5B,OATIC,IACF9J,KAAK+J,gBACLD,EAAU9J,KAAKyJ,SAASI,IAAQ,eAGlBG,IAAblF,GACDgF,EAAQpI,MAAK,IAAMoD,MAGdgF,EAGFG,QAAQnF,GACb,OAAO9E,KAAK4J,GAAG,OAAQ9E,GAGlBoF,OAAOpF,GACZ,OAAO9E,KAAK4J,GAAG,QAAS9E,GAQnBqF,cAAcC,EAAsBtF,GACzC,MAAMuF,GAAc,OAAQD,GACtBN,EAAUO,EAAcrK,KAAKkK,SAAW/G,QAAQ4B,UAUtD,YARgBiF,IAAblF,IACEuF,EACDvF,IAEAgF,EAAQpI,MAAK,IAAMoD,OAIhBgF,EAGDC,gBACF/J,KAAK2J,YACP3J,KAAK2J,WAAY,EAEjB3J,KAAK0J,KAAI,KACP1J,KAAKyJ,SAASa,MAAQtK,KAAKyJ,SAASa,KAAKvF,UACzC/E,KAAKyJ,SAASc,OAASvK,KAAKyJ,SAASc,MAAMxF,UAE3C/E,KAAK2J,WAAY,EACjB3J,KAAKyJ,SAAW,SAOxB,OAAmB,mBAA+BD,GAClD,W,8OCjEO,MAAMgB,EAKX5K,YACS6D,EACAxD,EACCwK,GAAY,EACpB9L,EACA+L,GAAY,EACLC,GAAa,EACbC,GANA,KAAAnH,KAAAA,EACA,KAAAxD,KAAAA,EACC,KAAAwK,UAAAA,EAGD,KAAAE,WAAAA,EACA,KAAAC,QAAAA,EAEP5K,KAAK6K,KAAO,oBACZ7K,KAAKkB,UAAYpC,SAASC,cAAc,OACrCJ,IAAWqB,KAAKkB,UAAUvC,UAAYA,GAEtC8E,IACDzD,KAAK8K,OAAShM,SAASC,cAAc,OACrCiB,KAAK8K,OAAO1L,UAAUC,IAAI,sBACN,iBAAX,GACPW,KAAK8K,OAAOpL,QAAO,QAAK+D,IAE1BzD,KAAKkB,UAAUxB,OAAOM,KAAK8K,SAG7B9K,KAAKkB,UAAU9B,UAAUC,IAAI,eAAgB,gBAAkBY,GAC/DD,KAAKkB,UAAUxB,OAAOM,KAAK6K,MAC3B7K,KAAKkB,UAAU+B,MAAMC,QAAU,OAE5BwH,GACD,wBAAuC1K,KAAK6K,KAAMD,OAASZ,EAAWW,GAI1EI,QACE/K,KAAKkB,UAAU+B,MAAMC,QAAU,OAE5BlD,KAAKyK,YACNzK,KAAK6K,KAAKvG,UAAY,IAI1B0G,YACEhL,KAAKkB,UAAU+B,MAAMC,QAAU,GAGjCM,SACKxD,KAAK6K,KAAKI,kBACXjL,KAAKgL,YAELhL,KAAK+K,SAOI,MAAMG,EAiBnBtL,YAAmBsB,EAA+BiK,EAAiCC,EAAgEC,GAAhI,KAAAnK,UAAAA,EAA+B,KAAAiK,YAAAA,EAAiC,KAAAC,aAAAA,EAAgE,KAAAC,SAAAA,EAhB3I,KAAAC,SAAW,EACX,KAAAC,aAAe,EACf,KAAAC,YAAc,EAEd,KAAAC,cAA+B,KAC/B,KAAAC,cAAwB,EAExB,KAAAC,MAAQ,GAER,KAAAC,eAAiC,KAGjC,KAAAC,SAAW,EAKjB7L,KAAK8L,WAAa,IAAI,KAAW9L,KAAKkB,WACtClB,KAAK4L,eAAiB5L,KAAK8L,WAAW5K,UACtC,IAAI,IAAI6K,KAAK/L,KAAKoL,aAChBpL,KAAK4L,eAAelM,OAAOM,KAAKoL,aAAaW,GAAsB7K,WAGlElB,KAAKoL,aAAaY,UACnBhM,KAAK8L,WAAWG,oBAAoBjM,KAAKoL,aAAaY,SAASnB,MAGjE7K,KAAKmL,YAAYe,SAAY1L,IAM3BR,KAAK2L,MAAQnL,EACbR,KAAKmM,OAAM,GACXnM,KAAKoM,cAGPpM,KAAK8L,WAAWO,iBAAmB,KAC7BrM,KAAK2L,MAAMW,SAEXtM,KAAK0L,gBACP1L,KAAK0L,cAAgB5F,OAAOM,YAAW,KACrCpG,KAAKoM,aACLpM,KAAK0L,cAAgB,IACpB,MAKFS,MAAM/I,GAAM,GACdA,IACDpD,KAAKmL,YAAY3K,MAAQ,GACzBR,KAAK2L,MAAQ,GACb3L,KAAKuM,YAASvC,EACdhK,KAAK6L,SAAW,GAGlB7L,KAAKsL,SAAW,EAChBtL,KAAKuL,aAAe,EACpBvL,KAAKwL,YAAc,EAEnB,IAAI,IAAIO,KAAK/L,KAAKoL,aAChBpL,KAAKoL,aAAaW,GAAsBhB,QAG1C/K,KAAKyL,cAAgB,KAGhBe,YAAYD,EAAiBV,EAAW,EAAGF,EAAQ,IACxD3L,KAAKuM,OAASA,EACdvM,KAAK6L,SAAWA,EAEb7L,KAAK2L,QAAUA,IAChB3L,KAAKmL,YAAY5I,WAAW/B,MAAQmL,GAGtC3L,KAAKmL,YAAYpL,MAAM0M,QAGlBL,aACL,GAAGpM,KAAKyL,cAAe,OAAOzL,KAAKyL,cAEnC,MAAME,EAAQ3L,KAAK2L,MAEnB,IAAIA,EAAMW,OAER,YADAtM,KAAKqL,UAAYrL,KAAKqL,SAAS,IAIjC,IAAwB,IAArBrL,KAAKwL,YAAqBxL,KAAKuL,aAAevL,KAAKwL,WACpD,OAAOrI,QAAQ4B,UAGjB,MAAM2H,EAAQ1M,KAAKsL,UAAY,EAE/B,OAAOtL,KAAKyL,cAAgB,0CAAgD,CAC1Ec,OAAQvM,KAAKuM,OACbZ,MAAAA,EACAgB,YAAa,CAACC,EAAG,4BACjBF,MAAAA,EACAG,MAAO,GACPhB,SAAU7L,KAAK6L,WACdnK,MAAMoL,IAGP,GAFA9M,KAAKyL,cAAgB,KAElBzL,KAAKmL,YAAY3K,QAAUmL,EAC5B,OAKF,MAAM,MAACoB,EAAK,QAAEC,GAAWF,EAEtBE,EAAQrM,QAAUqM,EAAQ,GAAGC,MAAQjN,KAAKsL,UAC3C0B,EAAQE,QAGV,MAAMC,EAAcnN,KAAKoL,aAAaY,SAEtCgB,EAAQI,SAASC,IACf,IACE,MAAMd,EAASvM,KAAKuM,OAASc,EAAQC,OAASD,EAAQd,OACtD,8BAA6C,CAC3CA,OAAAA,EACArL,UAAWlB,KAAK8L,WAChByB,WAAY,GACZC,WAAW,EACXH,QAAAA,EACA1B,MAAAA,IAEF,MAAM8B,GACNC,QAAQC,MAAM,mCAAoCF,OAItDN,EAAY3J,SAEZxD,KAAKsL,SAAW0B,EAAQrM,QAAUqM,EAAQA,EAAQrM,OAAS,GAAGsM,KAErC,IAAtBjN,KAAKuL,cACNvL,KAAKuL,YAAc,GAErBvL,KAAKuL,aAAeyB,EAAQrM,QAEJ,IAArBX,KAAKwL,aACNxL,KAAKwL,WAAauB,EAEfI,EAAYrC,SACb,EAAA8C,EAAA,GAAeT,EAAYrC,QAAQ,QAAKiC,EAAQ,4BAA8B,8BAA+B,CAACA,KAGhH/M,KAAKqL,UAAYrL,KAAKqL,SAASrL,KAAKwL,gBAErCqC,OAAOJ,IACRC,QAAQC,MAAM,eAAgBF,GAC9BzN,KAAKyL,cAAgB,S,aC3NZ,MAAMqC,EAWnBlO,YAAYmO,EAA0B7B,GAL/B,KAAA8B,UAAY,GACZ,KAAAC,QAAU,EA+BjB,KAAAC,QAAU,KACR,IAAIlO,KAAKkM,SAAU,OAEnB,IAAI1L,EAAQR,KAAKQ,MAIdA,IAAUR,KAAKgO,YAChBhO,KAAKgO,UAAYxN,EACjB2N,aAAanO,KAAKiO,SAClBjO,KAAKiO,QAAUnI,OAAOM,YAAW,KAC/BpG,KAAKkM,SAAS1L,KACb,OAIP,KAAA4N,aAAe,KACbpO,KAAKQ,MAAQ,GACbR,KAAKkM,UAAYlM,KAAKkM,SAAS,IAC/BlM,KAAKqO,SAAWrO,KAAKqO,WA7CrBrO,KAAKuC,WAAa,IAAI,IAAW,CAC/BwL,YAAAA,EACAjO,WAAW,IAGbE,KAAKkB,UAAYlB,KAAKuC,WAAWrB,UACjClB,KAAKkB,UAAU9B,UAAUkB,OAAO,eAChCN,KAAKkB,UAAU9B,UAAUC,IAAI,gBAE7BW,KAAKkM,SAAWA,EAEhBlM,KAAKD,MAAQC,KAAKuC,WAAWxC,MAC7BC,KAAKD,MAAMX,UAAUC,IAAI,sBAEzB,MAAMiP,EAAaxP,SAASC,cAAc,KAC1CuP,EAAWlP,UAAUC,IAAI,QAAS,gBAElCW,KAAKuO,SAAWzP,SAASC,cAAc,KACvCiB,KAAKuO,SAASnP,UAAUC,IAAI,QAAS,WAAY,eAEjDW,KAAKD,MAAMK,iBAAiB,QAASJ,KAAKkO,SAC1ClO,KAAKuO,SAASnO,iBAAiB,QAASJ,KAAKoO,cAE7CpO,KAAKkB,UAAUxB,OAAO4O,EAAYtO,KAAKuO,UAyBrC/N,YACF,OAAOR,KAAKuC,WAAW/B,MAGrBA,UAAMA,GACRR,KAAKgO,UAAYxN,EACjB2N,aAAanO,KAAKiO,SAClBjO,KAAKuC,WAAW/B,MAAQA,EAGnBF,SACL6N,aAAanO,KAAKiO,SAClBjO,KAAKD,MAAMsG,oBAAoB,QAASrG,KAAKkO,SAC7ClO,KAAKuO,SAASlI,oBAAoB,QAASrG,KAAKoO,e,qDC3EpD,MASA,EATmB,CAACzP,EAAoBC,EAAuE,MAC9F,OAAO,WAAY,OAAF,QAC9BK,KAAMN,QAAaqL,GAChBpL,ICkBQ,MAAM4P,EAgBnB5O,YAAY6O,EAAuBC,GACjC1O,KAAK2O,aAAaF,EAAQC,GAGrBC,aAAaF,EAAuBC,GAAc,GACvD1O,KAAKyO,OAASA,EACdzO,KAAK0O,YAAcA,EAEnB1O,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,WAAY,uBAGzCW,KAAK4O,OAAS9P,SAASC,cAAc,OACrCiB,KAAK4O,OAAOxP,UAAUC,IAAI,kBAE1BW,KAAK6O,SAAW,EAAW,4BAA6B,CAAC3P,UAAU,IACnEc,KAAK8O,MAAQhQ,SAASC,cAAc,OACpCiB,KAAK8O,MAAM1P,UAAUC,IAAI,yBACzBW,KAAK4O,OAAOlP,OAAOM,KAAK6O,SAAU7O,KAAK8O,OAGvC9O,KAAK+O,QAAUjQ,SAASC,cAAc,OACtCiB,KAAK+O,QAAQ3P,UAAUC,IAAI,mBAE3BW,KAAK8L,WAAa,IAAI,KAAW9L,KAAK+O,aAAS/E,OAAWA,GAAW,GAErEhK,KAAKkB,UAAUxB,OAAOM,KAAK4O,OAAQ5O,KAAK+O,SAErC/O,KAAKyO,QACNzO,KAAKyO,OAAOO,OAAOhP,MAGrBA,KAAKiJ,eAAiB,IAAI,IAGrBgG,QACL,OAAOjP,KAAKyO,OAAOS,SAASlP,MAGjBmP,QAAQC,G,qCACnB,GAAGpP,KAAKqP,KACN,IACE,MAAMC,EAAStP,KAAKqP,OACpBrP,KAAKqP,KAAO,KAETC,aAAkBnM,gBACbmM,GAER,MAAM7B,GACNC,QAAQC,MAAM,iBAAkBF,GAIpCzN,KAAKyO,OAAOc,UAAUvP,O,+RAGdqP,QAIHG,sBACFxP,KAAK0O,cACN1O,KAAKyO,OAAOgB,KAAKC,OAAO1P,MACxBA,KAAKkB,UAAUZ,UAGdN,KAAKiJ,gBACNjJ,KAAKiJ,eAAe0G,YAIdC,SAASC,GACjB7P,KAAK8O,MAAMxK,UAAY,GACvBtE,KAAK8O,MAAMpP,QAAO,QAAKmQ,KAIpB,MAAMC,UAAgCtB,EAK3C5O,YAAY6O,GACV5O,MAAM4O,GACNzO,KAAK+P,cAAgB,IAAI,IAG3BP,sBAGE,OAFAxP,KAAK+P,cAAcC,cAAc,WACjChQ,KAAK+P,cAAcE,UACZpQ,MAAM2P,uB,wBCnHF,MAAMU,EAUnBtQ,YAAYhB,GARL,KAAAuR,cAA6C,GAI5C,KAAAC,cAAe,EA2BhB,KAAAC,gBAAkB,KACVC,EAAA,iBAAuCtQ,KAAKuQ,gBAEvDD,EAAA,OAA6BtQ,KAAKuQ,gBAC1BvQ,KAAKmQ,cAAcxP,QAC3BX,KAAKkP,SAASlP,KAAKmQ,cAAcnQ,KAAKmQ,cAAcxP,OAAS,KAK1D,KAAAuO,SAAW,CAACsB,EAA8BC,EAAmBC,KAClE,QAAU1G,IAAPwG,GAAoBxQ,KAAKmQ,cAAcnQ,KAAKmQ,cAAcxP,OAAS,KAAO6P,EAC3E,OAAO,EAIT,MAAMG,EAAY3Q,KAAKmQ,cAAcS,MACrC5Q,KAAK6Q,WAAWF,EAAWF,EAASC,GAEpC,MAAMI,EAAM9Q,KAAKmQ,cAAcnQ,KAAKmQ,cAAcxP,OAAS,GAE3D,OADAX,KAAK+Q,gBAAmB/G,IAAR8G,EAAqBA,aAAetC,EAAiBsC,EAAI5P,UAAY4P,EAAQ9Q,KAAKoQ,cAAgB,EAAI,EAAIK,IACnH,IAtCP,EAAAO,EAAA,GAAWhR,KAAMpB,GAEboB,KAAKyP,OACPzP,KAAKyP,KAAO,IAAIwB,KAGlBjR,KAAKkR,cAAgBlR,KAAKmR,UAAUjM,cAAc,mBAClDlF,KAAK+Q,YAAa,OAAiB/Q,KAAKkR,cAAe,aA5BnC,KA6BhBlR,KAAKoQ,cACPpQ,KAAK+Q,WAAW,GAGlBK,MAAMC,KAAKrR,KAAKmR,UAAUG,iBAAiB,0BAAkDlE,SAASmE,KACpG,QAAiBA,EAAIvR,KAAKqQ,oBA4BvBd,UAAUiB,GAKf,GAAGxQ,KAAKmQ,cAAcnQ,KAAKmQ,cAAcxP,OAAS,KAAO6P,EACvD,OAAO,EAGT,MAAMM,EAAiBN,aAAchC,EAAiBgC,EAAKxQ,KAAKyP,KAAK+B,IAAIhB,GAyBzE,OAxBGM,IACEA,EAAIW,QACLX,EAAIW,SAGHX,EAAIY,oBACLtL,YAAW,KACT0K,EAAIY,uBA/EU,MAqFlBpB,EAAA,WAAiC,CAC/BrQ,KAAMD,KAAKuQ,eACXoB,MAAQC,IACN5R,KAAKkP,cAASlF,EAAW4H,GAAY,IAC9B,KAKb5R,KAAKmQ,cAAc0B,KAAKrB,GACxBxQ,KAAK+Q,WAAWP,aAAchC,EAAiBgC,EAAGtP,UAAYsP,IACvD,EAGFsB,qBAAqBtB,IAC1B,EAAAuB,EAAA,GAAiB/R,KAAKmQ,cAAeK,GACrCxQ,KAAK6Q,WAAWL,OAAIxG,GAGfgI,kBAAkBC,EAA6CC,GACpE,IAAI,IAAInG,EAAI/L,KAAKmQ,cAAcxP,OAAS,EAAGoL,GAAK,IAAKA,EAAG,CACtD,MAAM+E,EAAM9Q,KAAKmQ,cAAcpE,GAC/B,GAAG+E,IAAQoB,EAAX,CACK,GAAGpB,aAAemB,EACrB,MAGFjS,KAAK8R,qBAAqBhB,KAKvBqB,OAAiCF,GACtC,OAAOjS,KAAKmQ,cAAciC,MAAMC,GAAMA,aAAaJ,IAG9CK,YAAYL,GACjB,QAASjS,KAAKmS,OAAOF,GAGbpB,WAAWL,EAA6BC,EAAkBC,GAC9DA,GACFJ,EAAA,eAAqCtQ,KAAKuQ,gBAAgB,GAG5D,MAAMO,EAAiBN,aAAchC,EAAiBgC,EAAKxQ,KAAKyP,KAAK+B,IAAIhB,GACtEM,IACEA,EAAIyB,SACLzB,EAAIyB,UAGHzB,EAAItB,qBACLpJ,YAAW,KACT0K,EAAItB,wBA1IU,MAgJfR,OAAO8B,GACRA,EAAI5P,UAAU0C,gBAChB5D,KAAKkR,cAAcxR,OAAOoR,EAAI5P,WAE3B4P,EAAIjC,UACLiC,EAAIjC,SAASzO,iBAAiB,QAASJ,KAAKqQ,kBAK3CmC,UAAoCC,EAAsCC,GAC/E,MAAM5B,EAAM,IAAI2B,EAAKC,OAAc1I,EAAYhK,MAAM,GAErD,OADA8Q,EAAI6B,SAAW3S,KAAK2S,SACb7B,G,wBChKI,MAAM8B,EAKnBhT,YAAYsM,GACVlM,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,eAE7BW,KAAKgD,OAASlE,SAASC,cAAc,UACrCiB,KAAKgD,OAAO5D,UAAUC,IAAI,sBAE1BW,KAAKf,KAAOH,SAASC,cAAc,QACnCiB,KAAKf,KAAKG,UAAUC,IAAI,QAAS,mBAEjCW,KAAKkB,UAAUxB,OAAOM,KAAKgD,OAAQhD,KAAKf,OAExC,QAAiBe,KAAKkB,WAAW,KAC/B,gBAAyB,KAAaiO,KAAKnP,KAAKgD,OAAQkJ,MAIrDnB,QACO/K,KAAKgD,OAAO6P,WAAW,MAC/BC,UAAU,EAAG,EAAG9S,KAAKgD,OAAOzB,MAAOvB,KAAKgD,OAAOxB,SC5BvD,MAKA,EALqB,CAAC5C,EAAwG,MAC7G,OAAO,mCAAqCA,EAAQD,UAAY,IAAMC,EAAQD,UAAY,IAAKC,G,aCAzG,MAAMmU,EAAS,CAAC,UAAW,WAAY,QAAS,QAAS,MAAO,OAAQ,OAAQ,SAAU,YAAa,UAAW,WAAY,YACxHC,EAAO,CAAC,SAAU,SAAU,UAAW,YAAa,WAAY,SAAU,YAE1EC,EAAU,MAGVC,EAAiBC,IAC5B,MAAMC,EAAI,IAAI1N,KAAKA,KAAK2N,IAAIF,EAAKG,cAAeH,EAAKI,WAAYJ,EAAKK,YAChEC,EAASL,EAAEM,aAAe,EAChCN,EAAEO,WAAWP,EAAEQ,aAAe,EAAIH,GAClC,MAAMI,EAAY,IAAInO,KAAKA,KAAK2N,IAAID,EAAEU,iBAAkB,EAAG,IAC3D,OAAOnR,KAAKoR,OAAQX,EAAEY,UAAYH,EAAUG,WAAaf,EAAW,GAAK,IAGpE,SAASgB,EAA8BC,GAC5C,MAAMC,EAAQ,IAAIzO,KACZC,EAAMwO,EAAMH,UAAY,IAAO,EAC/BI,EAAYF,EAAKF,UAAY,IAAO,EAEpCpV,EAAsC,GAa5C,OAZI+G,EAAMyO,EAAanB,GAAWkB,EAAMX,YAAcU,EAAKV,UACzD5U,EAAQyV,KAAOzV,EAAQ0V,OAAS,UACxBH,EAAMb,gBAAkBY,EAAKZ,eACrC1U,EAAQ2V,KAAO3V,EAAQ4V,IAAM,UAC7B5V,EAAQ6V,MAAQ,WACP9O,EAAMyO,EAAa,QAAiBlB,EAAciB,KAAWjB,EAAcgB,GACpFtV,EAAQ8V,QAAU,SAElB9V,EAAQ6V,MAAQ,QAChB7V,EAAQ4V,IAAM,WAGT,IAAI,qBAAqB,CAC9BrB,KAAMe,EACNtV,QAAAA,IACCwL,QAGE,SAASuK,EAAsBP,EAAmBxV,EAErD,IACF,MAAMuU,EAAO,IAAIzN,KACXwO,EAAO,IAAIxO,KAAiB,IAAZ0O,GAChBzO,EAAMwN,EAAKa,UAAY,IAEvBY,EAASC,EAAWX,GAE1B,IAAIY,EA8BJ,OA7BInP,EAAMyO,EAAanB,GAAWE,EAAKK,YAAcU,EAAKV,UACxDsB,GAAS,QAAKlW,EAAQmW,WAAa,aAAe,qBACzCpP,EAAMyO,EAAa,QAAkBjB,EAAKK,UAAY,IAAOU,EAAKV,WAC3EsB,GAAS,QAAKlW,EAAQmW,WAAa,YAAc,yBAE9CnW,EAAQmW,aACRD,EAAuB7R,MAAM+R,cAAgB,eAGhDF,EADQ3B,EAAKG,gBAAkBY,EAAKZ,cAC3B,IAAI,qBAAqB,CAChCH,KAAMe,EACNtV,QAAS,CACP6V,MAAO,QACPD,IAAK,UACLD,KAAM,aAEPnK,QAGM,IAAI,qBAAqB,CAChC+I,KAAMe,EACNtV,QAAS,CACP6V,MAAO,QACPD,IAAK,aAENpK,QAIE,CAAC0K,OAAAA,EAAQF,OAAAA,GAGX,SAASK,EAAmBb,GACjC,MAAM,OAACU,EAAM,OAAEF,GAAUD,EAAsBP,EAAW,CACxDW,YAAY,IAGRG,EAAWpW,SAASqW,yBAE1B,OADAD,EAASxV,OAAOoV,EAAQ,KAAK,QAAK,yBAA0B,IAAKF,GAC1DM,EAGF,SAASL,EAAW1B,GACzB,OAAO,IAAI,qBAAqB,CAC9BA,KAAAA,EACAvU,QAAS,CACPyV,KAAM,UACNC,OAAQ,aAETlK,QAGL,OAAmB,mCAA+C6J,GAE3D,MAAMmB,EAAc,CAACjC,EAAYvU,EAKnC,MACH,MAAMyW,EAASzW,EAAQ0W,cAAgB,IAAM,IACvCpB,GAAQ,IAAMf,EAAKoC,YAAY7U,OAAO,GAAK,KAAO,IAAMyS,EAAKqC,cAAc9U,OAAO,IAAM9B,EAAQ6W,UAAY,GAAK,KAAO,IAAMtC,EAAKuC,cAAchV,OAAO,IAE9J,OAAQ9B,EAAQ+W,aAAe,IAAMxC,EAAKK,WAAW9S,OAAO,GAAKyS,EAAKK,WACpE6B,GAAUzW,EAAQ0W,eAAiB,KAAOnC,EAAKI,WAAa,IAAI7S,OAAO,GAAKqS,EAAOI,EAAKI,aACxF8B,EAASlC,EAAKG,eACb1U,EAAQgX,OAAS,GAAK,KAAO1B,IAI5B2B,EAAU,KACVC,EAAc,IAAIC,OAAO,gBACzBC,EAAwB,IAAID,OAAO,yBAA0B,KAC7DE,EAA2B,IAAIF,OAAO,yBAA0B,KAChEG,EAAY,IAAIH,OAAO,0CAA2C,KAClEI,EAAW,IAAIJ,OAAO,mEAAoE,KAC1FK,EAAwB,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,IAMpE,SAASC,EAAa1K,EAAe2K,GAC1C,MAAMC,EAAI5K,EAAMW,OAAOzD,cAEvB,GAAG0N,EAAE5V,OAAS,EACZ,OAGF,GAA0B,IAAvB,QAAQ6V,QAAQD,GAAU,CAC3B,MAAMpD,EAAO,IAAIzN,KACX6O,EAAOpB,EAAKG,cACZmB,EAAQtB,EAAKI,WACbiB,EAAMrB,EAAKK,UACjBL,EAAKsD,YAAYlC,EAAME,EAAOD,GAC9BrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrBb,EAAKsD,YAAYlC,EAAME,EAAOD,EAAM,GACpCrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,EAMjC,YALAsC,EAAMzE,KAAK,CACT/C,MAAO,QACP6H,QAAAA,EACAC,QAAAA,IAKJ,GAA8B,IAA3B,YAAYJ,QAAQD,GAAU,CAC/B,MAAMpD,EAAO,IAAIzN,KACX6O,EAAOpB,EAAKG,cACZmB,EAAQtB,EAAKI,WACbiB,EAAMrB,EAAKK,UACjBL,EAAKsD,YAAYlC,EAAME,EAAOD,GAC9BrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UAAY,MACjCb,EAAKsD,YAAYlC,EAAME,EAAOD,EAAM,GACpCrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,SAMjC,YALAsC,EAAMzE,KAAK,CACT/C,MAAO,YACP6H,QAAAA,EACAC,QAAAA,IAKJ,MAAMC,EAySR,SAAsBN,GACpB,MAAMO,EAAI,IAAIpR,KACd,GAAG6Q,EAAE5V,QAAU,EACb,OAAQ,EAGV,IAAI,IAAIoL,EAAI,EAAGA,EAAI,EAAGA,IAGpB,GAFA+K,EAAEC,QAAQD,EAAEtD,UAAY,GAEoC,IAAzDwD,GAAeF,EAAE9C,WAAWnL,cAAc2N,QAAQD,GACnD,OAAOO,EAAEG,SAGb,OAAQ,EAtTUC,CAAaX,GAC/B,GAAGM,GAAa,EAAG,CACjB,MAAM1D,EAAO,IAAIzN,KACXC,EAAMwN,EAAKa,UAEXmD,EAAWN,EADE1D,EAAK8D,SAExB9D,EAAK4D,QAAQ5D,EAAKK,UAAY2D,GAC3BhE,EAAKa,UAAYrO,GAClBwN,EAAKiE,QAAQjE,EAAKa,UAAY,QAEhC,MAAMO,EAAOpB,EAAKG,cACZmB,EAAQtB,EAAKI,WACbiB,EAAMrB,EAAKK,UACjBL,EAAKsD,YAAYlC,EAAME,EAAOD,GAC9BrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrBb,EAAKsD,YAAYlC,EAAME,EAAOD,EAAM,GACpCrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,EAMjC,YALAsC,EAAMzE,KAAK,CACT/C,MAAOkI,GAAeL,GACtBA,QAAAA,EACAC,QAAAA,IAKJ,IAAIS,EACJ,GAAqC,QAAjCA,EAAUnB,EAAUoB,KAAKf,IAyB7B,GAAoC,QAAhCc,EAAUlB,EAASmB,KAAKf,IAqC5B,GAAuC,QAAnCc,EAAUvB,EAAYwB,KAAKf,IAA/B,CAyCA,GAAiD,QAA7Cc,EAAUrB,EAAsBsB,KAAKf,IAAc,CACrD,MAAMgB,EAAKF,EAAQ,GACbG,EAAKH,EAAQ,GACb5C,EAAQlB,GAASgE,GACvB,GAAG9C,GAAS,EAAG,CACb,MAAMgD,GAAKD,EACX,GAAGC,EAAI,GAAKA,GAAK,GAGf,YADAC,EAAkBpB,EADNmB,EAAI,EACchD,GAEzB,GAAGgD,GAAK5B,EAGb,YADA8B,EAAmBrB,EAAO7B,EADLgD,IAO3B,GAAoD,QAAhDJ,EAAUpB,EAAyBqB,KAAKf,IAAc,CACxD,MAAMgB,EAAKF,EAAQ,GAEb5C,EAAQlB,GADH8D,EAAQ,IAEnB,GAAG5C,GAAS,EAAG,CACb,MAAMgD,GAAKF,EACX,GAAGE,EAAI,GAAKA,GAAK,GAGf,YADAC,EAAkBpB,EADNmB,EAAI,EACchD,GAErBgD,GAAK5B,GAEd8B,EAAmBrB,EAAO7B,EADLgD,SAtE3B,CACE,IAAIG,GAAgBrB,EACpB,MAAMsB,GAAc,IAAInS,MAAO4N,cAC/B,GAAGsE,EAAe/B,EAAS,CACzB+B,EAAe/B,EACf,IAAI,IAAI9J,EAAI8L,EAAa9L,GAAK6L,EAAc7L,IAAK,CAC/C,MAAMoH,EAAO,IAAIzN,KACjByN,EAAKsD,YAAY1K,EAAG,EAAG,GACvBoH,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrBb,EAAKsD,YAAY1K,EAAI,EAAG,EAAG,GAC3BoH,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,EACjCsC,EAAMzE,KAAK,CACT/C,MAAO,GAAK/C,EACZ4K,QAAAA,EACAC,QAAAA,UAGC,GAAGgB,GAAgBC,EAAa,CACrC,MAAM1E,EAAO,IAAIzN,KACjByN,EAAKsD,YAAYmB,EAAc,EAAG,GAClCzE,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrBb,EAAKsD,YAAYmB,EAAe,EAAG,EAAG,GACtCzE,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,EACjCsC,EAAMzE,KAAK,CACT/C,MAAO,GAAK8I,EACZjB,QAAAA,EACAC,QAAAA,SAvEN,CACE,MAAMW,EAAKF,EAAQ,GACbG,EAAKH,EAAQ,GACbS,EAAKT,EAAQ,GACnB,IAAIA,EAAQ,KAAOA,EAAQ,GACzB,OAGF,MAAM7C,EAAMuD,SAASR,GACf9C,EAAQsD,SAASP,GAAM,EAC7B,IAAIjD,EAAOwD,SAASD,GACjBvD,GAAQ,IAAMA,GAAQ,KACvBA,GAAQ,KAGV,MAAMsD,GAAc,IAAInS,MAAO4N,cAC/B,GAAG0E,GAAkBxD,EAAM,EAAGC,IAAUF,GAAQsB,GAAWtB,GAAQsD,EAAa,CAC9E,MAAM1E,EAAO,IAAIzN,KACjByN,EAAKsD,YAAYlC,EAAME,EAAOD,GAC9BrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrBb,EAAKsD,YAAYlC,EAAME,EAAOD,EAAM,GACpCrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAME,EAAUzD,EAAKa,UAAY,EAMjC,YALAsC,EAAMzE,KAAK,CACT/C,MAAOmJ,GAAiBtB,GACxBA,QAAAA,EACAC,QAAAA,SAtDN,CACE,MAAMW,EAAKF,EAAQ,GACbG,EAAKH,EAAQ,GACbI,EAAIM,SAASR,GACbW,EAAKH,SAASP,GACpB,GAAGC,EAAI,GAAKA,GAAK,GAAI,CACnB,GAAGS,GAAMrC,GAAW4B,GAAK,GAIvB,YADAE,EAAmBrB,EADLmB,EAAI,EADGS,GAIZA,GAAM,IAGfR,EAAkBpB,EAFNmB,EAAI,EACFS,EAAK,QAGZT,GAAK5B,GAAWqC,GAAM,IAG/BP,EAAmBrB,EADL4B,EAAK,EADET,IA0H3B,SAASE,EAAmBrB,EAAmB7B,EAAemD,GAC5D,MAAMC,GAAc,IAAInS,MAAO4N,cACzBa,EAAQzO,KAAKC,MACnB,GAAGiS,GAAgB/B,GAAW+B,GAAgBC,EAAa,CACzD,MAAM1E,EAAO,IAAIzN,KACjByN,EAAKsD,YAAYmB,EAAcnD,EAAO,GACtCtB,EAAKuD,SAAS,EAAG,EAAG,GACpB,MAAMC,EAAUxD,EAAKa,UACrB,GAAG2C,EAAUxC,EACX,OAEFhB,EAAKgF,SAAShF,EAAKI,WAAa,GAChC,MAAMqD,EAAUzD,EAAKa,UAAY,EAEjCsC,EAAMzE,KAAK,CACT/C,MAAOsJ,GAAmBzB,GAC1BA,QAAAA,EACAC,QAAAA,KAKN,SAASc,EAAkBpB,EAAmB9B,EAAaC,GACzD,GAAGuD,GAAkBxD,EAAKC,GAAQ,CAChC,MAAMoD,GAAc,IAAInS,MAAO4N,cACzBa,EAAQzO,KAAKC,MAEnB,IAAI,IAAIoG,EAAI8L,EAAa9L,GAAK8J,EAAS9J,IAAK,CAC1C,GAAa,IAAV0I,GAAuB,KAARD,KA8DJD,EA9D8BxI,GA+DhC,GAAM,GAAOwI,EAAO,KAAQ,IAAQA,EAAO,KAAQ,EA9D7D,SAGF,MAAMpB,EAAO,IAAIzN,KACjByN,EAAKsD,YAAY1K,EAAG0I,EAAOD,EAAM,GACjCrB,EAAKuD,SAAS,EAAG,EAAG,GAEpB,MAAMC,EAAUxD,EAAKa,UACrB,GAAG2C,EAAUxC,EACX,SAGFhB,EAAKsD,YAAY1K,EAAG0I,EAAOD,EAAM,GACjCrB,EAAKuD,SAAS,EAAG,EAAG,GACpB,MAAME,EAAUzD,EAAKa,UAAY,EAC9BjI,IAAM8L,EACPvB,EAAMzE,KAAK,CACT/C,MAAOuJ,GAAkB1B,GACzBA,QAAAA,EACAC,QAAAA,IAGFN,EAAMzE,KAAK,CACT/C,MAAOmJ,GAAiBtB,GACxBA,QAAAA,EACAC,QAAAA,KAoCV,IAAoBrC,EA7BpB,SAAS6D,GAAmBhE,GAC1B,MAAMjB,EAAO,IAAIzN,KAAK0O,GACtB,OAAOrB,EAAOI,EAAKI,YAAY7S,MAAM,EAAG,GAAK,IAAMyS,EAAKG,cAG1D,SAAS+E,GAAkBjE,GACzB,MAAMjB,EAAO,IAAIzN,KAAK0O,GACtB,OAAOrB,EAAOI,EAAKI,YAAY7S,MAAM,EAAG,GAAK,IAAMyS,EAAKK,UAG1D,SAASyE,GAAiB7D,GACxB,MAAMjB,EAAO,IAAIzN,KAAK0O,GACtB,OAAQ,IAAMjB,EAAKK,WAAW9S,OAAO,GAAK,KAAO,KAAOyS,EAAKI,WAAa,IAAI7S,OAAO,GAAK,IAAMyS,EAAKG,cAGvG,SAAS0D,GAAe5C,GACtB,MAAMjB,EAAO,IAAIzN,KAAK0O,GACtB,OAAOpB,EAAKG,EAAK8D,UAGnB,SAASe,GAAkBxD,EAAaC,GACtC,OAAGA,GAAS,GAAKA,EAAQ,IACpBD,GAAO,GAAKA,EAAM4B,EAAsB3B,GAW/C,SAASlB,GAASgD,GAwBhBA,EAAIA,EAAE1N,cACN,IAAI,IAAIkD,EAAI,EAAGA,EAAI,GAAIA,IAErB,GAAwB,IADVgH,EAAOhH,GAAGlD,cACf2N,QAAQD,GACf,OAAOxK,EAGX,OAAQ,EAmBV,kBAA8BsK,E,eC1ef,SAASiC,GAAoBC,G,MAC1C,IAAIA,EACF,OAAOzZ,SAASC,cAAc,QAGhC,IAAI8Q,EACAT,EAEJ,OAAOmJ,EAAK/H,IACV,KAAK,iBACHX,EAAM,4BACN,MACF,KAAK,iBACHA,EAAM,4BACN,MACF,QACE,GAAG0I,EAAKC,OAAOC,IAAK,CAClB5I,EAAM,MACN,MAGF,GAAG0I,EAAKC,OAAOE,QAAS,CACtB7I,EAAM,gBACN,MAGF,OAAkB,QAAX,EAAA0I,EAAKI,cAAM,eAAE/L,GAClB,IAAK,qBACHiD,EAAM,SACN,MAGF,IAAK,qBACHA,EAAM,cACN,MAGF,IAAK,sBACHA,EAAM,eACN,MAGF,IAAK,oBAAqB,CACxB,MAAMsD,EAAOoF,EAAKI,OAAOC,WACnBzE,EAAQ,IAAIzO,KAGZmT,GAFM1E,EAAMH,UAAY,IAAO,GAElBb,EACnB,GAAG0F,EAAO,GACRhJ,EAAM,2BACD,GAAGgJ,EAAO,KACfhJ,EAAM,qBAENT,EAAO,CADGyJ,EAAO,GAAK,QAEjB,GAAGA,EAAO,OAAS1E,EAAMX,YAAc,IAAI9N,KAAY,IAAPyN,GAAaK,UAClE3D,EAAM,oBAENT,EAAO,CADGyJ,EAAO,KAAO,OAEnB,CACLhJ,EAAM,yBACN,MAAM,OAACiF,EAAM,OAAEF,GAAUD,EAAsBxB,GAC/C/D,EAAO,CAAC0F,EAAQF,GAGlB,MAGF,IAAK,mBACH/E,EAAM,SACN,MAGF,QACEA,EAAM,gBASd,OAAO,QAAKA,EAAKT,GChEJ,MAAM0J,WAAuBtK,EAA5C,c,oBAEU,KAAAuK,aAAyC,KAEzC,KAAAC,WAAqB,EAQnB3J,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,uBAC7BW,KAAK4P,SAAS,YAEd5P,KAAKiZ,WAAa,IAAIrG,GAAYsG,IAChClZ,KAAK+Y,aAAeG,KAGtB,MAAMC,EAAU,IAAIC,GAAe,IAE7BC,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAKsZ,oBAAsB,IAAI,IAAW,CACxCC,MAAO,yBACPC,UAAW,MAGbxZ,KAAKyZ,wBAA0B,IAAI,IAAW,CAC5CF,MAAO,eACP9V,KAAM,WACNiW,aAAa,IAGfL,EAAa3Z,OACXM,KAAKsZ,oBAAoBpY,UACzBlB,KAAKyZ,wBAAwBvY,WAG/BlB,KAAKsZ,oBAAoBvZ,MAAMK,iBAAiB,SAAS,KAEvD,IAAIuZ,IADU3Z,KAAKsZ,oBAAoB9Y,MACdG,SAAWX,KAAKsZ,oBAAoBvZ,MAAMX,UAAUiG,SAAS,SACnFrF,KAAKgZ,YAAWW,EAAaA,KAAgB3Z,KAAK4Z,sBAAwB5Z,KAAK6Z,qBAClF7Z,KAAK8Z,QAAQ1a,UAAUoE,OAAO,eAAgBmW,MAGhD3Z,KAAK8Z,QAAU,EAAa,CAAC7a,KAAM,eAEnCe,KAAK8Z,QAAQ1Z,iBAAiB,SAAS,KACrC,MAAM0O,EAAQ9O,KAAKsZ,oBAAoB9Y,MAEvC,IAAIsJ,EACJ,GAAG9J,KAAKgZ,UAAW,CACjB,IAAIhZ,KAAK6Z,sBAAwB7Z,KAAK4Z,mBAAoB,OAC1D9P,EAAU9J,KAAK2S,SAASoH,gBAAgBC,cAAc,CACpDlL,MAAAA,EACAmL,MAAO,GACPC,UAAW,OAAF,QACPtN,EAAG,iBACA5M,KAAK4Z,oBAEVO,QAASna,KAAK6Z,oBACdO,WAAW,IACV1Y,MAAM2Y,IACJra,KAAK+Y,cACN/Y,KAAK+Y,eAAerX,MAAM4Y,IACxBta,KAAK2S,SAASoH,gBAAgBQ,UAAUF,EAAQC,MAIjDta,KAAKwa,QAAQ7Z,QACdX,KAAK2S,SAASoH,gBAAgBU,gBAAgBJ,EAAQra,KAAKwa,SAGtDH,UAGTra,KAAK8Z,QAAQva,UAAW,EACxBuK,EAAU9J,KAAK2S,SAASoH,gBAAgBW,WAAW5L,EAAO9O,KAAKwa,QAAQG,KAAKpO,GAAWA,EAAOqO,cAAalZ,MAAM2Y,IAC5Gra,KAAK+Y,cACN/Y,KAAK+Y,eAAerX,MAAM4Y,IACxBta,KAAK2S,SAASoH,gBAAgBQ,UAAUF,EAAQC,MAI7CD,KAIPvQ,GAIJA,EAAQpI,MAAM2Y,IACZ,wBAAoCra,MACpC,aAAyB,GAEzB,gBAA0B,CAACuM,OAAQ8N,EAAOQ,UAAS,WAIvD,MAAMC,EAAe,IAAI1B,GAAe,CACtC3V,KAAM,UACNsX,SAAU,CAAC/a,KAAKwa,QAAQ7Z,UAGpBkK,EAAO7K,KAAK6K,KAAO,kBAAiC,CACxDmQ,KAAK,IAGPF,EAAa/L,QAAQrP,OAAOmL,GAE5BsO,EAAQpK,QAAQrP,OAAOM,KAAKiZ,WAAW/X,UAAWmY,GAElDrZ,KAAK+O,QAAQrP,OAAOM,KAAK8Z,SACzB9Z,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,UAAW4Z,EAAa5Z,WAGlDsO,sBACLxP,KAAKiZ,WAAWlO,QAChB/K,KAAK+Y,aAAe,KACpB/Y,KAAKsZ,oBAAoB9Y,MAAQ,GACjCR,KAAKyZ,wBAAwBvY,UAAU9B,UAAUC,IAAI,QACrDW,KAAK8Z,QAAQva,UAAW,EAGnB4P,KAAKqL,EAAmBxB,GAAqB,GAClDhZ,KAAKgZ,UAAYA,EACjBhZ,KAAKwa,QAAUA,EACf,MAAMlL,EAASzP,MAAMsP,OAuBrB,OAtBAG,EAAO5N,MAAK,KACPsX,GACDhZ,KAAK4P,SAAS,qBACd5P,KAAKyZ,wBAAwBvY,UAAU9B,UAAUkB,OAAO,QACxDN,KAAKyZ,wBAAwB7Y,iBAAiB,YAAY,WAAW,IACrEZ,KAAKib,iBAELjb,KAAKyZ,wBAAwBvY,UAAU9B,UAAUC,IAAI,QAGhD8D,QAAQC,IAAIpD,KAAKwa,QAAQG,KAAUO,IAAW,O,EAAA,K,OAAA,E,EAAA,YACnD,MAAM,IAACC,GAAO,gBAA+B,CAC3C5O,OAAQ2O,EACRha,UAAWlB,KAAK6K,KAChBuQ,eAAe,EACf7N,WAAY,KAGd4N,EAAIE,gBAAgB3b,OAAO4Y,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQL,M,YARxC,K,qRAYhD5L,EAGD2L,gBACNO,UAAUC,YAAYC,oBAAoBC,IACxC3b,KAAK4Z,mBAAqB,CACxBgC,IAAKD,EAASE,OAAOC,SACrBC,KAAMJ,EAASE,OAAOG,WAGxB,IAAIC,EAAM,8CACVA,GAAO,QAAQN,EAASE,OAAOC,SAC/BG,GAAO,QAAQN,EAASE,OAAOG,UAC/BC,GAAO,eACPA,GAAO,oBACPA,GAAO,sBACPC,MAAMD,GACLva,MAAMya,GAAaA,EAASC,SAC5B1a,MAAMya,IACLnc,KAAK6Z,oBAAsBsC,EAASE,aACpCrc,KAAKyZ,wBAAwB7Y,iBAAiBub,EAASE,oBAEvD1O,IACCA,aAAiB2O,yBAClBtc,KAAKyZ,wBAAwB7Y,iBAAiB,mDAE9CZ,KAAKyZ,wBAAwB7Y,iBAAiB,kD,0BCxMvC,MAAM2b,GAKnB3c,YAAY4c,GAHJ,KAAAC,MAAkC,IAAIxL,IACtC,KAAAyL,QAAS,EAGf1c,KAAK2c,SAAW,IAAIC,sBAAsBC,IACxC,GAAG7c,KAAK0c,OACN,OAGF,MAAMI,EAAoD,GAE1DD,EAAQzP,SAAS2P,IACf,MAAM5V,EAAS4V,EAAM5V,OAElBnH,KAAKyc,MAAMjL,IAAIrK,KAAY4V,EAAMC,iBAGlChd,KAAKyc,MAAMQ,IAAI9V,EAAQ4V,EAAMC,gBAW/BF,EAAQC,EAAMC,eAAiB,UAAY,QAAQ,CAAC7V,OAAAA,EAAQ+V,QAASH,EAAMC,qBAK7EF,EAAQ1P,SAAS+P,IACfX,EAAmBW,EAAKhW,OAAQgW,EAAKD,eAKpCE,aACL,MAAMX,EAAsB,GAO5B,OANAzc,KAAKyc,MAAMrP,SAAQ,CAAC5M,EAAOqP,KACtBrP,GACDic,EAAM5K,KAAKhC,MAIR4M,EAGFY,eACL,MAAMH,EAAUld,KAAKod,aACrB,IAAI,MAAMjW,KAAU+V,EAClBld,KAAKyc,MAAMQ,IAAI9V,GAAQ,GAIpBmW,UAAUnW,GACf,OAAOnH,KAAKyc,MAAMjL,IAAIrK,GAGjBoW,aACLvd,KAAK2c,SAASY,aACdvd,KAAKyc,MAAM1R,QAGNyS,UACLxd,KAAK2c,SAASY,aAGZ,MAAME,EAAU,IAAIzd,KAAKyc,MAAMiB,QAC/B,IAAI,MAAMvW,KAAUsW,EAElBzd,KAAK2c,SAASgB,QAAQxW,GAKrByW,iBACL,MAAMV,EAAUld,KAAKod,aACrB,IAAI,MAAMjW,KAAU+V,EAClBld,KAAK2c,SAASkB,UAAU1W,GAG1B,IAAI,MAAMA,KAAU+V,EAClBld,KAAK2c,SAASgB,QAAQxW,GAInBwW,QAAQxW,GACbnH,KAAKyc,MAAMQ,IAAI9V,GAAQ,GACvBnH,KAAK2c,SAASgB,QAAQxW,GAGjB0W,UAAU1W,GACfnH,KAAK2c,SAASkB,UAAU1W,GACxBnH,KAAKyc,MAAM/M,OAAOvI,GAGb2W,SACL9d,KAAK0c,QAAS,EAGTqB,mBACL/d,KAAK8d,SACL9d,KAAKwd,UAGAQ,OACLhe,KAAK0c,QAAS,GCxHH,SAASuB,GAAoBC,EAAiBC,GAC3D,MAAMC,EAAoB,GAC1B,IAAIC,GAAO,EACX,MAA2C,KAApCA,EAAMH,EAAMI,UAAUH,KAC3BC,EAAIvM,KAAKqM,EAAMK,OAAOF,EAAK,GAAG,IAGhC,OAAOD,E,0BCSM,MAAMI,WAAiC,KAOpD5e,YAAY6e,GACV5e,MAAM4e,GAPE,KAAAC,MAAgC,GAChC,KAAAC,UAAkC,IAAIC,IASzCZ,OACLne,MAAMme,OACNhe,KAAK6e,YAAYb,OAGZF,SACLje,MAAMie,SACN9d,KAAK6e,YAAYf,SAGZC,mBACLle,MAAMie,SACN9d,KAAK6e,YAAYd,mBAGZhT,QACLlL,MAAMkL,QACN/K,KAAK6e,YAAYtB,aAGZC,UACLxd,KAAK6e,YAAYrB,UAGTsB,SAASC,GACjB,OAAOA,EAAK5d,KAAK4d,EAAK1a,KAGd2a,WAAWC,EAA4B1N,GAE/C,GADavR,KAAK0e,MAAMtM,MAAMrG,GAAMA,EAAE1H,MAAQkN,EAAGlN,KAAO0H,EAAE5K,OAASoQ,EAAGpQ,OAEpE,OAAO,EAEP,IAAI,MAAM4d,KAAQ/e,KAAK2e,UACrB,GAAGI,EAAK1a,MAAQkN,EAAGlN,KAAO0a,EAAK5d,OAASoQ,EAAGpQ,KACzC,OAAO,EAMb,OADAnB,KAAK0e,MAAMO,GAAQ1N,IACZ,EAGC2N,yBACJlf,KAAKmf,qBACPnf,KAAKmf,mBAAqBrZ,OAAOM,YAAW,KAC1CpG,KAAKmf,mBAAqB,EAC1Bnf,KAAKof,iBACJ,IAIAvN,KAAKN,GACV1R,MAAMgS,KAAKN,GAGN8N,QAAQ9N,GACb1R,MAAMwf,QAAQ9N,GAGTsM,UAAUtM,GACf0M,GAAiBje,KAAK0e,OAAQ3S,GAAMA,EAAE1H,MAAQkN,IAE9CvR,KAAK6e,YAAYhB,UAAUtM,IChFhB,MAAM+N,WAAsBd,GACzC5e,YAAY6e,GACV5e,MAAM4e,GAKA,KAAAjC,mBAAqB,CAACrV,EAAqB+V,KAC9CA,IAMDe,GAAiBje,KAAK0e,OAAQ3S,GAAMA,EAAE1H,MAAQ8C,IAAQiG,SAAS2R,IAC7DA,EAAKQ,SAAU,EACfvf,KAAK0e,MAAMW,QAAQN,MAIrB/e,KAAKkf,2BAhBPlf,KAAK6e,YAAc,IAAItC,GAAsBvc,KAAKwc,oBAoB1CgD,UACR,OAAO,EAAAC,GAAA,GAAczf,KAAK0e,OAAOK,GAAQA,EAAKQ,UAGnCG,YAAYX,G,iHACjB,EAAMW,YAAW,UAACX,GACxB/e,KAAK6e,YAAYhB,UAAUkB,EAAK1a,M,+RAGxB2a,WAAWC,EAA4B1N,GAG/C,QAFiB1R,MAAMmf,WAAWC,EAAQ1N,KAI1CvR,KAAK6e,YAAYlB,QAAQpM,EAAGlN,KAGdkN,EAAGoO,eAAe,aAC9BpO,EAAGgO,SAAU,IAGR,I,+CC7CI,SAASK,GACtBC,EACAC,EAAW,EACXC,EAAY,EACZC,GAAW,EACXC,GAAmB,GAEhBna,OAAOoa,iBAAmB,IAC3BJ,GAAY,EACZC,GAAa,GAcf,IAAII,EAA2B,CAACvT,EAAG,iBAAkB3M,KAAM,IACvDmgB,EAASP,EAAkBO,OAAUP,EAAqBQ,OAW9D,GAVGJ,GAAoBG,GAAqB,aAAZP,EAAMjT,IACpCwT,EAAQA,EAAME,OAAO,CACnB1T,EAAG,YACH2T,EAAIV,EAAqBU,EACzBC,EAAIX,EAAqBW,EACzBxf,KAAO6e,EAAqB7e,KAC5Bf,UAAM+J,KAIPoW,MAAAA,OAAK,EAALA,EAAOzf,OAAQ,CAChB,IAAI,IAAIoL,EAAI,EAAGpL,EAASyf,EAAMzf,OAAQoL,EAAIpL,IAAUoL,EAAG,CACrD,MAAM0U,EAAYL,EAAMrU,GACxB,KAAK,MAAO0U,MAAgB,MAAOA,GAAY,SAE/CN,EAAgBM,EAEhB,MAAMzf,GAAO,EAAA0f,GAAA,GAAeD,EAAUF,EAAGE,EAAUD,EAAGV,EAAUC,GAChE,GAAG/e,EAAKO,OAASue,GAAY9e,EAAKQ,QAAUue,EAC1C,MAIDC,GAAgC,mBAApBG,EAAcvT,GAAyC,sBAAfwT,EAAM,GAAGxT,IAC9DuT,EAAgBC,EAAM,IAI1B,OAAOD,EChEM,SAASQ,GAAWC,EAAeC,GAChD,OAAOD,EAAIE,QAAO,CAACC,EAAKvgB,IAAUugB,EAAMvgB,GAAOqgB,G,eCgC1C,MAAMG,GAOXphB,YAAoBwgB,EAAuBa,EAA0BC,EAA0BC,EAAyBC,EAAYH,GAAhH,KAAAb,MAAAA,EAAuB,KAAAa,SAAAA,EAA0B,KAAAC,SAAAA,EAA0B,KAAAC,QAAAA,EAAyB,KAAAC,UAAAA,EACtHphB,KAAK+M,MAAQqT,EAAMzf,OACnBX,KAAKqhB,OAASL,GAASM,YAAYlB,GACnCpgB,KAAKuhB,YAAcP,GAASQ,iBAAiBxhB,KAAKqhB,QAClDrhB,KAAKyhB,aAAed,GAAW3gB,KAAKqhB,OAAQ,GAAKrhB,KAAK+M,MACtD/M,KAAK0hB,aAAeT,EAAWjhB,KAAKohB,UAG/BO,SACL,OAAI3hB,KAAK+M,MAGN/M,KAAK+M,OAAS,GAAK/M,KAAKqhB,OAAOjP,MAAMhN,GAAMA,EAAI,IACzC,IAAIwc,GAAgB5hB,KAAKqhB,OAAQrhB,KAAKyhB,aAAczhB,KAAKihB,SAAUjhB,KAAKkhB,SAAUlhB,KAAKmhB,SAASQ,SAGvF,IAAf3hB,KAAK+M,MAAoB/M,KAAK6hB,YACV,IAAf7hB,KAAK+M,MAAoB/M,KAAK8hB,cAC/B9hB,KAAK+hB,aATW,GAYjBF,YACN,MAAyB,OAArB7hB,KAAKuhB,aACHvhB,KAAKyhB,aAAe,IAAMzhB,KAAK0hB,cAC/B1hB,KAAKqhB,OAAO,GAAKrhB,KAAKqhB,OAAO,GAAK,GAC/BrhB,KAAKgiB,qBACiB,OAArBhiB,KAAKuhB,aAA6C,OAArBvhB,KAAKuhB,YACnCvhB,KAAKiiB,0BAEPjiB,KAAKkiB,qBAGNJ,cAEN,MAA2B,MAAxB9hB,KAAKuhB,YAAY,GACXvhB,KAAKmiB,0BAEPniB,KAAKoiB,yBAGNL,aACN,MAA2B,MAAxB/hB,KAAKuhB,YAAY,GACXvhB,KAAKqiB,wBAEPriB,KAAKsiB,yBAGNN,qBACN,MAAMzgB,EAAQvB,KAAKihB,SACbzf,EAASmB,KAAKE,MAAMF,KAAKC,IAC7BrB,EAAQvB,KAAKqhB,OAAO,GACpB1e,KAAKC,IACHrB,EAAQvB,KAAKqhB,OAAO,IACnBrhB,KAAKohB,UAAYphB,KAAKmhB,SAAW,KAEtC,MAAO,CACL,CACEoB,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAAA,EAAOC,OAAAA,GAC9BghB,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAG,EAAGC,EAAGzF,EAASxB,KAAKmhB,QAAS5f,MAAAA,EAAOC,OAAAA,GAClDghB,MAAOC,KAKLR,0BACN,MAAM1gB,GAASvB,KAAKihB,SAAWjhB,KAAKmhB,SAAW,EACzC3f,EAASmB,KAAKE,MAAMF,KAAKC,IAC7BrB,EAAQvB,KAAKqhB,OAAO,GACpB1e,KAAKC,IAAIrB,EAAQvB,KAAKqhB,OAAO,GAAqB,EAAjBrhB,KAAKohB,aAExC,MAAO,CACL,CACEmB,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAAA,EAAOC,OAAAA,GAC9BghB,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAGzF,EAAQvB,KAAKmhB,QAASla,EAAG,EAAG1F,MAAAA,EAAOC,OAAAA,GACjDghB,MAAOC,IAKLP,qBACN,MAAMQ,EAAe/f,KAAKE,MAAsB,IAAhB7C,KAAKkhB,UAC/ByB,EAAchgB,KAAKC,IACvBD,KAAKE,MAAMF,KAAKH,IACd,IAAOxC,KAAKihB,SAAWjhB,KAAKmhB,UAC3BnhB,KAAKihB,SAAWjhB,KAAKmhB,SAAWnhB,KAAKqhB,OAAO,IACxC,EAAIrhB,KAAKqhB,OAAO,GAAK,EAAIrhB,KAAKqhB,OAAO,MAC5CrhB,KAAKihB,SAAWjhB,KAAKmhB,QAAUuB,GAC3BE,EAAa5iB,KAAKihB,SACpB0B,EACA3iB,KAAKmhB,QACH3f,EAASmB,KAAKC,IAClB5C,KAAKohB,UACLze,KAAKE,MAAMF,KAAKC,IACdggB,EAAa5iB,KAAKqhB,OAAO,GACzBsB,EAAc3iB,KAAKqhB,OAAO,MAE9B,MAAO,CACL,CACEkB,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAOqhB,EAAYphB,OAAAA,GAC1CghB,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAG4b,EAAa5iB,KAAKmhB,QAASla,EAAG,EAAG1F,MAAOohB,EAAanhB,OAAAA,GACnEghB,MAAOC,IAKLN,0BACN,MAAMU,EAAc7iB,KAAKohB,UACnB0B,EAAcngB,KAAKE,MAAMF,KAAKC,KACjC5C,KAAKohB,UAAYphB,KAAKmhB,SAAW,EACjCnhB,KAAKqhB,OAAO,IAAMrhB,KAAKihB,SAAWjhB,KAAKmhB,UACnCnhB,KAAKqhB,OAAO,GAAKrhB,KAAKqhB,OAAO,MAC9B0B,EAAeF,EACjBC,EACA9iB,KAAKmhB,QACH6B,EAAargB,KAAKH,IACtBxC,KAAKkhB,SACLve,KAAKE,MAAMF,KAAKC,KACb5C,KAAKihB,SAAWjhB,KAAKmhB,SAAW,EACjCxe,KAAKC,IACHkgB,EAAc9iB,KAAKqhB,OAAO,GAC1B0B,EAAe/iB,KAAKqhB,OAAO,OAC3B4B,EAAYtgB,KAAKC,IACrBD,KAAKE,MAAMggB,EAAc7iB,KAAKqhB,OAAO,IACrCrhB,KAAKihB,SAAWjhB,KAAKmhB,QAAU6B,GAEjC,MAAO,CACL,CACET,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAO0hB,EAAWzhB,OAAQqhB,GACjDL,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAGic,EAAYjjB,KAAKmhB,QAASla,EAAG,EAAG1F,MAAOyhB,EAAYxhB,OAAQuhB,GACzEP,MAAOC,GAET,CACEF,SAAU,CAACvb,EAAGic,EAAYjjB,KAAKmhB,QAASla,EAAG8b,EAAe/iB,KAAKmhB,QAAS5f,MAAOyhB,EAAYxhB,OAAQshB,GACnGN,MAAOC,IAKLL,yBACN,MAAMQ,EAAa5iB,KAAKihB,SAClB4B,EAAclgB,KAAKE,MAAMF,KAAKC,IAClCggB,EAAa5iB,KAAKqhB,OAAO,GACS,KAAjCrhB,KAAKohB,UAAYphB,KAAKmhB,WACnBwB,GAAe3iB,KAAKihB,SAAWjhB,KAAKmhB,SAAW,EAC/C4B,EAAepgB,KAAKC,IACxB5C,KAAKohB,UAAYyB,EAAc7iB,KAAKmhB,QACpCxe,KAAKE,MAAMF,KAAKC,IACd+f,EAAc3iB,KAAKqhB,OAAO,GAC1BsB,EAAc3iB,KAAKqhB,OAAO,MACxB6B,EAAaN,EAAaD,EAAc3iB,KAAKmhB,QAEnD,MAAO,CACL,CACEoB,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAOqhB,EAAYphB,OAAQqhB,GAClDL,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAG,EAAGC,EAAG4b,EAAc7iB,KAAKmhB,QAAS5f,MAAOohB,EAAanhB,OAAQuhB,GAC5EP,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAG2b,EAAc3iB,KAAKmhB,QAASla,EAAG4b,EAAc7iB,KAAKmhB,QAAS5f,MAAO2hB,EAAY1hB,OAAQuhB,GACpGP,MAAOC,IAKLJ,wBACN,MAAM9B,EAAIvgB,KAAKihB,SACTkC,EAAKxgB,KAAKE,MAAMF,KAAKC,IACzB2d,EAAIvgB,KAAKqhB,OAAO,GACkB,KAAjCrhB,KAAKohB,UAAYphB,KAAKmhB,WACnBX,EAAI7d,KAAKE,OACZ7C,KAAKihB,SAAW,EAAIjhB,KAAKmhB,UACrBnhB,KAAKqhB,OAAO,GAAKrhB,KAAKqhB,OAAO,GAAKrhB,KAAKqhB,OAAO,KAC/C+B,EAAKzgB,KAAKH,IACdxC,KAAKkhB,SACLve,KAAKE,MAAMF,KAAKC,IACuB,IAApC5C,KAAKihB,SAAW,EAAIjhB,KAAKmhB,SAC1BX,EAAIxgB,KAAKqhB,OAAO,MACdgC,EAAK1gB,KAAKE,MAAMF,KAAKH,IACzBG,KAAKH,IACa,EAAhBxC,KAAKkhB,SACgC,KAApClhB,KAAKihB,SAAW,EAAIjhB,KAAKmhB,UAC5BX,EAAIxgB,KAAKqhB,OAAO,KACZiC,EAAK/C,EAAI6C,EAAKC,EAAK,EAAIrjB,KAAKmhB,QAC5BoC,EAAK5gB,KAAKC,IACd5C,KAAKohB,UAAY+B,EAAKnjB,KAAKmhB,QAC3BX,GAEF,MAAO,CACL,CACE+B,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAOgf,EAAG/e,OAAQ2hB,GACzCX,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAG,EAAGC,EAAGkc,EAAKnjB,KAAKmhB,QAAS5f,MAAO6hB,EAAI5hB,OAAQ+hB,GAC1Df,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAGoc,EAAKpjB,KAAKmhB,QAASla,EAAGkc,EAAKnjB,KAAKmhB,QAAS5f,MAAO+hB,EAAI9hB,OAAQ+hB,GAC1Ef,MAjOE,GAmOJ,CACED,SAAU,CAACvb,EAAGoc,EAAKpjB,KAAKmhB,QAAUmC,EAAKtjB,KAAKmhB,QAASla,EAAGkc,EAAKnjB,KAAKmhB,QAAS5f,MAAO8hB,EAAI7hB,OAAQ+hB,GAC9Ff,MAAOC,IAKLH,yBACN,MAAM9B,EAAIxgB,KAAKohB,UACTgC,EAAKzgB,KAAKE,MAAMF,KAAKC,IACzB4d,EAAIxgB,KAAKqhB,OAAO,GACiB,IAAhCrhB,KAAKihB,SAAWjhB,KAAKmhB,WAElBZ,EAAI5d,KAAKE,OACZ7C,KAAKohB,UAAY,EAAIphB,KAAKmhB,UACtB,EAAKnhB,KAAKqhB,OAAO,GAAK,EAAKrhB,KAAKqhB,OAAO,GAAK,EAAKrhB,KAAKqhB,OAAO,KAE9D8B,EAAKxgB,KAAKE,MAAM0d,EAAIvgB,KAAKqhB,OAAO,IAChCkC,EAAK5gB,KAAKE,MAAM0d,EAAIvgB,KAAKqhB,OAAO,IAChCmC,EAAKhD,EAAI2C,EAAKI,EAAK,EAAIvjB,KAAKmhB,QAC5BmC,EAAK3gB,KAAKH,IACdxC,KAAKkhB,SACLve,KAAKC,IAAI5C,KAAKihB,SAAWmC,EAAKpjB,KAAKmhB,QAASZ,IAE9C,MAAO,CACL,CACEgC,SAAU,CAACvb,EAAG,EAAGC,EAAG,EAAG1F,MAAO6hB,EAAI5hB,OAAQgf,GAC1CgC,MAAOC,IAET,CACEF,SAAU,CAACvb,EAAGoc,EAAKpjB,KAAKmhB,QAASla,EAAG,EAAG1F,MAAO+hB,EAAI9hB,OAAQ2hB,GAC1DX,MAAOC,GAET,CACEF,SAAU,CAACvb,EAAGoc,EAAKpjB,KAAKmhB,QAASla,EAAGkc,EAAKnjB,KAAKmhB,QAAS5f,MAAO+hB,EAAI9hB,OAAQ+hB,GAC1Ef,MAvQC,GAyQH,CACED,SAAU,CAACvb,EAAGoc,EAAKpjB,KAAKmhB,QAASla,EAAGkc,EAAKI,EAAK,EAAIvjB,KAAKmhB,QAAS5f,MAAO+hB,EAAI9hB,OAAQgiB,GACnFhB,MAAOC,IAKLgB,mBAAmBrD,GACzB,OAAOA,EAAMzF,KAAK3Z,GAASA,EAAKuf,EAAIvf,EAAKwf,IAGnCiD,wBAAwBpC,GAC9B,OAAOA,EAAO1G,KAAK+I,GAAWA,EAAQ,IAAO,IAAOA,EAAQ,GAAO,IAAM,MAAKC,KAAK,KAIvF,MAAM/B,GAIJhiB,YAAYyhB,EAA0BI,EAA8BR,EAA0BC,EAA0BC,EAAyBC,EAAuB,EAAXH,EAAe,GAAtI,KAAAQ,aAAAA,EAA8B,KAAAR,SAAAA,EAA0B,KAAAC,SAAAA,EAA0B,KAAAC,QAAAA,EAAyB,KAAAC,UAAAA,EAC/IphB,KAAKqhB,OAASO,GAAgBgC,WAAWvC,EAAQI,GACjDzhB,KAAK+M,MAAQsU,EAAO1gB,OAGd8iB,kBAAkBpC,EAAkBI,GAG1C,OAAOJ,EAAO1G,KAAK+I,GACVjC,EAAe,KACrB,EAAAoC,GAAA,GAAMH,EAAO,EAJE,OAKf,EAAAG,GAAA,GAAMH,EAJS,MAIS,KAItB/B,SACL,IAAIrS,EAAS,IAAI8B,MAAwBpR,KAAK+M,OAE1C+W,EAAsB,GAC1B,MAAMC,EAAc,CAACC,EAAgBjX,KACnC,MACMkX,EAAMtD,GADG3gB,KAAKqhB,OAAO3gB,MAAMsjB,EAAQA,EAASjX,GACnB,GAC/B,OAAQ/M,KAAKihB,UAAYlU,EAAQ,GAAK/M,KAAKmhB,SAAW8C,GAElDC,EAAeC,IACnB,IAAIC,EAAoB,GACpBJ,EAAS,EACb,IAAI,IAAIjX,KAASoX,EACfC,EAAQvS,KAAKkS,EAAYC,EAAQjX,IACjCiX,GAAUjX,EAEZ+W,EAASjS,KAAK,CAACsS,WAAAA,EAAYC,QAAAA,KAG7B,IAAI,IAAIC,EAAQ,EAAGA,IAAUrkB,KAAK+M,QAASsX,EAAO,CAChD,MAAMC,EAAStkB,KAAK+M,MAAQsX,EACzBA,EAAQ,GAAKC,EAAS,GAGzBJ,EAAY,CAACG,EAAOC,IAEtB,IAAI,IAAID,EAAQ,EAAGA,IAAUrkB,KAAK+M,MAAQ,IAAKsX,EAC7C,IAAI,IAAIC,EAAS,EAAGA,IAAWtkB,KAAK+M,MAAQsX,IAASC,EAAQ,CAC3D,MAAMC,EAAQvkB,KAAK+M,MAAQsX,EAAQC,EAC/BD,EAAQ,GACNC,GAAWtkB,KAAKyhB,aAAe,IAAQ,EAAI,IAC3C8C,EAAQ,GAGdL,EAAY,CAACG,EAAOC,EAAQC,IAGhC,IAAI,IAAIF,EAAQ,EAAGA,IAAUrkB,KAAK+M,MAAQ,IAAKsX,EAC7C,IAAI,IAAIC,EAAS,EAAGA,IAAWtkB,KAAK+M,MAAQsX,IAASC,EACnD,IAAI,IAAIC,EAAQ,EAAGA,IAAUvkB,KAAK+M,MAAQsX,EAAQC,IAAUC,EAAO,CACjE,MAAMC,EAASxkB,KAAK+M,MAAQsX,EAAQC,EAASC,EAC1CF,EAAQ,GAAKC,EAAS,GAAKC,EAAQ,GAAKC,EAAS,GAGpDN,EAAY,CAACG,EAAOC,EAAQC,EAAOC,IAKzC,IAAIC,EAA0B,KAC1BC,EAAc,EAClB,IAAI,MAAMC,KAAWb,EAAU,CAC7B,MAAM,QAACM,EAASD,WAAYS,GAAUD,EAChCE,EAAYD,EAAOjkB,OACnBmkB,EAAcnE,GAAWyD,EAAS,GACpCpkB,KAAKmhB,SAAW0D,EAAY,GAC1BE,EAAgBpiB,KAAKC,OAAOwhB,GAE5BY,GADgBriB,KAAKH,OAAO4hB,GACpBW,EAAgB/kB,KAAKkhB,SAAY,IAAM,GAC/C+D,EAAO,MACX,IAAI,IAAIC,EAAO,EAAGA,IAASL,IAAaK,EACtC,GAAGN,EAAOM,EAAO,GAAKN,EAAOM,GAC3B,OAAO,IAGX,OAAO,GANI,GAQPrM,EAAOlW,KAAKoE,IAAI+d,EAAc9kB,KAAKohB,WAAa4D,EAAOC,IACzDR,GAAkB5L,EAAO6L,KAC3BD,EAAiBE,EACjBD,EAAc7L,GAIlB,MAAMsM,EAAgBV,EAAeN,WAChCiB,EAAiBX,EAAeL,QAC/BiB,EAAWF,EAAcxkB,OAE/B,IAAI2kB,EAAQ,EACRre,EAAI,EACR,IAAI,IAAIse,EAAM,EAAGA,IAAQF,IAAYE,EAAK,CACxC,MAAMC,EAAWL,EAAcI,GACzBE,EAAaL,EAAeG,GAC5B/jB,EAASmB,KAAKE,MAAM4iB,GAE1B,IAAIze,EAAI,EACR,IAAI,IAAI0e,EAAM,EAAGA,IAAQF,IAAYE,EAAK,CACxC,MAAMlD,EArYN,GAsYa,IAAR+C,EArYN,EADC,IAuYKA,IAAQF,EAAW,EApYtB,EAHF,IAwYa,IAARK,EApYL,EAJA,IAyYKA,IAAQF,EAAW,EAvYvB,EAFD,GA2YM9B,EAAQ1jB,KAAKqhB,OAAOiE,GACpB/jB,EAASmkB,IAAQF,EAAW,EAC7BxlB,KAAKihB,SAAWja,EACjBrE,KAAKE,MAAM6gB,EAAQ+B,GACvBnW,EAAOgW,GAAS,CACd/C,SAAU,CAACvb,EAAAA,EAAGC,EAAAA,EAAG1F,MAAAA,EAAOC,OAAAA,GACxBghB,MAAAA,GAGFxb,GAAKzF,EAAQvB,KAAKmhB,UAChBmE,EAEJre,GAAKzF,EAASxB,KAAKmhB,QAGrB,OAAO7R,GC3aI,SAASqW,GAAa/mB,GASnC,MACM+iB,EADW,IAAIX,GAASpiB,EAAQ6d,MAAO7d,EAAQqiB,SAAUriB,EAAQsiB,SAAUtiB,EAAQuiB,QAASviB,EAAQwiB,WAClFO,SAElBiE,EAAYjE,EAAOvP,MAAM2M,GDOxB,ECPiCA,EAAKyD,QACvCjhB,EAAQqkB,EAAUrD,SAAShhB,MAAQqkB,EAAUrD,SAASvb,EAEtD6e,EAAalE,EAAOvP,MAAM2M,GDKxB,ECLiCA,EAAKyD,QACxChhB,EAASqkB,EAAWtD,SAAS/gB,OAASqkB,EAAWtD,SAAStb,EAE1D/F,EAAYtC,EAAQsC,UAC1BA,EAAU+B,MAAM1B,MAAQA,EAAQ,KAChCL,EAAU+B,MAAMzB,OAASA,EAAS,KAClC,MAAMskB,EAAW5kB,EAAU4kB,SAE3BnE,EAAOvU,SAAQ,EAAEmV,SAAAA,EAAUC,MAAAA,GAAQnE,KACjC,IAAIha,EA8BJ,GA7BAA,EAAMyhB,EAASzH,GACXha,IACFA,EAAMvF,SAASC,cAAc,OAC7BmC,EAAUxB,OAAO2E,IAGnBA,EAAIjF,UAAUC,IAAI,aAAc,gBAEhCgF,EAAIpB,MAAM1B,MAASghB,EAAShhB,MAAQA,EAAQ,IAAO,IACnD8C,EAAIpB,MAAMzB,OAAU+gB,EAAS/gB,OAASA,EAAS,IAAO,IACtD6C,EAAIpB,MAAM4D,IAAO0b,EAAStb,EAAIzF,EAAS,IAAO,IAC9C6C,EAAIpB,MAAM0D,KAAQ4b,EAASvb,EAAIzF,EAAQ,IAAO,IDf1C,ECiBDihB,GDpBA,ECoByBA,IAC1Bne,EAAIpB,MAAM8iB,oBAAsB,WDlB9B,ECqBDvD,GDtBG,ECsBsBA,IAC1Bne,EAAIpB,MAAM+iB,uBAAyB,WDxBhC,EC2BFxD,GD5BA,EC4B0BA,IAC3Bne,EAAIpB,MAAMgjB,qBAAuB,WD5B9B,EC+BFzD,GD9BG,EC8BuBA,IAC3Bne,EAAIpB,MAAMijB,wBAA0B,WAGnCtnB,EAAQunB,SAAU,CACnB,MAAMC,EAAWtnB,SAASC,cAAc,OACxCqnB,EAAShnB,UAAUC,IAAI,oBAEvBgF,EAAI3E,OAAO0mB,O,eC1DV,MAAMC,GAAuC,GAC9CpJ,GAAM,CAAC/Y,EAA2EoiB,KACnFpiB,aAAgBqiB,kBAAoBriB,aAAgBsiB,iBAAkBtiB,EAAKuiB,IAAMH,EAC5EpiB,aAAgBwiB,gBAAiBxiB,EAAKyiB,eAAe,KAAM,OAAQL,GACtEpiB,EAAKjB,MAAM2jB,gBAAkB,OAASN,EAAM,KAIpC,SAASO,GACtB3iB,EACAoiB,EACAxhB,EACAgiB,GAAW,GAEX,IAAIR,EAGF,OAFA5Y,QAAQC,MAAM,8BAA+BzJ,EAAMoiB,QACnDxhB,GAAYA,KAId,GAAKuhB,GAAWC,IAAwBQ,GAAa5iB,aAAgBsiB,iBAChEtiB,GACD+Y,GAAI/Y,EAAMoiB,GAGZxhB,GAAYA,QAEP,CACL,MAAMiiB,EAAU7iB,aAAgBqiB,iBAC1BS,EAASD,EAAU7iB,EAA2B,IAAI+iB,MAExDD,EAAOP,IAAMH,EAEbU,EAAO5mB,iBAAiB,QAAQ,MAC1B2mB,GAAW7iB,GACb+Y,GAAI/Y,EAAMoiB,GAGZD,GAAWC,IAAO,EAIlBxhB,GAAYA,MACX,CAAC0C,MAAM,IAEP1C,GACDkiB,EAAO5mB,iBAAiB,SAAUqN,IAChCC,QAAQC,MAAM,gCAAiCF,EAAK6Y,EAAKU,GACzDliB,QAMD,SAASoiB,GAA0BhjB,EAAgDoiB,EAAaQ,GACrG,OAAO,IAAI3jB,SAAe4B,IACxB8hB,GAAmB3iB,EAAMoiB,EAAKvhB,EAAS+hB,MCvD5B,SAASK,GACtBjmB,EACAkmB,EACAd,EACAe,EACAC,EAAWpmB,EACXqmB,GAsCA,OApCGF,GACDD,EAAMhoB,UAAUC,IAAI,WAGN,IAAI8D,SAAe4B,IAMjC8hB,GAAmBO,EAAOd,GAAK,KAC7B9c,GAAA,gBAA4BtI,GAAW,KACrComB,EAAS5nB,OAAO0nB,GAEhBriB,IAKGsiB,GACDD,EAAMhnB,iBAAiB,gBAAgB,KACrCoJ,GAAA,UAAqB,KACnB4d,EAAMhoB,UAAUkB,OAAO,WAEpBinB,GACDA,EAAWjnB,cAGd,CAACkH,MAAM,a,qCC7BL,MAAMggB,GAqBnB5nB,YAAYhB,GAfJ,KAAA6oB,OAAS,EACV,KAAAC,UAAW,EAEX,KAAA5d,QAAmC,KAEnC,KAAA6d,UAAW,EACV,KAAAC,YAAa,EACb,KAAAC,YAAa,EACb,KAAAC,gBAAiB,EACjB,KAAAC,aAAqC,SA8FtC,KAAAC,QAAW3nB,IACbA,IACD,EAAA4nB,EAAA,GAAY5nB,GAGXL,KAAKkoB,UAAU9oB,UAAUiG,SAAS,UAChCrF,KAAKmoB,UACNnoB,KAAKmoB,SAAS9nB,GAGbL,KAAK8J,SAAW9J,KAAK8J,QAAQse,QAC9BpoB,KAAK8J,QAAQse,UA5FdxpB,IACD,EAAAoS,EAAA,GAAWhR,KAAMpB,GAGhBoB,KAAK2nB,WACN3nB,KAAK8nB,gBAAiB,GAInBO,mBAAmBzpB,EAGrB,IACCoB,KAAKkoB,YACPloB,KAAKkoB,UAAYppB,SAASC,cAAc,OACxCiB,KAAKkoB,UAAU9oB,UAAUC,IAAI,uBAE1BT,EAAQ0pB,OACTtoB,KAAKkoB,UAAU9oB,UAAUC,IAAI,aAAeT,EAAQ0pB,OAGnD1pB,EAAQ2pB,MACTvoB,KAAKkoB,UAAU9oB,UAAUC,IAAI,kBAG5BW,KAAK6nB,YACN7nB,KAAKkoB,UAAU9oB,UAAUC,IAAI,yBAK5BmpB,wBACLxoB,KAAKqoB,qBAGAI,YACLzoB,KAAKyoB,UAAY,KAEjBzoB,KAAKqoB,qBAELroB,KAAKkoB,UAAU5jB,UAAY,0HAEmDtE,KAAK6nB,WAAa,cAAgB,+DACvE7nB,KAAK6nB,WAAa,KAAO,aAAa7nB,KAAK6nB,WAAa,KAAO,YAAY7nB,KAAK6nB,WAAa,GAAK,mEAIxI7nB,KAAK6nB,WACN7nB,KAAK0oB,YAAc,mBAEnB1oB,KAAK0oB,YAAc,mBAGlB1oB,KAAK4nB,YACN5nB,KAAKkoB,UAAU5jB,WAAa,kxEAc5BtE,KAAK2oB,YAAc3oB,KAAKkoB,UAAUzjB,iBAClCzE,KAAK4oB,UAAY5oB,KAAK2oB,YAAYE,wBAElC7oB,KAAKkoB,UAAU9oB,UAAUC,IAAI,mBAG/BW,KAAK8oB,OAAS9oB,KAAKkoB,UAAUa,kBAAkBA,kBAAkBA,kBAE9D/oB,KAAK4nB,aACN,QAAiB5nB,KAAKkoB,UAAWloB,KAAKgoB,SAoBnCgB,oBAAoBC,GACzBjpB,KAAKmoB,SAAWc,EAGXC,YACLlpB,KAAKkoB,UAAU9oB,UAAUC,IAAI,UAC7BW,KAAKmpB,YAAY,GAGZC,cAActf,GACnB,GAAG9J,KAAK2nB,UAAY3nB,KAAK8J,QAAS,OAElC9J,KAAK8J,QAAUA,EAEf,MAAM2d,IAAWznB,KAAKynB,OAChBhiB,EAAYC,KAAKC,MAEjBX,EAASyI,IAGb,GAFA3D,EAAQuf,OAASvf,EAAQwf,UAAY,KAElC7B,IAAWznB,KAAKynB,OACjB,OAGF,MAAMxhB,EAAcP,KAAKC,MAAQF,EAIjC,IAAIgI,GAAOzN,KAAK4nB,WAAY,CAC1B5nB,KAAKmpB,YAAY,KAEjB,MAAMhjB,EAAQ,IAEXF,EAAcE,EACfnG,KAAKupB,SAELnjB,YAAW,KACNqhB,IAAWznB,KAAKynB,QACjBznB,KAAKupB,WAENpjB,QAGFnG,KAAK8nB,gBACN9nB,KAAKwpB,OAAOxpB,KAAKkoB,UAAUtkB,gBAC3B,UAAQ,KACN5D,KAAKkpB,gBAGPlpB,KAAKupB,SAITvpB,KAAK8J,QAAUA,EAAU,MAG3BA,EACCpI,MAAK,IAAMsD,EAAM,QACjB6I,OAAOJ,GAAQzI,EAAMyI,KAEnB3D,EAAQ2f,mBACT3f,EAAQ2f,mBAAmBC,IAKzB,GAAGjC,IAAWznB,KAAKynB,OAAQ,OAG3B,MAAMkC,EAAWD,EAAQE,KAAOF,EAAQG,MAAQ,IAChD7pB,KAAKmpB,YAAYQ,MAKhBH,OAAOtlB,EAAeiI,GAAQ,EAAOrC,GAe1C,GAdG9J,KAAKyoB,WACNzoB,KAAKyoB,YAGJzoB,KAAKkoB,UAAUtkB,eAChB5D,KAAKkoB,UAAU9oB,UAAUkB,OAAO,UAGlCN,KAAK0nB,UAAW,EAEb5d,GACD9J,KAAKopB,cAActf,GAGlB9J,KAAK0nB,UAAY1nB,KAAKkoB,UAAUtkB,gBAAkBM,EAAM,CACzD,MAAM4lB,GAAU,EAAAC,GAAA,GAAQ/pB,KAAKkoB,WAAa,EAAI,EAC3CloB,KAAKkoB,UAAUtkB,gBAAkBM,GAClCA,EAAKlE,KAAK+nB,cAAc/nB,KAAKkoB,YAG/B,QAAcloB,KAAKkoB,UAAW,cAAc,EA/N1B,SA+NiDle,EAAW8f,GAG7E9pB,KAAK4nB,YAAczb,GACpBnM,KAAKmpB,YAAY,GAIdI,SACFvpB,KAAK0nB,WAKR1nB,KAAK0nB,UAAW,EAIb1nB,KAAKkoB,WAAaloB,KAAKkoB,UAAUtkB,gBAY9B,QAAc5D,KAAKkoB,UAAW,cAAc,EA7P9B,KA6PsD,KAClEloB,KAAKkoB,UAAU5nB,WACd,IAMJ6oB,YAAYQ,GACjB,GAAI3pB,KAAK0oB,cAAgB,EAAAqB,GAAA,GAAQ/pB,KAAK8oB,QAItC,GAAgB,IAAba,EAKH,IACM3pB,KAAK0oB,cACP1oB,KAAK0oB,YAAc1oB,KAAK8oB,OAAOkB,kBAIjChqB,KAAK8oB,OAAO7lB,MAAMgnB,gBAAuBtnB,KAAKH,IAAI,EAAGmnB,EAAW,IAAM3pB,KAAK0oB,aAAe,KAAO1oB,KAAK0oB,YACtG,MAAMjb,SAXNzN,KAAK8oB,OAAO7lB,MAAMgnB,gBAAkB,I,0BCxQ1C,MAAMC,GAAgC,GACtC,IAAIC,IAAkB,EAEP,SAASC,GAAsC1L,EAAUO,EAA6B,QACnG,IAAIP,EAAMjC,MAAM9b,OACd,OAAOwC,QAAQ4B,QAAQ,IAGzB,MAAM+E,EAAU4U,EAAM5U,SAAU,UAIhC,OAHAogB,GAAWjL,GAAQP,GACnB2L,KAEOvgB,EAGT,SAASugB,KACHF,IAWN,SAA6CzL,GAC3C,IAAIA,EAAMjC,MAAM9b,OAEd,OADA+d,EAAM5U,QAAQ/E,QAAQ,IACf5B,QAAQ4B,QAAQ,IAGzB,MAAMulB,EAAO5L,EAAMjC,MAAM/b,QACnB6pB,EAAsC,GAE5C,OAAO,IAAIpnB,SAAwB,CAAC4B,EAASylB,KAC3C,MAAMC,EAAI,KAAW,O,EAAA,K,OAAA,E,EAAA,YACnB,MAAMC,EAAQC,YAAYhlB,MAE1B,EAAG,OACK,WACN,MAAMilB,EAAkBlM,EAAMmM,QAAQC,MAAMpM,EAAMqM,QAAST,EAAKpd,SAChE,IAAI8d,EAEJ,GAAGJ,aAA2BznB,QAC5B,IACE6nB,QAAmBJ,EACnB,MAAMnd,GAEN,YADA+c,EAAO/c,QAITud,EAAaJ,EAGfL,EAAQ1Y,KAAKmZ,SACPV,EAAK3pB,OAAS,GAAMgqB,YAAYhlB,MAAQ+kB,EAAS,GAEtDJ,EAAK3pB,OAAS,GACf,SAAQ8pB,GAGR1lB,EAAQwlB,I,YA1BS,K,gRA8BrB,SAAQE,MAEP/oB,KAAKgd,EAAM5U,QAAQ/E,QAAS2Z,EAAM5U,QAAQ0gB,QAnD3CS,CADcf,GAAWhd,SACPge,SAAQ,KACxBf,IAAkB,EACfD,GAAWvpB,QACZ0pB,Q,eCzBR,IAAIc,GACAC,GASJ,SAASC,GACPC,EACAC,EACAC,EACAxoB,EAA4BlE,SAASC,cAAc,WAEnDiE,EAAOzB,MAAQ+pB,EAAI/pB,MACnByB,EAAOxB,OAAS8pB,EAAI9pB,OAEpB,MAAMiqB,EAAMzoB,EAAO6P,WAAW,KAAM,CAAC6Y,OAAO,IAS5C,OARG,MACDD,EAAIE,OAAS,QAAQJ,OACrBE,EAAIG,UAAUN,EAAe,GAATC,EAAsB,GAATA,EAAYvoB,EAAOzB,MAAiB,EAATgqB,EAAYvoB,EAAOxB,OAAkB,EAAT+pB,KAExFE,EAAIG,UAAUN,EAAK,EAAG,GACtBF,GAAaK,EAAK,EAAG,EAAGzoB,EAAOzB,MAAOyB,EAAOxB,OAAQ+pB,EAAQC,IAGxDxoB,EArBPmoB,GALE,KAKmBhoB,QAAQ4B,UAJR,6BAA6BrD,MAAMmqB,IACtDT,GAAeS,EAAEC,WA4BrB,MAAMC,GAAiC,IAAI9a,IAG5B,SAAS,GAAK+a,EAAiBT,EAtC/B,EAsCwDC,EArCpD,GAsCjB,IAAIQ,EACF,KAAM,wBAA0BA,EAG/BD,GAAM/qB,KAPQ,KAQf+qB,GAAMhhB,QAGR,MAAM/H,EAASlE,SAASC,cAAc,UACtCiE,EAAOrE,UAAY,mBAEnB,IAAIstB,EAASF,GAAMva,IAAIwa,GACvB,GAAIC,EA6BFjpB,EAAOzB,MAAQ0qB,EAAOjpB,OAAOzB,MAC7ByB,EAAOxB,OAASyqB,EAAOjpB,OAAOxB,OAC9ByqB,EAAOniB,QAAQpI,MAAK,KAClBsB,EAAO6P,WAAW,MAAM+Y,UAAUK,EAAOjpB,OAAQ,EAAG,EAAGA,EAAOzB,MAAOyB,EAAOxB,eAhCpE,CACV,MAAMsI,EAAiC,IAAI3G,SAAS4B,IAElDomB,GAAmBzpB,MAAK,KACtB,MAAM4pB,EAAM,IAAIrE,MAChBqE,EAAIY,OAAS,KAIO9B,GAAa,CAC3B3N,MAAO,CAAC,CAAC6O,EAAKC,EAAQC,EAAYxoB,IAClC+nB,QAAS,KACTF,QAASQ,IACR,WAEK3pB,MAAK,KACXqD,QAINumB,EAAI7E,IAAMuF,QAIdD,GAAM9O,IAAI+O,EAASC,EAAS,CAC1BjpB,OAAAA,EACA8G,QAAAA,IAUJ,OAAO,OAAP,wBACKmiB,GAAM,CACTjpB,OAAAA,I,0BCzFJ,MAAMmpB,IAAc,EAAAC,GAAA,GAAa,kuCAC3BC,IAAY,EAAAD,GAAA,GAAa,QAEhB,SAASE,GAAuBC,EAA8BC,GAAY,GACvF,IAAI5L,EASA6L,EAOJ,OAfID,EAKF5L,EAAM2L,aAAiBG,WAAaH,EAAQ,IAAIG,WAAWH,IAJ3D3L,EAAM,IAAI8L,WAAWP,GAAY7L,OAAOlP,MAAMC,KAAKkb,EAAM7rB,MAAM,IAAK2rB,KACpEzL,EAAI,KAAO2L,EAAM,GACjB3L,EAAI,KAAO2L,EAAM,IAOjBE,EADCD,EACU,GAAAG,UAAY,YAAc,aAE1B,aC3BA,SAAwBJ,EAAmBE,EAAmB,cAC3E,MAAO,QAAQA,YAAmBG,KAAKC,OAAOC,gBAAgBP,MD6BvDQ,CAAenM,EAAK6L,GElBd,SAASO,GAAuBnN,EAA6BoN,EAAgET,GAAY,GAGtJ,OAAOF,GAAuBW,EAAMV,MAAOC,GCF9B,SAASU,GAA0BrN,EAA6BoN,EAAgEE,GAC7I,MAAM7G,EAAM0G,GAAuBnN,EAAOoN,GAAO,GAEjD,IAAI7iB,EAA+ChJ,EACnD,GAAI+rB,EAGG,CACL,MAAM7d,EAAS,GAAKgX,GACpBlc,EAAUkF,EAAOtM,OACjB5B,EAAckO,EAAOxF,aALrBM,EAAU,IAAI6c,MACd7lB,EAAc8lB,GAA0B9c,EAASkc,GASnD,OAFAlc,EAAQhL,UAAUC,IAAI,aAEf,CAAC+nB,MAAOhd,EAAShJ,YAAAA,GCjBX,SAASgsB,GAAyBvN,EAA6BwN,EAA0BF,EAAkBG,GAAc,GACtI,IAAID,EAAaE,YAAe,CAAC,QAAS,OAAgCnmB,SAAUyY,EAAqB5f,OAASqtB,EAAa,CAC7H,GAAe,aAAZzN,EAAMjT,GAAoBygB,EAAaE,aAAeD,EACvD,OAAO,KAGT,MAAMlN,EAASP,EAAkBO,OAAUP,EAAqBQ,OAC1D4M,GAAQ7M,MAAAA,OAAK,EAALA,EAAOzf,QAASyf,EAAMhO,MAAMpR,GAAoB,sBAAXA,EAAK4L,IAA6B,KACrF,GAAGqgB,GAAU,UAAWA,EACtB,OAAOC,GAA0BrN,EAAOoN,EAAcE,GAI1D,OAAO,K,eCXM,SAASK,GACtB3N,EACAzV,EACA0V,EACAC,EACA0N,GAAS,EACTpgB,EACA4S,EACAQ,GAOA,IAAIzf,EALAyf,IACFA,EAAYb,GAAgBC,EAAOC,EAAUC,OAAW/V,EAAWiW,IAKrE,MAAMyN,EAAyB,aAAZ7N,EAAMjT,EAEvB5L,EADC0sB,GACM,QAAe7N,EAAqBU,GAAME,EAAkCF,GAAK,IAAMV,EAAqBW,GAAMC,EAAkCD,GAAK,MAEzJ,QAAeC,EAAkCF,GAAK,IAAME,EAAkCD,GAAK,KAG5G,IAAImN,GAAU,QAAc7N,EAAUC,GAEtC4N,EAAU3sB,EAAOA,EAAK4sB,OAAOD,EAASF,GAEtC,IAAII,GAAQ,EAoCZ,OAlCIH,IAAc,CAAC,QAAS,OAAOtmB,SAAUyY,EAAqB5f,QAC7D0tB,EAAQpsB,MAAQ,KAAOosB,EAAQnsB,OAAS,MACzCmsB,EAAU3sB,EAAOA,EAAK8sB,eAAc,QAAc,IAAK,OAGtDzgB,IACAA,EAAQA,SACPA,EAAQ0gB,cACR1gB,EAAQ2gB,MAAMC,SACb5gB,EAAQ6gB,SAAW7gB,EAAQ6gB,QAAQ1V,OAAO2V,UAAY9gB,EAAQ6gB,QAAQE,WAAWC,aAAe,QAGhGV,EAAQpsB,MAAQ,MACjBosB,GAAU,QAAc,IAAKA,EAAQnsB,QACrCqsB,GAAQ,GAITA,GAASF,EAAQpsB,MAAQ,KAAO8L,IACjCsgB,GAAU,QAAc,IAAKA,EAAQnsB,QACrCqsB,GAAQ,IAUVzjB,EAAQnH,MAAM1B,MAAQosB,EAAQpsB,MAAQ,KACtC6I,EAAQnH,MAAMzB,OAASmsB,EAAQnsB,OAAS,KAGnC,CAACif,UAAAA,EAAWzf,KAAAA,EAAM6sB,MAAAA,G,2SCtDZ,SAAeS,IAAU,MAACzO,EAAK,QAAExS,EAAO,UAAEnM,EAAS,SAAE4e,EAAQ,UAAEC,EAAS,SAAEwO,EAAQ,MAAEC,EAAK,cAAEC,EAAa,WAAEC,EAAU,KAAE1tB,EAAI,iBAAE2tB,EAAgB,aAAEC,EAAY,iBAAEC,EAAgB,OAAEC,EAAM,QAAEC,EAAO,SAAEC,EAAQ,UAAEC,EAAS,SAAEtc,EAAW,e,0CAoB5O,IAAMkN,EAAkBO,QAAUP,EAAqBQ,OAKrD,OAJGP,GAAYC,IAAc/e,GAAoB,aAAZ6e,EAAMjT,GACzC4gB,GAAkB3N,EAAO3e,EAAW4e,EAAUC,OAAW/V,EAAWqD,GAG/D,CACLuhB,aAAc,CACZ3B,MAAO9pB,QAAQ4B,UACfmqB,KAAM/rB,QAAQ4B,WAEhBoqB,OAAQ,CACNlC,MAAO,KACPiC,KAAM,MAERhH,UAAW,KACXZ,SAAU,MAId,IAAI8H,EAAsC,IAArBP,EAEjB7tB,SACcgJ,IAAb8V,IAAwBA,EAAWuP,EAAA,6BACrBrlB,IAAd+V,IAAyBA,EAAYsP,EAAA,0BAG1CnuB,EAAU9B,UAAUC,IAAI,mBACxB,IAIIkoB,EACAH,EACAiG,EANA/F,EAAWpmB,EAEX2sB,GAAQ,EACRyB,EAAiCnsB,QAAQ4B,UAI7C,MAAMwqB,EAAoB,aAAZ1P,EAAMjT,GAAwC,cAApBiT,EAAM2P,YAA8BxuB,EAM1E,GAFAomB,EAAQ,IAAIH,MAETnH,GAAYC,IAAc/e,EAAM,CACjC,MAAMic,EAAMuQ,GAAkB3N,EAAO3e,EAAW4e,EAAUC,OAAW/V,EAAWqD,OAASrD,EAAWulB,EAAQ,CAC1G3iB,EAAG,YACH2T,EAAGV,EAAMU,EACTC,EAAGX,EAAMW,EACTxf,KAAM6e,EAAM7e,KACZf,KAAM,aACJ+J,GAKJ,GAJAhJ,EAAOic,EAAIwD,UACXoN,EAAQ5Q,EAAI4Q,MACZR,QAAqB1a,EAAS8c,cAAcC,gBAAgB7P,EAAO7e,EAAKf,OAEpE4tB,EAAO,CACTvG,EAAWxoB,SAASC,cAAc,OAClCuoB,EAASloB,UAAUC,IAAI,4BACvBioB,EAASrkB,MAAM1B,MAAQ0b,EAAIjc,KAAKO,MAAQ,KACxC+lB,EAASrkB,MAAMzB,OAASyb,EAAIjc,KAAKQ,OAAS,KAE1C,MAAMmuB,EAAWvC,GAAyBvN,EAAOwN,GAAeyB,GAAQ,GACxE,GAAGa,EAAU,CACXL,EAAmBK,EAASvuB,YAC5B,MAAMmmB,EAAaoI,EAASvI,MAC5BG,EAAWnoB,UAAUC,IAAI,eACzB6B,EAAUxB,OAAO6nB,cAEC+G,GAAU,CAC1BptB,UAAAA,EACAmM,QAAAA,EACAwS,MAAAA,EACAC,SAAU,EACVC,UAAW,EACX/e,KAAAA,EACAytB,cAAAA,EACAD,MAAAA,EACAI,aAAAA,EACAF,WAAAA,EACAC,iBAAAA,EACAJ,SAAAA,EACAM,iBAAAA,EACAC,OAAAA,EACAC,SAAS,EACTE,WAAW,EACXtc,SAAAA,KAGqBwc,OAAOD,KACnB9vB,UAAUC,IAAI,cAAe,aAI1C6B,EAAU9B,UAAUC,IAAI,0BACxB6B,EAAUxB,OAAO4nB,SAGftmB,IACFA,EAAO4e,GAAgBC,EAAOC,EAAUC,GAAW,IAGrDsN,QAAqB1a,EAAS8c,cAAcC,gBAAgB7P,EAAO7e,MAAAA,OAAI,EAAJA,EAAMf,MAG3E,IAAI8uB,EAAS,CACX,MAAMY,EAAWvC,GAAyBvN,EAAOwN,GAAeyB,GAC7Da,IACDL,EAAmBnsB,QAAQC,IAAI,CAACksB,EAAkBK,EAASvuB,cAC3DmmB,EAAaoI,EAASvI,MACtBG,EAAWnoB,UAAUC,IAAI,eACzBioB,EAAS5nB,OAAO6nB,IAKtBH,EAAMhoB,UAAUC,IAAI,eAIpB,MAAMgoB,GAAcE,IAAe8F,EAAaE,aAAe,iCAAyCyB,EAExG,IAAI9G,EACJ,MAAM0H,EAAqBviB,MAAAA,OAAO,EAAPA,EAA6BuiB,kBACpDjB,IACEtB,EAAaE,aAAcqC,IAC7B1H,EAAY,IAAIV,GAAqB,CACnCO,aAAc,UACdJ,WAAYiI,KAIbA,IACD1H,EAAUkB,cAAcyG,EAAA,YAA6BD,IACrD1H,EAAUsB,OAAOtoB,GACjBkuB,OAAiBplB,IAKrB,MAeM8lB,EAAgBxJ,GACba,GAAsBjmB,EAAWkmB,EAAOd,EAAKe,EAAYC,EAAUC,GAGtEwI,EAAezJ,GAAgB,mCACnC,IAAGoI,GAAeA,IAAlB,CAEA,GAAGO,EAAW,CACZ,MAAM3f,EAAS,GAAKgX,EAAK,IACzB,OAAOhX,EAAOxF,QAAQpI,MAAK,IAElBouB,EAAaxgB,EAAOtM,OAAOgtB,eAItC,OAAOF,EAAaxJ,OAGtB,IAAIllB,EACJ,MAAM6uB,EACHjvB,EAA6Buf,GAAK,KAClCvf,EAA6Bwf,GAAK,KAC9B4O,EACDjuB,EAAO,IAAW,mCACnBiuB,IAAmBT,GAAoBzG,IACxCA,EAAUO,YACVP,EAAUgB,aAGZ,MAAMpf,EA5CmB,MAIzB,MAAMomB,EAAiBX,IAAUvuB,EAQjC,OAPgB6uB,EAAA,mBAAoC,CAClD7B,MAAOnO,EACPoN,MAAOjsB,EACPmvB,QAAS1B,MAAAA,OAAa,EAAbA,EAAe0B,QACxBC,UAAWF,OAAiBlmB,EAAYolB,KAmC1BiB,GACVhD,QAAqB1a,EAAS8c,cAAcC,gBAAgB7P,EAAO7e,MAAAA,OAAI,EAAJA,EAAMf,MAE7EioB,IACCmF,EAAaE,aACboB,GACDsB,GAEA/H,EAAUsB,OAAOtoB,GAAW,EAAO4I,GAGrCslB,OAAiBplB,EAEjB,MAAMsmB,EAAgBxmB,EAAQpI,KAAKquB,GAEnC,OADAO,EAAcziB,OAAM,SACb,CAAC0iB,SAAUzmB,EAAS0mB,OAAQF,MA8BrC,OA3BGpI,GACDA,EAAUc,oBAAoB7nB,GAG7BksB,EAAaE,WACd+B,EAAmBluB,SAAqBD,KAAQqvB,OAE5C/B,EAKMA,EAAc5c,KAAK,CAACxN,IAAKnD,EAAWC,KAAM,IAAMA,IAAOO,MAAK,EAAE6uB,SAAAA,KAAcA,MALnEnvB,SAAqBD,KAAQqvB,OAQ/C5B,GAAgBU,GACjBV,EAAa/c,KAAKyd,SAIdA,EAOC,CACLV,aAAc,CACZ3B,MAAOqC,EACPJ,KAAM9tB,GAAe+B,QAAQ4B,WAE/BoqB,OAAQ,CACNlC,MAAO1F,EACP2H,KAAM9H,GAERc,UAAAA,EACAZ,SAAAA,M,eCrRW,SAASmJ,GAAY7xB,EAEhC,IACF,MAAM8xB,EAAQ5xB,SAASC,cAAc,SAGrC,OAFIH,EAAQ+xB,MAAKD,EAAME,yBAA0B,GACjDF,EAAMlxB,aAAa,cAAe,QAC3BkxB,E,cCAM,SAASG,GAA6CC,GACnE,OCHa,SAAmDC,EAAgCD,GAChG,IACI1hB,EADA4hB,GAAU,EAGd,MAAO,IAAIC,KACT7hB,EAAO6hB,EAEFD,IACHA,GAAU,EAEVD,GAAY,KACVC,GAAU,EAEVF,KAAM1hB,QDVL8hB,CAAa,MAASJ,GEPhB,SAASK,GAASC,EAAsBC,GAAW,GAChE,MAAMC,EAAUvZ,SAASqZ,EAAM,GAAI,IAC7BG,EAAQ5uB,KAAK6uB,MAAMF,EAAU,MACnC,IAAIG,EAAe9uB,KAAK6uB,OAAOF,EAAmB,KAARC,GAAiB,IACvDG,EAAeJ,EAAmB,KAARC,EAA2B,GAAVE,EAK/C,OAHGF,IAAOF,GAAW,GAClBI,EAAU,KAAIA,EAAUJ,EAAW,IAAMI,EAAUA,GACnDC,EAAU,KAAIA,EAAU,IAAMA,IACzBH,EAAqCA,EAAQ,IAAM,IAAME,EAAU,IAAMC,E,oCCDnF,IAAI3G,GAMW,SAAS4G,GAAalyB,EAAcmyB,GAEjD,IAAI7G,GAAS,CACX,MAAM/nB,EAASlE,SAASC,cAAc,UACtCgsB,GAAU/nB,EAAO6P,WAAW,MAC5BkY,GAAQ6G,KAAOA,EAMjB,OAFgB7G,GAAQ8G,YAAYpyB,GAErB8B,MCFjB,MACMoZ,GAQD,IAAI1J,IAEH6gB,GAA8B,IAAIlT,IAC3BmT,GAAa,8HAE1B,IAAIC,IAAc,EAElB,SAASC,KACJD,KAIHA,IAAc,GACd,UAAQ,KACNA,IAAc,EAMhBF,GAAU1kB,QAAQ8kB,IAClBJ,GAAU/mB,YAWZ,SAASonB,GAAgB/nB,GACvB,MAAMnK,EAAOmK,EAAQxC,QAAQwqB,SAC7B,OAAGnyB,EACiBovB,EAAA,SAEgBpvB,GACtBsB,MAGP6I,EAAQ3D,wBAAwBlF,MAGzC,SAAS2wB,GAAY9nB,GAGnB,IAAIioB,EAAS1X,GAAInJ,IAAIpH,GACrB,MAAMkoB,GAAaD,EAEnB,IAAI,KAAC5yB,EAAI,WAAE8yB,EAAU,KAAElhB,EAAI,WAAEmhB,EAAU,KAAEZ,EAAI,UAAEa,EAAS,aAAEC,GAAgBL,GAAU,GAGjFC,IACD7yB,EAAO2K,EAAQuoB,YACfJ,EAAa9yB,EAAKkB,OAClB0Q,EAAgE,GAChEmhB,EAAanhB,EAAO,GAAKA,EAAO,IAGhCugB,EAAO,GAAGxnB,EAAQxC,QAAQgrB,YAAc,YAAmBb,KAK3DU,EAAYd,GAAalyB,EAAMmyB,GAE/Bc,EAAeP,GAAgB/nB,GAE/BioB,EAAS,CAAC5yB,KAAAA,EAAM8yB,WAAAA,EAAYlhB,KAAAA,EAAMmhB,WAAAA,EAAYZ,KAAAA,EAAMa,UAAAA,EAAWC,aAAAA,GAC/D/X,GAAIsC,IAAI7S,EAASioB,IAKnB,MAAMQ,EAAkBV,GAAgB/nB,GAClC0oB,EAAeR,GAAaI,IAAiBG,EAGnD,IAFCP,GAAaQ,IAAiBT,EAAOK,aAAeA,EAAeG,GAEjEC,EACD,GAAGL,EAAYC,EAAc,CAC3BtoB,EAAQ5K,aAAa,QAASC,GAC9B,IAAIszB,EAActzB,EACduzB,EAAeN,EACnB,KAAMK,EAAYpyB,OAAS,GAAG,CAC5B,IAAIsyB,EAAoBF,EAAYpyB,OACpC,MAAMuyB,EAAOV,IACX,EAAA3O,GAAA,GAAM2O,EAAaS,GAAqB,EAAG,EAAGA,EAAoB,IAClEtwB,KAAKH,IAAIywB,EAAoB5hB,EAAO,EAAG,GACnC8hB,EAAQJ,EAAYK,OAAO,EAAGF,GAAMzyB,QAAQ,OAAO,IACnD4yB,EAAQN,EAAYK,OAAOF,EAAO,GAAGzyB,QAAQ,OAAO,IAG1D,GAFAsyB,EAAcI,EAAQE,EACtBL,EAAerB,GAAaoB,EArGnB,IAqG2CnB,GACjDoB,EAAeN,EAAc,CAC9BtoB,EAAQuoB,YAAcQ,EAvGf,IAuGkCE,EACzC,OAKJhB,EAAOK,aAAeP,GAAgB/nB,QAGtCA,EAAQzF,gBAAgB,SA/E9BmB,OAAO1F,iBAAiB,UAAU,KAChC,IAAI,MAAOyP,KAAQ8K,GACjBmX,GAAUzyB,IAAIwQ,GAGhBoiB,OACC,CAACqB,SAAS,EAAM3rB,SAAS,IAgFrB,MAAM4rB,WAA8BC,YACzCC,oBAGE9Y,GAAIsC,IAAIjd,KAAM,MACXA,KAAK4H,QAAQwqB,SACdF,GAAYlyB,OAEZ8xB,GAAUzyB,IAAIW,MACdiyB,MAOJyB,uBACkB/Y,GAAIjL,OAAO1P,MAC3B8xB,GAAUpiB,OAAO1P,OCxJN,SAAS2zB,GAAYpH,EAAeqH,EAAW,GAC5D,GAAa,IAAVrH,EAAa,OAAO,QAAK,aAAc,CAAC,IAE3C,MACMsH,EAAKD,EAAW,EAAI,EAAIA,EAGxB7nB,EAAIpJ,KAAK6uB,MAAM7uB,KAAKmxB,IAAIvH,GAAS5pB,KAAKmxB,IAJlC,OAMV,OAAO,QAJsB,CAAC,aAAc,cAAe,cAAe,eAIxD/nB,GAAI,CAACgoB,YAAYxH,EAAQ5pB,KAAKqxB,IANtC,KAM6CjoB,IAAIkoB,QAAQJ,MCTtD,SAASK,GAAoB9pB,EAC1C+pB,EACAC,EACApvB,GAEA,MAAMqvB,EAAeC,IACnBF,EAAO,CAACptB,EAAGstB,EAAMC,MAAOttB,EAAGqtB,EAAME,MAAOF,MAAAA,KAGpCG,EAAaH,IACjBx1B,SAASuH,oBAAoB,YAAaguB,GAC1CjqB,EAAQhK,iBAAiB,YAAas0B,EAAa,CAACltB,MAAM,IAC1DxC,GAASA,EAAM,CAACgC,EAAGstB,EAAMC,MAAOttB,EAAGqtB,EAAME,MAAOF,MAAAA,KAG5CI,EAAeJ,IACC,IAAjBA,EAAMz1B,QAKTs1B,EAAQ,CAACntB,EAAGstB,EAAMC,MAAOttB,EAAGqtB,EAAME,MAAOF,MAAAA,IACzCD,EAAYC,GAEZx1B,SAASsB,iBAAiB,YAAai0B,GACvCv1B,SAASsB,iBAAiB,UAAWq0B,EAAW,CAACjtB,MAAM,KARrD4C,EAAQhK,iBAAiB,YAAas0B,EAAa,CAACltB,MAAM,KAW9D4C,EAAQhK,iBAAiB,YAAas0B,EAAa,CAACltB,MAAM,IAG1D,MAAMmtB,EAAeL,IACnBA,EAAMM,iBACNR,EAAO,CAACptB,EAAGstB,EAAM/sB,QAAQ,GAAGhC,QAAS0B,EAAGqtB,EAAM/sB,QAAQ,GAAG/B,QAASqvB,SAAS,EAAMP,MAAAA,KAG7EQ,EAAcR,IAClBx1B,SAASuH,oBAAoB,YAAasuB,GAC1CvqB,EAAQhK,iBAAiB,aAAc20B,EAAc,CAACptB,SAAS,EAAOH,MAAM,IAC5ExC,GAASA,EAAM,CAACgC,EAAGstB,EAAM/sB,QAAQ,GAAGhC,QAAS0B,EAAGqtB,EAAM/sB,QAAQ,GAAG/B,QAASqvB,SAAS,EAAMP,MAAAA,KAGrFS,EAAgBT,IACpBH,EAAQ,CAACntB,EAAGstB,EAAM/sB,QAAQ,GAAGhC,QAAS0B,EAAGqtB,EAAM/sB,QAAQ,GAAG/B,QAASqvB,SAAS,EAAMP,MAAAA,IAClFK,EAAYL,GAEZx1B,SAASsB,iBAAiB,YAAau0B,EAAa,CAAChtB,SAAS,IAC9D7I,SAASsB,iBAAiB,WAAY00B,EAAY,CAACntB,SAAS,EAAOH,MAAM,KAK3E,OAFA4C,EAAQhK,iBAAiB,aAAc20B,EAAc,CAACptB,SAAS,EAAOH,MAAM,IAErE,KACL4C,EAAQ/D,oBAAoB,YAAaquB,GACzC51B,SAASuH,oBAAoB,YAAaguB,GAC1Cv1B,SAASuH,oBAAoB,UAAWouB,GAExCrqB,EAAQ/D,oBAAoB,aAAc0uB,GAC1Cj2B,SAASuH,oBAAoB,YAAasuB,GAC1C71B,SAASuH,oBAAoB,WAAYyuB,IFkG7CE,eAAeC,OAAO,0BAA2B1B,IG3JlC,MAAM2B,GAyBnBt1B,YACEhB,EAQA4B,EAAQ,GA7BH,KAAA20B,WAAY,EAIX,KAAAC,OAKH,GAOK,KAAAC,gBAAiB,EACjB,KAAAC,cAAe,EACf,KAAAC,UAAW,EA0DX,KAAAlB,YAAeC,IACvBt0B,KAAKw1B,MAAMlB,IAGH,KAAAI,YAAeJ,I,MACvBt0B,KAAKwG,KAAOxG,KAAKkB,UAAUuF,wBAC3BzG,KAAKm1B,WAAY,EACjBn1B,KAAKw1B,MAAMlB,GACXt0B,KAAKkB,UAAU9B,UAAUC,IAAI,eAClB,QAAX,EAAAW,KAAKo1B,cAAM,eAAEV,cAAe10B,KAAKo1B,OAAOV,YAAYJ,IAG5C,KAAAG,UAAaH,I,MACrBt0B,KAAKm1B,WAAY,EACjBn1B,KAAKkB,UAAU9B,UAAUkB,OAAO,eACrB,QAAX,EAAAN,KAAKo1B,cAAM,eAAEX,YAAaz0B,KAAKo1B,OAAOX,UAAUH,IAQ3C,KAAApmB,QAAU,K,MACf,MAAM1N,GAASR,KAAKy1B,KAAKj1B,MACzBR,KAAK01B,UAAUl1B,IACJ,QAAX,EAAAR,KAAKo1B,cAAM,eAAEO,UAAW31B,KAAKo1B,OAAOO,QAAQn1B,KAvE5C,EAAAwQ,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,iBAG1BW,KAAKs1B,aACNt1B,KAAKkB,UAAU9B,UAAUC,IAAI,iBACrBW,KAAKq1B,gBACbr1B,KAAKkB,UAAU9B,UAAUC,IAAI,mBAG/BW,KAAK41B,OAAS92B,SAASC,cAAc,OACrCiB,KAAK41B,OAAOx2B,UAAUC,IAAI,yBAE1B,MAAMo2B,EAAOz1B,KAAKy1B,KAAO32B,SAASC,cAAc,SAChD02B,EAAKr2B,UAAUC,IAAI,uBAEnBo2B,EAAKx1B,KAAO,QACZw1B,EAAKI,KAAO,GAAK71B,KAAK61B,KACtBJ,EAAK7yB,IAAM,GAAK5C,KAAK4C,IACrB6yB,EAAKjzB,IAAM,GAAKxC,KAAKwC,IACrBizB,EAAKj1B,MAAQ,GAAKA,EAEfA,GACDR,KAAKmpB,YAAY3oB,GAGnB,MAAMs1B,EAAU,GAAK91B,KAAK61B,KACpBvQ,EAAQwQ,EAAQtf,QAAQ,KAC9BxW,KAAK4zB,UAAsB,IAAXtO,EAAe,EAAIwQ,EAAQn1B,OAAS2kB,EAAQ,EAI5DtlB,KAAKkB,UAAUxB,OAAOM,KAAK41B,OAAQH,GAGjCj1B,YACF,OAAQR,KAAKy1B,KAAKj1B,MAGbu1B,YAAYX,GACjBp1B,KAAKo1B,OAASA,EAqBTY,eACLh2B,KAAKy1B,KAAKr1B,iBAAiB,QAASJ,KAAKkO,SACzClO,KAAKi2B,iBAAmB/B,GAAoBl0B,KAAKkB,UAAWlB,KAAK00B,YAAa10B,KAAKq0B,YAAar0B,KAAKy0B,WAShGtL,YAAY3oB,GACjBR,KAAKy1B,KAAKj1B,MAAQ,GAAKA,EACvBR,KAAK01B,WAAW11B,KAAKy1B,KAAKj1B,OAGrB01B,YAAY11B,GACjBR,KAAKy1B,KAAKj1B,MAAQ,KAAOR,KAAKy1B,KAAKj1B,MAAQA,GAC3CR,KAAK01B,WAAW11B,KAAKy1B,KAAKj1B,OAGrBk1B,UAAUl1B,GACf,IAAImpB,GAAYnpB,EAAQR,KAAK4C,MAAQ5C,KAAKwC,IAAMxC,KAAK4C,KACrD+mB,GAAW,EAAA9F,GAAA,GAAM8F,EAAU,EAAG,GAG3B3pB,KAAKs1B,aACNt1B,KAAK41B,OAAO3yB,MAAMkzB,UAAY,UAAUxM,KAExC3pB,KAAK41B,OAAO3yB,MAAM1B,MAAoB,IAAXooB,EAAkB,IAIvC6L,MAAMlB,G,MACd,MAAM8B,EAAUp2B,KAAKu1B,SAAWv1B,KAAKwG,KAAKhF,OAASxB,KAAKwG,KAAKjF,MACvD80B,GAAkB,EAAAxS,GAAA,GAAM7jB,KAAKu1B,WAAajB,EAAMrtB,EAAIjH,KAAKwG,KAAK8vB,QAAUhC,EAAMttB,EAAIhH,KAAKwG,KAAKG,KAAM,EAAGyvB,GAE3G,IAAI51B,EAAQR,KAAK4C,IAAOyzB,EAAkBD,GAAWp2B,KAAKwC,IAAMxC,KAAK4C,KAerE,OAbIpC,EAAQR,KAAK4C,KAAS5C,KAAKwC,IAAMxC,KAAK4C,KAAO,IAC/CpC,GAASR,KAAK61B,KAAO,IAGvBr1B,GAASA,EAAMyzB,QAAQj0B,KAAK4zB,UAC5BpzB,GAAQ,EAAAqjB,GAAA,GAAMrjB,EAAOR,KAAK4C,IAAK5C,KAAKwC,KAKpCxC,KAAKmpB,YAAY3oB,IACN,QAAX,EAAAR,KAAKo1B,cAAM,eAAEO,UAAW31B,KAAKo1B,OAAOO,QAAQn1B,GAErCA,EAGF+1B,kBACFv2B,KAAKi2B,mBACNj2B,KAAKi2B,mBACLj2B,KAAKi2B,iBAAmB,MAG1Bj2B,KAAKy1B,KAAKpvB,oBAAoB,QAASrG,KAAKkO,SAE5ClO,KAAKo1B,OAAS,IClKH,MAAMoB,WAA0BtB,GAQ7Ct1B,YAAYouB,EAA6CnG,EAAsBwN,EAA0BC,GACvGz1B,MAAM,CACJg2B,KAAM,IAAO,GAAK,IAClBjzB,IAAK,EACLJ,IAAK,EACL6yB,eAAAA,EACAC,aAAAA,GACC,GAZK,KAAAmB,YAAc,EAuDd,KAAAC,aAAe,KACvB12B,KAAKwC,IAAMxC,KAAKguB,MAAMnoB,SACtB7F,KAAKy1B,KAAKj2B,aAAa,MAAO,GAAKQ,KAAKwC,MAGhC,KAAAm0B,QAAU,KAClB32B,KAAKmpB,eAGG,KAAAyN,OAAS,KACjB,IAAIxxB,EAAI,KACNpF,KAAKmpB,cAELnpB,KAAKy2B,YAAcz2B,KAAKguB,MAAM6I,OAAS,EAAI/wB,OAAOS,sBAAsBnB,IAGvEpF,KAAKy2B,aACN3wB,OAAOgxB,qBAAqB92B,KAAKy2B,aAGhCz2B,KAAK6nB,YACN7nB,KAAK+2B,kBAGP/2B,KAAKy2B,YAAc3wB,OAAOS,sBAAsBnB,IAGxC,KAAA4xB,aAAe,KACpBh3B,KAAKguB,MAAM6I,SACZ72B,KAAKmpB,cAEFnpB,KAAK6nB,YACN7nB,KAAK+2B,oBAKD,KAAAE,WAAc52B,IACtBL,KAAK+2B,mBA/EF/I,GACDhuB,KAAKk3B,SAASlJ,EAAOnG,GAIlBqP,SAASlJ,EAAyBnG,GAAa,GACjD7nB,KAAKguB,OACNhuB,KAAKu2B,kBAGJ1O,IAAe7nB,KAAKm3B,YACrBn3B,KAAKm3B,WAAar4B,SAASC,cAAc,OACzCiB,KAAKm3B,WAAW/3B,UAAUC,IAAI,wBAAyB,yBACvDW,KAAKkB,UAAU2C,QAAQ7D,KAAKm3B,aAEpBn3B,KAAKm3B,YACbn3B,KAAKm3B,WAAW/3B,UAAUoE,OAAO,QAASqkB,GAG5C7nB,KAAKguB,MAAQA,EACbhuB,KAAK6nB,WAAaA,IACdmG,EAAM6I,QAAU7I,EAAMoJ,YAAc,IACtCp3B,KAAK42B,SAGP,IAAIS,GAAa,EACjBr3B,KAAKs3B,aACLt3B,KAAKg2B,eACLh2B,KAAK+1B,YAAY,CACfrB,YAAa,KACX2C,GAAcr3B,KAAKguB,MAAM6I,OACzBQ,GAAcr3B,KAAKguB,MAAMhsB,SAG3ByyB,UAAYp0B,IAEVg3B,GAAcr3B,KAAKguB,MAAM3rB,UA8CrBmzB,MAAMn1B,GACd,MAAMk3B,EAAY13B,MAAM21B,MAAMn1B,GAE9B,OADAL,KAAKguB,MAAMoJ,YAAcG,EAClBA,EAGCR,kBACR,GAAGS,GAAA,oBAA6Cx3B,KAAKguB,OAAQ,OAC7D,MAAMyJ,EAAMz3B,KAAKguB,MAAM0J,SACjBC,EAAYF,EAAI92B,OAEhBy2B,EAAcp3B,KAAKguB,MAAMoJ,YAC/B,IAAIQ,EAAe,EAAGC,EAAM,EAC5B,IAAI,IAAI9rB,EAAI,EAAGA,EAAI4rB,IAAa5rB,EAAG,CACjC,MAAM2e,EAAQ+M,EAAI/M,MAAM3e,GACrBqrB,GAAe1M,GAASA,GAASkN,IAClCA,EAAelN,EACfmN,EAAMJ,EAAII,IAAI9rB,IAQlB,MAAM4d,EAAW3pB,KAAKguB,MAAMnoB,SAAWgyB,EAAM73B,KAAKguB,MAAMnoB,SAAW,EACnE7F,KAAKm3B,WAAWl0B,MAAM1B,MAAoB,IAAXooB,EAAkB,IAIzC2N,aACRt3B,KAAKwC,IAAMxC,KAAKguB,MAAMnoB,UAAY,EAC/B7F,KAAKwC,IAAM,EACZxC,KAAK02B,eAEL12B,KAAKguB,MAAM5tB,iBAAiB,aAAcJ,KAAK02B,cAI5CvN,cACL,GAAGqO,GAAA,oBAA6Cx3B,KAAKguB,OAAQ,OAC7D,MAAMoJ,EAAcp3B,KAAKguB,MAAMoJ,YAE/Bv3B,MAAMspB,YAAYiO,GAGbpB,eACLn2B,MAAMm2B,eACNh2B,KAAKguB,MAAM5tB,iBAAiB,QAASJ,KAAK22B,SAC1C32B,KAAKguB,MAAM5tB,iBAAiB,OAAQJ,KAAK42B,QACzC52B,KAAKguB,MAAM5tB,iBAAiB,aAAcJ,KAAKg3B,cAC/Ch3B,KAAK6nB,YAAc7nB,KAAKguB,MAAM5tB,iBAAiB,WAAYJ,KAAKi3B,YAG3DV,kBACL12B,MAAM02B,kBAEHv2B,KAAKguB,QACNhuB,KAAKguB,MAAM3nB,oBAAoB,aAAcrG,KAAK02B,cAClD12B,KAAKguB,MAAM3nB,oBAAoB,QAASrG,KAAK22B,SAC7C32B,KAAKguB,MAAM3nB,oBAAoB,OAAQrG,KAAK42B,QAC5C52B,KAAKguB,MAAM3nB,oBAAoB,aAAcrG,KAAKg3B,cAClDh3B,KAAK6nB,YAAc7nB,KAAKguB,MAAM3nB,oBAAoB,WAAYrG,KAAKi3B,aAGlEj3B,KAAKy2B,cACN3wB,OAAOgxB,qBAAqB92B,KAAKy2B,aACjCz2B,KAAKy2B,YAAc,I,eC7KV,SAASqB,GAA6BzqB,G,MACnD,OAAGA,EAAQC,OACF,CACLf,OAAQc,EAAQC,QAGX,CACLyqB,SAA+C,QAApC,EAAA1qB,EAA4B2qB,gBAAQ,eAAEC,W,yBCgBvD,MAAMC,GAA2C,IAAIC,QAErD,qBAA2B,mBAAoB5rB,IAC5B6E,MAAMC,KAAKvS,SAASwS,iBAAiB,6BAA6B/E,QAC1Ea,SAAShD,IAChB,MAAMguB,EAAYF,GAAQ1mB,IAAIpH,GAG3BguB,GACDA,EAAUC,eAKD,MAAMC,GAUnB14B,YAAYhB,GANJ,KAAAkB,WAAY,EACZ,KAAAy4B,eAAgB,EAChB,KAAAC,QAAS,EAKfx4B,KAAKoK,QAAUtL,SAASC,cAAc,QACtCiB,KAAKoK,QAAQhL,UAAUC,IAAI,cAC3BW,KAAKoK,QAAQ5K,aAAa,MAAO,QAE9BZ,GACDoB,KAAKq4B,OAAOz5B,GAGds5B,GAAQjb,IAAIjd,KAAKoK,QAASpK,MAGrBy4B,WAAW75B,GAChB,GAAIA,EAIJ,IAAI,MAAMmN,KAAKnN,EAAS,CAEtB,MAAM4B,EAAQ5B,EAAQmN,GAED,iBAAZ,IAEP/L,KAAKoK,QAAQxC,QAAQmE,GAAKvL,EAAQ,IAAwB,kBAAZ,GAAyBA,EAAQA,GAAS,KAI1FR,KAAK+L,GAAKvL,GAID63B,OAAOz5B,G,mDAClBoB,KAAKy4B,WAAW75B,GAEhB,IAAIm5B,EAAW/3B,KAAK+3B,SACpB,QAAgB/tB,IAAb+tB,EAMD,YALyB/tB,IAAtBhK,KAAK04B,eACNX,GAAW,EAAAW,GAAA,GAAaX,EAAU/3B,KAAK04B,aAAc14B,KAAK04B,oBAG5D,EAAAC,EAAA,GAAa34B,KAAKoK,SAAS,EAAAwuB,GAAA,GAAcb,IAQ3C,QAJmB/tB,IAAhBhK,KAAKuM,SACNvM,KAAKuM,OAAS,OAGbvM,KAAKuM,SAAW,UAAmBvM,KAAKw4B,QAIzC,EAAA5qB,EAAA,GAAe5N,KAAKoK,SAAS,QAAKpK,KAAKu4B,cAAgB,QAAU,sBAJhB,CACjD,MAAM5lB,EAAwB,QAAb,EAAA3S,KAAK2S,gBAAQ,QAAI,cAClC,EAAAgmB,EAAA,GAAa34B,KAAKoK,cAAe,EAAAyuB,GAAA,GAAa74B,KAAKuM,OAAQvM,KAAKF,UAAWE,KAAKu4B,cAAev4B,KAAK04B,aAAc/lB,M,oRCxFzG,SAAemmB,GAAiBzrB,G,qCAC7C,MAAM0rB,EAA2Bj6B,SAASC,cAAc,QACxDg6B,EAAY35B,UAAUC,IAAI,gBAE1B,MAAM25B,EAAS3rB,EAAQC,SAAW,UAAkBD,EAAQd,SAAW,SAUvE,GATAwsB,EAAYr5B,OACVs5B,GACE,QAAK,WACL,IAAIV,GAAU,OAAD,wBACRR,GAA6BzqB,IAAQ,CACxCmrB,OAAQnrB,EAAQd,SAAW,YAC1BnC,gBAGE,wCAA8CiD,EAAQd,UAAWysB,EAAQ,CAChF,MAAMZ,EAAY,IAAIE,GAAU,CAAC/rB,OAAQc,EAAQd,SAASnC,QAC1D2uB,EAAYr5B,OAAO,MAAO04B,GAG5B,OAAOW,G,+RCtBM,SAASE,GAAa5rB,GACnC,MAAMkE,EAAkBzS,SAASC,cAAc,QAI/C,OAHAwS,EAAGnS,UAAUC,IAAI,aACjBkS,EAAG7R,OAAOuU,EAA8B,IAAIvO,KAAoB,IAAf2H,EAAQ8F,QAElD5B,E,2SCwVT,SAAS2nB,GAA2BpR,GAAiB,GACnD,MAAMI,EAAY,IAAIV,GAAqB,CAACI,YAAY,EAAME,eAAAA,IAQ9D,OAPAI,EAAUO,YAENX,IACFI,EAAUY,OAAOnC,eAAe,KAAM,IAAK,MAC3CuB,EAAUQ,YAAc,cAGnBR,EAxUT,qBAA2B,uBAAuB,EAAEiR,KAAAA,EAAM5sB,OAAAA,MACxD4sB,EAAK/rB,SAASH,IACZ,MAAMmsB,EAAO,cAAcnsB,qBAAuBV,MACjD6E,MAAMC,KAAKvS,SAASwS,iBAAiB,0BAA0B8nB,4BAA+BA,MAA4BhsB,SAASlJ,IAClIA,EAAK9E,UAAUkB,OAAO,sBAuUrB,MAAM+4B,GAAmB,CAACC,EAAqBC,KACpD,IAAIC,EAAmBC,EAErB,MAAMC,GAAaJ,EAAOl6B,UAAUiG,SAAS,qBACvCnE,GAAY,EAAAy4B,GAAA,GAAgBL,EAASI,EAAyB,gBAAb,YACvD,GAAGx4B,EAAW,CACZ,MAAMk4B,EAAO,+BACPQ,EAAoB,wBAAwBR,IAClD,IAAIS,EAOJ,GAHEA,EAHEP,EAAOjiB,QAAQuiB,GAGL,CAACA,GAFD,CAAC,kBAAkBR,IAAQ,eAAeA,KAKrDM,EAAW,CACZ,MAAMI,EAAS,yBACfD,EAAYA,EAAUlf,KAAKof,GAAMD,EAASC,IAG5C,MAAMC,EAAWH,EAAUlW,KAAK,MAE1BsW,EAAW7oB,MAAMC,KAAKnQ,EAAUoQ,iBAAiB0oB,IACjD3b,EAAM4b,EAASzjB,QAAQ8iB,GAEvBY,EAA0BD,EAAStf,KAAKvQ,IAAY,CAAEmC,OAAQnC,EAAQxC,QAAQ2E,OAAOsO,WAAY5N,KAAM7C,EAAQxC,QAAQqF,QAE7HusB,EAAOU,EAAWx5B,MAAM,EAAG2d,GAC3Bob,EAAOS,EAAWx5B,MAAM2d,EAAM,GAUlC,OANIob,EAAK94B,QAAU84B,EAAK,GAAGxsB,IAAMssB,GAAeC,EAAK74B,QAAU64B,EAAKA,EAAK74B,OAAS,GAAGsM,IAAMssB,MACxFC,EAAMC,GAAQ,CAACA,EAAKU,UAAWX,EAAKW,YAKhC,CAACX,EAAMC,IAGD,MAAMW,WAAqB5G,YAA1C,c,oBAIS,KAAA6G,UAAW,EACX,KAAAC,cAAe,EAEf,KAAAC,YAAa,EAMZ,KAAAtxB,eAAiB,IAAI,IAKhBunB,S,oDACXxwB,KAAKZ,UAAUC,IAAI,SACnBW,KAAK2S,SAAW,aAEhB3S,KAAK4H,QAAQqF,IAAM,GAAKjN,KAAKqN,QAAQJ,IACrCjN,KAAK4H,QAAQ2E,OAAS,GAAKvM,KAAKqN,QAAQd,OAExC,MAAMiuB,GAAM,EAAAC,GAAA,GAAoBz6B,KAAKqN,SAC/BqtB,EAA2B,UAAbF,EAAIv6B,KAClB06B,GAAW36B,KAAKs6B,cAAgBI,EAChCE,EAAa56B,KAAKqN,QAAQmL,OAAOqiB,YACjCjL,EAAgC,QAAZ,EAAA5vB,KAAKqN,eAAO,eAAEuiB,kBAElCkL,EAAc3J,GAAwB,EAAfqJ,EAAI30B,UAEjC7F,KAAKsE,UAAY,wOAQjB,MAAMd,EAASxD,KAAK+oB,kBAEdgS,EAAcj8B,SAASC,cAAc,OAC3Cg8B,EAAY37B,UAAUC,IAAI,kBAEI,UAAbm7B,EAAIv6B,MAAoBD,KAAKqN,SAAWrN,KAAKqN,QAAQmL,OAAOwiB,cAE3Eh7B,KAAKZ,UAAUC,IAAI,aAGlBuwB,IACD5vB,KAAKZ,UAAUC,IAAI,eACnBW,KAAKN,OAAOq7B,IAGd,MAAME,QAAoBN,EA7T9B,SAAgCO,G,0CAC9BA,EAAQ97B,UAAUC,IAAI,YAEtB,MAAMgO,EAAU6tB,EAAQ7tB,QAClBmtB,GAAM,EAAAC,GAAA,GAAoBptB,GAE7BA,EAAQmL,OAAO4F,KAChB8c,EAAQ97B,UAAUC,IAAI,UAGxB,IAAI87B,EAAYX,EAAIY,WAAWhpB,MAAMipB,GAA8B,2BAAhBA,EAAUzuB,IAA6EuuB,UAAY,IAAIzO,WAAW,IACrKyO,EAhHK,SAAwBA,GACxBA,aAAoBzO,aACvByO,EAAW,IAAIzO,WAAWyO,IAG5B,MACMG,EAD6B,EAAlBH,EAASx6B,OACI,EAAI,EAClC,IAAI26B,EACF,OAAO,IAAI5O,WAAW,IAGxB,IAAIpd,EACJ,IACE,MAAMisB,EAAW,IAAIC,SAASL,EAASM,QACvCnsB,EAAS,IAAIod,WAAW4O,GACxB,IAAI,IAAIvvB,EAAI,EAAGA,EAAIuvB,EAAYvvB,IAAK,CAClC,MAAM2vB,EAAgB,EAAJ3vB,EAAQ,EAAI,EACxB4vB,EAAe,EAAJ5vB,EAAQ,EACnBvL,EAAQ+6B,EAASK,UAAUF,GAAW,GAC5CpsB,EAAOvD,GAAMvL,GAASm7B,EAAY,IAEpC,MAAMluB,GACN6B,EAAS,IAAIod,WAAW,IAY1B,OAAOpd,EA8EIusB,CAAeV,EAASz6B,MAAM,EAAG,KAE5C,MAAM,IAACo7B,EAAK56B,UAAW66B,EAAY,OAAEC,GA7EvC,SAA4Bb,EAAsBt1B,GAChD,MAGMo2B,EAAe5M,EAAA,WAAsB,GAAK,GAG1C6M,EAAO7M,EAAA,WAAsB,IAAM,IACnC8M,EAAO9M,EAAA,WAAsB,IAAM,IACnC2M,GAAS,EAAAnY,GAAA,GAAMhe,EAAW,GAAKs2B,EAAMD,EAAMC,GAE3CL,EAAMh9B,SAASs9B,gBAAgB,6BAA8B,OACnEN,EAAI18B,UAAUC,IAAI,uBAClBy8B,EAAInV,eAAe,KAAM,QAAS,GAAKqV,GACvCF,EAAInV,eAAe,KAAM,SAAU,GAAKsV,GACxCH,EAAInV,eAAe,KAAM,UAAW,OAAOqV,KAAUC,KAIrD,MAAMI,EAAY15B,KAAKH,OAAO24B,GACxBmB,EAASnB,EAASx6B,OAASw6B,EAASx6B,OAAS,IAC7C47B,EAAW55B,KAAKC,IAAKo5B,EAAS,EAA0B,EAAGM,GAEjE,IAAIE,EAAW,EACf,MAAMC,EAAWR,EArBI,EAuBrB,IAAI73B,EAAO,GACX,IAAI,IAAI2H,EAAI,EAAG2wB,EAAO,EAAGC,EAAO,EAAG5wB,EAAIuwB,IAAUvwB,EAAG,CAClD,MAAMvL,EAAQ26B,EAASpvB,IAAM,EAC7B,GAAI4wB,EAAOJ,GAAaD,EAAQ,CAC9BK,EAAOA,EAAOJ,EAAWD,EACzBK,GAAQJ,EAAW,GAAK,GACvBC,EAAWh8B,IAAOg8B,EAAWh8B,GAG9B,MAAMo8B,EAAYj6B,KAAKH,KAAMg6B,EAAWC,GAAcJ,EAAY,GAAK,IAAOA,EAAY,GAhCzE,GAqCjBj4B,GAHU,oBACCs4B,SAAYT,EAAeW,wBAA0CA,mCAIhFF,GAAQG,EAGNL,EADCG,GAAQJ,EAAW,GAAK,EACd,EAEA/7B,OAGVg8B,EAAWh8B,IAAOg8B,EAAWh8B,GAEhCm8B,GAAQJ,EAIZ,MAAMr7B,EAAYpC,SAASC,cAAc,OAKzC,OAJAmC,EAAU9B,UAAUC,IAAI,kBACxB6B,EAAUxB,OAAOo8B,GAEjBA,EAAIt3B,mBAAmB,YAAaJ,GAC7B,CAAC03B,IAAAA,EAAK56B,UAAAA,EAAW86B,OAAAA,GAgBuBc,CAAmB3B,EAAUX,EAAI30B,UAE1Ek3B,EAAmBhB,EAAah4B,WAAU,GAChDg5B,EAAiB39B,UAAUC,IAAI,uBAC/B08B,EAAa38B,UAAUC,IAAI,6BAE3B,MAAM29B,EAAoBl+B,SAASC,cAAc,OACjDi+B,EAAkB59B,UAAUC,IAAI,4BAChC29B,EAAkBt9B,OAAOq8B,EAAcgB,GAEvC,MAAME,EAAUn+B,SAASC,cAAc,OACvCk+B,EAAQ79B,UAAUC,IAAI,cACtB67B,EAAQx7B,OAAOs9B,EAAmBC,GAElC,IAAIC,EAAWpB,EAiFf,MA/Ee,KACb,IAAIqB,EAAQjC,EAAQiC,MAEpB,MAQMnG,EAAe,KACnB+F,EAAiB95B,MAAM1B,MAAS47B,EAAM/F,YAAc+F,EAAMt3B,SAAW,IAAO,OAG1Es3B,EAAMtG,QAAWsG,EAAM/F,YAAc,GAAK+F,EAAM/F,cAAgB+F,EAAMt3B,WACxEmxB,IAGF,MAAMoG,EAAsBvM,GAAgBmG,GAqD5C,OApDAkE,EAAQmC,iBAAiB,aAAcD,GACvClC,EAAQmC,iBAAiB,QAASD,GAClClC,EAAQmC,iBAAiB,QAnBJ,MACnB,UAAc,MACRF,IACJnG,KACQmG,EAAMtG,SACbqE,MAgBLA,EAAQoC,aAAa57B,MAAK,KACxB,IAAIyzB,GAAY,EAAOoI,GAAY,EAiCnC,SAAS/H,EAAMn1B,GACb,IAAIm9B,EACJ,GAAGn9B,aAAao9B,WACdD,EAAUn9B,EAAEm9B,YACP,CACL,MAAMh3B,EAAQnG,EAAE8G,OAAuBV,wBACvC+2B,EAAUn9B,EAAEq9B,cAAc,GAAGnJ,MAAQ/tB,EAAKG,KAG5C,MAAM4wB,EAAYiG,EAAUxB,EAAqBmB,EAAMt3B,SACvDs3B,EAAM/F,YAAcG,EA1CtB2F,EAAS98B,iBAAiB,cAAeC,IACpC80B,IACDgI,EAAM96B,OACN8yB,GAAY,GAEdoI,GAAY,KAEdL,EAAS98B,iBAAiB,aAAcC,IACtCk9B,GAAY,EACTpI,GAAWK,EAAMn1B,MAEtB68B,EAAS98B,iBAAiB,aAAcC,IACtCA,EAAEu0B,iBACc,IAAbv0B,EAAExB,SACDs+B,EAAMtG,QACRsG,EAAMn7B,QAGRwzB,EAAMn1B,GACN80B,GAAY,MAEd+H,EAAS98B,iBAAiB,WAAYC,IACjCk9B,GAAapI,IACdgI,EAAM96B,OACN8yB,GAAY,OAGhB,QAAiB+H,GAAW78B,KAC1B,EAAA4nB,EAAA,GAAY5nB,GACR88B,EAAMtG,QAAQrB,EAAMn1B,QAezBs9B,GAAA,GAEI,KACLT,EAAS58B,SACT48B,EAAW,KACXC,EAAQ,UAqN0BS,CAAiB59B,MA9MzD,SAAyBk7B,G,gDACvB,MAAMb,EAAWa,EAAQb,SAEnBhtB,EAAU6tB,EAAQ7tB,QAClBmtB,GAAM,EAAAC,GAAA,GAAoBptB,GAE1BstB,EAAuB,UAAbH,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,KACtC49B,EAAgB/+B,SAASC,cAAc,OAC7C8+B,EAAcz+B,UAAUC,IAAI,qBAE5B,MAAMy+B,EAAiBtD,EAAIY,WAAWhpB,MAAMgnB,GAAoB,2BAAXA,EAAKxsB,IAE1D,IAAI+tB,EAAS,CACX,MAAMoD,EAA2B,IAC9BD,MAAAA,OAAc,EAAdA,EAAgBE,YACjBD,EAAMlsB,MAAK,EAAA+mB,GAAA,GAAckF,EAAeE,YAGvC3D,EACD0D,EAAMlsB,KAAKoD,EAAmB5H,EAAQ8F,OAC7B4qB,EAAMp9B,QACfo9B,EAAMlsB,KAAK8hB,GAAY6G,EAAIx5B,OAG1Bk6B,EAAQX,YACTwD,EAAMlsB,WAAWinB,GAAiBzrB,IAGpCwwB,EAAcn+B,WAAU,QAAiBq+B,EAAO,QAQlD7C,EAAQ12B,mBAAmB,YALd,wJAOb,MAAMy5B,EAAU/C,EAAQh2B,cAAc,gBAEhCg5B,EAAmB,IAAI3K,GAC7B2K,EAAiBt2B,QAAQgrB,WAAasI,EAAQtzB,QAAQgrB,WACtDsL,EAAiBt2B,QAAQwqB,SAAW8I,EAAQtzB,QAAQwqB,SACjDuI,EACDuD,EAAiBx+B,aAAao5B,GAAiBzrB,KAE/C,EAAAsrB,EAAA,GAAauF,GAAkB,EAAAtF,GAAA,GAAmC,QAArB,EAAAkF,MAAAA,OAAc,EAAdA,EAAgBhvB,aAAK,QAAI0rB,EAAI2D,YAG5EF,EAAQv+B,OAAOw+B,GAEZhD,EAAQX,YACT0D,EAAQv+B,OAAOu5B,GAAa5rB,IAG9B,MAAM+wB,EAAclD,EAAQh2B,cAAc,mBAuC1C,OAtCAk5B,EAAY1+B,OAAOm+B,GAEJ,KACb,IAAIQ,GAAW,EAEXC,EAAe,IAAI9H,GAAkB0E,EAAQiC,MAAO3C,EAAI+D,mBAE5DrD,EAAQmC,iBAAiB,SAAS,KAChCnC,EAAQ97B,UAAUkB,OAAO,uBAEzB89B,EAAYI,UAAUC,YAAYZ,GAClCQ,GAAW,KAGb,MAAMzH,EAAS,KACTyH,IACFnD,EAAQ97B,UAAUC,IAAI,uBACtBg/B,GAAW,EAERC,GACDF,EAAYI,UAAUC,YAAYH,EAAap9B,aAWrD,OANAg6B,EAAQmC,iBAAiB,OAAQzG,KAE7BsE,EAAQiC,MAAMtG,QAAUqE,EAAQiC,MAAM/F,YAAc,IACtDR,IAGK,KACL0H,EAAa/H,kBACb+H,EAAap9B,UAAUZ,SACvBg+B,EAAe,UAoH4CI,CAAU1+B,MAEjE2+B,EAAe3+B,KAAKkF,cAAc,eACxCy5B,EAAar6B,UAAYw2B,EAEzB,MAAM/K,EAAS/vB,KAAK+vB,OAAU6O,IAC5B5+B,KAAK+vB,YAAS/lB,EAEd,MAAMmzB,EAAQn9B,KAAKm9B,MAAQ3F,GAAA,WAAoCx3B,KAAKqN,QAASuxB,GAEvEtB,EAAet9B,KAAKs9B,cAAe,UACtCt9B,KAAKm9B,MAAM0B,YAAc7+B,KAAKm9B,MAAM2B,kBAAmBxB,EAAav4B,UAErE/E,KAAKq9B,iBAAiB,WAAW,IAAMC,EAAav4B,WAAW,CAACyC,MAAM,IAGxExH,KAAK++B,iBAAmB9D,IAExB,MAAM+D,EAAa,IAAM7N,GAA6B,EAApBgM,EAAM/F,cAAoBuD,EAAW,MAAQG,EAAe,IAExFlE,EAAS,KACb+H,EAAaM,UAAYD,IACzBx7B,EAAOpE,UAAUoE,OAAO,WAAY25B,EAAMtG,WAGxCsG,EAAMtG,QAAWsG,EAAM/F,YAAc,GAAK+F,EAAM/F,cAAgB+F,EAAMt3B,WACxE+wB,IAGF,MAAMsI,EAAa,CAAC7+B,EAAWw2B,EAASsG,EAAMtG,UAG5C,GAFAx2B,IAAK,EAAA4nB,EAAA,GAAY5nB,GAEdw2B,EAAQ,CACT,MAAMsI,IAAqBn/B,KAAKo/B,cAChC,GAAG5H,GAAA,mBAA4Cx3B,KAAKo/B,eAAiB,CACnE7yB,OAAQ,MACRI,YAAa,CAACC,EAAG,4BACjByyB,WAAW,IACT,CACF,MAAO7F,EAAMC,GAAS0F,EAAwB9F,GAAiBr5B,KAAMA,KAAKqN,QAAQJ,KAAzC,GACzCuqB,GAAA,aAAsC,CAACjrB,OAAQvM,KAAKqN,QAAQd,OAAQU,IAAKjN,KAAKqN,QAAQJ,KAAMusB,EAAMC,GAGpG0D,EAAM96B,OAAOwL,OAAM,cAEnBsvB,EAAMn7B,SAsBV,OAlBA,QAAiBwB,GAASnD,GAAM6+B,EAAW7+B,IAAI,CAAC4I,eAAgBjJ,KAAKiJ,iBAErEjJ,KAAKq9B,iBAAiB,SAAS,KAC7B75B,EAAOpE,UAAUkB,OAAO,WACxBq+B,EAAaM,UAAYnE,KAG3B96B,KAAKq9B,iBAAiB,cAAc,MAC7BF,EAAM/F,aAAe+F,EAAMtG,QAAWW,GAAA,oBAA6C2F,KACxFwB,EAAaM,UAAYD,QAG3Bh/B,KAAKq9B,iBAAiB,SAAS,KAC7B75B,EAAOpE,UAAUkB,OAAO,cAG1BN,KAAKq9B,iBAAiB,OAAQzG,GAEvBsI,GAGT,GAAa,QAAV,EAAA1E,EAAIna,cAAM,eAAE1f,OAAQ,CACrB,MAAM2+B,EAAsB,GACtBC,QAAgBjR,GAAU,CAC9BzO,MAAO2a,EACPntB,QAAS,KACTnM,UAAWsC,EACXsc,SAAU,GACVC,UAAW,GACX6O,aAAc5uB,KAAK4uB,aACnBD,kBAAkB,EAClBF,cAAezuB,KAAKyuB,gBAEtBjrB,EAAOP,MAAM1B,MAAQiC,EAAOP,MAAMzB,OAAS,GACxC+9B,EAAQpQ,OAAOlC,OAAOqS,EAAKztB,KAAK0tB,EAAQpQ,OAAOlC,OAC/CsS,EAAQpQ,OAAOD,MAAMoQ,EAAKztB,KAAK0tB,EAAQpQ,OAAOD,MAEjDlvB,KAAKZ,UAAUC,IAAI,oBACnBigC,EAAKlyB,SAASke,GAAQA,EAAIlsB,UAAUC,IAAI,iBAG1C,GAAIu7B,EA2HMhL,IACR5vB,KAAKkoB,UAAYgR,IAA2B,GAC5Cl5B,KAAKkoB,UAAUkB,cAAcyG,EAAA,YAA6BD,IAC1D5vB,KAAK4H,QAAQgzB,WAAa,IAC1B56B,KAAKkoB,UAAUsB,OAAOuR,GAAa,QA/HrB,CACd,IAAI7S,EAAkCloB,KAAKkoB,UAE3C,MAAMsX,EAA4B,UAAbhF,EAAIv6B,KACzB8vB,EAAOyP,GAEP,MAAMp6B,EAAKq6B,IACT,GAAGz/B,KAAKm9B,MAAM1W,IACZ,OAGF+Q,GAAA,6BAAsDx3B,KAAKqN,QAAQd,OAAQvM,KAAKqN,QAAQJ,IAAKjN,KAAKqN,QAAQmL,OAAOknB,cAEjH,MAAMC,EAAiB,KAClBF,IACDjI,GAAA,eAAwCx3B,KAAKm9B,OAE1C,GAAAxQ,YAAc3sB,KAAKm9B,MAAM77B,WAC1BtB,KAAKm9B,MAAM77B,UAAW,KAO5B,GAFAq+B,KAEIzX,EACF,GAAGsS,EAAI+D,kBAAmB,CAGxB,IAAIqB,EAFJ5/B,KAAKZ,UAAUC,IAAI,mBAGnB,MAAMu3B,EAAS,KACb,MAAM1O,EAAYgR,IAA2B,GACvC2G,GAAW,UACjBA,EAASvW,UAAU,CAACM,KAAM,GAAIC,MAAO,MACrCgW,EAAShyB,OAAM,KACb7N,KAAKm9B,MAAMn7B,QACXw1B,GAAA,oBAAwCxtB,MAE1C61B,EAASzX,OAAS,KAChByX,EAASzX,OAASuV,GAAA,EAClB,MAAMlwB,EAAM,IAAIqyB,MACfryB,EAAYxN,KAAO,WACpB4/B,EAASrV,OAAO/c,IAElBya,EAAUsB,OAAOuR,GAAa,EAAO8E,GAErCD,EAAgB5/B,KAAKq9B,iBAAiB,SAAS,KAC7CwC,EAASzX,WACR,CAAC5gB,MAAM,IAEVm4B,KAOII,EAAoB//B,KAAKq9B,iBAAiB,OAAQzG,GACxD52B,KAAKs9B,aAAa57B,MAAK,KACrB1B,KAAKiJ,eAAe3I,OAAOy/B,GAC3B//B,KAAKiJ,eAAe3I,OAAOs/B,UAExB,CACL1X,EAAYgR,KAERuG,IACFz/B,KAAKs9B,cAAe,WAGtB,MAAMn8B,EAAO,KACXw+B,IAEA,MAAMpP,EAAWV,EAAA,mBAAoC,CAAC7B,MAAOwM,IAS7D,OAPIiF,GACFlP,EAAS7uB,MAAK,KACZ1B,KAAKs9B,aAAav4B,aAItBmjB,EAAUsB,OAAOuR,GAAa,EAAOxK,GAC9B,CAACA,SAAAA,IAGVrI,EAAUc,oBAAoB7nB,GAC9BA,IAIDnB,KAAKZ,UAAUiG,SAAS,mBACzB7B,EAAO9D,OAAOq7B,GAEd/6B,KAAKN,OAAOq7B,GAGd/6B,KAAKZ,UAAUC,IAAI,eAEnBW,KAAKs9B,aAAa57B,MAAK,KACrB1B,KAAKZ,UAAUkB,OAAO,eACtBy6B,EAAY37B,UAAUC,IAAI,cAC1B+G,YAAW,KACT20B,EAAYz6B,WACX,KAIEk3B,GAAA,sBAAiDx3B,KAAKm9B,QACvDn9B,KAAKm9B,MAAM96B,OACXm1B,GAAA,oBAAwCxtB,SAMlC,QAAV,EAAAhK,KAAKm9B,aAAK,eAAE1W,OACX+Y,EACDp6B,GAAE,IAEF,QAAiB5B,GAAQ,KACvB4B,GAAE,KACD,CAACoC,MAAM,EAAM8rB,SAAS,EAAM3rB,SAAS,EAAOsB,eAAgBjJ,KAAKiJ,sBAYxEo0B,uBACF,OAAOr9B,KAAKiJ,eAAe5J,IAAIW,KAAKm9B,OAGtCzJ,uBACEttB,YAAW,KACNpG,KAAKqK,cAILrK,KAAK++B,mBACN/+B,KAAK++B,mBACL/+B,KAAK++B,iBAAmB,MAGvB/+B,KAAKs9B,cACNt9B,KAAKs9B,aAAa9S,SAGjBxqB,KAAKiJ,iBACNjJ,KAAKiJ,eAAe0G,YACpB3P,KAAKiJ,eAAiB,MAGrBjJ,KAAKkoB,YACNloB,KAAKkoB,UAAY,SAElB,MAIP8M,eAAeC,OAAO,gBAAiBmF,I,2SC3qBvC,IAAI4F,GAA0B,EAuBf,SAAeC,IAAU,IAACzF,EAAG,UAAEt5B,EAAS,QAAEmM,EAAO,SAAEyS,EAAQ,UAAEC,EAAS,SAAEwO,EAAQ,MAAEC,EAAK,WAAEE,EAAU,cAAED,EAAa,OAAEyR,EAAM,MAAEC,EAAK,YAAEC,EAAW,iBAAEzR,EAAgB,aAAEC,EAAY,aAAEyR,EAAY,KAAEr/B,EAAI,cAAEo+B,EAAa,aAAEI,EAAY,SAAE7sB,EAAW,e,gDAqBzP,MAAMkc,EAAmB2Q,MAAAA,OAAY,EAAZA,EAAc9O,MACvC,IAAItB,EAAsC,IAArBP,EACrB,MAAMyR,IAAgBxgB,GAAYC,GAC5BwgB,GAEW,UAAb/F,EAAIv6B,MACFu6B,EAAIx5B,MApDoB,WAqDvBs/B,KAEc,QAAb9F,EAAIv6B,KAAiB,2BAAmC,8BAEhE,IAAIugC,EAAuBC,EAE3B,IAAIP,EAAQ,CACVM,EAAW1hC,SAASC,cAAc,QAClCyhC,EAASphC,UAAUC,IAAI,cACvB6B,EAAUxB,OAAO8gC,GAEjB,IAAIE,GAAiB,EACL,QAAblG,EAAIv6B,MACLugC,EAASvB,UAAY9N,GAASqJ,EAAI30B,UAAU,GAExCw6B,GAA6B,UAAb7F,EAAIv6B,OACnBsgC,IAAgBnR,EACjBoR,EAASphC,UAAUC,IAAI,QAAS,gBAEhCqhC,GAAiB,KAIrBF,EAASvB,UAAY,MAEjBsB,GAAgBF,IAClBK,GAAiB,EACjBtR,OAAiBplB,IAIlB02B,IACDD,EAAW3hC,SAASC,cAAc,QAClC0hC,EAASrhC,UAAUC,IAAI,aAAc,kBAAmB,aAAc,mBACtE6B,EAAUxB,OAAO+gC,IAIrB,IAiCIvY,EAjCApb,EAGA,GAEJ,GAAqB,cAAlB0tB,EAAIhL,UAA2B,CAChC,MAAMmR,QAAiBrS,GAAU,CAC/BzO,MAAO2a,EACPntB,QAAAA,EACAnM,UAAAA,EACA4e,SAAAA,EACAC,UAAAA,EACAwO,SAAAA,EACAC,MAAAA,EACAC,cAAAA,EACAC,WAAAA,EACAC,iBAAAA,EACAC,aAAAA,EACAC,iBAAAA,EACA7tB,KAAAA,EACA2R,SAAAA,IAKF,OAFA7F,EAAImgB,MAAQ0T,EACZ7zB,EAAI1L,YAAcu/B,EAAS/R,aAAaM,KACjCpiB,EAUT,MAAM4jB,EAAQD,KAGd,GAFAC,EAAMtxB,UAAUC,IAAI,eACpBqxB,EAAMkQ,OAAQ,EACE,UAAbpG,EAAIv6B,KAAkB,CACvB,MAAM4gC,EAAW/hC,SAASC,cAAc,OACxC8hC,EAASzhC,UAAUC,IAAI,cAAe,aACtCwhC,EAASj5B,QAAQqF,IAAM,GAAKI,EAAQJ,IACpC4zB,EAASj5B,QAAQ2E,OAAS,GAAKc,EAAQd,OACtCs0B,EAAiBxzB,QAAUA,EAE5B,MAAMrM,EAAOquB,EAAA,eACPyR,EAAW9/B,EAAKO,MAAQ,EACxBw/B,EAAc,IACdxV,EAASuV,EAA0B,EAAdC,EAC3BF,EAASv8B,UAAY,qCAAqCtD,EAAKO,kBAAkBP,EAAKO,6IACMw/B,UAAoBD,UAAiBA,SAAgBvV,sCAGjJ,MAAMzC,EAAS+X,EAAS9X,kBAAkBA,kBACtCiX,KACFA,GAA0B,EAAIr9B,KAAKq+B,GAAKzV,GAE1CzC,EAAO7lB,MAAMgnB,gBAAkB+V,GAA0B,IAAMA,GAC/DlX,EAAO7lB,MAAMg+B,iBAAmB,GAAKjB,GAErCQ,EAASphC,UAAUC,IAAI,SAENgO,EAAQmL,OAAOwiB,cAE9B6F,EAASzhC,UAAUC,IAAI,aAGzB,MAAM2D,EAASlE,SAASC,cAAc,UACtCiE,EAAOzB,MAAQyB,EAAOxB,OAASg5B,EAAIja,EAEnCsgB,EAASh9B,QAAQb,EAAQw9B,GACzBK,EAASnhC,OAAOgxB,GAChBxvB,EAAUxB,OAAOmhC,GAEjB,MAAMpV,EAAMzoB,EAAO6P,WAAW,MAKxBkd,EAAS,KACb,MAAM1iB,EAA4BwzB,EAAiBxzB,QAC7C6zB,EAAc1J,GAAA,WAAoCnqB,GAAU+hB,GAC5DrkB,EAAQ,MACX,wBAAoC5H,QAAQ4B,WAAWmmB,SAAQ,MAC3D,EAAAnB,GAAA,GAAQmX,KAIXA,EAAY76B,oBAAoB,OAAQuwB,GACxCsK,EAAY76B,oBAAoB,aAAc+2B,GAC9C8D,EAAY76B,oBAAoB,QAAS86B,GACzCD,EAAY76B,oBAAoB,QAASswB,QAIvCyK,EAAU,KACd3V,EAAIG,UAAUsV,EAAa,EAAG,GAE9B,MAAMld,EAASgc,GAA0BkB,EAAY9J,YAAc8J,EAAYr7B,SAAWm6B,GAG1F,OAFAlX,EAAO7lB,MAAMg+B,iBAAmB,GAAKjd,GAE7Bkd,EAAYrK,QAGhBG,EAAe,KACfkK,EAAYr7B,YAIZ,EAAAkkB,GAAA,GAAQmX,IAKTA,EAAYrK,QACbuK,IAGFZ,EAASvB,UAAY9N,GAAS+P,EAAYr7B,SAAWq7B,EAAY9J,aAAa,IAR5ErsB,MAWEqyB,EAAsBvM,GAAgBmG,GAEtCJ,EAAS,KACblG,EAAMtxB,UAAUC,IAAI,QACpBwhC,EAASzhC,UAAUkB,OAAO,cAC1B,SAAc8gC,EAASp+B,GAEpBklB,GAAaA,EAAUA,WAAaA,EAAUA,UAAU9oB,UAAUiG,SAAS,WAC5E6iB,EAAUF,WAIRmZ,EAAW,MACX,EAAApX,GAAA,GAAQmX,GAKZL,EAASzhC,UAAUC,IAAI,aAJrB0L,KAOE4rB,EAAU,KACdjG,EAAMtxB,UAAUkB,OAAO,QACvBugC,EAASzhC,UAAUC,IAAI,aAEvBqxB,EAAM0G,YAAc,EACpBoJ,EAASvB,UAAY9N,GAAS+P,EAAYr7B,UAAU,GAEjDq7B,EAAY9J,cACb8J,EAAY9J,YAAc,IAI9B8J,EAAY9gC,iBAAiB,OAAQw2B,GACrCsK,EAAY9gC,iBAAiB,aAAcg9B,GAC3C8D,EAAY9gC,iBAAiB,QAAS+gC,GACtCD,EAAY9gC,iBAAiB,QAASu2B,IAEtC,QAAiB3zB,GAAS3C,IAaxB,IAZA,EAAA4nB,EAAA,GAAY5nB,GAGT6nB,IAAcA,EAAUR,UACzBQ,EAAUF,UAQTkZ,EAAYrK,OAAQ,CACrB,MAAMsI,IAAqBC,EAC3B,GAAG5H,GAAA,mBAA4C4H,GAAiB,CAC9D7yB,OAAQ,MACRI,YAAa,CAACC,EAAG,4BACjByyB,WAAW,IACT,CACF,MAAO7F,EAAMC,GAAS0F,EAAwB9F,GAAiBwH,EAAUxzB,EAAQJ,KAAxC,GACzCuqB,GAAA,aAAsC,CAACjrB,OAAQc,EAAQd,OAAQU,IAAKI,EAAQJ,KAAMusB,EAAMC,GAG1FyH,EAAY7+B,YAEZ6+B,EAAYl/B,WAIbk/B,EAAYrK,OACVqK,EAAYr7B,UAAYq7B,EAAY9J,cAAgB8J,EAAYr7B,UAAYq7B,EAAY9J,YAAc,GACvGgK,IACApK,IACAtG,EAAMtxB,UAAUC,IAAI,SAEpB8hC,IAGFvK,KAIDvpB,EAAQmL,OAAOqiB,aACfgG,EAAiB9Q,OAASA,EAC3B8Q,EAASj5B,QAAQgzB,WAAa,KAE9B7K,SAGFW,EAAMpvB,UAAW,EAGnB,IAAIq/B,EA6CAtT,EA5CJ,GAAGhgB,EAAS,CAoBV,GAnBAszB,QAAiBrS,GAAU,CACzBzO,MAAO2a,EACPntB,QAAAA,EACAnM,UAAAA,EACA4e,SAAAA,EACAC,UAAAA,EACAwO,SAAAA,EACAC,MAAAA,EACAC,cAAAA,EACAC,WAAAA,EACAC,kBAAkB,EAClBC,aAAAA,EACAC,iBAAkB2Q,MAAAA,OAAY,EAAZA,EAAc3f,MAChC7e,KAAAA,EACA2R,SAAAA,IAGF7F,EAAImgB,MAAQ0T,GAEPJ,GAA4B,QAAb/F,EAAIv6B,MAAmBmgC,EAEzC,OADAtzB,EAAI1L,YAAcu/B,EAAS/R,aAAaM,KACjCpiB,EAGT,GAAGyhB,EAAU,CACX,MAAM8S,GAAiBV,EAASxR,OAAOlC,OAAS0T,EAASxR,OAAOD,MAAMtrB,cACtE8sB,EAAMnvB,OAAS8/B,EAAcC,eAAe,KAAM,SAClD5Q,EAAMlvB,QAAU6/B,EAAcC,eAAe,KAAM,UACnDD,EAAc3hC,OAAOgxB,KAWrBA,EAAM9sB,eAAiB1C,KACxBy/B,MAAAA,OAAQ,EAARA,EAAUrZ,WAAYpmB,GAAWxB,OAAOgxB,GAI3C,MAAMhB,EAAkB,IAAW,mCACjC,OAAOrC,QAAqB1a,EAAS8c,cAAcC,gBAAgB8K,YAG/D9K,IAEN,MAAM6R,EAAiBl0B,MAAAA,OAAO,EAAPA,EAASuiB,kBAC7B2R,GACDrZ,EAAY,IAAIV,GAAqB,CACnCO,aAAc,UACdJ,UAAU,IAEZO,EAAUkB,cAAcyG,EAAA,YAA6B0R,IACrDrZ,EAAUsB,OAAOtoB,GAAW,GAC5BkuB,OAAiBplB,GACRqjB,EAAaE,YAAeiN,EAAI+D,mBAAsB5P,EAIvD6L,EAAI+D,oBACZrW,EAAY,IAAIV,GAAqB,CACnCI,YAAY,EACZG,aAAc,aANhBG,EAAY,IAAIV,GAAqB,CACnCO,aAAc,YASlB,MAAMyZ,GAAiB,UA2BvB,GA1BA9Q,EAAMtwB,iBAAiB,SAAUC,IACP,IAArBqwB,EAAM/iB,MAAM8zB,MACb/zB,QAAQC,MAAM,SAAW+iB,EAAM/iB,MAAM8zB,KAAO,cAAgB/Q,EAAM/iB,MAAMN,SAGvE6a,IAAcqZ,GACfrZ,EAAUqB,SAGRiY,EAAeE,aACjBF,EAAez8B,YAEhB,CAACyC,MAAM,KAEV,EAAAm6B,GAAA,GAAYjR,GAAOhvB,MAAK,KACnBy+B,GACDyB,EAAA,eAAkClR,EAAOyP,GAGxCjY,IAAcqZ,GACfrZ,EAAUqB,SAGZiY,EAAez8B,aAGD,UAAby1B,EAAIv6B,KAAkB,CACvB,MAQMm9B,EAAsBvM,IARP,KACfH,EAAMmR,aAIVrB,EAASvB,UAAY9N,GAAST,EAAM7qB,SAAW6qB,EAAM0G,aAAa,OAKpE1G,EAAMtwB,iBAAiB,aAAcg9B,GAElCqD,GACD/P,EAAMtwB,iBAAiB,cAAc,KACnCoJ,GAAA,gBAA4Bi3B,GAAU,KACpCA,EAASngC,cAEV,CAACkH,MAAM,IAIdkpB,EAAMkQ,OAAQ,EACdlQ,EAAMrvB,MAAO,EAEbqvB,EAAMpvB,UAAW,EAEjB,IAAIwgC,EAAqB1S,IAAqC,QAAnB,EAAAuR,MAAAA,OAAQ,EAARA,EAAUzY,iBAAS,eAAEC,UAChE,MAAMhnB,EAAO,IAAW,mCACnB+mB,GAAakH,IAAmBT,IACjCzG,EAAUO,YACVP,EAAUgB,mBAGNwG,IACN,IAAItuB,EAA4B+B,QAAQ4B,UACxC,GAAImjB,IAAcqZ,GAAmB5S,EACnC,GAAItB,EAAaE,YAAeiN,EAAI+D,kBAK1B/D,EAAI+D,oBACTnP,EACDhuB,EAAc+B,QAAQqnB,UACb6C,EAAaE,YAAcrF,IACpCA,EAAUsB,OAAOtoB,GAAW,EAAO,MACnCwvB,EAAMtwB,iBAAiB,GAAAusB,UAAY,aAAe,WAAW,KAC3DzE,EAAUqB,WACT,CAAC/hB,MAAM,UAZyC,CACrD,MAAMsC,EAAU1I,EAAcuR,EAASovB,eAAeC,iBAAiB,CAAChU,MAAOwM,EAAKrK,QAAS1B,MAAAA,OAAa,EAAbA,EAAe0B,QAASC,UAAWhB,IAC7HlH,GACDA,EAAUsB,OAAOtoB,GAAW,EAAO4I,GAmCzC,OArBIslB,GAAkB0S,IACpBA,IACAA,EAAqB,MAGvB1S,OAAiBplB,EAEjB5I,EAAYM,MAAK,IAAW,oCACvBgtB,GAAeA,KAKF,UAAb8L,EAAIv6B,MACLu3B,GAAA,6BAAsDnqB,EAAQd,OAAQc,EAAQJ,IAAKI,EAAQmL,OAAOknB,oBAG9FhQ,IACN7I,GAAmB6J,EAAOrD,EAAa/G,MATrCkb,EAAez8B,eAUhB,SAEI,CAACwrB,SAAUnvB,EAAaovB,OAAQgR,MAqCzC,OAlCGtZ,IAAcqZ,GACfrZ,EAAUc,oBAAoB7nB,GAqBhB,QAAbq5B,EAAIv6B,MAAmBsgC,EAOxBzzB,EAAI1L,YAAeqtB,GAEhBA,EAAc5c,KAAK,CAACxN,IAAKnD,EAAWC,KAAM,IAAMA,IAAOO,MAAK,EAAE8uB,OAAAA,KAAYA,MAAWrtB,QAAQ4B,kBADvF5D,KAAQqvB,QAPjB,QAAiBtvB,GAAYb,KAC3B,EAAA4nB,EAAA,GAAY5nB,GACZogC,EAASngC,SACTa,MACC,CAACmyB,SAAS,EAAM9rB,MAAM,IAOpBsF,KClhBM,SAASm1B,IAAU,SAACj2B,EAAQ,cAAEk2B,EAAa,WAAExT,EAAU,UAAEyT,EAAS,cAAE1T,EAAa,MAAED,EAAK,KAAE4T,EAAI,aAAExT,EAAY,aAAE4Q,EAAY,SAAE7sB,EAAW,eAYpJ,MAAM8J,EAAiE,GAGvE,IAAI,MAAMpP,KAAWrB,EAAU,CAC7B,MAAMgiB,GAAQ,EAAAyM,GAAA,GAAoBptB,GAE5BrM,EAAwB,UAAZgtB,EAAMphB,EAAgBgT,GAAgBoO,EAAO,IAAK,KAAO,CAACzN,EAAGyN,EAAMzN,EAAGC,EAAGwN,EAAMxN,GACjG/D,EAAM5K,KAAK,CAAC7Q,KAAAA,EAAMgtB,MAAAA,EAAO3gB,QAAAA,IAQ3BsY,GAAa,CACXzkB,UAAWghC,EACXzlB,MAAOA,EAAM9B,KAAK5O,IAAM,CAAEwU,EAAGxU,EAAE/K,KAAKuf,EAAGC,EAAGzU,EAAE/K,KAAKwf,MACjDS,SAAUoO,EAAA,qBACVnO,SAAU,IACVC,QAAS,EACTgF,UAAU,IAGZ1J,EAAMrP,SAAQ,CAAC2R,EAAMV,KACnB,MAAM,KAACrd,EAAI,MAAEgtB,EAAK,QAAE3gB,GAAW0R,EAEzB1a,EAAM69B,EAAcpc,SAASzH,GACnCha,EAAIuD,QAAQqF,IAAM,GAAKI,EAAQJ,IAC/B5I,EAAIuD,QAAQ2E,OAAS,GAAKc,EAAQd,OAClC,MAAM6Z,EAAW/hB,EAAI0kB,kBAErB,IAAIsZ,EAEFA,EAH0B,UAAZrU,EAAMphB,EAGL0hB,GAAU,CACvBzO,MAAOmO,EACP3gB,QAAAA,EACAnM,UAAWklB,EACXtG,SAAU,EACVC,UAAW,EACXyO,MAAAA,EACAC,cAAAA,EACAC,WAAAA,EACA1tB,KAAAA,EACA4tB,aAAAA,EACAC,iBAAkB2Q,EAAa3f,MAC/BlN,SAAAA,IAGastB,GAAU,CACvBzF,IAAKntB,EAAQ2gB,MAAMlvB,SACnBoC,UAAWklB,EACX/Y,QAAAA,EACAyS,SAAU,EACVC,UAAW,EACXwO,UAAU,EACVC,MAAAA,EACAC,cAAAA,EACAC,WAAAA,EACAE,aAAAA,EACA4Q,aAAAA,EACA7sB,SAAAA,IAID0vB,GAAgBzT,GACjBA,EAAa/c,KAAKwwB,MD3DxBhT,EAAA,mBAA4B,gBAAgB,CAAChe,EAAMixB,KACjD,GAAGA,IAAO,YAAqBjxB,IAAS,WAAmB,CACzD,MAAM4oB,EAAW7oB,MAAMC,KAAKvS,SAASwS,iBAAiB,gCAChD/P,EAAQ8tB,EAAA,qBACRyR,EAAWv/B,EAAQ,EACnBgqB,EAASuV,EAAW,EAC1Bd,GAA0B,EAAIr9B,KAAKq+B,GAAKzV,EACxC0O,EAAS7sB,SAAShD,IAChBA,EAAQuc,eAAe,KAAM,QAAS,GAAKplB,GAC3C6I,EAAQuc,eAAe,KAAM,SAAU,GAAKplB,GAE5C,MAAMunB,EAAS1e,EAAQ2e,kBACvBD,EAAOnC,eAAe,KAAM,KAAM,GAAKma,GACvChY,EAAOnC,eAAe,KAAM,KAAM,GAAKma,GACvChY,EAAOnC,eAAe,KAAM,IAAK,GAAK4E,GAEtCzC,EAAO7lB,MAAMgnB,gBAAkB+V,GAA0B,IAAMA,GAC/DlX,EAAO7lB,MAAMg+B,iBAAmB,GAAKjB,U,2UEb5B,SAAeuC,IAAa,QAACl1B,EAAO,SAAEgtB,EAAQ,WAAEzH,EAAU,aAAE0H,EAAY,WAAEC,EAAU,cAAE6E,EAAa,aAAExQ,EAAY,iBAAEC,EAAgB,cAAEJ,EAAa,SAAE2D,EAAQ,SAAEzf,EAAW,aAAkB,aAAE0a,I,gDActMuF,IAAYA,EAAa,KACzBR,IAAUA,EAAW,IACzB,MAAMhD,EAAsC,IAArBP,EAEjB2L,EAAQntB,EAAQ2gB,MAA4ClvB,UAAcuO,EAAQ2gB,MAA2CC,QAA4BnvB,SACzJyiC,EAAiBl0B,MAAAA,OAAO,EAAPA,EAASuiB,kBAChC,GAAgB,UAAb4K,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,KAAkB,CACvE,MAAMuiC,EAAe,IAAIpI,GAczB,OAbAoI,EAAanI,SAAWA,EACxBmI,EAAan1B,QAAUA,EACvBm1B,EAAapT,eAAiBA,EAC9BoT,EAAa/T,cAAgBA,EAC7B+T,EAAa5T,aAAeA,EAEzB0L,IAAckI,EAAalI,aAAeA,GAC1C8E,IAAeoD,EAAapD,cAAgBA,GAC5C7E,IAAYiI,EAAajI,WAAaA,GAEzCiI,EAAa56B,QAAQgrB,WAAa,GAAKA,EACvC4P,EAAa56B,QAAQwqB,SAAWA,QAC1BoQ,EAAahS,SACZgS,EAGT,IAAIC,EAAcjI,EAAI2D,UAAY3D,EAAI2D,UAAUuE,MAAM,KAAO,GACzDC,EAAM,GACVA,EAAMF,EAAY9hC,OAAS,GAAKyQ,MAAMwxB,QAAQH,IAC5C,SAAqBA,EAAY7xB,MAAM8xB,MAAM,IAAK,GAAG,GAAG75B,eACxD,OAEF,IAAIg6B,EAAS/jC,SAASC,cAAc,OACpC8jC,EAAOzjC,UAAUC,IAAI,WAAY,OAAOsjC,KACxCE,EAAOj7B,QAAQk7B,MAAQ,GAAKtI,EAAIhqB,GAIhC,MAAMuyB,EAASjkC,SAASC,cAAc,OACtCgkC,EAAO3jC,UAAUC,IAAI,gBAErB,MAAM2jC,IAAe3V,EACfqC,EAAkB,IACfsT,EAAa3V,EAAe1a,EAAS8c,cAAcC,gBAAgB8K,GAI5E,GADAnN,QAAqBqC,KACP,QAAV,EAAA8K,EAAIna,cAAM,eAAE1f,SAAW0M,EAAQmL,OAAOqiB,aAAexN,EAAa/G,KAAoB,UAAbkU,EAAIv6B,KAA2D,CAC1I4iC,EAAOzjC,UAAUC,IAAI,uBAErB,IAAIigC,EAAiD,GAErD,GAAGjyB,EAAQmL,OAAOqiB,aAAe,CAAC,QAAS,SAASzzB,SAASozB,EAAIv6B,MAC/D8iC,EAAOz+B,UAAY,aAAa+oB,EAAa/G,QAC7CgZ,EAAKztB,KAAKkxB,EAAOha,uBACZ,CACQ4B,YAAYhlB,MAAzB,MACM45B,QAAgBjR,GAAU,CAC9BzO,MAAO2a,EACPntB,QAAS,KACTnM,UAAW6hC,EACXjjB,SAAU,GACVC,UAAW,GACX6O,aAAAA,EACAD,kBAAkB,EAClBF,cAAAA,EACAztB,KAAM4e,GAAgB4a,EAAK,GAAI,IAAI,GACnC7nB,SAAAA,IAGFowB,EAAO9/B,MAAM1B,MAAQwhC,EAAO9/B,MAAMzB,OAAS,GACxC+9B,EAAQpQ,OAAOlC,OAAOqS,EAAKztB,KAAK0tB,EAAQpQ,OAAOlC,OAC/CsS,EAAQpQ,OAAOD,MAAMoQ,EAAKztB,KAAK0tB,EAAQpQ,OAAOD,MAGnDoQ,EAAKlyB,SAASke,GAAQA,EAAIlsB,UAAUC,IAAI,yBAExC0jC,EAAO9D,UAAY0D,EAIrB,IAAIM,EAAWzI,EAAI2D,WAAY,EAAA+E,GAAA,GAAc1I,EAAI2D,WAAa,eACxCr/B,SAASC,cAAc,OAC/BK,UAAUC,IAAI,wBAC5B,MAAM8jC,EAAgE,CAACxP,GAAY6G,EAAIx5B,OAEpFq5B,GACD8I,EAAiBtxB,KAAKoD,EAAmB5H,EAAQ8F,OAGhDonB,GACD4I,EAAiBtxB,WAAWinB,GAAiBzrB,IAG/Cw1B,EAAOv+B,UAAY,OAChB+oB,EAAaE,aAAegU,IAAoBl0B,EAAQJ,IAAM,GAAK,wHAKtE,MAAMm2B,EAAUP,EAAO39B,cAAc,kBAC/Bg5B,EAAmB,IAAI3K,GAiB7B,GAhBA2K,EAAiBt2B,QAAQgrB,WAAa,GAAKA,EAC3CsL,EAAiBt2B,QAAQwqB,SAAWA,EACpC8L,EAAiBvL,YAAcsQ,EAG/BG,EAAQ1jC,OAAOw+B,GAEZ3D,GACD6I,EAAQ1jC,OAAOu5B,GAAa5rB,IAGdw1B,EAAO39B,cAAc,kBAC7BxF,WAAU,QAAiByjC,EAAkB,QAErDN,EAAOh/B,QAAQk/B,IAEXxB,GAAkBl0B,EAAQmL,OAAOqiB,cAAgBxtB,EAAQJ,IAC3D,OAAO41B,EAGT,IAAI9H,EAA0B7S,EAAkC,KAChE,MAAM6H,EAAS,KACb,GAAGgL,EAAa,CACdA,EAAY37B,UAAUC,IAAI,cAC1B,MAAMgkC,EAAetI,EACrB30B,YAAW,KACTi9B,EAAa/iC,WACZ,KACHy6B,EAAc,KAGb7S,IACDA,EAAY,OAIV/mB,EAAad,GAAc,mC,MAC/B,MAAMijC,GAAQjjC,GAAKA,EAAEkjC,UACf/I,QAAY7nB,EAAS6wB,eAAeC,OAAOZ,EAAOj7B,QAAQk7B,OAChE,IAAIvS,EACJ,MAAMJ,EAAU,gBAA4B,2CAAkDnmB,EAC9F,GAAIs5B,EAEG,GAAgB,QAAb9I,EAAIv6B,KAAgB,CAC5B,MAAMyjC,GAAyExb,GAAaA,EAAUR,SACtG6I,EAAWV,EAAA,mBAAoC,CAAC7B,MAAOwM,EAAKrK,QAAAA,IACzDuT,GACDnT,EAAS7uB,MAAK,KACZ0E,YAAW,IAAW,mCACpB,MAAMkgB,SAAaoJ,KAAmBpJ,IACtCxgB,OAAOqJ,KAAKmX,OACX,+BAAuC,IAAM,WAIpDiK,EADQ,QAA+BiK,EAAIhL,aAAwB,QAAV,EAAAgL,EAAIna,cAAM,eAAE1f,QAC1DkvB,EAAA,mBAAoC,CAAC7B,MAAOwM,EAAKrK,QAAAA,IAEjDN,EAAA,iBAAkC,CAAC7B,MAAOwM,EAAKrK,QAAAA,SAf1DI,EAAWV,EAAA,oBAAqC,CAAC7B,MAAOwM,EAAKrK,QAAAA,IAkB5D4K,IACDxK,EAAS7uB,KAAKquB,EAAQ4N,GAAA,GACtBzV,EAAUsB,OAAOuR,GAAa,EAAMxK,QAIjC0S,SAAUU,IAAoB,EAAAC,GAAA,GAAwB,CAAC5V,MAAOwM,IACrE,SAAS7nB,EAASovB,eAAe8B,cAAcF,GAAmB,CAChE5I,EAAc8H,EAAO39B,cAAc,sBACnC,MAAM4E,EAAU+lB,EAAA,oBAAqC,CAAC7B,MAAOwM,IAE7DtS,EAAY,IAAIV,GAChBU,EAAUsB,OAAOuR,GAAa,EAAOjxB,GACrCoe,EAAUc,oBAAoB7nB,QACzB,IAAIksB,EAAaE,YAAcgU,EAMpC,GALAxG,EAAc8H,EAAO39B,cAAc,sBACnCgjB,EAAY,IAAIV,GAAqB,CACnCG,WAAY4Z,IAGVA,EASG,CACL,MAAMuC,EAAgBjU,EAAA,YAA6B0R,GACnDrZ,EAAUkB,cAAc0a,GACxB5b,EAAUsB,OAAOuR,GACjB+I,EAAcpiC,KAAKquB,EAAQ4N,GAAA,QAZ3BzV,EAAUO,YACVP,EAAUgB,YACVhB,EAAUsB,OAAOuR,GACjB7S,EAAUc,oBAAoB7nB,QAEN6I,IAArB6kB,GAAkCA,GAAoB2L,EAAIx5B,OAC3D,QAAmBknB,EAAUA,WAkBnC,OARA,QAAiB2a,GAASxiC,IACrB6nB,EACDA,EAAUF,QAAQ3nB,GAElBc,EAAKd,MAIFwiC,KApOT,qBAA2B,wBAAyBC,IACjC1xB,MAAMC,KAAKvS,SAASwS,iBAAiB,0BAA0BwxB,QACvE11B,SAAShD,IACbA,EAAQlF,cAAc,iCACvB,QAAmBkF,S,4UC5BzB,MAAM25B,GAAyE,GAOxE,SAAeC,GAAkBxJ,EAAiBx3B,EAA2BihC,G,qCAClF,MAAMp0B,EAAM2qB,EAAIhqB,GAAK,IAAMyzB,GACrB,MAAC1iC,EAAK,OAAEC,GAAUwB,EACxB,IAAIkhC,EAASH,GAAoBl0B,GACjC,GAAGq0B,GAAUA,EAAO3iC,OAASA,GAAS2iC,EAAO1iC,QAAUA,EACrD,OAGF0iC,EAASH,GAAoBl0B,GAAO,CAClCtO,MAAAA,EACAC,OAAAA,GAGF,MAAMyrB,QAAc,iDAAuDuN,EAAIhqB,GAAIyzB,GACnF,GAAGF,GAAoBl0B,KAASq0B,EAC9B,OAGF,GAAGjX,GAASA,EAAM1M,GAAKhf,GAAS0rB,EAAMzM,GAAKhf,EACzC,OAGF,MAAMsI,EAAU,IAAI3G,SAAe4B,IACjC/B,EAAOmhC,QAAQC,GAASr/B,EAAQq/B,QAG5BA,QAAat6B,EAChBi6B,GAAoBl0B,KAASq0B,IAMhC,8CAAoD1J,EAAIhqB,GAAI4zB,EAAM7iC,EAAOC,EAAQyiC,UAE1EF,GAAoBl0B,K,oWCnCd,SAASw0B,IAAqB,KAC3CrjC,EAAI,IACJw5B,EAAG,WACH9L,EAAU,OACVvnB,EAAM,KACNm9B,EAAI,UACJC,EAAS,KACTliC,EAAI,SACJsQ,IAWA,MAAM6xB,EAAe1lC,SAASC,cAAc,OAC5CylC,EAAaplC,UAAUC,IAAI,mBAG3BmlC,EAAavhC,MAAM1B,MAAQP,EAAO,KAClCwjC,EAAavhC,MAAMzB,OAASR,EAAO,KAEnC,MAAMyjC,EAAiB,GAAY,CACjCpgC,IAAKmgC,EACLhK,IAAAA,EACA9L,WAAAA,EACAgW,WAAW,EACXrd,YAAY,EACZhmB,MAAM,EACNE,MAAOP,EACPQ,OAAQR,EACRqB,KAAAA,EACA89B,MAAO,OACPoE,UAAAA,EACA5xB,SAAAA,IACCjR,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQ9uB,MAAME,KAClC,EAAA+iC,GAAA,GAA0B/iC,GAC1BA,EAAUxB,iBAAiB,cAAewkC,IACrCA,IAAYhjC,EAAUijC,WACvBjjC,EAAUtB,SACVkkC,EAAalkC,SACb,yDAAmE,SAAUwkC,OAI9E,MACDljC,EAAUxB,iBAAiB,cAAc,KACvCob,UAAUupB,QAAQ,OACjB,CAACv9B,MAAM,IAGL5F,KAGHojC,EAAwBxiC,IAC5B,MAAM4C,EAAIzC,KAAKsiC,SAAWziC,EAAM,EAChC,OAAO4C,EAAI5C,GAAO4C,EAAI5C,EAAM4C,GAGxB8/B,EAAgBF,EAAqB,IACrCG,EAAgBH,EAAqB,GACrCI,EAAgBpkC,EAAO,GAAc,UAATsjC,EAAmB,GAAK,GACpDe,EAAc,KAClB,KAAI,EAAAtb,GAAA,GAAQ5iB,GACV,OAGF,MAAMX,EAAOW,EAAOV,wBASdO,GAHiB,UAATs9B,EAAmB99B,EAAK8+B,MAAQ9+B,EAAKG,OAEvB,WAAT29B,GAAqB99B,EAAKjF,MAAQP,GAAQ,GAAc,UAATsjC,GAAoBtjC,EAAO,GAAKokC,EAAgBF,GAG5Gj+B,EAAIT,EAAKK,KAAQL,EAAKhF,OAASR,GAAQ,GAAe,WAATsjC,EAAoB,EAAIa,GAE3EX,EAAavhC,MAAM4D,IAAMI,EAAI,KAC7Bu9B,EAAavhC,MAAM0D,KAAOK,EAAI,MAG1B89B,EAAWjU,GAAgBwU,GAQjC,OANA,sDAAgE,SAAUP,GAE1EO,IAEA,kCAA4Cb,GAErC,CAACA,aAAAA,EAAcC,eAAAA,G,2SCzET,SAAe,IAAY,IAACjK,EAAG,IAAEn2B,EAAG,WAAEqqB,EAAU,cAAED,EAAa,MAAE0R,EAAK,KAAE99B,EAAI,UAAEkjC,EAAS,MAAEC,EAAK,MAAEjkC,EAAK,OAAEC,EAAM,UAAEkjC,EAAS,KAAErjC,EAAI,aAAEutB,EAAY,WAAEvH,EAAU,YAAEoe,EAAW,UAAElB,EAAW9gB,OAAQiiB,EAAQ,SAAE/yB,EAAW,e,gDAoB5N,MAAMgzB,EAAcnL,EAAIoL,QAkBxB,GAjBmB,IAAhBD,IACDD,GAAW,GAGTnkC,IACFA,EAASikC,OAAcx7B,EAAN,KAGfxI,IACFA,EAAUgkC,OAAcx7B,EAAN,KAGD,IAAhB27B,GAEDE,GAAA,uBAGEF,EAEF,MADAj4B,QAAQC,MAAM,6BAA8B6sB,GACtC,IAAIsF,MAAM,8BAoClB,IAAIzS,EAjCJhpB,EAAIuD,QAAQk7B,MAAQ,GAAKtI,EAAIhqB,GAC7BnM,EAAIjF,UAAUC,IAAI,yBAiClB,IAAIqwB,EAAkB,CAAMzvB,GAAeotB,MAAAA,OAAY,EAAZA,EAAcptB,QAAS,mCAChE,OAAOotB,QAAqB1a,EAAS8c,cAAcC,gBAAgB8K,EAAKv6B,MAG1E,GAAGylC,GAA4B,IAAhBC,EAAmB,CAChC,MAAM1Y,EAAQrN,GAAgB4a,EAAKj5B,EAAOC,GAAQ,SAC5CkuB,EAAgBzC,EAAMhtB,iBAEtByvB,IAGR,MAAMuU,EAAYuB,GAAQ,SAAkBA,IAAU,EAChDjY,EAAaF,EAAaE,aAAelG,EAEzCye,GAAcJ,IAA6B,IAAhBC,GAAqC,IAAhBA,GAChDI,EAAuBD,EACvBE,EAAoC,IAAhBL,GAAqC,IAAhBA,QAA0BhzB,EAAS6wB,eAAeyC,qBAAqBzL,EAAIhqB,GAAIyzB,QAAaj6B,EAE3I,IAAIslB,GAAmB,UACnB4W,GAAkB,EACtB,KACc,QAAV,EAAA1L,EAAIna,cAAM,eAAE1f,SACZqlC,KAED3hC,EAAI0kB,qBACFwE,GACDwY,GACAR,KACiB,IAAdb,EACL,CACA,IAIInd,EAJA0F,EAAQ+Y,GAAqBxL,EAAIna,OAAO,GAK5C,MAAM8lB,EAAc,KACd9hC,EAAI4G,oBACNsc,EAAWnoB,UAAUC,IAAI,gBAAiB,aAE1CmK,GAAA,gBAA4BnF,GAAK,KAC/BA,EAAI3E,OAAO6nB,GACX+H,EAAiBvqB,eAKvB,GAAG,QAASkoB,EACV1F,EAAa,IAAIN,MACjBJ,GAAmBU,EAAY0F,EAAM3G,IAAK6f,GAC1CD,GAAkB,OACb,GAAG,UAAWjZ,EACnB,GAAe,kBAAZA,EAAMrgB,EACP,GAAGqgB,EAAMV,MAAM5rB,OAAQ,CACrB,MAAMyS,EChKD,SAA0BmZ,GAGvC,IAAI6Z,EAAO,IACX,IAAI,IAAIr6B,EAAI,EAAGpL,EAAS4rB,EAAM5rB,OAAQoL,EAAIpL,IAAUoL,EAAG,CACrD,MAAMs6B,EAAM9Z,EAAMxgB,GAEfs6B,GAAO,IACRD,GAPW,mEAOIC,EAAM,IAAM,KAExBA,GAAO,IACRD,GAAQ,IACAC,GAAO,KACfD,GAAQ,KAEVA,GAAQ,IAAY,GAANC,IAKlB,OAFAD,GAAQ,IAEDA,ED4IWE,CAAiBrZ,EAAMV,OAC3BuP,EAAMh9B,SAASs9B,gBAAgB,6BAA8B,OACnEN,EAAI18B,UAAUC,IAAI,iBAAkB,gBAAiB,aACrDy8B,EAAInV,eAAe,KAAM,UAAW,OAAO6T,EAAIja,GAAK,OAAOia,EAAIha,GAAK,OACpE,MAAM4lB,EAAOtnC,SAASs9B,gBAAgB,6BAA8B,QACpEgK,EAAKzf,eAAe,KAAM,IAAKvT,GAC/B0oB,EAAIp8B,OAAO0mC,GACX/hC,EAAI3E,OAAOo8B,QAEX7O,EAAQuN,EAAIna,OAAOjO,MAAMC,IAAK,MAAC,OAAwC,QAAxC,EAACA,EAAkCka,aAAK,eAAE5rB,WAAWssB,OAE9EgX,GAAa,IACrB1c,EAAa,IAAIN,MAEb,MAAqBuT,EAAIhiB,OAAO+tB,uBAAyBlZ,EAAa/G,KACxEO,GAAmBU,EAAYyF,GAAuBwN,EAAKvN,GAAO,GAAOkZ,GACzED,GAAkB,GAElBM,GAAA,UAA6B,QAAUhM,EAAIhqB,GAAIyc,EAAMV,OAAO7qB,MAAM6qB,IAChE5Z,EAAS6wB,eAAeiD,+BAA+BjM,EAAIhqB,GAAI+b,GAC9DU,EAAsCV,MAAQA,EAC/CiO,EAAIhiB,OAAO+tB,uBAAwB,EAEhC7X,IAAeA,KAEdrqB,EAAI4G,mBACN4b,GAAmBU,EAAYyF,GAAuBwN,EAAKvN,GAAsC,GAAOkZ,MAEzGt4B,OAAM,eAGR,IAAqB,IAAhB83B,GAAqB1B,GAAa,GAAsB,IAAhB0B,KAAuBjB,GAAaa,GAAY,CAClG,MAAMpkC,EAAO,IAAW,mCACtB,GAAGkD,EAAI4G,mBAAsByjB,IAAeA,IAAe,OAE3D,MAAMtpB,EAAI,KACLf,EAAI4G,mBAAsByjB,IAAeA,KAC5C7H,GAAmBU,EAAY8F,EAAa/G,IAAK6f,IAInD,SADMzW,IACHrC,EAAa/G,IACdlhB,QAEK,CACL,MAAM0H,EAAMogB,GAA0BsN,EAAKvN,GAAsC,GACjF1F,EAAaza,EAAIsa,MACjBta,EAAI1L,YAAYM,KAAK0D,OAMzB,GAAGqpB,GAAiB8W,EAElB,YADA9W,EAAc5c,KAAK,CAACxN,IAAAA,EAAKlD,KAAAA,IAGzBA,IAEI8rB,EAAc3G,MAChB4f,GAAkB,IAU1B,GAJGtX,GAAgBsX,GACjBtX,EAAa/c,KAAKyd,GAGjBiW,EACD,OAGF,MAAMpkC,EAAO,IAAW,mCACtB,IAAGutB,GAAeA,IAAlB,CAEA,GAAmB,IAAhBiX,IAAsBD,EAYvB,aAAa7V,EAAA,gBAAiC,CAAC7B,MAAOwM,EAAKrK,QAAS1B,MAAAA,OAAa,EAAbA,EAAe0B,UAClFzuB,MAAW0iC,GAAS,mCAGnB,GAAG1V,IAAeA,IAChB,MAAM,IAAIoR,MAAM,4BAGlB,IAAIl+B,QAAkBikC,GAAA,sBAAiC,CACrD3kC,UAAWmD,EACXhD,KAAMA,IAASmkC,EACflkC,SAAUe,EACVqkC,cAAetC,EACf7iC,MAAAA,EACAC,OAAAA,EACAiC,KAAM,MAAQ+2B,EAAIhqB,GAClBi1B,YAAAA,EACAlB,UAAAA,EACAN,UAAAA,GACC9D,EAAOzR,GA2CV,GAvCA9sB,EAAUxB,iBAAiB,cAAc,KACvC,MAAMgK,EAAU/F,EAAI0kB,mBACF,IAAf1B,IACDA,GAAcA,IAAejd,GAA+B,QAApBA,EAAQ/C,UAAsB,gCAGxE,MAAMnB,EAAK,KACNkE,GAAWA,IAAYxI,EAAUoB,QAClCoH,EAAQ9J,UAIR+mB,EAKF7d,GAAA,UAAqB,KACnB5H,EAAUoB,OAAO5D,UAAUC,IAAI,WAC5B+K,GACDA,EAAQhL,UAAUC,IAAI,YAGxBuC,EAAUoB,OAAO5C,iBAAiB,gBAAgB,KAChDoJ,GAAA,UAAqB,KACnB5H,EAAUoB,OAAO5D,UAAUkB,OAAO,WAClC4F,SAED,CAACsB,MAAM,OAfT4C,GACDZ,GAAA,SAAqBtD,IAkBR,IAAdw+B,GACDV,GAAkBxJ,EAAK54B,EAAUoB,OAAQihC,KAI1C,CAACz8B,MAAM,IAEPg+B,EAAO,CACR,MAAMmB,EAAwC,CAC5CC,EAAG,GACHC,EAAG,GAGL,IAAIC,EAEJn0B,EAASo0B,mBAAmBC,qCAAqCxB,IAEjE,QAAiBnhC,GAAWhE,GAAM,oCAChC,EAAA4nB,EAAA,GAAY5nB,GACZ,MAAMuB,EAAYikC,GAAA,eAA0BxhC,GAE5C,GAAGzC,EAAUi1B,OAAQ,CACnB,MAAM2D,QAAY7nB,EAASo0B,mBAAmBE,8BAA8BzB,GAC5E,GAAGhL,EAAK,CACN,MAAM2C,EAAQr+B,SAASC,cAAc,SACrCo+B,EAAMl6B,MAAMC,QAAU,OACtBmB,EAAIT,cAAclE,OAAOy9B,GAEzB,IACE,MAAM7W,QAAYuJ,EAAA,mBAAoC,CAAC7B,MAAOwM,IAE9D2C,EAAM1W,IAAMH,EACZ6W,EAAM96B,aACA,EAAAs/B,GAAA,GAAYxE,OAAOnzB,GAAW,GAEpCmzB,EAAM/8B,iBAAiB,SAAS,KAC9B+8B,EAAM1W,IAAM,GACZ0W,EAAM78B,WACL,CAACkH,MAAM,IACV,MAAMiG,KAKV7L,EAAUN,UAAW,EACrBM,EAAUslC,UAIZ,IADe,eACJC,SACT,OAGF,MAAM3M,QAAY7nB,EAASo0B,mBAAmBK,wBAAwB5B,GAAO,GAC7E,IAAIhL,EACF,OAGF,MAAM6M,GAAS,EAAA1N,GAAA,GAAgBt1B,EAAK,UAC9BmqB,EAAQ6Y,EAAOjoC,UAAUiG,SAAS,WAElC,aAACm/B,GAAgBH,GAAqB,CAC1C7J,IAAAA,EACA9L,WAAAA,EACA4V,KAAM9V,EAAQ,QAAU,OACxBxtB,KAAM,IACNmG,OAAQ9C,EACRhC,MAAM,IAGLglC,IACE7Y,EACDgW,EAAaplC,UAAUC,IAAI,UAE3BmlC,EAAaplC,UAAUC,IAAI,UAI3BynC,IACFA,GAA2B,EAAAQ,GAAA,IAAS,KAElC,IADeX,EAAKC,EAAEjmC,OAEpB,OAGF,MAAM2xB,EAAYqU,EAAKC,EAAE,GAAGv0B,EAE5Bs0B,EAAKC,EAAEx5B,SAASw5B,IACdA,EAAEv0B,GAAKu0B,EAAEv0B,EAAIigB,GAAa,OAG5B,MAAM+U,GAAS,EAAA1N,GAAA,GAAgBt1B,EAAK,UACpCsO,EAAS40B,mBAAmBC,UAAU,eAA0B,CAC9D56B,EAAG,8BACH66B,QAAQ,EAAAC,GAAA,IAAoBL,EAAOz/B,QAAQqF,KAC3C06B,SAAUnC,EACVoC,YAAa,CACXh7B,EAAG,WACH+5B,KAAMkB,KAAKC,UAAUnB,MAEtB,GAEHA,EAAKC,EAAEjmC,OAAS,IACf,KAAM,IAIRN,EAAEkjC,YACHoD,EAAKC,EAAE/0B,KAAK,CACV9F,EAAG,EACHsG,EAAG3M,KAAKC,QAGVmhC,UAKN,OAAOllC,OAOJ,GAAG8jC,GAA4B,IAAhBC,EAAmB,CACvC,IAAI3X,EACD0X,EACD1X,EAAQ,IAAI/G,OAEZ+G,EAAQyC,KACPzC,EAA2B4S,OAAQ,EAEjCv+B,IACA2rB,EAA2B1sB,UAAW,EACtC0sB,EAA2B3sB,MAAO,IAIvC,MAAMkmB,EAAaljB,EAAI0kB,oBAAsBiF,GAAS3pB,EAAI0kB,kBAW1D,OAVkB,IAAf1B,IACDA,GAAcA,IAAekG,IAAemY,EAAWne,GAAeA,GAAqC,QAAvBA,EAAWlgB,WAAwB,gCAGzH2mB,EAAM5uB,UAAUC,IAAI,iBAEjBgoB,GACD2G,EAAM5uB,UAAUC,IAAI,WAGf,IAAI8D,SAAc,CAAM4B,EAASylB,IAAW,mCACjD,MAAMplB,EAAI,IAAW,mCACnB,GAAGspB,IAAeA,IAAc,OAAO3pB,IAEvC,MAAMgrB,EAAS,KACbvmB,GAAA,gBAA4BnF,GAAK,KAM/B,GALAA,EAAI3E,OAAOsuB,GACRzG,GACDA,EAAWnoB,UAAUC,IAAI,YAGR,IAAhBsmC,IF/cV,SAA+BnL,EAAiByJ,GACrD,MAAMp0B,EAAM2qB,EAAIhqB,GAAK,IAAMyzB,EAC3B,QAASF,GAAoBl0B,GE6cQk4B,CAAsBvN,EAAKyJ,GAAY,EAE9D,EAAAU,GAAA,GAA6B3W,GAC7B,MAAMhrB,EAASlE,SAASC,cAAc,UACtCiE,EAAOzB,MAAQA,EAAQuE,OAAOoa,iBAC9Bld,EAAOxB,OAASA,EAASsE,OAAOoa,iBACpBld,EAAO6P,WAAW,MAC1B+Y,UAAUoC,EAAO,EAAG,EAAGhrB,EAAOzB,MAAOyB,EAAOxB,QAChDwiC,GAAkBxJ,EAAKx3B,EAAQihC,GAId,IAAhB0B,GAAqBxF,GACtByB,EAAA,eAAkC5T,EAA2BmS,GAG/Dp7B,IAEGsiB,GACD2G,EAAM5tB,iBAAiB,gBAAgB,KACrC4tB,EAAM5uB,UAAUkB,OAAO,WACpBinB,GACDA,EAAWjnB,WAEZ,CAACkH,MAAM,cAKVkoB,IACHgW,EACD7e,GAAmBmH,EAAOX,EAAa/G,IAAKyJ,IAE3C/B,EAA2BvH,IAAM4G,EAAa/G,KAC/C,EAAAqb,GAAA,GAAY3T,GAA2BtsB,KAAKquB,OAKhD,SADML,IACHrC,EAAa/G,IAAKlhB,QAChB,CACH,IAAI0E,EACJ,GAAmB,IAAhB67B,GAAqBD,EAAU,CAChC,MAAMzY,EAAQrN,GAAgB4a,EAAKj5B,EAAOC,GAAQ,GAElDsI,EAAU+lB,EAAA,mBAAoC,CAAC7B,MAAOwM,EAAKvN,MAAAA,EAAOkD,QAAS1B,MAAAA,OAAa,EAAbA,EAAe0B,eAE1FrmB,EAAU+lB,EAAA,mBAAoC,CAAC7B,MAAOwM,EAAKrK,QAAS1B,MAAAA,OAAa,EAAbA,EAAe0B,UAGrFrmB,EAAQpI,KAAK0D,EAAGL,cAMlB3D,GAA6CqtB,GAAmBlB,IAAcuY,EAElF3kC,KADCstB,EAAc5c,KAAK,CAACxN,IAAAA,EAAKlD,KAAAA,IAAQgC,QAAQ4B,WAU5C,OAPGwoB,GAAc,IACf+B,EAAmBluB,EAChBwtB,GACDA,EAAa/c,KAAKyd,IAIf,CAACkB,OAAQpvB,M,eE/gBH,MAAM4mC,GAenBpoC,YAAYhB,GAHJ,KAAAqpC,WAAY,EACZ,KAAA16B,WAAa,IAiEd,KAAA26B,UAAY,KACjB,GAAGloC,KAAK+Y,aACN,OAAO,EAGT,IAAIovB,EAAgB,EAAGC,EAAiB,EAAGC,EAAsB,EAiBjE,OAhBAroC,KAAKsoC,YAAYl7B,SAAS7K,IACrBA,EAAWgmC,YACThmC,EAAW2lC,eACVC,EAGD5lC,EAAWimC,YACVH,GAIH9lC,EAAWimC,YACVJ,KAICA,IAAmBC,GAAuBF,EAAgB,GAG5D,KAAAM,aAAe,KACpBzoC,KAAK8Z,QAAQ1a,UAAUoE,OAAO,aAAcxD,KAAKkoC,eAhFjD,EAAAl3B,EAAA,GAAWhR,KAAMpB,GAEboB,KAAK8Z,QAEE9Z,KAAK8Z,QAAQ1a,UAAUiG,SAAS,gBACzCrF,KAAKyoC,aAAe,KAClBzoC,KAAK8Z,QAAQ4uB,gBAAgB,YAAa1oC,KAAKkoC,aAAeloC,KAAKT,YAHrES,KAAK8Z,QAAU,EAAa,CAAC7a,KAAM,UAOjCL,EAAQ+pC,gBACV3oC,KAAK4oC,WAAa9pC,SAASC,cAAc,kBACzCiB,KAAK4oC,WAAWxpC,UAAUC,IAAI,qBAAsB,UAAYW,KAAKuN,YACrEvN,KAAK4oC,WAAWC,kBAAkB,CAACt8B,OAAQvM,KAAKuM,SAE5C3N,EAAQkqC,kBACV9oC,KAAKiZ,WAAa,IAAIrG,GAAYsG,IAChClZ,KAAK+Y,aAAeG,EACpBlZ,KAAKyoC,eACLzoC,KAAK4oC,WAAWtoC,YAGlBN,KAAKiZ,WAAW/X,UAAUxB,OAAOM,KAAK4oC,cAI1C5oC,KAAKsoC,YAAYl7B,SAAS7K,IACxBvC,KAAKiJ,eAAe5J,IAAIkD,EAAWxC,MAAnCC,CAA0C,QAASA,KAAKyoC,iBAG1DzoC,KAAKyoC,eAGIlpC,eACT,OAAOS,KAAKioC,UAGH1oC,aAASiB,GAClBR,KAAKioC,UAAYznC,EACjBR,KAAKsoC,YAAYl7B,SAAS7K,GAAeA,EAAWxC,MAAM2oC,gBAAgB,WAAYloC,KACtFR,KAAKyoC,eAGAM,gBAAgBj/B,EAAuBk/B,GAAkB,GAC9DhpC,KAAKT,UAAW,EAChBuK,EAAQpI,MAAK,KACRsnC,IACDhpC,KAAKT,UAAW,MAEjB,KACDS,KAAKT,UAAW,MClFP,SAAS0pC,GAAUC,EAA6Dh9B,GAC7F,MAAMi9B,EAAOrqC,SAASC,cAAc,QAYpC,OAVAmqC,EAAO97B,SAAShI,IACd,MAAM,UAAClE,EAAS,MAAEnB,GAASqF,EAC3B+jC,EAAKzpC,OAAOwB,GACZnB,EAAMK,iBAAiB,UAAWC,IAC7BN,EAAMqpC,SACPl9B,EAASnM,EAAMS,MAAOH,SAKrB8oC,ECJM,MAAME,GAYnBzpC,YAAYhB,EAgBP,IAlBE,KAAA0qC,SAAU,EAmBftpC,KAAKkB,UAAYpC,SAASC,cAAcH,EAAQ2qC,YAAc3qC,EAAQ4qC,cAAgB,QAAU,OAChGxpC,KAAKkB,UAAU9B,UAAUC,IAAI,OAE7BW,KAAKypC,SAAW3qC,SAASC,cAAc,OACvCiB,KAAKypC,SAASrqC,UAAUC,IAAI,gBAC5BW,KAAKypC,SAASjqC,aAAa,MAAO,QAC/BZ,EAAQ6qC,SACuB,iBAAtB7qC,EAAgB,UACxB,EAAA+5B,EAAA,GAAa34B,KAAKypC,SAAU7qC,EAAQ6qC,UAEpCzpC,KAAKypC,SAAS/pC,OAAOd,EAAQ6qC,UAEvB7qC,EAAQ8qC,iBAChB1pC,KAAKypC,SAAS/pC,QAAO,QAAKd,EAAQ8qC,gBAAiB9qC,EAAQ+qC,mBAE7D3pC,KAAKkB,UAAUxB,OAAOM,KAAKypC,UAE3B,IAAIG,IAAgBhrC,EAAQgrC,YAC5B,GAAGhrC,EAAQ2qC,YAAc3qC,EAAQ4qC,cAAe,CAO9C,GANG5qC,EAAQ2qC,aACTvpC,KAAKupC,WAAa3qC,EAAQ2qC,WAC1BvpC,KAAKkB,UAAUxB,OAAOM,KAAKupC,WAAWhwB,OACtCqwB,GAAc,GAGbhrC,EAAQ4qC,cAAe,CACxBxpC,KAAKwpC,cAAgB5qC,EAAQ4qC,cAE7B,MAAMK,EAAWjrC,EAAQ4qC,cAAcjwB,MAAMna,UAAUiG,SAAS,yBAC7DwkC,GACD7pC,KAAKkB,UAAU9B,UAAUC,IAAI,mBAC7BT,EAAQkrC,WAAa9pC,KAAKwpC,cAAcjwB,QAExCqwB,GAAc,EACd5pC,KAAKkB,UAAUxB,OAAOM,KAAKwpC,cAAcjwB,QAGvC3a,EAAQmrC,oBAAuBF,GACjC7pC,KAAKwpC,cAAczpC,MAAMK,iBAAiB,UAAU,MAClD,EAAAwN,EAAA,GAAe5N,KAAKypC,UAAU,QAAKzpC,KAAKwpC,cAAczpC,MAAMqpC,QAAU,mBAAqB,0BAKvFxqC,EAAQ2qC,YAAc3qC,EAAQ4qC,eACtCjwB,MAAMna,UAAUC,IAAI,iBAGxB,GAAGT,EAAQkQ,OAASlQ,EAAQorC,aAAc,CACxC,IAAIlzB,EACJ,MAAMgzB,EAAalrC,EAAQkrC,YAAclrC,EAAQqrC,oBAuBjD,GAtBGH,GACDhzB,EAAIhY,SAASC,cAAc,OAC3B+X,EAAE1X,UAAUC,IAAI,iBAChBW,KAAKkB,UAAUxB,OAAOoX,IAEtBA,EAAI9W,KAAKkB,UAGXlB,KAAK8O,MAAQhQ,SAASC,cAAc,OACpCiB,KAAK8O,MAAM1P,UAAUC,IAAI,aACzBW,KAAK8O,MAAMtP,aAAa,MAAO,QAC5BZ,EAAQkQ,MACoB,iBAAnBlQ,EAAa,MACrBoB,KAAK8O,MAAMxK,UAAY1F,EAAQkQ,MAE/B9O,KAAK8O,MAAMpP,OAAOd,EAAQkQ,OAG5B9O,KAAK8O,MAAMpP,QAAO,QAAKd,EAAQorC,eAEjClzB,EAAEpX,OAAOM,KAAK8O,OAEXg7B,EAAY,CACb,MAAMI,EAAelqC,KAAK8pC,WAAahrC,SAASC,cAAc,OAC9DmrC,EAAa9qC,UAAUC,IAAI,YAAa,mBAErCT,EAAQqrC,qBACTC,EAAa9qC,UAAUC,IAAI,6BAGH,iBAAjB,EACP6qC,EAAa5lC,UAAYwlC,EAEzBI,EAAaxqC,OAAOoqC,GAGtBhzB,EAAEpX,OAAOwqC,IAIVtrC,EAAQK,OACT2qC,GAAc,EACd5pC,KAAK8O,MAAM1P,UAAUC,IAAI,QAAS,SAAWT,EAAQK,MACrDe,KAAKkB,UAAU9B,UAAUC,IAAI,kBAG5BuqC,GACD5pC,KAAKkB,UAAU9B,UAAUC,IAAI,oBAG5BT,EAAQurC,gBACTvrC,EAAQ8L,UAAY,IAAM9L,EAAQurC,cAAch7B,SAG/CvQ,EAAQ8L,WAAa9L,EAAQ2qC,YAAc3qC,EAAQ4qC,iBACnB,mBAAvB5qC,EAAiB,WACzBoB,KAAKkB,UAAUd,iBAAiB,SAAUC,IACrCL,KAAKspC,SACP1qC,EAAQ8L,UAAkBrK,MAI/BL,KAAKkB,UAAU9B,UAAUC,IAAI,gBAAiB,gBAE1CT,EAAQM,WACV,EAAA2F,GAAA,GAAO7E,KAAKkB,eAAW8I,OAAWA,GAAW,IAS5CogC,YAAYppC,GACjBhB,KAAKkB,UAAU9B,UAAUC,IAAI,oBAE7B,MAAM2uB,EAAQhuB,KAAKguB,MAAQlvB,SAASC,cAAc,OASlD,OARAivB,EAAM5uB,UAAUC,IAAI,aAEjB2B,GACDgtB,EAAM5uB,UAAUC,IAAI,aAAe2B,GAGrChB,KAAKkB,UAAUxB,OAAOsuB,GAEfA,GAIJ,MAAMqc,GAAoB,CAACC,EAAap+B,IACtC+8B,GAAUqB,EAAK3vB,KAAKvV,IAAM,CAAElE,UAAWkE,EAAElE,UAAWnB,MAAOqF,EAAEmkC,WAAWxpC,UAAUmM,GC1JpF,SAASq+B,GAAoB9qC,GAC9B+b,UAAUgvB,UAKdhvB,UAAUgvB,UAAUC,UAAUhrC,GA/BhC,SAAqCA,GACnC,IAAIirC,EAAW5rC,SAASC,cAAc,YACtC2rC,EAASlqC,MAAQf,EAGjBirC,EAASznC,MAAM4D,IAAM,IACrB6jC,EAASznC,MAAM0D,KAAO,IACtB+jC,EAASznC,MAAM0nC,SAAW,QAE1B7rC,SAAS8rC,KAAKrmC,YAAYmmC,GAC1BA,EAASj+B,QACTi+B,EAASG,SAET,IACE/rC,SAASgsC,YAAY,QAIrB,MAAMr9B,IAIR3O,SAAS8rC,KAAKG,YAAYL,GAKxBM,CAA4BvrC,G,oCCvBjB,MAAMwrC,GAKnBrrC,YAAYhB,GAQV,MAAM2a,EAAQvZ,KAAKuZ,MAAQza,SAASC,cAAc,SAClDwa,EAAMna,UAAUC,IAAI,eAEjBT,EAAQssC,YACT3xB,EAAMna,UAAUC,IAAI,qBAGtB,MAAMU,EAAQC,KAAKD,MAAQjB,SAASC,cAAc,SAClDgB,EAAME,KAAO,QACIF,EAAM0D,KAAO,eAAiB7E,EAAQ6E,KAEpD7E,EAAQ4B,QACTT,EAAMS,MAAQ5B,EAAQ4B,MAEnB5B,EAAQusC,WACT,gBAA2BzpC,MAAM0pC,IAC/BrrC,EAAMqpC,SAAU,EAAAiC,GAAA,GAAgBD,EAAOxsC,EAAQusC,YAAcvsC,EAAQ4B,SAGvET,EAAMK,iBAAiB,UAAU,KAC/B,sCAA4CxB,EAAQusC,SAAUvsC,EAAQ4B,YAK5E,MAAM8qC,EAAOtrC,KAAKsrC,KAAOxsC,SAASC,cAAc,OAChDusC,EAAKlsC,UAAUC,IAAI,oBAEhBT,EAAQa,KACT6rC,EAAKhnC,UAAY1F,EAAQa,KAWjBb,EAAQ2sC,UAChB,QAAMD,EAAM1sC,EAAQ2sC,SAGtBhyB,EAAM7Z,OAAOK,EAAOurC,GAGlBlC,cACF,OAAOppC,KAAKD,MAAMqpC,QAGhBA,YAAQA,GACVppC,KAAKY,iBAAiBwoC,GAEtB,MAAM9U,EAAQ,IAAIkX,MAAM,SAAU,CAACC,SAAS,EAAM7jB,YAAY,IAC9D5nB,KAAKD,MAAMiQ,cAAcskB,GAGpB1zB,iBAAiBwoC,GACtBppC,KAAKD,MAAMqpC,QAAUA,GC1EzB,MAAMsC,GAAU5sC,SAASC,cAAc,OAEhC,SAAS4sC,GAAM58B,IACpB,EAAAnB,EAAA,GAAe89B,GAAS38B,GACxBjQ,SAAS8rC,KAAKlrC,OAAOgsC,IAElBA,GAAQ9jC,QAAQqG,SAASE,cAAcu9B,GAAQ9jC,QAAQqG,SAC1Dy9B,GAAQ9jC,QAAQqG,QAAU,GAAK7H,YAAW,KACxCslC,GAAQprC,gBACDorC,GAAQ9jC,QAAQqG,UACtB,KAGE,SAAS29B,GAAShtC,GAIvB+sC,IAAM,QAAK/sC,EAAQitC,YAAajtC,EAAQktC,oBAhB1CJ,GAAQtsC,UAAUC,IAAI,S,eCVP,SAAS0sC,GAAgBC,GACtC,OAASA,EAASrrC,QAAU,GAAKqrC,EAASrrC,QAAU,KAAQqrC,EAASrrC,SAAW,kBAAkBsrC,KAAKD,GCYlG,MAAME,WAA2B,IAatCtsC,YACEhB,EACQ+T,GAER9S,MAAMjB,GAFE,KAAA+T,SAAAA,EAIR3S,KAAKmsC,wBAAyB,EAAAC,GAAA,GAASpsC,KAAKqsC,cAAcnjC,KAAKlJ,MAAO,KAAK,GAAO,GAElFpB,EAAQqK,eAAe5J,IAAIW,KAAKD,MAAhCnB,CAAuC,SAAS,KAC9C,MAAM4B,EAAQR,KAAKssC,WAGnB,GAAG9rC,IAAUR,KAAKusC,gBAAkB/rC,EAAMG,OAGxC,OAFAX,KAAKwsC,SAAS,EAAAC,EAAA,QAAoBzsC,KAAKpB,QAAQ2a,YAC/CvZ,KAAKpB,QAAQsN,UAAYlM,KAAKpB,QAAQsN,YAE7B6/B,GAAgBvrC,GAGzBR,KAAKwsC,SAAS,EAAAC,EAAA,SAFdzsC,KAAK0sC,SAAS1sC,KAAKpB,QAAQ+tC,aAK1B3sC,KAAKD,MAAMX,UAAUiG,SAAS,SAC/BrF,KAAKpB,QAAQsN,UAAYlM,KAAKpB,QAAQsN,WAIxClM,KAAKmsC,uBAAuB3rC,MAIzB8rC,WACL,IAAI9rC,EAAQR,KAAKQ,MAMjB,OALGR,KAAKpB,QAAQguC,OACdpsC,EAAQA,EAAME,MAAMV,KAAKpB,QAAQguC,KAAKjsC,QACtCX,KAAKY,iBAAiBZ,KAAKpB,QAAQguC,KAAOpsC,IAGrCA,EAGD6rC,cAAcL,GACjBhsC,KAAK6sC,uBAEL7sC,KAAKpB,QAAQ2N,OACdvM,KAAK6sC,qBAAuB7sC,KAAK2S,SAASoH,gBAAgBsyB,cAAcrsC,KAAKpB,QAAQ2N,OAAO8hB,WAAY2d,GAExGhsC,KAAK6sC,qBAAuB7sC,KAAK2S,SAAS2I,gBAAgB+wB,cAAcL,GAG1EhsC,KAAK6sC,qBAAqBnrC,MAAMorC,IAC3B9sC,KAAKssC,aAAeN,IAEpBc,EACD9sC,KAAKwsC,SAAS,EAAAC,EAAA,MAAkBzsC,KAAKpB,QAAQmuC,eAE7C/sC,KAAK0sC,SAAS1sC,KAAKpB,QAAQouC,eAE3Bv/B,IACCzN,KAAKssC,aAAeN,GAGhB,qBADAv+B,EAAIxN,MAEPD,KAAK0sC,SAAS1sC,KAAKpB,QAAQ+tC,gBAI9BjrC,MAAK,KACN1B,KAAK6sC,0BAAuB7iC,EAC5BhK,KAAKpB,QAAQsN,UAAYlM,KAAKpB,QAAQsN,WAEtC,MAAM1L,EAAQR,KAAKssC,WAChB9rC,IAAUwrC,GAAYhsC,KAAKitC,mBAAqBlB,GAAgBvrC,IACjER,KAAKqsC,cAAc7rC,Q,eCtEZ,MAAM0sC,WAAkB,IAGrCttC,YAAoBjB,EAAmBC,EAA4B,IAGjE,GAFAiB,MAAM,cAAgBlB,EAAY,IAAMA,EAAY,IAAKC,EAAQuuC,UAAW,OAAgBvuC,EAAQuuC,SAAU,OAAF,QAAGC,iBAAiB,GAASxuC,IADvH,KAAAD,UAAAA,EAGfC,EAAQ2N,OAAQ,CACjB,MAAM8gC,EAAW,IAAIC,GACrBD,EAASjuC,UAAUC,IAAI,aACvBguC,EAASxE,kBAAkB,CACzB0E,UAAU,EACVhhC,OAAQ3N,EAAQ2N,SAElBvM,KAAK4O,OAAO/K,QAAQwpC,GAGlBzuC,EAAQ4uC,UACP5uC,EAAQorC,eAAiBprC,EAAQkQ,MAAO9O,KAAK8O,MAAMpP,QAAO,QAAKd,EAAQorC,cAAgB,UAAWprC,EAAQ6uC,gBACrG7uC,EAAQkQ,iBAAiB0kB,YAC/BxzB,KAAK8O,MAAMpP,OAAOd,EAAQkQ,OACrB9O,KAAK8O,MAAMmwB,UAAYrgC,EAAQkQ,OAAS,IAGjD,MAAMoG,EAAWpW,SAASqW,yBAE1B,GAAGvW,EAAQ8uC,oBAAsB9uC,EAAQ+uC,YAAa,CACpD,MAAMC,EAAI5tC,KAAK2tC,YAAc7uC,SAASC,cAAc,KACpD6uC,EAAExuC,UAAUC,IAAI,qBACbT,EAAQ8uC,mBAAoBE,EAAEluC,QAAO,QAAKd,EAAQ8uC,mBAAoB9uC,EAAQivC,sBACzEjvC,EAAQ+uC,cAAa,EAAAhV,EAAA,GAAaiV,EAAGhvC,EAAQ+uC,aAErDz4B,EAASxV,OAAOkuC,GAGfhvC,EAAQkvC,aACT9tC,KAAKkB,UAAU9B,UAAUC,IAAI,iBAE7BT,EAAQkvC,WAAW1gC,SAAS2gC,IAC1BA,EAAEC,YAAa,EACf,MAAMxE,EAAgB,IAAI,KAAcuE,GACxCA,EAAEvE,cAAgBA,EAClBt0B,EAASxV,OAAO8pC,EAAcjwB,UAGhC3a,EAAQuuC,QAAQ//B,SAASvO,IACvB,GAAGA,EAAOiG,SAAU,CAClB,MAAMmpC,EAAWpvC,EAAOiG,SACxBjG,EAAOiG,SAAW,KAChB,MAAMgS,EAAsB,IAAI8H,IAChChgB,EAAQkvC,WAAW1gC,SAAS2gC,IACvBA,EAAEvE,cAAcJ,SACjBtyB,EAAEzX,IAAI0uC,EAAEtuC,SAGZwuC,EAASn3B,SAMjB9W,KAAKkB,UAAU4C,aAAaoR,EAAUlV,KAAK4O,OAAOs/B,qB,eChEvC,MAAMC,WAAuBr+B,EAI1BT,O,qCACdrP,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,wBAEpD,MAAM+uC,QAAoBpuC,KAAK2S,SAASoH,gBAAgBq0B,YAAYpuC,KAAKqa,QAEzEra,KAAK4P,SAASw+B,EAAc,cAAgB,aAE5C,MAAMj1B,EAAU,IAAIC,GAAe,CACjC3V,KAAM2qC,EAAc,cAAgB,cAGhCnJ,GAAS,UACToJ,EAAa,IAAIhF,GAAI,CACzBE,WAAY,IAAI0B,GAAW,CACzBM,QAAS6C,EAAc,iBAAmB,cAC1C3qC,KAAMwhC,EACNzkC,MAAO,YAETkpC,gBAAiB0E,EAAc,qBAAuB,oBAElDE,EAAY,IAAIjF,GAAI,CACxBE,WAAY,IAAI0B,GAAW,CACzBM,QAAS6C,EAAc,gBAAkB,aACzC3qC,KAAMwhC,EACNzkC,MAAO,WAETkpC,gBAAiB0E,EAAc,oBAAsB,mBAEjDjF,EAAOkB,GAAkB,CAACgE,EAAYC,IAAa9tC,IACvD,MAAMomC,EAAI,CAAC2H,EAAgBC,GACd,WAAVhuC,GAAoBomC,EAAEzM,UAEzByM,EAAE,GAAG1lC,UAAU9B,UAAUkB,OAAO,QAChCsmC,EAAE,GAAG1lC,UAAU9B,UAAUC,IAAI,QAE7B6M,OAGIk2B,QAAmBpiC,KAAK2S,SAASoH,gBAAgB00B,QAAQzuC,KAAKqa,QAEpElB,EAAQpK,QAAQrP,OAAOypC,GAEvB,MAAMoF,EAAiB,IAAIn1B,GAAe,IAGpCs1B,EAAU,IAAIrF,GAAI,CACtBv6B,MAAQ9O,KAAK2uC,SAASC,gBAA0DC,KAChFnF,gBAAiB0E,EAAc,yBAA2B,sBAC1D1jC,UAAW,KACT6/B,GAAqBvqC,KAAK2uC,SAASC,gBAA0DC,MAC7FlD,GAAM,YAAY,cAAc,OAI9BmD,GAAY,OAAO,qCAAsC,CAAC7vC,KAAM,SAAUQ,KAAM,gBAEtF,QAAiBqvC,GAAW,KAC1B,IAAI5B,GAAU,cAAe,CAC3BC,QAAS,CAAC,CACR5B,QAAS,eACTzmC,SAAU,KACR,MAAMtB,GAAS,EAAAurC,GAAA,GAAiB,CAACD,IAAY,GAE7C9uC,KAAK2S,SAASq8B,kBAAkBC,kBAAkBjvC,KAAKqa,QAAQ,GAAM3Y,MAAMmtC,IACzErrC,IACAkrC,EAAQ5/B,MAAMxK,UAAYuqC,QAMhC7E,aAAc,aACd0D,mBAAoB,gBACnBwB,SACF,CAACjmC,eAAgBjJ,KAAKiJ,iBAEzBslC,EAAex/B,QAAQrP,OAAOgvC,EAAQxtC,UAAW4tC,GAEjD,MAAMN,EAAgB,IAAIp1B,GAAe,CACvC+1B,QAASf,EAAc,+BAAiC,6BACxDgB,aAAa,IAGT/1B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM0O,EAAc,QAEd7B,EAAW,KACf,MAAM4Q,EAAWuxB,EAAW9E,WAAWH,SAAYmD,IAAkBx+B,GAC/DshC,EAAepC,mBAAqBoC,EAAetvC,MAAMX,UAAUiG,SAAS,SAClFiqC,EAASlwC,UAAUoE,OAAO,aAAcsZ,IAGpCuyB,EAAiB,IAAInD,GAAmB,CAC5C3yB,MAAO,oBACP9V,KAAM,oBACN3D,WAAW,EACXmJ,eAAgBjJ,KAAKiJ,eACrB8jC,cAAe,iBACfJ,YAAa,eACbK,UAAW,aACX9gC,SAAUA,EACVK,OAAQvM,KAAKqa,OAAOQ,UAAS,GAC7B+xB,KAAM7+B,GACL/N,KAAK2S,UAEF45B,EAAgBx+B,GAAgBq0B,EAAsB4J,UAAY,IAExE3yB,EAAa3Z,OAAO2vC,EAAenuC,WACnCstC,EAAcz/B,QAAQrP,OAAO2Z,GAE7B,MAAMi2B,EAAW,EAAa,CAACrwC,KAAM,QAASN,UAAW,eACzDqB,KAAK+O,QAAQrP,OAAO4vC,IAEpB,QAAiBA,GAAU,MACC,QAAgBA,GAC1C,MAAMtD,EAAWsC,EAAU/E,WAAWH,QAAUiG,EAAe/C,WAAa,GAC5EtsC,KAAK2S,SAASoH,gBAAgBw1B,YAAYvvC,KAAKqa,QAAQ3Y,MAAM8tC,GACpDxvC,KAAK2S,SAASoH,gBAAgB01B,eAAeD,EAAWxD,KAC9DtqC,MAAK,KAEN1B,KAAKiP,aAEN,CAAChG,eAAgBjJ,KAAKiJ,kBAExBsjC,IAAkBx+B,EAAcugC,EAAYD,GAAY9E,WAAWH,SAAU,EAC9EiG,EAAeK,iBAAiBnD,GAEhCvsC,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,UAAWqtC,EAAertC,UAAWstC,EAActtC,WAElF,CACE,MAAMiY,EAAU,IAAIC,GAAe,CACjC3V,KAAM,qBACN0rC,QAASf,EAAc,mCAAqC,mCAGxD5E,EAAgB,IAAI,KAAc,CACtC/pC,KAAM,wBACNuuC,YAAY,IAGdhuC,KAAKiJ,eAAe5J,IAAImqC,EAAczpC,MAAtCC,CAA6C,UAAU,KACrD,MAAMwD,EAASgmC,EAAcuF,kBAAiB,GAC9C/uC,KAAK2S,SAASoH,gBAAgB41B,iBAAiB3vC,KAAKqa,OAAQmvB,EAAcJ,SAAS1nC,MAAK,KACtF8B,UAIJ,MAAMosC,EAAe,KACnBpG,EAAc5oC,mBAAoBwhC,EAAsB5pB,OAAOq3B,aAGjE7vC,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAgBqa,IAC9Cra,KAAKqa,SAAWA,GACjBu1B,OAIJA,IAEAz2B,EAAQpK,QAAQrP,OAAO8pC,EAAcjwB,OAErCvZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,a,+SCvLtB,MAAM4uC,GAOnBlwC,YAAYhB,GANL,KAAAmxC,SAAU,EAIT,KAAAC,QAAS,GAMf,EAAAh/B,EAAA,GAAWhR,KAAMpB,GAEjBA,EAAQkN,WAAWO,iBAAmB,KACpCrM,KAAKmB,QAIFA,OACL,OAAGnB,KAAKgwC,OACC7sC,QAAQ4B,UAGd/E,KAAK+vC,QACC/vC,KAAK8J,SAGd9J,KAAK+vC,SAAU,OACf/vC,KAAK8J,QAAU9J,KAAKiwC,aAAavuC,MAAMkoB,IACrC5pB,KAAK+vC,SAAU,EACf/vC,KAAK8J,aAAUE,EAEZ4f,GACD5pB,KAAKgwC,QAAS,EACdhwC,KAAK8L,WAAWO,iBAAmB,MAEnCrM,KAAK8L,WAAWokC,sBAEjB,KACDlwC,KAAK8J,aAAUE,EACfhK,KAAK+vC,SAAU,Q,sECrBrB,MAAMI,GAAa,IApBZ,MAILvwC,cACE,GAAG,MACD,OAIF,MAAM2gB,EAAS,mBAAoBza,OAASA,OAAOsqC,eAAiBtqC,OAC9DmX,EAAM,KACVjd,KAAKuB,MAAQgf,EAAEhf,OAASgf,EAAE8vB,WAC1BrwC,KAAKwB,OAAS+e,EAAE/e,QAAU+e,EAAE+vB,aAE9B/vB,EAAEngB,iBAAiB,SAAU6c,GAC7BA,MAKJ,M,sTC5Be,SAAeszB,GAAe3vB,EAAU9b,G,0CACrD,MAAM2E,EAAWmX,EAAIjG,KAAI,CAAMoE,EAAMV,EAAKuC,IAAQ,mCAChD,SAAS9b,EAASia,EAAMV,EAAKuC,GAC3B,OAAO7B,OAIX,aAAc5b,QAAQC,IAAIqG,IAAWkiB,OAAO6kB,Y,eCR/B,SAASC,GAAuBzpC,EAAWqO,EAAS,KACjE,MAAM0oB,EAAQ/2B,EAAE0pC,WAAWhO,MAAM,KAEjC,OADA3E,EAAM,GAAKA,EAAM,GAAGt9B,QAAQ,wBAAyB4U,GAC9C0oB,EAAMpa,KAAK,KCQL,SAAegtB,GAAqBt2B,EAAgB1H,EAAW,c,qDAC5E,MAAMyvB,QAAmBzvB,EAASoH,gBAAgB00B,QAAQp0B,GAC1D,GAAc,kBAAX+nB,EAAKx1B,EACN,OAAO,QAAK,iBAGd,MAAM+hC,QAAiBh8B,EAASq8B,kBAAkB4B,kBAAkBv2B,GACpE,IAAItN,EAGAA,EAFD4hC,EACiB,gBAAfA,EAAS/hC,EACF+hC,EAASkC,mBAEgE,QAAxE,EAAAlC,EAASmC,aAAmDA,oBAAY,eAAEnwC,OAG5EyhC,EAAmByO,qBAAgD,QAAzB,EAAAzO,EAAa0O,oBAAY,eAAEA,aAAanwC,QAI7FoM,EAAQA,GAAS,EAEjB,IAAI8C,EAHiBuyB,EAAsB5pB,OAAOu4B,UAGb,0BAA4B,qBACjE,OAAO,QAAKlhC,EAAK,CAAC4gC,GAAuB1jC,M,olBCU5B,MAAMikC,GAqDnBpxC,YAAYhB,GApDL,KAAAsC,UAAYpC,SAASC,cAAc,OACnC,KAAA8L,KAAO,oBAIN,KAAAomC,eAAiBnyC,SAASC,cAAc,OAQzC,KAAAmyC,SAAW,IAAItyB,IAEf,KAAA0qB,SAAU,EAET,KAAA6H,SAAW,EACX,KAAAC,YAAc,EAGd,KAAAzlC,MAAQ,GAGR,KAAA0lC,WAAkG,GAElG,KAAAC,gBAA+B,IAAI1yB,IAInC,KAAA2yB,SAAmC,CAAC,WAGpC,KAAAC,aAAc,EACd,KAAAp2B,eAAgB,EAChB,KAAA7N,WAAa,GACb,KAAAkkC,YAAa,EAGb,KAAAC,QAA+D,GAK/D,KAAAC,aAA4B,oBAE5B,KAAAC,gBAAiB,EAuKjB,KAAA1jC,QAAU,KAChB,MAAM1N,EAAQR,KAAKD,MAAMS,MACzB,GAAGR,KAAK2L,QAAUnL,EAAO,EACpBR,KAAKuxC,SAASnqC,SAAS,aAAepH,KAAKuxC,SAASnqC,SAAS,cAC9DpH,KAAK6xC,eAAiB,MAGrB7xC,KAAKuxC,SAASnqC,SAAS,aACxBpH,KAAKmxC,SAAW,EAChBnxC,KAAKoxC,YAAc,GAGrB,IAAI,IAAIrlC,KAAK/L,KAAK0xC,UAEd1xC,KAAK0xC,QAAQ3lC,GAGjB/L,KAAK6K,KAAO,oBAEZ7K,KAAK8J,QAAU,KACf9J,KAAKqxC,WAAa,GAClBrxC,KAAK2L,MAAQnL,EACbR,KAAKsxC,gBAAgBvmC,QACrB/K,KAAK4xC,gBAAiB,EAGtB5xC,KAAK8xC,mBAqLT,KAAA5B,iBAAmB,KACjBlwC,KAAK8L,WAAWokC,qBA/VhB,EAAAl/B,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKkB,UAAU9B,UAAUC,IAAI,YAE7B,MAAMorB,GAAKzqB,KAAK+xC,mBAAqB/xC,KAAKgyC,eAAe9oC,KAAKlJ,MA4C9D,GA3CAA,KAAK+xC,kBAA0Bv3B,GAAY,mCA8BzC,OA7BGxa,KAAK4xC,iBACN5xC,KAAK8L,WAAWmmC,QAAQxT,YAAYz+B,KAAK6K,MACzC7K,KAAK8L,WAAWG,oBAAoBjM,KAAK6K,MACzC7K,KAAK4xC,gBAAiB,GAGxBp3B,EAAUA,EAAQmR,QAAQpf,IACxB,MAAM2lC,GAAelyC,KAAKsxC,gBAAgBa,IAAI5lC,GAE9C,OADG2lC,GAAalyC,KAAKsxC,gBAAgBjyC,IAAIkN,GAClC2lC,KAGNlyC,KAAKoyC,mBACN53B,QAAgB+1B,GAAY/1B,GAAejO,GAAW,mCACpD,GAAGA,EAAO8lC,oBACWryC,KAAK2S,SAAS2/B,gBAAgBC,QAAQhmC,IAChDimC,QACP,IAAI,MAAMvzB,KAAUjf,KAAKoyC,iBACvB,SAASpyC,KAAK2S,SAAS2/B,gBAAgBrzB,GAAQ1S,GAC7C,OAAO,EAMf,OAAO,QAIJke,EAAEjQ,MAGXxa,KAAKD,MAAQjB,SAASC,cAAc,SACpCiB,KAAKD,MAAMX,UAAUC,IAAI,yBACtBW,KAAK+N,aACN,QAAM/N,KAAKD,MAAOC,KAAK+N,iBAAa/D,EAAW,gBAE/C,QAAMhK,KAAKD,MAAO,qBAAiBiK,EAAW,eAGhDhK,KAAKD,MAAME,KAAO,OAEfD,KAAKwxC,YAAa,CACnB,MAAMr4B,EAAU,IAAIC,GAAe,IACnCD,EAAQs5B,eAAerzC,UAAUC,IAAI,2BACrC,IAAIqzC,EAAe5zC,SAASC,cAAc,OAC1C2zC,EAAatzC,UAAUC,IAAI,6BAE3BW,KAAK2yC,kBAAoB7zC,SAASC,cAAc,OAChDiB,KAAK2yC,kBAAkBvzC,UAAUC,IAAI,mBAErCW,KAAK2yC,kBAAkBjzC,OAAOM,KAAKD,OACnC2yC,EAAahzC,OAAOM,KAAK2yC,mBACzB3yC,KAAK4yC,mBAAqB,IAAI,KAAWF,IAIzC,QAAiB1yC,KAAK2yC,mBAAoBtyC,IACxC,GAAGL,KAAKspC,QAAS,OACjB,IAAIniC,EAAS9G,EAAE8G,OAGf,GAFAA,GAAS,EAAAwyB,GAAA,GAAgBxyB,EAAQ,kBAE7BA,EAAQ,OAEZ,MAAMoF,EAASpF,EAAOS,QAAQiI,IACxBgjC,EAAK7yC,KAAKixC,eAAe/rC,cAAc,kBAAoBqH,EAAS,MACtEsmC,EAGFA,EAAGC,QAFH9yC,KAAKM,OAAOiM,EAAOsO,eAMvB1B,EAAQpK,QAAQrP,OAAOgzC,GACvB1yC,KAAKkB,UAAUxB,OAAOyZ,EAAQjY,WAGhClB,KAAKixC,eAAe7xC,UAAUC,IAAI,sBAElC,MAAM8Z,EAAU,IAAIC,GAAe,CACjC3V,KAAMzD,KAAK+yC,uBACXC,UAAU,IAEZ75B,EAAQpK,QAAQrP,OAAOM,KAAK6K,MAC5B7K,KAAKixC,eAAevxC,OAAOyZ,EAAQjY,WACnClB,KAAK8L,WAAa,IAAI,KAAW9L,KAAKixC,gBACtCjxC,KAAK8L,WAAWG,oBAAoBjM,KAAK6K,OAEzC,QAAiB7K,KAAKixC,gBAAiB5wC,IACrC,MAAM8G,GAAS,EAAA8rC,GAAA,GAAgB5yC,EAAE8G,OAAQ,gBAGzC,IAFA,EAAA8gB,EAAA,GAAY5nB,IAER8G,EAAQ,OACZ,GAAGnH,KAAKspC,QAAS,OAEjB,IAAIz5B,EAAuB1I,EAAOS,QAAQ2E,OAG1C,GAFAsD,EAAMA,EAAIwiC,WAAaxiC,EAAIgL,WAAahL,GAEpC7P,KAAKwxC,YAEP,YADAxxC,KAAKX,IAAIwQ,GAKR7P,KAAKkxC,SAASiB,IAAItiC,GACnB7P,KAAKM,OAAOuP,GAEZ7P,KAAKX,IAAIwQ,GAGX,MAAMqjC,EAAW/rC,EAAOjC,cAAc,SACtCguC,EAAS9J,SAAW8J,EAAS9J,WAG/B,MAAM+J,GAAiB,EAAA/G,GAAA,GAASpsC,KAAKkO,QAAS,KAAK,GAAO,GAC1DlO,KAAKD,MAAMK,iBAAiB,QAAS+yC,GAErCnzC,KAAK8L,WAAWO,iBAAmB,KACjCrM,KAAK8xC,kBAGP9xC,KAAK8L,WAAW5K,UAAU2C,QAAQuvC,MAElCpzC,KAAKkB,UAAUxB,OAAOM,KAAKixC,gBAC3BjxC,KAAKqzC,SAAS3zC,OAAOM,KAAKkB,WAG1BkF,YAAW,KACT,IAAIktC,EAAoBtzC,KAAK8xC,iBAC1BlzC,EAAQ20C,eACTD,EAAkB5xC,MAAK,KACrB9C,EAAQ20C,qBAGX,GAiCSC,c,0CAETxzC,KAAKyxC,YACLzxC,KAAKoxC,aACY,IAAlBpxC,KAAKmxC,WACLnxC,KAAKuxC,SAASnqC,SAAS,YACrBpH,KAAK2L,eAAe3L,KAAK2S,SAAS2I,gBAAgBm4B,eAAezzC,KAAK2L,gBAElE3L,KAAK+xC,kBAAkB,CAAC,eAI1B2B,UAAUzzC,GAKhB,YAJ0B+J,IAAvBhK,KAAK0xC,QAAQzxC,KACdD,KAAK0xC,QAAQzxC,GAAQ,KAGdD,KAAK0xC,QAAQzxC,GAGV0zC,iB,0CACZ,GAAG3zC,KAAK8J,QAAS,OAAO9J,KAAK8J,QAE7B,GAAG9J,KAAKqxC,WAAWuC,SAAW5zC,KAAKqxC,WAAWwC,SAC5C,OAIF,MAAMC,EAAY,UAAoB,GAAK,KAAO,EAE5CrsB,EAASznB,KAAK0zC,UAAU,WACxB5pC,EAAU9J,KAAK2S,SAAS40B,mBAAmBwM,iBAAiB/zC,KAAK2L,MAAO3L,KAAKoxC,YAAa0C,EAAW9zC,KAAKmxC,UAAU,GAC1HnxC,KAAK8J,QAAUA,EACf,MAAMtJ,QAAcsJ,EACpB,GAAG9J,KAAK0xC,QAAQkC,UAAYnsB,EAC1B,OAGFznB,KAAK8J,QAAU,KAEf,IAAI8pC,EAAUpzC,EAAMozC,QACpB,GAAGA,EAAQjzC,OAAQ,CACjB,MAAMqzC,GAAiB,EAAAC,GAAA,GAAeL,EAAQA,EAAQjzC,OAAS,KAAO,EAEtEizC,EAAUA,EAAQlzC,SAClB,EAAA+e,GAAA,GAAcm0B,GAASxgC,GAAKA,EAAE7G,SAAW,WAEtCvM,KAAKk0C,mBACNN,QAAgBrD,GAAYqD,GAAUxgC,GAAMpT,KAAKm0C,eAAe/gC,EAAE7G,iBAG9DvM,KAAKwzC,cAEXxzC,KAAKoxC,YAAc4C,EAKrB,GAFAh0C,KAAK+xC,kBAAkB6B,EAAQj5B,KAAK6d,GAAWA,EAAOjsB,UAEnD/L,EAAM4zC,MAAO,CACd,IAAIp0C,KAAKqxC,WAAWuC,QAOlB,aANM5zC,KAAKwzC,cAEXxzC,KAAKqxC,WAAWuC,SAAU,EAC1B5zC,KAAKoxC,YAAc,EACnBpxC,KAAKmxC,SAAW,EAETnxC,KAAK2zC,iBAIZ,GAFA3zC,KAAKqxC,WAAWwC,UAAW,GAEvB7zC,KAAKqxC,WAAWgD,SAClB,OAAOr0C,KAAKs0C,sBAMNH,eAAe5nC,G,0CAC3B,MAAMgoC,QAA0Bv0C,KAAK2S,SAAS2/B,gBAAgBC,QAAQhmC,GACtE,OAAGA,EAAO46B,SACyB,kBAA1BnnC,KAAKk0C,mBAAwC,EAAAM,GAAA,GAAcD,MAC1D,EAAAE,GAAA,GAAUF,EAAmBv0C,KAAKk0C,wBAArC,KAKKI,kB,0CACZ,GAAGt0C,KAAK8J,QAAS,OAAO9J,KAAK8J,QAE7B,GAAG9J,KAAKqxC,WAAWgD,SACjB,OAGF,MAAMK,EAAiB10C,KAAKuxC,SAASnqC,SAAS,YAE9C,IAAIpH,KAAK6xC,eAAgB,CAQvB,MAAMpqB,EAASznB,KAAK0zC,UAAU,YACxB5pC,EAAU3G,QAAQC,IAAI,CAC1BsxC,EAAiB10C,KAAK2S,SAAS2I,gBAAgBq5B,mBAAmB30C,KAAK2L,OAAS,GAChF3L,KAAK2L,MAAQ3L,KAAK2S,SAAS2I,gBAAgBs5B,eAAe50C,KAAK2L,YAAS3B,IAG1EhK,KAAK8J,QAAUA,EACf,IAAK+nC,EAAgBgD,SAAsB/qC,EAC3C,GAAG9J,KAAK0xC,QAAQ2C,WAAa5sB,EAC3B,OAGF,GAAGotB,EAAc,CAEf,IAAIC,EAAgBJ,EAAiBG,EAAaE,WAAWz0B,OAAOu0B,EAAatqB,SAAWsqB,EAAaE,WAEtG/0C,KAAKk0C,mBACNY,QAAsBvE,GAAYuE,GAAgBvoC,GAAWvM,KAAKm0C,eAAe5nC,MAG/EvM,KAAKuxC,SAASnqC,SAAS,aACzB0tC,EAAgBA,EAAcnpB,QAAQpf,GAAWA,EAAO46B,YAG1DnnC,KAAK6xC,gBAAiB,EAAAmD,GAAA,GAAanD,EAAevxB,OAAOw0B,SACpD90C,KAAK6xC,eAAiBA,EAAenxC,SAE5C,EAAAqR,EAAA,GAAiB/R,KAAK6xC,eAAgB,UACtC7xC,KAAK8J,QAAU,KAIf,MAAMgqC,EAAY,UAAoB,GAAK,KAAO,EAC5ClzB,EAAM5gB,KAAK6xC,eAAetzB,OAAO,EAAGu1B,GAC1C9zC,KAAK+xC,kBAAkBnxB,GAGrB5gB,KAAK6xC,eAAelxC,SACtBX,KAAKqxC,WAAWgD,UAAW,MASjBY,6B,0CACZ,GAAGj1C,KAAK8J,QAAS,OAAO9J,KAAK8J,QAE7B,GAAG9J,KAAKqxC,WAAW6D,oBACjB,OAGF,MAEMztB,EAASznB,KAAK0zC,UAAU,uBACxB5pC,EAAU9J,KAAK2S,SAASq8B,kBAAkBmG,uBAAuBn1C,KAAKuM,OAAO8hB,WAAY,CAACzhB,EAAG,4BAA6B2J,EAAGvW,KAAK2L,OAHtH,GAGyI3L,KAAK6K,KAAKI,mBAC/J6lC,QAAqBhnC,EAC3B,GAAG9J,KAAK0xC,QAAQwD,sBAAwBztB,EACtC,OAGF,MAAMjN,EAAUs2B,EAAaA,aAAan2B,KAAKy6B,IACtC,EAAAC,GAAA,GAAqBD,MAE9B,EAAArjC,EAAA,GAAiByI,EAAS,UAC1Bxa,KAAK+xC,kBAAkBv3B,IAEpBxa,KAAK6K,KAAKI,mBAAqB6lC,EAAa/jC,OAAS+jC,EAAaA,aAAanwC,OAfhE,MAgBhBX,KAAKqxC,WAAW6D,qBAAsB,MAQlCpD,iBACN,MAmCMroC,EAnCM,MACV,MAAMA,EAA2B,GAejC,OAAIzJ,KAAKuxC,SAASnqC,SAAS,YAAkDpH,KAAKqxC,WAAWwC,WAC3FpqC,EAASoI,KAAK7R,KAAK2zC,kBAEf3zC,KAAKqxC,WAAWwC,YAKlB7zC,KAAKuxC,SAASnqC,SAAS,cAAepH,KAAKuxC,SAASnqC,SAAS,YAAgBpH,KAAKqxC,WAAWgD,UAC/F5qC,EAASoI,KAAK7R,KAAKs0C,mBAGlBt0C,KAAKuxC,SAASnqC,SAAS,yBAA2BpH,KAAKqxC,WAAW6D,qBACnEzrC,EAASoI,KAAK7R,KAAKi1C,8BAGdxrC,GAZIA,GAeI+H,GACX1H,EAAU3G,QAAQC,IAAIqG,GAK5B,OAJGA,EAAS9I,QACVmJ,EAAQpI,KAAK1B,KAAKkwC,kBAGbpmC,EAGKkoC,cAAcx3B,G,2CAItBxa,KAAKuxC,SAASnqC,SAAS,YAAcpH,KAAKqxC,WAAWgD,WACvD75B,QAAgB+1B,GAAY/1B,GAAUjO,GAC7BvM,KAAK2S,SAAS2I,gBAAgBg6B,iBAAiB/oC,MAI1DiO,EAAQpN,SAAcb,GAAW,mCAC/B,MAAM,IAAC4O,GAAO,gBAA+B,CAC3C5O,OAAQA,EACRrL,UAAWlB,KAAK8L,WAChBsP,cAAepb,KAAKob,cACpB7N,WAAYvN,KAAKuN,aAGnB,GAAGvN,KAAKwxC,YAAa,CACnB,MAAMN,EAAWlxC,KAAKkxC,SAASiB,IAAI5lC,GAC7Bi9B,EAAgB,IAAI,KAEvB0H,IAED1H,EAAczpC,MAAMqpC,SAAU,GAGhCjuB,EAAIo6B,YAAY1xC,QAAQ2lC,EAAcjwB,OAGxC,IAAIi8B,EAEFA,EADCjpC,EAAOkpC,kBACW9E,GAAqBpkC,EAAO8hB,YACvC9hB,IAAW,UACN,QAAKvM,KAAK2xC,cAEVr5B,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,EAAOqO,aAGtFO,EAAIE,gBAAgB3b,OAAO81C,WAIxBn2C,IAAIwQ,EAAsBf,EAA8B4mC,GAAS,GAItE,GAFA11C,KAAKkxC,SAAS7xC,IAAIwQ,IAEd7P,KAAKwxC,YAEP,YADAxxC,KAAKkM,SAASlM,KAAKkxC,SAASlwC,MAI3BhB,KAAK2L,MAAMW,SACZtM,KAAKD,MAAMS,MAAQ,GACnBR,KAAKkO,WAGP,MAAM7J,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,gBAAiB,YAEnC,MAAMguC,EAAW,IAAIC,GAqCrB,OApCAD,EAASjuC,UAAUC,IAAI,uBAAwB,QAAS,aACxDguC,EAASE,UAAW,EAEpBlpC,EAAIuD,QAAQiI,IAAM,GAAKA,EACpBA,EAAIwiC,kBACQroC,IAAV8E,IACDA,EAAQ,IAAIwpB,GAAU,CAAC/rB,OAAQsD,EAAIgL,WAAY2d,QAAQ,IAAOpuB,SAGhEijC,EAASxE,kBAAkB,CACzBt8B,OAAQsD,KAITf,IACoB,iBAAZ,EACPzK,EAAIC,UAAYwK,IAEhB,EAAAlB,EAAA,GAAevJ,EAAKyK,GACpBzK,EAAI3E,OAAOoP,KAIfzK,EAAIsxC,sBAAsB,aAActI,GAExCrtC,KAAK2yC,kBAAkB7uC,aAAaO,EAAKrE,KAAKD,OAE9CC,KAAKkM,UAAYlM,KAAKkM,SAASlM,KAAKkxC,SAASlwC,MAE1C00C,GACD11C,KAAK4yC,mBAAmBgD,kBAAkB,CACxCxrC,QAASpK,KAAKD,MACd4qC,SAAU,WAIPtmC,EAGF/D,OAAOuP,GACZ,IAAI7P,KAAKwxC,YAAa,OAEtB,MAAMntC,EAAMrE,KAAK2yC,kBAAkBztC,cAAc,cAAc2K,OAC/DxL,EAAIjF,UAAUkB,OAAO,YAChB+D,EAAIwxC,YACTxxC,EAAIjF,UAAUC,IAAI,aAElB,MAAMy2C,EAAiB,KACrB91C,KAAKkxC,SAASxhC,OAAOG,GACrBxL,EAAI/D,SACJN,KAAKkM,UAAYlM,KAAKkM,SAASlM,KAAKkxC,SAASlwC,OAG5C,+BACDqD,EAAIjE,iBAAiB,eAAgB01C,EAAgB,CAACtuC,MAAM,IAE5DsuC,IAIGC,cACL,MAAO,IAAI/1C,KAAKkxC,UAGX8E,WAAWC,GAChBA,EAAO7oC,SAAS5M,IACdR,KAAKX,IAAImB,OAAOwJ,GAAW,MAG7BlE,OAAOS,uBAAsB,KAC3BvG,KAAK4yC,mBAAmBgD,kBAAkB,CACxCxrC,QAASpK,KAAKD,MACd4qC,SAAU,SACVuL,eAAgB,kBC5nBT,MAAMC,WAAsB,IAGzCv2C,YAAYhB,GAQViB,MAAM,gBAAiB,KAAM,CAACu2C,UAAU,EAAMhJ,iBAAiB,EAAMxC,MAAM,IAE3E5qC,KAAKg6B,SAAW,IAAIgX,GAAe,CACjCqC,SAAUrzC,KAAK4qC,KACf1+B,SAAU,KAAW,O,EAAA,K,OAAA,E,EAAA,YACnB,MAAMglC,EAAWlxC,KAAKg6B,SAAS+b,cACzBxpC,EAAS2kC,EAASA,EAASvwC,OAAS,GAAGka,WAE7C,GAAGjc,EAAQy3C,SAAU,CACnB,MAAMvpC,EAAMlO,EAAQy3C,SAAS9pC,GAC7B,GAAGO,aAAe3J,QAChB,UACQ2J,EACN,MAAMW,GACN,QAKNzN,KAAKg6B,SAAW,KAChBh6B,KAAKs2C,Q,YAhBc,K,+QAkBrB/E,SAAU3yC,EAAQ23C,UAClBhD,cAAe,KACbvzC,KAAKkvC,OACLlvC,KAAKg6B,SAASkW,mBAEV,MACFlwC,KAAKg6B,SAASj6B,MAAM0M,SAGxBynC,iBAAkBt1C,EAAQs1C,iBAC1B1C,aAAa,EACbp2B,eAAe,EACf7N,WAAY,GACZhB,OAAQ3N,EAAQ2N,OAChBwB,YAAanP,EAAQmP,YACrB4jC,aAAc/yC,EAAQ+yC,aACtBh/B,SAAU3S,KAAK2S,WAKjB3S,KAAK8O,MAAMpP,OAAOM,KAAKg6B,SAASj6B,Q,eChDrB,MAAMy2C,WAA8B1mC,EAKjCT,O,qCAId,IAAIonC,EAHJz2C,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,8BACpDW,KAAK4P,SAAS,oBAId,CACE,MAAMuJ,EAAU,IAAIC,GAAe,CACjC3V,KAAM,0BAGFY,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,sBAClB8Z,EAAQpK,QAAQjL,aAAaO,EAAK8U,EAAQrK,OAE1C,MAAMjE,EAAO,kBAAiC,CAACmQ,KAAK,IACpD3W,EAAI3E,OAAOmL,GAEX,MAAM,IAACsQ,GAAO,gBAA+B,CAC3C5O,OAAQvM,KAAKkb,OAAOL,UAAS,GAC7B3Z,UAAW2J,EACXuQ,eAAe,EACf7N,WAAY,KAGd4N,EAAIE,gBAAgB3b,OAAO4Y,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKkb,UAEhG,MAAM0yB,EAAI,IAAI8I,GAAgB,CAC5Br8B,OAAQra,KAAKqa,OACbpR,eAAgBjJ,KAAKiJ,eACrBoqC,SAAUl6B,EAAQpK,QAClBqmC,YAAoC,6BAAvBp1C,KAAKo1C,YAAYxoC,EAAmC5M,KAAKo1C,iBAAcprC,GACnFhK,KAAK2S,UAER8jC,EAAkB,KAEhB,MAAME,EAAS/I,EAAEgJ,UACS,6BAAvB52C,KAAKo1C,YAAYxoC,IAAoC,EAAAiqC,GAAA,GAAU72C,KAAKo1C,YAAY0B,cAAct+B,OAAQm+B,EAAOn+B,SAIhHxY,KAAK2S,SAASoH,gBAAgBg9B,WAAW/2C,KAAKqa,OAAQra,KAAKo1C,YAAauB,IAG1E32C,KAAK+P,cAAc3P,iBAAiB,UAAWq2C,EAAiB,CAACjvC,MAAM,IAEvExH,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,CACE,MAAMiY,EAAU,IAAIC,GAAe,IAEnC,GAA0B,6BAAvBpZ,KAAKo1C,YAAYxoC,EAAkC,CACpD,MAAMoqC,GAAqB,OAAO,qCAAsC,CAAC/3C,KAAM,SAAUQ,KAAM,4BAE/F,QAAiBu3C,GAAoB,KACnC,MAAMxzC,GAAS,EAAAurC,GAAA,GAAiB,CAACiI,IAAqB,GACtDh3C,KAAK2S,SAASoH,gBAAgBk9B,oCAAoCj3C,KAAKqa,OAAQra,KAAKo1C,aAAa1zC,MAAK,KACpG1B,KAAK+P,cAAc1J,oBAAoB,UAAWowC,GAClDz2C,KAAKiP,WACJ,KACDzL,SAED,CAACyF,eAAgBjJ,KAAKiJ,iBAEzBkQ,EAAQpK,QAAQrP,OAAOs3C,GAGzB,MAAME,GAAY,OAAO,qCAAsC,CAACj4C,KAAM,aAAcQ,KAAM,2BAE1F,QAAiBy3C,GAAW,MACX,EAAAnI,GAAA,GAAiB,CAACmI,IAAY,GAC7Cl3C,KAAK2S,SAASoH,gBAAgBo9B,gBAAgBn3C,KAAKqa,OAAQra,KAAKo1C,aAAa1zC,MAAK,KAChF1B,KAAK+P,cAAc1J,oBAAoB,UAAWowC,GAClDz2C,KAAKiP,aAqBN,CAAChG,eAAgBjJ,KAAKiJ,iBAEzBkQ,EAAQpK,QAAQrP,OAAOw3C,GAEvBl3C,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,a,2kBC7F9B,MAAMw1C,GASX92C,YAAoBhB,EAKT+T,GALS,KAAA/T,QAAAA,EAKT,KAAA+T,SAAAA,EACT3S,KAAKyoB,YAGMA,Y,0CACXzoB,KAAK6mC,EAAI,CACP,CAACuQ,MAAO,CAAC,iBAAkB33C,KAAM,uBAAwB43C,cAAe,0BACxE,CAACD,MAAO,CAAC,cAAe33C,KAAM,4BAA6B43C,cAAe,+BAC1E,CAACD,MAAO,CAAC,gBAAiB,aAAc33C,KAAM,+BAAgC43C,cAAe,kCAC7F,CAACD,MAAO,CAAC,cAAe33C,KAAM,4BAA6B43C,cAAe,+BAC1E,CAACD,MAAO,CAAC,eAAgB33C,KAAM,6BAA8B43C,cAAe,gCAC5E,CAACD,MAAO,CAAC,gBAAiB33C,KAAM,8BAA+B43C,cAAe,iCAC9E,CAACD,MAAO,CAAC,gBAAiB33C,KAAM,8BAA+B43C,cAAe,iCAC9E,CAACD,MAAO,CAAC,eAAgB33C,KAAM,6BAA8B43C,cAAe,iCAG9Er3C,KAAKs3C,WAAa,CAChB,cAAiB,CAAC,aAAc,gBAAiB,aAAc,gBAGjE,MAAM14C,EAAUoB,KAAKpB,QACfwjC,QAAuCpiC,KAAK2S,SAASoH,gBAAgB00B,QAAQ7vC,EAAQyb,QACrFk9B,EAAsBnV,EAAKoV,sBAC3Bb,EAAS/3C,EAAQw2C,YCxDZ,SAAwChT,EAAoBuU,GACzE,GAAGvU,EAAKoV,sBAAuB,CAC7Bb,GAAS,EAAAc,GAAA,GAAKd,GACd,MAAMe,EAAgBtV,EAAKoV,sBAAsBh/B,OACjD,IAAI,IAAIzM,KAAK2rC,EAEXf,EAAOn+B,OAAOzM,GAAK2rC,EAAc3rC,GAIrC,OAAO4qC,ED8CgCgB,CAA+BvV,EAAsBxjC,EAAQw2C,YAAY0B,eAAiBS,EAEzHK,EAA+Bh5C,EAAQw2C,YAAc,2BAA6B,gCACxF,IAAI,MAAMyC,KAAQ73C,KAAK6mC,EAAG,CACxB,MAAMiR,EAAWD,EAAKT,MAAM,GAC5BS,EAAKrO,cAAgB,IAAI,KAAc,CACrC/pC,KAAMo4C,EAAKp4C,KACX2pC,SAAS,EAAAqL,GAAA,GAAUrS,EAAM0V,EAAUnB,GACnCoB,aAAa,EACb/J,YAAY,KAIVpvC,EAAQw2C,aACRmC,EAAoB/+B,OAAOs/B,IAE1B1V,EAAsB4J,WAErB6L,EAAKT,MAAMhwC,SAAS,iBACpBywC,EAAKT,MAAMhwC,SAAS,mBAIxBywC,EAAKrO,cAAczpC,MAAMR,UAAW,GAYpC,QAAiBs4C,EAAKrO,cAAcjwB,OAAQlZ,IAC1CsrC,GAAM,YAAYiM,GAAiB,MAClC,CAAC3uC,eAAgBrK,EAAQqK,kBAG3BjJ,KAAKs3C,WAAWQ,IACjBl5C,EAAQqK,eAAe5J,IAAIw4C,EAAKrO,cAAczpC,MAA9CnB,CAAqD,UAAU,KACzDi5C,EAAKrO,cAAcJ,SACPppC,KAAK6mC,EAAElb,QAAQ5f,GAAM/L,KAAKs3C,WAAWQ,GAAU1wC,SAAS2E,EAAEqrC,MAAM,MACxEhqC,SAASyqC,IACbA,EAAKrO,cAAcJ,SAAU,QAMrCxqC,EAAQy0C,SAAS3zC,OAAOm4C,EAAKrO,cAAcjwB,WAIxCq9B,UACL,MAAMD,EAA2B,CAC/B/pC,EAAG,mBACHorC,WAAY,WACZx/B,OAAQ,IAGV,IAAI,MAAMq/B,KAAQ73C,KAAK6mC,GACLgR,EAAKrO,cAAcJ,SAEjCyO,EAAKT,MAAMhqC,SAAS6qC,IAElBtB,EAAOn+B,OAAOy/B,IAAQ,KAK5B,OAAOtB,GAII,MAAMuB,WAA+BpoC,EAGlCT,O,0CAId,IAAI8oC,EAHJn4C,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,+BACpDW,KAAK4P,SAAS,sBAGd,CACE,MAAMuJ,EAAU,IAAIC,GAAe,CACjC3V,KAAM,6BAGR00C,EAAkB,IAAIzB,GAAgB,CACpCr8B,OAAQra,KAAKqa,OACbpR,eAAgBjJ,KAAKiJ,eACrBoqC,SAAUl6B,EAAQpK,SACjB/O,KAAK2S,UAER3S,KAAK+P,cAAc3P,iBAAiB,WAAW,KAC7CJ,KAAK2S,SAASoH,gBAAgBq+B,4BAA4Bp4C,KAAKqa,OAAQ89B,EAAgBvB,aACtF,CAACpvC,MAAM,IAEVxH,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,CACE,MAAMiY,EAAU,IAAIC,GAAe,CACjC3V,KAAM,sBAGF40C,EAAkB,IAAIhP,GAAI,CAC9BW,aAAc,sBACdN,gBAAiB,UACjBzqC,KAAM,UACNyL,UAAW,KACT,IAAIyrC,GAAc,CAChBI,UAAW,CAAC,uBACZF,SAAW9pC,IACTnG,YAAW,KACTkyC,EAAgB/rC,KACf,IAELwB,YAAa,oCACbxB,QAASvM,KAAKqa,YAKdi+B,EAAwB/rC,GAAmB,mCAC/C,IAAI6oC,EACJ,IACEA,QAAoBp1C,KAAK2S,SAASq8B,kBAAkBuJ,sBAAsBv4C,KAAKqa,OAAQ9N,GACvF,MAAMkB,GAEN,YADAk+B,GAAM,iCAIR,MAAM76B,EAAM9Q,KAAKyO,OAAO+D,UAAUgkC,IAClC1lC,EAAIskC,YAAcA,EAClBtkC,EAAIuJ,OAASra,KAAKqa,OAClBvJ,EAAIoK,OAAS3O,EACbuE,EAAI3B,UAGNgK,EAAQpK,QAAQrP,OAAO24C,EAAgBn3C,WAWvC,MAAM4V,EAAIqC,EAAQq/B,yBAClB1hC,EAAE1X,UAAUC,IAAI,sBAEhB,MAAMwL,EAAO,kBAAiC,CAACmQ,KAAK,IACpDlE,EAAEpX,OAAOmL,IAET,QAAiBA,GAAOxK,IACtB,MAAM8G,GAAS,EAAAsxC,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IACnC,IAAIvxC,EAAQ,OAEZ,MAAMoF,EAASpF,EAAOS,QAAQ2E,OAAOsO,WACrCy9B,EAAgB/rC,KACf,CAACtD,eAAgBjJ,KAAKiJ,iBAEzB,MAAM0vC,EAAc,CAAM9F,EAAauC,IAA6D,mCAClG,MAAMwD,EAAexD,EAAY0B,cAC3BS,SAA8Bv3C,KAAK2S,SAASoH,gBAAgB00B,QAAQzuC,KAAKqa,SAA0Bm9B,sBAGnGqB,EAA0B,GAChCV,EAAgBtR,EAAEz5B,SAASyqC,IACzB,MAAMC,EAAWD,EAAKT,MAAM,GAEzBwB,EAAapgC,OAAOs/B,KAAcP,EAAoB/+B,OAAOs/B,IAC9De,EAAShnC,KAAKgmC,EAAKR,kBAOvB,MAAM9lC,EAAKshC,EAAG3tC,cAAc,sBAEzB2zC,EAASl4C,SACV4Q,EAAGjN,UAAY,GACfiN,EAAG7R,WAAU,QAAKm5C,EAASl+B,KAAKtI,IAAM,QAAKA,MAAK,KAKlDd,EAAGnS,UAAUoE,OAAO,QAASq1C,EAASl4C,WAGlCtB,EAAM,CAAC+1C,EAA0D11C,KACrE,MAAM,IAACyb,GAAO,gBAA+B,CAC3C5O,QAAQ,EAAAusC,GAAA,GAAU1D,EAAYb,MAC9BrzC,UAAW2J,EACXuQ,eAAe,EACf7N,WAAY,GACZ7N,OAAAA,IAGFi5C,EAAYx9B,EAAI49B,OAAQ3D,IAgCpB4D,EAAY,MAChB,EAAAprC,EAAA,GAAeyqC,EAAgB5O,UAAU,QAAKwP,EAAkB,8BAAgC,2BAA4B,CAACA,MAG/H,IACIjyB,EADAiyB,EAAkB,EAEtB,MAAMC,EAAY,KAEhBlyB,EAAS,IAAI8oB,GAAiB,CAC5BhkC,WAAY9L,KAAK8L,WACjBmkC,WAAY,IACHjwC,KAAK2S,SAASq8B,kBAAkBmG,uBAAuBn1C,KAAKqa,OAAQ,CAACzN,EAAG,4BAA6B2J,EAAG,IAJhG,GAIiH1L,EAAKI,mBAAmBvJ,MAAMoL,IAC5J,IAAI,MAAMsoC,KAAetoC,EAAIgkC,aAC3BzxC,EAAI+1C,GAA4D,GAMlE,OAHA6D,EAAkBnsC,EAAIC,MACtBisC,IAEOlsC,EAAIgkC,aAAanwC,OAZX,IAYkCmM,EAAIC,QAAUlC,EAAKI,uBAKjE+b,EAAO7lB,QAGhBnB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,kBAEtBlB,KAAK2S,SAASoH,gBAAgBo/B,UAAUn5C,KAAKqa,eAC9C6+B,KAENF,IAEAh5C,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAEo5C,YAAAA,EAAaC,UAAAA,MAC/Dr5C,KAAKqa,SAAW++B,IACjBp5C,KAAKqa,OAASg/B,EACdH,aAOVxnC,qBACE1R,KAAK8L,WAAWg5B,YE9UL,MAAMwU,GACnB15C,YACU2M,EAEAglC,EACA8E,GAHA,KAAA9pC,OAAAA,EAEA,KAAAglC,SAAAA,EACA,KAAA8E,SAAAA,EAERr2C,KAAKyoB,YAGOA,Y,qCACZ,IAAI,OAAClc,EAAM,SAAEglC,EAAQ,SAAE8E,GAAYr2C,KACnC,MAAMu5C,EAAmB,IAAIjhB,GAAU,CAAC/rB,OAAAA,IAASnC,QAE3CuI,EAAW,kBACD3I,IAAbunC,IACDA,QAAiB5+B,EAAS2/B,gBAAgBkH,cAAcjtC,IAQ1D,MAAMktC,EAAgB,CAACrQ,EAA4CsQ,EAAQ5L,KAAgB1E,EAAQpoC,QACjG,IAAI8I,EAAU6I,EAASoH,gBAAgB4/B,MAAMptC,EAAO8hB,YAEjDqrB,IACD5vC,EAAUA,EAAQohB,SAAQ,IACjBvY,EAAS40B,mBAAmBqS,aAAartC,MAIpD8pC,GAAYA,EAASvsC,IAGjB+vC,EAAkBzQ,IACtB,IAAIt/B,EAEJ,GAAGyC,EAAO46B,SACRr9B,EAAU6I,EAAS40B,mBAAmBqS,aAAartC,GAAQ,EAAOuhC,IAAe1E,EAAQpoC,UAAOgJ,OAC3F,CACL,IAAGo/B,EAAQpoC,KAGT,OAAOy4C,EAAcrQ,GAFrBt/B,EAAU6I,EAASoH,gBAAgBrK,OAAOnD,EAAO8hB,YAMrDgoB,GAAYA,EAASvsC,IAGvB,IAAIgF,EAAoB6+B,EAA0BmM,EAAwB3M,EAAsCW,EAChH,OAAOyD,GACL,IAAK,iBACuC5+B,EAASoH,gBAAgB06B,UAAUloC,EAAO8hB,WAAY,iBAC9Fvf,EAAQ,oBACR6+B,EAAc,iCACdR,EAAU,CAAC,CACT5B,QAAS,oBACTwO,UAAU,EACVj1C,SAAU+0C,IAGZ/L,EAAa,CAAC,CACZruC,KAAM,0BAGRqP,EAAQ,mBACR6+B,EAAc,4BACdmM,EAAkB,CAACP,GACnBpM,EAAU,CAAC,CACT5B,QAAS,eACTwO,UAAU,EACVj1C,SAAU20C,KAId,MAeF,IAAK,OACH3qC,EAAQ,iBACR6+B,EAAc,mCACdmM,EAAkB,CAACP,GAEnBpM,EAAU,CAAC,CACT5B,QAAS,iBACTwO,UAAU,EACVj1C,SAAU+0C,IAGZ/L,EAAa,CAAC,CACZruC,KAAM,2BACNu6C,SAAU,CACR,IAAI1hB,GAAU,CAAC/rB,OAAAA,IAASnC,WAI5B,MAGF,IAAK,QACH0E,EAAQ,iBACR6+B,EAAc,wCACdR,EAAU,CAAC,CACT5B,QAAS,iBACTwO,UAAU,EACVj1C,SAAU+0C,IAGZ,MAGF,IAAK,YACL,IAAK,eACuClnC,EAASoH,gBAAgB06B,UAAUloC,EAAO8hB,WAAY,iBAC9Fvf,EAAQ,iBACR6+B,EAAc,0BACdR,EAAU,CAAC,CACT5B,QAAS,iBACTwO,UAAU,EACVj1C,SAAU+0C,IAGZ/L,EAAa,CAAC,CACZruC,KAAM,mCAGRqP,EAAQ,gBACR6+B,EAAc,8BACdmM,EAAkB,CAACP,GACnBpM,EAAU,CAAC,CACT5B,QAAS,iBACTwO,UAAU,EACVj1C,SAAWgpC,GAAe2L,EAAc3L,GAAY,MAQ5D,IAAIZ,GAAU,oBAAqB,CACjC3gC,OAAAA,EACAy9B,aAAcl7B,EACd4+B,mBAAoBC,EACpBE,oBAAqBiM,EACrB3M,QAAAA,EACAW,WAAAA,IACCoB,Q,2kBCjKQ,MAAM+K,WAA4BnqC,EAG/BT,O,gDACdrP,KAAK4P,SAAS,aAEd,MAAMsqC,QAA2Bl6C,KAAK2S,SAASwnC,oBAAoBC,8BAC7DzL,QAAiB3uC,KAAK2S,SAASq8B,kBAAkBqL,YAAYr6C,KAAKqa,QACxE,IAAIigC,EAAgD,QAA5B,EAAA3L,EAAS4L,2BAAmB,QAAI,GACxD,MAAMC,EAAmB,IAAI57B,IAAI07B,GAE3BG,EAAgB,IAAIrhC,GAAe,CACvC+1B,eAAenvC,KAAK2S,SAASoH,gBAAgBq0B,YAAYpuC,KAAKqa,SAAU,6BAA+B,6BAGnGqgC,EAAsB,IAAI,KAAc,CAACl3C,QAAQ,EAAM4lC,UAAWoR,EAAiBx5C,OACnF25C,EAAY,IAAItR,GAAI,CACxBG,cAAekR,EACf1Q,aAAc,oBAGhByQ,EAAc1rC,QAAQrP,OAAOi7C,EAAUz5C,WAEvC,MAAM05C,EAAmB,IAAIxhC,GAAe,CAC1C3V,KAAM,uBAGFo3C,EAAiBX,EAAmBv/B,KAAKmgC,IAC7C,MAAMtR,EAAgB,IAAI,KAAc,CACtChmC,QAAQ,EACR4lC,QAASoR,EAAiBrI,IAAI2I,EAAkBC,YAGlD/6C,KAAKiJ,eAAe5J,IAAImqC,EAAczpC,MAAtCC,CAA6C,UAAU,KAClDwpC,EAAcJ,SACfoR,EAAiBn7C,IAAIy7C,EAAkBC,UAEnCL,EAAoBtR,SACtBsR,EAAoB95C,kBAAiB,KAGvC45C,EAAiB9qC,OAAOorC,EAAkBC,WAEtCP,EAAiBx5C,MAAQ05C,EAAoBtR,SAC/CsR,EAAoB95C,kBAAiB,IAIzCo6C,OAGF,MAAMz1B,EAAM,IAAI8jB,GAAI,CAClBG,cAAAA,EACA16B,MAAOgsC,EAAkBhsC,MACzB86B,aAAa,IAWf,OARAqR,GAAiB,CACf11B,IAAAA,EACAiV,IAAKsgB,EAAkBI,YACvBl6C,KAAM,UAGR45C,EAAiB7rC,QAAQrP,OAAO6lB,EAAIrkB,WAE7BsoC,KAGTxpC,KAAKiJ,eAAe5J,IAAIs7C,EAAUnR,cAAczpC,MAAhDC,CAAuD,UAAU,KAC3D06C,EAAoBtR,QAGdyR,EAAeM,OAAO3R,IAAmBA,EAAcJ,YAC/DyR,EAAeztC,SAASo8B,GAAkBA,EAAcJ,SAAU,IAClE4R,MAJAH,EAAeztC,SAASo8B,GAAkBA,EAAcJ,SAAU,IAClE4R,QAOJ,MAAMI,EAAgB,IAAW,mCAC/B,MAAMC,EAAejqC,MAAMC,KAAKmpC,GAChC,GAAG,IAAIa,GAAcC,OAAO33B,SAAW,IAAI22B,GAAmBgB,OAAO33B,OACnE,OAGF,MAAMgrB,QAAiB3uC,KAAK2S,SAASq8B,kBAAkB4B,kBAAkB5wC,KAAKqa,QAC3Es0B,IACDA,EAAS4L,oBAAsBc,GAGjCr7C,KAAK2S,SAASoH,gBAAgBwhC,0BAA0Bv7C,KAAKqa,OAAQghC,GACrEf,EAAoBe,KAGhBL,GAAyB,EAAA5O,GAAA,GAASgP,EAAe,KAAM,GAAO,GAEpEp7C,KAAK+P,cAAc3P,iBAAiB,UAAWg7C,EAAe,CAAC5zC,MAAM,IAErExH,KAAK8L,WAAWpM,OAAO+6C,EAAcv5C,UAAW05C,EAAiB15C,e,2SCrFtD,MAAMs6C,WAAuBhtC,EAO1BitC,Q,gDAEdz7C,KAAKiJ,eAAe0G,YACpB3P,KAAK8L,WAAW5K,UAAUoD,UAAY,GAC3B,QAAX,EAAAtE,KAAKynB,cAAM,QAAXznB,KAAKynB,OAAW,GAChB,MAAMA,IAAWznB,KAAKynB,OAEtBznB,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,wBACpDW,KAAK4P,SAAS,QAEd,IAAI++B,QAAiB3uC,KAAK2S,SAASq8B,kBAAkBqL,YAAYr6C,KAAKqa,QAAQ,GAE9E,MAAM+nB,QAAuCpiC,KAAK2S,SAASoH,gBAAgB00B,QAAQzuC,KAAKqa,QAClF+zB,QAAoBpuC,KAAK2S,SAASoH,gBAAgBq0B,YAAYpuC,KAAKqa,QACnE8+B,QAAkBn5C,KAAK2S,SAASoH,gBAAgBo/B,UAAUn5C,KAAKqa,QAE/DqhC,EAAsC,GACtCC,EAAyB72C,IAC7B42C,EAAoB7pC,KAAK/M,IAG3B9E,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAgBqa,IAC9Cra,KAAKqa,SAAWA,GACjBqhC,EAAoBtuC,SAAStI,GAAaA,SAI9C9E,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAA0Bqa,GAAW,mCACnEra,KAAKqa,SAAWA,IACjBs0B,SAAiB3uC,KAAK2S,SAASq8B,kBAAkB4B,kBAAkBv2B,KAAWs0B,QAIlF,MAAMpiC,EAASvM,KAAKqa,OAAOQ,UAAS,GAC9B+gC,QAAsB57C,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,eAC3EwhC,QAA6B77C,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,sBAExF,CACE,MAAMlB,EAAU,IAAIC,GAAe,CAACg2B,aAAa,IAC3C9G,EAA4B,GAE5BjvB,EAAeva,SAASC,cAAc,OA+B5C,GA9BAsa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAK87C,mBAAqB,IAAI,IAAW,CACvCviC,MAAO60B,EAAc,mBAAqB,yBAC1C3qC,KAAM,YACN+V,UAAW,IACXgvB,UAAU,IAEZxoC,KAAK+7C,sBAAwB,IAAI,IAAW,CAC1CxiC,MAAO,yBACP9V,KAAM,mBACN+V,UAAW,MAGbxZ,KAAK87C,mBAAmBpM,iBAAiBtN,EAAKtzB,OAC9C9O,KAAK+7C,sBAAsBrM,iBAAiBf,EAAS10B,OAErDZ,EAAa3Z,OAAOM,KAAK87C,mBAAmB56C,UAAWlB,KAAK+7C,sBAAsB76C,WAElFonC,EAAYz2B,KAAK7R,KAAK87C,mBAAoB97C,KAAK+7C,uBAE/C/7C,KAAKg8C,SAAW,IAAIhU,GAAS,CAC3Bz7B,OAAAA,EACA+7B,YAAAA,EACAr/B,eAAgBjJ,KAAKiJ,iBAEvBjJ,KAAK+O,QAAQrP,OAAOM,KAAKg8C,SAASliC,SAElCX,EAAQpK,QAAQrP,OAAOM,KAAKg8C,SAAS/iC,WAAW/X,UAAWmY,GAExDuiC,EAAe,CAChB,MAAMK,EAAc,IAAI5S,GAAI,CAC1BW,aAAcoE,EAAc,cAAgB,YAC5C1jC,UAAW,KACT,MAAMoG,EAAM9Q,KAAKyO,OAAO+D,UAAU27B,IAClCr9B,EAAIuJ,OAASra,KAAKqa,OAClBvJ,EAAI69B,SAAWA,EACf79B,EAAI3B,OAEJnP,KAAKiJ,eAAe5J,IAAIyR,EAAIf,cAA5B/P,CAA2C,UAAWk8C,IAExDj9C,KAAM,SAGFi9C,EAAsB,KAG1B,IAAIrsC,EAFJosC,EAAYxS,SAAS9W,YAAc,GAIjC9iB,EADCu+B,EACMhM,EAAsB4J,SAAW,aAAe,cAEhD5J,EAAsB4J,SAAW,kBAAoB,mBAG9DiQ,EAAYxS,SAAS/pC,QAAO,QAAKmQ,KAGnCqsC,IACA/iC,EAAQpK,QAAQrP,OAAOu8C,EAAY/6C,WAGrC,GAAG06C,GAAiBC,EAAsB,CACxC,MAAMM,EAAe,IAAI9S,GAAI,CAC3BW,aAAc,YACd/qC,KAAM,YACNyL,UAAW,KACT,MAAMoG,EAAM9Q,KAAKyO,OAAO+D,UAAUynC,IAClCnpC,EAAIuJ,OAASra,KAAKqa,OAClBvJ,EAAI3B,OAAOzN,MAAK,KACX1B,KAAKynB,SAAWA,GAInBznB,KAAKiJ,eAAe5J,IAAIyR,EAAIf,cAA5B/P,CAA2C,UAAWo8C,SAMtDC,SAD2Br8C,KAAK2S,SAASwnC,oBAAoBmC,yBACf3wB,QAAQmvB,IAAuBA,EAAkBtiC,OAAO+jC,WAAU57C,OAChHy7C,EAAqB,K,MACzB,MAAMI,EAAwC,QAA5B,EAAA7N,EAAS4L,2BAAmB,QAAI,GAClD4B,EAAa1S,SAASnlC,UAAYk4C,EAAU77C,OAAS,IAAM07C,GAG7DD,IAEAjjC,EAAQpK,QAAQrP,OAAOy8C,EAAaj7C,WAGtC,GAAG26C,IAAyBzN,EAAa,CACvC,MAAMgJ,EAAQ,CACZ,gBACA,aACA,gBACA,aACA,cACA,eACA,eACA,eAGIqF,EAAiB,IAAIpT,GAAI,CAC7BW,aAAc,qBACdt/B,UAAW,KACT,MAAMoG,EAAM9Q,KAAKyO,OAAO+D,UAAU0lC,IAClCpnC,EAAIuJ,OAASra,KAAKqa,OAClBvJ,EAAI3B,QAENlQ,KAAM,gBAGFy9C,EAAuB,IAAW,mCACtC,MAAMta,QAAapiC,KAAK2S,SAASoH,gBAAgB4iC,aAAa38C,KAAKqa,QACnEoiC,EAAehT,SAASnlC,UAAY8yC,EAAMt2B,QAAO,CAACC,EAAK0J,IAAM1J,KAAO,EAAA0zB,GAAA,GAAUrS,EAAM3X,EAAI2X,EAAmBoV,wBAAwB,GAAK,IAAMJ,EAAMz2C,UAGtJ+7C,IACAvjC,EAAQpK,QAAQrP,OAAO+8C,EAAev7C,WAEtClB,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAgBqa,IAC9Cra,KAAKqa,SAAWA,GACjBqiC,OA+DN,GAjDA18C,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YAE/B,QAAiBlB,KAAKg8C,SAASliC,SAAS,KACtC9Z,KAAKg8C,SAASliC,QAAQva,UAAW,EAEjC,IAAIkK,EAA2B,GAE/B,MAAM+G,EAAKxQ,KAAKqa,OACbra,KAAK87C,mBAAmB7O,mBACzBxjC,EAASoI,KAAK7R,KAAK2S,SAASoH,gBAAgB6iC,UAAUpsC,EAAIxQ,KAAK87C,mBAAmBt7C,QAGjFR,KAAK+7C,sBAAsB9O,mBAC5BxjC,EAASoI,KAAK7R,KAAK2S,SAASoH,gBAAgB8iC,UAAUrsC,EAAIxQ,KAAK+7C,sBAAsBv7C,QAGpFR,KAAKg8C,SAASjjC,cACftP,EAASoI,KAAK7R,KAAKg8C,SAASjjC,eAAerX,MAAM4Y,GACxCta,KAAK2S,SAASoH,gBAAgBQ,UAAU/J,EAAI8J,MAIvDnX,QAAQ25C,KAAKrzC,GAAUyhB,SAAQ,KAC7BlrB,KAAKg8C,SAASliC,QAAQnV,gBAAgB,YACtC3E,KAAKiP,aAEN,CAAChG,eAAgBjJ,KAAKiJ,iBAuBtBmlC,UAAqBpuC,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,gBAAgB,CAC3F,MAAM0iC,EAA4B,IAAI,KAAc,CAClDt9C,KAAM,wBACN2pC,UAAYhH,EAAsB5pB,OAAOwkC,WACzChP,YAAY,IAGdhuC,KAAKiJ,eAAe5J,IAAI09C,EAA0Bh9C,MAAlDC,CAAyD,UAAU,KACjE,MAAMwD,EAASu5C,EAA0BhO,kBAAiB,GAC1D/uC,KAAK2S,SAASoH,gBAAgBkjC,iBAAiBj9C,KAAKqa,OAAQ0iC,EAA0B3T,SAAS1nC,MAAK,KAClG8B,UAIJm4C,GAAsB,KACpBoB,EAA0Bn8C,mBAAoBwhC,EAAsB5pB,OAAOwkC,eAG7E7jC,EAAQpK,QAAQrP,OAAOq9C,EAA0BxjC,QAIrD,IAAI60B,EAAa,CACf,MAAMj1B,EAAU,IAAIC,GAAe,IAcnC,IAAIg1B,GAAewN,EAAe,CAChC,MAAMsB,EAA+B,IAAI,KAAc,CACrDz9C,KAAM,cACNuuC,YAAY,IAGdhuC,KAAKiJ,eAAe5J,IAAI69C,EAA6Bn9C,MAArDC,CAA4D,UAAU,KACpE,MAAMwD,EAAS05C,EAA6BnO,kBAAiB,GAC7D/uC,KAAK2S,SAASoH,gBAAgBojC,uBAAuBn9C,KAAKqa,QAAS6iC,EAA6B9T,SAAS1nC,MAAK,KAC5G8B,UAKJ,MAAMosC,EAAe,KACnBsN,EAA6Bt8C,iBAAiBu4C,IAAexK,EAAkCn2B,OAAO4kC,oBAGxGxN,IACA+L,EAAsB/L,GAEtBz2B,EAAQpK,QAAQrP,OAAOw9C,EAA6B3jC,OAGnDJ,EAAQpK,QAAQ9D,mBACjBjL,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAInC,SAASlB,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,eAAgB,CAC5E,MAAMlB,EAAU,IAAIC,GAAe,IAE7B89B,GAAY,OAAO,qCAAsC,CAACj4C,KAAM,SAAUQ,KAAM2uC,EAAc,yBAA2B,yBAE/H,QAAiB8I,GAAW,KAC1B,IAAIoC,GAAkB/sC,OAAwBvC,GAAYF,IACxD,MAAMtG,GAAS,EAAAurC,GAAA,GAAiB,CAACmI,IAAY,GAC7CptC,EAAQpI,MAAK,KACX1B,KAAKiP,WACJ,KACDzL,YAGH,CAACyF,eAAgBjJ,KAAKiJ,iBAEzBkQ,EAAQpK,QAAQrP,OAAOw3C,GAEvBl3C,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAG7Bi4C,GAEFn5C,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAEo5C,YAAAA,EAAaC,UAAAA,MAC/D9sC,IAAW6sC,IACZp5C,KAAKqa,OAASg/B,EAAUhrB,WACxBruB,KAAKy7C,eAMHpsC,OACR,OAAOrP,KAAKy7C,S,eC9VD,SAAS4B,GAAgBC,GACtC,MAAO,KAAM,EAAAC,GAAA,GAAkBD,GAAOE,U,2SCczB,MAAMC,WAA0BjvC,EAM7Ba,O,0CACdrP,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,0BACpD,MAAMq+C,UAAgB19C,KAAK2S,SAAS2I,gBAAgBqiC,UAAU39C,KAAKuM,OAAOqO,aAC1E5a,KAAK4P,SAAS8tC,EAAQ,kBAAoB,QAE1C,CACE,MAAMvkC,EAAU,IAAIC,GAAe,CAACg2B,aAAa,IAC3C9G,EAA4B,GAE5BjvB,EAAeva,SAASC,cAAc,OAe5C,GAdAsa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAK49C,eAAiB,IAAI,IAAW,CACnCrkC,MAAO,YACP9V,KAAM,eACN+V,UAAW,GACXgvB,UAAU,IAEZxoC,KAAK69C,mBAAqB,IAAI,IAAW,CACvCtkC,MAAO,WACP9V,KAAM,mBACN+V,UAAW,KAGVxZ,KAAKuM,OAAQ,CACd,MAAMgM,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKuM,QAE3DmxC,GACD19C,KAAK49C,eAAeE,cAAcvlC,EAAKwlC,YACvC/9C,KAAK69C,mBAAmBC,cAAcvlC,EAAKylC,aAE3Ch+C,KAAK49C,eAAelO,iBAAiBn3B,EAAKwlC,YAC1C/9C,KAAK69C,mBAAmBnO,iBAAiBn3B,EAAKylC,YAelD,GAXA3kC,EAAa3Z,OAAOM,KAAK49C,eAAe18C,UAAWlB,KAAK69C,mBAAmB38C,WAC3EonC,EAAYz2B,KAAK7R,KAAK49C,eAAgB59C,KAAK69C,oBAE3C79C,KAAKg8C,SAAW,IAAIhU,GAAS,CAC3Bz7B,OAAQvM,KAAKuM,OACb+7B,YAAAA,EACAr/B,eAAgBjJ,KAAKiJ,eACrB6/B,iBAAiB,IAEnB9oC,KAAK+O,QAAQrP,OAAOM,KAAKg8C,SAASliC,SAE/B9Z,KAAKuM,OAAQ,CACd,MAAMlI,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,eAClBgF,EAAI3E,OAAOM,KAAKg8C,SAASpT,YAEzB,MAAMqV,EAA6B,IAAI,KAAc,CACnDx+C,KAAM,kBAGRw+C,EAA2Bl+C,MAAMK,iBAAiB,UAAWC,IACvDA,EAAEkjC,WAINvjC,KAAK2S,SAAS40B,mBAAmB2W,eAAel+C,KAAKuM,WAGvDvM,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,mBAAyBq4B,GAAW,mCACrE,GAAqB,eAAlBA,EAAOkc,KAAK3nC,EAAoB,OACnC,MAAML,GAAS,EAAAusC,GAAA,GAAUzgB,EAAOkc,KAAKA,MACrC,GAAGv0C,KAAKuM,SAAWA,EAAQ,CACzB,MAAM4xC,UAAkBn+C,KAAK2S,SAASyrC,wBAAwBC,QAAQhmB,EAAOimB,kBAC1EH,IAAYF,EAA2B7U,UACxC6U,EAA2B7U,QAAU+U,SAK3C,MAAMI,EAAiBz/C,SAASC,cAAc,OAC9Cw/C,EAAen/C,UAAUC,IAAI,gBAC7Bk/C,EAAe7+C,OAAO,IAAI44B,GAAU,CAClC/rB,OAAQvM,KAAKuM,SACZnC,SAGH,MAAMo0C,EAAqB1/C,SAASC,cAAc,OAMlD,GALAy/C,EAAmBp/C,UAAUC,IAAI,oBACjCm/C,EAAmB9+C,QAAO,QAAK,6BAE/ByZ,EAAQpK,QAAQrP,OAAO2E,EAAKk6C,EAAgBC,EAAoBnlC,GAE5DqkC,EASG,CACL,MAAMnlC,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKuM,QAExDkyC,EAAW,IAAIpV,GAAI,CACvBpqC,KAAM,QACN+qC,aAAczxB,EAAK+kC,WAAQtzC,EAAY,eACvC8E,MAAOyJ,EAAK+kC,MAAQD,GAAgB9kC,EAAK+kC,YAAUtzC,EACnD0/B,gBAAiBnxB,EAAK+kC,MAAQ,QAAU,4BACxC3T,iBAAkBpxB,EAAK+kC,WAAQtzC,EAAY,CAAC,IAAIsuB,GAAU,CAAC/rB,OAAQvM,KAAKuM,SAASnC,WAGnF+O,EAAQpK,QAAQrP,OAAO++C,EAASv9C,eApBvB,CACT,MAAMw9C,EAAmB,IAAIrV,GAAI,CAC/BG,cAAeyU,IAGXE,UAAkBn+C,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKuM,QAAQ,IAC5F0xC,EAA2B7U,QAAU+U,EAErChlC,EAAQpK,QAAQrP,OAAOg/C,EAAiBx9C,iBAe1CiY,EAAQpK,QAAQrP,OAAO2Z,GAGzBrZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YAE/B,QAAiBlB,KAAKg8C,SAASliC,SAAS,IAAW,mCACjD9Z,KAAKg8C,SAASliC,QAAQva,UAAW,EAEjCS,KAAK2S,SAAS2I,gBAAgBsjC,WAC5B5+C,KAAKuM,OACLvM,KAAK49C,eAAep9C,MACpBR,KAAK69C,mBAAmBr9C,aACjBR,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKuM,SAAS+wC,OAC3DpyB,SAAQ,KACRlrB,KAAKg8C,SAASliC,QAAQnV,gBAAgB,YACtC3E,KAAKiP,eAEN,CAAChG,eAAgBjJ,KAAKiJ,iBAG3B,IAAIy0C,EAAO,CACT,MAAMvkC,EAAU,IAAIC,GAAe,IAI7B89B,GAAY,OAAO,qCAAsC,CAACj4C,KAAM,SAAUQ,KAAM,4BAEtF,QAAiBy3C,GAAW,KAC1B,IAAIhK,GAAU,uBAAwB,CACpC3gC,OAAQvM,KAAKuM,OACby9B,aAAc,gBACd0D,mBAAoB,0BACpBP,SAAS,OAAgB,CAAC,CACxB5B,QAAS,SACTzmC,SAAU,KACR,MAAMtB,GAAS,EAAAurC,GAAA,GAAiB,CAACmI,IAAY,GAE7Cl3C,KAAK2S,SAAS2I,gBAAgBujC,eAAe,CAAC7+C,KAAKuM,SAAS7K,MAAK,KAC/D1B,KAAKiP,WACJ,KACDzL,QAGJu2C,UAAU,OAEX7K,SACF,CAACjmC,eAAgBjJ,KAAKiJ,iBAEzBkQ,EAAQpK,QAAQrP,OAAOw3C,GAEvBl3C,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,gBClLtB,MAAM49C,WAAyBtwC,EAOlCa,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,yBAC7BW,KAAK8Z,QAAU,EAAa,CAAC7a,KAAM,eACnCe,KAAK+O,QAAQrP,OAAOM,KAAK8Z,SACzB9Z,KAAK8L,WAAW5K,UAAUZ,SAE1BN,KAAK8Z,QAAQ1Z,iBAAiB,SAAS,KACrC,MAAMoa,EAAUxa,KAAKg6B,SAAS+b,cAAcp7B,KAAKokC,GAAQA,EAAIlkC,aAE7D,GAAG7a,KAAKg/C,UACNh/C,KAAK42C,QAAQp8B,GACbxa,KAAKiP,YACA,CACL,MAAMnF,EAAU9J,KAAK42C,QAAQp8B,GAE1B1Q,aAAmB3G,QACpBnD,KAAKi/C,gBAAgBn1C,QACDE,IAAZF,GACR9J,KAAKiP,YAMNgwC,gBAAgBn1C,GACrB,MAAMo1C,GAAe,QAAgBl/C,KAAK8Z,QAAS,cAEnDhQ,EAAQpI,MAAK,KACX1B,KAAKiP,WACJ,KACDiwC,OAIG/vC,KAAKvQ,GAQV,MAAMugD,EAAMt/C,MAAMsP,OAElBnP,KAAK4P,SAAShR,EAAQkQ,OACtB9O,KAAKuxC,SAAW3yC,EAAQqB,KACxBD,KAAK42C,QAAUh4C,EAAQg4C,QACvB52C,KAAKg/C,UAAYpgD,EAAQogD,UAEzB,MAAMI,EAA8B,YAAlBp/C,KAAKuxC,SAsBvB,OArBAvxC,KAAKg6B,SAAW,IAAIgX,GAAe,CACjCqC,SAAUrzC,KAAK+O,QACf7C,SAAUlM,KAAKg/C,UAAY,KAAQr+C,IACjCX,KAAK8Z,QAAQ1a,UAAUoE,OAAO,eAAgB7C,IAEhD4wC,SAAU,CAAC6N,EAAY,UAAY,YACnCrxC,YAAanP,EAAQmP,YACrB0jC,WAAY2N,EACZhN,iBAAkBgN,EAAY,CAAC,aAAc,eAAYp1C,EACzD2I,SAAU3S,KAAK2S,WAGd/T,EAAQygD,iBACTr/C,KAAKg6B,SAASgc,WAAWp3C,EAAQygD,iBAGnCr/C,KAAK8Z,QAAQ1a,UAAUC,IAAI,oBAC3BW,KAAK8Z,QAAQxV,UAAY,GACzBtE,KAAK8Z,QAAQva,UAAW,EACxBS,KAAK8Z,QAAQ1a,UAAUoE,OAAO,aAAcxD,KAAKg/C,WAE1CG,G,eCxFI,SAASG,GAAiBC,GACvC,MAAMh2C,EAAOzK,SAASC,cAAc,QAGpC,OAFAwK,EAAKnK,UAAUC,IAAI,eACnB,QAAMkK,EAAMg2C,EAAS,cAAgB,eAC9Bh2C,ECMM,SAAei2C,GAAmBjzC,G,mDAC/C,MAAM0tB,EAAsB,GACtBsa,QAA0B,qCAA2ChoC,GAa3E,OAZiC,QAA7B,EAAAgoC,MAAAA,OAAI,EAAJA,EAAuB/7B,cAAM,eAAEinC,WACjCxlB,EAASpoB,KChBE,WACb,MAAMiqB,EAAMh9B,SAASs9B,gBAAgB,6BAA8B,OACnEN,EAAInV,eAAe,KAAM,UAAW,aACpCmV,EAAInV,eAAe,KAAM,QAAS,MAClCmV,EAAInV,eAAe,KAAM,SAAU,MACnCmV,EAAI18B,UAAUC,IAAI,iBAElB,MAAMqgD,EAAM5gD,SAASs9B,gBAAgB,6BAA8B,OACnEsjB,EAAI/4B,eAAe,KAAM,OAAQ,wBACjC+4B,EAAItgD,UAAUC,IAAI,uBAElB,MAAMsgD,EAAO7gD,SAASs9B,gBAAgB,6BAA8B,OAMpE,OALAujB,EAAKh5B,eAAe,KAAM,OAAQ,mBAClCg5B,EAAKvgD,UAAUC,IAAI,kBAEnBy8B,EAAIp8B,OAAOggD,EAAKC,GAET7jB,EDDS8jB,KAGZrL,EAAsB/7B,OAAOqnC,MAAStL,EAAmB/7B,OAAOsnC,OAClE7lB,EAASpoB,KAAKytC,GAAkB/K,EAAmB/7B,OAAOsnC,OAOrD7lB,G,6SEfT,MAAM8lB,GAAiB,CAAC,UAAW,UAAW,UAAW,UAAW,UAAW,UAAW,UAAW,WAC/FC,GAAe,CAAC,MAAO,QAAS,SAAU,OAAQ,SAAU,OAAQ,OAAQ,UAC5EC,GAAkB,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAE5B,SAASC,GAAiB3zC,EAAgB4zC,GAAM,GAC7D,IAAI5zC,EAAQ,MAAO,GAEnB,MAAM8R,EAAM4hC,GAAgBt9C,KAAKoE,KAAKwF,GAAU,GAEhD,OADe4zC,EAAMH,GAAeD,IAAgB1hC,GCZvC,SAAS+hC,GAAgBhvB,EAAaivB,GAAY,GAC/D,IAAIjvB,EAAK,MAAO,GAChB,MAAMkvB,EAAWlvB,EAAI9kB,OAAOo2B,MAAM,KAClC,IAAI4d,EAAS,GAAI,MAAO,GAExB,MAAMj8B,EAAQ,IAAIi8B,EAAS,IAAI,GAE/B,GAAGD,GAAiC,IAApBC,EAAS3/C,OAAc,OAAO,EAAAi4B,GAAA,GAAcvU,GAE5D,MAAMk8B,EAAO,IAAID,EAASA,EAAS3/C,OAAS,IAAI,GAEhD,OAAO,EAAAi4B,GAAA,GAAcvU,EAAQk8B,G,2SCCxB,SAAeC,GACpBn8C,EACAkI,EACAsT,EACA7e,EACAsqB,EAAM,IAAIrE,MACVse,GAAY,G,0CAEZ,MAAMngC,QAAU,uDAA6DmH,EAAQsT,EAAO7e,GACtFI,EAAcgE,EAAEkK,OAChB2c,EAAS7mB,EAAE6mB,OAIjB,IAAIw0B,EACA37C,EACAyiB,EACJ,GALA+D,EAAIlsB,UAAUC,IAAI,gBAKf4sB,EAEDnnB,EAAW,MACT,EAAA8I,EAAA,GAAevJ,EAAKinB,GACpBjnB,EAAIuD,QAAQ0gB,MAAQ,QAEjB,CACL,MAAM7X,EAAU,+BACbA,GACD6a,EAAIlsB,UAAUC,IAAI,WAGpB,IAAIqhD,GAAe,EACnB,GAAY,cAAT1/C,EAAsB,CACvB,MAAM8L,QAAY0zC,GAAUn8C,EAAKkI,EAAQsT,EAAO,eAChD4gC,EAAqB3zC,EAAI1L,YACzBmmB,EAAaza,EAAIya,gBACZ,GAAG1H,EAAM8gC,eAAgB,CAC9Bp5B,EAAa,IAAIN,MACjB5iB,EAAIjF,UAAUC,IAAI,mBAClBkoB,EAAWnoB,UAAUC,IAAI,eAAgB,0BACzC,MAAMinB,EAAMgG,GAAuBzM,EAAM8gC,gBACzCF,EAAqBv5B,GAA0BK,EAAYjB,GAAK5kB,MAAK,KAChEg/C,IAIH,EAAA9yC,EAAA,GAAevJ,EAAKkjB,MAIxBziB,EAAW,KACT47C,GAAe,EAEZn5B,EACDljB,EAAI3E,OAAO4rB,IAEX,EAAA1d,EAAA,GAAevJ,EAAKinB,GAGtBllB,YAAW,KACN/B,EAAI4G,mBACLzB,GAAA,gBAA4B8hB,GAAK,KAC/BjnB,EAAIuD,QAAQ0gB,MAAQ,GAEjB7X,GACD6a,EAAIlsB,UAAUkB,OAAO,WAGpBinB,GACDA,EAAWjnB,cAIhBmQ,EAAU,IAAM,IAIvB,MAAM6f,EAAgBlvB,EACrBM,MAAM4kB,GAAQY,GAA0BoE,EAAKhF,KAC7C5kB,KAAKoD,GAIN,aAFO27C,GAAsBnwB,EAEtB,CACLrE,OAAAA,EACA7qB,YAAaq/C,GAAsBnwB,EACnC/I,WAAAA,MAIJ,SAAS,GACPljB,EACAC,EACAgkB,EACArpB,IAEA,EAAA05B,EAAA,GAAat0B,EAAKC,GAClBD,EAAIuD,QAAQ0gB,MAAQA,EACpBjkB,EAAIjF,UAAUkB,OAAO,cAAe,uBAAwB,sBAC5DrB,GAAQoF,EAAIjF,UAAUC,IAAIJ,GAIb,SAAe2hD,GAC5Bv8C,EACAkI,EACAghC,GAAW,EACXz+B,EAAQ,GACRy2B,GAAY,EACZsb,G,0CAEA,MAAMC,EAAO,SAEb,GAAGv0C,IAAWu0C,GAAQvT,EAEpB,YADA,GAAIlpC,EAAK,GAAI,GAAI,eAInB,MAAMsO,EAAW,aAEjB,GAAGpG,IAAW,OAAgBA,EAAO46B,SAAU,CAC7C,MAAM5uB,QAAa5F,EAAS2I,gBAAgBC,QAAQhP,GACpD,GAAGgM,GAAQA,EAAKC,QAAUD,EAAKC,OAAOg6B,QAEpC,YADA,GAAInuC,EAAK,GAAI67C,GAAiB3zC,GAAS,wBAK3C,MAAMvL,EAAsB6/C,EAAQ,YAAc,cAC5ChhC,QAAclN,EAAS2/B,gBAAgByO,aAAax0C,GACpDy0C,IAAoBnhC,EACpBohC,IAAmB58C,EAAI0kB,oBAAuB1kB,EAAI0kB,kBAAkC3pB,UAAUiG,SAAS,SAC7G,IAAI27C,IAAoBC,WAA0BtuC,EAASuuC,kBAAkBC,eAAe50C,EAAQvL,IAAQ,CAC1G,IAAIsnB,EAAQ,GAKZ,IAJG/b,GAAWA,IAAWu0C,GAASvT,IAChCjlB,EAAQ43B,GAAiB3zC,IAGxBA,IAAW,MAEZ,YADA,GAAIlI,EAAK,GAAIikB,EAAO,sBAItB,MAAM84B,QAActyC,EAAQsxC,GAAgBtxC,GCvJjC,SAA+BvC,EAAgBoG,EAAW,c,mDACvE,MAAM4hC,QAA0B5hC,EAAS2/B,gBAAgBC,QAAQhmC,GACjE,OAAO6zC,GACoB,QAAxB,EAAA7L,EAAmBzlC,aAAK,QAAI,CAAEylC,EAAmBwJ,WAAaxJ,EAAmByJ,WAAWryB,OAAO6kB,SAAS7sB,KAAK,O,mRDoJ7D09B,CAAgB90C,EAAQoG,GAC7E,GAAItO,EAAK+8C,EAAM94B,EAAO,IAIxB,OAAG04B,EACeR,GAAUn8C,EAAKkI,EAAQsT,EAAO7e,OAAMgJ,EAAWu7B,QADjE,KExJF,MAAM+b,WAA8B,IAOlC1hD,cACEC,QAoBM,KAAAw0B,YAAeh0B,IACrB,IAAImG,EAAOxG,KAAKuhD,WAAW96C,yBACvB,QAAClB,EAAO,QAAEC,GAAWnF,EAErBmhD,EAAQj8C,GAAWiB,EAAK8+B,MAAQ//B,EAAUiB,EAAK8+B,MAAQ9+B,EAAKG,KAAOpB,EACnEk8C,EAAQj8C,GAAWgB,EAAK8vB,OAAS9wB,EAAUgB,EAAK8vB,OAAS9vB,EAAKK,IAAMrB,GAErEg8C,GAAS,KAAOC,GAAS,MAC1BzhD,KAAK0hD,gBAMD,KAAA15B,QAAW3nB,IAEjBL,KAAK0hD,gBAWA,KAAAA,aAAe,KACjB1hD,KAAKuhD,aACNvhD,KAAKuhD,WAAWniD,UAAUkB,OAAO,UACjCN,KAAKuhD,WAAW39C,cAAcxE,UAAUkB,OAAO,aAE5CN,KAAK2hD,aAAa3hD,KAAK2hD,YAAYrhD,SACtCN,KAAKuhD,gBAAav3C,EAElBhK,KAAKgQ,cAAc,UAAU,IAG5BhQ,KAAK4hD,oBACN5hD,KAAK4hD,oBACL5hD,KAAK4hD,uBAAoB53C,GAGvB,OACFlE,OAAOO,oBAAoB,YAAarG,KAAKq0B,aAE7CvuB,OAAOO,oBAAoB,cAAerG,KAAKgoB,UAGjDlpB,SAASuH,oBAAoB,KAAkBrG,KAAKgoB,SAEhD,GAAA65B,kBACFvxC,EAAA,eAAqC,SAtEvC+e,EAAA,mBAA4B,UAAU,KACjCrvB,KAAKuhD,YACNvhD,KAAK0hD,kBAYJI,WACL,QAAS9hD,KAAKuhD,WA2DTQ,YAAYC,EAA0BzvC,GAC3CvS,KAAK0hD,eAED,GAAAG,kBACFvxC,EAAA,WAAiC,CAC/BrQ,KAAM,OACN0R,MAAQC,IACN5R,KAAK0hD,kBAKX1hD,KAAKuhD,WAAaS,EAClBhiD,KAAKuhD,WAAWniD,UAAUC,IAAI,UAC9BW,KAAKuhD,WAAW39C,cAAcxE,UAAUC,IAAI,aAExCW,KAAK2hD,cACP3hD,KAAK2hD,YAAc7iD,SAASC,cAAc,OAC1CiB,KAAK2hD,YAAYviD,UAAUC,IAAI,oBAG/BW,KAAK2hD,YAAYvhD,iBAAiB,MAAmBC,KACnD,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKgoB,QAAQ3nB,OAIjBL,KAAKuhD,WAAW39C,cAAcE,aAAa9D,KAAK2hD,YAAa3hD,KAAKuhD,YAIlEvhD,KAAK4hD,kBAAoBrvC,EAErB,OACFzM,OAAO1F,iBAAiB,YAAaJ,KAAKq0B,aAE1CvuB,OAAO1F,iBAAiB,cAAeJ,KAAKgoB,QAAS,CAACxgB,MAAM,KAU9D1I,SAASsB,iBAAiB,KAAkBJ,KAAKgoB,SAEjDhoB,KAAKgQ,cAAc,UAAU,IAIjC,MACA,GAD8B,IAAIsxC,GC3IlC,MAAMW,GAAY5hD,GACRA,EAAiBkH,QAAWlH,EAAiBkH,QAAQ,GAAKlH,EAG9D6hD,GAAyBp8C,OAE/B,IAAIq8C,IAAe,EACnB,oBAAuC,UAAWjlC,IAChDilC,GAAejlC,KAcF,MAAMklC,GAenBxiD,YAAYhB,GATJ,KAAAyjD,OAA6M,WAC7M,KAAAp6B,aAAc,EACd,KAAAq6B,iBAAqD,EAGrD,KAAAC,SAAU,EACV,KAAAC,MAAgB,KAChB,KAAAC,MAAgB,KAsCxB,KAAAt2C,MAAS9L,IAKJ,KACD6hD,GAAuB77C,oBAAoB,YAAarG,KAAK0iD,WAAY,CAACpvB,SAAS,KAEnF4uB,GAAuB77C,oBAAoB,YAAarG,KAAK0iD,YAC7D1iD,KAAK2iD,YAAY1/C,MAAMo/C,OAAS,IAG/BriD,KAAK4iD,SAAW5iD,KAAKuiD,SACtBviD,KAAK4iD,UAGP5iD,KAAKwiD,MAAQxiD,KAAKyiD,MAAQ,KAC1BziD,KAAKuiD,SAAU,GAGjB,KAAAM,YAAoBC,IAAgC,O,EAAA,K,OAAA,E,EAAA,YAClD,MAAMziD,EAAI4hD,GAASa,GACnB,GAAG9iD,KAAK+iD,2BAA6B/iD,KAAK+iD,kBAAkBD,IAC1D,OAAO9iD,KAAKmM,QAGdnM,KAAKwiD,MAAQniD,EAAEkF,QACfvF,KAAKyiD,MAAQpiD,EAAEmF,QAEZ,KACD08C,GAAuB9hD,iBAAiB,YAAaJ,KAAK0iD,WAAY,CAAC/6C,SAAS,EAAO2rB,SAAS,IAEhG4uB,GAAuB9hD,iBAAiB,YAAaJ,KAAK0iD,YAAY,I,YAZtB,K,+QAgBpD,KAAAA,WAAcI,IACZ,GAAkB,OAAf9iD,KAAKwiD,OAAiC,OAAfxiD,KAAKyiD,OAAkBN,GAE/C,YADAniD,KAAKmM,QAIJnM,KAAKioB,cACN,EAAAA,EAAA,GAAY66B,GAGd,MAAMziD,EAAI4hD,GAASa,GACbE,EAAM3iD,EAAEkF,QACR09C,EAAM5iD,EAAEmF,QAER09C,EAAQljD,KAAKwiD,MAAQQ,EACrBG,EAAQnjD,KAAKyiD,MAAQQ,EAE3B,IAAIjjD,KAAKuiD,QAAS,CAChB,IAAIW,IAAUC,EACZ,OAGFnjD,KAAKuiD,SAAU,EAEX,MACFviD,KAAK2iD,YAAY1/C,MAAMmgD,YAAY,SAAUpjD,KAAKqiD,OAAQ,aAGzDriD,KAAKqjD,cACNrjD,KAAKqjD,eAmBT,MAAMC,EAAgBtjD,KAAKujD,QAAQL,EAAOC,EAAOL,QAC5B94C,IAAlBs5C,GAA+BA,GAChCtjD,KAAKmM,UAzHP,EAAA6E,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAK2iD,YAAc3iD,KAAKoK,QAExBpK,KAAKg2B,eAGAA,eACD,MAIFh2B,KAAKoK,QAAQhK,iBAAiB,aAAcJ,KAAK6iD,YAAa7iD,KAAKsiD,iBACnEJ,GAAuB9hD,iBAAiB,WAAYJ,KAAKmM,SAJzDnM,KAAKoK,QAAQhK,iBAAiB,YAAaJ,KAAK6iD,YAAa7iD,KAAKsiD,iBAClEJ,GAAuB9hD,iBAAiB,UAAWJ,KAAKmM,QAOrDoqB,kBACD,MAIFv2B,KAAKoK,QAAQ/D,oBAAoB,aAAcrG,KAAK6iD,YAAa7iD,KAAKsiD,iBACtEJ,GAAuB77C,oBAAoB,WAAYrG,KAAKmM,SAJ5DnM,KAAKoK,QAAQ/D,oBAAoB,YAAarG,KAAK6iD,YAAa7iD,KAAKsiD,iBACrEJ,GAAuB77C,oBAAoB,UAAWrG,KAAKmM,QAOxDq3C,UAAUnB,GACfriD,KAAKqiD,OAASA,GAEV,MAAsBriD,KAAKuiD,SAC7BviD,KAAK2iD,YAAY1/C,MAAMmgD,YAAY,SAAUpjD,KAAKqiD,OAAQ,c,2SCrDjD,MAAMoB,GAkBnB7jD,YACSkM,EACC6G,GADD,KAAA7G,WAAAA,EACC,KAAA6G,SAAAA,EAySH,KAAA+M,YAAoBgkC,GAAwD,mCACjF,MAAMC,EAAS7kD,SAASC,cAAc,OAKtC,IAAI8gB,EAJJ8jC,EAAOvkD,UAAUC,IAAIokD,GAAmBG,WAAa,UAAW,kBAAmB,QAEnF5jD,KAAK6jD,QAAQnkD,OAAOikD,GAGjBD,IACD7jC,EAA4B,iBAAd,QACN7f,KAAK2S,SAASmxC,iBAAiBC,SAASL,GAC7CA,EAAQM,OAAuDnkC,OAGpE,MAAMyL,EAAM,IAAIrE,MAChBqE,EAAIlsB,UAAUC,IAAI,gBAClBisB,EAAI24B,WAAY,EAEhB,MAAMC,EAAe,IAAW,mCAC9B,GAAGrkC,EAAO,CACR,MAAM/S,QAAYwhB,GAAU,CAC1BptB,UAAWyiD,EACX9jC,MAAAA,EACA7e,KAAM4e,GAAgBC,EAAO,IAAK,KAAK,GACvC8O,kBAAkB,IAGpB,CAAC7hB,EAAIqiB,OAAOlC,MAAOngB,EAAIqiB,OAAOD,MAAMvD,OAAO6kB,SAASpjC,SAASke,IAC3DA,EAAIlsB,UAAUC,IAAI,uBAEf,CACL,MAAMwgB,QAAc7f,KAAK2S,SAAS2/B,gBAAgByO,aAAa/gD,KAAKuM,cAC9Di0C,GAAUmD,EAAQ3jD,KAAKuM,OAAQsT,EAAO,YAAayL,GAG3Dq4B,EAAOvkD,UAAUkB,OAAO,WAY1B,OATGN,KAAK6jD,QAAQ54C,mBApWC,QAqWTi5C,KAENlkD,KAAKmkD,qBAAqBxmC,QAAQgmC,GAClC3jD,KAAKokD,cAAcnnC,IAAI0mC,EAAQO,IAGjClkD,KAAKgP,SAEE00C,KArVP1jD,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAIokD,GAAmBG,WAAa,cAE7D5jD,KAAK6jD,QAAU/kD,SAASC,cAAc,OACtCiB,KAAK6jD,QAAQzkD,UAAUC,IAAIokD,GAAmBG,WAAa,YAE3D5jD,KAAKqkD,SAAWvlD,SAASC,cAAc,OACvCiB,KAAKqkD,SAASjlD,UAAUC,IAAIokD,GAAmBG,WAAa,aAE5D5jD,KAAK63C,KAAO/4C,SAASC,cAAc,OACnCiB,KAAK63C,KAAKz4C,UAAUC,IAAIokD,GAAmBG,WAAa,SAExD5jD,KAAKyP,KAAO3Q,SAASC,cAAc,OACnCiB,KAAKyP,KAAKrQ,UAAUC,IAAIokD,GAAmBG,WAAa,SAExD5jD,KAAKskD,cAAgBxlD,SAASC,cAAc,OAC5CiB,KAAKskD,cAAcllD,UAAUC,IAAIokD,GAAmBG,WAAa,SAAU,wBAM3E5jD,KAAKukD,UAAYzlD,SAASC,cAAc,OACxCiB,KAAKukD,UAAUnlD,UAAUC,IAAIokD,GAAmBG,WAAa,SAAUH,GAAmBG,WAAa,cAAe,oBAMtH5jD,KAAKkB,UAAUxB,OAAOM,KAAK6jD,QAAS7jD,KAAKqkD,SAAUrkD,KAAK63C,KAAM73C,KAAKyP,KAAMzP,KAAKskD,cAAetkD,KAAKukD,WAElGvkD,KAAKokD,cAAgB,IAAInzC,IACzBjR,KAAKiJ,eAAiB,IAAI,IAE1B,MAAMu7C,EAAiB,IACY,IAA9BxkD,KAAK8L,WAAW24C,YACjBzkD,KAAK8L,WAAW8pC,kBAAkB,CAChCxrC,QAASpK,KAAK8L,WAAW5K,UAAU6nB,kBACnC4hB,SAAU,WAEL,GAML+Z,EAAc,EAAI,EACxB,IAAIt8B,GAAS,EACTu8B,GAAS,GACb,QAAiB3kD,KAAKkB,WAAiB4hD,GAAO,mCAC5C,GAAG6B,EAED,YADA,EAAA18B,EAAA,GAAY66B,GAId,GAAG16B,EAED,YADAA,GAAS,GAIX,IAAIo8B,IACF,OAGF,MAAMh+C,EAAOxG,KAAKkB,UAAUuF,wBAItBO,EADI87C,EACEvuB,MAEN7tB,EAASM,EAAIR,EAAKG,KACxB,IAAK3G,KAAK4kD,WAAWC,SAASlkD,SAAWX,KAAK4kD,WAAWnrB,KAAK94B,QACxD+F,EAAUF,EAAKjF,MAAQmjD,GAAgBh+C,EAAUF,EAAKjF,MAAQiF,EAAKjF,MAAQmjD,EAAe,CAC9F,MAAMn4C,EAASvM,KAAKuM,OAEdkR,EAAsF,GAC5Fzd,KAAK4kD,WAAWC,SAASvkC,OAAOtgB,KAAK4kD,WAAWE,QAAS9kD,KAAK4kD,WAAWnrB,MAAMrsB,SAAQ,CAAC2R,EAAMV,KAC5FZ,EAAQ5L,KAAK,CACXzH,QAAmBpK,KAAK6jD,QAAQ/9B,SAASzH,GACzCU,KAAAA,OAIJ,MAAMgmC,EAActnC,EAAQ/c,MAAM,EAAGV,KAAK4kD,WAAWC,SAASlkD,QACxDqkD,EAAcvnC,EAAQ/c,MAAMV,KAAK4kD,WAAWC,SAASlkD,OAAS,GAE9DwG,EAASnH,KAAK6jD,QAAQ/9B,SAAS9lB,KAAK4kD,WAAWC,SAASlkD,QAC9DgkD,GAAS,EACTM,GAAiB99C,EAAQoF,GAAQ,IAAMA,IAAWvM,KAAKuM,QAAQvM,KAAK4kD,WAAWE,QAASC,EAAaC,GACrGL,GAAS,MACJ,CACL,MACMO,EAAUl+C,EADAR,EAAK8+B,MAAS9+B,EAAKjF,MAAQ,EAQzC,IAAI4V,EAHJnX,KAAK6jD,QAAQzkD,UAAUC,IAAI,iBACtBW,KAAK6jD,QAAQsB,WAIwDhuC,EAD7C,IAA1BnX,KAAK4kD,WAAWt/B,OAAgB4/B,EAC3BllD,KAAK4kD,WAAWt/B,QAAWtlB,KAAK4kD,WAAW73C,MAAQ,GAAMm4C,IAAsBllD,KAAK4kD,WAAW73C,MAAQ,GAC/Fm4C,EAAU,GAAK,EAFwBllD,KAAK4kD,WAAW73C,MAAQ,EAG/E/M,KAAK4kD,WAAWQ,GAAGjuC,IAEnB,UAAQ,KACNnX,KAAK6jD,QAAQzkD,UAAUkB,OAAO,yBAInC,CAAC2I,eAAgBjJ,KAAKiJ,iBAEzB,MAAMo8C,EAAkB,KACtBj9B,GAAS,EACTtpB,SAAS8rC,KAAKxqC,iBAAiB,KAAqB,WAAa,SAAUC,IACzE+nB,GAAS,IACR,CAAC5gB,MAAM,KAGZ,IAAIjG,EAAQ,EAAGyF,EAAI,EAAGs+C,EAAY,EAAkBC,EAAO,EACtCvlD,KAAKwlD,aAAe,IAAIpD,GAAa,CACxDh4C,QAASpK,KAAK6jD,QACdN,QAAS,CAACL,EAAOC,KACfmC,EAAYpC,EACZ,IAAIuC,EAAQz+C,EAAIk8C,GAASO,GAAmBiC,MAM5C,OALGD,EAAQ,EAAGA,EAAQ,EACdA,EAAQF,IAAME,EAAQF,GAE9BvlD,KAAK6jD,QAAQ5gD,MAAMkzB,UAAYstB,GAAmBkC,mBAAmBllD,QAAQ,MAAOglD,EAAQ,OAErF,GAET1C,kBAAoB1iD,GACdmkD,KAIMxkD,KAAKkB,UAAU9B,UAAUiG,SAAS,eAAgBs/C,GAH1DU,KACA,EAAAp9B,EAAA,GAAY5nB,IACL,GAOXgjD,aAAc,KACZ,MAAM78C,EAAOxG,KAAK6jD,QAAQp9C,wBAC1BlF,EAAQiF,EAAKjF,MACbgkD,GAAQhkD,GAASvB,KAAKyP,KAAKxE,kBAAoB,GAI/CjE,EAAIR,EAAKG,KAAO3G,KAAKkB,UAAUuF,wBAAwBE,KAEvD3G,KAAK6jD,QAAQ5gD,MAAMkzB,UAAYstB,GAAmBkC,mBAAmBllD,QAAQ,MAAOuG,EAAI,MAExFhH,KAAKkB,UAAU9B,UAAUC,IAAI,cAC7BW,KAAK6jD,QAAQzkD,UAAUC,IAAI,iBACtBW,KAAK6jD,QAAQsB,YAEpBvC,QAAS,KACP,MAAMgD,EAAWjjD,KAAKoR,KAAKpR,KAAKoE,IAAIu+C,IAAc/jD,EAAQkiD,GAAmBiC,SAAWJ,GAAa,EAAI,GAAK,GAC9GD,IAIArlD,KAAK6jD,QAAQzkD,UAAUkB,OAAO,kBAC9B,UAAQ,KACNN,KAAK4kD,WAAWQ,GAAGQ,GACnB5lD,KAAKkB,UAAU9B,UAAUkB,OAAO,oBAKtCN,KAAKmkD,qBAAuB,IAAIvnC,sBAAsBC,IACpDA,EAAQzP,SAAS2P,IACXA,EAAMC,gBAIVhd,KAAK6lD,oBAAoB9oC,EAAM5V,cAmBxB2+C,QAAQv5C,G,0CACnBvM,KAAKuM,OAASA,EAEd,MAAMsT,QAAc7f,KAAK2S,SAAS2/B,gBAAgByO,aAAax0C,GAC/D,IAAIsT,EACF,OAGF,MAAM+kC,EAA+C5kD,KAAK4kD,WAAa,IAAI,KAAW,CACpFmB,UAAW,GACXC,SAAU,CAAC1sB,EAAQ2sB,EAAOF,KACxB,IAAIE,EAAO,OAAO9iD,QAAQ4B,QAAQ,CAACgI,WAAO/C,EAAWyS,MAAO,KAE5D,GAAGlQ,EAAO46B,SAAU,CAClB,MAAMz6B,EAA2B4sB,EACjC,OAAOt5B,KAAK2S,SAASmxC,iBAAiBoC,cAAc35C,EAAQG,EAAOq5C,GAAWrkD,MAAMlB,IAC3E,CACLuM,MAAOvM,EAAMuM,MACb0P,MAAOjc,EAAM2lD,WAGZ,CACL,MAAM18C,EAAwF,GAe9F,OAdIm7C,EAAWE,SACbr7C,EAASoI,KAAK7R,KAAK2S,SAASq8B,kBAAkBqL,YAAY9tC,EAAO8hB,aAGnE5kB,EAASoI,KAAK7R,KAAK2S,SAAS40B,mBAAmB6e,UAAU,CACvD75C,OAAAA,EACAG,MAAO25C,OAAOC,iBACd35C,YAAa,CACXC,EAAG,iCAELC,MAAOk5C,EACPQ,UAAW,KAGNpjD,QAAQC,IAAIqG,GAAU/H,MAAW4N,GAAW,mCACjD,MAAM9O,EAAQ8O,EAAOsB,MAIrB,IAFA,EAAA41C,GAAA,GAAyBhmD,IAErBokD,EAAWE,QAAS,CACtB,MAAMnW,EAAWr/B,EAAO,GAClBjC,GAAU,EAAAoS,GAAA,GAAcjf,EAAMwM,SAAUK,GACnCA,EAAmC22C,OAAuDnkC,MAAMrP,KAAOm+B,EAAS8X,WAAWj2C,KAGtIo0C,EAAWE,QAAUz3C,UAAiBrN,KAAK2S,SAAS40B,mBAAmBmf,0BAA0B1mD,KAAKuM,OAAQoiC,EAAS8X,aAIzH,MAAO,CACL15C,MAAOvM,EAAMuM,MACb0P,MAAOjc,EAAMwM,gBAKrB0S,YAAa1f,KAAK0f,YAClBinC,OAAQ,CAAC5nC,EAAMknC,KACb,MAAMz1C,EAAKxQ,KAAK4kD,WAAWt/B,MAErBte,EAAI,IAAMy8C,GAAmBiC,MAAQl1C,EAC3CxQ,KAAK6jD,QAAQ5gD,MAAMkzB,UAAYstB,GAAmBkC,mBAAmBllD,QAAQ,MAAO,IAAIuG,MAExF,MAAM4/C,EAAY5mD,KAAKyP,KAAKvK,cAAc,WACvC0hD,GAAWA,EAAUxnD,UAAUkB,OAAO,UAE7BN,KAAKyP,KAAKqW,SAAStV,GAC3BpR,UAAUC,IAAI,UAElBW,KAAK6lD,oBAAoB7lD,KAAK6jD,QAAQ/9B,SAAStV,OAIpC,qBAAZqP,EAAMjT,IACPg4C,EAAWE,QAAUjlC,EAAMgnC,gBAGvB7mD,KAAK0f,YAAYklC,EAAWE,SAGlCF,EAAWzjD,MAAK,MAGX6N,SACL,MAAM8B,EAAMhS,SAASC,cAAc,OACnC+R,EAAI1R,UAAUC,IAAIokD,GAAmBG,WAAa,QAClD5jD,KAAKyP,KAAK/P,OAAOoR,GAEkB,IAAhC9Q,KAAKyP,KAAKxE,mBACX6F,EAAI1R,UAAUC,IAAI,UAGpBW,KAAKkB,UAAU9B,UAAUoE,OAAO,YAAaxD,KAAKyP,KAAKxE,mBAAqB,GAoDtE46C,oBAAoB1+C,GAC1B,MAAM2e,EAAW1U,MAAMC,KAAKlK,EAAOvD,cAAckiB,UAC3CzH,EAAMyH,EAAStP,QAAQrP,GACf2e,EAASplB,MAAMiC,KAAKH,IAAI,EAAG6b,EAnXxB,GAmX6C1b,KAAKC,IAAIkjB,EAASnlB,OAAQ0d,EAnXvE,IAqXXjR,SAASjG,IACb,MAAMrC,EAAW9E,KAAKokD,cAAc5yC,IAAIrK,GACrCrC,IACDA,IACA9E,KAAKokD,cAAc10C,OAAOvI,GAC1BnH,KAAKmkD,qBAAqBtmC,UAAU1W,OAKnC8I,UACLjQ,KAAKiJ,eAAe0G,YACpB3P,KAAKwlD,aAAajvB,mBA9XL,GAAAqtB,WAAa,kBACb,GAAA8B,MAAQ,KAAwB,EAAI,EACpC,GAAAC,mBAAqB,KAAwB,mCAAmClC,GAAmBiC,SAAW,oBCtBhH,SAAeoB,GAAcloD,G,qCAC1C,MAAMw5B,EAAY,IAAIE,GAEtB,aADMF,EAAUC,OAAOz5B,GAChBw5B,EAAUhuB,S,0kBCmBnB,IAAI28C,GAAU,CAACtnD,EAA0C8lB,MAErD,EAAAoT,EAAA,GAAapT,EAAIzW,MAAOrP,GAAQ,IAChC8lB,EAAIrkB,UAAU+B,MAAMC,QAAUzD,EAAO,GAAK,QAI/B,MAAMunD,GAqBnBpnD,YACU+S,EACD7G,EACC7C,EACAskC,GAAW,GAHX,KAAA56B,SAAAA,EACD,KAAA7G,WAAAA,EACC,KAAA7C,eAAAA,EACA,KAAAskC,SAAAA,EAiLF,KAAA0Z,cAAgB,CAACC,GAAY,KACnC,MAAM36C,EAASvM,KAAKuM,OAEpB,GADAvM,KAAKoK,QAAQhL,UAAUoE,OAAO,QAAS+I,IAAW,UAC9CA,IAAW,WAAmBA,IAAUvM,KAAKutC,UAEjD,OAAO,iBACLhhC,EACAvM,KAAKypC,SACLyd,GACA,GACA,IAAM36C,IAAWvM,KAAKuM,SACrBvM,KAAKutC,UACN7rC,MAAMoD,IACHA,GACDA,QA7LA,MACF9E,KAAK8L,WAAW5K,UAAU9B,UAAUC,IAAI,eAGtC4J,IACFjJ,KAAKiJ,eAAiB,IAAI,KAIvBoG,OACLrP,KAAKqP,KAAO,KAGZrP,KAAKoK,QAAUtL,SAASC,cAAc,OACtCiB,KAAKoK,QAAQhL,UAAUC,IAAI,mBAE3BW,KAAKmZ,QAAU,IAAIC,GAAe,CAChCg2B,aAAa,IAGfpvC,KAAK2jD,OAAS,IAAIrW,GAClBttC,KAAK2jD,OAAOvkD,UAAUC,IAAI,iBAAkB,cAC5CW,KAAK2jD,OAAOpW,SAAWvtC,KAAKutC,SAC5BvtC,KAAK2jD,OAAO36C,mBAEZhJ,KAAKyD,KAAO3E,SAASC,cAAc,OACnCiB,KAAKyD,KAAKrE,UAAUC,IAAI,gBAExBW,KAAKypC,SAAW3qC,SAASC,cAAc,OACvCiB,KAAKypC,SAASrqC,UAAUC,IAAI,oBAE5BW,KAAKmnD,IAAM,IAAI9d,GAAI,CACjBv6B,MAAO,IACP46B,gBAAiB,UACjBzqC,KAAM,OACNyL,UAAiBrK,GAAM,mCACoB,MAArCA,EAAE8G,OAAuBE,UAK7BkjC,UADmBvqC,KAAK2S,SAASq8B,kBAAkBoY,mBAAmBpnD,KAAKuM,SAClD0N,OACzB0xB,GAAM,YAAY,aAAa,UAInC3rC,KAAKmnD,IAAIr4C,MAAM1P,UAAUC,IAAI,YAE7BW,KAAKgsC,SAAW,IAAI3C,GAAI,CACtBv6B,MAAO,IACP46B,gBAAiB,WACjBzqC,KAAM,WACNyL,UAAW,IAAW,mCAEpB6/B,GAAoB,WADoBvqC,KAAK2S,SAAS2/B,gBAAgBC,QAAQvyC,KAAKuM,SACpDy/B,UAC/BL,GAAM,YAAY,kBAAkB,SAIxC3rC,KAAKs9C,MAAQ,IAAIjU,GAAI,CACnBv6B,MAAO,IACP46B,gBAAiB,QACjBzqC,KAAM,QACNyL,UAAW,IAAW,mCAEpB6/B,GAAoB,WADKvqC,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKuM,SACrC+wC,OAC/B3R,GAAM,YAAY,eAAe,SAIrC3rC,KAAK6uC,KAAO,IAAIxF,GAAI,CAClBv6B,MAAO,IACP46B,gBAAiB,oBACjBzqC,KAAM,OACNyL,UAAW,KACT6/B,GAAoBvqC,KAAK6uC,KAAK//B,MAAM6jB,aAGlCgZ,GAAM,YAAY,cAAc,OAKtC3rC,KAAK2b,SAAW,IAAI0tB,GAAI,CACtBv6B,MAAO,IACP46B,gBAAiB,eACjBzqC,KAAM,aAGRe,KAAKmZ,QAAQpK,QAAQrP,OACnBM,KAAKs9C,MAAMp8C,UACXlB,KAAKgsC,SAAS9qC,UACdlB,KAAK2b,SAASza,UACdlB,KAAKmnD,IAAIjmD,UACTlB,KAAK6uC,KAAK3tC,WAGZ,MAAM,eAAC+H,GAAkBjJ,KACtBA,KAAKutC,WACNvtC,KAAKqnD,cAAgB,IAAIhe,GAAI,CAC3BG,cAAe,IAAI,KAAc,CAAChmC,QAAQ,IAC1CwmC,aAAc,gBACd/qC,KAAM,WAGRgK,EAAe5J,IAAIW,KAAKqnD,cAAc7d,cAAczpC,MAApDkJ,CAA2D,UAAW5I,IAChEA,EAAEkjC,WAKNvjC,KAAK2S,SAAS40B,mBAAmB2W,eAAel+C,KAAKuM,WAGvDtD,EAAe5J,IAAI,IAAnB4J,CAA8B,0BAAgCuvB,GAAW,mCACvE,GAAGx4B,KAAKuM,SAAWisB,EAAOjsB,OAAQ,CAChC,MAAMq0B,QAAc5gC,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKuM,QAAQ,GACxFvM,KAAKqnD,cAAc7d,cAAcJ,SAAWxI,QAIhD5gC,KAAKmZ,QAAQpK,QAAQrP,OAAOM,KAAKqnD,cAAcnmD,YAGjDlB,KAAKoK,QAAQ1K,OAAOM,KAAKmZ,QAAQjY,WAE9B,MACDlB,KAAKoK,QAAQ1K,OAAO0zC,MAGtBnqC,EAAe5J,IAAI,IAAnB4J,CAA8B,gBAAgB,EAAEsD,OAAAA,MAC3CvM,KAAKuM,SAAWA,GACjBvM,KAAKinD,mBAITh+C,EAAe5J,IAAI,IAAnB4J,CAA8B,iBAAkBsD,IAC3CA,IAAWvM,KAAKuM,QACjBvM,KAAKsnD,gBAAe,MAIxBr+C,EAAe5J,IAAI,IAAnB4J,CAA8B,mBAAoBsD,IAC7CA,IAAWvM,KAAKuM,QACjBvM,KAAKunD,kBAITt+C,EAAe5J,IAAI,IAAnB4J,CAA8B,eAAgBiS,IACzClb,KAAKuM,SAAW2O,EAAOL,YACxB7a,KAAKinD,mBAITh+C,EAAe5J,IAAI,IAAnB4J,CAA8B,mBAAyBiS,GAAW,mCAC7Dlb,KAAKuM,SAAW2O,EAAOL,oBACL7a,KAAK2S,SAAS2I,gBAAgBC,QAAQL,IAChD1C,OAAOgvC,MAASxnD,KAAKutC,UAC5BvtC,KAAKynD,sBAKXx+C,EAAe5J,IAAI,IAAnB4J,CAA8B,iBAAkBsD,IAC3CvM,KAAKuM,SAAWA,GAGfvM,KAAK0nD,eAKX1nD,KAAK2nD,sBAAwB7hD,OAAO8hD,YAAY5nD,KAAKinD,cAAe,KAsB/DY,cACL,CACE7nD,KAAKmnD,IACLnnD,KAAKs9C,MACLt9C,KAAKgsC,SACLhsC,KAAK2b,SACL3b,KAAK6uC,MACLzhC,SAASmY,IACTA,EAAIrkB,UAAU+B,MAAMC,QAAU,UAG7BlD,KAAKqnD,gBACNrnD,KAAKqnD,cAAcnmD,UAAU+B,MAAMC,QAAU,GAC7ClD,KAAKqnD,cAAc7d,cAAcJ,SAAU,GAG7CppC,KAAK8nD,6BAGCC,gBACN,OAAO/nD,KAAKuM,SAAW,WAAmBvM,KAAKutC,SAGnCma,Y,0CACZ,GAAG1nD,KAAK+nD,wBACc/nD,KAAK2S,SAAS2/B,gBAAgByO,aAAa/gD,KAAKuM,SAE1D,CACR,MAAMy7C,EAAahoD,KAAK6jD,QAcxB,OAbA7jD,KAAK6jD,QAAU,IAAIJ,GAAmBzjD,KAAK8L,WAAY9L,KAAK2S,gBACtD3S,KAAK6jD,QAAQiC,QAAQ9lD,KAAKuM,QAChCvM,KAAK6jD,QAAQhM,KAAKn4C,OAAOM,KAAKyD,KAAMzD,KAAKypC,UAEzCzpC,KAAK2jD,OAAOrjD,SAET0nD,EAAYA,EAAW9mD,UAAUu9B,YAAYz+B,KAAK6jD,QAAQ3iD,WACxDlB,KAAKoK,QAAQvG,QAAQ7D,KAAK6jD,QAAQ3iD,gBAEpC,MACDlB,KAAK8L,WAAW5K,UAAU9B,UAAUC,IAAI,aAO3C,MACDW,KAAK8L,WAAW5K,UAAU9B,UAAUkB,OAAO,YAG1CN,KAAK6jD,UACN7jD,KAAK6jD,QAAQ3iD,UAAUZ,SACvBN,KAAK6jD,QAAQ5zC,UACbjQ,KAAK6jD,aAAU75C,SAGXhK,KAAK2jD,OAAO9a,kBAAkB,CAACt8B,OAAQvM,KAAKuM,SAElDvM,KAAKmZ,QAAQpK,QAAQlL,QAAQ7D,KAAK2jD,OAAQ3jD,KAAKyD,KAAMzD,KAAKypC,aAG9C8d,e,0CACZ,MAAM,OAACh7C,GAAUvM,KACjB,GAAGuM,EAAO46B,UAAYnnC,KAAK+nD,gBAAiB,CAC1C,MAAM/b,QAAiBhsC,KAAK2S,SAAS2/B,gBAAgB2V,gBAAgB17C,GACrE,OAAOw6C,GAAQ/a,EAAUhsC,KAAKgsC,cAIpByb,gB,0CACZ,MAAM,OAACl7C,GAAUvM,KACjB,GAAGuM,EAAO46B,UAAYnnC,KAAK+nD,gBAAiB,CAC1C,MAAMxvC,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,GACzD,OAAOw6C,GAAQxuC,EAAK+kC,MAAQD,GAAgB9kC,EAAK+kC,YAAStzC,EAAWhK,KAAKs9C,WAIhE4K,oB,0CACZ,MAAMxJ,EAAmB1+C,KAAKqnD,cAC9B,GAAI3I,EAIJ,GAAG1+C,KAAK+nD,gBAAiB,CACvB,MAAMnnB,QAAc5gC,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKuM,QAAQ,GACxFmyC,EAAiBlV,cAAcJ,SAAWxI,OAE1C,UAAQ,KACN8d,EAAiBx9C,UAAU+B,MAAMC,QAAU,aAKnCilD,W,0CACZ,MAAM57C,EAASvM,KAAKuM,aAEdpJ,QAAQC,IAAI,CAChBpD,KAAKunD,eACLvnD,KAAKynD,gBACLznD,KAAKkoD,oBACLloD,KAAKsnD,iBACL,KAAY,mCACV,MAAOl9C,EAASg+C,SAAejlD,QAAQC,IAAI,CACzC0jD,GAAc,CACZv6C,OAAAA,EACAisB,OAAQx4B,KAAKutC,WAGfiS,GAAmBjzC,MAErB,EAAAqB,EAAA,GAAe5N,KAAKyD,KAAM2G,GAC1BpK,KAAKyD,KAAK/D,UAAU0oD,MAVtB,GAYApoD,KAAKinD,eAAc,QAIVoB,sB,0CACProD,KAAKsoD,UACTtoD,KAAKsoD,SAAU,EAEftoD,KAAK6nD,oBACC1kD,QAAQC,IAAI,CAChBpD,KAAK0nD,YACL1nD,KAAKmoD,iBAIKI,gBAAgBh8C,EAAgBi8C,G,0CAK5C,GAHAzB,GAAQyB,EAASvuC,OAAQ,EAAAwuC,GAAA,GAAaD,EAASvuC,YAASjQ,EAAWhK,KAAKmnD,MAGpE56C,EAAO46B,SAAU,CACnB,MAAM/E,QAA2BpiC,KAAK2S,SAASoH,gBAAgB00B,QAAQliC,EAAO8hB,YAC9E,GAAG+T,EAAK4J,SACN+a,GAAQ,gBAAkB3kB,EAAK4J,SAAUhsC,KAAK6uC,UACzC,CACL,MAAM6Z,EAAkBF,EAAkC5Z,gBACjC,wBAAtB8Z,MAAAA,OAAc,EAAdA,EAAgB97C,IACjBm6C,GAAQ2B,EAAe7Z,KAAM7uC,KAAK6uC,OAKxC,MAAMlzB,EAAY6sC,EAAkC7sC,SAClC,oBAAfA,MAAAA,OAAQ,EAARA,EAAU/O,IACXm6C,GAAQprC,EAASxB,QAASna,KAAK2b,UAGjC3b,KAAK2oD,sBAAwB7iD,OAAOM,YAAW,IAAMpG,KAAKsnD,gBAAe,IAAO,QAGpEA,eAAesB,G,0CAC3B5oD,KAAK8nD,6BAEL,MAAMv7C,EAASvM,KAAKuM,OACdV,EAAW7L,KAAK6L,SAEtB,IAAIU,UAAgBvM,KAAK2S,SAAS2/B,gBAAgBuW,aAAat8C,MAAYvM,KAAK+nD,gBAC9E,OAGF,MAAMz4C,QAAetP,KAAK2S,SAASm2C,aAAa9Z,kBAAkBoY,mBAAmB76C,EAAQq8C,GACvFG,EAAaz5C,EAAOA,OAAO5N,MAAW8mD,GAAa,mCACpDxoD,KAAKuM,SAAWA,GAAUvM,KAAK6L,WAAaA,UAAkB7L,KAAK2S,SAAS2/B,gBAAgBuW,aAAat8C,YAKtGvM,KAAKuoD,gBAAgBh8C,EAAQi8C,SAGlCl5C,EAAO2c,eACF88B,MAIHjD,QAAQv5C,EAAgBV,EAAW,GACrC7L,KAAKuM,SAAWA,GAAUvM,KAAK6L,WAAaA,IAE5C7L,KAAKqP,MACNrP,KAAKqP,OAGPrP,KAAKuM,OAASA,EACdvM,KAAK6L,SAAWA,EAEhB7L,KAAKsoD,SAAU,GAGVR,kCAC6B99C,IAA/BhK,KAAK2oD,wBACNx6C,aAAanO,KAAK2oD,uBAClB3oD,KAAK2oD,2BAAwB3+C,GAI1Bg/C,UACLhpD,KAAK8nD,6BACLmB,cAAcjpD,KAAK2nD,wB,2SCjbvB,MAAMuB,GAIF,GAGW,MAAMC,WAA0B36C,EAW7C5O,YAAY6O,GACV5O,MAAM4O,GAAQ,GARR,KAAA5C,SAAW,EAWZwD,OAGLrP,KAAKkB,UAAU9B,UAAUC,IAAI,yBAA0B,qBAGvD,MAAM+pD,GAAc,OAAO,gCAAiC,CAAClqD,UAAU,IACvEc,KAAK6O,SAAS4vB,YAAY2qB,GAC1BppD,KAAK6O,SAAWu6C,EAEhB,MAAMC,EAAoBvqD,SAASC,cAAc,OACjDsqD,EAAkBjqD,UAAUC,IAAI,uBAChC+pD,EAAY1pD,OAAO2pD,GAEnB,MAAMC,EAAsBxqD,SAASC,cAAc,OACnDuqD,EAAoB3qD,UAAY,wBAEhC,MAAM4qD,EAAsBzqD,SAASC,cAAc,OACnDwqD,EAAoBnqD,UAAUC,IAAI,mBAElCW,KAAK8O,MAAMpP,QAAO,QAAK,YACvBM,KAAKwpD,QAAU,EAAW,QAG1BD,EAAoB7pD,OAAOM,KAAK8O,MAAO9O,KAAKwpD,SAE5C,MAAMC,EAAqB3qD,SAASC,cAAc,OAClD0qD,EAAmBrqD,UAAUC,IAAI,mBAEjC,MAAMqqD,EAA2B1pD,KAAK8O,MAAM/K,YAC5C2lD,EAAYhqD,QAAO,QAAK,yBAExB+pD,EAAmB/pD,OAAOgqD,GAE1BJ,EAAoB5pD,OAAO6pD,EAAqBE,GAEhDzpD,KAAK4O,OAAOlP,OAAO4pD,GAInBtpD,KAAK2pD,QAAU,IAAI3C,GAAYhnD,KAAK2S,SAAU3S,KAAK8L,YACnD9L,KAAK2pD,QAAQt6C,OAEbrP,KAAK8L,WAAWpM,OAAOM,KAAK2pD,QAAQv/C,SAGpCpK,KAAK8L,WAAW89C,mBAAqB,KACnC,MAAMpjD,EAAOxG,KAAK6pD,YAAYC,IAAIrjD,wBAClC,IAAID,EAAKjF,MAAO,OAEhB,MAAMsF,EAAML,EAAKK,IAAM,EACvBkjD,EAAiBljD,GANG,KAStB,MAAMkjD,EAAoBC,IACxBX,EAAkBjqD,UAAUoE,OAAO,aAAcwmD,GACjDhqD,KAAK6pD,YAAY3oD,UAAU9B,UAAUoE,OAAO,mBAAoBwmD,GAChEC,GAAYD,GAERA,GACFhqD,KAAK6pD,YAAYK,wBAIfD,GAAa,OAAiBX,EAAqB,aAAc,IAAK,MAAM,GAElFW,EAAW,IAEX,QAAiBjqD,KAAK6O,UAAWxO,IAC5BL,KAAK6O,SAASka,kBAAkB3pB,UAAUiG,SAAS,eACpDrF,KAAK8L,WAAW8pC,kBAAkB,CAChCxrC,QAASpK,KAAK8L,WAAW5K,UAAU6nB,kBACnC4hB,SAAU,UAEZsf,EAAW,GACXZ,EAAkBjqD,UAAUkB,OAAO,eAC1BN,KAAK8L,WAAWq+C,4BACzBnqD,KAAKyO,OAAO4B,sBAIhB,QAAiBrQ,KAAKwpD,SAAUnpD,IAC9B,IAAIyQ,EAEFA,EADC9Q,KAAKuM,OAAOkpC,YACPz1C,KAAKyO,OAAO+D,UAAUgpC,IAEtBx7C,KAAKyO,OAAO+D,UAAUirC,IAG3B3sC,IACEA,aAAe0qC,GAChB1qC,EAAIuJ,OAASra,KAAKuM,OAAO8hB,WAEzBvd,EAAIvE,OAASvM,KAAKuM,OAGpBuE,EAAI3B,WAIRnP,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,mBAAoBkb,IAClDlb,KAAKuM,SAAW2O,GACjBlb,KAAKoqD,mBAITpqD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAgBqa,IAC9Cra,KAAKuM,SAAW8N,EAAOQ,UAAS,IACjC7a,KAAKoqD,mBAITpqD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,uBAAwBqN,IACzDrN,KAAKqqD,kBAAkBh9C,MAGzBrN,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAEuM,OAAAA,EAAQ+9C,KAAAA,MAC7DtqD,KAAKuqD,sBAAsBh+C,EAAQ6E,MAAMC,KAAKi5C,OAIhDtqD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAgB,EAAEqN,QAAAA,MACnDrN,KAAKqqD,kBAAkBh9C,MAKzBrN,KAAK6pD,YAAc,IAAIW,GAAe,CACpCC,UAAW,CAAC,CACV99C,YAAa,2BACblJ,KAAM,oBACNxD,KAAM,WACL,CACD0M,YAAa,gCACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,8BACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,yBACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,2BACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,gCACblJ,KAAM,kBACNxD,KAAM,UAER6L,WAAY9L,KAAK8L,WACjB4+C,YAAcC,IACZ,IAAI18C,EAA4B,YAAlB08C,EAAS1qD,MAAsB,+BAAuC,IAAM,EAC1FmG,YAAW,KACTwkD,EAAcxrD,UAAUoE,OAAO,YAA+B,YAAlBmnD,EAAS1qD,QACpDgO,IAEL0E,SAAU3S,KAAK2S,WAGjB3S,KAAK6pD,YAAYgB,oBAAsB,KACrCd,GAAiB,IAGnB/pD,KAAK2pD,QAAQv/C,QAAQ1K,OAAOM,KAAK6pD,YAAY3oD,WAE7C,MAAM0pD,EAAgB,EAAa,CAAC3rD,KAAM,qBAC1Ce,KAAK+O,QAAQrP,OAAOkrD,GAEpBA,EAAcxqD,iBAAiB,SAAS,IAAW,mCACjD,MAAMmM,EAASvM,KAAKuM,OACdiE,EAAKxQ,KAAKuM,OAAO8hB,WACjB8qB,QAAkBn5C,KAAK2S,SAASoH,gBAAgBo/B,UAAU3oC,GAE1Ds6C,EAAmB,CAACtwC,EAAmB1V,KAC3C,IAAIklC,EAA2ByD,EAC7BC,EAAiCG,EACjCC,EAEF,GAAGtzB,EAAQ7Z,OAAS,EAClBqpC,EAAe,uBACfyD,EAAgB,EAAC,QAAK,UAAW,CAACjzB,EAAQ7Z,UAC1C+sC,EAAqB,2BACrBG,EAAsBrzB,EAAQG,KAAKpO,IACjC,MAAMw+C,EAAIjsD,SAASC,cAAc,KAEjC,OADAgsD,EAAErrD,OAAO,IAAI44B,GAAU,CAAC/rB,OAAAA,IAASnC,SAC1B2gD,KAGL5R,IACFrL,EAAa,CAAC,CACZruC,KAAM,4BACN2pC,SAAS,SAGR,CACLY,EAAe,yBACf0D,EAAqB,2BACrB,MAAMqd,EAAIjsD,SAASC,cAAc,KACjCgsD,EAAErrD,OAAO,IAAI44B,GAAU,CACrB/rB,OAAQiO,EAAQ,KACfpQ,SACHyjC,EAAsB,CAACkd,GAEnB5R,IACFrL,EAAa,CAAC,CACZruC,KAAM,8BACNu6C,SAAU,CAAC,IAAI1hB,GAAU,CAAC/rB,OAAQiO,EAAQ,KAAKpQ,SAC/Cg/B,SAAS,KAKfyE,EAAoBh8B,KAAK,IAAIymB,GAAU,CACrC/rB,OAAAA,IACCnC,SAEH,IAAI8iC,GAAU,oBAAqB,CACjC3gC,OAAAA,EACAy9B,aAAAA,EACA0D,mBAAAA,EACAG,oBAAAA,EACAV,QAAS,CAAC,CACR5B,QAAS,MACTzmC,SAAAA,IAEFgpC,WAAAA,IACCoB,QAGC8b,EAAWv9C,IACC,4BAAbA,EAAIxN,MACL2rC,GAAS,CAACC,YAAa,wBAI3B,GAAGsN,EAAW,CACZ,MAAMroC,EAAM9Q,KAAKyO,OAAO+D,UAAUssC,IAClChuC,EAAI3B,KAAK,CACPlP,KAAM,UACN++C,WAAW,EACXpI,QAAUp8B,IACRswC,EAAiBtwC,GAAS,KACxB,MAAM1Q,EAAU9J,KAAK2S,SAASoH,gBAAgBU,gBAAgBjK,EAAIgK,GAClE1Q,EAAQ+D,MAAMm9C,GACdl6C,EAAImuC,gBAAgBn1C,OAGf,GAETgF,MAAO,kBACPf,YAAa,uBAGf,IAAIooC,GAAc,CAChBI,UAAW,CAAC,YACZxoC,YAAa,SACbsoC,SAAW9pC,IACTnG,YAAW,KACT0kD,EAAiB,CAACv+C,IAAU68B,IAC1BppC,KAAK2S,SAASoH,gBAAgBkxC,YAAYz6C,EAAIjE,EAAQ68B,EAAQpoC,UAAOgJ,EAAY,GAChF6D,MAAMm9C,QAER,WASAX,kBAAkBh9C,G,0CAC7B,GAAGrN,KAAKqP,KAAM,OAEd,MAAM,OAAC9C,GAAUc,EACjB,GAAI67C,GAAiB38C,GAErB,IAAI,MAAMo+C,KAAY3qD,KAAK6pD,YAAYY,UAAW,CAChD,MAAM99C,EAAcg+C,EAASh+C,YACvBK,EAAUk8C,GAAiB38C,GAAQI,GACzC,IAAIK,EACF,SAGF,MAAMk+C,EAAWlrD,KAAK6pD,YAAYsB,qBAAqB,CAAC99C,GAAUV,GAAagf,QAAQte,IAAaL,EAAQoF,MAAMyZ,GAAMA,EAAE5e,MAAQI,EAAQJ,KAAO4e,EAAEtf,SAAWc,EAAQd,WACnK2+C,EAASvqD,SACVqM,EAAQqS,WAAW6rC,EAASvwC,KAAKtN,IAAY,CAAEJ,IAAKI,EAAQJ,IAAKV,OAAQc,EAAQd,YAE9EvM,KAAKuM,SAAWA,IAA6D,IAAnDvM,KAAK6pD,YAAYuB,gBAAgBz+C,KAC5D3M,KAAK6pD,YAAYuB,gBAAgBz+C,IAAgBu+C,EAASvqD,OAC1DX,KAAK6pD,YAAYwB,oBAAoBH,EAAUP,GAAU,SAM1DJ,sBAAsBh+C,EAAgB4sB,GAC3C,IAAGn5B,KAAKqP,MAEJ65C,GAAiB38C,GAArB,CAEA,IAAI,MAAMU,KAAOksB,EACf,IAAI,MAAMl5B,KAAQD,KAAK6pD,YAAYY,UAAW,CAC5C,MAAM99C,EAAc1M,EAAK0M,YAEnBK,EAAUk8C,GAAiB38C,GAAQI,GACzC,IAAIK,EAAS,SAEb,MAAMqR,EAAMrR,EAAQsR,WAAWuN,GAAMA,EAAE5e,MAAQA,IAC/C,IAAY,IAAToR,IAIHrR,EAAQuR,OAAOF,EAAK,GAEjBre,KAAKuM,SAAWA,GAAQ,CACzB,MACMlI,EADYrE,KAAK6pD,YAAYp6C,KAAK9C,GAClBzH,cAAc,cAAc+H,qBAAuBV,OACtElI,IACErE,KAAK6pD,YAAYyB,UAAUC,aAC5BvrD,KAAK6pD,YAAYyB,UAAUE,gBAAgBnnD,GAG7CA,EAAI/D,UAGHN,KAAK6pD,YAAYuB,gBAAgBz+C,IAAiB0R,EAAM,KACvDre,KAAK6pD,YAAYuB,gBAAgBz+C,IAS3C3M,KAAK8L,WAAWg5B,YAGL+iB,c,0CAEX7nD,KAAK2pD,QAAQ9B,cACb7nD,KAAKwpD,QAAQpqD,UAAUC,IAAI,QAC3BW,KAAK6pD,YAAYhC,aAAY,GAC7B7nD,KAAKkB,UAAU9B,UAAUoE,OAAO,yBAAyBxD,KAAK6pD,YAAY4B,0BAA0BzrD,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKuM,OAAO8hB,WAAY,qBAI/Jq9B,aAAa5hD,GAClB9J,KAAK6pD,YAAY8B,UAAY7hD,EAGxBg8C,QAAQv5C,EAAgBV,EAAW,G,MACxC,OAAG7L,KAAKuM,SAAWA,GAAUvM,KAAK6L,WAAaA,KAE/C7L,KAAKuM,OAASA,EACdvM,KAAK6L,SAAWA,EAChB7L,KAAK4rD,aAAc,EAEhB5rD,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGdrP,KAAK6pD,YAAYgC,SAAS,CACxBt/C,OAAAA,EAEAu/C,eAAuC,QAAzB,EAAE5C,GAAiB38C,UAAM,QAAvB28C,GAAiB38C,GAAY,KAG/CvM,KAAK2pD,QAAQ7D,QAAQv5C,EAAQV,IAEtB,GAGIw8C,sB,0CACProD,KAAK4rD,cAIT5rD,KAAK4rD,aAAc,QACb5rD,KAAK6nD,oBACL7nD,KAAKoqD,sBACLpqD,KAAK2pD,QAAQtB,0BAGP+B,gB,0CACZ,IAAIlb,EAEFA,EADClvC,KAAKuM,OAAO46B,SACNnnC,KAAKuM,SAAW,iBAAwBvM,KAAK2S,SAAS2I,gBAAgBqiC,UAAU39C,KAAKuM,OAAOqO,mBAEtF5a,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKuM,OAAO8hB,WAAY,eAG/EruB,KAAKwpD,QAAQpqD,UAAUoE,OAAO,QAAS0rC,MAGlC6c,iBAAiBC,EAAiBC,GACvCjsD,KAAK6pD,YAAY1oD,KAAK6qD,EAAQC,GAGhCv6C,qBACE1R,KAAK8L,WAAWg5B,WAGXkkB,UACLhpD,KAAK0O,aAAc,EACnB1O,KAAKwP,sBACLxP,KAAK2pD,QAAQX,WC9bV,MAAMkD,GAAgC,wBA2IvCC,GAAkB,IAzIjB,cAA8Bj8C,EAInCtQ,cACEC,MAAM,CACJsR,UAAWrS,SAASstD,eAAe,gBACnCh8C,cAAc,EACdG,eAAgB,UAPZ,KAAA87C,uBAAwB,EAWhC5jC,UAAU9V,GACR3S,KAAK2S,SAAWA,EAEhB0c,EAAA,mBAA4B,gBAAgB,CAAChe,EAAMixB,KAC9CA,IAAO,YAAqBjxB,IAAS,YACtCrR,KAAKssD,eAAc,MAIvBj9B,EAAA,mBAA4B,UAAU,KACpCrvB,KAAKusD,yBAIFC,uBACL,MAAM17C,EAAM9Q,KAAKwS,UAAU22C,IAAmB,GAG9C,OAFAr4C,EAAIrC,OAASzO,KAEN8Q,EAGF27C,sBAAsB37C,GAC3B,IAAI47C,EAAc1sD,KAAK2sD,eACpBD,GACiBA,EAAYxrD,UAAU9B,UAAUiG,SAAS,WAEzDyL,EAAI5P,UAAU9B,UAAUC,IAAI,UAG9BqtD,EAAYxrD,UAAUu9B,YAAY3tB,EAAI5P,YAEtClB,KAAKkR,cAAcrN,QAAQiN,EAAI5P,WAGjClB,KAAK2sD,eAAiB77C,EAGjBD,WAAWL,EAAYC,EAAkBC,GAC1C1Q,KAAKmQ,cAAcxP,QACrBX,KAAKssD,eAAc,EAAO77C,GAG5B5Q,MAAMgR,WAAWL,EAAIC,EAASC,GAGxB67C,sBACN,MAAMK,EAAa5sD,KAAKmR,UAAU07C,YAAc7sD,KAAKmR,UAAU0X,uBAAuBgkC,YACtF/tD,SAASguD,gBAAgB7pD,MAAMmgD,YAAY,4BAA6B,GAAKwJ,GAGxEN,cAAcS,EAAkBt8C,GACrC,MAAMu8C,EAASluD,SAAS8rC,KAAKxrC,UAAUiG,SAAS6mD,IAChD,IAAIe,EAaJ,QAZcjjD,IAAX+iD,EACEA,EACGC,IACFC,GAAa,GAEPD,IACRC,GAAa,GAGfA,GAAa,GAGXA,EAAY,OAAO9pD,QAAQ4B,UAE3BioD,GAAWhtD,KAAKmQ,cAAcxP,QAChCX,KAAK2sD,eAAex9C,OAGlBnP,KAAKqsD,wBACPrsD,KAAKusD,sBACLvsD,KAAKqsD,uBAAwB,GAG/B,MAAMa,EAAmB,aAAuBF,EAAS,EAAI,EAAGv8C,GAEhE,OADA3R,SAAS8rC,KAAKxrC,UAAUoE,OAAO0oD,GAA+Ba,GACvDG,IAgDX,qBAAiCf,GACjC,YC3Ie,MAAMgB,WAA0B3+C,EAGnCa,OACRrP,KAAKkB,UAAUsP,GAAK,yBACpBxQ,KAAKkB,UAAU9B,UAAUC,IAAI,sBAE7BW,KAAKotD,WAAatuD,SAASC,cAAc,OACzCiB,KAAKotD,WAAWhuD,UAAUC,IAAI,gBAC9BW,KAAK8L,WAAWpM,OAAOM,KAAKotD,YAGjBj+C,KAAK9B,G,6FAChB,MAAM8xC,EAAM,EAAMhwC,KAAI,WAChBk+C,QAAartD,KAAK2S,SAAS26C,gBAAgBC,QAAQlgD,EAAQ2gB,MAAMq/B,KAAK78C,IAE5ExQ,KAAK4P,SAASy9C,EAAKA,KAAK70C,OAAOg1C,KAAO,yBAA2B,0BAEjE,MAAM1+C,EAAQhQ,SAASC,cAAc,OACrC,EAAA45B,EAAA,GAAa7pB,GAAO,EAAA8pB,GAAA,GAAcy0B,EAAKA,KAAKI,WAE5C,MAAM9jC,EAAW0jC,EAAK9iC,QAAQA,QAAQ5P,KAAKksB,GAAMA,EAAE6mB,OAASL,EAAK9iC,QAAQojC,aAAe,MACxFC,GAAcjkC,GAEd,MAAMzU,EAAWpW,SAASqW,yBAwF1B,OAvFAk4C,EAAK9iC,QAAQA,QAAQnd,SAAQ,CAACkC,EAAQ+O,KACpC,IAAI/O,EAAOo+C,OAAQ,OAEnB,MAAMG,EAAK/uD,SAASC,cAAc,MAE5B+uD,EAAST,EAAKA,KAAKU,QAAQ1vC,GAG3B2vC,EAAWlvD,SAASC,cAAc,OACxCivD,EAAS5uD,UAAUC,IAAI,uBAEvB,MAAM4uD,EAAcnvD,SAASC,cAAc,QAC3C,EAAA45B,EAAA,GAAas1B,GAAa,EAAAr1B,GAAA,GAAck1B,EAAOruD,OAE/C,MAAMyuD,EAAiBpvD,SAASC,cAAc,OAC9CmvD,EAAejvB,UAAYt8B,KAAKE,MAAM8mB,EAAStL,IAAQ,IAEvD2vC,EAAStuD,OAAOuuD,EAAaC,GAG7B,MAAMrjD,EAAO,oBACbA,EAAKzL,UAAUC,IAAI,uBAEnB,wBAAuCwL,GAAM,KAC3C,4BACCb,GAAW,GAEda,EAAK5H,MAAMkrD,UAAyC,GAA7BxrD,KAAKC,IAAI0M,EAAOo+C,OAAQ,GAAU,KAEzDx4C,EAASxV,OAAOmuD,EAAIG,EAAUnjD,GAE9B,IAAImZ,EAAgBnX,EAAQ,EAAGkjC,GAAU,EAAOppC,EAAO2I,EAAOo+C,OAAS,EACvE,MAAMvsD,EAAO,KACR4uC,IACHA,GAAU,EAEV/vC,KAAK2S,SAAS26C,gBAAgBc,SAAS/gD,EAASygD,EAAOO,OAAQrqC,EAAQnX,GAAOnL,MAAM4sD,IAClFA,EAAUC,MAAMnhD,SAASohD,IACvB,MAAM,IAACrzC,GAAO,gBAA+B,CAC3C5O,OAAQiiD,EAAKC,QAAQ5zC,UAAS,GAC9B3Z,UAAW2J,EACXuQ,eAAe,EACf5N,WAAW,EACXD,WAAY,KAEd4N,EAAIE,gBAAgBzX,cAActD,YAGjC0jB,IACDrd,GAAQ2nD,EAAUC,MAAM5tD,OACvB+tD,EAASjqD,iBAAiCg6B,aAAY,QAAK,uBAAwB,CAAC97B,KAAKC,IAAI,GAAI+D,OAGpGqd,EAASsqC,EAAUK,YACnB9hD,EAAQ,GAEJlG,GAAS2nD,EAAUC,MAAM5tD,QAC3B+tD,EAASpuD,YAEV4qB,SAAQ,KACT6kB,GAAU,OAMd,GAFA5uC,IAEGwF,GAAQ,EAAG,OAEd,MAAM+nD,EAAW5vD,SAASC,cAAc,OACxC2vD,EAAStvD,UAAUC,IAAI,oBAAqB,YAAa,eACzDqvD,EAAStuD,iBAAiB,QAASe,IACnC,EAAA0D,GAAA,GAAO6pD,GACP,MAAME,EAAO9vD,SAASC,cAAc,OACpC6vD,EAAKxvD,UAAUC,IAAI,cACnBqvD,EAAShvD,OAAOkvD,GAAM,QAAK,uBAAwB,CAACjsD,KAAKC,IAAI,GAAI+D,MAEjEuO,EAASxV,OAAOgvD,MAGlB1uD,KAAKotD,WAAW1tD,OAAOoP,EAAOoG,GAE9B,kBAA8B,GAAMxT,MAAK,SAMlCy9C,G,gSCtHX,MAAM0P,GAAa,kBAIJ,MAAMC,GAKnBlvD,YAAYhB,GAIVoB,KAAKyuB,cAAgB7vB,EAAQ6vB,cAC7BzuB,KAAKuN,WAAa3O,EAAQ2O,WAE1BvN,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAIwvD,IAE7B7uD,KAAKkB,UAAU+B,MAAMmgD,YAAY,gBAAiBxkD,EAAQ2O,WAAa,MAOlEijB,OAAOhW,EAAmBoU,GAC/B,MAAM9I,EAAW9lB,KAAKkB,UAAU4kB,UAChCtL,EAAUA,EAAQ9Z,QAAQy5B,WACfx5B,OAAS,IAClB6Z,EAAUA,EAAQ9Z,OAAO,IAG3B8Z,EAAQpN,SAAQ,CAACb,EAAQ8R,KACvB,IAAI0wC,EAAkBjpC,EAASzH,GAC3B0wC,IACFA,EAAkBjwD,SAASC,cAAc,OACzCgwD,EAAgB3vD,UAAUC,IAnCE2vD,qCAsC9B,IAAIpmB,EAAammB,EAAgBhmC,kBAC7B6f,IACFA,EAAa,IAAI0E,GACjB1E,EAAWxpC,UAAUC,IAAI,UAAYW,KAAKuN,WA1CxBshD,0BA2ClBjmB,EAAWqmB,cAAc,CACvB1hB,UAAU,EACV3e,aAAAA,KAIJga,EAAWC,kBAAkB,CAC3Bpa,cAAezuB,KAAKyuB,cACpBliB,OAAQA,IAGNq8B,EAAWsmB,YACbH,EAAgBrvD,OAAOkpC,GAGrBmmB,EAAgBG,YAClBlvD,KAAKkB,UAAUxB,OAAOqvD,MAKzB39C,MAAMC,KAAKyU,GAA4BplB,MAAM8Z,EAAQ7Z,QAAQyM,SAASmE,GAAOA,EAAGjR,YC7CrF,IAAI6uD,GAAkB,EACtB,MAKavB,GAAiBjkC,IAG5B,MAAM1F,EAAM0F,EAAS7I,QAAO,CAACC,EAAK6sB,IAAM7sB,EAAMpe,KAAKE,MAAM+qC,IAAI,GAC7D,GAAG3pB,EAAM,IAAK,CACZ,MAAMpL,EAAOoL,EAAM,IACbtjB,EAASgpB,EAAShpB,OACxB,IAAI,IAAIoL,EAAI,EAAGA,EAAI8M,IAAQ9M,EAAG,CAC5B,IAAIqjD,GAAY,EAAGC,EAAe,EAClC,IAAI,IAAI53C,EAAI,EAAGA,EAAI9W,IAAU8W,EAAG,CAC9B,IAAI63C,EAAY3lC,EAASlS,GAAK,EAC3B63C,GAAa,IAAOA,EAAYD,IACjCA,EAAeC,EACfF,EAAW33C,GAIf,IAAiB,IAAd23C,EAED,OAGFzlC,EAASylC,IAAaC,QAEnB,GAAGprC,EAAM,IAAK,CACnB,MAAMpL,EAAO,IAAMoL,EACbtjB,EAASgpB,EAAShpB,OACxB,IAAI,IAAIoL,EAAI,EAAGA,EAAI8M,IAAQ9M,EAAG,CAC5B,IAAIqjD,GAAY,EAAGG,EAAe,EAClC,IAAI,IAAI93C,EAAI,EAAGA,EAAI9W,IAAU8W,EAAG,CAC9B,IAAI63C,EAAY3lC,EAASlS,GAAK,EAC3B63C,EAAY,IAAOA,EAAYC,IAChCA,EAAeD,EACfF,EAAW33C,GAIf,IAAiB,IAAd23C,EAED,OAGFzlC,EAASylC,IAAa,EAAIG,KAqBhC,qBAA2B,eAAe,EAAElC,KAAAA,EAAM9iC,QAAAA,MAC3BnZ,MAAMC,KAAKvS,SAASwS,iBAAiB,yBAAyB+7C,EAAK78C,SAC3EpD,SAASoiD,IAEpBA,EAAYC,WAAapC,EAAK70C,OAAOk3C,OACrCF,EAAYG,eAAeplC,EAAS8iC,EAAKuC,qBAI7CvgC,EAAA,mBAA4B,UAAU,KACpCwgC,GAAYC,eACZD,GAAYE,iBAGd1gC,EAAA,mBAA4B,gBAAgB,KAC1CwgC,GAAYC,kBAGd,MAAME,GAAe,CAAC5lD,EAAsB6lD,EAAoBhiD,KAC9D7D,EAAQhL,UAAUkB,OAAO,UAEzB6N,aAAaF,GACb7H,YAAW,KACT6pD,IACA7lD,EAAQ9J,SAEL4vD,KAAiB9lD,GAAW+lD,KAAuBF,GAAUG,KAAwBniD,IACtFiiD,GAAeC,GAAqB,KACpCC,GAAsB,KAEvB,MAGL,IAAIF,GAA2BC,GAAgCC,GAC3DC,IAAgB,EAwCL,MAAMR,WAAoBr8B,YAAzC,c,oBAgBS,KAAAi8B,UAAW,EACV,KAAAa,QAAS,EACT,KAAAC,aAAc,EACd,KAAAC,UAAW,EACX,KAAAC,YAAa,EACb,KAAAb,cAA0B,GAU1B,KAAAc,eAA2B,GAG3B,KAAAC,UAAW,EAEZltC,sBACL,MAAMliB,EAAQ,UAAoB,IAAM,SAAmB,IAAM8tB,EAAA,oBACjErvB,KAAK4wD,WAAarvD,EApLH,EAoLwBvB,KAAK6wD,YAAc,KAGrDptC,qBACDzjB,KAAK4wD,YACYx/C,MAAMC,KAAKvS,SAASwS,iBAAiB,0BAC7ClE,SAASoiD,IACpBA,EAAYsB,SAAS1jD,SAAQ,CAAC0uB,EAAKzd,KAEjCmxC,EAAYuB,gBAAgB1yC,EAAK,SAK1BmS,S,qCAIP2+B,KACFA,GAAmBrwD,SAASstD,eAAe,aAAuCpiC,iBAElF6lC,GAAYC,gBAId,MAAM,KAACzC,EAAI,QAAE9iC,GAAWvqB,KAAKqN,QAAQ2gB,MAUrC,IAAIgjC,EANDhxD,KAAKqN,QAAQmL,OAAOknB,cACrB1/B,KAAKZ,UAAUC,IAAI,iBAMlBguD,EAAK70C,SACNxY,KAAKwwD,WAAanD,EAAK70C,OAAOy4C,cAC9BjxD,KAAKswD,SAAWjD,EAAK70C,OAAOg1C,KAC5BxtD,KAAKyvD,WAAapC,EAAK70C,OAAOk3C,OAC9B1vD,KAAKywD,aAAepD,EAAK70C,OAAO04C,gBAE7BlxD,KAAKyvD,UACNuB,EAAU,wBACVhxD,KAAKZ,UAAUC,IAAI,cAEnB2xD,EADQhxD,KAAKswD,OACHtwD,KAAKwwD,SAAW,sBAAwB,+BAExCxwD,KAAKwwD,SAAW,wBAA0B,4BAIxDxwD,KAAKZ,UAAUoE,OAAO,cAAexD,KAAKywD,YAE1C,MAAMU,EAAiBnxD,KAAKywD,WAAa,yDAA2D,GAC9FlC,EAAQlB,EAAKU,QAAQpzC,KAAI,CAACmzC,EAAQzvC,IAC/B,kDACkCA,4PAMjC8yC,+cAUPxtC,KAAK,IAwBR,GAtBA3jB,KAAKsE,UAAY,+KAMbiqD,KAEJ,EAAA51B,EAAA,GAAa34B,KAAK+oB,mBAAmB,EAAA6P,GAAA,GAAcy0B,EAAKI,WAExDr8C,MAAMC,KAAKrR,KAAKsR,iBAAiB,sBAAsBlE,SAAQ,CAACmE,EAAI8M,MAClE,EAAAsa,EAAA,GAAapnB,GAAI,EAAAqnB,GAAA,GAAcy0B,EAAKU,QAAQ1vC,GAAK5e,UAGnDO,KAAKoxD,QAAUpxD,KAAK+oB,kBAAkBmlB,mBACtCluC,KAAKqxD,QAAUrxD,KAAKoxD,QAAQroC,kBAC5B/oB,KAAKsxD,WAAatxD,KAAKoxD,QAAQ3sD,iBAE5BusD,GACDhxD,KAAKqxD,QAAQ3xD,QAAO,QAAKsxD,IAGxBhxD,KAAKswD,SACNtwD,KAAKZ,UAAUC,IAAI,WAEhBguD,EAAKkE,cAAgBlE,EAAKmE,YAAY,CACvC,MAAMC,EAAc3yD,SAASC,cAAc,OAC3C0yD,EAAYryD,UAAUC,IAAI,aAC1BW,KAAKoxD,QAAQ1xD,OAAO+xD,GAEpB,MAAM31B,EAAMh9B,SAASs9B,gBAAgB,6BAA8B,OAEnEN,EAAI18B,UAAUC,IAAI,mBAElBW,KAAK0xD,UAAY51B,EAEjB,MAAMiF,EAAc,EACdxV,EAAS,EACTomC,EAAgB,EAAIhvD,KAAKq+B,GAAKzV,EAE9BzC,EAAShqB,SAASs9B,gBAAgB,6BAA8B,UACtEtT,EAAO1pB,UAAUC,IAAI,0BACrBypB,EAAOnC,eAAe,KAAM,KAAM,MAClCmC,EAAOnC,eAAe,KAAM,KAAM,MAClCmC,EAAOnC,eAAe,KAAM,IAAK,GAAK4E,GACtCzC,EAAOnC,eAAe,KAAM,eAAgB,GAAKoa,GAEjDjF,EAAIp8B,OAAOopB,GACX9oB,KAAKoxD,QAAQ1xD,OAAOo8B,GAEpB,MAAM81B,EAA6B,IAApBvE,EAAKkE,aACdM,EAA6F,KAAhFxE,EAAKmE,kBAAmB,iDAa3CxxD,KAAK8xD,aAAehsD,OAAO8hD,aAAY,KACrC,MAAM1zC,EAAOxO,KAAKC,MACZgkB,GAAYkoC,EAAY39C,GAAQ09C,EAChCG,GAAYF,EAAY39C,GAAQ,IAAO,EAAI,EACjDu9C,EAAYntD,UAAY6sB,GAAS4gC,GAE7BA,GAAY,IACdN,EAAYxuD,MAAMqlB,MAAQ,UAC1BQ,EAAO7lB,MAAM+uD,OAAS,WAKxBlpC,EAAO7lB,MAAMg+B,iBAAmB0wB,EAAgBhoC,EAAWgoC,EAC3D7oC,EAAO7lB,MAAMgnB,gBAAkB,GAAG0nC,KAAiBA,IAEhDz9C,GAAQ29C,IACT5I,cAAcjpD,KAAK8xD,cACnBL,EAAYntD,UAAY,GAExBwkB,EAAO7lB,MAAMg+B,iBAAmB0wB,EAChC3xD,KAAK8xD,aAAe,EAEpB1rD,YAAW,KAETpG,KAAK2S,SAAS26C,gBAAgB2E,WAAWjyD,KAAKqN,WAC7C,QAEJ,KAIPrN,KAAKkyD,WAAa9gD,MAAMC,KAAKrR,KAAKsR,iBAAiB,iBACnDtR,KAAK8wD,SAAW1/C,MAAMC,KAAKrR,KAAKsR,iBAAiB,eACjDtR,KAAKmyD,WAAa/gD,MAAMC,KAAKrR,KAAKsR,iBAAiB,0BAEnD,MAAM8gD,EAAYtzD,SAASC,cAAc,OACzCqzD,EAAUhzD,UAAUC,IAAI,eAExBW,KAAKqyD,YAAcvzD,SAASC,cAAc,OAC1CiB,KAAKqyD,YAAY1zD,UAAY,4CAC7BqB,KAAKqyD,YAAY3yD,QAAO,QAAK,0BAE7BM,KAAKsyD,eAAiBxzD,SAASC,cAAc,OAC7CiB,KAAKsyD,eAAe3zD,UAAY,mBAEhCyzD,EAAU1yD,OAAOM,KAAKqyD,YAAaryD,KAAKsyD,gBACxCtyD,KAAKN,OAAO0yD,GAEZpyD,KAAKqyD,YAAYjyD,iBAAiB,SAAUC,KAC1C,EAAA4nB,EAAA,GAAY5nB,GAER,eAA4B8sD,KAC9B,aAA0BA,IAAmBh+C,KAAKnP,KAAKqN,aAG3D,EAAAxI,GAAA,GAAO7E,KAAKqyD,aAETryD,KAAKywD,aACNzwD,KAAKuyD,YAAczzD,SAASC,cAAc,OAC1CiB,KAAKuyD,YAAYnzD,UAAUC,IAAI,qBAAsB,kBACrDW,KAAKuyD,YAAY7yD,QAAO,QAAK,0BAC7B,EAAAmF,GAAA,GAAO7E,KAAKuyD,aAERlF,EAAKuC,cAAcjvD,QACrBX,KAAKsyD,eAAelzD,UAAUC,IAAI,SAGpC,QAAiBW,KAAKuyD,aAAclyD,KAClC,EAAA4nB,EAAA,GAAY5nB,GAKTL,KAAK0wD,eAAe/vD,QACrBX,KAAKwyD,UAAUxyD,KAAK0wD,gBAAgBhvD,MAAK,KACvC1B,KAAK0wD,eAAe/vD,OAAS,EAC7BX,KAAKkyD,WAAW9kD,SAASmE,IACvBA,EAAGnS,UAAUkB,OAAO,uBAM5B8xD,EAAU1yD,OAAOM,KAAKuyD,cAOxB,MAAME,IAAYpF,EAAKuC,cAAcjvD,QAAUX,KAAKyvD,UAChDgD,IAAWzyD,KAAKwwD,UAClBxwD,KAAK2vD,eAAeplC,EAAS8iC,EAAKuC,eAAe,GAGhD6C,IACDzyD,KAAK0yD,eAAenoC,IACpB,QAAiBvqB,KAAMA,KAAK2yD,gB,+RAIhCC,aAAaroC,GACX,GAAGA,EAAQsoC,UAAYtoC,EAAQuoC,kBAAmB,CAChD,MAAMC,EAAaj0D,SAASC,cAAc,OAgB1C,GAfAg0D,EAAW3zD,UAAUC,IAAI,YAAa,aACtCW,KAAKoxD,QAAQ1xD,OAAOqzD,IAGpB,QAAiBA,GAAa1yD,KAC5B,EAAA4nB,EAAA,GAAY5nB,GAGZ0yD,EAAW3zD,UAAUC,IAAI,UAzUb,EAACwzD,EAAkBC,EAA0B7C,KAC5DC,IACDF,GAAaE,GAAcC,GAAoBC,IAGjD,MAAMhmD,EAAUtL,SAASC,cAAc,OACvCqL,EAAQhL,UAAUC,IAAI,aAEtB,MAAM6B,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI,YAAa,SAErC,MAAM2zD,EAASl0D,SAASC,cAAc,OACtCi0D,EAAO5zD,UAAUC,IAAI,QAErB6B,EAAUxB,OAAOszD,GACjB5oD,EAAQ1K,OAAOwB,IAEf,EAAAy3B,EAAA,GAAaq6B,GAAQ,EAAAvK,GAAA,GAAaoK,EAAU,CAACI,SAAUH,KACvD,iCAA2C1oD,GAEtCA,EAAQ+6C,WACb/6C,EAAQhL,UAAUC,IAAI,UAEtB6wD,GAAe9lD,EACf+lD,GAAqBF,EACrBG,GAAsBtqD,OAAOM,YAAW,KACtC4pD,GAAa5lD,EAAS6lD,EAAQG,MAC7B,KAAqB,IAAO,KAE3BC,KACFA,IAAgB,EAChB,oBAA8B,gBAAgB,KACzCH,IACDF,GAAaE,GAAcC,GAAoBC,SAyS/C8C,CAAY3oC,EAAQsoC,SAAUtoC,EAAQuoC,mBAAmB,KAEvDC,EAAW3zD,UAAUkB,OAAO,gBAI7BN,KAAK2wD,SAAU,CAChB,MAAMwC,EAAgB5oC,EAAQA,QAAQnY,MAAMhN,GAAMA,EAAEoT,OAAO46C,UACxDD,IAAkBA,EAAc36C,OAAO66C,QACxCN,EAAWjgB,UAMnB6f,aAAatyD,GACX,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,eACzC,IAAIA,EACF,QAGF,EAAA8gB,EAAA,GAAY5nB,GACZ,MAAMizD,GAAensD,EAAOS,QAAQ0d,MACpC,GAAGtlB,KAAKywD,WAAY,CAClBtpD,EAAO/H,UAAUoE,OAAO,cAExB,MAAM+vD,EAAavzD,KAAK0wD,eAAel6C,QAAQ88C,IAC5B,IAAhBC,EACDvzD,KAAK0wD,eAAenyC,OAAOg1C,EAAY,GAEvCvzD,KAAK0wD,eAAe7+C,KAAKyhD,QAG3BtzD,KAAKwyD,UAAU,CAACc,IAUpBd,UAAUgB,GACR,GAAGxzD,KAAKyzD,gBAAiB,OAAOzzD,KAAKyzD,gBAErC,MAAMh2C,EAAUzd,KAAKkyD,WAAWvmC,QAAO,CAAC/e,EAAGyR,IAAQm1C,EAAQpsD,SAASiX,KAOpE,OANAZ,EAAQrQ,SAASjG,IACfA,EAAO/H,UAAUC,IAAI,gBAGvBW,KAAKZ,UAAUC,IAAI,iBACnBW,KAAK2wD,UAAW,EACT3wD,KAAKyzD,gBAAkBzzD,KAAK2S,SAAS26C,gBAAgBoG,SAAS1zD,KAAKqN,QAASmmD,GAAS9xD,MAAK,KAC/F+b,EAAQrQ,SAASjG,IACfA,EAAO/H,UAAUkB,OAAO,gBAG1BN,KAAKZ,UAAUkB,OAAO,oBACrBuN,OAAM,KACP7N,KAAK2wD,UAAW,KACfzlC,SAAQ,KACTlrB,KAAKyzD,gBAAkB,QAI3B9D,eAAeplC,EAAsBqlC,EAAyBn/C,GAAU,G,QAKtE,GAJI,iCACFA,GAAU,GAGTzQ,KAAKswD,UAA0B,QAAf,EAAA/lC,EAAQA,eAAO,eAAE5pB,SAAUX,KAAKyvD,UAAW,CAC5DzvD,KAAKkyD,WAAW9kD,SAAQ,CAACmE,EAAI8M,KAC3B9M,EAAGnS,UAAUoE,OAAO,eAAgB+mB,EAAQA,QAAQlM,GAAK7F,OAAO46C,YAG/DpzD,KAAK4yD,eACN5yD,KAAK4yD,aAAaroC,GAClBvqB,KAAK4yD,aAAe,MAGnB5yD,KAAK8xD,eACN7I,cAAcjpD,KAAK8xD,cACnB9xD,KAAK8xD,aAAe,IAGL,QAAd,EAAA9xD,KAAK0xD,iBAAS,eAAE9tD,gBACjB5D,KAAK0xD,UAAUpxD,SAGjB,MAAMsU,EAAS5U,KAAKoxD,QAAQlsD,cAAc,cACvC0P,GACDA,EAAOtU,SAsBX,GAlBGN,KAAKyvD,WACNzvD,KAAKZ,UAAUC,IAAI,cACnB,EAAAuO,EAAA,GAAe5N,KAAKqxD,SAAS,QAAK,4BAIjCrxD,KAAK4vD,cAAcjvD,SAAWivD,EAAcjvD,QAAUX,KAAKyvD,YAC5DzvD,KAAKuwD,YAAcvwD,KAAK4vD,cAAcjvD,SAAWivD,EAAcjvD,OAC/DX,KAAK4vD,cAAgBA,EAAclvD,QAEhCV,KAAKuwD,aACN,QAAiBvwD,KAAMA,KAAK2yD,eAE5B,QAAiB3yD,KAAMA,KAAK2yD,eAK7B3yD,KAAK4vD,cAAcjvD,QAAUX,KAAKuwD,aAAevwD,KAAKyvD,SAAU,CACjE,MAAM9lC,EAAWY,EAAQA,QAAQ5P,KAAKksB,GAAMtc,EAAQojC,aAAe9mB,EAAE6mB,OAASnjC,EAAQojC,aAAe,IAAM,IAE3G3tD,KAAKZ,UAAUoE,OAAO,iBAAkBiN,GACrCA,IACD,QAAczQ,KAAM,IAAKA,KAAKuwD,YAAa,MAG7C,UAAQ,KACNvwD,KAAK2zD,WAAW3zD,KAAKuwD,YAAcvwD,KAAK2pB,SAAWA,EAAU3pB,KAAK4vD,cAAen/C,GACjFzQ,KAAK2pB,SAAWA,EAChB3pB,KAAKuwD,aAAc,KAMvB,GAFAvwD,KAAK0yD,eAAenoC,GAEjBvqB,KAAKwwD,SAAU,CACZxwD,KAAKywD,aACPzwD,KAAKqyD,YAAYjzD,UAAUoE,OAAO,QAAS+mB,EAAQojC,eAAiB3tD,KAAK4vD,cAAcjvD,QACvFX,KAAKsyD,eAAelzD,UAAUoE,OAAO,SAAUxD,KAAK4vD,cAAcjvD,SAGpE,MAAM6Z,GAAW+P,EAAQqpC,eAAiB,IAAIj5C,KAAKO,GAAWA,EAAOL,aAC/Dg5C,EAAiB,IAAI/E,GAAe,CAACvhD,WAAY,KACvDsmD,EAAerjC,OAAOhW,IACtB,EAAA5M,EAAA,GAAe5N,KAAKsxD,WAAYuC,EAAe3yD,WAGjD,GAAGlB,KAAKywD,WAAY,CAClB,MAAMqD,IAAY9zD,KAAK4vD,cAAcjvD,OAE/BozD,EAAkB/zD,KAAKyvD,UAAYqE,EACnCE,GAAsBh0D,KAAKwwD,WAAajmC,EAAQojC,eAAkBmG,IAAY9zD,KAAKyvD,SACzFzvD,KAAKuyD,YAAYnzD,UAAUoE,OAAO,OAAQuwD,GAC1C/zD,KAAKqyD,YAAYjzD,UAAUoE,OAAO,OAAQwwD,GAC1Ch0D,KAAKsyD,eAAelzD,UAAUoE,OAAO,QAASuwD,IAAoBC,IAItEL,WAAWhqC,EAAoBimC,EAAyBn/C,GACtDzQ,KAAK8wD,SAAS1jD,SAAS0uB,GAAQA,EAAI74B,MAAMC,QAAU,KAEnDlD,KAAKkyD,WAAW9kD,SAAQ,CAACmE,EAAI8M,KAC3B9M,EAAGnS,UAAUoE,OAAO,YAAaosD,EAAcxoD,SAASiX,OAG1D,MAAMme,EAAW75B,KAAKH,OAAOmnB,GAK7B,GAHA3pB,KAAKi0D,YAActqC,EAAShP,KAAKizB,GAAMA,EAAIpR,IAGxCx8B,KAAKuwD,YACNvwD,KAAK8wD,SAAS1jD,SAAQ,CAAC0uB,EAAKzd,KAC1Bre,KAAK+wD,gBAAgB1yC,GAAM,UAExB,CACL,MAAMnY,EAAK,KACTlG,KAAK8wD,SAAS1jD,SAAQ,CAAC0uB,EAAKzd,KAE1Bre,KAAK+wD,gBAAgB1yC,EAAK,OAI9B5N,GAAU,SAAQvK,GAAMA,IAK1B,IAAIguD,EAFJvqC,EAAWA,EAASjpB,QACpBktD,GAAcjkC,GAEd,MAAMwqC,EAAWpoD,IACf4d,EAASvc,SAAQ,CAACuc,EAAUtL,KAC1B,MAAM7d,EAAQ0zD,EAAgBvqC,EAAU5d,GACxC/L,KAAKmyD,WAAW9zC,GAAK4gB,UAAYz+B,EAAQ,QAI7C,GAAGR,KAAKuwD,YAGN,GAFA2D,EAAkB,CAACvqC,EAAUrE,IAAU3iB,KAAKE,MAAM8mB,EAhnB1C,GAgnB6DrE,GAElE7U,EACD,IAAI,IAAI1E,EAAI,EAAa0L,EAAI,EAAG1L,GAAK,IAAKA,IAAK0L,EAC7CrR,YAAW,KACT+tD,EAAQpoD,KAnnBJqoD,GAonBO38C,QAGf08C,EAAQ,QAKV,GAFAD,EAAkB,CAACvqC,EAAUrE,IAAU3iB,KAAKE,MAAM8mB,EA5nB1C,IA4nB8DrE,EAAQ,IAE3E7U,EACD,IAAI,IAAI1E,EAAI,EAAGA,EA/nBT,KA+nBsBA,EAC1B3F,YAAW,KACT+tD,EAAQpoD,KA/nBJqoD,GAgoBOroD,QAGfooD,EAAQE,GAIZ,GAAGr0D,KAAKuwD,YAAa,CAChB9/C,GACDzQ,KAAKZ,UAAUC,IAAI,iBAGrBW,KAAKZ,UAAUkB,OAAO,YACtB,MAAM4F,EAAK,KACTlG,KAAK8wD,SAAS1jD,SAAS0uB,GAAQA,EAAI74B,MAAMC,QAAU,UAGlDuN,EACDrK,YAAW,KACTpG,KAAKZ,UAAUkB,OAAO,iBACtB4F,MArpBO,KAwpBTA,SAGFlG,KAAKZ,UAAUC,IAAI,YAIvBqzD,eAAenoC,GACb,MAAM+pC,EAAc/pC,EAAQojC,cAAgB,EAC5C,IAAI99C,EAAkBT,EAAO,CAACklD,GAEZzkD,EADf7P,KAAKyvD,SACHzvD,KAAKswD,OAAcgE,EAAc,uBAAyB,kCAClDA,EAAc,wBAA0B,kCAEhDt0D,KAAKswD,OAAcgE,EAAc,uBAAyB,4BAClDA,EAAc,wBAA0B,6BAGrD,EAAA1mD,EAAA,GAAe5N,KAAKsyD,gBAAgB,QAAKziD,EAAKT,IAGhD2hD,gBAAgBzrC,EAAekN,GAC7B,MAAMsJ,EAAM97B,KAAK8wD,SAASxrC,IAEP,IAAhBkN,GACDsJ,EAAI74B,MAAMgnB,gBAAkB,GAC5B6R,EAAI74B,MAAMg+B,iBAAmB,KAG7BnF,EAAI74B,MAAMgnB,gBAAmBuI,EAAaxyB,KAAKi0D,YAAY3uC,GAASuqC,GAAYe,WAAc,UAE9F90B,EAAI74B,MAAMg+B,iBAAmB,GAAKzO,EAAaq9B,GAAYgB,aA1iBjD,GAAAA,YAAc,KACd,GAAAD,WAAa,EAgjB7B57B,eAAeC,OAAO,eAAgB46B,I,eCxtBvB,MAAM0E,GAOnB30D,YAAsBjB,EAA0B61D,GAA1B,KAAA71D,UAAAA,EAA0B,KAAA61D,KAAAA,EAC9Cx0D,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAUvC,UAAYA,EAE3BqB,KAAKy0D,OAAS31D,SAASC,cAAc,OACrCiB,KAAKy0D,OAAOr1D,UAAUC,IAAIV,EAAY,WAEtCqB,KAAK+O,QAAUjQ,SAASC,cAAc,OACtCiB,KAAK+O,QAAQ3P,UAAUC,IAAIV,EAAY,YAEvCqB,KAAK8O,MAAQhQ,SAASC,cAAc,OACpCiB,KAAK8O,MAAM1P,UAAUC,IAAIV,EAAY,UACrCqB,KAAK8O,MAAMtP,aAAa,MAAO,QAE/BQ,KAAKypC,SAAW3qC,SAASC,cAAc,OACvCiB,KAAKypC,SAASrqC,UAAUC,IAAIV,EAAY,aACxCqB,KAAKypC,SAASjqC,aAAa,MAAO,QAElCQ,KAAK+O,QAAQrP,OAAOM,KAAK8O,MAAO9O,KAAKypC,UACrCzpC,KAAKkB,UAAUxB,OAAOM,KAAKy0D,OAAQz0D,KAAK+O,UC1B7B,SAAS2lD,GAAuBtwD,GAC7C,GAAGA,aAAgBuwD,iBAAkB,OAAOvwD,EAC5C,MAAMwwD,EAAW91D,SAASC,cAAc,YAGxC,OAFAqF,EAAOA,EAAKkI,OACZsoD,EAAStwD,UAAYF,EACdwwD,EAAS7lD,QCTlB,MAAM8lD,GAAY,IAAIj2C,IAAI,CACxB,MACA,MACA,SAGIk2C,GAAS,IAAIl2C,IAEZ,SAASm2C,GAAqBC,GAEnC,OAAOA,EAAQ5iD,MAAM6iD,GAAWJ,GAAU1iB,IAAI8iB,EAAOC,YAAcJ,GAAO3iB,IAAI8iB,EAAOA,UCXxE,SAASE,GAAa/jC,GACnC,OAAOA,EACJ3wB,QAAQ,sBAAuB,QAC/BA,QAAQ,KAAM,SCDJ,SAAS20D,GAAoB/nD,GAC1C,SAAUA,EAAQgoD,qBFWSL,EEX0B3nD,EAAQgoD,oBFYpDN,GAAqBC,KADzB,IAAsBA,E,0BGN7B,MAAMM,GAAiE,CACrEv7B,EAAG,UACHlO,EAAG,UACHrL,EAAG,QACHpN,EAAG,OACHmN,EAAG,SAEU,SAASg1C,GAAmB1vD,EAAkB2vD,GAC3D,MAAM5uB,ECVO,SAAwB/gC,EAAkB4vD,EAAW,GAC9D5vD,IACFA,EAAW,GAGb,IAAIuN,EAA8C,GAClD,MAAMw6B,EAAI,CACR,CAAC/hB,EAAG,EAAGxZ,EAAG,KACV,CAACwZ,EAAG,GAAIxZ,EAAG,KACX,CAACwZ,EAAG,GAAIxZ,EAAG,KACX,CAACwZ,EAAG,GAAIxZ,EAAG,KACX,CAACwZ,EAAG,EAAGxZ,EAAG,MAGZ,IAAIA,EADM,EAEVu7B,EAAExgC,SAAQ,CAAC2gC,EAAG1vB,KAGZ,GAFAhM,GAAK07B,EAAEliB,EAEJhmB,EAAWwM,EACZ,OAGF,MAAMqjD,EAAU9nB,EAAEvvB,IAASuvB,EAAEjtC,OAAS,EAAK0d,EAAMA,EAAM,GAAGwN,EAC1DzY,EAAEvB,KAAK,CACLhM,SAAWA,EAAWwM,EAAIqjD,EAAU,EACpCz1D,KAAM8tC,EAAE17B,OAIZ,MAAM+L,EAAMhL,EAAE1S,OAAO+0D,GAAUt7B,UAC/B,IAAI,IAAIpuB,EAAIqS,EAAIzd,OAAS,EAAGoL,GAAK,IAAKA,EACb,IAApBqS,EAAIrS,GAAGlG,UACRuY,EAAIG,OAAOxS,EAAG,GAIlB,OAAOqS,ED1BGu3C,CAAe9vD,EAAU,GACnC,GAAG2vD,EAAO,CACR,MAAMI,EAAUhvB,EAAEjsB,KAAKvH,GAAM,YAAYkiD,GAAwBliD,EAAEnT,OAAO,EAAM,CAACmT,EAAEvN,aACnF,OAAO,QAAK+vD,GAAS,EAAOJ,GAG9B,MAAMv7B,EAAW2M,EAAEjsB,KAAKvH,IAAM,QAAKkiD,GAAwBliD,EAAEnT,MAAO,CAACmT,EAAEvN,aAEjEqP,EAAWpW,SAASC,cAAc,QAGxC,OAFAmW,EAASxV,WAAU,QAAKu6B,GAAU,IAE3B/kB,E,eEnBM,SAAS2gD,GAAwBxoD,GAC9C,MAAM22C,EAAS32C,EAAQ22C,QACjB,QAAC8R,EAAO,IAAExvC,IAAO,EAAAyvC,GAAA,GAAQ,0BAA0B1oD,EAAQd,OAAO8hB,iBAAiB21B,EAAOgS,KAAKxlD,kBAAkBwzC,EAAOgS,KAAKC,eACnI,IAAIH,EACF,OAAOh3D,SAASC,cAAc,QAGhC,MAAM6nC,EAAI9nC,SAASC,cAAc,KAIjC,OAHA6nC,EAAEsvB,KAAO5vC,EACTsgB,EAAEpnC,aAAa,UAAWs2D,EAAU,UAE7BlvB,E,2SCRM,SAAeuvB,GAAyB9oD,EAAoBmoD,G,qCACzE,IACE,aCSW,SAA8CnoD,EAAoBmoD,G,0CAC/E,MAAMprD,EAAuBorD,OAAQxrD,EAAYlL,SAASC,cAAc,QAClEilD,EAAS,WAAY32C,GAAWA,EAAQ22C,OAI9C,GAAIA,EAAmD32C,QAAS,CAC9D,MAAM+oD,EAAiBpS,EAAmD32C,QAC1E,OAAGmoD,GACM,EAAAtyB,GAAA,GAAckzB,KAErB,EAAAz9B,EAAA,GAAavuB,GAAS,EAAAq+C,GAAA,GAAa2N,EAAe,CAACC,cAAc,KAC1DjsD,GAEJ,CACL,IAEIyhC,EACAz8B,EAHAxC,EAAIo3C,EAAOp3C,EAKf,MAAM+F,EAAW,aAEX2jD,EAAiB,CAAM/pD,EAAgBipD,IAAmB,mCAC9D,OAAOA,GAAQ,EAAA38B,GAAA,GAAatsB,EAAQipD,GAAS,IAAKl9B,GAAU,CAAC/rB,OAAAA,IAAUnC,WAGzE,OAAO45C,EAAOp3C,GACZ,IAAK,yBACHA,GAAK,IAAOo3C,EAAe/jD,KAE3BmP,EAAO,CAACmmD,GAAmBvR,EAAOn+C,SAAU2vD,IAC5C,MAGF,IAAK,yBACH5oD,GAAK,IAAOo3C,EAAe/jD,KAE3BmP,EAAO,GACHxC,EAAE2pD,SAAS,QAAWlpD,EAAQmL,OAAOg+C,MACvCpnD,EAAKyC,KAAKykD,EAAejpD,EAAQC,OAAQkoD,SAGpBxrD,IAApBg6C,EAAOn+C,SACRuJ,EAAKyC,KAAK0jD,GAAmBvR,EAAOn+C,SAAU2vD,IAE9CpmD,EAAKyC,KAAKgkD,GAAwBxoD,IAGpC,MAGF,IAAK,iCAAkC,CACrC,MAAMmN,EAAU,CAACnN,EAAQC,OAAQ02C,EAAOyS,MAAM,GAAG57C,YACjD,IAAI+rB,EAAI,mCACR,MAAMka,EAAO,SACVtmC,EAAQ,KAAOsmC,EAAMla,GAAK,QACrBpsB,EAAQ,KAAOsmC,IAAMla,GAAK,WAClC,EAAA70B,EAAA,GAAiByI,EAASsmC,GAE1BjV,EAAcjF,EACdx3B,EAAOoL,EAAQG,KAAKpO,GAAW+pD,EAAe/pD,EAAQipD,KACtDpmD,EAAKyC,KAAKgkD,GAAwBxoD,IAClC,MAGF,IAAK,kCAAmC,CACtC,MAAM8G,EAAQ,IAAIzO,KACZyN,EAAO,IAAIzN,KAA4B,IAAvBs+C,EAAO0S,eACvBC,GAAexjD,EAAKa,UAAYG,EAAMH,WAAa,MACnD4iD,EAAe,IAAIlxD,KAAKyO,GAC9ByiD,EAAa7/C,QAAQ6/C,EAAapjD,UAAY,GAE9C,MAAM46B,QAAoBz7B,EAAS2/B,gBAAgBlE,YAAY/gC,EAAQd,QACvEs/B,EAAcuC,EAAc,8CAAgD,sCAC5Eh/B,EAAO,GACP,MAAM0xC,EAAO,SACVzzC,EAAQC,SAAWwzC,EACpBjV,GAAe,MACNuC,GACTh/B,EAAKyC,KAAKykD,EAAejpD,EAAQC,OAAQkoD,IAG3C,IAAI/9C,EAAgBwZ,EAA4B,GAC7C0lC,EAAc,GAAKxjD,EAAKK,YAAcW,EAAMX,UAC7CiE,EAAI,4BACIk/C,EAAc,GAAKxjD,EAAKK,YAAcojD,EAAapjD,UAC3DiE,EAAI,mBAEJA,EAAI,mBACJwZ,EAAMpf,KAAK,IAAI,qBAAqB,CAClCsB,KAAAA,EACAvU,QAAS,CACP4V,IAAK,UACLC,MAAO,UACPF,KAAM,aAEPnK,UAGL6mB,EAAMpf,KAAKgD,EAAW1B,IACtB,MAAMd,GAAI,QAAKoF,EAAGwZ,GAClB7hB,EAAKyC,KAAKQ,GAEV,MAGF,IAAK,0BAA2B,CAC9B,MAAMyuC,EAAO,SACVzzC,EAAQC,SAAWwzC,EACpBl0C,GAAK,MAELwC,EAAO,CAACknD,EAAejpD,EAAQC,OAAQkoD,IAGzC,MAGF,IAAK,0BAA2B,CAC9B,MAAMjpD,EAASc,EAAQd,OACjBsqD,QAAsBlkD,EAAS40B,mBAAmBuvB,iBAAiBvqD,EAAQc,EAAQ0gB,cAMzF,GAJA3e,EAAO,CACLknD,EAAejpD,EAAQC,OAAQkoD,IAG7BqB,EAqBG,CACL,MAAMjwB,EAAI9nC,SAASC,cAAc,KACjC6nC,EAAEh/B,QAAQmvD,UAAYF,EAActqD,OAAS,IAAMsqD,EAAc5pD,IACjE25B,EAAEowB,IAAM,OACRpwB,EAAElnC,aAAau3D,GAAoBJ,OAAe7sD,OAAWA,EAAWwrD,IACxEpmD,EAAKyC,KAAK+0B,QAzBViF,EAAc,qBAEXx+B,EAAQ0gB,cACTpb,EAAS40B,mBAAmB2vB,oBAAoB7pD,GAAS3L,MAAWy1D,GAAoB,mCACnFA,GAAmB9pD,IACpB,kBAAwB,eAAgB,CACtC+pD,WAAY,GAAG7qD,YACfA,OAAQA,EACRU,IAAKI,EAAQJ,IACbI,QAAAA,IAGCsF,EAAS40B,mBAAmB8vB,sBAAsBhqD,IACnD,kBAAwB,sBAAuB,CAC7C,CAACd,SAAeoG,EAAS40B,mBAAmB+vB,cAAc/qD,WActE,MAGF,IAAK,mCAAoC,CACvC,MAAM6hC,QAAoBz7B,EAAS2/B,gBAAgBlE,YAAY/gC,EAAQd,QACpEc,EAAQmL,OAAO4F,IAChBytB,EAAcuC,EAAc,+BAAiC,8BAE7DvC,EAAcuC,EAAc,yCAA2C,uCACvEh/B,EAAO,CAACknD,EAAejpD,EAAQC,OAAQkoD,KAEzC,MAGF,IAAK,6BACL,IAAK,0BACL,IAAK,yBACL,IAAK,0BACL,IAAK,6BACL,IAAK,+BACL,IAAK,6BACL,IAAK,gCACL,IAAK,gCACL,IAAK,kCACHpmD,EAAO,CAACknD,EAAejpD,EAAQC,OAAQkoD,IACvC,MAGF,IAAK,gCACL,IAAK,6BACHpmD,EAAO,GACS,+BAAb40C,EAAOp3C,GACRwC,EAAKyC,KAAKykD,EAAejpD,EAAQC,OAAQkoD,IAG3CpmD,EAAKyC,KAAK2jD,EAAQxR,EAAOl1C,OAAQ,EAAAxF,GAAA,IAAW,EAAAsvB,GAAA,GAAcorB,EAAOl1C,SACjE,MAGF,IAAK,8BACL,IAAK,4BACL,IAAK,2BAA4B,CAC/B,MAAM2nD,EAASzS,EAAkDyS,OAC5D,CAAEzS,EAAqDyK,SAI5D,GAFAr/C,EAAO,CAACknD,EAAejpD,EAAQC,OAAQkoD,IAEpCiB,EAAM91D,OAAS,EAAG,CACnB,MAAM42D,GAAS,cACPp0D,QAAQC,IAAIqzD,EAAM97C,KAAKO,GAAmBo7C,EAAep7C,EAAOL,WAAY26C,OAClF,EACAA,GAGF,GAAGA,EACDpmD,EAAKyC,QAAQ0lD,OACR,CACL,MAAMriD,EAAWpW,SAASC,cAAc,QACxCmW,EAASxV,UAAU63D,GACnBnoD,EAAKyC,KAAKqD,SAGZ9F,EAAKyC,KAAKykD,EAAeG,EAAM,GAAG57C,WAAY26C,IAGhD,MAGF,IAAK,0BAA2B,CAC9B,MAAMgC,GAAa,EAAA/O,GAAA,GAAazE,EAAOyT,OAAQ,CAC7CxE,SAAU,CAAC,CACTrmD,EAAG,mBACHjM,OAAQqjD,EAAOyT,OAAO92D,OACtBqjB,OAAQ,MAMZ5U,EAAO,EAFM,EAAA9F,GAAA,GAAWkuD,IAGxB,MAGF,QACE3rB,EAAe6rB,EAAA,GAAS9qD,IAAM,IAAIo3C,EAAOp3C,KAIzCi/B,IACFA,EAAc6rB,EAAA,GAAS9qD,QACJ5C,IAAhB6hC,IACDA,EAAc,IAAMj/B,EAAI,MAI5B,MAAM+qD,EAASvoD,UAAcjM,QAAQC,IAAIgM,IAEzC,OAAGomD,EACM,YAAY3pB,GAAa,EAAM8rB,IAE/B,QAAMvtD,EAASyhC,EAAa8rB,ODvQxBC,CAA+BvqD,EAASmoD,GACrD,MAAM/nD,GAEN,OADAC,QAAQC,MAAM,wCAAyCF,GAChD+nD,EAAQ,GAAK12D,SAASC,cAAc,U,+REShC,SAAek4D,GAAoB5pD,EAAqC5N,EAAgB4N,EAA4BA,QAASwqD,EAAsBrC,EAAiBsC,EAAwBC,G,qCACzM,MAAMh6B,EAA2B,GAEjC,IAAIi6B,GAAc,EAClB,MAAMC,EAAU,CAAC1sB,EAAsB2sB,KACrC,GAAG3sB,EAAS,CACV,QAAYvhC,IAATkuD,GAAsBF,EACvB,OAGFE,EAAO1C,EAAQ,YAAYjqB,GAAS,IAAQ,QAAKA,GAGnD,GAAGiqB,EACDz3B,EAAMlsB,KAAKqmD,OACN,CACL,MAAM3mD,EAAKzS,SAASC,cAAc,KACd,iBAAX,EAAqBwS,EAAGjN,UAAY4zD,EACxC3mD,EAAG7R,OAAOw4D,GACfn6B,EAAMlsB,KAAKN,KAKTg2B,EADW,aACmBA,mBAE9BshB,EAAeuM,GAAoB/nD,GAEzC,IAAI4lD,EAAY5lD,EAA4B8qD,cAC5C,GAAI9qD,EAA4B2gB,QAAU66B,EAAc,EACtD,EAAAlkB,GAAA,GAA4Bt3B,GAC5B,IAAI+qD,GAAiB,EACrB,GAAG/qD,EAAQgrD,WAAY,CACrB,GAAGR,EAAW,CACZ,MAAM1+B,QAAaoO,EAAmB+wB,iBAAiBjrD,GACvD,GAAGwqD,EAAUl3D,SAAWw4B,EAAKx4B,QAC3B,IAAI,MAAMsM,KAAOksB,EACf,IAAI0+B,EAAUzwD,SAAS6F,GAAM,CAC3BmrD,GAAiB,EACjB,YAIJA,GAAiB,EAIrB,GAAGA,EAAgB,CACjB,MAAMG,QAAkBhxB,EAAmBixB,aAAanrD,EAAQgrD,YAChE54D,EAAO84D,EAAUlrD,QACjB4lD,EAAWsF,EAAUJ,cAEjBJ,IACFE,EAAQ,eACRD,GAAc,SAIlBI,GAAiB,EAGnB,IAAKA,IAAmBL,IAAsBt4D,EAAM,CAClD,MAAMuuB,EAAQ3gB,EAAQ2gB,MACtB,OAAOA,EAAMphB,GACX,IAAK,oBACHqrD,EAAQ,eACR,MACF,IAAK,mBACHA,OAAQjuD,EAAWwrD,EAAQxnC,EAAM2Z,UAAW,EAAA/O,GAAA,GAAc5K,EAAM2Z,WAChE,MACF,IAAK,oBACHloC,EAAOuuB,EAAMlf,MACbmpD,EAAQ,kBACR,MAEF,IAAK,kBACHA,EAAQ,kBACR,MACF,IAAK,sBACHA,EAAQ,sBACR,MACF,IAAK,mBACH,MAAMxtC,EAAI,OAAcuD,EAAMq/B,KAAKI,UAAY,QAC/CwK,OAAQjuD,EAAWwrD,EAAQ/qC,GAAI,EAAAmO,GAAA,GAAcnO,IAC7C,MACF,IAAK,sBACHwtC,EAAQ,iBACR,MACF,IAAK,mBAAoB,CACvB,MAAMxtC,EAAI,MAAauD,EAAMyqC,KAAK3pD,MAClCmpD,OAAQjuD,EAAWwrD,EAAQ/qC,GAAI,EAAAmO,GAAA,GAAcnO,IAC7C,MAEF,IAAK,uBAAwB,CAC3B,MAAM3rB,EAAWkvB,EAAMlvB,SAEvB,GAAqB,UAAlBA,EAASmB,KACVg4D,EAAQ,oBACH,GAAqB,UAAlBn5D,EAASmB,KACjBg4D,EAAQ,oBACH,GAAqB,QAAlBn5D,EAASmB,KACjBg4D,EAAQ,kBACH,GAAqB,UAAlBn5D,EAASmB,KACjBg4D,EAAQ,oBACH,GAAqB,YAAlBn5D,EAASmB,KAAoB,CACrC,MAAM8L,EAAIgyB,EAAMp9B,OAChB,GAAG7B,EAAS45D,gBAAiB,CAC3B,MAAMjuC,EAAI3rB,EAAS45D,gBAAkB,IACrCT,OAAQjuD,EAAWwrD,EAAQ/qC,GAAI,EAAAmO,GAAA,GAAcnO,IAG/CwtC,EAAQ,iBAGR,MAAMrqB,EAAI7P,EAAMxf,OAAOxS,EAAG,GAC1B,GAAGypD,EAAOz3B,EAAMlsB,KAAM+7B,EAAE,GAAiBA,EAAE,QACtC,CACH,MAAMrkC,EAAOzD,OAAOhH,SAASC,cAAc,QAC3CwK,EAAK7J,UAAUkuC,GACf7P,EAAMlsB,KAAKtI,GAGb9J,EAAO,QACF,GAAqB,UAAlBX,EAASmB,KAAkB,CACnC,MAAMo7B,EAAYv8B,EAASs8B,WAAWhpB,MAAMipB,GAA8B,2BAAhBA,EAAUzuB,IAAmCyuB,EAAUvsB,OAASusB,EAAU2C,aAC9HvT,EAAI,OAAc4Q,EAAY,CAACA,EAAUvsB,MAAOusB,EAAU2C,WAAWrS,OAAO6kB,SAAS7sB,KAAK,OAAS7kB,EAASq/B,WAClH85B,OAAQjuD,EAAWwrD,EAAQ/qC,GAAI,EAAAmO,GAAA,GAAcnO,SAE7CwtC,OAAQjuD,EAAWwrD,EAAQ12D,EAASq/B,WAAY,EAAAvF,GAAA,GAAc95B,EAASq/B,YAGzE,MAGF,IAAK,0BACH85B,EAAQ,OAWd,MAAMt3D,EAASo9B,EAAMp9B,OACrB,IAAI,IAAIoL,EAAI,EAAGA,EAAIpL,EAAQoL,GAAK,EAC9BgyB,EAAMxf,OAAOxS,EAAG,EAAG,MAGlBtM,GAAQkB,GACTo9B,EAAMlsB,KAAK,MAIf,GAAIxE,EAAmC22C,OAAQ,CAC7C,MAAM2U,QAAsBxC,GAA0B9oD,EAAoCmoD,GACvFmD,GACDV,OAAQjuD,EAAW2uD,GASvB,GALG9P,IACDppD,EAAOs1D,GAAsB1nD,EAA4BgoD,oBAAoB51D,KAC7EwzD,EAAW,IAGVxzD,EAOD,GANAA,GAAO,EAAAi5B,GAAA,GAAaj5B,EAAM,KAEtBwzD,IACFA,EAAW,IAGVuC,EACDz3B,EAAMlsB,MAAK,EAAAqxB,GAAA,GAAczjC,EAAMwzD,QAC1B,CAGL,GAAG6E,EAAe,CAChBA,EAAgBA,EAAcxrD,OAC9B,IACIssD,EADAC,GAAQ,EAERC,EAAS,IAAI/iD,OAAOo/C,GAAa2C,GAAgB,MAErD,IADA7E,EAAWA,EAASvyD,QACkB,QAA/Bk4D,EAAQE,EAAOxhD,KAAK7X,KACzBwzD,EAASphD,KAAK,CAACjF,EAAG,yBAA0BjM,OAAQm3D,EAAcn3D,OAAQqjB,OAAQ40C,EAAMtzC,QACxFuzC,GAAQ,EAGPA,IACD,EAAAE,GAAA,GAAa9F,GAIjB,MAAM+F,GAAiB,EAAAvQ,GAAA,GAAahpD,EAAM,CACxC42D,cAAc,EACdpD,SAAAA,EACAgG,SAAS,EACTC,cAAc,IAGhBn7B,EAAMlsB,KAAK6iD,GAAuBsE,IAItC,GAAGxD,EACD,OAAOz3B,EAAMpa,KAAK,IACb,CACL,MAAMzO,EAAWpW,SAASqW,yBAE1B,OADAD,EAASxV,UAAUq+B,GACZ7oB,I,0kBC/NX,MAAMikD,GAAa,GAEZ,SAAeC,GAAuBx6D,G,kDAS3C,IAAI,MAACkQ,EAAK,QAAEmvB,EAAO,SAAEwL,EAAQ,WAAE+L,EAAU,QAAE6jB,EAAO,QAAEhsD,EAAO,aAAEuhB,GAAgBhwB,OAChEoL,IAAV8E,IACoB,iBAAZ,IACPA,GAAQ,EAAA4pB,GAAA,GAAa5pB,EAAO,KAC5BA,GAAQ,EAAA8pB,GAAA,GAAc9pB,KAGxB,EAAAlB,EAAA,GAAeqwB,EAASnvB,IAGtB8f,IACFA,EAAe,IAGjB,IAAIZ,EAAQ3gB,GAAWA,EAAQ2gB,MAC3BkJ,GAAW,EAAOoiC,GAAU,EAChC,MAAMC,EAAgBF,EAAUjoD,MAAMC,KAAKgoD,EAAQvzC,UAAUplB,QAAU,GACvE,IAAIguB,EACJ,GAAGV,GAASqrC,GAUV,GATA7jB,EAAW7iB,YAAc,GACzB6iB,EAAW91C,aAAau3D,GAAoB5pD,OAASrD,OAAWA,OAAWA,OAAWA,GAAW,IAI9FgkB,EAAMC,UACPD,EAAQA,EAAMC,SAGbD,EAAMnO,OAAUmO,EAAMlvB,WAAiC,QAArB,EAAAkvB,EAAMlvB,SAASuhB,cAAM,eAAE1f,QAA0G,CACpK+tB,EAAa,gCACb,MAAMD,EAAgB,8BAEtB,GAA4B,aAAX,QAAd,EAAAT,EAAMlvB,gBAAQ,eAAEmB,MACjBi3B,GAAW,QACL,GAAY,CAChBsD,IAAKxM,EAAMlvB,SACXuF,IAAKg1D,EACL5qC,cAAAA,EACA0R,MAAOq5B,GAEPj4D,MAAO43D,GACP33D,OAAQ23D,GACRzqC,WAAAA,EACAE,aAAAA,QAEG,CACL,MAAM/O,EAAQmO,EAAMnO,OAASmO,EAAMlvB,SAEnCw6D,EAAyB,UAAfz5C,EAAM5f,KAEhB,UACQquB,GAAU,CACdzO,MAAAA,EACA3e,UAAWm4D,EACXv5C,SAAUq5C,GACVp5C,UAAWo5C,GACXn4D,KAAM4e,GAAgBC,EAAOs5C,GAAYA,IACzCzqC,WAAAA,EACAD,cAAAA,EACAK,QAAQ,EACRH,kBAAkB,EAClBC,aAAAA,IAEFsI,GAAW,EACX,MAAMzpB,YAMTJ,GACDmoC,EAAW7iB,YAAc,GACzB6iB,EAAW91C,aAAau3D,GAAoB5pD,MAEpB,iBAAf,IACPo8B,GAAW,EAAA/Q,GAAA,GAAa+Q,EAAU,KAClCA,GAAW,EAAA7Q,GAAA,GAAc6Q,KAG3B,EAAA77B,EAAA,GAAe4nC,EAAY/L,GAAY,KAa3C,OATAtmC,QAAQC,IAAIwrB,GAAcltB,MAAK,KAC1BgtB,IAAeA,MAClB6qC,EAAcnsD,SAASqsD,GAAUA,EAAMn5D,WAEpC+4D,GACDA,EAAQj6D,UAAUoE,OAAO,WAAY81D,OAIlCpiC,KAGM,MAAMwiC,WAAuBnF,GAG1C30D,YAAsBjB,GACpBkB,MAAMlB,GAAW,CAAMmQ,EAAO26B,EAAW,GAAIp8B,IAAa,mCACpDrN,KAAKq5D,UACPr5D,KAAKq5D,QAAUv6D,SAASC,cAAc,OACtCiB,KAAKq5D,QAAQj6D,UAAUC,IAAIW,KAAKrB,UAAY,WAG9C,MAAMg7D,QAAmBP,GAAuB,CAC9CtqD,MAAAA,EACAmvB,QAASj+B,KAAK8O,MACd26B,SAAAA,EACA+L,WAAYx1C,KAAKypC,SACjB4vB,QAASr5D,KAAKq5D,QACdhsD,QAAAA,IAGFrN,KAAKkB,UAAU9B,UAAUoE,OAAO,WAAYm2D,GACzCA,EACD35D,KAAK+O,QAAQlL,QAAQ7D,KAAKq5D,SAE1Br5D,KAAKq5D,QAAQ/4D,cApBG,KAAA3B,UAAAA,GCjHT,SAASi7D,GACtB9qD,EACA26B,EACAp8B,EACAwsD,GAEA,MAAMC,EAAiB,IAAIJ,GAAe,SACpCK,EAAcD,EAAetF,KAAK1lD,EAAO26B,EAAUp8B,GAEzD,GAAGwsD,EAAgB,CACjB,MAAMG,EAAM9Z,GAAiB2Z,GAAgB,IACtCz0D,EAAG60D,EAAGlP,IAAK,SAASiP,GAC3BF,EAAe54D,UAAU+B,MAAMmgD,YAAY,mBAAoB,GAAGh+C,MAAM60D,MAAMlP,KAC9E+O,EAAe54D,UAAU9B,UAAUC,IAAI,uBAKzC,MAAO,CAAC6B,UAAW44D,EAAe54D,UAAW64D,YAAAA,G,2SCbhC,SAAeG,IAAoB,IAACj9C,EAAG,cAAEwR,EAAa,UAAEvtB,EAAS,MAAEi/B,EAAK,SAAE7+B,EAAQ,MAAEC,EAAK,OAAEC,EAAM,SAAEmR,EAAW,e,gDAU3H,GAAa,QAAV,EAAAsK,EAAIoD,cAAM,eAAE1f,OA4Cb,OA3CAO,EAAU9B,UAAUC,IAAI,8BACxBovB,EAAc5c,KAAK,CACjBxN,IAAKnD,EACLC,KAAM,IAAW,mCACf,MAAMg5D,QAAwBxnD,EAASo0B,mBAAmBqzB,kCAAkCn9C,GACtFnT,EAAU+lB,EAAA,WAA4BsqC,GAE5C,GAAGl9C,EAAIzE,OAAO6hD,WAAap9C,EAAIzE,OAAO8hD,OACpC,OAAOxwD,EACNpI,MAAM0iC,IACLyB,GAAA,sBAAiC,CAC/B3kC,UAAAA,EACAG,MAAM,EACNC,SAAAA,EACAolC,cAAetC,EACf7iC,MAAAA,EACAC,OAAAA,EACAikC,aAAa,EACbhiC,KAAM,WAAawZ,EAAIzM,IACtB2vB,MAEA,CACL,IAAInS,EAYJ,OAXG/Q,EAAIzE,OAAO8hD,QACZtsC,EAAQyC,KACPzC,EAA2B1sB,UAAW,EACtC0sB,EAA2B4S,OAAQ,EACnC5S,EAA2B3sB,MAAO,GAEnC2sB,EAAQ,IAAI/G,MAGd+G,EAAM5uB,UAAUC,IAAI,iBAEbyK,EAAQpI,MAAM0iC,IACnBvd,GAAmBmH,EAAOusC,IAAIC,gBAAgBp2B,IAAO,KACnDljC,EAAUxB,OAAOsuB,eAU7B,MAAMlkB,EAAU6I,EAASo0B,mBAAmB0zB,cAAcx9C,GACpDy9C,QAAmB5wD,EACQ,kBAA9B4wD,EAAWC,UAAU,GAAG/tD,GACzB,GAAY,CACV4tB,IAAKkgC,EAAWC,UAAU,GAC1Bt2D,IAAKnD,EACLi/B,MAAOA,EACP1R,cAAAA,EACA9b,SAAAA,OCtES,SAASsoC,IAAiB,IAACzgB,EAAG,IAAEjV,EAAG,KAAEvkB,EAAI,SAAE2R,IAMxD,MAAMioD,EAAgBr1C,EAAIyI,MACpBA,EAAQzI,EAAI6kB,YAAY,SAE3BwwB,GACD5sC,EAAM5uB,UAAUC,IAAI,QAGtB,MAAMuvB,EAA+BgsC,EAAgB,QAAK5wD,EAEpD6wD,EAAiB,UAAT75D,EAAmB,GAAK,GAChCsO,EAAS,GAAY,CACzBjL,IAAK2pB,EACLwM,IAAKA,EACLj5B,MAAOs5D,EACPr5D,OAAQq5D,EACRjsC,aAAAA,EACAjc,SAAAA,IACCjR,MAAK,EAAE8uB,OAAAA,KAAYA,IAOtB,OALA5B,GAAgBzrB,QAAQC,IAAIwrB,GAAcltB,MAAK,KAC7CssB,EAAM5uB,UAAUkB,OAAO,QACvBs6D,EAAct6D,YAGTgP,E,0BCjCM,SAASwrD,GAAuB1wD,EAAsBlJ,EAAwB65D,EAAaC,GAKxG,YAJehxD,IAAZgxD,IACDA,EAAU5wD,EAAQxG,gBAAkB1C,GAAY,EAAA+5D,GAAA,GAAW7wD,IAAY,GAGtE4wD,IAAYD,KAEQ,IAAbC,GAAkBA,EAAUD,IACpCA,GAAO,GAGLA,EAEM75D,EAAU+J,kBAAoB8vD,EACtC75D,EAAU4C,aAAasG,EAASlJ,EAAU4kB,SAASi1C,IAEnD75D,EAAUxB,OAAO0K,GAJjBlJ,EAAU2C,QAAQuG,IAOb,G,eCXM,MAAM8wD,GAenBt7D,YAAYhB,GALF,KAAAu8D,kBAAqBr2D,GAAyBA,IAC9C,KAAAs2D,eAAkBt2D,GAAuDA,GAAS,GAElF,KAAA4pB,YAAa,WAYrB,EAAA1d,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKi6B,SAAW,IAAIhpB,IACpBjR,KAAKq7D,OAAS,GAGTtwD,QACL/K,KAAK0uB,WAAW4sC,QAChBt7D,KAAKi6B,SAASlvB,QACd/K,KAAKq7D,OAAO16D,OAAS,EAGb46D,cACRv7D,KAAKi6B,SAAS7sB,SAAShD,IACrBpK,KAAKq4B,OAAOjuB,EAAQoG,IAAI,MAGvBxQ,KAAKw7D,QACNx7D,KAAKq7D,OAAOjuD,SAAQ,CAAChD,EAASiU,KAC5Bre,KAAKw7D,OAAOpxD,EAASiU,MAKpBo9C,WAAW32D,GAChB,MAAM4pB,EAAa1uB,KAAK0uB,WAAWld,MACnCxR,KAAKo7D,gBAAgBM,IACnB,IAAIhtC,UAA+B1kB,IAAd0xD,IAA4BA,EAC/C,OAAO52D,GAAS,GAGlB9E,KAAKu7D,cAELz2D,GAAS,MAINqtC,IAAI3hC,GACT,OAAOxQ,KAAKi6B,SAASkY,IAAI3hC,GAGpBgB,IAAIhB,GACT,OAAOxQ,KAAKi6B,SAASzoB,IAAIhB,GAGpBmrD,SACL,OAAO37D,KAAKi6B,SAGP56B,IACLmR,EACAorD,GAAQ,EACRT,EACAU,EAAcD,GAEd,IAAIxxD,EAAUpK,KAAKwR,IAAIhB,GACvB,GAAGpG,EACD,OAAOA,EAGT,MAAM0xD,EAA0B,CAC9BtrD,GAAAA,EACA8U,MAAO,GAOT,OAJAlb,EAAUpK,KAAK+7D,gBAAgBD,EAAMF,GACrC57D,KAAKi6B,SAAShd,IAAIzM,EAAIpG,GACtBpK,KAAKq4B,OAAO7nB,EAAIqrD,EAAazxD,EAAS+wD,GAE/B/wD,EAGFsF,OAAOc,EAAqBwrD,GACjC,MAAM5xD,EAAUpK,KAAKi6B,SAASzoB,IAAIhB,GAClC,IAAIpG,EACF,OAAO,EAGTpK,KAAKi6B,SAASvqB,OAAOc,GAErB,MAAM6N,EAAMre,KAAKq7D,OAAO7kD,QAAQpM,GAKhC,IAJY,IAATiU,GACDre,KAAKq7D,OAAO98C,OAAOF,EAAK,GAGvBre,KAAKi8D,SACN,GAAGD,EACDh8D,KAAKi8D,SAAS7xD,OACT,CACL,MAAMskB,EAAa1uB,KAAK0uB,WAAWld,MACnCxR,KAAKm7D,mBAAkB,KACjBzsC,KAIJ1uB,KAAKi8D,SAAS7xD,MAKpB,OAAO,EAGIiuB,OACX7nB,EACAorD,GAAQ,EACRxxD,EAAUpK,KAAKwR,IAAIhB,GACnB2qD,G,qCAEA,IAAI/wD,EACF,OAGFA,EAAQkb,YAActlB,KAAKk8D,SAAS9xD,GACpCpK,KAAKm8D,UAAYn8D,KAAKm8D,SAAS/xD,GAE/B,MAAMiU,GAAM,EAAA+9C,GAAA,GAA2Bp8D,KAAKq7D,OAAQjxD,EAAS,SAC7D,IAAIwxD,GAAS57D,KAAKw7D,OAAQ,CACxB,MAAM9sC,EAAa1uB,KAAK0uB,WAAWld,OAClC2pD,GAAqBn7D,KAAKm7D,oBAAmB,KACxCzsC,KAKJ1uB,KAAKw7D,OAAOpxD,EAASiU,Q,2kBChJd,MAAMg+C,WAAuBnB,GAc1Ct7D,YAAYhB,GAgEV,IAAIqP,EApDJpO,MAAM,CACJq8D,SAAUt9D,EAAQs9D,UAAY,CAAE9xD,GAAYpK,KAAK2S,SAAS2I,gBAAgBghD,qBAAqBlyD,EAAQoG,KACvGyrD,SAAW7xD,IACTA,EAAQ+Q,IAAI49B,OAAOz4C,SACnBN,KAAKu8D,oBAAsBv8D,KAAKu8D,sBAElCJ,SAAUv9D,EAAQu9D,UAAY,CAAO/xD,GAAY,mCAC/C,MAAMuO,EAASL,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQnR,EAAQoG,MACvF,EAAA5C,EAAA,GAAexD,EAAQ+Q,IAAIE,gBAAiB1C,OAE9C6iD,OAAQ,CAACpxD,EAASiU,KAChB,MAAMm+C,EAAmBpyD,EAAQ+Q,IAAI49B,OAAOn1C,gBAAkB5D,KAAK6K,KACnEiwD,GAAuB1wD,EAAQ+Q,IAAI49B,OAAQ/4C,KAAK6K,KAAMwT,GAEnDm+C,GAAoBx8D,KAAKu8D,oBAC1Bv8D,KAAKu8D,sBAGTR,gBAAkBD,IAChB,MAAM,IAAC3gD,GAAO,gBAA+B,CAC3C5O,OAAQuvD,EAAKtrD,GACbtP,WAAW,EACXqM,WAAYvN,KAAKuN,WACjB5C,WAAY3K,KAAK2K,WACjB6C,WAAW,EACX4N,cAAepb,KAAKob,cACpBqT,cAAezuB,KAAKyuB,gBAItB,OADCqtC,EAAoB3gD,IAAMA,EACpB2gD,GAETX,kBAAmB,MACnBC,eAAsBt2D,GAAa,mCACjC,OAAI,EAAAilB,GAAA,GAAQ/pB,KAAK6K,aAIX,YAEF,EAAAkf,GAAA,GAAQ/pB,KAAK6K,WAIjB/F,GAAS,GAHAA,GAAS,IANTA,GAAS,QAxDd,KAAAyI,WAAa,GACb,KAAA6N,eAAgB,EAChB,KAAAzQ,YAAa,GAmErB,EAAAqG,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAK6K,KAAO,kBAAiC7K,KAAKy8D,uBAGlD,MAAMC,EAAY,KAChBzuD,EAAUnI,OAAOM,YAAW,KAC1BpG,KAAKy7D,YAAYkB,IACZA,GACDD,SAGHL,GAAeO,gBAGpBF,KAxFe,GAAAE,cAAgB,ICXnC,IAAIC,IAA4B,EAAOC,GAAmC,EACnE,SAASC,KACXD,IACD3uD,aAAa2uD,IAGfA,GAAmCh3D,OAAOM,YAAW,KACnD02D,GAAmC,EACnCD,IAA4B,IAC3B,KAEHA,IAA4B,EAGvB,SAASG,GAA0B5yD,EAAsBtF,EAA2CmE,GACzG,MAAM5J,EAAM4J,EAAiBA,EAAe5J,IAAI+K,GAAWA,EAAQhK,iBAAiB8I,KAAKkB,GACnF9J,EAAS2I,EAAiBA,EAAeg0D,aAAa/zD,KAAKD,EAAgBmB,GAAWA,EAAQ/D,oBAAoB6C,KAAKkB,GAE7H,GAAG,GAAA8yD,UAAY,KAAoB,CACjC,IAAIjvD,EAEJ,MAAMrP,EAAgC,CAAC00B,SAAS,GAE1C6pC,EAAW,KACfhvD,aAAaF,GAEb3N,EAAO,YAAa68D,EAAUv+D,GAE9B0B,EAAO,WAAY68D,EAAUv+D,GAE7B0B,EAAO,cAAe68D,EAAUv+D,IAGlCS,EAAI,cAAegB,IACdA,EAAEkH,QAAQ5G,OAAS,EACpBw8D,KAIF99D,EAAI,YAAa89D,EAAUv+D,GAC3BS,EAAI,WAAY89D,EAAUv+D,GAC1BS,EAAI,cAAe89D,EAAUv+D,GAE7BqP,EAAUnI,OAAOM,YAAW,KACvBy2D,GACDM,KAIFr4D,EAASzE,EAAEkH,QAAQ,IACnB41D,IAEG,eACD/yD,EAAQhK,iBAAiB,WAAY6nB,EAAA,EAAa,CAACzgB,MAAM,OAE1D,cASLnI,EAAI,cAAe,KAAsBgB,IACvCyE,EAASzE,GAEN,eACD+J,EAAQhK,iBAAiB,WAAY6nB,EAAA,EAAa,CAACzgB,MAAM,KAEzD1C,G,eCnEO,SAASs4D,GAAsBx+D,GAC5C,IAAIy+D,GAAU,EACd,OAAO,IAAIjb,GAAa,OAAD,wBAClBxjD,GAAO,CACVmkD,kBAAoB1iD,KACV,EAAAs5B,GAAA,GAAgBt5B,EAAE8G,OAAQ,oBAC/B,EAAAm2D,GAAA,GAAoBj9D,MACpBzB,EAAQmkD,mBAAoBnkD,EAAQmkD,kBAAkB1iD,IAE3DkjD,QAAS,CAACL,EAAOC,EAAO9iD,KACtB,IAAIg9D,GAAW16D,KAAKoE,IAAIo8C,GAAS,GAC/B,OAAO,EAGT,GAAGxgD,KAAKoE,IAAIm8C,GAASvgD,KAAKoE,IAAIo8C,IAC5B,EAAAl7B,EAAA,GAAY5nB,GACZg9D,GAAU,OACL,IAAIA,GAAW16D,KAAKoE,IAAIo8C,GAASxgD,KAAKoE,IAAIm8C,GAC/C,OAAO,EAOT,OAAOtkD,EAAQ2kD,QAAQL,EAAOC,EAAO9iD,IAEvCuiD,QAAS,KACPya,GAAU,EACVz+D,EAAQgkD,SAAWhkD,EAAQgkD,WAE7B36B,aAAa,KCrCF,SAASs1C,GAAe3+D,GACrC,OAAOw+D,GAAsB,OAAD,wBACvBx+D,GAAO,CACV2kD,QAAS,CAACL,EAAOC,EAAO9iD,KACtB,GAAGsC,KAAKoE,IAAIm8C,GAAS,GAInB,OAHAtkD,EAAQ2kD,QAAQL,EAAOC,EAAO9iD,GAC9B08D,MAEO,MCYf,MAAMS,GAAkB5+D,IACtB,GAAGA,EAAQwL,QAAS,OAAOxL,EAAQwL,QAEnC,MAAM,KAACnL,EAAI,KAAEQ,EAAI,QAAEuoB,EAAO,cAAEwhB,EAAa,wBAAEi0B,GAA2B7+D,EAChE2S,EAAKzS,SAASC,cAAc,OAClCwS,EAAG5S,UAAY,6BAA+BM,EAAO,UAAYA,EAAO,IAGxE,IAAIy+D,EAAc9+D,EAAQ8+D,YACtBA,IACFA,EAAc9+D,EAAQ8+D,YAAcj+D,GAAO,QAAKA,EAAMb,EAAQo7C,UAAYl7C,SAASC,cAAc,QAC9FH,EAAQ++D,cAAaD,EAAYp5D,UAAY1F,EAAQ++D,cAG1DD,EAAYt+D,UAAUC,IAAI,sBAC1BkS,EAAG7R,OAAOg+D,GAEV,MAAME,IAAap0B,KAAmB5qC,EAAQg/D,SA8B9C,OA3BA51C,IAAW,QAAiBzW,GAAsDlR,KAChF,EAAA4nB,EAAA,GAAY5nB,GAEZ,MAAMw9D,GAAO,EAAAlkC,GAAA,GAAgBt5B,EAAE8G,OAAQ,YACpC02D,IAASA,EAAKz+D,UAAUiG,SAAS,YAMtB,IAFC2iB,EAAQ3nB,KAMnBu9D,GACF,kBAGCp0B,IAAkBi0B,IACnBj0B,EAAcJ,QAAuC,UAA7BI,EAAczpC,MAAME,OAA2BupC,EAAcJ,YAEtExqC,EAAQA,SAExB4qC,GACDj4B,EAAG7R,OAAO8pC,EAAcjwB,OAGnB3a,EAAQwL,QAAUmH,GAwB3B,GArBmB,CAAC47B,EAAkClkC,KACpD,MAAMsI,EAAKzS,SAASC,cAAc,OAClCwS,EAAGnS,UAAUC,IAAI,YAEd4J,GACDkkC,EAAQ//B,SAAS29C,IACZA,EAAEnsD,QACHmsD,EAAEnsD,QAAQqK,eAAiBA,EAE3B8hD,EAAEnsD,QAAU,CAACqK,eAAAA,MAKnB,MAAMwT,EAAQ0wB,EAAQxyB,IAAI6iD,IAI1B,OAFAjsD,EAAG7R,UAAU+c,GAENlL,GCxFM,MAAMusD,WAAqB3nB,GACxCv2C,YACEm+D,EACA1nB,EACA2nB,GAAmB,GAEnBn+D,MAAM,CACJ02C,UAAW,CAAC,UAAW,YACvBF,SAAU2nB,EAAmB3nB,EAAiB9pC,IAAW,O,EAAA,K,OAAA,E,EAAA,YACvD,GAAG8pC,EAAU,CACX,MAAMvpC,EAAMupC,EAAS9pC,GAClBO,aAAe3J,gBACV2J,GAIV,gBAA0B,CAACP,OAAAA,IAC3B,kCAA4CwxD,I,YATW,K,+QAWzDhwD,YAAa,uCACbmmC,iBAAkB,gBAClBvC,aAAc,kB,2SCfL,MAAMssB,GACnBr+D,YAAoB2M,EAAwB4sB,EAAwBl5B,EAAwBi+D,GAAxE,KAAA3xD,OAAAA,EAAwB,KAAA4sB,KAAAA,EAAwB,KAAAl5B,KAAAA,EAAwB,KAAAi+D,UAAAA,EAC1Fl+D,KAAKyoB,YAGOA,Y,0CACZ,IAAI,OAAClc,EAAM,KAAE4sB,EAAI,KAAEl5B,EAAI,UAAEi+D,GAAal+D,KAEtC,MAAMu5C,EAAmB,IAAIjhB,GAAU,CAAC/rB,OAAAA,IAASnC,QAE3CuI,EAAW,aAEjBwmB,EAAOA,EAAKz4B,QACZ,MAAMoE,EAAW,CAACskC,EAA4C+0B,KAC5DD,GAAaA,IACD,cAATj+D,EACD0S,EAAS40B,mBAAmB62B,wBAAwB7xD,EAAQ4sB,GAE5DxmB,EAAS40B,mBAAmB82B,eAAe9xD,EAAQ4sB,IAAQiQ,EAAQpoC,MAAQm9D,IAI/E,IAAIrvD,EAAoBwvD,EAAkB3wB,EAA0BmM,EAAwB3M,EAAsCW,EAA6C,GAoB/K,GAnBmB,IAAhB3U,EAAKx4B,OACNmO,EAAQ,6BAERA,EAAQ,sBACRwvD,EAAY,EAAC,QAAK,WAAY,CAACnlC,EAAKx4B,WAIpCgtC,SADOh7B,EAAS2/B,gBAAgBisB,YAAYhyD,IACd,IAAhB4sB,EAAKx4B,OAAe,oCAAsC,kCAE1C,IAAhBw4B,EAAKx4B,OAAe,gCAAkC,8BAGtEwsC,EAAU,CAAC,CACT5B,QAAS,SACTwO,UAAU,EACVj1C,SAAAA,IAGCyH,IAAW,UAA2B,cAATtM,QAG9B,GAAGsM,EAAO46B,SACR2G,EAAWj8B,KAAK,CACdpS,KAAM,2BACNu6C,SAAU,CAACT,SAER,CACL,MAAMnX,QAAazvB,EAASoH,gBAAgB00B,QAAQliC,EAAO8hB,YAErDmwC,GAAa,EAAA/pB,GAAA,GAAUrS,EAAM,mBACnC,GAAc,SAAXA,EAAKx1B,EAAc,CACpB,MAAM6xD,EAAYD,EAAarlC,EAAKz4B,cAAgB6vC,GAAYpX,GAAYlsB,GAAQ,mCAElF,aADsB0F,EAAS40B,mBAAmBuvB,iBAAiBvqD,EAAQU,IAC5DK,SAAW,cAGzBmxD,EAAU99D,SACR89D,EAAU99D,SAAWw4B,EAAKx4B,OAC3BmtC,EAAWj8B,KAAK,CACdpS,KAAM,kBAGRquC,EAAWj8B,KAAK,CACdpS,KAAM,yBAGRkuC,EAAc,0BACdmM,EAAkB,EAAC,QAAK,WAAY,CAAC2kB,EAAU99D,iBAKnDwsC,EAAQ,GAAGroC,SAAYskC,GAAYtkC,EAASskC,GAAS,IAK3D,OAAgB+D,GAEF,IAAID,GAAU,oBAAqB,CAC/C3gC,OAAAA,EACAy9B,aAAcl7B,EACd2+B,cAAe6wB,EACf5wB,mBAAoBC,EACpBE,oBAAqBiM,EACrB3M,QAAAA,EACAW,WAAAA,IAGIoB,WCpGK,MAAMwvB,WAAqBxxB,GACxCttC,YAAY2M,EAAgB4sB,EAAgB+kC,GAC1Cr+D,MAAM,oBAAqB,CACzBiP,MAAO,eAAeqqB,EAAKx4B,OAAS,EAAI,IAAM,SAC9CgtC,YAAaxU,EAAKx4B,OAAS,EAAI,QAAUw4B,EAAKx4B,OAAS,iBAAmB,oBAC1EwsC,QAAS,CAAC,CACR5B,QAAS,OACTzmC,SAAU,KACRo5D,GAAaA,IACbl+D,KAAK2S,SAAS40B,mBAAmBo3B,sBAAsBpyD,EAAQ4sB,QAKrEn5B,KAAKkvC,Q,eChBM,SAAS0vB,KACnB94D,OAAO+4D,aACL/4D,OAAO+4D,eAAeC,MACvBh5D,OAAO+4D,eAAeC,QACdh5D,OAAO+4D,eAAeE,iBAC9Bj5D,OAAO+4D,eAAeE,kBAGhBjgE,SAASwsD,WAEjBxsD,SAASwsD,UAAUwT,Q,sTC0BvB,MAAME,GAAoBrkD,GACjB,IAAIA,EAAIs7B,UAAUn1B,QAAO,CAACC,EAAK8lB,IAAM9lB,EAAM8lB,EAAE7lC,MAAM,GAK5D,MAAMi+D,WAAqB,IA+BzBr/D,YAAYhB,GAWViB,OAAM,GAvCD,KAAAq/D,aAAyC,IAAIjuD,IAC7C,KAAAs6C,aAAc,EAyFb,KAAA72B,YAAer0B,IAErB,MAAM+J,GAAU,EAAAuvB,GAAA,GAAgBt5B,EAAE8G,OAAQnH,KAAKm/D,uBAC/C,GAAgB,IAAb9+D,EAAExB,OACH,OAGF,GAAGmB,KAAKo/D,eAAiBp/D,KAAKo/D,aAAa/+D,EAAG+J,GAC5C,OAGF,MAAMi1D,EAAqC,IAAIpuD,IAC/C,IAAIquD,EAaAC,EAAcn1D,EAElB,MAAMo1D,EAAiB,CAACp1D,EAAsBq1D,GAAe,KAC3D,MAAMxyD,GAAO7C,EAAQxC,QAAQqF,IAC7B,IAAIA,IAAQ7C,EAAQxC,QAAQ2E,OAAQ,OACpC,MAAMA,EAASnC,EAAQxC,QAAQ2E,OAAOsO,YAElC,EAAAkP,GAAA,GAAQw1C,KACVA,EAAcn1D,GAGhB,IAAIs1D,EAAUL,EAAK7tD,IAAIjF,GAKvB,GAJImzD,GACFL,EAAKpiD,IAAI1Q,EAAQmzD,EAAU,IAAI9gD,KAG9B8gD,EAAQvtB,IAAIllC,GACb,OAGF,MAAM0yD,EAAa3/D,KAAK4/D,cAAcrzD,EAAQU,GAQ9C,QAPiBjD,IAAds1D,IAEDA,GAAaK,GAGfD,EAAQrgE,IAAI4N,GAERqyD,IAAcK,IAAiBL,GAAaK,EAAa,CAC3D,MAAME,EAAab,GAAiBK,GACpC,GAAGr/D,KAAKwrD,iBAAmBiU,EAAc,CACpCI,EAAa,IACX,EAAAC,GAAA,GAAc11D,EAASm1D,KACxBA,EAAcn1D,GAIlB,MAAM21D,EAAkB//D,KAAKggE,mBAAmBT,EAAan1D,GAE1D21D,EAAgBp/D,QACjBo/D,EAAgB3yD,SAAShD,IACvBo1D,EAAep1D,GAAS,MAK9B,GAAIpK,KAAKk/D,aAAal+D,KAQZhB,KAAKwrD,iBACbxrD,KAAKwrD,gBAAgBphD,QARrB,GAAkB,IAAfy1D,GAAoB7/D,KAAKigE,YAC1B,IAAI,MAAO1zD,EAAQ4sB,KAASkmC,EAC1B,IAAI,MAAMpyD,KAAOksB,EACfn5B,KAAKigE,YAAY1zD,EAAQU,KAWrC,IAAIizD,GAAoB,EACxB,MAAM7rC,EAAeh0B,IACf6/D,IACFtB,KACAsB,GAAoB,GAYtB,MAAM91D,EAAUpK,KAAKmgE,qBAAqB9/D,EAAE8G,QAC5C,GAAIiD,EAKJ,OAAGpK,KAAKogE,wBAA0BpgE,KAAKogE,sBAAsB//D,EAAG+J,EAASk1D,IACvEt/D,KAAKiJ,eAAeg0D,aAAaj9D,KAAKqgE,cAAe,YAAahsC,QAClEr0B,KAAKiJ,eAAeg0D,aAAan+D,SAAU,UAAW21B,EAAW6rC,SAInEd,EAAep1D,IAGXqqB,EAAap0B,IACdg/D,EAAKr+D,OACN,QAAiB8E,OAAQmiB,EAAA,EAAa,CAACqL,SAAS,EAAM9rB,MAAM,EAAMG,SAAS,IAG7E3H,KAAKiJ,eAAeg0D,aAAaj9D,KAAKqgE,cAAe,YAAahsC,GAIlEuqC,MAGI0B,EAA0B,CAAC94D,MAAM,GACvCxH,KAAKiJ,eAAe5J,IAAIW,KAAKqgE,cAA7BrgE,CAA4C,YAAaq0B,GACzDr0B,KAAKiJ,eAAe5J,IAAIP,SAAxBkB,CAAkC,UAAWy0B,EAAW6rC,IAGlD,KAAAN,mBAAqB,CAAC37C,EAAoBk8B,KAChD,GAAGl8B,IAAUk8B,EACX,MAAO,GAGT,MAAMggB,EAAYl8C,EAAM5d,wBAClB+5D,EAAWjgB,EAAK95C,wBAEhBg6D,GADcF,EAAU15D,IAAM25D,EAAS35D,KAAS05D,EAAU55D,KAAO65D,EAAS75D,MAClD,EAExB+5D,GAAS,EAAA/mC,GAAA,GAAgBtV,EAAOrkB,KAAK2gE,8BAC3C,IAAID,EACF,MAAO,GAGT,MAAMzmC,EAAW7oB,MAAMC,KAAKqvD,EAAOpvD,iBAAiBtR,KAAK4gE,6BACzD,IAAIC,EAAa5mC,EAASzjB,QAAQ6N,GAC9By8C,EAAY7mC,EAASzjB,QAAQ+pC,GAUjC,OARIkgB,KACDK,EAAWD,GAAc,CAACA,EAAYC,IAG3B7mC,EAASv5B,MAAMmgE,EAAa,EAAGC,IAkIxC,KAAAlC,gBAAwBmC,GAA2B,mCACrDA,IAAc/gE,KAAK+gE,cAAe,GACrC/gE,KAAKghE,0BAA2BhhE,KAAKghE,qBACrChhE,KAAKk/D,aAAan0D,QAClB/K,KAAKihE,kBACLrC,KACGmC,IAAc/gE,KAAK+gE,kBAAe/2D,OAtVrC,EAAAgH,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKuQ,eAAiB,gBAAiB,UAGlC2wD,gBAAgBb,EAA4Bp3D,GAQjD,GAPGjJ,KAAKqgE,eACNrgE,KAAKiJ,eAAe0G,YAGtB3P,KAAKqgE,cAAgBA,EACrBrgE,KAAKiJ,eAAiBA,EAElBo3D,EAIJ,OAAG,MACDp3D,EAAe5J,IAAIghE,EAAnBp3D,CAAkC,YAAY,KACxCjJ,KAAKurD,cACTvrD,KAAKmhE,aCzGRr7D,OAAO+4D,aACD/4D,OAAO+4D,eAAenuB,WAErB5xC,SAASwsD,UAEVxsD,SAASwsD,UAAU8V,cAAc3hE,KAGnC,YDoGHu9D,GAA0BqD,GAAgBhgE,IACxC,GAAGL,KAAKurD,aAAgBvrD,KAAKqhE,uBAAyBrhE,KAAKqhE,uBAAyB,OAGpFviE,SAAS8rC,KAAKxrC,UAAUC,IAAI,aAC5BghE,EAAcjgE,iBAAiB,YAAaC,KAC1C,EAAA4nB,EAAA,GAAY5nB,GACZvB,SAAS8rC,KAAKxrC,UAAUkB,OAAO,eAG9B,CAACkH,MAAM,EAAM8rB,SAAS,IAEzBsrC,KAEA,MAAMx0D,EAAUpK,KAAKmgE,qBAAqB9/D,EAAE8G,QACzCiD,GACDpK,KAAKwrD,gBAAgBphD,KAEtBnB,SAKLA,EAAe5J,IAAIghE,EAAnBp3D,CAAkC,YAAajJ,KAAK00B,aAuK5C4sC,0BAA0Bl3D,GAClC,OAAOpK,KAAK4/D,cAAcx1D,EAAQxC,QAAQ2E,OAAOsO,YAAazQ,EAAQxC,QAAQqF,KAGtEs0D,eAAen3D,EAAsBo/B,GAC7Cp/B,EAAQvG,QAAQ2lC,EAAcjwB,OAGzBioD,sBAAsBp3D,EAAsB8kC,GACjD,MAAMuyB,IAAgBzhE,KAAK0hE,4BAA4Bt3D,GACvD,GAAG8kC,EAAM,CACP,GAAGuyB,EACD,OAAO,EAGT,MAAMj4B,EAAgB,IAAI,KAAc,CACtC/lC,KAAM2G,EAAQxC,QAAQqF,IACtBpK,OAAO,IAIN7C,KAAKurD,aACHvrD,KAAKshE,0BAA0Bl3D,KAChCo/B,EAAczpC,MAAMqpC,SAAU,EAC9Bh/B,EAAQhL,UAAUC,IAAI,gBAI1BW,KAAKuhE,eAAen3D,EAASo/B,QACrBi4B,IACRzhE,KAAK0hE,4BAA4Bt3D,GAASxG,cAActD,UACxD,QAAc8J,EAAS,eAAe,EAAO,MAG/C,OAAO,EAGCs3D,4BAA4Bt3D,G,MACpC,MAA8C,WAAd,QAAzB,EAAAA,EAAQ2e,yBAAiB,eAAE1hB,UAChC+C,EAAQ2e,kBAAkBA,kBAGd44C,gBAAgBC,GAAiB,G,0CAC/C,MAAM5gE,EAAOhB,KAAKk/D,aAAal+D,KAC/B,IAAIA,IAAS4gE,EAAgB,OAE7B,IAAIC,GAAe7gE,EACjB8gE,GAAc9gE,EACd+gE,GAAY/gE,EACd,IAAI,MAAOuL,EAAQ4sB,KAASn5B,KAAKk/D,aAAc,CAC7C,MAAM9H,EAAiC,GAAG7qD,KAAUvM,KAAKgiE,YAAc,YAAc,YAC/E58D,QAAUpF,KAAK2S,SAAS40B,mBAAmB06B,sBAAsB7K,EAAYhmD,MAAMC,KAAK8nB,IAI9F,GAHA0oC,EAAcz8D,EAAEy8D,YAChBC,EAAa18D,EAAE08D,WAEZD,GAAeC,EAAY,MAGhC9hE,KAAKkiE,mBAAqBliE,KAAKkiE,kBAAkBL,EAAaC,EAAYC,MAGrEd,gBAAgBkB,GAAmB,EAAMP,GAAiB,GAC/D,MAAMQ,EAAepiE,KAAKurD,YACpBvqD,EAAOhB,KAAKk/D,aAAal+D,KAG/B,GAFAhB,KAAKurD,cAAgBvqD,GAAQ4gE,EAE1BQ,IAAiBpiE,KAAKurD,YAAa,OAAO,EAE7CvrD,KAAKgQ,cAAc,SAAUhQ,KAAKurD,aAY9B,OACFvrD,KAAKqgE,cAAcjhE,UAAUoE,OAAO,YAAaxD,KAAKurD,aAEnD6W,GAEDxD,OAaJ,EAAAyD,GAAA,KAEA,MAAMC,IAAathE,GAAQ4gE,EAoB3B,OAnBA5hE,KAAKuiE,mBAAqBviE,KAAKuiE,kBAAkBD,GAAWtiE,KAAK+gE,cAE7D,GAAAlf,mBACCygB,EACDhyD,EAAA,WAAiC,CAC/BrQ,KAAMD,KAAKuQ,eACXoB,MAAO,KACL3R,KAAK4+D,qBAITtuD,EAAA,eAAqCtQ,KAAKuQ,iBAI3CqxD,GACD5hE,KAAK2hE,gBAAgBC,IAGhB,EAYF3xD,UACLjQ,KAAK+gE,cAAe,EACpB/gE,KAAKk/D,aAAan0D,QAClB/K,KAAKihE,iBAAgB,GACrBjhE,KAAK+gE,kBAAe/2D,EAGZw4D,uBAAuBp4D,EAAsBu1D,GACrD3/D,KAAKwhE,sBAAsBp3D,GAAS,GACtBpK,KAAK0hE,4BAA4Bt3D,GACzCg/B,QAAUu2B,EAEhB3/D,KAAKihE,kBACLjhE,KAAK2hE,mBACL,QAAcv3D,EAAS,cAAeu1D,EAAY,KAG7CC,cAAcrzD,EAAgBU,GACnC,MAAMgQ,EAAMjd,KAAKk/D,aAAa1tD,IAAIjF,GAClC,OAAO0Q,MAAAA,OAAG,EAAHA,EAAKk1B,IAAIllC,GAGXtM,SACL,OAAOq+D,GAAiBh/D,KAAKk/D,cAGrBuD,UAAUl2D,EAAgBU,EAAay1D,GAC/C,IAAIzlD,EAAMjd,KAAKk/D,aAAa1tD,IAAIjF,GAqChC,OApCGm2D,QAA0B14D,IAAb04D,IAA0BzlD,MAAAA,OAAG,EAAHA,EAAKk1B,IAAIllC,IAC9CgQ,IACDA,EAAIvN,OAAOzC,GAEPgQ,EAAIjc,MACNhB,KAAKk/D,aAAaxvD,OAAOnD,KAuBzB0Q,IACFA,EAAM,IAAI2B,IACV5e,KAAKk/D,aAAajiD,IAAI1Q,EAAQ0Q,IAGhCA,EAAI5d,IAAI4N,KAGH,EAMF01D,mBAAmBp2D,EAAgB4sB,GACxC,MAAMlc,EAAMjd,KAAKk/D,aAAa1tD,IAAIjF,GAC9B0Q,IAIJkc,EAAK/rB,SAASH,IACZgQ,EAAIvN,OAAOzC,MAGTgQ,EAAIjc,MACNhB,KAAKk/D,aAAaxvD,OAAOnD,GAG3BvM,KAAK2hE,kBACL3hE,KAAKihE,oBAIF,MAAM2B,WAAwB3D,GASnCr/D,YAAoBiqD,EAA6Bl3C,GAC/C9S,MAAM,CACJ8S,SAAAA,EACAysD,aAAc,CAAC/+D,EAAG8G,MAAaA,GAAUnH,KAAKurD,YAC9C4U,qBAAuBh5D,IAAW,EAAAwyB,GAAA,GAAgBxyB,EAAQ,qBAC1Dg4D,sBAAuB,oBACvBwB,6BAA8B,WAC9BC,2BAA4B,uBAPZ,KAAA/W,YAAAA,EAqCb,KAAA2B,gBAAmBphD,IACxB,MAAM6C,GAAO7C,EAAQxC,QAAQqF,IACvBV,EAASnC,EAAQxC,QAAQ2E,OAAOsO,WAElC7a,KAAKyiE,UAAUl2D,EAAQU,IAI3BjN,KAAKwiE,uBAAuBp4D,EAASpK,KAAK4/D,cAAcrzD,EAAQU,KAG3D,KAAAgzD,YAAc,CAAC1zD,EAAgBU,KACpC,MAAM7C,EAAUpK,KAAK6pD,YAAYc,SAASkY,WAAW39D,cAAc,oCAAoCqH,iBAAsBU,OAC7HjN,KAAKwrD,gBAAgBphD,IAGb,KAAA83D,kBAAoB,CAACL,EAAsBC,EAAqBC,KACxE,MAAMphE,EAASX,KAAKW,UACpB,EAAAiN,EAAA,GAAe5N,KAAK8iE,kBAAkB,QAAK,WAAY,CAACniE,KACxDX,KAAK+iE,iBAAiB3jE,UAAUoE,OAAO,OAAmB,IAAX7C,GAC/CX,KAAKgjE,oBAAoB5jE,UAAUoE,OAAO,OAAQq+D,GAClD7hE,KAAKijE,oBAAsBjjE,KAAKijE,mBAAmB7jE,UAAUoE,OAAO,OAAQs+D,IAGpE,KAAAS,kBAAoB,CAACD,EAAmB7xD,KAchD,IAbA,QAAczQ,KAAK6pD,YAAYqZ,uBAAwB,eAAgBZ,EAAU7xD,EAAU,IAAM,GAAG,KAC9FzQ,KAAKurD,cACPvrD,KAAKmjE,mBAAmB7iE,SACxBN,KAAKmjE,mBACHnjE,KAAKgjE,oBACLhjE,KAAKijE,mBACL,KACFjjE,KAAKmhE,kBAAen3D,OAIxB,QAAchK,KAAK6pD,YAAY3oD,UAAW,eAAgBohE,EAAU,KAEjEtiE,KAAKurD,cACFvrD,KAAKmjE,mBAAoB,CAC3B,MAAMvf,EAAa,yBACnB5jD,KAAKmjE,mBAAqBrkE,SAASC,cAAc,OACjDiB,KAAKmjE,mBAAmB/jE,UAAUC,IAAIukD,EAAa,cAEnD,MAAMwf,EAAY,EAAW,SAASxf,WAAqB,CAAC1kD,UAAU,IACtEc,KAAKiJ,eAAe5J,IAAI+jE,EAAxBpjE,CAAmC,SAAS,IAAMA,KAAK4+D,mBAAmB,CAACp3D,MAAM,IAEjFxH,KAAK8iE,iBAAmBhkE,SAASC,cAAc,OAC/CiB,KAAK8iE,iBAAiB1jE,UAAUC,IAAIukD,EAAa,UAEjD5jD,KAAK+iE,iBAAmB,EAAW,WAAWnf,UAE9C,MAAMyf,EAAyC,CAACp6D,eAAgBjJ,KAAKiJ,iBACrE,QAAiBjJ,KAAK+iE,kBAAkB,KACtC,MAAMx2D,EAAS,IAAIvM,KAAKk/D,aAAaxhD,QAAQ,GACvCzQ,EAAM,IAAIjN,KAAKk/D,aAAa1tD,IAAIjF,IAAS,GAC/CvM,KAAK4+D,kBAEL,gBAA0B,CAACryD,OAAAA,EAAQ+2D,UAAWr2D,MAC7Co2D,GAEHrjE,KAAKgjE,oBAAsB,EAAW,WAAWpf,cACjD,QAAiB5jD,KAAKgjE,qBAAqB,KACzC,MAAMO,EAAwC,GAC9C,IAAI,MAAOC,EAAYrqC,KAASn5B,KAAKk/D,aACnCqE,EAAIC,GAAcpyD,MAAMC,KAAK8nB,GAAMmiB,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IAGxD,IAAI+S,GAAayF,GAAK,KACpBvjE,KAAK4+D,uBAENyE,GAEArjE,KAAKyjE,YACNzjE,KAAKijE,mBAAqB,EAAW,iBAAiBrf,aACtD,QAAiB5jD,KAAKijE,oBAAoB,KACxC,MAAM12D,EAAS,IAAIvM,KAAKk/D,aAAaxhD,QAAQ,GAC7C,IAAIugD,GAAoB1xD,EAAQ,IAAIvM,KAAKk/D,aAAa1tD,IAAIjF,IAAU,QAAQ,KAC1EvM,KAAK4+D,uBAENyE,IAGLrjE,KAAKmjE,mBAAmBzjE,UAAU,CAChC0jE,EACApjE,KAAK8iE,iBACL9iE,KAAK+iE,iBACL/iE,KAAKgjE,oBACLhjE,KAAKijE,oBACLt3C,OAAO6kB,UAET,MAAMkzB,EAAoB1jE,KAAKmjE,mBAC/BO,EAAkBzgE,MAAM0gE,QAAU,IAClC3jE,KAAK6pD,YAAYqZ,uBAAuBxjE,OAAOgkE,GAE1CA,EAAkBve,WACvBue,EAAkBzgE,MAAM0gE,QAAU,KA3HtC3jE,KAAKyjE,WAAa5Z,EAAYtvB,WAC9Bv6B,KAAKkhE,gBAAgBrX,EAAY3oD,UAAW,IAAI,KAa3C+/D,gBAAgBkB,GAAmB,EAAMP,GAAiB,GAC/D,MAAMziB,EAAMt/C,MAAMohE,gBAAgBkB,EAAkBP,GASpD,OAPGziB,GAAOgjB,GACS/wD,MAAMC,KAAKrR,KAAK6pD,YAAY34C,cAAcI,iBAAiB,uBACnElE,SAAShD,IAChBpK,KAAKwhE,sBAAsBp3D,EAASpK,KAAKurD,gBAItCpM,GAyGI,MAAMykB,WAAsB3E,GAUzCr/D,YACUwiC,EACAqJ,EACA1rC,EACR4S,GAEA9S,MAAM,CACJ8S,SAAAA,EACAwtD,qBAAuBh5D,IAAW,EAAAwyB,GAAA,GAAgBxyB,EAAQ,kBAAmB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,UACrGi4D,aAAc,CAAC/+D,EAAG8G,OAGHnH,KAAKk/D,aAAal+D,OACxBX,EAAE8G,OAAuB/H,UAAUiG,SAAS,YAC5ChF,EAAE8G,OAAuB/H,UAAUiG,SAAS,uBAC9C8B,GAIPi5D,sBAAuB,CAAC//D,EAAG+J,EAASk1D,MACtBj/D,EAAE8G,SAAWiD,IACrB/J,EAAE8G,OAAuB/H,UAAUiG,SAAS,4BAChC2E,IAAds1D,IACCt/D,KAAKk/D,aAAal+D,MAGvBqgE,qBAAsB,KAAOrhE,KAAKoiC,KAAKriC,MAAM8jE,UAC7C1E,sBAAuB,SACvBwB,6BAA8B,gBAC9BC,2BAA4B,qDAC5BoB,YAA2B,cAAd5/B,EAAKniC,OA7BZ,KAAAmiC,KAAAA,EACA,KAAAqJ,QAAAA,EACA,KAAA1rC,MAAAA,EAwEH,KAAAyrD,gBAAmBnkB,IACxB,IAAIrnC,KAAK8jE,gBAAgBz8B,GAAS,OAElC,MAAMp6B,GAAOo6B,EAAOz/B,QAAQqF,IAG5B,GADkBo6B,EAAOjoC,UAAUiG,SAAS,cAC5C,CACE,IAAIrF,KAAK+jE,wBAAwB18B,GAAS,CACxC,MAAMpqB,EAAMjd,KAAKk/D,aAAa1tD,IAAIxR,KAAKoiC,KAAK71B,QACzC0Q,GAEYjd,KAAKgkE,0BAA0B38B,GACvCj6B,SAASH,GAAQgQ,EAAIvN,OAAOzC,KAIdjN,KAAKyrC,QAAQw4B,sBAAsB58B,GAAQ1sB,IAAI3a,KAAKwrD,sBAK7E,GAAIxrD,KAAKyiE,UAAUziE,KAAKoiC,KAAK71B,OAAQU,GAArC,CAKA,GADsBo6B,EAAOjoC,UAAUiG,SAAS,gBAC9B,CAChB,MAAM6+D,GAAiB,EAAAvqC,GAAA,GAAgB0N,EAAQ,UACzC88B,EAAoBnkE,KAAK+jE,wBAAwBG,GACjDE,EAAwBpkE,KAAKokE,sBAAsBF,IAEtCE,GAAyBD,IAE1CnkE,KAAKwiE,uBAAuB0B,EAAgBE,GAIhDpkE,KAAKwiE,uBAAuBn7B,EAAQrnC,KAAK4/D,cAAc5/D,KAAKoiC,KAAK71B,OAAQU,MAGjE,KAAAgzD,YAAc,CAAM1zD,EAAgBU,IAAgB,mCAC5D,MAAMo3D,QAAgBrkE,KAAKyrC,QAAQ64B,iBAAiBr3D,GACjDo3D,GACDrkE,KAAKwrD,gBAAgB6Y,EAAQh9B,WAyDvB,KAAAk7B,kBAAoB,CAAMD,EAAmB7xD,IAAqB,mCAC1E,MAAM,eAAC8zD,EAAc,UAAEC,EAAS,QAAEC,SAAiBzkE,KAAKoiC,KAAKriC,MAAM2kE,OAAOj0D,IAE1E,QAAczQ,KAAKqgE,cAAe,eAAgBiC,EAAU7xD,EAAU,IAAM,GAAG,KACzEzQ,KAAKurD,cACPvrD,KAAK2kE,sBAAsBrkE,SAC3BN,KAAK2kE,sBACH3kE,KAAKmjE,mBACLnjE,KAAK4kE,oBACL5kE,KAAKgjE,oBACLhjE,KAAKijE,mBACLjjE,KAAK6kE,cACL7kE,KAAK8kE,eACL,KACF9kE,KAAKmhE,kBAAen3D,MAUxB,MAAM+6D,EAAoBP,EAAYC,OAAUz6D,EAA6B,EAAjBu6D,EAC5D,GAAGvkE,KAAKurD,aACN,IAAIvrD,KAAKmjE,mBAAoB,CAC3BnjE,KAAK2kE,sBAAwB7lE,SAASC,cAAc,OACpDiB,KAAK2kE,sBAAsBvlE,UAAUC,IAAI,qBAAsB,qBAK/DW,KAAKmjE,mBAAqBrkE,SAASC,cAAc,OACjDiB,KAAKmjE,mBAAmB/jE,UAAUC,IAAI,uBAEtC,MAAMgkE,EAAyC,CAACp6D,eAAgBjJ,KAAKiJ,gBAC/Dm6D,EAAY,EAAW,QAAS,CAAClkE,UAAU,KACjD,QAAiBkkE,GAAW,IAAMpjE,KAAK4+D,mBAAmB,CAACp3D,MAAM,EAAMyB,eAAgBjJ,KAAKiJ,iBAE5FjJ,KAAK8iE,iBAAmBhkE,SAASC,cAAc,OAC/CiB,KAAK8iE,iBAAiB1jE,UAAUC,IAAI,6BAEd,cAAnBW,KAAKoiC,KAAKniC,MACXD,KAAK4kE,qBAAsB,OAAO,2EAA4E,CAAC3lE,KAAM,UACrHe,KAAK4kE,oBAAoBllE,QAAO,QAAK,yBACrC,QAAiBM,KAAK4kE,qBAAqB,KACzC,IAAIlG,GAAa1+D,KAAKoiC,KAAK71B,OAAQ,IAAIvM,KAAKk/D,aAAa1tD,IAAIxR,KAAKoiC,KAAK71B,UAAU,KAC/EvM,KAAK4+D,uBAENyE,KAEHrjE,KAAKgjE,qBAAsB,OAAO,oEAAqE,CAAC/jE,KAAM,YAC9Ge,KAAKgjE,oBAAoBtjE,QAAO,QAAK,aACrC,QAAiBM,KAAKgjE,qBAAqB,KACzC,MAAMO,EAAwC,GAC9C,IAAI,MAAOC,EAAYrqC,KAASn5B,KAAKk/D,aACnCqE,EAAIC,GAAcpyD,MAAMC,KAAK8nB,GAAMmiB,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IAGxD,IAAI+S,GAAayF,GAAK,KACpBvjE,KAAK4+D,uBAENyE,IAGLrjE,KAAKijE,oBAAqB,OAAO,0EAA2E,CAAChkE,KAAM,WACnHe,KAAKijE,mBAAmBvjE,QAAO,QAAK,YACpC,QAAiBM,KAAKijE,oBAAoB,KACxC,IAAIhF,GAAoBj+D,KAAKoiC,KAAK71B,OAAQ,IAAIvM,KAAKk/D,aAAa1tD,IAAIxR,KAAKoiC,KAAK71B,SAAUvM,KAAKoiC,KAAKniC,MAAM,KACtGD,KAAK4+D,uBAENyE,GAEH,MAAM18D,EAAO3G,KAAK6kE,cAAgB/lE,SAASC,cAAc,OACzD4H,EAAKvH,UAAUC,IAAI,4BACnBsH,EAAKjH,OAAO0jE,EAAWpjE,KAAK8iE,kBAE5B,MAAMx9B,EAAQtlC,KAAK8kE,eAAiBhmE,SAASC,cAAc,OAC3DumC,EAAMlmC,UAAUC,IAAI,6BACpBimC,EAAM5lC,UAAU,CACdM,KAAK4kE,oBACL5kE,KAAKgjE,oBACLhjE,KAAKijE,oBACLt3C,OAAO6kB,eAEgBxmC,IAAtB+6D,IACDp+D,EAAK1D,MAAMkzB,UAAY,eAAe4uC,OACtCz/B,EAAMriC,MAAMkzB,UAAY,cAAc4uC,QAGxC/kE,KAAKmjE,mBAAmBzjE,OAAOiH,EAAM2+B,GAGrCtlC,KAAK2kE,sBAAsB1hE,MAAM0gE,QAAU,IAC3C3jE,KAAK2kE,sBAAsBjlE,OAAyBM,KAAKmjE,oBACzDnjE,KAAKD,MAAMilE,eAAetlE,OAAOM,KAAK2kE,uBAEjC3kE,KAAK2kE,sBAAsBxf,WAEhCnlD,KAAK2kE,sBAAsB1hE,MAAM0gE,QAAU,GAC3Ch9D,EAAK1D,MAAMkzB,UAAY,GACvBmP,EAAMriC,MAAMkzB,UAAY,SAElBn2B,KAAK6kE,oBAAuC76D,IAAtB+6D,IAC9B/kE,KAAK6kE,cAAc5hE,MAAMkzB,UAAY,eAAe4uC,OACpD/kE,KAAK8kE,eAAe7hE,MAAMkzB,UAAY,cAAc4uC,WAI9C,KAAA7C,kBAAoB,CAACL,EAAsBC,EAAqBC,MACxE,EAAAn0D,EAAA,GAAe5N,KAAK8iE,kBAAkB,QAAK,WAAY,CAAC9iE,KAAKW,YAC7DX,KAAK4kE,qBAAuB5kE,KAAK4kE,oBAAoBl8B,gBAAgB,WAAYq5B,GACjF/hE,KAAKgjE,qBAAuBhjE,KAAKgjE,oBAAoBt6B,gBAAgB,WAAYm5B,GACjF7hE,KAAKijE,mBAAmBv6B,gBAAgB,WAAYo5B,IAG5C,KAAAd,kBAAoB,IAAW,uCAlQlCO,eAAel6B,EAAqBmC,GACzCA,EAAcjwB,MAAMna,UAAUC,IAAI,0BAE/BgoC,EAAOjoC,UAAUiG,SAAS,sBAC3BgiC,EAAOniC,cAAc,4BAA4BxF,OAAO8pC,EAAcjwB,OAEtE1Z,MAAM0hE,eAAel6B,EAAQmC,GAI1By3B,gBAAgBkB,GAAmB,EAAMP,GAAiB,GAC/D,MAAMziB,EAAMt/C,MAAMohE,gBAAgBkB,EAAkBP,GAEpD,GAAGziB,GAAOgjB,EACR,IAAI,MAAMl1D,KAAOjN,KAAKyrC,QAAQA,QAAS,CACrC,GAAGzrC,KAAKyrC,QAAQw5B,YAAY9yB,KAAKllC,GAC/B,SAGF,MAAMo6B,EAASrnC,KAAKyrC,QAAQA,QAAQx+B,GACpCjN,KAAKwhE,sBAAsBn6B,EAAQrnC,KAAKurD,aAI5C,OAAOpM,EAGFqiB,sBAAsBn6B,EAAqB6H,GAChD,IAAIlvC,KAAK8jE,gBAAgBz8B,GAAS,OAElC,MAAM8X,EAAMt/C,MAAM2hE,sBAAsBn6B,EAAQ6H,GAQhD,OAPGiQ,GACiB9X,EAAOjoC,UAAUiG,SAAS,eAE1CrF,KAAKyrC,QAAQw4B,sBAAsB58B,GAAQj6B,SAAS2R,GAAS/e,KAAKwhE,sBAAsBziD,EAAMmwB,KAI3FiQ,EAkDFmiB,0BAA0Bl3D,GAC/B,MAAM86D,EAAY96D,EAAQhL,UAAUiG,SAAS,cAC7C,OAAOxF,MAAMyhE,0BAA0Bl3D,MAAc86D,GAAallE,KAAKokE,sBAAsBh6D,IAGrF25D,wBAAwB18B,GAChC,MAAM89B,EAAuBnlE,KAAK0hE,4BAA4Br6B,GAC9D,OAAO89B,MAAAA,OAAoB,EAApBA,EAAsB/7B,QAGrB46B,0BAA0BE,GAClC,MAAMjqC,EAAWj6B,KAAKoiC,KAAKqJ,QAAQw4B,sBAAsBC,GAKzD,OAJIjqC,EAASt5B,QACXs5B,EAASpoB,KAAKqyD,GAGTjqC,EAAStf,KAAKvQ,IAAaA,EAAQxC,QAAQqF,MAG1Cm3D,sBAAsBF,GAC9B,MAAM/qC,EAAOn5B,KAAKgkE,0BAA0BE,GACtChF,EAAe/lC,EAAKxN,QAAQ1e,GAAQjN,KAAK4/D,cAAc5/D,KAAKoiC,KAAK71B,OAAQU,KAC/E,OAAOksB,EAAKx4B,SAAWu+D,EAAav+D,OAG5B+gE,4BAA4Br6B,GAgBpC,OAAOA,EAAOjoC,UAAUiG,SAAS,sBAC/BgiC,EAAOniC,cAAc,eACrBrF,MAAM6hE,4BAA4Br6B,GAG/By8B,gBAAgBz8B,GACrB,QAAQA,EAAOjoC,UAAUiG,SAAS,YAC/BgiC,EAAOjoC,UAAUiG,SAAS,gBAC1BgiC,EAAOjoC,UAAUiG,SAAS,iBAC1BgiC,EAAOjoC,UAAUiG,SAAS,qB,eE90BlB,SAAS+/D,GAAuBC,GAC7C,MAAMC,GAAuB,EAAA5sC,GAAA,GAAa2sC,EAAQ13B,aAAe,GAAI,IAAK,KAS1E,OAAO,EAAA8a,GAAA,GAAa6c,GCVP,SAASC,GAAiBF,GACvC,IAAIG,EAAaH,EAAQv2D,OAASu2D,EAAQI,QAAUJ,EAAQK,WAAa,GAEzE,OADAF,GAAa,EAAA9sC,GAAA,GAAa8sC,EAAY,GAAI,MACnC,EAAA/c,GAAA,GAAa+c,EAAY,CAACvM,SAAS,EAAM5C,cAAc,I,0BCMjD,SAASsP,IAAa,MAACpxC,EAAK,MAAEC,GAA4BtwB,EAAmBogC,EAAoCshC,GAK9H,MAAMC,EAA6Bz0D,MAAMC,KAAKnN,EAAK4hB,UAA4B1T,MAAMhI,GAAYA,EAAQhL,UAAUiG,SAAS,mBAAqB+E,EAAQhL,UAAUiG,SAAS,WAAYnB,EAExL,IAAK2oD,YAAaiZ,GAAaD,GAC1BE,aAAcC,GAAc9hE,EAEjC,MAAMsC,EAAO1H,SAAS8rC,KAAKnkC,wBACrBw/D,EAAcz/D,EAAKjF,MACnB2kE,EAAe1/D,EAAKhF,OAE1B,IAAI2kE,EAlBc,EAkBYC,EAhBX,EAgByCC,EAlB1C,EAkB0EC,EAhBzE,EAiBhBV,IACEA,EAAkB/+D,KAAmB++D,EAAkB/+D,IACvD++D,EAAkBtgC,QAAO8gC,GAAgBR,EAAkBtgC,OAC3DsgC,EAAkBtvC,SAAQ+vC,GAAiBT,EAAkBtvC,QAC7DsvC,EAAkBj/D,OAAM2/D,GAAeV,EAAkBj/D,OAG9D29B,EAAOjV,EAAA,WAAsB,QAAU,OACvC,IAAIk3C,EAAkD,MAEtD,MAAMC,EAASN,EAAeF,EAAaK,EACrCI,EAAUR,EAAcH,EAAYM,EAEpCM,EAAUJ,EAoBV9jD,EAjBG,CACLxb,EAAG,CACDL,KAAM4tB,EACN+Q,MAAO3iC,KAAKC,IAAI6jE,EAASlyC,EAAQuxC,IAEnCa,cAAwB,UAATriC,EAAmBoiC,EAAUD,EAE5Cx/D,EAAG,CACDJ,IAAK2tB,EACL8B,OAAQ9B,EAAQwxC,GAIlBY,cAAeJ,GAMbK,EACD,CACDlgE,KAAO6b,EAAMxb,EAAEL,KAAOm/D,EAAYM,GAAiBH,EACnD3gC,MAAO9iB,EAAMxb,EAAEs+B,OAASghC,GAHtBO,EAKD,CACDhgE,IAAM2b,EAAMvb,EAAEJ,IAAMm/D,EAAaK,GAAkBH,EACnD5vC,OAAS9T,EAAMvb,EAAEqvB,OAAS+vC,GAAkBA,GAUhD,CAUE,IAAI1/D,EAQJA,EAAOkgE,EAAgBviC,GAAQ9hB,EAAMxb,EAAEs9B,IAASA,EAAO,SAAU9hB,EAAMmkD,eAEvEziE,EAAKjB,MAAM0D,KAAOA,EAAO,KAY3B,CACE,IAAIE,EAEJA,EAAMggE,EAAgBN,GAAgB/jD,EAAMvb,EAAEs/D,IAAiBA,EAAe,SAAU/jD,EAAMokD,eAE9F1iE,EAAKjB,MAAM4D,IAAMA,EAAM,KAUzB,OAPA3C,EAAKvF,UAAYuF,EAAKvF,UAAU8B,QAAQ,2CAA4C,IACpFyD,EAAK9E,UAAUC,KAEK,WAAjBknE,EAA4BA,EAAe,UAC5C,KACU,WAATjiC,EAAoBA,EAAiB,SAATA,EAAkB,QAAU,SAEpD,CACL/iC,MAAOukE,EACPtkE,OAAQwkE,G,2SCrCZ,MAAMc,GASJlnE,YACUmnE,EACAld,GADA,KAAAkd,SAAAA,EACA,KAAAld,YAAAA,EAyGF,KAAAmd,YAAc,KACpB,gBAA0B,CACxBz6D,OAAQvM,KAAKuM,OACb+2D,UAAWtjE,KAAKiN,IAChBpB,SAAU7L,KAAK6pD,YAAYzqB,cAAcvzB,YAIrC,KAAAo7D,eAAiB,KACpBjnE,KAAK6pD,YAAYyB,UAAUC,aAC5B,QAAmBvrD,KAAK6pD,YAAYyB,UAAU0X,qBAE9C,IAAIlF,GAAa,CACf,CAAC99D,KAAKuM,QAAS,CAACvM,KAAKiN,QAKnB,KAAAi6D,cAAgB,KACtBlnE,KAAK6pD,YAAYyB,UAAUE,gBAAgBxrD,KAAKmH,SAG1C,KAAAggE,sBAAwB,KAC9BnnE,KAAK6pD,YAAYyB,UAAUsT,mBAGrB,KAAAwI,cAAgB,KACnBpnE,KAAK6pD,YAAYyB,UAAUC,aAC5B,QAAmBvrD,KAAK6pD,YAAYyB,UAAU2X,oBAE9C,IAAIhF,GAAoBj+D,KAAKuM,OAAQ,CAACvM,KAAKiN,KAAM,SArInDjN,KAAK2S,SAAWk3C,EAAYl3C,SAkDzB,MAGDqqD,GAA0B+J,GAnDL1mE,IAMrB,IAAI0e,EALD/e,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAId,IACE0P,GAAO,EAAA4a,GAAA,GAAgBt5B,EAAE8G,OAAQ,qBACjC,MAAM9G,IAER,GAAI0e,EAAJ,CAGA,GADG1e,aAAao9B,YAAYp9B,EAAEu0B,iBAC3B50B,KAAKoK,QAAQhL,UAAUiG,SAAS,UACjC,OAAO,EAENhF,aAAao9B,aAAYp9B,EAAEoH,cAAe,GAEnC,MAAW,mCACnBzH,KAAKmH,OAAS4X,EACd/e,KAAKuM,OAASwS,EAAKnX,QAAQ2E,OAAOsO,WAClC7a,KAAKiN,KAAO8R,EAAKnX,QAAQqF,IACzBjN,KAAK2/D,WAAa9V,EAAYyB,UAAUsU,cAAc5/D,KAAKuM,OAAQvM,KAAKiN,WAElE9J,QAAQC,IAAIpD,KAAKmtC,QAAQxyB,KAAU9b,GAAW,mCAClD,IAAI89D,EAGFA,IADC38D,KAAK2/D,aAAe9gE,EAAOwoE,kBAGrBxoE,EAAOsf,eAAetf,EAAOsf,WAGtCtf,EAAOuL,QAAQhL,UAAUoE,OAAO,QAASm5D,SAG3C59C,EAAK3f,UAAUC,IAAI,aAEnBsmE,GAAatlE,EAAGL,KAAKoK,SACrB,eAAkCpK,KAAKoK,SAAS,KAC9C2U,EAAK3f,UAAUkB,OAAO,oBAI1B8E,OAUIiK,OACNrP,KAAKmtC,QAAU,CAAC,CACdluC,KAAM,UACNQ,KAAM,UACNuoB,QAAShoB,KAAKinE,eACd9oD,OAAQ,IAAW,GAAAne,UAAA,6BAAAA,KAAK2S,SAAS40B,mBAAmB+/B,iBAAiBtnE,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiB92D,KAAKuM,OAAQvM,KAAKiN,UACxI,CACDhO,KAAM,UACNQ,KAAM,oCACNuoB,QAAShoB,KAAKinE,eACd9oD,OAAQ,IAAMne,KAAK2/D,aAChB3/D,KAAK6pD,YAAYyB,UAAU0X,oBAAoB5jE,UAAUiG,SAAS,QACrEgiE,eAAe,GACd,CACDpoE,KAAM,UACNQ,KAAM,uBACNuoB,QAAShoB,KAAKgnE,YACdK,eAAe,GACd,CACDpoE,KAAM,SACNQ,KAAM,yBACNuoB,QAAShoB,KAAKknE,eACb,CACDjoE,KAAM,SACNQ,KAAM,kCACNuoB,QAAShoB,KAAKmnE,sBACdhpD,OAAQ,IAAMne,KAAK2/D,WACnB0H,eAAe,GACd,CACDpoE,KAAM,gBACNQ,KAAM,SACNuoB,QAAShoB,KAAKonE,cACdjpD,OAAQ,IAAW,GAAAne,UAAA,6BAAAA,KAAK2S,SAAS40B,mBAAmBggC,uBAAuBvnE,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiB92D,KAAKuM,OAAQvM,KAAKiN,UAC9I,CACDhO,KAAM,gBACNQ,KAAM,mCACNuoB,QAAShoB,KAAKonE,cACdjpD,OAAQ,IAAMne,KAAK2/D,aAAe3/D,KAAK6pD,YAAYyB,UAAU2X,mBAAmB7jE,UAAUiG,SAAS,QACnGgiE,eAAe,IAGjBrnE,KAAKoK,QAAU,GAAWpK,KAAKmtC,SAC/BntC,KAAKoK,QAAQhL,UAAUC,IAAI,qBAAsB,eACjDP,SAASstD,eAAe,cAAc1sD,OAAOM,KAAKoK,UA+CvC,MAAMogD,GAmEnB5qD,YAAYhB,GAlEL,KAAA6Q,KAAiD,GAUhD,KAAA+3D,WAAa,EAEb,KAAA/4C,cAAgB,IAAInP,GACrB,KAAAoP,YAAa,UAEb,KAAAo9B,eAAwF,GACxF,KAAAV,gBAAgE,GAChE,KAAAqc,aAAyB,GAGzB,KAAA9b,UAA0BxoD,QAAQ4B,UAEjC,KAAA2iE,UAA0D,GAC1D,KAAA94C,aAAoE,GACpE,KAAAohB,OAAwD,GACxD,KAAA23B,aAAc,EACd,KAAAC,WAAY,EAEZ,KAAA9zC,KAAM,EAAA+zC,GAAA,IAAO,gBAGb,KAAAC,gBAOH,GAIE,KAAAC,aAA+D,IAAI92D,IAUnE,KAAA+2D,YAAc,EACd,KAAAC,cAAgB,EAChB,KAAAC,eAAiB,EAEjB,KAAA3tC,YAAc,EA+Qb,KAAA4tC,kBAAoB,KAC1BnoE,KAAKkB,UAAU9B,UAAUC,IAAI,YAGvB,KAAA+oE,gBAAkB,KACxBpoE,KAAKkB,UAAU9B,UAAUkB,OAAO,aAzQhC,EAAA0Q,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,gBAE7BW,KAAKqoE,kBAAoB,IAAIvB,GAAkB9mE,KAAKkB,UAAWlB,MAC/DA,KAAKsrD,UAAY,IAAIsX,GAAgB5iE,KAAMA,KAAK2S,UAEhD,MAAMuwD,EAAyBljE,KAAKkjE,uBAAyBpkE,SAASC,cAAc,OACpFmkE,EAAuB9jE,UAAUC,IAAI,+BAAgC,6BAA8B,UAEnG,MAAMipE,EAAgBtoE,KAAKsoE,cAAgB,IAAI,KAAYpF,GAC3DoF,EAAcpnE,UAAU9B,UAAUC,IAAI,+BAEtC,MAAMyqD,EAAM9pD,KAAK8pD,IAAMhrD,SAASC,cAAc,OAC9C+qD,EAAI1qD,UAAUC,IAAI,oBAAqB,uBACvCW,KAAKuoE,SAAWze,EAEhBwe,EAAcpnE,UAAUxB,OAAOoqD,GAE/B,IAAI,MAAMa,KAAY3qD,KAAKyqD,UAAW,CACpC,MAAM+d,EAAU1pE,SAASC,cAAc,OACvCypE,EAAQppE,UAAUC,IAAI,4BACtB,MAAMkK,EAAOzK,SAASC,cAAc,QAC9BgN,EAAIjN,SAASC,cAAc,KAEjCwK,EAAK7J,QAAO,QAAKirD,EAASlnD,OAC1B8F,EAAK7J,OAAOqM,GAEZy8D,EAAQ9oE,OAAO6J,IAEf,EAAA1E,GAAA,GAAO2jE,GAEPxoE,KAAKuoE,SAAS7oE,OAAO8oE,GAErBxoE,KAAK+nE,aAAa9qD,IAAI0tC,EAAS1qD,KAAM0qD,GAErCA,EAAS6d,QAAUA,EAMrB,IAAIC,EAHJzoE,KAAKkR,cAAgBpS,SAASC,cAAc,OAC5CiB,KAAKkR,cAAc9R,UAAUC,IAAI,8BAA+B,kBAG7D,MACDk+D,GAAe,CACbnzD,QAASpK,KAAKkR,cACdqyC,QAAS,CAACL,EAAOC,EAAO9iD,KACtB,MAAMqoE,EAAS1oE,KAAKuP,UAAUm5D,SACxB5iD,EAAW1U,MAAMC,KAAKrR,KAAKuoE,SAASziD,UAC1C,IAAIzH,EACJ,GAAG6kC,EAAQ,GACT,IAAI,IAAIn3C,EAAI28D,EAAS,EAAG38D,EAAI+Z,EAASnlB,SAAUoL,EAC7C,IAAI+Z,EAAS/Z,GAAG3M,UAAUiG,SAAS,QAAS,CAC1CgZ,EAAMtS,EACN,YAIJ,IAAI,IAAIA,EAAI28D,EAAS,EAAG38D,GAAK,IAAKA,EAChC,IAAI+Z,EAAS/Z,GAAG3M,UAAUiG,SAAS,QAAS,CAC1CgZ,EAAMtS,EACN,WAKK/B,IAARqU,IACDoqD,EClYG,SAAyBvnE,GACtC,MAAMyzB,EAAet0B,KACnB,EAAA4nB,EAAA,GAAY5nB,IAGd,IAAIsoE,EAAU,EACd,MAAMziE,EAAK,OACHyiE,GACJznE,EAAUmF,oBAAoB,YAAasuB,EAAa,CAACrB,SAAS,KAOtE,OAHApyB,EAAUd,iBAAiB,YAAau0B,EAAa,CAACrB,SAAS,EAAM3rB,SAAS,IAC9EzG,EAAUd,iBAAiB,WAAY8F,EAAI,CAACsB,MAAM,IAE3CtB,EDmXkB0iE,CAAgB5oE,KAAKkR,eACpClR,KAAKuP,UAAU8O,OAMvB,IAAI,MAAMssC,KAAY3qD,KAAKyqD,UAAW,CACpC,MAAMvpD,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI,0BAA4BsrD,EAAS1qD,KAAM,YAEnE,MAAM8O,EAAUjQ,SAASC,cAAc,OACvCgQ,EAAQ3P,UAAUC,IAAI,wBAA0BsrD,EAAS1qD,MAEzDiB,EAAUxB,OAAOqP,GAEjB/O,KAAKkR,cAAcxR,OAAOwB,GAE1BlB,KAAKyP,KAAKk7C,EAASh+C,aAAeoC,EAElC47C,EAASkY,WAAa9zD,EAGxB/O,KAAKkB,UAAUxB,OAAOwjE,EAAwBljE,KAAKkR,eAInDlR,KAAK6oE,iBAAmB,IAAIr+D,GAAY,EAAO,YAAY,GAE3DxK,KAAK8L,WAAWO,iBAAmB,KAC9BrM,KAAK2qD,SAASkY,YAAc7iE,KAAK8oE,gBAAgB9oE,KAAK2qD,WAEvD3qD,KAAKmB,MAAK,IAKdnB,KAAKuP,WAAY,EAAAw5D,GAAA,GAAe/oE,KAAKuoE,SAAUvoE,KAAKkR,eAAe,CAACV,EAAIw4D,EAAYv4D,KAClF,GAAGzQ,KAAKwnE,YAAch3D,IAAOxQ,KAAKipE,WAMhC,YALAjpE,KAAK8L,WAAW8pC,kBAAkB,CAChCxrC,QAASpK,KAAKkB,UACdypC,SAAU,QACVu+B,cAAelpE,KAAK6qD,sBAKxB,MAAMse,EAAcnpE,KAAKyqD,UAAUj6C,GAChCxQ,KAAK0qD,aACN1qD,KAAK0qD,YAAYye,GAGnB,MAAMC,EAAeppE,KAAK2qD,SAO1B,GANA3qD,KAAK2qD,SAAWwe,GAEO,IAApBnpE,KAAKwnE,WAAoB/2D,GAC1BzQ,KAAKmoE,oBAGJnoE,KAAKipE,WACNjpE,KAAKipE,YAAa,MACb,CACL,MAAMI,EAAYrpE,KAAKkB,UAAUmoE,UACjC,IAAI5kB,EAAYzkD,KAAK8L,WAAW24C,UAYhC,GAXGA,EAAY4kB,IACbrpE,KAAK8L,WAAW8pC,kBAAkB,CAChCxrC,QAASpK,KAAKkB,UACdypC,SAAU,QACVu+B,cAAelpE,KAAK6qD,sBAEtBpG,EAAY4kB,GAGdD,EAAa1zB,OAAS,CAAC+O,UAAWA,EAAWshB,aAAc/lE,KAAK8L,WAAWi6D,mBAEjD/7D,IAAvBm/D,EAAYzzB,OAAsB,CACnC,MAAMlvC,EAAOxG,KAAKkB,UAAUuF,wBACtB6iE,EAAQtpE,KAAKkB,UAAU0C,cAAc6C,wBACrCoS,EAAOrS,EAAKS,EAAIqiE,EAAMriE,EAEzBw9C,EAAY5rC,IACbswD,EAAYzzB,OAAS,CAAC+O,UAAW5rC,EAAMktD,aAAc,IAIzD,GAAGoD,EAAYzzB,OAAQ,CACrB,MAAM78B,EAAOuwD,EAAa1zB,OAAO+O,UAAY0kB,EAAYzzB,OAAO+O,UAI7D5rC,IAKCswD,EAAYtG,WAAW5/D,MAAMkzB,UAAY,cAActd,UAaxC,IAApB7Y,KAAKwnE,WAAqB2B,EAAYtG,WAAW53D,mBAElDjL,KAAKmB,MAAK,GAGZnB,KAAKwnE,UAAYh3D,KAChB,KACDxQ,KAAK8L,WAAWg5B,gBAGY96B,IAAzBhK,KAAK2qD,SAASjV,SACf11C,KAAK2qD,SAASkY,WAAW5/D,MAAMkzB,UAAY,GAC3Cn2B,KAAK8L,WAAW24C,UAAYzkD,KAAK2qD,SAASjV,OAAO+O,WAGhDgkB,IACDA,IACAA,OAAez+D,GAGjBhK,KAAKooE,yBACJp+D,EAAWs+D,IAEd,QAAiBtoE,KAAKkR,eAAgB7Q,IACjCL,KAAKsrD,UAAUC,eAChB,EAAAtjC,EAAA,GAAY5nB,GACZL,KAAKsrD,UAAUE,iBAAgB,EAAA7xB,GAAA,GAAgBt5B,EAAE8G,OAAQ,yBAE1D,CAACmsB,SAAS,EAAM3rB,SAAS,IAE5B,MAAM4hE,EAAe,CAAM5qE,EAAmB6qE,EAAyB78D,EAAoCtM,IAAkB,mCAC3H,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAA0BxI,GAC3D,IAAIwI,EAAQ,OAEZ,MAAM8F,GAAO9F,EAAOS,QAAQqF,IAC5B,IAAIA,EAEF,YADAjN,KAAK8zB,IAAI21C,KAAK,mCAAoCtiE,GAIpD,MAAMoF,EAASpF,EAAOS,QAAQ2E,OAAOsO,WAE/B4C,EAAWrM,MAAMC,KAAKrR,KAAKyP,KAAK9C,GAAa2E,iBAAiB,IAAMk4D,IAAoC7uD,KAAKpJ,IACjH,MAAMgkC,GAAc,EAAA5b,GAAA,GAAgBpoB,EAAI5S,GACxC,MAAO,CACLyL,QAASmH,EACTtE,KAAMsoC,EAAY3tC,QAAQqF,IAC1BV,OAAQgpC,EAAY3tC,QAAQ2E,OAAOsO,eAKjCwD,EAAMZ,EAAQa,WAAWS,GAASA,EAAK9R,MAAQA,GAAO8R,EAAKxS,SAAWA,IAEtEc,QAAgBrN,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBvqD,EAAQU,IAChF,IAAIy8D,IACHC,iBAAiB3pE,KAAK4pE,kBAAkBj9D,IACxCk9D,UAAUx8D,EAASoQ,EAAQY,GAAKjU,QAAS,GAAG,EAAOqT,EAAQ/c,MAAM,EAAG2d,GAAMZ,EAAQ/c,MAAM2d,EAAM,QAGjG,QAAiBre,KAAKyP,KAAKq6D,8BAA+BP,EAAargE,KAAK,KAAM,YAAa,YAAa,mCAC5G,QAAiBlJ,KAAKyP,KAAKs6D,4BAA6BR,EAAargE,KAAK,KAAM,sBAAuB,kBAAmB,gCAc1HlJ,KAAK2qD,SAAW3qD,KAAKyqD,UAAU,IAE/B,EAAAuf,GAAA,KAAuB,KACrBhqE,KAAKyuB,cAAczQ,UAClB,KACDhe,KAAKyuB,cAAc1Q,sBAYhBotC,qBAAqBn/C,EAAiB/L,GAC3C,OAAO,EAAAgqE,GAAA,GAA4BhqE,EAAM+L,EAAUA,EAASrL,QAGtDupE,oBAAmB,QAAC78D,EAAO,YAAEF,IACnC,MAAMyhB,EAA+B,IAC/B,IAACzT,GAAO,gBAA+B,CAC3C5O,OAAQc,EAAQd,OAChBrL,UAAWiM,EAAYtC,KACvB0C,WAAY,GACZqhB,aAAAA,IAGIu7C,EAAwB,mBAAkC,CAC9D3xC,OAAQ,CACN5rB,EAAG,SACHL,OAAQc,EAAQd,QAElB69D,YAAa/8D,EACb8N,IAAAA,EACA28C,cAAe93D,KAAKo/B,cAAczzB,QAIpC,OADAijB,EAAa/c,KAAKs4D,GACXhnE,QAAQC,IAAIwrB,GAGPy7C,yBAAwB,QAACh9D,EAAO,SAAE5D,EAAQ,WAAEilB,I,0CACxD,MAAMV,GAAQ,EAAAyM,GAAA,GAAoBptB,GAE5BhJ,EAAMvF,SAASC,cAAc,OAInC,IAAIwgC,EAHJl7B,EAAIjF,UAAUC,IAAI,aAIlB,MAAM2B,EAAO4e,GAAgBoO,EAAO,IAAK,KAoCzC,OAlCEuR,EADa,UAAZvR,EAAMphB,cACgBqzB,GAAU,CAC/BzF,IAAKxM,EACL3gB,QAAAA,EACAnM,UAAWmD,EACXyb,SAAU,EACVC,UAAW,EACX0O,cAAezuB,KAAKyuB,cACpBC,WAAAA,EACA0R,aAAa,EACbzR,kBAAkB,EAClB0R,cAAc,EACdr/B,KAAAA,KACEisB,YAEYqB,GAAU,CACxBzO,MAAOmO,EACP3gB,QAAAA,EACAnM,UAAWmD,EACXyb,SAAU,EACVC,UAAW,EACX0O,cAAezuB,KAAKyuB,cACpBC,WAAAA,EACAC,kBAAkB,EAClBG,QAAQ,EACR9tB,KAAAA,IAIJ,CAACu+B,EAAQpQ,OAAOlC,MAAOsS,EAAQpQ,OAAOD,MAAMvD,OAAO6kB,SAASpjC,SAASga,IACnEA,EAAMhoB,UAAUC,IAAI,sBAGtBoK,EAASoI,KAAK0tB,EAAQ3Q,aAAa3B,OAE5B,CAAC7iB,QAAS/F,EAAKgJ,QAAAA,MAGVi9D,uBAAsB,QAACj9D,EAAO,YAAEV,I,0CAC5C,MAAM7N,GAAW,EAAA27B,GAAA,GAAoBptB,GAC/BktB,EAAav6B,KAAKu6B,YAAe,CAAC,QAAS,SAAkCnzB,SAAStI,EAASmB,MAE/FoE,QAAYk+B,GAAa,CAC7Bl1B,QAAAA,EACAgtB,UAAWE,EACX3H,WAAY,IACZ0H,cAAc,EACdC,WAAAA,EACA6E,cAAep/B,KAAK4pE,kBAAkBj9D,GACtC8hB,cAAezuB,KAAKyuB,cACpBI,iBAAkB,IAOpB,MAJI,CAAC,QAAS,QAAS,SAAkCznB,SAAStI,EAASmB,OACzEoE,EAAIjF,UAAUC,IAAI,YAGb,CAACgO,QAAAA,EAASjD,QAAS/F,MAGdkmE,kBAAiB,QAACl9D,EAAO,SAAE5D,EAAQ,WAAEilB,I,gDACjD,IAAIT,EAA6D,QAAlD,EAAA5gB,EAAQ2gB,aAA0C,eAAEC,QAEnE,IAAIA,EAAS,CACX,MAAMu8C,EAASn9D,EAAQ8qD,cAAgB9qD,EAAQ8qD,cAAc/lD,MAAM/R,GAAmB,qBAARA,EAAEuM,GAAoC,yBAARvM,EAAEuM,IAAgC,KAC9I,IAAI0Z,EAAamkD,EAAqBC,EAEtC,GAAIF,EAUFE,EAASr9D,EAAQA,QAAQ3M,MAAM8pE,EAAOxmD,OAAQwmD,EAAOxmD,OAASwmD,EAAO7pE,YAV3D,CAEV,MAAMi4D,GAAQ,EAAA+R,GAAA,GAASt9D,EAAQA,SAC/B,IAAIurD,EAEF,OAGFtyC,EAAMsyC,EAAM,GAMZtyC,EADe,0BAAdkkD,MAAAA,OAAM,EAANA,EAAQ59D,GACH49D,EAAOlkD,IAGPA,GAAOokD,EAGfD,EAAcnkD,EAEd,MAAMskD,EAAOv9D,EAAQA,UAAYiZ,EAC7BA,EAAIsyC,MAAM,4BACZ6R,EAAc,WAAankD,EAC3BA,EAAMA,EAAIlf,SAAS,KAAOkf,EAAM,WAAaA,GAG/CmkD,EAAc,IAAIlQ,IAAIkQ,GAAaI,SAEnC58C,EAAU,CACRrhB,EAAG,UACH0Z,IAAAA,EACAmkD,YAAAA,EACAj6D,GAAI,GACJs6D,KAAM,GAGJF,IACF38C,EAAQ0f,YAActgC,EAAQA,SAIlC,IAAI09D,EAAajsE,SAASC,cAAc,OACxCgsE,EAAW3rE,UAAUC,IAAI,UAAW,aAIjC4uB,EAAQpO,MACGyO,GAAU,CACpBptB,UAAW6pE,EACX19D,QAAS,KACTwS,MAAOoO,EAAQpO,MACfC,SAAU,EACVC,UAAW,EACX4O,kBAAkB,EAClBF,cAAezuB,KAAKyuB,cACpBC,WAAAA,EACA1tB,KAAM4e,GAAgBqO,EAAQpO,MAAsB,GAAI,IAAI,GAC5D+O,aAAcnlB,EACdqlB,QAAQ,KAGVi8C,EAAW3rE,UAAUC,IAAI,UACzB,EAAAs5B,EAAA,GAAaoyC,EAAY3qB,GAAgBnyB,EAAQnf,OAASmf,EAAQw8C,aAAex8C,EAAQ0f,aAAe1f,EAAQ3H,KAAK,KAGvH,IAAIxX,EAAQy2D,GAAiBt3C,GAE7B,MAAM+8C,EAAmB5F,GAAuBn3C,GAE1C2Y,EADY8tB,IAAuB,EAAAjM,GAAA,GAAax6B,EAAQ3H,KAAO,KACjDyC,kBACpB,GAAG6d,aAAaqkC,kBACd,IACErkC,EAAE3H,UAAYisC,mBAAmBtkC,EAAEsvB,MACnC,MAAMzoD,IAKPu9D,EAAiBG,YAClBH,EAAiBtrE,OAAO,MAG1BsrE,EAAiBtrE,OAAOknC,GAErB5mC,KAAKu6B,YACNywC,EAAiBtrE,OAAO,WAAYo5B,GAAiBzrB,IAGnDyB,EAAM6jB,aAER7jB,EAAMpP,QAAO,EAAAwjC,GAAA,GAAcjV,EAAQw8C,YAAY/nC,MAAM,IAAK,GAAG,KAG/D,MAAMnd,EAAM,IAAI8jB,GAAI,CAClBv6B,MAAAA,EACAg7B,WAAY7Q,GAAa5rB,GACzBo8B,SAAUuhC,EACVphC,aAAa,EACbl/B,WAAW,EACXxL,UAAU,IAiBZ,GAXAqmB,EAAIrkB,UAAUxB,OAAOqrE,GAWlBxlD,EAAIrkB,UAAU+9B,UAAU3yB,OAAO3L,OAChC,MAAO,CAAC0M,QAAAA,EAASjD,QAASmb,EAAIrkB,cAIrBmqD,oBAAoBr/C,EAAiB2+C,EAA+BjrD,GAAS,G,0CACxF,MAAM0rE,EAAwD,GACxDC,EAA8B1gB,EAASkY,WACvCp5D,EAA2B,GAC3BilB,EAAa1uB,KAAK0uB,WAAWld,MACnC,IAIIrE,EAJAR,EAAcg+C,EAASh+C,kBAErB,WAGa,kCAAhBA,GAAqD3M,KAAKo/B,cAAczzB,MAAMW,QAC/EK,EAAc,2BACdQ,EAAcnN,KAAK6oE,iBACnBwC,EAAe3rE,OAAOyN,EAAYjM,YACV,6BAAhByL,IACRQ,EAAcnN,KAAKoL,aAAaY,UAGlC,MAAMpN,EAAoC,CACxCwsE,cAAAA,EACAz+D,YAAAA,EACAU,aAASrD,EACT0kB,WAAAA,EACAjlB,SAAAA,EACA0D,YAAAA,GAGF,IAAIm+D,EAGJ,OAAO3+D,GACL,IAAK,2BACH2+D,EAAkBtrE,KAAKkqE,mBACvB,MAGF,IAAK,gCACHoB,EAAkBtrE,KAAKqqE,wBACvB,MAGF,IAAK,2BACL,IAAK,gCACL,IAAK,2BACL,IAAK,8BACHiB,EAAkBtrE,KAAKsqE,sBACvB,MAGF,IAAK,yBACHgB,EAAkBtrE,KAAKuqE,iBAS3B,GAAGe,EAAiB,CAClBA,EAAkBA,EAAgBpiE,KAAKlJ,MAGvC,MAAMuqB,EAA8Bve,EAAS2O,KAAUtN,GAAY,mCACjE,IAEE,OADAzO,EAAQyO,QAAUA,QACLi+D,EAAgB1sE,GAC7B,MAAM6O,GACNzN,KAAK8zB,IAAInmB,MAAM,yBAA0BhB,EAAa/N,EAASyO,EAASI,SAItE89D,SAAiBpoE,QAAQC,IAAImnB,IAAUoB,OAAO6kB,SACpD46B,EAAcv5D,QAAQ05D,EAAQ5/C,OAAO6kB,UAWvC,GARGrjC,GAAeA,EAAYtC,KAAKI,mBACjCkC,EAAYnC,YAGXhL,KAAK2rD,WACNliD,EAASoI,KAAK7R,KAAK2rD,YAGlBliD,EAAS9I,eACJwC,QAAQC,IAAIqG,GACdilB,KAFN,CAQA,GAAG08C,EAAczqE,OAAQ,CACvB,MAAMse,EAASvf,EAAS,SAAW,UACnC0rE,EAAch+D,SAASsc,IACrB,MAAM,QAACtf,EAAO,QAAEiD,GAAWqc,EACrB8hD,EAAiBxrE,KAAKyrE,6BAA6BzrE,KAAKioE,aAAe56D,EAAQ8F,KAAO,EAAGxG,GAC/FvC,EAAQhL,UAAUC,IAAI,qBACtB+K,EAAQxC,QAAQqF,IAAM,GAAKI,EAAQJ,IACnC7C,EAAQxC,QAAQ2E,OAAS,GAAKc,EAAQd,OACtCi/D,EAAe/uD,MAAMwC,GAAQ7U,GAE1BpK,KAAKsrD,UAAUC,aAChBvrD,KAAKsrD,UAAUkW,sBAAsBp3D,GAAS,MAMlDpK,KAAK0rE,gBAAgC,6BAAhB/+D,EAA6C,EAAIX,EAASrL,OAAQ0qE,OAInFK,gBAAgB/qE,EAAgBkiE,GACtC,GAAGA,EAAY,CACb,MAAMnC,EAASmC,EAAWj/D,cAO1B,GANAwN,MAAMC,KAAKqvD,EAAO56C,UAAUplB,MAAM,GAAG0M,SAASqsD,IAC5CA,EAAMn5D,aAKJK,IAAWkiE,EAAW53D,kBAAmB,CAC3C,MAAM5G,EAAMvF,SAASC,cAAc,OACnCsF,EAAI46B,UAAY,kCAChB56B,EAAIjF,UAAUC,IAAI,kBAAmB,cAAe,gBAAiB,aAErEqhE,EAAOhhE,OAAO2E,KAKZsnE,YACN,MAAMr6B,EAA+B,IAAI1yB,IACnC8P,EAAa1uB,KAAK0uB,WAAWld,MAEnC,IAAI,IAAIzF,KAAK/L,KAAKoL,aAAc,CAC9B,MAAM+0B,EAAQngC,KAAKoL,aAAaW,GAChC/L,KAAKyP,KAAKm8D,yBAAyBlsE,OAAOygC,EAAMj/B,WAChDi/B,EAAMp1B,QAGR,MAAMY,EAAQ3L,KAAKo/B,cAAczzB,MACjC,GAAGA,EAAO,CACR,MAAMgoD,EAAa,CAACppC,EAAmB4V,EAAoB0rC,GAAmB,KAC5EthD,EAAQ5P,KAAKpO,IACX,GAAG+kC,EAAgBa,IAAI5lC,GACrB,OAGF+kC,EAAgBjyC,IAAIkN,GAEpB,MAAM,IAAC4O,GAAO,gBAA+B,CAC3C5O,OAAQA,EACRrL,UAAWi/B,EAAMt1B,KACjB0C,WAAY,GACZ5C,WAAYw1B,EAAMx1B,aAGpB,MAAO,CAACwQ,IAAAA,EAAK5O,OAAAA,MACZa,SAAQ,EAAO+N,IAAAA,EAAK5O,OAAAA,KAAY,mCACjC,MAAMgoC,QAAav0C,KAAK2S,SAAS2/B,gBAAgBC,QAAQhmC,GACzD,GAAGs/D,IAAqBt3B,EAAK1D,oBAAsB0D,EAAKzD,cAAe,CACrE,MAAMgoB,EAAS,IAAI/iD,OAAO,IAAIo/C,GAAaxpD,MAAUwpD,IAAa,EAAAltD,GAAA,IAAgB0D,OAAY,MAC9FwP,EAAI2wD,UAAUxnE,UAAY6W,EAAI2wD,UAAUxnE,UAAU7D,QAAQq4D,EAAQ,aAClE39C,EAAIE,gBAAgB3b,aAAaixC,GAAqBpkC,EAAO8hB,kBACxD,GAAG9hB,IAAW,SACnB4O,EAAIE,gBAAgB3b,QAAO,QAAK,0BAC3B,CACL,IAAIssC,QAAiBhsC,KAAK2S,SAAS2/B,gBAAgB2V,gBAAgB17C,GACnE,GAAIy/B,EAMFA,EAAW,IAAMA,MANL,CACZ,MAAMzzB,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,GACtDgM,GAAQA,EAAK+kC,QACdtR,EAAW,KAAM,EAAAuR,GAAA,GAAkBhlC,EAAK+kC,OAAOE,WAMnDriC,EAAIE,gBAAgB/W,UAAY,MAAQ0nC,EAAW,aAIvD7L,EAAM38B,UAGFusB,EAAag8C,IACjB,GAAIr9C,IAMJ,OAAOq9C,GAGT,OAAO5oE,QAAQC,IAAI,CACjBpD,KAAK2S,SAAS2I,gBAAgBq5B,mBAAmBhpC,GAAO,GACvDjK,KAAKquB,GACLruB,MAAM2yC,IACFA,GACDsf,EAAWtf,EAAUr0C,KAAKoL,aAAaipC,UAAU,MAIrDr0C,KAAK2S,SAAS2I,gBAAgBs5B,eAAejpC,EAAO,IACnDjK,KAAKquB,GACLruB,MAAM2yC,IACL,GAAGA,IACDsf,EAAWtf,EAASU,WAAY/0C,KAAKoL,aAAaipC,UAAU,GAC5Dsf,EAAWtf,EAAS9pB,QAA4EvqB,KAAKoL,aAAa4gE,gBAElHhsE,KAAKoL,aAAa4gE,eAAe9qE,UAAU9B,UAAUC,IAAI,YAEtDW,KAAKoL,aAAa4gE,eAAelhE,OAAOrG,mBAAqBzE,KAAKoL,aAAa4gE,eAAelhE,OAAOie,mBACtG/oB,KAAKoL,aAAa4gE,eAAelhE,OAAOrG,iBAAiBnE,SAGxDN,KAAKoL,aAAa4gE,eAAenhE,KAAKI,kBAAoB,GAAG,CAC9D,MAAMyjD,EAAW5vD,SAASC,cAAc,OACxC2vD,EAAStvD,UAAUC,IAAI,2BACvB,MAAM4sE,EAAc,IAAI,iBAAiB,CACvCp8D,IAAK,uBAEP6+C,EAAShvD,OAAOusE,EAAY7hE,SAC5BpK,KAAKoL,aAAa4gE,eAAelhE,OAAOpL,OAAOgvD,IAC/C,QAAiBA,GAAU,KACzB,MAAMwd,EAAUlsE,KAAKoL,aAAa4gE,eAAe9qE,UAAU9B,UAAUoE,OAAO,YAC5EyoE,EAAYp8D,IAAMq8D,EAAU,qBAAuB,qBACnDD,EAAY5zC,gBAMpBr4B,KAAK2S,SAAS40B,mBAAmBwM,iBAAiBpoC,EAAO,EAAG,GAAI,GAC/DjK,KAAKquB,GACLruB,MAAMlB,IACFA,GACDmzD,EAAWnzD,EAAMozC,QAAQj5B,KAAKvH,GAAMA,EAAE7G,SAASvM,KAAKoL,aAAaipC,UAAU,QAI5E,GAAIr0C,KAAKo/B,cAAc7yB,QAAWvM,KAAKo/B,cAAczoB,QA0DrD,OAAOxT,QAAQ4B,UA1D+C,CACnE,MAAMonE,EAAqB,CAACnhE,GAAY,IAC/B,gBAA2BtJ,MAAM0pC,IAClC1c,MAIJ1uB,KAAKoL,aAAaghE,OAAOvhE,KAAKvG,UAAY,GAE1C8mC,EAAMihC,aAAa3rE,MAAM,EAAG,IAAI0M,SAAcb,GAAW,mCACvD,IAAI,IAAC4O,GAAO,gBAA+B,CACzC5O,OAAQA,EACRrL,UAAWlB,KAAKoL,aAAaghE,OAAOvhE,KACpC2C,WAAW,EACXD,WAAY,GACZ5C,YAAY,IAGdwQ,EAAIE,gBAAgB3b,aAAc6M,EAAO46B,SACvC7uB,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,EAAOqO,aACvE+1B,GAAqBpkC,EAAO8hB,kBAG5B+c,EAAMihC,aAAa1rE,OAEbqK,GACRhL,KAAKoL,aAAaghE,OAAOphE,YAFzBhL,KAAKoL,aAAaghE,OAAOrhE,YAO/B,OAAO5H,QAAQC,IAAI,CACjBpD,KAAK2S,SAAS2I,gBAAgBgxD,YAAY,kBAAkB5qE,MAAM6qE,IAChE,IAAI79C,IAAc,OAElB,MAAMrQ,EAAMkuD,EAAMjuD,WAAWi2B,GAASA,EAAK/jC,KAAO,YACtC,IAAT6N,IACDkuD,EAAQA,EAAM7rE,SACR6d,OAAOF,EAAK,GAGjBkuD,EAAM5rE,QACP4rE,EAAMn/D,SAASmnC,IACb,gBAA+B,CAC7BhoC,OAAQgoC,EAAK/jC,GACbtP,UAAWlB,KAAKoL,aAAaohE,OAAO3hE,KACpC0tB,eAAe,EACfhrB,WAAY,GACZ5C,YAAY,OAKlB3K,KAAKoL,aAAaohE,OAAOxhE,eAG3BmhE,OAKQM,YAAY9hB,G,0CACxB,MAAMn6C,EAAKxQ,KAAKo/B,cAAc7yB,OAAO8hB,WAC/BK,EAAa1uB,KAAK0uB,WAAWld,MACnC,IAAI1H,EAEJ,MAAM4iE,EAA2B57B,GAA2D,mCAC1F,IAAG9wC,KAAK2rD,kBACA3rD,KAAK2rD,UAEPj9B,KAHN,CAQI1uB,KAAK2sE,cACP3sE,KAAK2sE,YAAc,IAAItQ,GAAe,CACpC5tC,cAAezuB,KAAKyuB,cACpBrT,eAAe,EACfzI,SAAU3S,KAAK2S,YAEjB,QAAiB3S,KAAK2sE,YAAY9hE,MAAOxK,IACvC,MAAMwyC,GAAK,EAAA4F,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IAC/B,IAAI7F,EACF,OAGF,MAAMtmC,EAASsmC,EAAGjrC,QAAQ2E,OAAOsO,WACjC,IAAI/Q,EAAwB3G,QAAQ4B,UACjCsqB,EAAA,aACDvlB,EAAU,kBAA8B,IAG1CA,EAAQpI,MAAK,KACX,gBAA0B,CAAC6K,OAAAA,UAG/Bo+C,EAASkY,WAAWnjE,OAAOM,KAAK2sE,YAAY9hE,MAC5C7K,KAAK0rE,gBAAgB,EAAG/gB,EAASkY,aAGnC,IAAI,MAAMztB,KAAetE,EAAc,CACrC,MAAMvkC,GAAS,EAAA8oC,GAAA,GAAqBD,GACjC7oC,EAAOkpC,qBAISz1C,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,IACjDiM,OAAOg6B,SAIfxyC,KAAK2sE,YAAYttE,IAAIkN,SAIzB,SAASvM,KAAK2S,SAASoH,gBAAgBo/B,UAAU3oC,GAAK,CACpD,MAAMo8D,EAAc5sE,KAAK2sE,YAAmB,IAAL,GACvC7iE,EAAU9J,KAAK2S,SAASq8B,kBAAkBmG,uBAAuB3kC,OAAIxG,EAAW4iE,EAAY5sE,KAAK0nE,UAAU/c,EAASh+C,cAAcjL,MAAMovC,IACtI,IAAIpiB,IACF,OAGF,IAAI7jB,EAAO8/C,EAASkY,WAAW95C,kBAO/B,OANA/oB,KAAK0nE,UAAU/c,EAASh+C,cAAgB9B,EAAOA,EAAKI,kBAAoB,GAAK6lC,EAAaA,aAAanwC,OAEpGmwC,EAAaA,aAAanwC,OAASisE,IACpC5sE,KAAKgwC,OAAO2a,EAASh+C,cAAe,GAG/B+/D,EAAmB57B,EAAaA,sBAGzChnC,EAAU9J,KAAK2S,SAASq8B,kBAAkBqL,YAAY7pC,GAAI9O,MAAMitC,IAC9D,IAAIjgB,IACF,OAIF1uB,KAAKgwC,OAAO2a,EAASh+C,cAAe,EACpC,MAAMmkC,EAAgBnC,EAA+BmC,aACrD,MAAsB,8BAAnBA,EAAalkC,EAIT8/D,EAAmB57B,EAAaA,mBAJvC,KAQJ,OAAO9wC,KAAK4uB,aAAa+7B,EAASh+C,aAAe7C,EAAQohB,SAAQ,KAC3DwD,MAIJ1uB,KAAK4uB,aAAa+7B,EAASh+C,aAAe,YAItCkgE,SAASliB,EAA+BsB,EAAmBlG,EAAmBr3B,G,MACpF,MAAMzuB,EAAO0qD,EAASh+C,YAEtB,GAAG3M,KAAK4uB,aAAa3uB,GACnB,OAAOD,KAAK4uB,aAAa3uB,GAG3B,GAAqB,YAAlB0qD,EAAS1qD,KACV,OAAOD,KAAKysE,YAAY9hB,GAG1B,MAAM39C,EAAmC,QAAzB,EAAAhN,KAAK8rD,eAAe7rD,UAAK,QAAKD,KAAK8rD,eAAe7rD,GAAQ,GAE1E,KAAY,6BAATA,GAAwC+M,EAAQrM,SAC7CX,KAAK2nE,cACP3nE,KAAK2rE,YACL3rE,KAAK2nE,aAAc,GAGjB3nE,KAAKo/B,cAAczzB,MAAMW,QAAWtM,KAAKo/B,cAAc7yB,QAAWvM,KAAKo/B,cAAczoB,UAEvF,OADA3W,KAAKgwC,OAAO/vC,IAAQ,EACbkD,QAAQ4B,UAInB,MAAM+E,EAAU9J,KAAK4uB,aAAa3uB,GAAQkD,QAAQ4B,UAAUrD,MAAK,IAAW,mC,QAE1E,GAAGsL,EAAQrM,QAAUX,KAAKorD,gBAAgBnrD,GAAQ+M,EAAQrM,SAAWsrD,EAAU,CAC7E,IAAIjgD,EAAkB,GAClB8gE,EAAOnqE,KAAKH,IAAI,EAAGxC,KAAKorD,gBAAgBnrD,IACxC8sE,EAAe,EAEnB,EAAG,CACD,IAAIC,EAAMhgE,EAAQtM,MAAMosE,EAAMA,EAAO/mB,GACrC+mB,GAAQE,EAAIrsE,OACZosE,GAAgBC,EAAIrsE,OAEpB,MAAMssE,QAA4B9pE,QAAQC,IAAI4pE,EAAIryD,KAAKkR,GAAM7rB,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBjrC,EAAEtf,OAAQsf,EAAE5e,QAE3HjB,EAAS6F,QAAQ7R,KAAKmrD,qBAAqB8hB,EAAqBhtE,UAC1D8sE,EAAehnB,GAAa+mB,EAAO9/D,EAAQrM,QAWjD,OAFFX,KAAKorD,gBAAgBnrD,GAAQ6sE,EAEpB9sE,KAAKqrD,oBAAoBr/C,EAAU2+C,GAAUz/B,SAAQ,KAC1D9kB,YAAW,KACTpG,KAAK8L,WAAWokC,qBACf,MAKT,IAAIxjC,EAAQM,EAAQrM,OAASqM,EAAQA,EAAQrM,OAAS,GAAGsM,IAAM,EAE/D,MAAMzM,QAAcR,KAAK2S,SAAS40B,mBAAmB6e,UAAU,OAAD,wBACzDpmD,KAAKo/B,eAAa,CACrBzyB,YAAa,CAACC,EAAG3M,GACjByM,MAAAA,EACAG,MAAOk5C,EACPmnB,SAA6B,QAArB,KAAEltE,KAAK0nE,WAAUznE,UAAI,UAAJA,GAAU,KAKrC,GAFA+M,EAAQ6E,QAAQrR,EAAMwM,QAAQ2N,KAAKkR,IAAM,CAAE5e,IAAK4e,EAAE5e,IAAKV,OAAQsf,EAAEtf,YAE7DmiB,OAMDluB,EAAMwM,QAAQrM,OAASolD,QAA8C/7C,IAAhChK,KAAKo/B,cAAc+R,WAA2B3wC,EAAM2sE,WAAc3sE,EAAMwM,QAAQrM,SAAWH,EAAMuM,SAGvI/M,KAAKgwC,OAAO/vC,IAAQ,GAGtBD,KAAK0nE,UAAUznE,GAAQO,EAAM2sE,WAE1BlhB,GA4BD,OAxBFjsD,KAAKorD,gBAAgBnrD,GAAQ+M,EAAQrM,OAEjCX,KAAKgwC,OAAO/vC,IACd6J,EAAQpI,MAAK,KACX0E,YAAW,KACT,GAAIsoB,KAED1uB,KAAK2qD,WAAaA,EAAU,CAC7B,MAAM7gD,EAAU9J,KAAKmB,MAAK,GAAM,GAC7B2I,GACDA,EAAQpI,MAAK,KACPgtB,KAEJtoB,YAAW,KACTpG,KAAK8L,WAAWokC,qBACf,SAIR,MAKElwC,KAAKqrD,oBAAoBrrD,KAAKmrD,qBAAqB3qD,EAAMwM,QAAS/M,GAAO0qD,QAEjF98C,OAAOJ,IACRzN,KAAK8zB,IAAInmB,MAAM,cAAeF,MAC7Byd,SAAQ,KACTlrB,KAAK4uB,aAAa3uB,GAAQ,QAG5B,OAAO6J,EAGDg/D,gBAAgBne,GACtB,MAAMh+C,EAAcg+C,EAASh+C,YAC7B,OAAQ3M,KAAKgwC,OAAOrjC,IAAiB3M,KAAK8rD,eAAen/C,IAAgB3M,KAAKorD,gBAAgBz+C,GAAe3M,KAAK8rD,eAAen/C,GAAahM,OAGlIysE,gB,0CACZ,MAAM1+C,EAAa1uB,KAAK0uB,WAAWld,MAC7BjF,EAASvM,KAAKo/B,cAAc7yB,OAClC,IAAIvM,KAAKkoE,cACP,OAGF,MAAMzd,EAAYzqD,KAAKyqD,UAAU9+B,QAAQg/B,GAAsC,6BAAzBA,EAASh+C,cACzD0gE,EAAU5iB,EAAU9vC,KAAKgwC,IAAa,CAAE/9C,EAAG+9C,EAASh+C,iBAEnD2gE,EAAU7hB,SAAwBtoD,QAAQC,IAAI,CACnDpD,KAAK2S,SAAS40B,mBAAmBgmC,kBAAkBhhE,EAAQ8gE,GAC3DrtE,KAAKyrD,mBAGP,IAAI/8B,IACF,OAGF,GAAG1uB,KAAK2rD,kBACA3rD,KAAK2rD,WAEPj9B,KACF,OAIJ,IAAI8+C,EACAzgE,EAAQ,EACZ09C,EAAUr9C,SAASu9C,IACjB,MAAM8iB,EAAUH,EAASl7D,MAAM0E,GAAMA,EAAE6U,OAAO/e,IAAM+9C,EAASh+C,cAE7Dg+C,EAAS6d,QAAQppE,UAAUoE,OAAO,QAASiqE,EAAQ1gE,OACnD49C,EAAS6d,QAAQppE,UAAUkB,OAAO,UAG/BmtE,EAAQ1gE,aACY/C,IAAlBwjE,IACDA,EAAgB7iB,KAGhB59C,MAIN,MAAM2gE,EAAa1tE,KAAK+nE,aAAav2D,IAAI,WACzCk8D,EAAWlF,QAAQppE,UAAUoE,OAAO,QAASioD,GAE1CA,IACD+hB,EAAgBE,GAGlB1tE,KAAKkB,UAAU9B,UAAUoE,OAAO,QAASgqE,GACzCxtE,KAAKkB,UAAU0C,cAAcxE,UAAUoE,OAAO,gBAAiBgqE,GAC5DA,IACDxtE,KAAKipE,YAAa,EAClBjpE,KAAKuP,UAAUvP,KAAKyqD,UAAUj0C,QAAQg3D,IAAgB,GAGtDxtE,KAAKkjE,uBAAuB9jE,UAAUoE,OAAO,OAAQuJ,GAAS,OAIrD5L,KAAK6qD,GAAS,EAAOC,GAAW,G,gDAC3C,MAAM1/C,EAASvM,KAAKo/B,cAAc7yB,OAClCvM,KAAK8zB,IAAI,OAAQk4B,EAAQz/C,EAAQvM,KAAK4uB,cACtC,MAAMF,EAAa1uB,KAAK0uB,WAAWld,MAEnC,GAAGxR,KAAK4nE,UAAW,CAEjB,SADgC,QAA1B,EAAC5nE,KAAK2tE,4BAAoB,QAAzB3tE,KAAK2tE,qBAAyB3tE,KAAKotE,iBACtC1+C,IACF,OAGF1uB,KAAK2tE,0BAAuB3jE,EAC5BhK,KAAK4nE,WAAY,EAGnB,IAAIgG,EAAS5hB,EAAS,CAAChsD,KAAK2qD,UAAY3qD,KAAKyqD,UAAU9+B,QAAQtZ,GAAMA,IAAMrS,KAAK2qD,WAShF,GARAijB,EAASA,EAAOjiD,QAAQg/B,GACf3qD,KAAK8oE,gBAAgBne,KAG3Bp+C,EAAO46B,WACR,EAAA1nB,GAAA,GAAcmuD,GAASjjB,GAA+B,YAAlBA,EAAS1qD,QAG3C2tE,EAAOjtE,OACT,OAGF,MAAMolD,EAAYkG,EAAW,GAAKtpD,KAAKE,MAAsC,GAA/B,UAAoB,IAAM,GAAS,MAE3E4G,EAA2BmkE,EAAOjzD,KAAKgwC,GACpC3qD,KAAK6sE,SAASliB,EAAUsB,EAAUlG,EAAWr3B,KAGtD,OAAOvrB,QAAQC,IAAIqG,GAAUoE,OAAOJ,IAClCzN,KAAK8zB,IAAInmB,MAAM,2BAA4BF,SAIxCg+D,6BAA6Br3D,EAAmBnU,G,MACrD,MAAMkT,EAAO,IAAIzN,KAAiB,IAAZ0O,GACtBjB,EAAKuD,SAAS,EAAG,EAAG,GACpBvD,EAAK4D,QAAQ,GACb,MAAM82D,EAAgB16D,EAAKa,UACrB85D,EAAuC,QAA1B,EAAA9tE,KAAK8nE,gBAAgB7nE,UAAK,QAAKD,KAAK8nE,gBAAgB7nE,GAAQ,GAC/E,KAAK4tE,KAAiBC,GAAa,CACjC,MAAM5sE,EAAYpC,SAASC,cAAc,OACzCmC,EAAUvC,UAAY,qBAEtB,MAAM8E,EAAO3E,SAASC,cAAc,OACpC0E,EAAKrE,UAAUC,IAAI,2BAEnB,MAAMT,EAAsC,CAC1C6V,MAAO,QAGNtB,EAAKG,iBAAkB,IAAI5N,MAAO4N,gBACnC1U,EAAQ2V,KAAO,WAGjB,MAAMw5D,EAAc,IAAI,qBAAqB,CAC3C56D,KAAAA,EACAvU,QAAAA,IACCwL,QACH3G,EAAK/D,OAAOquE,GAEZ7sE,EAAUxB,OAAO+D,GAEjB,MAAMgZ,EAAQ3d,SAASC,cAAc,OACrC0d,EAAMrd,UAAUC,IAAI,4BAEpB6B,EAAUxB,OAAO+D,EAAMgZ,GAEvB,MAAMuxD,GAAiB,EAAAC,GAAA,GAAqBH,EAAY,QACxD,IAAI/hE,EAAI,EACR,KAAMA,EAAIiiE,EAAertE,UAEpBktE,EADOG,EAAejiE,MADQA,GAOnC+hE,EAAWD,GAAiB,CAAC3sE,UAAAA,EAAWub,MAAAA,GACxCq+C,GAAuB55D,EAAWlB,KAAKyP,KAAKxP,GAAO8L,GAGrD,OAAO+hE,EAAWD,GAGbpiB,iBACL,OAAOtoD,QAAQC,IAAI,CACjBpD,KAAKo/B,cAAc7yB,OAAOkpC,YAC1Bz1C,KAAK2S,SAASoH,gBAAgBq0B,YAAYpuC,KAAKo/B,cAAc7yB,OAAO8hB,YACpEruB,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKo/B,cAAc7yB,OAAO8hB,WAAY,uBAC7E3sB,MAAK,EAAE+zC,EAAWrH,EAAaqG,KACzBgB,IAAcrH,GAAeqG,IAIjCxkC,UACLjQ,KAAK4uB,aAAe,GACpB5uB,KAAKgwC,OAAS,GACdhwC,KAAK2nE,aAAc,EACnB3nE,KAAK0nE,UAAY,GACjB1nE,KAAK4nE,WAAY,EACjB5nE,KAAKwnE,WAAa,EAElBxnE,KAAKyuB,cAAc1jB,QAEnB/K,KAAKyqD,UAAUr9C,SAASu9C,IACtB3qD,KAAKorD,gBAAgBT,EAASh+C,cAAgB,KAG7C3M,KAAKsrD,UAAUC,aAChBvrD,KAAKsrD,UAAUsT,kBAUjB5+D,KAAK0uB,WAAW4sC,QAChBt7D,KAAK2tE,0BAAuB3jE,EAC5BhK,KAAKkqD,uBACLlqD,KAAK2sE,iBAAc3iE,EAGdkgD,uBACLlqD,KAAKyqD,UAAUr9C,SAASu9C,IACtBA,EAASjV,YAAS1rC,KAIf69C,YAAYqmB,GAAU,GACxBluE,KAAKynE,aAAa9mE,SACnBX,KAAKynE,aAAar6D,SAASkZ,IACzBi0C,IAAI4T,gBAAgB7nD,MAEtBtmB,KAAKynE,aAAa9mE,OAAS,GAG7BX,KAAKyqD,UAAUr9C,SAAS0D,IAStB,GARAA,EAAI+xD,WAAWv+D,UAAY,GAExBtE,KAAKkoE,gBAENloE,KAAKkB,UAAU9B,UAAUC,IAAI,QAC7BW,KAAKkB,UAAU0C,cAAcxE,UAAUC,IAAI,iBAG7B,UAAbyR,EAAI7Q,OAIHD,KAAK8rD,eAAeh7C,EAAInE,aAAc,CACxC,MAAM+zD,EAAS5vD,EAAI+xD,WAAWj/D,cAExB88D,EAAOx7D,cAAc,gBACvB,EAAAjB,GAAA,GAAay8D,GAAQ,GAIzB,MAAM5B,EAAQ4B,EAAOx7D,cAAc,kBAChC45D,GACDA,EAAMx+D,aAiBZN,KAAK8nE,gBAAkB,GACvB9nE,KAAK6oE,iBAAiB99D,QACtB/K,KAAK8L,WAAW24C,UAAY,EActBmlB,kBAAkBwE,GACxB,MAAMrjD,GAAU,EAAA0sB,GAAA,GAAKz3C,KAAKo/B,eAG1B,OAFArU,EAAQpe,YAAc,CAACC,EAAGwhE,GAC1BrjD,EAAQmiD,SAAWltE,KAAK0nE,UAAU0G,GAC3BrjD,EAGF8gC,UAAS,OAACt/C,EAAM,MAAEZ,EAAK,SAAEE,EAAQ,eAAEigD,EAAc,SAAE3a,EAAQ,QAAEx6B,EAAO,QAAEC,IAS3E5W,KAAKo/B,cAAgB,CACnB7yB,OAAAA,EACAZ,MAAOA,GAAS,GAChBgB,YAAa,CAACC,EAAG5M,KAAK2qD,SAASh+C,aAC/Bd,SAAAA,EACAslC,SAAAA,EACAx6B,QAAAA,EACAC,QAAAA,GAGF5W,KAAK8rD,eAAiBA,MAAAA,EAAAA,EAAkB,GAExC9rD,KAAKiQ,WE5lDT,MAyBMo+D,GAA0B,CAAC98D,EAAiBE,EAA4C7S,EAA8B2T,OAC9G3T,MAAAA,OAAO,EAAPA,EAASqK,gBAAiBrK,EAAQqK,eAAe5J,IAAIkS,GAAMA,EAAGnR,iBAAiB8I,KAAKqI,IAG5F,MAAmBlR,IAErB,IAAIkR,EAAGnS,UAAUiG,SAAS,mBAAoB,OAAO,EAGrD,MAAMk8C,EAAahwC,EAAGrM,cAAc,aAGpC,IAFA,EAAA+iB,EAAA,GAAY5nB,GAETkR,EAAGnS,UAAUiG,SAAS,aACvB,sBACK,CACL,MAAMiK,EAASmC,GAAUA,EAAOpR,GAC1B8O,EAAO,KACX,eAAkCoyC,EAAYhvC,IAG7CjD,aAAkBnM,QACnBmM,EAAO5N,KAAKyN,GAEZA,SAOR,GAvDyB,CACvBvQ,EAMK,GACLkD,EACAqrC,EACA17B,EACAc,K,MAEA3T,EAAQI,OAAQ,EAChB,MAAMH,EAA0B,QAAjB,EAAAD,EAAQsC,iBAAS,QAAI,EAAW,OAAQtC,GACvDC,EAAOO,UAAUC,IAAI,mBAErB,MAAMivE,EAAU,GAAWnhC,EAASvuC,EAAQqK,gBAI5C,OAHAqlE,EAAQlvE,UAAUC,IAAIyC,GACtBusE,GAAwBxvE,EAAQ4S,EAAQ7S,EAAS2T,GACjD1T,EAAOa,OAAO4uE,GACPzvE,GCzBM,SAAS0vE,GAAuBC,GAC7C,MAAMC,EAAuB,GAG7B,IAAIC,EAAoB,CAACjY,MAAO,GAAIkY,MAAO,IAAKC,EAAuB,CAACnY,MAAO,GAAIkY,MAAO,IA8B1F,OA7BAH,EAAMphE,SAASyhE,IACb,OAAOA,EAAKjiE,GACV,IAAK,uBACH6hE,EAAM58D,KAAK,GACX,MACF,IAAK,0BACH48D,EAAM58D,KAAK,GACX,MACF,IAAK,4BACH48D,EAAM58D,KAAK,GACX,MAIF,IAAK,oCACH68D,EAAWC,MAAM98D,QAAQg9D,EAAKF,OAC9B,MACF,IAAK,yBACHD,EAAWjY,MAAM5kD,QAAQg9D,EAAKpY,OAC9B,MACF,IAAK,uCACHmY,EAAcD,MAAM98D,QAAQg9D,EAAKF,OACjC,MACF,IAAK,4BACHC,EAAcnY,MAAM5kD,QAAQg9D,EAAKpY,WAKhC,CAACx2D,KAAMwuE,EAAM,GAAIG,cAAAA,EAAeF,WAAAA,GC3CzC,IAAKI,IAAL,SAAKA,GACH,6BACA,2BACA,uBAHF,CAAKA,KAAAA,GAAW,KAMhB,YCee,MAAMC,GAiBnBnvE,YAAmBhB,GAAA,KAAAA,QAAAA,EAqLX,KAAAowE,cAAiBxuE,IACvBA,GAASA,EACTR,KAAKC,KAAOO,EAEZ,MAAM2uC,EAAUnvC,KAAKpB,QAAQqwE,SAASjvE,KAAKC,MACrCivE,EAAiBlvE,KAAKmvE,aAAahgC,QACrCA,EAEMA,aAAmB3b,aAC3B,EAAA5lB,EAAA,GAAeshE,EAAgB//B,IAE/B,QAAM+/B,EAAgB//B,GAJtB+/B,EAAe5qE,UAAY,GAM7B4qE,EAAe9vE,UAAUoE,OAAO,QAAS2rC,GAEtCnvC,KAAKovE,aACNpvE,KAAKovE,WAAW59D,IAAI,SAAS+T,IAAIrkB,UAAU9B,UAAUoE,OAAO,OAAQxD,KAAKC,OAAS,cAClFD,KAAKovE,WAAW59D,IAAI,YAAY+T,IAAIrkB,UAAU9B,UAAUoE,OAAO,OAAQxD,KAAKC,OAAS,YAGvFD,KAAKpB,QAAQowE,eAAiBhvE,KAAKpB,QAAQowE,cAAcxuE,IA7LtD5B,EAAQqwE,UACTrwE,EAAQqwE,SAAS90C,UAGnB,MAAMxnB,EAAW/T,EAAQ+T,SAEzB3S,KAAKmvE,aAAe,IAAI/1D,GAAe,CAAC3V,KAAM7E,EAAQkQ,MAAOqgC,SAAS,IAEtEnvC,KAAKqvE,UAAY,IAAIp+D,IAErB,IAAI7L,EAAsD,CAAC,CACzDnF,KAAM,aACNsrC,QAAS,sCACR,CACDtrC,KAAM,YACNsrC,QAAS,wCACR,CACDtrC,KAAM,UACNsrC,QAAS,qCAGR3sC,EAAQ0wE,YACTlqE,EAAIA,EAAEumB,QAAQvmB,IAAOxG,EAAQ0wE,UAAUloE,SAAShC,EAAEnF,SAGpD,MAAMglC,GAAS,UACf7/B,EAAEgI,SAAQ,EAAEnN,KAAAA,EAAMsrC,QAAAA,MAChB,MAAMhmB,EAAM,IAAI8jB,GAAI,CAClBE,WAAY,IAAI0B,GAAW,CACzBM,QAAAA,EACA9nC,KAAMwhC,EACNzkC,MAAO,GAAKP,MAIhBD,KAAKqvE,UAAUpyD,IAAIhd,EAAMslB,MAG3B,MAAM4jB,EAAOkB,GAAkB,IAAIrqC,KAAKqvE,UAAUp5B,UAAWj2C,KAAKgvE,eAOlE,GALAhvE,KAAKmvE,aAAapgE,QAAQrP,OAAOypC,GAC9BvqC,EAAQy0C,UACTz0C,EAAQy0C,SAAS3zC,OAAOM,KAAKmvE,aAAajuE,YAGxCtC,EAAQ2wE,aAAc,CACxB,MAAMruE,EAAYsuE,GAAgB5wE,EAAQy0C,SAAU,oBAAqB,sCAEzErzC,KAAKovE,WAAa,IAAIn+D,IAAI,CAAC,CACzB,WACA,CACE+4B,aAAcprC,EAAQ6wE,eAAe,GACrC5/D,IAAK,WACL0V,IAAK,KACLtmB,KAAM,aACNyqC,gBAAiB,qCACjBh/B,WAAW,IAEZ,CACD,QACA,CACEs/B,aAAcprC,EAAQ6wE,eAAe,GACrC5/D,IAAK,QACL0V,IAAK,KACLtmB,KAAM,UACNyqC,gBAAiB,qCACjBh/B,WAAW,MAIf1K,KAAKovE,WAAWhiE,SAASsiE,IACvBA,EAAUnqD,IAAM,IAAI8jB,GAAIqmC,GAExBA,EAAUnqD,IAAIrkB,UAAUd,iBAAiB,SAAS,KAChD0J,EAAQpI,MAAK,KACX,MAAMiuE,EAAW3vE,KAAKwa,QAAQk1D,EAAU7/D,KACxCjR,EAAQkS,IAAIrC,OAAO+D,UAAUssC,IAAkB3vC,KAAK,CAClDlP,KAAM,UACN++C,WAAW,EACXlwC,MAAO4gE,EAAU1lC,aACjBj8B,YAAa,kCACb6oC,QAAUg5B,IACRD,EAAShvE,OAAS,EAClBgvE,EAAS99D,QAAQ+9D,GACjBF,EAAUnqD,IAAIkkB,SAASnlC,UAAY,GACnCorE,EAAUnqD,IAAIkkB,SAAS/pC,UAAUM,KAAK6vE,YAAY7vE,KAAK8vE,iBAAiBF,MAE1EvwB,gBAAiBswB,UAKvBzuE,EAAUxB,OAAOgwE,EAAUnqD,IAAIrkB,cAQnC,MAAM4I,EAAU6I,EAASo9D,kBAAkBC,WAAWpxE,EAAQqxE,UAAUvuE,MAAM8sE,IAC5E,MAAM9kD,EAAU6kD,GAAuBC,GACvCxuE,KAAKkwE,SAASxmD,EAAQzpB,MAEnBD,KAAKovE,aACNpvE,KAAKwa,QAAU,GACf,CAAC,QAAkB,YAAqBpN,SAASqK,IAC/C,MAAMmJ,EAAM,GACNvP,EAAa,UAANoG,EAAgBiS,EAAQglD,WAAahlD,EAAQklD,cAC1DhuD,EAAI/O,QAAQR,EAAKolD,MAAM97C,KAAKnK,GAAOA,EAAGqK,cACtC+F,EAAI/O,QAAQR,EAAKs9D,MAAMh0D,KAAKnK,GAAOA,EAAGqK,UAAS,MAC/C7a,KAAKwa,QAAQ/C,GAAKmJ,EAClB,MAAMmZ,EAAI/5B,KAAKovE,WAAW59D,IAAIiG,GAAG8N,IAAIkkB,SACrC1P,EAAEz1B,UAAY,GACdy1B,EAAEr6B,UAAUM,KAAK6vE,YAAYx+D,QAIjCzS,EAAQkS,IAAIf,cAAc3P,iBAAiB,WAAW,KAAW,O,EAAA,K,OAAA,E,EAAA,YAC/D,MAAMouE,EAA4B,GAElC,OAAOxuE,KAAKC,MACV,KAAK,aACHuuE,EAAM38D,KAAK,CAACjF,EAAG,8BACf,MACF,KAAK,YACH4hE,EAAM38D,KAAK,CAACjF,EAAG,mCACf,MACF,KAAK,UACH4hE,EAAM38D,KAAK,CAACjF,EAAG,iCAInB,GAAG5M,KAAKovE,WAAY,CAClB,MAAMxoC,EAAK,CACT,CAAC,QAAa,yCAA8C,+BAC5D,CAAC,WAAa,4CAA8C,mCAM9D,IAAI,MAAOnvB,EAAG04D,EAASC,KAAaxpC,EAAG,CACrC,GAAG5mC,KAAKovE,WAAW59D,IAAIiG,GAAG8N,IAAIrkB,UAAU9B,UAAUiG,SAAS,QACzD,OAGF,MAAMsqE,EAAW3vE,KAAKwa,QAAQ/C,GAC9B,GAAGk4D,EAAU,CACX,MAAMrvB,EAAWtgD,KAAK8vE,iBAAiBH,GACpCrvB,EAASquB,MAAMhuE,QAChB6tE,EAAM38D,KAAK,CAACjF,EAAGujE,EAASxB,MAAOruB,EAASquB,QAGvCruB,EAASmW,MAAM91D,QAChB6tE,EAAM38D,KAAK,CACTjF,EAAGwjE,EACH3Z,YAAatzD,QAAQC,IAAIk9C,EAASmW,MAAM97C,KAAKnK,GAAOmC,EAAS2I,gBAAgB+0D,aAAa7/D,UAOpGmC,EAASo9D,kBAAkBO,WAAW1xE,EAAQqxE,SAAUzB,I,YA9CO,K,gRA+C9D,CAAChnE,MAAM,OA2BP0oE,SAASjwE,GACd,MAAMslB,EAAMvlB,KAAKqvE,UAAU79D,IAAIvR,GAC/BD,KAAKgvE,cAAc/uE,GACnBslB,EAAIgkB,WAAWxpC,MAAMqpC,SAAU,EAGzB0mC,iBAAiBt1D,GACvB,MAAM+xD,EAAQ,CAAC9V,MAAO,GAAgBkY,MAAO,IAK7C,OAJAn0D,EAAQpN,SAASb,IACfggE,EAAMhgE,EAAOkpC,YAAc,QAAU,SAAS5jC,KAAKtF,EAAOkpC,YAAclpC,EAAO8hB,WAAa9hB,MAGvFggE,EAGDsD,YAAYtD,GAClB,OAAIA,EAAM9V,MAAM91D,QAAW4rE,EAAMoC,MAAMhuE,QAIhC,QAAK,CACV4rE,EAAM9V,MAAM91D,QAAS,QAAK,QAAS,CAAC4rE,EAAM9V,MAAM91D,SAAW,KAC3D4rE,EAAMoC,MAAMhuE,QAAS,QAAK,QAAS,CAAC4rE,EAAMoC,MAAMhuE,SAAW,MAC3DgrB,OAAO6kB,UAAU,GANV,EAAC,QAAK,wCCvPJ,MAAM+/B,WAAiCzgE,EACpCT,O,qCACdrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,wBAC5CW,KAAK4P,SAAS,gBAEd,MAAM4tC,EAAY,WAAax9C,KAAK2S,SAAS2I,gBAAgBk1D,WAAWlzB,MAClEmzB,EAAY3xE,SAASC,cAAc,OACzC0xE,EAAU/wE,QACR,QAAK,oBACLZ,SAASC,cAAc,MACvBD,SAASC,cAAc,OACvB,QAAK,qBACLD,SAASC,cAAc,MCdd,SAAoBH,EAG9B,IACH,MAAM06B,EAASx6B,SAASC,cAAc,KAGtC,GAFAu6B,EAAOl6B,UAAUC,IAAI,eAElBT,EAAQ8xE,OAAQ,CACjB,MAAMxa,EAAO,gBAAkBt3D,EAAQ8xE,OACvCp3C,EAAO48B,KAAO58B,EAAO2F,UAAYi3B,EASnC,OANA,QAAiB58B,GAASj5B,KACxB,EAAA4nB,EAAA,GAAY5nB,GACZkqC,GAAoBjR,EAAO48B,MAC3BtqB,GAAS,CAACC,YAAa,kBAGlBvS,EDHHq3C,CAAW,CACTD,OAAQlzB,KAIZ,MAAMozB,EAAe,IAAI7B,GAAe,CACtCj+D,IAAK9Q,KACL8O,MAAO,oBACPmhE,SAAU,6BACVhB,SAAU,CAACwB,EAAWA,EAAW,IACjChB,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACfkjE,cAAgB/uE,IACd85B,EAAEm2C,SAAS,cACXn2C,EAAEo1C,aAAajuE,UAAU9B,UAAUoE,OAAO,OAAQvD,IAAS,YAE7D0S,SAAU3S,KAAK2S,WAGXk+D,EAAwB,oBACxB92C,EAAI,IAAIg1C,GAAe,CAC3Bj+D,IAAK9Q,KACL8O,MAAO,qBACPmhE,SAAU,8BACVhB,SAAU,CAAC4B,EAAUA,EAAU,IAC/BtB,cAAc,EACdD,UAAW,CAAC,WACZ38D,SAAU3S,KAAK2S,WAGjB3S,KAAK8L,WAAW5K,UAAU4C,aAAai2B,EAAEo1C,aAAajuE,UAAW0vE,EAAazB,aAAajuE,UAAU8C,c,gSE9C1F,SAAe8sE,IAAiB,MAACtrC,EAAK,IAAEnhC,EAAG,MAAE9C,EAAK,OAAEC,EAAM,SAAEmR,EAAW,e,qCAOpF,MAAM6nB,QAAY7nB,EAASo0B,mBAAmBK,wBAAwB5B,GACtE,IAAIhL,EAEF,MADAn2B,EAAIjF,UAAUC,IAAI,yBACZ,IAAIygC,MAAM,cAGlB,OAAO,GAAY,CACjBtF,IAAAA,EACAn2B,IAAAA,EACAmhC,MAAAA,EACAjkC,MAAAA,EACAC,OAAAA,EACAH,MAAM,EACNgB,MAAM,K,+RCjBK,MAAM0uE,WAAqCviE,EAC9Ca,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,6BACtDW,KAAK4P,SAAS,kCAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjC+1B,QAAS,qCACTC,aAAa,IAIT4hC,EAAmBlyE,SAASC,cAAc,OAEhD+xE,GAAiB,CACftrC,MAJY,KAKZnhC,IAAK2sE,EACLzvE,MAAO,IACPC,OAAQ,MAGV2X,EAAQpK,QAAQrP,OAAOsxE,GAEvB,MAAMC,EAAe93D,EAAQq/B,yBAEvBn/B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM6xE,GAAY,OAAO,gCAAiC,CAACzxE,KAAM,+CAEjE,QAAiByxE,GAAY7wE,IAC3BL,KAAKiP,WAGPjP,KAAKyO,OAAOuD,kBAAkBm/D,GAAgBnxE,MAE9CqZ,EAAa3Z,OAAOwxE,GAEpBD,EAAavxE,OAAO2Z,GAEpBrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,Y,eC5CtC,SAASkwE,GAASC,GACvB,OAAQ,GAAAxvB,mBAAqBwvB,ECYhB,MAAMC,WAAmD9iE,EAAxE,c,oBAKS,KAAA+iE,SAAU,EAEPliE,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,4CACtDW,KAAK4P,SAAS,6BAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjC+1B,SAAS,EACTC,aAAa,KAGf,QAAMj2B,EAAQg2B,QAAS,mCAAoC,CAACnvC,KAAKwxE,QAEjE,MACMR,EAAmBlyE,SAASC,cAAc,OAEhD+xE,GAAiB,CACfzsE,IAAK2sE,EACLzvE,MAAO,IACPC,OAAQ,IACRgkC,MAPY,OAUdrsB,EAAQpK,QAAQrP,OAAOsxE,GAEvB,MAAMC,EAAe93D,EAAQq/B,yBAEvBn/B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAMkD,EAAavC,KAAKyxE,eAAiB,IAAI,KAAe,CAC1DhuE,KAAM,sBACN8V,MAAO,2BACP5Y,OAAQX,KAAKW,OACbE,OAAS4gC,IACPkjB,GAAO,GAEP3kD,KAAK2S,SAAS++D,gBAAgBC,qBAAqB,GAAKlwC,GACvD//B,MAAMlB,IAKLoxE,OAED/jE,OAAOJ,IACN,OAAOA,EAAIxN,MACT,IAAK,eACHsC,EAAWxC,MAAMX,UAAUC,IAAI,UAC/B,EAAAuO,EAAA,GAAerL,EAAWgX,OAAO,QAAK,oCACtC,MAEF,IAAK,qBACHhX,EAAWxC,MAAMX,UAAUC,IAAI,UAC/B,EAAAuO,EAAA,GAAerL,EAAWgX,OAAO,QAAK,oCACtC,MAEF,QACE7L,QAAQC,MAAM,gBAAiBF,GAInCk3C,GAAO,SAKPktB,GAAY,OAAO,8CAA+C,CAACpyE,KAAM,qCACzEqyE,GAAY,OAAO,4DAA6D,CAACryE,KAAM,eAEvFmyE,EAAS,KACb5xE,KAAKyO,OAAO+D,UAAUu+D,IAA8B5hE,QAGhDw1C,EAAUotB,KACd,EAAAhjC,GAAA,GAAiB,CAACxsC,EAAWxC,MAAO8xE,EAAWC,GAAYC,KAG7D,QAAiBF,GAAYxxE,IAC3BskD,GAAO,GACP3kD,KAAK2S,SAAS++D,gBAAgBM,sBAAsBtwE,MAAMlB,IACxDR,KAAKyO,OAAOuD,kBAAkBigE,GAAgCjyE,MAC9DA,KAAKiP,WACJ,KACD01C,GAAO,UAIX,QAAiBmtB,GAAYzxE,IAC3BskD,GAAO,GACP,MAAMvxC,GAAI,EAAAnP,GAAA,GAAa6tE,GACvB9xE,KAAK2S,SAAS++D,gBAAgBQ,sBAAsBxwE,MAAMlB,IACxD4S,EAAE9S,SACFqkD,GAAO,SAIXtrC,EAAa3Z,OAAO6C,EAAWrB,UAAW2wE,EAAWC,GAErDb,EAAavxE,OAAO2Z,GAEpBrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAG3CwQ,qBACM0/D,GAASpxE,KAAKuxE,UAClBvxE,KAAKyxE,eAAe1xE,MAAM0M,S,eC/Gf,MAAMwlE,WAAuCzjE,EAA5D,c,oBAMS,KAAA+iE,SAAU,EAEPliE,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,+BACtDW,KAAK4P,SAAS,sBAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjC+1B,SAAS,EACTC,aAAa,IAIT4hC,EAAmBlyE,SAASC,cAAc,OAEhD+xE,GAAiB,CACfzsE,IAAK2sE,EACLzvE,MAAO,IACPC,OAAQ,IACRgkC,MAPY,OAUdrsB,EAAQpK,QAAQrP,OAAOsxE,GAEvB,MAAMC,EAAe93D,EAAQq/B,yBAEvBn/B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAMkD,EAAavC,KAAKuC,WAAa,IAAI,IAAW,CAClDkB,KAAM,iBACN8V,MAAO,gBACPzZ,WAAW,IAGbyC,EAAWxC,MAAMK,iBAAiB,YAAaC,IAC7C,GAAa,UAAVA,EAAEwP,IAEH,OADA,EAAAoY,EAAA,GAAY5nB,GACL8xE,OAIX5vE,EAAWxC,MAAMK,iBAAiB,SAAUC,IAC1CkC,EAAWxC,MAAMX,UAAUkB,OAAO,YAGpC,MAAM8xE,GAAc,OAAO,gCAAiC,CAAC3yE,KAAM,aAC7D4yE,GAAU,OAAO,4DAA6D,CAAC5yE,KAAM,kBAErFmyE,EAAS,KACb5xE,KAAKyO,OAAO+D,UAAUu+D,IAA8B5hE,QAGhDgjE,EAAkB,KACtB,MAAMX,EAAQjvE,EAAW/B,MAAM8L,OACzBssD,GC/EuBn5D,ED+EJ+xE,GC9EP/xE,EAAKm5D,MAAM,GAAA0Z,GAAlB,KADF,IAAoB7yE,EDgF7B,IAAIm5D,GAASA,EAAM,GAAGj4D,SAAW6wE,EAAM7wE,OAErC,YADA4B,EAAWxC,MAAMX,UAAUC,IAAI,SAIjCkzE,GAAc,GACd,MAAMn/D,GAAI,EAAAnP,GAAA,GAAamuE,GAEvBpyE,KAAK2S,SAAS++D,gBAAgBc,eAAe,CAC3CC,KAAMzyE,KAAKyyE,KACXC,gBAAiB1yE,KAAK2yE,cACtBC,YAAa5yE,KAAK4yE,YAClBpB,MAAAA,IACC9vE,MAAMlB,IACPoxE,OACEnkE,IACF,GAAGA,EAAIxN,KAAKmH,SAAS,qBAAsB,CACzC,MAAMyrE,GAAWplE,EAAIxN,KAAK24D,MAAM,4BAA4B,GAEtD9nD,EAAM9Q,KAAKyO,OAAO+D,UAAU8+D,IAClCxgE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI0gE,MAAQA,EACZ1gE,EAAInQ,OAASkyE,EACb/hE,EAAI3B,YAEJzB,QAAQomB,IAAI,qBAAsBrmB,GAGpC8kE,GAAc,GACdn/D,EAAE9S,cAGN,QAAiB8xE,EAAaD,GAE9B,MAAMI,EAAiB5tB,IAClBA,GACDytB,EAAY5yE,aAAa,WAAY,QACrC6yE,EAAQ7yE,aAAa,WAAY,UAEjC4yE,EAAYztE,gBAAgB,YAC5B0tE,EAAQ1tE,gBAAgB,eAI5B,QAAiB0tE,GAAUhyE,IACX,IAAI6sC,GAAU,mBAAoB,CAC9CC,QAAS,CAAC,CACR5B,QAAS,SACTunC,UAAU,GACT,CACDvnC,QAAS,gBACTzmC,SAAU,KAERytE,GAAc,IACd,EAAAtuE,GAAA,GAAaouE,GACbryE,KAAK2S,SAAS++D,gBAAgBc,eAAe,CAC3CC,KAAMzyE,KAAKyyE,KACXC,gBAAiB1yE,KAAK2yE,cACtBC,YAAa5yE,KAAK4yE,YAClBpB,MAAO,KACN9vE,MAAK,KACNkwE,OACEnkE,IACF8kE,GAAc,OAGlBx4B,UAAU,IAEZ/P,aAAc,uBACd0D,mBAAoB,6BAGhBwB,UAGR71B,EAAa3Z,OAAO6C,EAAWrB,UAAWkxE,EAAaC,GAEvDpB,EAAavxE,OAAO2Z,GAEpBrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAG3CwQ,qBACM0/D,GAASpxE,KAAKuxE,UAClBvxE,KAAKuC,WAAWxC,MAAM0M,S,qCEpJX,MAAMsmE,WAAsCvkE,EAM/Ca,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,8BACtDW,KAAK4P,SAAS,8BAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjCg2B,aAAa,IAIT4hC,EAAmBlyE,SAASC,cAAc,OAChD+xE,GAAiB,CACfzsE,IAAK2sE,EACLzvE,MAAO,IACPC,OAAQ,IACRgkC,MANY,OASdrsB,EAAQpK,QAAQrP,OAAOsxE,GAEvB,MAAM33D,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAMkD,EAAavC,KAAKuC,WAAa,IAAI,IAAW,CAClDkB,KAAM,OACN8V,MAAO,qCAGThX,EAAWxC,MAAMK,iBAAiB,YAAaC,IAC7C,GAAa,UAAVA,EAAEwP,IAEH,OADA,EAAAoY,EAAA,GAAY5nB,GACLkC,EAAW/B,MAAQ2xE,IAAoBa,OAIlD,MAAMpB,EAAS,CAACvxE,EAAW4yE,KACtB5yE,IACD,EAAA4nB,EAAA,GAAY5nB,GAGd,MAAMoyE,EAAOQ,EAAW1wE,EAAW/B,WAAQwJ,EAC3C,GAAGyoE,GAAQzyE,KAAK4yE,cAAgBH,EAE9B,YADA9mC,GAAM,YAAY,uBAAuB,IAI3C,MAAM76B,EAAM9Q,KAAKyO,OAAO+D,UAAUy/D,IAClCnhE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI6hE,cAAgB3yE,KAAK2yE,cACzB7hE,EAAI8hE,YAAc5yE,KAAK4yE,YACvB9hE,EAAI2hE,KAAOA,EAEX3hE,EAAI3B,QAGAijE,GAAc,OAAO,gCAAiC,CAAC3yE,KAAM,aAC7D4yE,GAAU,OAAO,4DAA6D,CAAC5yE,KAAM,kBAErF0yE,EAAmB9xE,GAAcuxE,EAAOvxE,GAAG,GAC3C2yE,EAAe3yE,GAAcuxE,EAAOvxE,GAAG,IAC7C,QAAiB+xE,EAAaD,IAC9B,QAAiBE,EAASW,GAE1B35D,EAAa3Z,OAAO6C,EAAWrB,UAAWkxE,EAAaC,GAEvDl5D,EAAQpK,QAAQrP,OAAO2Z,GAEvBrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAG3CwQ,qBACE1R,KAAKuC,WAAWxC,MAAM0M,SC7EX,MAAMymE,WAAiD1kE,EAM1Da,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,uCAAwC,2CAC9FW,KAAK4P,SAAS,yBAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjCg2B,aAAa,IAGT/1B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM0B,EAAqBf,KAAKe,mBAAqB,IAAI,KAAmB,CAC1E0C,KAAM,oBACN8V,MAAO,0BAGH45D,EAAS,IAAI,KAAepyE,EAAoB,KAEhDqxE,GAAc,OAAO,gCAAiC,CAAC3yE,KAAM,aAEnE4Z,EAAa3Z,OAAOqB,EAAmBG,UAAWkxE,GAClDj5D,EAAQpK,QAAQrP,OAAOyzE,EAAOjyE,UAAWmY,GAEzCrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAEzCH,EAAmBhB,MAAMK,iBAAiB,YAAaC,IAKrD,GAJGU,EAAmBhB,MAAMX,UAAUiG,SAAS,UAC7CtE,EAAmByrC,SAAS,EAAAC,EAAA,SAGjB,UAAVpsC,EAAEwP,IACH,OAAOsiE,OAIX,MAAMiB,EAAc,IACfpzE,KAAK4yE,cAAgB7xE,EAAmBP,QACzCO,EAAmB2rC,YACZ,GAMLylC,EAAmB9xE,IAKvB,GAJGA,IACD,EAAA4nB,EAAA,GAAY5nB,IAGV+yE,IAAe,OAEnB,MAAMtiE,EAAM9Q,KAAKyO,OAAO+D,UAAUugE,IAClCjiE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI6hE,cAAgB3yE,KAAK2yE,cACzB7hE,EAAI8hE,YAAc5yE,KAAK4yE,YACvB9hE,EAAI3B,QAIN,OAFA,QAAiBijE,EAAaD,GAEvBgB,EAAOhyE,OAGhBuQ,qBACE1R,KAAKe,mBAAmBhB,MAAM0M,SC/DnB,MAAM4mE,WAA+C7kE,EAApE,c,oBAIS,KAAA+iE,SAAU,EAEPliE,OACR,MAAMquC,GAAS19C,KAAKorC,MAAM5yB,OAAO86D,cAAgBtzE,KAAK2yE,cACtD3yE,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,wCACtDW,KAAK4P,SAAS8tC,EAAQ,2BAA6B,8BAEnD,MAAMvkC,EAAU,IAAIC,GAAe,CACjCg2B,aAAa,IAGT/1B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM0B,EAAqBf,KAAKe,mBAAqB,IAAI,KAAmB,CAC1E0C,KAAM,iBACN8V,MAAOmkC,EAAQ,2BAA8B19C,KAAKorC,MAAMqnC,UAAOzoE,EAAY,gBAC3EupE,WAAY71B,GAAS19C,KAAKorC,MAAMqnC,MAAO,EAAA75C,GAAA,GAAc54B,KAAKorC,MAAMqnC,WAAQzoE,IAGpEmpE,EAAS,IAAI,KAAepyE,EAAoB,KAEhDqxE,GAAc,OAAO,iCACrBpf,EAAS,IAAI,iBAAiB,CAACnjD,IAAK,aAE1CuiE,EAAY1yE,OAAOszD,EAAO5oD,SAE1BiP,EAAa3Z,OAAOqB,EAAmBG,UAAWkxE,GAClDj5D,EAAQpK,QAAQrP,OAAOyzE,EAAOjyE,UAAWmY,GAEzCrZ,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAEzCH,EAAmBhB,MAAMK,iBAAiB,YAAaC,IAOrD,GANGU,EAAmBhB,MAAMX,UAAUiG,SAAS,WAC7CtE,EAAmBhB,MAAMX,UAAUkB,OAAO,SAC1C0yD,EAAOnjD,IAAM,WACbmjD,EAAO36B,UAGI,UAAVh4B,EAAEwP,IACH,OAAOsiE,OAIX,MAAMiB,EAAc,MACdryE,EAAmBP,MAAMG,SAC3BI,EAAmBhB,MAAMX,UAAUC,IAAI,UAChC,GAMX,IAAI8yE,EACJ,GAAIz0B,EAkEFy0B,EAAmB9xE,IAKjB,GAJGA,IACD,EAAA4nB,EAAA,GAAY5nB,IAGV+yE,IAAe,OAEnB,MAAMtiE,EAAM9Q,KAAKyO,OAAO+D,UAAU0gE,IAClCpiE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI8hE,YAAc7xE,EAAmBP,MACrCsQ,EAAI6hE,cAAgB3yE,KAAK2yE,cACzB7hE,EAAI3B,YA7EG,CACT,IAAIqkE,EAEAC,EAAW,KAETD,IACFA,EAAmB1tE,OAAO8hD,YAAY6rB,EAAU,MAG3CzzE,KAAK2S,SAAS++D,gBAAgB+B,WAAW/xE,MAAMgyE,IACpD1zE,KAAKorC,MAAQsoC,EAEV1zE,KAAKorC,MAAMqnC,MACZ,EAAA95C,EAAA,GAAa53B,EAAmBwY,OAAO,EAAAqf,GAAA,GAAc54B,KAAKorC,MAAMqnC,QAEhE,EAAA7kE,EAAA,GAAe7M,EAAmBwY,OAAO,QAAK,sBA+CpD44D,EA1CgB9xE,IACd,IAAI+yE,IAEF,YADA,EAAAnrD,EAAA,GAAY5nB,GAId+xE,EAAY5yE,aAAa,WAAY,QACrCwzD,EAAOnjD,IAAM,aACbmjD,EAAO36B,SACP,MAAMnQ,GAAY,EAAAjkB,GAAA,GAAamuE,GAEzBO,EAAgB5xE,EAAmBP,MACzCR,KAAK2S,SAAS++D,gBAAgBiC,MAAM5yE,EAAmBP,MAAOR,KAAKorC,OAAO1pC,MAAMkyE,IAG9E,GAFAlmE,QAAQomB,IAAI8/C,GAEE,uBAAXA,EAAKhnE,EAA4B,CAClCq8C,cAAcuqB,GACXL,GAAQA,EAAO7yE,SAClB,MAAMwQ,EAAM9Q,KAAKyO,OAAO+D,UAAUqhE,IAClC/iE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI6hE,cAAgBA,EACpB7hE,EAAI3B,OACJnP,KAAKyO,OAAOqD,qBAAqB9R,UAEjCyN,IACF2kE,EAAYztE,gBAAgB,YAC5B5D,EAAmBhB,MAAMX,UAAUC,IAAI,SAEhCoO,EAAIxN,KAGP+yD,EAAOnjD,IAAM,8BACbmjD,EAAO36B,SACPnQ,EAAU5nB,SACVS,EAAmB8pC,SAIvB4oC,QAMJA,IAmBF,OAFA,QAAiBrB,EAAaD,GAEvBgB,EAAOhyE,OAGhBuQ,qBACM0/D,GAASpxE,KAAKuxE,UAClBvxE,KAAKe,mBAAmBhB,MAAM0M,SCvJnB,MAAMonE,WAAkCrlE,EAI3Ca,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,wBAAyB,8BACtDW,KAAK4P,SAAS,4BAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjC+1B,SAAS,EACTC,aAAa,IAIT4hC,EAAmBlyE,SAASC,cAAc,OAEhD+xE,GAAiB,CACfzsE,IAAK2sE,EACLzvE,MAAO,IACPC,OAAQ,IACRgkC,MAPY,OAUdrsB,EAAQpK,QAAQrP,OAAOsxE,GAEvB,MAAMl6D,EAAIqC,EAAQq/B,yBAClB,GAAGx4C,KAAKorC,MAAM5yB,OAAO86D,aAAc,EACjC,QAAMn6D,EAAQg2B,QAAS,2BAEvB,MAAM2kC,GAAoB,OAAO,8BAA+B,CAAC70E,KAAM,OAAQQ,KAAM,+BAC/Es0E,GAAqB,OAAO,8BAA+B,CAAC90E,KAAM,cAAeQ,KAAM,+BACvFu0E,GAAsB,OAAO,8BAA+B,CAAC/0E,KAAM,QAASQ,KAAMO,KAAKorC,MAAM5yB,OAAOy7D,aAAe,0BAA4B,4BAErJ,QAAiBH,GAAmB,KAClC,MAAMhjE,EAAM9Q,KAAKyO,OAAO+D,UAAU6gE,IAClCviE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI6hE,cAAgB3yE,KAAK2yE,cACzB7hE,EAAI3B,WAGN,QAAiB4kE,GAAoB,KACrB,IAAI7mC,GAAU,yBAA0B,CACpDC,QAAS,CAAC,CACR5B,QAAS,UACTzmC,SAAU,KACR9E,KAAK2S,SAAS++D,gBAAgBc,eAAe,CAACE,gBAAiB1yE,KAAK2yE,gBAAgBjxE,MAAK,KACvF1B,KAAKyO,OAAOuD,kBAAkBm/D,GAAgBnxE,MAC9CA,KAAKiP,YAGT8qC,UAAU,IAEZ/P,aAAc,+BACd0D,mBAAoB,4BAGhBwB,WAGR,QAAiB8kC,GAAqB,KACpC,MAAMljE,EAAM9Q,KAAKyO,OAAO+D,UAAUy/D,IAClCnhE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI2hE,KAAOzyE,KAAKorC,MAAMqnC,KACtB3hE,EAAI6hE,cAAgB3yE,KAAK2yE,cACzB7hE,EAAI8hE,YAAc5yE,KAAK2yE,cACvB7hE,EAAIygE,SAAU,EACdzgE,EAAI3B,UAGN2H,EAAEpX,OAAOo0E,EAAmBC,EAAoBC,OAC3C,EACL,QAAM76D,EAAQg2B,QAAS,+BAEvB,MAAM91B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM60E,GAAiB,OAAO,gCAAiC,CAACz0E,KAAM,mCAEtE4Z,EAAa3Z,OAAOw0E,GACpBp9D,EAAEpX,OAAO2Z,IAET,QAAiB66D,GAAiB7zE,IAChC,MAAMyQ,EAAM9Q,KAAKyO,OAAO+D,UAAU6gE,IAClCviE,EAAIs6B,MAAQprC,KAAKorC,MACjBt6B,EAAI3B,UAIRnP,KAAK8L,WAAW5K,UAAUxB,OAAOyZ,EAAQjY,YChG9B,MAAMizE,WAA8BrkE,EACvCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,qBAC5CW,KAAK4P,SAAS,mBAEd,MAAMu/B,EAAuB,gDAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,gBACPmhE,SAAU,iCACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACf6G,SAAU3S,KAAK2S,YCbN,MAAMyhE,WAAkCtkE,EAC3CT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,yBAC5CW,KAAK4P,SAAS,uBAEd,MAAMu/B,EAAuB,oDAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,2BACPmhE,SAAU,8BACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACfwjE,UAAW,CAAC,WACZ38D,SAAU3S,KAAK2S,YChBN,MAAM0hE,WAAqCvkE,EAC9CT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,4BAC5CW,KAAK4P,SAAS,4BAEd,MAAMu/B,EAAuB,gDAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,uBACPmhE,SAAU,0BACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACf6G,SAAU3S,KAAK2S,YCbN,MAAM2hE,WAAiCxkE,EAC1CT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,yBAC5CW,KAAK4P,SAAS,0BAEd,MAAMu/B,EAAuB,6CAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,cACPmhE,SAAU,4BACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACfwjE,UAAW,CAAC,WACZ38D,SAAU3S,KAAK2S,YChBN,MAAM4hE,WAA2BzkE,EACpCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,cAAe,iBAC5CW,KAAK4P,SAAS,8BAEd,MAAMu/B,EAAuB,iDAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,eACPmhE,SAAU,2BACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACf6G,SAAU3S,KAAK2S,WAGjB,CACE,MAAMw8B,EAAuB,qCAC7B,IAAI4/B,GAAe,CACjBj+D,IAAK9Q,KACL8O,MAAO,mBACPmhE,SAAU,0BACVhB,SAAU,CAAC9/B,EAASA,EAASA,GAC7BsgC,eAAgB,CAAC,uCAAwC,yCACzDp8B,SAAUrzC,KAAK8L,WACf6G,SAAU3S,KAAK2S,aCZR,MAAM6hE,WAA6B1kE,EAItCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,6BAC7BW,KAAK4P,SAAS,iBAEd,MAAM6kE,EAAWb,IACf,MAAMruD,EAAM,IAAI8jB,GAAI,CAClBv6B,MAAO,CAAC8kE,EAAKc,SAAUd,EAAKe,aAAahxD,KAAK,KAC9C8lB,SAAU,CAACmqC,EAAKgB,GAAIhB,EAAKiB,SAASlxD,KAAK,OACvCjZ,WAAW,EACXo/B,WAAY8pC,EAAKp7D,OAAOssC,aAAU96C,EAAYiK,EAA8B,IAAIvO,KAAqD,IAAhD/C,KAAKH,IAAIoxE,EAAKkB,YAAalB,EAAKmB,kBAGvHxvD,EAAIrkB,UAAU0G,QAAQkjE,KAAO,GAAK8I,EAAK9I,KAEvC,MAAMkK,EAAWl2E,SAASC,cAAc,OAMxC,OALAi2E,EAAS51E,UAAUC,IAAI,gBACvB21E,EAAS1wE,UAAY,CAACsvE,EAAKqB,aAAcrB,EAAKsB,gBAAkBtB,EAAK1e,UAAUvpC,OAAO6kB,SAAS7sB,KAAK,MAEpG4B,EAAIkkB,SAAS7lC,cAAcE,aAAakxE,EAAUzvD,EAAIkkB,UAE/ClkB,GAGH4vD,EAAiBn1E,KAAKm1E,eAAez0E,QAE3C,CACE,MAAMyY,EAAU,IAAIC,GAAe,CACjC3V,KAAM,iBACN0rC,QAAS,2BAGLykC,GAAO,EAAAn0D,GAAA,GAAc01D,GAAgBvB,GAAQA,EAAKp7D,OAAOssC,UACzDswB,EAAUX,EAAQb,GAIxB,GAFAz6D,EAAQpK,QAAQrP,OAAO01E,EAAQl0E,WAE5Bi0E,EAAex0E,OAAQ,CACxB,MAAM00E,GAAe,OAAO,qCAAsC,CAACp2E,KAAM,OAAQQ,KAAM,0BACvF,QAAiB41E,GAAeh1E,IAC9B,IAAI6sC,GAAU,iBAAkB,CAC9BC,QAAS,CAAC,CACR5B,QAAS,YACTwO,UAAU,EACVj1C,SAAU,KACR,MAAMtB,GAAS,EAAAurC,GAAA,GAAiB,CAACsmC,IAAe,GAChDr1E,KAAK2S,SAAS2iE,WAAWC,UAAU,4BAA4B7zE,MAAMlB,IAEnE60E,EAAa/0E,SACbk1E,EAAat0E,UAAUZ,WACtB0qD,GAAS9/B,SAAQ,KAClB1nB,UAINwmC,aAAc,0BACd0D,mBAAoB,uBACnBwB,UAGL/1B,EAAQpK,QAAQrP,OAAO21E,GAGzBr1E,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,IAAIi0E,EAAex0E,OACjB,OAGF,MAAM60E,EAAe,IAAIp8D,GAAe,CACtC3V,KAAM,gBACN0rC,QAAS,qBAGXgmC,EAAe/nE,SAASwmE,IACtB4B,EAAazmE,QAAQrP,OAAO+0E,EAAQb,GAAM1yE,cAG5ClB,KAAK8L,WAAWpM,OAAO81E,EAAat0E,WAEpC,MAAM8pD,EAAWv9C,IACC,wCAAbA,EAAIxN,MACL0rC,GAAM,YAAY,mCAAmC,KAIzD,IAAIxkC,EACJ,MAAMsuE,EAAmB,KACvB,MAAM3K,EAAO3jE,EAAOS,QAAQkjE,KAE5B,IAAI59B,GAAU,iBAAkB,CAC9BC,QAAS,CAAC,CACR5B,QAAS,YACTwO,UAAU,EACVj1C,SAAU,KACR9E,KAAK2S,SAAS2iE,WAAWC,UAAU,6BAA8B,CAACzK,KAAAA,IACjEppE,MAAMlB,IACFA,GACD2G,EAAO7G,WAER0qD,MAGPhhB,aAAc,yBACd0D,mBAAoB,yBACnBwB,QAGC9kC,EAAUpK,KAAKgiD,YAAc,GAAW,CAAC,CAC7C/iD,KAAM,OACNQ,KAAM,YACNuoB,QAASytD,KAEXrrE,EAAQoG,GAAK,8BACbpG,EAAQhL,UAAUC,IAAI,eAEtBP,SAASstD,eAAe,cAAc1sD,OAAO0K,GAE7C4yD,GAA0Bh9D,KAAK8L,WAAW5K,WAAYb,IACpD8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,OAC/BA,GAAkC,MAAxBA,EAAOS,QAAQkjE,OAI1BzqE,aAAao9B,YAAYp9B,EAAEu0B,iBAE3Bv0B,aAAao9B,aAAYp9B,EAAEoH,cAAe,GAE7Ck+D,GAAatlE,EAAG+J,GAChB,eAAkCA,QAGpC,QAAiBpK,KAAK8L,WAAW5K,WAAYb,IAC3C8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,OAC/BA,GAAkC,MAAxBA,EAAOS,QAAQkjE,MAI7B2K,OAIJjmE,sBAKE,OAJGxP,KAAKgiD,aACNhiD,KAAKgiD,YAAY1hD,SAGZT,MAAM2P,uBC3JF,MAAMkmE,WAA2BlnE,EAIpCa,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,2BAC7BW,KAAK4P,SAAS,gBAEd,MAAMuJ,EAAU,IAAIC,GAAe,CACjC+1B,QAAS,qBAGXh2B,EAAQg2B,QAAQvrC,cAAcC,QAAQsV,EAAQg2B,SAE9CnvC,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/B,MAAMy0E,EAAS,EAAa,CAAC12E,KAAM,MAAON,UAAW,eACrDqB,KAAK+O,QAAQrP,OAAOi2E,IAEpB,QAAiBA,GAASt1E,IACxB,IAAI81C,GAAc,CAChBI,UAAW,CAAC,YACZxoC,YAAa,gCACbsoC,SAAW9pC,IAETvM,KAAK2S,SAAS2I,gBAAgBs6D,YAAYrpE,GAAQ,QAGrD,CAACtD,eAAgBjJ,KAAKiJ,iBAEzB,MAAM4B,EAAO,oBACb7K,KAAK8L,WAAW5K,UAAU9B,UAAUC,IAAI,sBACxC8Z,EAAQpK,QAAQrP,OAAOmL,GAEvB,MAAMxL,EAAM,CAAMkN,EAAgB7M,KAAoB,O,EAAA,K,OAAA,E,EAAA,YACpD,MAAM,IAACyb,GAAO,gBAA+B,CAC3C5O,OAAQA,EACRrL,UAAW2J,EACXuQ,eAAe,EACf7N,WAAY,GACZ7N,OAAAA,IAGI6Y,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,GACtDgM,EAAKC,OAAOC,IACb0C,EAAIE,gBAAgB3b,OAAO,IAAM6Y,EAAKyzB,UAEnCzzB,EAAK+kC,MAAOniC,EAAIE,gBAAgB/W,UAAY+4C,GAAgB9kC,EAAK+kC,OAC/DniC,EAAIE,gBAAgB3b,OAAO6Y,EAAKyzB,SAAW,IAAMzzB,EAAKyzB,SAAW1zB,GAAoBC,K,YAdxC,K,+QAqBtD,IAAI,MAAMhM,KAAUvM,KAAKwa,QACvBnb,EAAIkN,GAAQ,GAGd,IAAIpF,EACJ,MAKMiD,EAAUpK,KAAKgiD,YAAc,GAAW,CAAC,CAC7C/iD,KAAM,UACNQ,KAAM,UACNuoB,QARgB,KAChB,MAAMzb,EAASpF,EAAOS,QAAQ2E,OAAOsO,WACrC7a,KAAK2S,SAAS2I,gBAAgBs6D,YAAYrpE,GAAQ,IAOlD3N,QAAS,CAACqK,eAAgBjJ,KAAKiJ,mBAEjCmB,EAAQoG,GAAK,4BACbpG,EAAQhL,UAAUC,IAAI,eAEtBP,SAASstD,eAAe,cAAc1sD,OAAO0K,GAE7C4yD,GAA0Bh9D,KAAK8L,WAAW5K,WAAYb,IACpD8G,GAAS,EAAAsxC,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IACzBvxC,IAID9G,aAAao9B,YAAYp9B,EAAEu0B,iBAE3Bv0B,aAAao9B,aAAYp9B,EAAEoH,cAAe,GAE7Ck+D,GAAatlE,EAAG+J,GAChB,eAAkCA,MACjCpK,KAAKiJ,gBAERjJ,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,cAAeq4B,IAChD,MAAM,OAAC9rB,EAAM,QAAEspE,GAAWx9C,EACpBwa,EAAKhoC,EAAK3F,cAAc,kBAAkBqH,OAC7CspE,EACGhjC,GACFxzC,EAAIkN,GAAQ,GAGXsmC,GACDA,EAAGvyC,YAMT,IAAIyvC,GAAU,EACd/vC,KAAK8L,WAAWO,iBAAmB,KAC9B0jC,IAIHA,GAAU,EACV/vC,KAAK2S,SAAS2I,gBAAgBw6D,WAAWjrE,EAAKI,kBAR7B,IAQ4DvJ,MAAMoL,IACjF,IAAI,MAAMP,KAAUO,EAAI0N,QACtBnb,EAAIkN,GAAQ,IAGXO,EAAI0N,QAAQ7Z,OAbA,IAauBkK,EAAKI,oBAAsB6B,EAAIC,SACnE/M,KAAK8L,WAAWO,iBAAmB,MAGrCrM,KAAK8L,WAAWokC,sBACfhlB,SAAQ,KACT6kB,GAAU,OAKhBr+B,qBACE1R,KAAK8L,WAAWg5B,WAGlBt1B,sBAKE,OAJGxP,KAAKgiD,aACNhiD,KAAKgiD,YAAY1hD,SAGZT,MAAM2P,uBC/JF,SAASumE,GAAqBlmE,GAG3C,MADM,SADAA,EAAI,GAAGmmE,cAAgBnmE,EAAInP,MAAM,IC+B1B,MAAMu1E,WAAiCnmE,EAI1CT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,wBAC7BW,KAAK4P,SAAS,mBAEd,MAAMsmE,EAAwB,UAE9B,CACE,MAAM/8D,EAAU,IAAIC,GAAe,CAACg2B,aAAa,EAAMD,QAAS,iBAEhE,IAAIgnC,EACJ,MAAMC,EAAkB,IAAI/sC,GAAI,CAC9BpqC,KAAM,aACN+qC,aAAc,eACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT,MAAMoG,EAAM9Q,KAAKyO,OAAO+D,UAAUkjE,IAClC5kE,EAAI0J,QAAU27D,EACdrlE,EAAI3B,UAKR,IAAIknE,EAFJD,EAAgB9sC,SAAU,EAG1B,MAuBMgtC,EAAe,IAAIjtC,GAvBG,CAC1BpqC,KAAM,OACN+qC,aAAc,sBACdN,gBAAiBwsC,EACjBxrE,UAAYrK,IACV,IAAIyQ,EACDulE,EAAc79D,OAAO86D,aACtBxiE,EAAM9Q,KAAKyO,OAAO+D,UAAU6gE,IACpBgD,EAAcE,2BACtBzlE,EAAM9Q,KAAKyO,OAAO+D,UAAU8+D,IAC5BxgE,EAAI0gE,MAAQ6E,EAAcE,0BAC1BzlE,EAAInQ,OAAS,EACbmQ,EAAIygE,SAAU,EACdvxE,KAAK2S,SAAS++D,gBAAgBQ,uBAE9BphE,EAAM9Q,KAAKyO,OAAO+D,UAAUqhE,IAG9B/iE,EAAIs6B,MAAQirC,EACZvlE,EAAI3B,UAKRmnE,EAAahtC,SAAU,EAEvB,MAAMktC,EAAoBx2E,KAAKw2E,kBAAoB,IAAIntC,GAAI,CACzDpqC,KAAM,iBACN+qC,aAAc,gBACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT,MAAMoG,EAAM9Q,KAAKyO,OAAO+D,UAAUgiE,IAClC1jE,EAAIqkE,eAAiBn1E,KAAKm1E,eAC1BrkE,EAAIf,cAAc3P,iBAAiB,WAAW,KAC5CJ,KAAKy2E,yBACJ,CAACjvE,MAAM,IACVsJ,EAAI3B,UAGRqnE,EAAkBltC,SAAU,EAE5BnwB,EAAQpK,QAAQrP,OAAO02E,EAAgBl1E,UAAWo1E,EAAap1E,UAAWs1E,EAAkBt1E,WAC5FlB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/B,MAAMw1E,EAAmB3pE,IACpBA,GACD,EAAAa,EAAA,GAAewoE,EAAgB3sC,UAAU,QAAK,sCAAuC,CAAC18B,MAEtF,EAAAa,EAAA,GAAewoE,EAAgB3sC,UAAU,QAAK,eAAgB,CAAC18B,MAInE/M,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,cAAc,KAM/C22E,OAGF,MAAMA,EAAgB,KACpB32E,KAAK2S,SAAS2I,gBAAgBw6D,aAAap0E,MAAMoL,IAC/CspE,EAAgB9sC,SAAU,EAC1BotC,EAAgB5pE,EAAIC,OACpBopE,EAAiBrpE,EAAI0N,YAIzBm8D,IAEA32E,KAAK2S,SAAS++D,gBAAgB+B,WAAW/xE,MAAM0pC,IAC7CirC,EAAgBjrC,GAChB,EAAAx9B,EAAA,GAAe0oE,EAAa7sC,UAAU,QAAK2B,EAAM5yB,OAAO86D,aAAe,6BAA+B,gCACtGgD,EAAahtC,SAAU,KAKzBtpC,KAAKy2E,uBAGP,CACE,MAAMt9D,EAAU,IAAIC,GAAe,CAAC3V,KAAM,eAAgB0rC,QAAS,0BAEnEh2B,EAAQpK,QAAQ3P,UAAUC,IAAI,gCAE9B,MAAMu3E,EAED,GAECC,EAAsBD,EAAuC,2BAAI,IAAIvtC,GAAI,CAC7EW,aAAc,oBACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU+9D,IAA0BphE,UAI9C2nE,EAAkBF,EAA2C,+BAAI,IAAIvtC,GAAI,CAC7EW,aAAc,gBACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU2hE,IAAuBhlE,UAI3C4nE,EAAqBH,EAAwC,4BAAI,IAAIvtC,GAAI,CAC7EW,aAAc,2BACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU4hE,IAA2BjlE,UAI/C6nE,EAAUJ,EAAqC,yBAAI,IAAIvtC,GAAI,CAC/DW,aAAc,eACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU+hE,IAAoBplE,UAIxC8nE,EAAiBL,EAAoC,wBAAI,IAAIvtC,GAAI,CACrEW,aAAc,uBACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU6hE,IAA8BllE,UAIlD+nE,EAAmBN,EAAsC,0BAAI,IAAIvtC,GAAI,CACzEW,aAAc,cACdN,gBAAiBwsC,EACjBxrE,UAAW,KACT1K,KAAKyO,OAAO+D,UAAU8hE,IAA0BnlE,UAI9CgoE,EAAoBtnE,IACxB,MAAM0V,EAAMqxD,EAAW/mE,GACnB0V,GAIJvlB,KAAK2S,SAASo9D,kBAAkBC,WAAWngE,GAAKnO,MAAM8sE,IACpD,MAAM9kD,EAAU6kD,GAAuBC,GACjCjjC,EAAU7hB,EAAQzpB,OAAS,aAAwB,qCAAwCypB,EAAQzpB,OAAS,YAAuB,uCAAyC,mCAC5Km3E,EAAiB1tD,EAAQklD,cAAcnY,MAAM91D,OAAS+oB,EAAQklD,cAAcD,MAAMhuE,OAClF02E,EAAc3tD,EAAQglD,WAAWjY,MAAM91D,OAAS+oB,EAAQglD,WAAWC,MAAMhuE,OAE/E4kB,EAAIkkB,SAASnlC,UAAY,GACzB,MAAMy1B,GAAI,QAAKwR,GACfhmB,EAAIkkB,SAAS/pC,OAAOq6B,IACjBq9C,GAAkBC,IACnB9xD,EAAIkkB,SAAS/pC,OAAO,KAAK,EAAE03E,EAAgBC,EAAc,IAAMA,EAAc,GAAG1rD,OAAO6kB,SAAS7sB,KAAK,cAK3GxK,EAAQpK,QAAQrP,OACdm3E,EAAoB31E,UACpB41E,EAAgB51E,UAChB61E,EAAmB71E,UACnB81E,EAAQ91E,UACR+1E,EAAe/1E,UACfg2E,EAAiBh2E,WAEnBlB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/B,IAAI,MAAM2O,KAAO+mE,EACfO,EAAiBtnE,GAGnB,qBAA2B,kBAAmBwoB,IAC5C8+C,EAAiBpB,GAAqB19C,EAAOxoB,IAAIjD,OAIrD,MAAMnD,EAA2B,GACjC,CACE,MAAM0P,EAAU,IAAIC,GAAe,CAAC3V,KAAM,6BAC1C0V,EAAQjY,UAAU9B,UAAUC,IAAI,QAEhCoK,EAASoI,KAAK7R,KAAK2S,SAAS2iE,WAAWC,UAAU,8BAA8B7zE,MAAM41E,IACnF,IAAIA,EAAS9+D,OAAO++D,qBAClB,OAGF,MAAMp5B,EAAUm5B,EAAS9+D,OAAOg/D,kBAE1BC,EAAe,IAAIpuC,GAAI,CAC3BG,cAAe,IAAI,KAAc,CAAC/pC,KAAM,mCAAoC2pC,QAAS+U,IACrFzU,gBAAiB,mCACjBK,oBAAoB,IAGtB5wB,EAAQpK,QAAQrP,OAAO+3E,EAAav2E,WACpCiY,EAAQjY,UAAU9B,UAAUkB,OAAO,QAEnCN,KAAK+P,cAAc3P,iBAAiB,WAAW,KAC7C,MAAMs3E,EAAWD,EAAajuC,cAAcJ,QAC1BsuC,IAAav5B,GAK/Bn+C,KAAK2S,SAAS2iE,WAAWC,UAAU,6BAA8B,CAC/DiC,kBAAmBE,MAEpB,CAAClwE,MAAM,QAGZxH,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,CACE,MAAMiY,EAAU,IAAIC,GAAe,CAAC3V,KAAM,gBAEpC2jE,EAAgB,KACN,IAAIl6B,GAAU,sBAAuB,CACjDC,QAAS,CAAC,CACR5B,QAAS,SACTzmC,SAAU,KACR,MAAMtB,GAAS,EAAAurC,GAAA,GAAiB,CAAC4oC,IAAe,GAChD33E,KAAK2S,SAASilE,iBAAiBC,iBAAiBn2E,MAAK,KACnD8B,QAGJu2C,UAAU,IAEZ/P,aAAc,6BACd0D,mBAAoB,0BAGhBwB,QAGFyoC,GAAe,OAAO,8BAA+B,CAAC14E,KAAM,SAAUQ,KAAM,6BAClFO,KAAKiJ,eAAe5J,IAAIs4E,EAAxB33E,CAAsC,QAASonE,GAC/CjuD,EAAQpK,QAAQrP,OAAOi4E,GAcvB33E,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,OAAOiC,QAAQC,IAAIqG,GAGdgtE,uBACLz2E,KAAK2S,SAAS2iE,WAAWC,UAAU,6BAA6B7zE,MAAMo2E,IACpE93E,KAAKw2E,kBAAkBltC,SAAU,EACjCtpC,KAAKm1E,eAAiB2C,EAAM3C,gBAC5B,QAAMn1E,KAAKw2E,kBAAkB/sC,SAAU,kBAAmB,CAACzpC,KAAKm1E,eAAex0E,aC5T9E,SAASo3E,GAAuB/0E,GACrC,MAAM+nB,EAAU/nB,EAAO6P,WAAW,MAE5BmlE,EAAQ,IAAI5mE,MAAM,GAAGojD,KAAK,GAC1ByjB,EAASltD,EAAQmtD,aAAa,EAAG,EAAGl1E,EAAOzB,MAAOyB,EAAOxB,QAAQmlC,KACvE,IAAI,IAAI56B,EAAI,EAAGA,EAAIksE,EAAOt3E,OAAQoL,GAAK,EACrCisE,EAAM,IAAMC,EAAOlsE,GACnBisE,EAAM,IAAMC,EAAOlsE,EAAI,GACvBisE,EAAM,IAAMC,EAAOlsE,EAAI,GACvBisE,EAAM,IAAMC,EAAOlsE,EAAI,GAGzB,MAAMosE,EAAeF,EAAOt3E,OAAS,EAC/By3E,EAAW,IAAIC,kBAAkB,GAKvC,OAJAD,EAAS,GAAKJ,EAAM,GAAKG,EACzBC,EAAS,GAAKJ,EAAM,GAAKG,EACzBC,EAAS,GAAKJ,EAAM,GAAKG,EACzBC,EAAS,GAAKJ,EAAM,GAAKG,EAClBC,ECvBM,SAASE,GAAmBC,GACzC,IAAI,EAAC/3D,EAAC,EAAEuZ,EAAC,EAAEy+C,IAAK,SAAWD,EAAK,GAAIA,EAAK,GAAIA,EAAK,IAOlD,OANGx+C,EAAI,IACLA,EAAIp3B,KAAKC,IAAI,IAAKm3B,EAAI,EAAI,IAAO,IAAMA,KAEzCy+C,EAAI71E,KAAKH,IAAI,EAAO,IAAJg2E,GAEH,QAAQh4D,MAAMuZ,OAAOy+C,UCErB,MAAMC,GAkDnB74E,cAjDiB,KAAA84E,OAJL,GAKK,KAAAC,QALL,GAQK,KAAAC,OAAS,GACT,KAAAC,aAAe,GAUf,KAAAC,OAAS,CACxB,EAAI,IAAO,GAAO,IAAO,EAAI,IAAM,EAAI,IAAM,EAAI,IAAM,EAAI,EAAI,EAAI,EAAI,EAAI,EAAI,GAAK,GAAK,GACzF,GAAK,GAAK,GAAK,GAAK,GAAK,GAAK,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KACtF,GAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,GAAO,KAAO,KACpF,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,KAAO,IAGrE,KAAAC,WAAa,CAC5B,CAAE/xE,EAAG,GAAMC,EAAG,IACd,CAAED,EAAG,GAAMC,EAAG,IACd,CAAED,EAAG,IAAMC,EAAG,KACd,CAAED,EAAG,IAAMC,EAAG,IACd,CAAED,EAAG,GAAMC,EAAG,IACd,CAAED,EAAG,GAAMC,EAAG,IACd,CAAED,EAAG,IAAMC,EAAG,KACd,CAAED,EAAG,IAAMC,EAAG,KAEC,KAAA+xE,QAAUh5E,KAAK+4E,WAAWp4E,OAiGnC,KAAAs4E,QAAW54E,IACdL,KAAKk5E,2BAIRl5E,KAAKm5E,cAAgB94E,EAAE+4E,YACCpvE,IAArBhK,KAAKq5E,cACNr5E,KAAKq5E,YAAc9yE,sBAAsBvG,KAAKs5E,gBAI1C,KAAAA,YAAc,KACpB,IAAIzgE,EAAO7Y,KAAKm5E,aAAen5E,KAAK64E,aAGpC,GAFA74E,KAAKm5E,cAAgBn5E,KAAK64E,aAC1BhgE,EAAOA,EAAO,EAAIlW,KAAK6uB,MAAM3Y,GAAQlW,KAAKoR,KAAK8E,GAC5CA,EAAM,CACP7Y,KAAKu5E,WAAW1gE,GAChB,MAAM2gE,EAASx5E,KAAKy5E,YAAYz5E,KAAK05E,OAAQ15E,KAAK25E,OAClD35E,KAAK45E,aAAaJ,GAEpBx5E,KAAKq5E,iBAAcrvE,GAGb,KAAA6vE,yBAA2B,KACjC,MAAMC,EAAS95E,KAAK+5E,QACdvpE,EAAKspE,EAAO5sE,QACfsD,GACDxQ,KAAKg6E,cAAcxpE,GAGrB,MAAMypE,EAAaH,EAAOn5E,OAK1B,OAJIs5E,IACFj6E,KAAKk5E,8BAA2BlvE,KAGzBiwE,GAlHT,MAAMphE,EAAO7Y,KAAK44E,OAAS54E,KAAK84E,OAAO94E,KAAK84E,OAAOn4E,OAAS,GAE5D,IAAI,IAAIoL,EAAI,EAAGpL,EAASX,KAAK84E,OAAOn4E,OAAQoL,EAAIpL,IAAUoL,EACxD/L,KAAK84E,OAAO/sE,GAAK/L,KAAK84E,OAAO/sE,GAAK8M,EAGpC7Y,KAAKk6E,kBAAoBl6E,KAAK84E,OAAOn+D,KAAI,CAACksB,EAAG96B,EAAG6U,K,MAC9C,OAAOimB,GAAe,QAAV,EAAAjmB,EAAI7U,EAAI,UAAE,QAAI,MAItBouE,SAASngB,GACf,MAAM1qD,GAAS,SAAS0qD,GACxB,MAAO,CAAC50D,EAAGkK,EAAO,GAAI2qD,EAAG3qD,EAAO,GAAIy7C,EAAGz7C,EAAO,IAGxC8qE,aAAaltE,GACnB,MAAMmtE,EAAYr6E,KAAK+4E,WAAWr4E,QAClC,KAAMwM,EAAQ,GACZmtE,EAAUxoE,KAAKwoE,EAAUntE,WACvBA,EAGJ,MAAMoC,EAA2B,GACjC,IAAI,IAAIvD,EAAI,EAAGA,EAAIsuE,EAAU15E,OAAQoL,GAAK,EACxCuD,EAAOuC,KAAKwoE,EAAUtuE,IAExB,OAAOuD,EAGDgrE,iBAAiBC,EAAeC,EAAkBC,GACxD,MAAM1f,EAAM/6D,KAAKo6E,aAAaG,GAC9B,IAAIE,EAAM,IAAuB,IAAjBA,EAAM95E,OACpB,MAAO,CAACo6D,GAGV,MACM2f,EADU16E,KAAKo6E,eAAeG,EAAQv6E,KAAKg5E,SACvBr+D,KAAI,CAACggE,EAASt8D,KAC/B,CACLrX,GAAI2zE,EAAQ3zE,EAAI+zD,EAAI18C,GAAKrX,GAAKwzE,EAC9BvzE,GAAI0zE,EAAQ1zE,EAAI8zD,EAAI18C,GAAKpX,GAAKuzE,MAalC,OATkBC,EAAM9/D,KAAKna,GACpBk6E,EAAU//D,KAAI,CAACxD,EAAUkH,KACvB,CACLrX,EAAG+zD,EAAI18C,GAAKrX,EAAImQ,EAASnQ,EAAIxG,EAC7ByG,EAAG8zD,EAAI18C,GAAKpX,EAAIkQ,EAASlQ,EAAIzG,QAQ7Bi5E,YAAYc,EAAeK,GAEjC,OADkB56E,KAAKs6E,iBAAiBC,EAAOv6E,KAAK44E,OAAQ,CAACgC,IAC5C,GAGXrB,WAAW1gE,GAGjB,IAFA7Y,KAAK25E,OAAS9gE,EAER7Y,KAAK25E,OAAS35E,KAAK44E,QACvB54E,KAAK25E,OAAS35E,KAAK44E,SACd54E,KAAK05E,QAAU15E,KAAKg5E,UACvBh5E,KAAK05E,QAAU15E,KAAKg5E,SAIxB,KAAMh5E,KAAK25E,MAAQ,GACjB35E,KAAK25E,OAAS35E,KAAK44E,SACd54E,KAAK05E,OAAS,IACjB15E,KAAK05E,QAAU15E,KAAKg5E,SA2ClB6B,qBAAqBR,GAC3B,MAAM7pE,EAAKxQ,KAAK86E,MAAMC,gBAAgB/6E,KAAK04E,OAAQ14E,KAAK24E,SAClDV,EAASznE,EAAGm2B,KAElB,IAAI3iB,EAAS,EACb,IAAI,IAAI/c,EAAI,EAAGA,EAAIjH,KAAK24E,UAAW1xE,EAAG,CACpC,MACM+zE,EADe/zE,EAAIjH,KAAK24E,QACS,GACjCsC,EAAmBD,EAAkBA,EAE3C,IAAI,IAAIh0E,EAAI,EAAGA,EAAIhH,KAAK04E,SAAU1xE,EAAG,CACnC,MAEMk0E,EAFel0E,EAAIhH,KAAK04E,OAES,GAGjCyC,EAAc,IAFGx4E,KAAKmE,KAAKo0E,EAAkBA,EAAkBD,GAG/DG,EAAQD,EAAcA,EAAc,GAAM,EAC1CE,EAAW14E,KAAK24E,IAAIF,GACpBG,EAAW54E,KAAK64E,IAAIJ,GAEpBK,EAAS94E,KAAKH,IAAI,EAAKG,KAAKC,IAAI,EAAK,GAAMs4E,EAAkBK,EAAWP,EAAkBK,IAC1FK,EAAS/4E,KAAKH,IAAI,EAAKG,KAAKC,IAAI,EAAK,GAAMs4E,EAAkBG,EAAWL,EAAkBO,IAEhG,IAAII,EAAc,EAEdv2E,EAAI,EACJ60D,EAAI,EACJlP,EAAI,EAER,IAAI,IAAIh/C,EAAI,EAAGA,EAAI/L,KAAK47E,QAAQj7E,OAAQoL,IAAK,CAC3C,MAGM8vE,EAAYJ,EAHHpB,EAAUtuE,GAAG/E,EAItB80E,EAAYJ,EAHHrB,EAAUtuE,GAAG9E,EAK5B,IAAIkQ,EAAWxU,KAAKH,IAAI,EAAK,GAAMG,KAAKmE,KAAK+0E,EAAYA,EAAYC,EAAYA,IACjF3kE,GAAWA,EAAWA,EAAWA,EACjCwkE,GAAexkE,EAEf/R,GAAK+R,EAAWnX,KAAK47E,QAAQ7vE,GAAG3G,EAAI,IACpC60D,GAAK9iD,EAAWnX,KAAK47E,QAAQ7vE,GAAGkuD,EAAI,IACpClP,GAAK5zC,EAAWnX,KAAK47E,QAAQ7vE,GAAGg/C,EAAI,IAGtCktB,EAAOj0D,KAAY5e,EAAIu2E,EAAc,IACrC1D,EAAOj0D,KAAYi2C,EAAI0hB,EAAc,IACrC1D,EAAOj0D,KAAY+mC,EAAI4wB,EAAc,IACrC1D,EAAOj0D,KAAY,KAGvB,OAAOxT,EAGDwpE,cAAcxpE,GACpBxQ,KAAK86E,MAAMiB,aAAavrE,EAAI,EAAG,GAC/BxQ,KAAKg8E,KAAKpwD,UAAU5rB,KAAKi8E,IAAK,EAAG,EAAGj8E,KAAK04E,OAAQ14E,KAAK24E,SAGhDiB,aAAaS,GACnBr6E,KAAKg6E,cAAch6E,KAAK66E,qBAAqBR,IAyBxChrE,KAAKkC,GACVvR,KAAK+5E,QAAU,GACf/5E,KAAK05E,OAAS,EACd15E,KAAK25E,MAAQ,EACb35E,KAAKm5E,aAAe,OACInvE,IAArBhK,KAAKq5E,cACNviD,qBAAqB92B,KAAKq5E,aAC1Br5E,KAAKq5E,iBAAcrvE,GAGrB,MAAMkyE,EAAS3qE,EAAG4qE,aAAa,eAAez5C,MAAM,KAAKvI,UACzDn6B,KAAK47E,QAAUM,EAAOvhE,KAAK2N,GAClBtoB,KAAKm6E,SAAS7xD,KAGnBtoB,KAAKi8E,MACPj8E,KAAKi8E,IAAMn9E,SAASC,cAAc,UAClCiB,KAAKi8E,IAAI16E,MAAQvB,KAAK04E,OACtB14E,KAAKi8E,IAAIz6E,OAASxB,KAAK24E,QACvB34E,KAAK86E,MAAQ96E,KAAKi8E,IAAIppE,WAAW,OAGnC7S,KAAKo8E,QAAU7qE,EACfvR,KAAKg8E,KAAOh8E,KAAKo8E,QAAQvpE,WAAW,MACpC7S,KAAKq4B,SAGAA,SACL,GAAGr4B,KAAK47E,QAAQj7E,OAAS,EAAG,CAC1B,MAAM2nB,EAAQtoB,KAAK47E,QAAQ,GAG3B,OAFA57E,KAAKg8E,KAAKK,UAAY,OAAO/zD,EAAMljB,MAAMkjB,EAAM2xC,MAAM3xC,EAAMyiC,UAC3D/qD,KAAKg8E,KAAKM,SAAS,EAAG,EAAGt8E,KAAK04E,OAAQ14E,KAAK24E,SAI7C,MAAM5d,EAAM/6D,KAAKy5E,YAAYz5E,KAAK05E,OAAQ15E,KAAK25E,OAC/C35E,KAAK45E,aAAa7e,GAGbwhB,iB,MACL,GAAGv8E,KAAK47E,QAAQj7E,OAAS,EACvB,OAGF,MAAMi6E,EAAO56E,KAAK25E,MACZ6C,EAAQx8E,KAAK44E,OAEnB,IAAI6D,EAEJ,MAAMhC,EAAkB,GACxB,IAAI,IAAI1uE,EAAI,EAAGpL,EAASX,KAAKk6E,kBAAkBv5E,OAAQoL,EAAIpL,IAAUoL,EAAG,CACtE,MAAM2wE,EAAM18E,KAAKk6E,kBAAkBnuE,GACnC,IAAIvL,GAAqB,QAAZ,EAAAi6E,EAAM1uE,EAAI,UAAE,QAAI6uE,GAAQ8B,GAEjCl8E,EAAMyzB,QAAQ,GAAKuoD,QAA4BxyE,IAAnByyE,IAC9BA,EAAiB1wE,EACjBvL,GAASg8E,GAGX/B,EAAM5oE,KAAKrR,GAMb,CAH0Bi6E,EAAM/5E,MAAM,EAAG+7E,QACCzyE,IAAnByyE,EAA+BhC,EAAM/5E,MAAM+7E,GAAkB,IAEhDrvE,SAAQ,CAACqtE,EAAOp8D,EAAKs+D,KACvD,MAAMp8B,EAAOk6B,EAAMA,EAAM95E,OAAS,GAOlC,QANYqJ,IAATu2C,GAAsBA,EAAOi8B,IAC9B/B,EAAMA,EAAM95E,OAAS,IAAM4/C,EAAKtsB,QAAQ,IAG1Cj0B,KAAK25E,MAAQp5B,MAAAA,EAAAA,EAAQ,GAEjBk6B,EAAM95E,OACR,OAGF,MAAM05E,EAAYr6E,KAAKs6E,iBAAiBt6E,KAAK05E,OAAQ8C,EAAO/B,GACzDp8D,IAASs+D,EAAOh8E,OAAS,KACrBX,KAAK05E,QAAU15E,KAAKg5E,UACvBh5E,KAAK05E,QAAU15E,KAAKg5E,SAIxB,MAAMhM,EAAMqN,EAAU1/D,KAAKogD,GAClB/6D,KAAK66E,qBAAqB9f,KAGnC/6D,KAAK+5E,QAAQloE,QAAQm7D,MAGvBhtE,KAAKk5E,0BAA2B,GAChC,SAAQl5E,KAAK65E,0BAGR+C,cAAclyD,GAChB1qB,KAAK47E,QAAQj7E,OAAS,GAAK+pB,IAI3BA,IAAU1qB,KAAK68E,sBAChB/9E,SAASsB,iBAAiB,QAASJ,KAAKi5E,SACxCj5E,KAAK68E,sBAAuB,IACnBnyD,GAAS1qB,KAAK68E,uBACvB/9E,SAASuH,oBAAoB,QAASrG,KAAKi5E,SAC3Cj5E,KAAK68E,sBAAuB,IAIzB5sE,UACLjQ,KAAK48E,eAAc,GAIdn5D,oBAAoBy4D,GACzB,MAAMl5E,EAASlE,SAASC,cAAc,UAOtC,OANAiE,EAAOzB,MArXG,GAsXVyB,EAAOxB,OAtXG,QAuXIwI,IAAXkyE,IACDl5E,EAAO4E,QAAQs0E,OAASA,GAGnBl5E,EAGFygB,cAAcy4D,GACnB,MAAMl5E,EAAShD,KAAK88E,aAAaZ,GAC3Ba,EAAmB,IAAItE,GAG7B,OAFAsE,EAAiB1tE,KAAKrM,GAEf,CAAC+5E,iBAAAA,EAAkB/5E,OAAAA,I,eC7Xf,MAAMg6E,GAyBnBp9E,cAhBO,KAAAq9E,IAAM,EACN,KAAAC,WAAa,IACb,KAAAC,UAAY,GACZ,KAAAzxD,MAAQ,EACP,KAAAuO,SAOJ,GAoGI,KAAAmjD,YAAc,KACpBt+E,SAASguD,gBAAgB7pD,MAAMo/C,OAASriD,KAAKi6B,SAASojD,WAAWp6E,MAAMo/C,OAAS,YAG1E,KAAAi7B,UAAY,KAClBx+E,SAASguD,gBAAgB7pD,MAAMo/C,OAASriD,KAAKi6B,SAASojD,WAAWp6E,MAAMo/C,OAAS,IAnGhFriD,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI29E,GAAYp5B,YAEzC,MAAMx/C,EAAO,uBACG44E,GAAYp5B,WAAa,g+BAgBvBo5B,GAAYp5B,WAAa,cAAco5B,GAAYp5B,WAAa,mKAIlEo5B,GAAYp5B,WAAa,qCACvBo5B,GAAYp5B,WAAa,6tBAavBo5B,GAAYp5B,WAAa,cAAco5B,GAAYp5B,WAAa,mLAOpF5jD,KAAKkB,UAAUoD,UAAYF,EAE3BpE,KAAKi6B,SAASsjD,IAAMv9E,KAAKkB,UAAU6nB,kBACnC/oB,KAAKi6B,SAASojD,WAAar9E,KAAKi6B,SAASsjD,IAAI94E,iBAC7CzE,KAAKi6B,SAASijD,WAAal9E,KAAKi6B,SAASsjD,IAAIx0D,kBAAkBA,kBAE/D/oB,KAAKi6B,SAASujD,QAAUx9E,KAAKi6B,SAASsjD,IAAIrvC,mBAE1CluC,KAAKi6B,SAASgjD,IAAMj9E,KAAKi6B,SAASujD,QAAQz0D,kBAC1C/oB,KAAKi6B,SAASwjD,WAAaz9E,KAAKi6B,SAASgjD,IAAIx4E,iBAE7CzE,KAAK09E,cAAgB,IAAI,IAAW,CAAC59E,WAAW,EAAMyZ,MAAO,yBAC7DvZ,KAAK29E,cAAgB,IAAI,IAAW,CAAC79E,WAAW,EAAMyZ,MAAO,yBAE7D,MAAMqkE,EAAS9+E,SAASC,cAAc,OACtC6+E,EAAOj/E,UAAYq+E,GAAYp5B,WAAa,UAC5Cg6B,EAAOl+E,OAAOM,KAAK09E,cAAcx8E,UAAWlB,KAAK29E,cAAcz8E,WAC/DlB,KAAKkB,UAAUxB,OAAOk+E,GAEtB59E,KAAK09E,cAAc39E,MAAMK,iBAAiB,SAAS,KACjD,IAAII,EAAQR,KAAK09E,cAAcl9E,MAAMC,QAAQ,KAAM,IAAIC,MAAM,EAAG,GAEhE,MAAMk4D,EAAQp4D,EAAMo4D,MAAM,iBACpBilB,EAAQjlB,GAASA,EAAM,GAAGj4D,SAAWH,EAAMG,QAAU,CAAa,GAAGyG,SAAS5G,EAAMG,QAC1FX,KAAK09E,cAAclxC,SAASqxC,EAAQ,EAAApxC,EAAA,QAAqB,EAAAA,EAAA,OAEzDjsC,EAAQ,IAAMA,EACdR,KAAK09E,cAAc98E,iBAAiBJ,GAEjCq9E,GACD79E,KAAK89E,SAASt9E,GAAO,GAAO,MAKhC,MAAMu9E,EAAY,wHAClB/9E,KAAK29E,cAAc59E,MAAMK,iBAAiB,SAAS,KACjD,MAAMw4D,EAAQ54D,KAAK29E,cAAcn9E,MAAMo4D,MAAMmlB,GAC7C/9E,KAAK29E,cAAcnxC,SAASosB,EAAQ,EAAAnsB,EAAA,QAAqB,EAAAA,EAAA,OAEtDmsB,GACD54D,KAAK89E,UAAS,UAAYllB,EAAM,IAAKA,EAAM,IAAKA,EAAM,KAAK,GAAM,MAIrE54D,KAAKg+E,qBACLh+E,KAAKi+E,qBAWCD,qBACN9pD,GAAoBl0B,KAAKi6B,SAASsjD,KAAY,KAC5Cv9E,KAAKo9E,cACLp9E,KAAKk+E,QAAUl+E,KAAKi6B,SAASsjD,IAAI92E,2BAE/Bs0D,IACF/6D,KAAKm+E,kBAAkBpjB,EAAI/zD,EAAG+zD,EAAI9zD,MACjC,KACDjH,KAAKs9E,eAIDW,qBACN/pD,GAAoBl0B,KAAKi6B,SAASgjD,KAAY,KAC5Cj9E,KAAKo9E,cACLp9E,KAAKo+E,QAAUp+E,KAAKi6B,SAASgjD,IAAIx2E,2BAE/Bs0D,IACF/6D,KAAKq+E,WAAWtjB,EAAI/zD,MACnB,KACDhH,KAAKs9E,eAIFQ,SAASx1D,EAA2Bg2D,GAAiB,EAAMC,GAAiB,GACjF,QAAav0E,IAAVse,EACDA,EAAQ,CACN9H,EAAG,EACHuZ,EAAG,IACHy+C,EAAG,GACH5xC,EAAG,QAEA,GAAqB,iBAAZ,EACd,GAAgB,MAAbte,EAAM,GACPA,GAAQ,SAAWA,OACd,CACL,MAAMk2D,EAAMl2D,EAAMswC,MAAM,YACxBtwC,GAAQ,UAAYk2D,EAAI,IAAKA,EAAI,IAAKA,EAAI,QAAex0E,IAAXw0E,EAAI,GAAmB,GAAKA,EAAI,IAKlFx+E,KAAKk+E,QAAUl+E,KAAKi6B,SAASsjD,IAAI92E,wBAEjC,MAAMg4E,EAAOz+E,KAAKk+E,QAAQ38E,MAAQ,IAAM+mB,EAAMyR,EACxC2kD,EAAW,IAAOp2D,EAAMkwD,GAAK,IAAMlwD,EAAMyR,EAAI,GAAM,IACnD4kD,EAAO3+E,KAAKk+E,QAAQ18E,OAAS,IAAMk9E,EAEzC1+E,KAAKm+E,kBAAkBn+E,KAAKk+E,QAAQv3E,KAAO83E,EAAMz+E,KAAKk+E,QAAQr3E,IAAM83E,GAAM,GAG1E3+E,KAAKo+E,QAAUp+E,KAAKi6B,SAASgjD,IAAIx2E,wBAEjC,MAAMm4E,EAAat2D,EAAM9H,EAAI,IACvBq+D,EAAO7+E,KAAKo+E,QAAQz3E,KAAO3G,KAAKo+E,QAAQ78E,MAAQq9E,EAEtD5+E,KAAKq+E,WAAWQ,GAAM,GAGtB7+E,KAAKi9E,IAAM30D,EAAM9H,EACjBxgB,KAAKk9E,WAAa50D,EAAMyR,EACxB/5B,KAAKm9E,UAAY70D,EAAMkwD,EACvBx4E,KAAK0rB,MAAQpD,EAAMse,EAEnB5mC,KAAK8+E,aAAaR,EAAgBC,GAG7BQ,kBACL,MAAMC,GAAY,SAAWh/E,KAAKi9E,IAAKj9E,KAAKk9E,WAAYl9E,KAAKm9E,UAAWn9E,KAAK0rB,OACvEuzD,GAAO,SAAWD,GAClBhlB,EAAMilB,EAAKv+E,MAAM,GAAI,GAE3B,MAAO,CACLw+E,IAAK,OAAOl/E,KAAKi9E,QAAQj9E,KAAKk9E,gBAAgBl9E,KAAKm9E,cACnDqB,IAAK,OAAOQ,EAAU,OAAOA,EAAU,OAAOA,EAAU,MACxDhlB,IAAKA,EACLmlB,KAAM,QAAQn/E,KAAKi9E,QAAQj9E,KAAKk9E,gBAAgBl9E,KAAKm9E,eAAen9E,KAAK0rB,SACzE6sD,KAAM,QAAQyG,EAAU,OAAOA,EAAU,OAAOA,EAAU,OAAOA,EAAU,MAC3EC,KAAMA,EACND,UAAWA,GAIRF,aAAaR,GAAiB,EAAMC,GAAiB,GAC1D,MAAMj2D,EAAQtoB,KAAK++E,kBACnB/+E,KAAKi6B,SAASojD,WAAW12D,eAAe,KAAM,OAAQ2B,EAAM0xC,KAEzDskB,IACDt+E,KAAK09E,cAAc98E,iBAAiB0nB,EAAM0xC,KAC1Ch6D,KAAK09E,cAAclxC,SAAS,EAAAC,EAAA,UAG3B8xC,IACDv+E,KAAK29E,cAAc/8E,iBAAiB0nB,EAAM02D,UAAUt+E,MAAM,GAAI,GAAGijB,KAAK,OACtE3jB,KAAK29E,cAAcnxC,SAAS,EAAAC,EAAA,UAG3BzsC,KAAKkM,UACNlM,KAAKkM,SAASoc,GAIV+1D,WAAW9pD,EAAe8D,GAAS,GACzC,MAEM1O,GAFS,EAAA9F,GAAA,GAAM0Q,EAAQv0B,KAAKo+E,QAAQz3E,KAAM,EAAG3G,KAAKo+E,QAAQ78E,OAEtCvB,KAAKo+E,QAAQ78E,MACvCvB,KAAKi9E,IAAMt6E,KAAKE,MAAM,IAAM8mB,GAE5B,MAAMw1D,EAAO,QAAQn/E,KAAKi9E,mBAAmBj9E,KAAK0rB,SAElD1rB,KAAKi6B,SAASwjD,WAAW92D,eAAe,KAAM,IAAiB,IAAXgD,EAAkB,KACtE3pB,KAAKi6B,SAASwjD,WAAW92D,eAAe,KAAM,OAAQw4D,GAEtDn/E,KAAKi6B,SAASijD,WAAWz4E,iBAAiBkiB,eAAe,KAAM,aAAcw4D,GAE1E9mD,GACDr4B,KAAK8+E,eAIDX,kBAAkB5pD,EAAeC,EAAe6D,GAAS,GAC/D,MAAM+mD,EAAOp/E,KAAKk+E,QAAQ38E,MACpB89E,EAAOr/E,KAAKk+E,QAAQ18E,OAKpB89E,GAHS,EAAAz7D,GAAA,GAAM0Q,EAAQv0B,KAAKk+E,QAAQv3E,KAAM,EAAGy4E,GAG7BA,EAAO,IACvBG,GAHS,EAAA17D,GAAA,GAAM2Q,EAAQx0B,KAAKk+E,QAAQr3E,IAAK,EAAGw4E,GAG5BA,EAAO,IAEvBhC,EAAar9E,KAAKi6B,SAASojD,WACjCA,EAAW12D,eAAe,KAAM,IAAK24D,EAAO,KAC5CjC,EAAW12D,eAAe,KAAM,IAAK44D,EAAO,KAE5C,MAAMrC,GAAa,EAAAr5D,GAAA,GAAMy7D,EAAM,EAAG,KAE5BE,EAAa,IAAMtC,EAAa,EAChCuC,EAAa,KAAM,EAAA57D,GAAA,GAAM07D,EAAM,EAAG,KAElCpC,GAAY,EAAAt5D,GAAA,GAAM47D,EAAa,IAAMD,EAAY,EAAG,KAE1Dx/E,KAAKk9E,WAAaA,EAClBl9E,KAAKm9E,UAAYA,EAEd9kD,GACDr4B,KAAK8+E,gBAhRM,GAAAl7B,WAAa,eCGf,MAAM87B,WAA8BlxE,EAAnD,c,oBA2FU,KAAAmxE,YAAc,CAAC3lB,EAAa4lB,GAAoB,KACtD,GAAGA,EACD5/E,KAAK6/E,YAAY/B,SAAS9jB,OACrB,CACL,MAAMue,GAAO,SAAWve,GAClB8lB,EAAa9/E,KAAK+/E,MAAMD,WACxBX,EAAO7G,GAAmBC,GAEhCuH,EAAWtvE,GAAK,IAChBsvE,EAAWE,UAAY,EACvBF,EAAWG,KAAO,GAClBH,EAAWx3D,MAAQ0xC,EAAInxD,cACvBi3E,EAAWxH,mBAAqB6G,EAChCn/E,KAAK2S,SAASutE,gBAAgBC,YAAY,WAAY,cAEtD,0BAA+Bn2E,OAAWA,GAAW,GACrDhK,KAAKgL,cAID,KAAAo1E,cAAiB93D,IACvBtoB,KAAKqgF,WAAW/3D,EAAM0xC,KAAK,IA1G7B3qD,OACErP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,uBAAwB,8BACrDW,KAAK4P,SAAS,YAEd5P,KAAK+/E,MAAQO,GAAA,aAEb,MAAMnnE,EAAU,IAAIC,GAAe,IACnCpZ,KAAK6/E,YAAc,IAAI7C,GAEvB7jE,EAAQpK,QAAQrP,OAAOM,KAAK6/E,YAAY3+E,WAExClB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/B,MAAMq/E,EAAc,IAAInnE,GAAe,IAEjConE,EAAOxgF,KAAKwgF,KAAO1hF,SAASC,cAAc,OAChDyhF,EAAKphF,UAAUC,IAAI,QAEJ,CACb,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,WAGK+N,SAASkb,IACd,MAAMvJ,EAAOjgB,SAASC,cAAc,OACpCggB,EAAK3f,UAAUC,IAAI,aACnB0f,EAAKnX,QAAQ0gB,MAAQA,EAAMzf,cAG3B,MAAMmlB,EAAQlvB,SAASC,cAAc,OACrCivB,EAAM5uB,UAAUC,IAAI,mBACpB2uB,EAAM/qB,MAAMw9E,gBAAkBn4D,EAE9BvJ,EAAKrf,OAAOsuB,GACZwyD,EAAK9gF,OAAOqf,OAGd,QAAiByhE,GAAOngF,IACtB,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,aACzC,IAAIA,GAAUA,EAAO/H,UAAUiG,SAAS,UACtC,OAGF,MAAMijB,EAAQnhB,EAAOS,QAAQ0gB,MACzBA,GAIJtoB,KAAKqgF,WAAW/3D,KACf,CAACrf,eAAgBjJ,KAAKiJ,iBAEzBs3E,EAAYxxE,QAAQrP,OAAO8gF,GAC3BxgF,KAAK8L,WAAWpM,OAAO6gF,EAAYr/E,WAEnClB,KAAKqgF,YAAa,EAAA/4C,GAAA,GAAStnC,KAAK2/E,YAAa,IAAI,GAG3C30E,YACN,MAAMgiD,EAAShtD,KAAKwgF,KAAKt7E,cAAc,WACjC46E,EAAa9/E,KAAK+/E,MAAMD,WACxB34E,EAAS24E,EAAWx3D,MAAQtoB,KAAKwgF,KAAKt7E,cAAc,0BAA0B46E,EAAWx3D,WAAa,KACzG0kC,IAAW7lD,IAIX6lD,GACDA,EAAO5tD,UAAUkB,OAAO,UAGvB6G,GACDA,EAAO/H,UAAUC,IAAI,WA4BzBoS,SACErL,YAAW,KACT,MAAM05E,EAAa9/E,KAAK+/E,MAAMD,WAExBx3D,GAASw3D,EAAWx3D,OAAS,IAAIoa,MAAM,KAAK,GAC5Cg+C,IAAcp4D,IAAUw3D,EAAWG,KAGtCS,IACD1gF,KAAK6/E,YAAY3zE,SAAWlM,KAAKogF,eAGnCpgF,KAAK6/E,YAAY/B,SAASx1D,GAAS,WAE/Bo4D,IACF1gF,KAAK6/E,YAAY3zE,SAAWlM,KAAKogF,iBAElC,GAGL5wE,sBAIE,OAHAxP,KAAK6/E,YAAY3zE,cAAWlC,EAC5BhK,KAAK6/E,iBAAc71E,EAEZnK,MAAM2P,uB,cC5JF,SAASmxE,GAAkB/hF,GAQxC,OAAO,IAAIuE,SAAS4B,I,UAClB,MAAM/B,EAASlE,SAASC,cAAc,UAChCiC,EAAmB,QAAZ,EAAApC,EAAQoC,YAAI,QAAIpC,EAAQgiF,UAAUC,aAAajiF,EAAQ+uB,SACpE3qB,EAAOzB,MAAQP,EAAKO,MAAQuE,OAAOoa,iBACnCld,EAAOxB,OAASR,EAAKQ,OAASsE,OAAOoa,iBACzBld,EAAO6P,WAAW,MAC1B+Y,UAAUhtB,EAAQovB,MAAO,EAAG,EAAGhrB,EAAOzB,MAAOyB,EAAOxB,QACxDwB,EAAOmhC,QAAQC,IACbr/B,EAAQ,CAACq/B,KAAAA,EAAMpjC,KAAAA,MACE,QAAhB,EAAApC,EAAQ6tB,gBAAQ,QAAI,aAA6B,QAAf,EAAA7tB,EAAQkiF,eAAO,QAAI,M,2SCgB7C,MAAMC,WAAyBvyE,EAA9C,c,oBAEU,KAAAiZ,OAAS,EACT,KAAAu5D,QAAsB,IAAIpiE,IAG1B,KAAAqiE,oBAAmD,IAAIhwE,IACvD,KAAAiwE,cAA0C,IAAIjwE,IAqE9C,KAAAkwE,cAAgB,MC/GX,SAAqBC,GAClC,MAAMrhF,EAAQjB,SAASC,cAAc,SACrCgB,EAAME,KAAO,OACbF,EAAMkD,MAAMC,QAAU,OAGpBnD,EAAMqhF,OAASA,EAGjBtiF,SAAS8rC,KAAKlrC,OAAOK,GAErB,MAAM+J,EAAU,IAAI3G,SAAc,CAAC4B,EAASylB,KAC1CzqB,EAAMK,iBAAiB,UAAWC,IAChC,MAAMghF,EAAahhF,EAAE8G,OAAOm6E,MAAM,GAC9BD,EAKJt8E,EAAQs8E,GAJN72D,EAAO,sBAKR,CAAChjB,MAAM,OACT0jB,SAAQ,KACTnrB,EAAMO,YAKR,OAFAP,EAAM+yC,QAEChpC,GDqFLy3E,CAAY,oCAAoC7/E,MAAW2/E,GAAS,mCAClE,GAAGA,EAAK59E,KAAK8yD,SAAS,QAAS,CAC7B,MAAMjrC,EAAMxsB,SAASC,cAAc,OAC7BunB,EAAMi0C,IAAIC,gBAAgB6mB,SAC1Bn6D,GAA0BoE,EAAKhF,GAAK,GAC1C,MAAMmG,EAAW,cACX,KAAC2X,SAAcu8C,GAAkB,CAAC3yD,MAAO1C,EAAKtqB,KAAM,IAAI,KAAUsqB,EAAIk2D,aAAcl2D,EAAIm2D,eAAgBh1D,SAAAA,IAC9G40D,EAAO,IAAIK,KAAK,CAACt9C,GAAOi9C,EAAK59E,KAAKhD,QAAQ,SAAU,QAAS,CAACR,KAAMwsB,IAGtE,MAAMk1D,QAAkB3hF,KAAK2S,SAAS6wB,eAAeo+C,uBAAuBP,GACtEv9C,EAAgB9jC,KAAK2S,SAAS6wB,eAAeq+C,gBAAgBF,EAAUnxE,IACvEsxE,EAA0CjyD,EAAA,0BAA2CwxD,EAAK59E,KAAMqgC,GAEhGjE,GAAW,UACjBA,EAASpW,kBAAoBq4D,EAAer4D,kBAC5CoW,EAASzX,OAAS05D,EAAe15D,OAEjC05D,EAAepgF,MAAMigF,IACnB3hF,KAAKghF,QAAQtxE,OAAOG,GACpB7P,KAAKkhF,cAAcxxE,OAAOG,GAC1B7P,KAAKihF,oBAAoBhkE,IAAI/b,EAAWygF,GACxC,MAAMI,EAAS/hF,KAAKgiF,gBAAgBL,GACpC3hF,KAAKkhF,cAAcjkE,IAAI8kE,EAAQ7gF,GAE/BlB,KAAKiiF,sBAAsBN,GAAWjgF,KAAKm+B,EAAS96B,QAAS86B,EAASrV,UACrEqV,EAASrV,QAEZ,MAAM3a,EAAM7P,KAAKgiF,gBAAgBL,GACjC9hD,EAAShyB,OAAM,KACb3M,EAAUZ,YAGZ,MAAM4nB,EAAY,IAAIV,GAAqB,CACzCG,UAAU,EACVC,YAAY,EACZE,gBAAgB,IAGZ5mB,EAAYlB,KAAKkiF,aAAaP,GAAW,GAC/C3hF,KAAKghF,QAAQ3hF,IAAIwQ,GAEjBqY,EAAUsB,OAAOtoB,GAAW,EAAO2+B,SAI/B,KAAAsiD,aAAe,KACrB,MAAMC,EAAe,2BAAiC/vE,GAAMA,EAAE5O,OAASzD,KAAK+/E,MAAMt8E,OAC/E2+E,MACCpiF,KAAKynB,OACPznB,KAAK+/E,MAAMD,YAAa,EAAAroC,GAAA,GAAK2qC,EAAatC,YAC1C9/E,KAAK2S,SAASutE,gBAAgBC,YAAY,WAAY,cACtD,0BAA+Bn2E,OAAWA,GAAW,GACrDhK,KAAKqiF,kBAAkBzhF,iBAAiBZ,KAAK+/E,MAAMD,WAAWwC,QA+G1D,KAAAC,YAAeliF,IACrB,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,aACzC,IAAIA,EAAQ,OAEZ,MAAMq7E,EAAYxiF,KAAKihF,oBAAoBzvE,IAAIrK,GAC/C,GAAmB,oBAAhBq7E,EAAU51E,EAEX,YADA5M,KAAKiiF,sBAAsBO,GAI7B,MAAM3yE,EAAM7P,KAAKgiF,gBAAgBQ,GACjC,GAAGxiF,KAAKghF,QAAQ7uC,IAAItiC,GAAM,OAC1B7P,KAAKghF,QAAQ3hF,IAAIwQ,GAEjB,MAAM2qB,EAAMgoD,EAAU1jF,SAChBopB,EAAY,IAAIV,GAAqB,CACzCI,YAAY,EACZE,gBAAgB,IAGZ3mB,EAAO,IAAW,mCACtB,MAAM2I,EAAU9J,KAAKiiF,sBAAsBO,UAChBxiF,KAAK2S,SAAS8c,cAAcC,gBAAgB8K,IACtDlU,MAAOtmB,KAAK+/E,MAAMD,WAAWwC,MAC5Cp6D,EAAUsB,OAAOriB,GAAQ,EAAM2C,MAInCoe,EAAUO,aAEV,QAAiBthB,GAAS9G,IACrB6nB,EAAUA,UAAUtkB,eACrBskB,EAAUF,QAAQ3nB,GAClB6nB,EAAUqB,UAEVpoB,MAED,CAAC8H,eAAgBjJ,KAAKiJ,iBAEzB9H,KAKM,KAAAshF,YAAc,CAACxC,EAAc35D,KACnCpK,MAAMoK,GAAK5kB,MAAMya,IACf,qBAA+B,eAAiB8jE,EAAM9jE,OAIlD,KAAA8lE,sBAAyBN,IAC/B,IAAIe,IAAY1iF,KAAKynB,OACrB,MAAMiH,EAAa,IAAMg0D,IAAY1iF,KAAKynB,OAEpC+S,EAAOmnD,EAAkC7iF,SACzC+gC,GAAW,UACjB,IAAItP,EA2EJ,OA1EGiK,GACDjK,EAAWV,EAAA,mBAAoC,CAAC7B,MAAOwM,EAAKrK,QAAS,gBAA4B,sCAAkD,IACnJ0P,EAASpW,kBAAoB8G,EAAS9G,kBACtCoW,EAASzX,OAASmI,EAASnI,QAE3BmI,EAAWptB,QAAQ4B,UAGrBwrB,EAAS7uB,MAAK,IAAW,mCACvB,IAAIgtB,IAEF,YADAmR,EAAS96B,UAIX,MAAM+6E,EAAa9/E,KAAK+/E,MAAMD,WACxB6C,EAAWr8D,IAEf,IAAIs8D,EACJ,GAAGt8D,IAAQtmB,KAAK+/E,MAAMD,WAAWx3D,MAC/Bs6D,ENnUH,SAAsBC,GAC3B,MAAMv3D,EAAMxsB,SAASC,cAAc,OACnC,OAAO,IAAIoE,SAA4B4B,IACrC8hB,GAAmByE,EAAKu3D,GAAU,KAChC,MAAM7/E,EAASlE,SAASC,cAAc,UAChC2kB,EAAQ4H,EAAIk2D,aAAel2D,EAAIm2D,cAExB,IAAV/9D,GACD1gB,EAAOzB,MAFU,GAGjByB,EAAOxB,OAASwB,EAAOzB,MAAQmiB,GACvBA,EAAQ,GAChB1gB,EAAOxB,OALU,GAMjBwB,EAAOzB,MAAQyB,EAAOxB,OAASkiB,GAE/B1gB,EAAOzB,MAAQyB,EAAOxB,OARL,GAWHwB,EAAO6P,WAAW,MAC1B+Y,UAAUN,EAAK,EAAG,EAAGA,EAAIk2D,aAAcl2D,EAAIm2D,cAAe,EAAG,EAAGz+E,EAAOzB,MAAOyB,EAAOxB,QAC7FuD,EAAQgzE,GAAuB/0E,UMgTT8/E,CAAax8D,OAC1B,CACL,MAAM,OAACtjB,GAAUy1E,GAA+BsK,OAAO/iF,KAAKgjF,uBAAuBrB,IACnFiB,EAAkBz/E,QAAQ4B,QAAQgzE,GAAuB/0E,IAG3D4/E,EAAgBlhF,MAAMs2E,I,UACpB,IAAItpD,IAEF,YADAmR,EAAS96B,UAIX,MAAMo6E,EAAO7G,GAAmBlnE,MAAMC,KAAK2mE,IAIrCiI,EAA8C,QAAtC,EAAA0B,EAAkC1B,YAAI,QAAI,GACxDH,EAAWtvE,GAAKmxE,EAAUnxE,GAC1BsvE,EAAWE,UAAyC,QAA7B,EAAkB,QAAlB,EAAA2B,EAAUrK,gBAAQ,eAAE0I,iBAAS,QAAI,EACxDF,EAAWx3D,MAAQtoB,KAAKgjF,uBAAuBrB,GAC/C7B,EAAWG,KAAOA,EAClBH,EAAWxH,mBAAqB6G,EAChCn/E,KAAK2S,SAASutE,gBAAgBC,YAAY,WAAY,cAEnDF,GACDjgF,KAAKyiF,YAAYxC,EAAM35D,GAGzB,qBAA+B25D,EAAM35D,GAAK,GAAM5kB,KAAKm+B,EAAS96B,aAIlE,IAAIy1B,EAEF,YADAmoD,IAIF,MAAMt1D,QAAqBrtB,KAAK2S,SAAS8c,cAAcC,gBAAgB8K,GACpEslD,EAAWwC,KACZl8E,YAAW,KACT,MAAM,OAACpD,EAAM,QAAE8G,GAAW,GAAKujB,EAAa/G,IAAK,GAAI,GACrDxc,EAAQpI,MAAK,KACPgtB,IAKJi0D,EAAQ3/E,EAAOgtB,aAJb6P,EAAS96B,eAMZ,KAEH49E,EAAQt1D,EAAa/G,UAIlBuZ,GAGD,KAAA70B,UAAY,KAClB,MAAMgiD,EAAShtD,KAAKwgF,KAAKt7E,cAAc,WACjCiC,EAASnH,KAAKkhF,cAAc1vE,IAAIxR,KAAKijF,yBAAyBjjF,KAAK+/E,QACtE/yB,IAAW7lD,IAIX6lD,GACDA,EAAO5tD,UAAUkB,OAAO,UAGvB6G,GACDA,EAAO/H,UAAUC,IAAI,YA1Xb0gF,YACV,OAAOO,GAAA,aAGTjxE,OACErP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,uBAAwB,8BACrDW,KAAK4P,SAAS,kBAEd,CACE,MAAM1O,EAAYsuE,GAAgBxvE,KAAK8L,YAEjCo3E,GAAe,OAAO,8BAA+B,CAACjkF,KAAM,YAAaQ,KAAM,mCAC/E0jF,GAAc,OAAO,8BAA+B,CAAClkF,KAAM,WAAYQ,KAAM,aAC7E2jF,GAAc,OAAO,8BAA+B,CAACnkF,KAAM,aAAcQ,KAAM,sBAErF,QAAiByjF,EAAcljF,KAAKmhF,cAAe,CAACl4E,eAAgBjJ,KAAKiJ,kBAEzE,QAAiBk6E,GAAa,KAC5BnjF,KAAKyO,OAAO+D,UAAUktE,IAAuBvwE,SAC5C,CAAClG,eAAgBjJ,KAAKiJ,kBAEzB,QAAiBm6E,EAAapjF,KAAKmiF,aAAc,CAACl5E,eAAgBjJ,KAAKiJ,iBAEvE,MAAMo5E,EAAoBriF,KAAKqiF,kBAAoB,IAAI,KAAc,CACnE5iF,KAAM,sBACNgE,KAAM,OACN2lC,QAASppC,KAAK+/E,MAAMD,WAAWwC,KAC/Bt0C,YAAY,IAGdhuC,KAAKiJ,eAAe5J,IAAIgjF,EAAkBtiF,MAA1CC,CAAiD,UAAU,IAAW,mCACpEA,KAAK+/E,MAAMD,WAAWwC,KAAOD,EAAkBtiF,MAAMqpC,cAC/CppC,KAAK2S,SAASutE,gBAAgBC,YAAY,WAAY,cAG5D/5E,YAAW,KACT,MAAM4mD,EAASwzB,EAAKt7E,cAAc,WAClC,IAAI8nD,EAAQ,OAEZ,MAAMw1B,EAAYxiF,KAAKihF,oBAAoBzvE,IAAIw7C,GAC3Cw1B,EAAkChqE,OAAO6qE,SAA2B,oBAAhBb,EAAU51E,GAIlE5M,KAAKiiF,sBAAsBO,KAC1B,UAGLthF,EAAUxB,OAAOwjF,EAAcC,EAAaC,EAAaf,EAAkB9oE,OAG7E,qBAA2B,oBAAqBvZ,KAAKgL,WAErDhL,KAAK2S,SAAS6wB,eAAe8/C,gBAAgB5hF,MAAM6hF,IACjDA,EAAWn2E,SAASu0E,IAClB3hF,KAAKkiF,aAAaP,SAItB,MAAM6B,EAAgBhU,GAAgBxvE,KAAK8L,YACrC00E,EAAOxgF,KAAKwgF,KAAO1hF,SAASC,cAAc,OAChDyhF,EAAKphF,UAAUC,IAAI,SACnB,QAAiBmhF,EAAMxgF,KAAKuiF,YAAa,CAACt5E,eAAgBjJ,KAAKiJ,iBAC/Du6E,EAAc9jF,OAAO8gF,GA6DfwC,uBAAuBrB,GAC7B,OAAOA,EAAUrK,SAAW,CAC1BqK,EAAUrK,SAASmM,iBACnB9B,EAAUrK,SAASoM,wBACnB/B,EAAUrK,SAASqM,uBACnBhC,EAAUrK,SAASsM,yBACnBj4D,OAAO6kB,SAAS71B,KAAK2N,GAAU,IAAMA,EAAMooB,SAAS,MAAK/sB,KAAK,KAAO,GAGjEq+D,gBAAgBL,GACtB,MAAO,GAAKA,EAAUnxE,GAGhByyE,yBAAyBlD,GAC/B,MAAO,GAAKA,EAAMD,WAAWtvE,GAGvB0xE,aAAaP,EAAsBjiF,GAAS,GAClD,MAAMw8E,EAASl8E,KAAKgjF,uBAAuBrB,GACrCkC,EAA0B,cAAhBlC,EAAU/0E,EAC1B,GAAIi3E,GAAWlC,EAAUnpE,OAAO6qE,UAAYnH,EAE1C,OAGF,MAAM4H,IAAWnC,EAAUnpE,OAAOurE,KAE5BvpD,EAAMqpD,EAAUlC,EAAU7iF,cAAgCkL,EAE1D9I,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI,aAExB6B,EAAU0G,QAAQ4I,GAAK,GAAKmxE,EAAUnxE,GAEtC,MAAMX,EAAM7P,KAAKgiF,gBAAgBL,GACjC3hF,KAAKihF,oBAAoBhkE,IAAI/b,EAAWygF,GACxC3hF,KAAKkhF,cAAcjkE,IAAIpN,EAAK3O,GAE5B,MAAM8sB,EAAQlvB,SAASC,cAAc,OAGrC,IAAIwgC,EAAuCv+B,EAuC3C,GAzCAgtB,EAAM5uB,UAAUC,IAAI,mBAGjBwkF,GACD7iF,EAAO4e,GAAgB4a,EAAK,IAAK,KACjC+E,EAAUjR,GAAU,CAClBzO,MAAO2a,EACPntB,QAAS,KACTnM,UAAW8sB,EACXW,kBAAkB,EAClB3tB,KAAMA,EACNguB,SAAU2yD,EAAUnpE,OAAO6qE,UAG1B1B,EAAUnpE,OAAO6qE,SAClBr1D,EAAM5uB,UAAUC,IAAI,cAGtBkgC,EAAQ79B,MAAK,EAAOktB,aAAAA,EAAcO,OAAAA,KAAY,mCAE5C,aADMP,EAAa3B,QAAS2B,EAAaM,KAClCC,OACNztB,MAAMytB,I,MACJwyD,EAAUnpE,OAAO6qE,UACfS,GACD30D,EAAOD,KAAKjsB,MAAMC,QAAU,OACzBisB,EAAOlC,QACRkC,EAAOlC,MAAMhqB,MAAMC,QAAU,UAEL,QAAlB,EAAAy+E,EAAUrK,gBAAQ,eAAE0I,aAC5B7wD,EAAOD,KAAKjsB,MAAM0gE,QAAU,GAAKhhE,KAAKoE,IAAI46E,EAAUrK,SAAS0I,WAAa,MAI9Ex2E,GAAA,UAAqB,KACnBtI,EAAUxB,OAAOsuB,UAIrB9sB,EAAUxB,OAAOsuB,GAGhB2zD,EAAUrK,eAAoDttE,IAAxC23E,EAAUrK,SAASmM,iBAAgC,CAC1E,MAAM,OAACzgF,GAAUy1E,GAA+BsK,OAAO7G,GACvDl5E,EAAO5D,UAAUC,IAAI,4BAElBykF,GAAUD,EACXtkD,EAAQ79B,MAAK,EAAEktB,aAAAA,MACbA,EAAaM,KAAKxtB,MAAK,IAAW,mCAChC,MAAM2rB,QAAqBrtB,KAAK2S,SAAS8c,cAAcC,gBAAgB8K,EAAKx5B,EAAKf,MACjF+C,EAAOC,MAAM+gF,gBAAkB,OAAO32D,EAAa/G,OACnDtjB,EAAOC,MAAM0gE,QAAU,GAAKhhE,KAAKoE,IAAI46E,EAAUrK,SAAS0I,WAAa,IACrEhyD,EAAMtuB,OAAOsD,WAIjBgrB,EAAMtuB,OAAOsD,GAUjB,OANGhD,KAAKijF,yBAAyBjjF,KAAK+/E,SAAWlwE,GAC/C3O,EAAU9B,UAAUC,IAAI,UAG1BW,KAAKwgF,KAAK9gF,EAAS,SAAW,WAAWwB,GAElCA,GExPX,MAAM+iF,GAAkB,iBAET,MAAMC,WAAsB,IAOzCtkF,YAAoBukF,GAClBtkF,MAAM,iBAAkB,KAAM,CAACu2C,UAAU,EAAMhJ,iBAAiB,EAAMxC,MAAM,IAD1D,KAAAu5C,gBAAAA,EA0CZ,KAAAC,gBAAmB/jF,IACzB,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,uBACzC,IAAIA,EAAQ,OAEZ,MAAMk9E,EAASl9E,EAAOS,QAAQk7B,MAC3B,sCAAgDuhD,GACjDrkF,KAAKs2C,OAEL5oC,QAAQ+7D,KAAK,oBAAqB4a,IA/CpCrkF,KAAKskF,GAAKxlF,SAASC,cAAc,MACjCiB,KAAKskF,GAAG5kF,QAAO,QAAK,YAEpBM,KAAK4O,OAAOlP,OAAOM,KAAKskF,IAExBtkF,KAAKI,iBAAiB,SAAS,KAC7BwhC,EAAA,0BAA6C,OAG/C,MAAMv9B,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,eAElBW,KAAKukF,YAAczlF,SAASC,cAAc,OAC1CiB,KAAKukF,YAAYnlF,UAAUC,IAAI,uBAAwB,eAEvD,QAAiBW,KAAKukF,YAAavkF,KAAKokF,gBAAiB,CAACn7E,eAAgBjJ,KAAKiJ,kBAE/E,EAAAhF,GAAA,GAAajE,KAAKukF,aAAa,GAE/BvkF,KAAKwkF,eAAiB1lF,SAASC,cAAc,OAC7CiB,KAAKwkF,eAAeplF,UAAUC,IAAI,sBAElCgF,EAAI3E,OAAOM,KAAKukF,aAEhB,MAAME,GAAM,OAAO,oDAAqD,CAACvlF,UAAU,EAAMO,KAAM,YAC/FO,KAAKwkF,eAAe9kF,OAAO+kF,GAE3BzkF,KAAK4qC,KAAKlrC,OAAO2E,GACE,IAAI,KAAWrE,KAAK4qC,MACvC5qC,KAAK4qC,KAAKlrC,OAAOM,KAAKwkF,gBAOtBxkF,KAAK0kF,iBAeCA,iBACN,OAAO1kF,KAAK2S,SAASo0B,mBAAmB0zB,cAAcz6D,KAAKmkF,iBAAiBziF,MAAMub,IAChF,IAAIA,EAGF,OAFA2uB,GAAS,CAACC,YAAa,8BACvB7rC,KAAKs2C,OAYP,IAAIz3C,EAPJmB,KAAKid,IAAMA,EAAIA,IAEf2kB,EAAA,0BAA6CqiD,KAE7C,EAAAtrD,EAAA,GAAa34B,KAAKskF,IAAI,EAAA1rD,GAAA,GAAc3b,EAAIA,IAAInO,QAC5C9O,KAAKwkF,eAAeplF,UAAUoE,OAAO,OAAQyZ,EAAIA,IAAI0nE,gBAGlD1nE,EAAIA,IAAI0nE,gBACT9lF,GAAS,OAAO,6CAA8C,CAACK,UAAU,IACzEL,EAAOa,QAAO,QAAK,sBAAuB,EAAC,QAAK,WAAY,CAACud,EAAIA,IAAIlQ,aAErElO,GAAS,OAAO,gCAAiC,CAACK,UAAU,IAC5DL,EAAOa,QAAO,QAAK,mBAAoB,EAAC,QAAK,WAAY,CAACud,EAAIA,IAAIlQ,YAGpE/M,KAAKwkF,eAAe7xD,YAAc,GAClC3yB,KAAKwkF,eAAe9kF,OAAOb,IAE3B,QAAiBA,GAAQ,KACvB,MAAM2E,GAAS,EAAAurC,GAAA,GAAiB,CAAClwC,IAAS,GAE1CmB,KAAK2S,SAASo0B,mBAAmB69C,iBAAiB5kF,KAAKid,KAAKvb,MAAK,KAC/D1B,KAAKs2C,UACJzoC,OAAM,KACPrK,UAIJ,MAAMirB,EAAgB,IAAInP,GAE1Btf,KAAKukF,YAAYnlF,UAAUkB,OAAO,cAClCN,KAAKukF,YAAYjgF,UAAY,GAC7B,IAAI,IAAIk2B,KAAOvd,EAAI09C,UAAW,CAC5B,GAAa,kBAAVngC,EAAI5tB,EACL,SAGF,MAAMvI,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,uBAElB,MAAM2B,EAAOquB,EAAA,0BAEb,GAAY,CACVmL,IAAAA,EACAn2B,IAAAA,EACAoqB,cAAAA,EACA0R,MAAO8jD,GACP5hF,MAAM,EACNhB,MAAM,EACNE,MAAOP,EACPQ,OAAQR,IAGVhB,KAAKukF,YAAY7kF,OAAO2E,Q,8BC3IjB,MAAMwgF,WAA4Br2E,EACrCa,OAKR,OAJArP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAK4P,SAAS,oBACd5P,KAAKkB,UAAU9B,UAAUC,IAAI,4BAEtB8D,QAAQC,IAAI,CACjBpD,KAAK2S,SAASwnC,oBAAoB2qC,mBAClC9kF,KAAK2S,SAASwnC,oBAAoBmC,0BACjC56C,MAAK,EAAEqjF,EAAe7qC,MACvBA,EAAqBA,EAAmBvuB,QAAQovB,IAAcA,EAASviC,OAAO+jC,WAE9E,MAAMpjC,EAAU,IAAIC,GAGdkxB,EAAO4P,EAAmBv/B,KAAKmgC,IACnC,MAAMvR,EAAa,IAAI0B,GAAW,CAChCxnC,KAHS,iBAIThE,KAAMq7C,EAAkBhsC,MACxBtO,MAAOs6C,EAAkBC,SACzB7P,YAAY,IAGR3lB,EAAM,IAAI8jB,GAAI,CAClBE,WAAAA,EACAK,aAAa,IAef,OAZAL,EAAW+B,KAAKlsC,UAAUC,IAAI,wBAE9B47C,GAAiB,CACf11B,IAAAA,EACAiV,IAAKsgB,EAAkBI,YACvBl6C,KAAM,UAGL85C,EAAkBC,WAAagqC,EAAchqC,UAC9CxR,EAAW3oC,kBAAiB,GAGvB2kB,KAGH4jB,EAAOkB,GAAkBC,GAAO9pC,IACpCR,KAAK2S,SAASwnC,oBAAoB6qC,mBAAmBxkF,MAGvD2Y,EAAQpK,QAAQrP,OAAOypC,GACvBnpC,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,eC/B9B,MAAM+jF,GAOXrlF,YACE6D,EACAoyB,EACAhV,EACAqkE,EACA1oD,EACA2oD,GAAa,GAEb,MAAMvhC,EAAa,yBACnB5jD,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAIukD,GAE7B,MAAMl6B,EAAU5qB,SAASC,cAAc,OACvC2qB,EAAQtqB,UAAUC,IAAIukD,EAAa,YAEnC,MAAMxgB,EAAUtkC,SAASC,cAAc,OACvCqkC,EAAQhkC,UAAUC,IAAIukD,EAAa,UACnC,QAAMxgB,EAAS3/B,GAEf,MAAM2hF,EAAWplF,KAAKqlF,eAAiBvmF,SAASC,cAAc,OAC9DqmF,EAAShmF,UAAUC,IAAIukD,EAAa,UAEjCuhC,IACDC,EAAS9gF,UAAY,GAAKuc,GAG5B6I,EAAQhqB,OAAO0jC,EAASgiD,GAExBplF,KAAKslF,MAAQ,IAAIpwD,GAAc,CAC7BW,KAAAA,EACAjzB,IAAKsiF,EACL1iF,IAAKg6B,GACJ3b,GACH7gB,KAAKslF,MAAMtvD,eACXh2B,KAAKslF,MAAMvvD,YAAY,CACrBJ,QAASn1B,IACJR,KAAKkM,UACNlM,KAAKkM,SAAS1L,GAGb2kF,IAEDC,EAASnmD,UAAY,GAAKz+B,MAKhCR,KAAKkB,UAAUxB,OAAOgqB,EAAS1pB,KAAKslF,MAAMpkF,YAI/B,MAAMqkF,WAA8Bz1E,EACjDT,OACErP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,8BAC7BW,KAAK4P,SAAS,WAEd,MAAMuJ,EAAUq2D,GAAgBtmE,KAAK,KAAMlJ,KAAK8L,YAEhD,CACE,MAAM5K,EAAYiY,EAAQ,YAEpBmsE,EAAQ,IAAIL,GAAqB,WAAY,EAAG,8BAAqC,GAAI,IAC/FK,EAAMp5E,SAAY1L,IAChB,sCAA4C,4BAA6BA,IAG3E,MAAMglF,GAAuB,OAAO,8BAA+B,CAACvmF,KAAM,QAASQ,KAAM,oBAEzF,QAAiB+lF,GAAsB,KACrCxlF,KAAKyO,OAAO+D,UAAUuuE,IAAkB5xE,UAG1C,MAAMs2E,EAA0B,IAAI,KAAc,CAChDhmF,KAAM,mBACNgE,KAAM,aACN0nC,SAAU,6BACV6C,YAAY,IAGd9sC,EAAUxB,OAAO4lF,EAAMpkF,UAAWskF,EAAsBC,EAAwBlsE,OAGlF,CACE,MAAMrY,EAAYiY,EAAQ,oBAEpBgwB,EAAOrqC,SAASC,cAAc,QAE9B0E,EAAO,gBACP0nC,EAAW,wBAEXu6C,EAAW,IAAIr8C,GAAI,CACvBE,WAAY,IAAI0B,GAAW,CACzBM,QAAS,6BACT9nC,KAAAA,EACAjD,MAAO,QACP2qC,SAAAA,IAEFzB,gBAAiB,4CAGbi8C,EAAe,IAAIt8C,GAAI,CAC3BE,WAAY,IAAI0B,GAAW,CACzBxnC,KAAAA,EACAjD,MAAO,YACP2qC,SAAAA,IAEFzB,gBAAiB,wCAEnB,QAAMi8C,EAAap8C,WAAW+B,KAAM,iCAAkC,CAAC,GAAA4xB,SAAW,IAAM,SAExF/zB,EAAKzpC,OAAOgmF,EAASxkF,UAAWykF,EAAazkF,WAC7CA,EAAUxB,OAAOypC,GAGnB,GAAG,KAA0B,CAC3B,MAAMjoC,EAAYiY,EAAQ,sBAEpBgwB,EAAOrqC,SAASC,cAAc,QAE9B0E,EAAO,gBACP0nC,EAAW,wBAEXy6C,EAAgB,IAAIv8C,GAAI,CAC5BE,WAAY,IAAI0B,GAAW,CACzBM,QAAS,0BACT9nC,KAAAA,EACAjD,MAAO,aACP2qC,SAAAA,MAIE06C,EAAW,IAAIx8C,GAAI,CACvBE,WAAY,IAAI0B,GAAW,CACzBM,QAAS,qBACT9nC,KAAAA,EACAjD,MAAO,QACP2qC,SAAAA,MAIJhC,EAAKzpC,OAAOkmF,EAAc1kF,UAAW2kF,EAAS3kF,WAC9CA,EAAUxB,OAAOypC,GAGnB,CACE,MAAMjoC,EAAYiY,EAAQ,sBAEpBgwB,EAAOrqC,SAASC,cAAc,QAE9B0E,EAAO,cACP0nC,EAAW,sBAEX26C,EAA4D,CAChE,CAAC,MAAO,0BACR,CAAC,MAAO,2BAGJx7C,EAAOw7C,EAAQnrE,KAAI,EAAEorE,EAAQl6C,KACrB,IAAIxC,GAAI,CAClBE,WAAY,IAAI0B,GAAW,CACzBM,QAASM,EACTpoC,KAAAA,EACAjD,MAAOulF,EACP56C,SAAAA,QAOA/iB,ECtMG,SAAoBtjB,EAAqBkhF,GAAW,GACjE,OCAa,SAAqBlhF,EAAqBmhF,EAA8BD,GAAW,GAChG,MAKME,EAAYphF,EAKlB,IAAImJ,EAQJ,OAZI+3E,IACFlhF,EAAW64B,GAAA,GAIb,SAAUwoD,IACRrhF,IACAmJ,EAAUwd,GAAA,aAAe06D,EAAKF,KAFhC,GAKAnhF,EAAWohF,EAhBI,KACb/3E,aAAaF,IDFRm4E,CAAYthF,GAAU,IAAuC,KAAhC,IAAK,IAAIY,MAAOgQ,eAAsBswE,GDqMvDK,EAAW,KACxB,MAAMlzE,EAAO,IAAIzN,KAEjBogF,EAAQ14E,SAAQ,EAAE24E,GAAS1nE,KACzB,MAAM+S,EAAMje,EAAKmzE,mBAAmB,cAAgBP,EAAQ,CAC1D1xE,KAAM,UACNC,OAAQ,YAGVg2B,EAAKjsB,GAAKorB,SAAS9W,YAAcvB,QAIrCpxB,KAAK+P,cAAc3P,iBAAiB,UAAWgoB,GAE/C+gB,EAAKzpC,UAAU4qC,EAAK3vB,KAAK4K,GAAQA,EAAIrkB,aACrCA,EAAUxB,OAAOypC,GAGnB,CACE,MAAMjoC,EAAYiY,EAAQ,SAEpBotE,EAAuB,IAAI,KAAc,CAC7C9mF,KAAM,kCACNgE,KAAM,gBACN0nC,SAAU,yBACV6C,YAAY,IAERw4C,EAAmB,IAAI,KAAc,CACzC/mF,KAAM,2BACNgE,KAAM,YACN0nC,SAAU,qBACV6C,YAAY,IAGd9sC,EAAUxB,OAAO6mF,EAAqBhtE,MAAOitE,EAAiBjtE,OAGhE,CACE,MAAMJ,EAAU,IAAIC,GAAe,CAAC3V,KAAM,2CAA4C0rC,QAAS,oBAEzFgN,EAAe,IAAI9S,GAAI,CAC3BW,aAAc,mBACdJ,aAAa,EACbl/B,UAAW,KACT1K,KAAKyO,OAAO+D,UAAUqyE,IAAqB11E,UAIzCs3E,EAAsB,KAC1BtjF,QAAQ4B,QAAQ/E,KAAK2S,SAASwnC,oBAAoB2qC,oBAAoBpjF,MAAMq5C,IAC1EE,GAAiB,CACf11B,IAAK42B,EACL3hB,IAAKugB,EAASG,YACdl6C,KAAM,cAKZylF,IAEAzmF,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAkBymF,GAErD,MAAMF,EAAuB,IAAI,KAAc,CAC7C9mF,KAAM,2BACNgE,KAAM,UACN0nC,SAAU,4BACV6C,YAAY,IAER04C,EAAoB,IAAI,KAAc,CAC1CjnF,KAAM,iCACNgE,KAAM,OACN0nC,SAAU,yBACV6C,YAAY,IAGR24C,EAAmC,GAEnCC,EAAkBztE,EAAQq/B,yBAE1B/pB,EAAgB,IAAInP,GACpBunE,EAAmB,CAACnsB,EAAmCz7C,EAA+B,YAC1F,MAAMsG,EAAM,IAAI8jB,GAAI,CAClBv6B,OAAO,EAAA8pB,GAAA,GAAc8hC,EAAW5rD,OAChC46B,gBAAiB,WACjBC,iBAAkB,CAAC+wB,EAAW3tD,OAC9B68B,aAAa,EACbl/B,UAAW,KACT,IAAIw5E,GAAc,CAAC1zE,GAAIkqD,EAAWlqD,GAAIylD,YAAayE,EAAWzE,cAAc/mB,UAIhFy3C,EAAYjsB,EAAWlqD,IAAM+U,EAE7B,MAAMlhB,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,aAElB66D,GAAoB,CAClBj9C,IAAKy9C,EACLx5D,UAAWmD,EACX87B,MAAO,mBACP1R,cAAAA,EACAltB,MAAO,GACPC,OAAQ,GACRF,UAAU,IAGZikB,EAAIrkB,UAAUxB,OAAO2E,GAErBuiF,EAAgB3nE,GAAQsG,EAAIrkB,YAG9BlB,KAAK2S,SAASo0B,mBAAmB+/C,iBAAiBplF,MAAMqlF,KACtD,EAAApiD,GAAA,GAAoDoiD,GACpD,IAAI,MAAMrsB,KAAcqsB,EAAYC,KAClCH,EAAiBnsB,MAIrB16D,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,sBAAuBK,IACxD,MAAM4c,EAA6B5c,EAE/BsmF,EAAY1pE,EAAIzM,KAClBq2E,EAAiB5pE,EAAK,cAI1Bjd,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAqBK,IACtD,MAAM4c,EAA6B5c,EAEhCsmF,EAAY1pE,EAAIzM,MACjBm2E,EAAY1pE,EAAIzM,IAAItP,UAAUZ,gBACvBqmF,EAAY1pE,EAAIzM,QAI3B2I,EAAQpK,QAAQrP,OAAOy8C,EAAaj7C,UAAWqlF,EAAqBhtE,MAAOmtE,EAAkBntE,OAC7FvZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YAInCuQ,SACKzR,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,OG9UH,MAAM43E,WAA0Bz4E,EAW7Ba,O,qCACdrP,KAAKkB,UAAU9B,UAAUC,IAAI,0BAC7BW,KAAK4P,SAAS,qBAEd,MAAM04B,EAA4B,GAElC,CACE,MAAMnvB,EAAUq2D,GAAgBxvE,KAAK8L,gBAAY9B,EAAW,mBACtDqP,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3B,MAAM6nF,QAAkBlnF,KAAK2S,SAAS2iE,WAAW6R,eACjDnnF,KAAKonF,oBAAsB,IAAI,IAAW,CACxC7tE,MAAO,6BACP9V,KAAM,aACN+V,UAAW,KAEbxZ,KAAK69C,mBAAqB,IAAI,IAAW,CACvCtkC,MAAO,sCACP9V,KAAM,YACN+V,UAAW,KAEbxZ,KAAKqnF,cAAgB,IAAI,IAAW,CAClC9tE,MAAO,uBACP9V,KAAM,MACN+V,UAAW,YAAoB0tE,EAAUI,2BAA6BJ,EAAUK,6BAGlFluE,EAAa3Z,OAAOM,KAAKonF,oBAAoBlmF,UAAWlB,KAAK69C,mBAAmB38C,UAAWlB,KAAKqnF,cAAcnmF,WAE9G,MAAMiuC,EAAUrwC,SAASC,cAAc,OACvCowC,EAAQ/vC,UAAUC,IAAI,YACtB,QAAM,CAAC+K,QAAS+kC,EAASt/B,IAAK,oBAE9By4B,EAAYz2B,KAAK7R,KAAKonF,oBAAqBpnF,KAAK69C,mBAAoB79C,KAAKqnF,eAEzErnF,KAAKg8C,SAAW,IAAIhU,GAAS,CAC3Bz7B,OAAQ,SACR+7B,YAAAA,EACAr/B,eAAgBjJ,KAAKiJ,iBAGvBjJ,KAAK+O,QAAQrP,OAAOM,KAAKg8C,SAASliC,SAElCX,EAAQzZ,OAAOM,KAAKg8C,SAAS/iC,WAAW/X,UAAWmY,GAGrD,CACE,MAAMF,EAAU,IAAIC,GAAe,CACjC3V,KAAM,uBACN0rC,SAAS,IAGL91B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAKwnF,mBAAqB,IAAIt7C,GAAmB,CAC/C3yB,MAAO,6BACP9V,KAAM,WACN3D,WAAW,EACXmJ,eAAgBjJ,KAAKiJ,eACrBiD,SAAU,KACRlM,KAAKg8C,SAASvT,eACdzoC,KAAKynF,iBAEP16C,cAAe,iCACfC,UAAW,6BACXL,YAAa,gCACZ3sC,KAAK2S,UAER0G,EAAa3Z,OAAOM,KAAKwnF,mBAAmBtmF,WAE5C,MAAMiuC,EAAUh2B,EAAQg2B,QACxBA,EAAQzvC,QAAO,QAAK,uCACpByvC,EAAQzvC,OAAOZ,SAASC,cAAc,MAAOD,SAASC,cAAc,OAEpE,MAAM2oF,EAAsB1nF,KAAK0nF,oBAAsB5oF,SAASC,cAAc,OAC9E2oF,EAAoBtoF,UAAUC,IAAI,yBAElC,MAAMsoF,EAAmB3nF,KAAK2nF,iBAAmB7oF,SAASC,cAAc,KACxE4oF,EAAiBvoF,UAAUC,IAAI,eAC/BsoF,EAAiBzxB,KAAO,IACxByxB,EAAiBxgF,OAAS,SAE1BugF,EAAoBhoF,QAAO,QAAK,mBAAoB,CAACioF,KAErDx4C,EAAQzvC,OAAOgoF,GAEfp/C,EAAYz2B,KAAK7R,KAAKwnF,oBACtBruE,EAAQpK,QAAQrP,OAAO2Z,GACvBrZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YAGjC,QAAiBlB,KAAKg8C,SAASliC,SAAS,KACtC9Z,KAAKg8C,SAASliC,QAAQva,UAAW,EAEjC,IAAIkK,EAA2B,GAE/BA,EAASoI,KAAK7R,KAAK2S,SAASq8B,kBAAkB44C,cAAc5nF,KAAKonF,oBAAoB5mF,MAAOR,KAAK69C,mBAAmBr9C,MAAOR,KAAKqnF,cAAc7mF,OAAOkB,MAAK,KACxJ1B,KAAKiP,WACHxB,IACFC,QAAQC,MAAM,uBAAwBF,OAGrCzN,KAAKg8C,SAASjjC,cACftP,EAASoI,KAAK7R,KAAKg8C,SAASjjC,eAAerX,MAAM4Y,GACxCta,KAAK2S,SAASq8B,kBAAkB64C,mBAAmBvtE,MAI3Dta,KAAKwnF,mBAAmBv6C,mBACzBxjC,EAASoI,KAAK7R,KAAK2S,SAAS2I,gBAAgBm0B,eAAezvC,KAAKwnF,mBAAmBhnF,QAGrF2C,QAAQ25C,KAAKrzC,GAAUyhB,SAAQ,KAC7BlrB,KAAKg8C,SAASliC,QAAQnV,gBAAgB,iBAEvC,CAACsE,eAAgBjJ,KAAKiJ,iBAEzB,MAAMsP,QAAavY,KAAK2S,SAAS2I,gBAAgBk1D,UAE3CsX,QAAiB9nF,KAAK2S,SAASq8B,kBAAkB+4C,WAAWxvE,EAAK/H,IAAI,GAE3ExQ,KAAKonF,oBAAoB13C,iBAAiBn3B,EAAKwlC,YAAY,GAC3D/9C,KAAK69C,mBAAmBnO,iBAAiBn3B,EAAKylC,WAAW,GACzDh+C,KAAKqnF,cAAc33C,iBAAiBo4C,EAAS7tE,OAAO,GACpDja,KAAKwnF,mBAAmB93C,iBAAiBn3B,EAAKyzB,UAAU,GAExDhsC,KAAKynF,gBACLznF,KAAKg8C,SAASvT,gB,+RAGRg/C,gBACN,GAAGznF,KAAKwnF,mBAAmBznF,MAAMX,UAAUiG,SAAS,WAAarF,KAAKwnF,mBAAmBhnF,MAAMG,OAC7FX,KAAK0nF,oBAAoBzkF,MAAMC,QAAU,WACpC,CACLlD,KAAK0nF,oBAAoBzkF,MAAMC,QAAU,GACzC,IAAIojB,EAAM,gBAAkBtmB,KAAKwnF,mBAAmBhnF,MACpDR,KAAK2nF,iBAAiB1oD,UAAY3Y,EAClCtmB,KAAK2nF,iBAAiBzxB,KAAO5vC,I,sTCjJpB,MAAM0hE,WAA4Bx5E,EAAjD,c,oBA0GE,KAAAwjC,cAAsBx3B,GAAsB,yCAGpCxa,KAAK2S,SAAS2I,gBAAgB2sE,cACpCztE,EAAQpN,SAASb,IAGf,MAAM,IAAC4O,GAAO,gBAA+B,CAC3C5O,OAAQA,EACRrL,UAAWlB,KAAKg6B,SAASluB,WACzBsP,eAAe,EACf7N,WAAY,KAGR2jC,EAAWlxC,KAAKg6B,SAASkX,SAASiB,IAAI5lC,GAC5C4O,EAAIo6B,YAAY71C,OAAOM,KAAKkzC,SAAShC,IAGrC,MAAMg3C,EAAgC,GACtCloF,KAAKmoF,iBAAiB/6E,SAAQ,CAACwmC,EAASjoB,KACtC,GAAGioB,EAAQzB,IAAI5lC,GAAS,CACtB,MAAMhD,EAAOzK,SAASC,cAAc,SACpC,EAAA45B,EAAA,GAAapvB,GAAM,EAAAqvB,GAAA,GAAcjN,EAAO7c,QACxCo5E,EAAer2E,KAAKtI,QAIT,QAAK2+E,GAAgB,GAC7B96E,SAASmE,IACd4J,EAAIE,gBAAgB3b,OAAO6R,YAoGjC,KAAA62E,eAAkBznF,IAEC,aAAdX,KAAKC,OACND,KAAKqoF,WAAWplF,MAAMC,QAAUvC,EAAS,GAAK,SAnOxC0O,OA2ER,OA1EArP,KAAK+O,QAAQzO,SACbN,KAAKkB,UAAU9B,UAAUC,IAAI,+BAC7BW,KAAKqoF,WAAa,EAAW,yBAA0B,CAACnpF,UAAU,IAClEc,KAAKqoF,WAAWplF,MAAMC,QAAU,OAEhClD,KAAK4O,OAAOlP,OAAOM,KAAKqoF,YAExBroF,KAAKqoF,WAAWjoF,iBAAiB,SAAS,IAAW,mCACnD,MAAM8wC,EAAWlxC,KAAKg6B,SAAS+b,cAI/B,GAAiB,aAAd/1C,KAAKC,KACN,IAAI,MAAM4P,KAAO7P,KAAK2rB,OAAOnT,OACI,IAA5B3I,EAAI2G,QAAQ,oBAKRxW,KAAK2rB,OAAOnT,OAAO3I,QAG5B,IAAI,MAAMA,KAAO7P,KAAK2rB,OAAOnT,OACI,IAA5B3I,EAAI2G,QAAQ,oBAKRxW,KAAK2rB,OAAOnT,OAAO3I,GAI9B,MAAM2K,EAAoB,GAC1B,IAAI,MAAM3K,KAAOqhC,EACZrhC,EAAIwiC,WACL73B,EAAQ3I,KAAKhC,EAAIgL,YAGjB7a,KAAK2rB,OAAOnT,OAAO3I,IAAO,EAI9B,IAAIy4E,EAEFA,EADe,aAAdtoF,KAAKC,KACCsM,GAAWiO,EAAQpT,SAASmF,GAE5BA,IAAYiO,EAAQpT,SAASmF,IAGtC,EAAAg8E,GAAA,GAAevoF,KAAK2rB,OAAO68D,eAAe,CAACj8E,EAAQ8R,KAC7CiqE,EAAI/7E,KACNvM,KAAK2rB,OAAO68D,cAAcjqE,OAAOF,EAAK,GACtCre,KAAK2rB,OAAO88D,aAAalqE,OAAOF,EAAK,OAIzC,MAAMqqE,EAAsB,aAAd1oF,KAAKC,KAAsB,iBAAmB,iBACtD0oF,EAA4B,aAAd3oF,KAAKC,KAAsB,gBAAkB,iBACjE,EAAAsoF,GAAA,GAAevoF,KAAK2rB,OAAO+8D,IAAQ,CAACn8E,EAAQ8R,KACvC7D,EAAQpT,SAASmF,KAClBvM,KAAK2rB,OAAO+8D,GAAOnqE,OAAOF,EAAK,GAC/Bre,KAAK2rB,OAAOg9D,GAAapqE,OAAOF,EAAK,OAIzCre,KAAK2rB,OAAqB,aAAd3rB,KAAKC,KAAsB,iBAAmB,kBAAoBua,EAC9Exa,KAAK2rB,OAAqB,aAAd3rB,KAAKC,KAAsB,gBAAkB,uBAAyBkD,QAAQC,IAAIoX,EAAQG,KAAKpO,GAAWvM,KAAK2S,SAAS2/B,gBAAgBs2C,iBAAiBr8E,MAGrKvM,KAAK6oF,cAAcC,UAAU9oF,KAAK2rB,QAAQ,GAC1C3rB,KAAKiP,aAGPjP,KAAKmoF,iBAAmB,IAAIl3E,IACrBjR,KAAK2S,SAASo2E,eAAeC,mBAAmBtnF,MAAW2rE,GAAY,yCACtElqE,QAAQC,IAAIiqE,EAAQ1yD,KAAUgR,GAAW,mCAC7C,MACMnR,SADgBxa,KAAK2S,SAASs2E,eAAeC,iBAAiBv9D,EAAOnb,KACnDmK,KAAKvH,GAAMA,EAAE7G,SACrCvM,KAAKmoF,iBAAiBlrE,IAAI0O,EAAQ,IAAI/M,IAAIpE,eAKhD04B,SAAShC,GACP,MAAM1H,EAAgB,IAAI,KAAc,CACtC3mC,OAAO,IAMT,OAJGquC,IACD1H,EAAczpC,MAAMqpC,QAAU8H,GAGzB1H,EAAcjwB,MAqCvB9H,SACKzR,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGdrP,KAAKqoF,WAAWplF,MAAMC,QAAwB,aAAdlD,KAAKC,KAAsB,GAAK,OAChED,KAAK4P,SAAuB,aAAd5P,KAAKC,KAAsB,mBAAqB,mBAE9D,MAAM0rB,EAAS3rB,KAAK2rB,OAEdw9D,EAAoB,IAAI/vE,GAAe,CAC3Cg2B,aAAa,EACb3rC,KAAM,oBAKR,IAAIimB,EAFJy/D,EAAkBjoF,UAAU9B,UAAUC,IAAI,qBAIxCqqB,EADe,aAAd1pB,KAAKC,KACI,CACRmpF,cAAe,CAACC,IAAK,OAAQ5pF,KAAM,8BACnC6pF,iBAAkB,CAACD,IAAK,UAAW5pF,KAAM,2BACzC8pF,aAAc,CAACF,IAAK,YAAa5pF,KAAM,8BAG/B,CACR40C,SAAU,CAACg1C,IAAK,aAAc5pF,KAAM,4BACpC+pF,aAAc,CAACH,IAAK,cAAe5pF,KAAM,+BACzCgqF,OAAQ,CAACJ,IAAK,QAAS5pF,KAAM,0BAC7BiqF,WAAY,CAACL,IAAK,aAAc5pF,KAAM,4BACtCkqF,KAAM,CAACN,IAAK,OAAQ5pF,KAAM,yBAI9B,MAAMgrB,EAAI3rB,SAASqW,yBACnB,IAAI,MAAMtF,KAAO6Z,EAAS,CACxB,MAAM7qB,GAAS,OAAO,qDAAsD,CAACI,KAAMyqB,EAAQ7Z,GAAKw5E,IAAK5pF,KAAMiqB,EAAQ7Z,GAAKpQ,OACxHZ,EAAO+I,QAAQ2E,OAASsD,EACxBhR,EAAOa,OAAOM,KAAKkzC,YACnBzoB,EAAE/qB,OAAOb,GAEXsqF,EAAkBp6E,QAAQrP,OAAO+qB,GAIjC,MAAMm/D,GAA+B,aAAd5pF,KAAKC,KAAsB0rB,EAAOk+D,eAAiBl+D,EAAOm+D,gBAAgBppF,QAEjGV,KAAKg6B,SAAW,IAAIgX,GAAe,CACjCqC,SAAUrzC,KAAKkB,UACfgL,SAAUlM,KAAKooF,eACf72C,SAAU,CAAC,WACXQ,kBAAmB/xC,KAAKgyC,cACxBjkC,YAAa,SACbglC,uBAAwB,cACxBpgC,SAAU3S,KAAK2S,WAEjB3S,KAAKg6B,SAASkX,SAAW,IAAItyB,IAAIgrE,GAEjC,IAAIG,GAAe,EACnB,MAAMC,EAAOhqF,KAAKg6B,SAAS36B,IAAI6J,KAAKlJ,KAAKg6B,UACzCh6B,KAAKg6B,SAAS36B,IAAM,CAACkN,EAAQuC,EAAO4mC,KAClC,GAAG11C,KAAKg6B,SAASkX,SAASlwC,MAAQ,KAAO+oF,IAAiBrgE,EAAQnd,GAAS,CACzE,MAAMgF,EAAuBvR,KAAKg6B,SAASnvB,KAAK3F,cAAc,kBAAkBqH,yBAShF,OARGgF,GACDnL,YAAW,KACTmL,EAAG63B,SAAU,IACZ,QAILuC,GADY,YAA0B,aAAd3rC,KAAKC,KAAsB,uCAAwC,wCAAwC,IAKrI,MAAMoE,EAAM2lF,EAAKz9E,EAAQmd,EAAQnd,IAAU,QAAKmd,EAAQnd,GAAQ9M,WAAQuK,EAAW0rC,GAInF,OAHGhsB,EAAQnd,IACTlI,EAAIa,cAAc,kBAAkB9F,UAAUC,IAAI,SAAWqqB,EAAQnd,GAAQ88E,KAExEhlF,GAGTrE,KAAKg6B,SAASluB,WAAW5K,UAAUxB,OAAOypF,EAAkBjoF,UAAWlB,KAAKg6B,SAASluB,WAAW5K,UAAUuD,kBAE1GzE,KAAKg6B,SAASgc,WAAW4zC,GACzBG,GAAe,EAEf,IAAI,MAAM9xC,KAAQtsB,EAAOnT,OAEpBkR,EAAQ/J,eAAes4B,IAAWtsB,EAAOnT,OAAOy/B,IAChDkxC,EAAkBp6E,QAAQ7J,cAAc,kBAAkB+yC,OAA0BnF,QAY3FtjC,sBAME,OALGxP,KAAKg6B,WACNh6B,KAAKg6B,SAAS94B,UAAUZ,SACxBN,KAAKg6B,SAAW,MAGXn6B,MAAM2P,sBAMRL,KAAKwc,EAAuB1rB,EAAgC4oF,GAMjE,OALA7oF,KAAKiqF,eAAiBt+D,EACtB3rB,KAAK2rB,QAAS,EAAA8rB,GAAA,GAAKz3C,KAAKiqF,gBACxBjqF,KAAKC,KAAOA,EACZD,KAAK6oF,cAAgBA,EAEdhpF,MAAMsP,Q,iUC7PF,MAAM+6E,WAAyB17E,EAA9C,c,oBAUU,KAAA4oC,MAAsJ,GASpJ/nC,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,yBAC7BW,KAAKmvC,QAAUrwC,SAASC,cAAc,OACtCiB,KAAKmvC,QAAQ/vC,UAAUC,IAAI,WAC3BW,KAAKmvC,QAAQzvC,QAAO,QAAK,6BACzBM,KAAKgxE,iBAAmBlyE,SAASC,cAAc,OAC/CiB,KAAKgxE,iBAAiB5xE,UAAUC,IAAI,qBAEpCW,KAAKqoF,WAAa,EAAW,+BAC7B,MAAM8B,EAA4C,CAChDlrF,KAAM,gBACNQ,KAAM,mBACNuoB,QAAS,KACP,IAAIklB,GAAU,gBAAiB,CAC7BlD,aAAc,wCACd0D,mBAAoB,sCACpBP,QAAS,CAAC,CACR5B,QAAS,SACTzmC,SAAU,KACRqlF,EAAmB//E,QAAQ5K,aAAa,WAAY,QACpDQ,KAAK2S,SAASo2E,eAAeqB,mBAAmBpqF,KAAK2rB,QAAQ,GAAMjqB,MAAM2oF,IACpEA,GACDrqF,KAAKiP,WAENic,SAAQ,KACTi/D,EAAmB//E,QAAQzF,gBAAgB,gBAG/Co1C,UAAU,MAEX7K,SAGPlvC,KAAKsqF,QAAU,GAAiB,GAAI,cAAe,CAACH,IACpDnqF,KAAKsqF,QAAQlrF,UAAUC,IAAI,QAE3BW,KAAK4O,OAAOlP,OAAOM,KAAKqoF,WAAYroF,KAAKsqF,SAEzC,MAAMC,EAAe,IAAInxE,GAAe,IAElCC,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAK49C,eAAiB,IAAI,IAAW,CACnCrkC,MAAO,iBACPC,UAlEyB,KAqE3BH,EAAa3Z,OAAOM,KAAK49C,eAAe18C,WACxCqpF,EAAax7E,QAAQrP,OAAO2Z,GAE5B,MAAMmxE,EAAe,CAAC7rF,EAAmB8rF,EAAqBt9C,EAAgF7K,KAC5I,MAAMnpB,EAAU,IAAIC,GAAe,CACjC3V,KAAMgnF,EACNr7C,aAAa,IAGfj2B,EAAQjY,UAAU9B,UAAUC,IAAI,cAAeV,GAE/C,MAAM+rF,EAAavxE,EAAQq/B,yBAiB3B,OAhBAkyC,EAAWtrF,UAAUC,IAAI,qBAEzB8tC,EAAQ//B,SAAS2gC,IACf,MAAMlvC,GAAS,OAAO,yDAA0D,CAC9EI,KAAM8uC,EAAE9uC,KACRQ,KAAMsuC,EAAEtuC,KACRP,UAAU6uC,EAAEC,iBAAahkC,IAGxB+jC,EAAEtqC,OACH6+B,EAAGyL,EAAEtqC,MAAQ5E,GAGf6rF,EAAWhrF,OAAOb,MAGbsa,GAGTnZ,KAAK6pF,eAAiBW,EAAa,uBAAwB,gBAAiB,CAAC,CAC3EvrF,KAAM,cACNQ,KAAM,kCACNuuC,YAAY,GACX,CACDvuC,KAAM,2BACNR,KAAM,aACNwE,KAAM,YACL,CACDhE,KAAM,8BACNR,KAAM,cACNwE,KAAM,gBACL,CACDhE,KAAM,yBACNR,KAAM,QACNwE,KAAM,UACL,CACDhE,KAAM,2BACNR,KAAM,UACNwE,KAAM,cACL,CACDhE,KAAM,uBACNR,KAAM,OACNwE,KAAM,SACJzD,KAAKo3C,OAETp3C,KAAK8pF,eAAiBU,EAAa,uBAAwB,gBAAiB,CAAC,CAC3EvrF,KAAM,gBACNQ,KAAM,kCACNuuC,YAAY,GACX,CACDvuC,KAAM,6BACNR,KAAM,OACNwE,KAAM,iBACL,CACDhE,KAAM,0BACNR,KAAM,UACNwE,KAAM,oBACL,CACDhE,KAAM,4BACNR,KAAM,YACNwE,KAAM,iBACJzD,KAAKo3C,OAETp3C,KAAK8L,WAAWpM,OAAOM,KAAKgxE,iBAAkBhxE,KAAKmvC,QAASo7C,EAAarpF,UAAWlB,KAAK6pF,eAAe3oF,UAAWlB,KAAK8pF,eAAe5oF,WAEvI,MAAMypF,EAAyB3qF,KAAK6pF,eAAe3oF,UAAUgE,cAAc,sBACrE0lF,EAAyB5qF,KAAK8pF,eAAe5oF,UAAUgE,cAAc,sBAE3EylF,EAAuBzlF,cAAc,QAAQ9E,iBAAiB,SAAS,KACrEJ,KAAKyO,OAAO+D,UAAUw1E,IAAqB74E,KAAKnP,KAAK2rB,OAAQ,WAAY3rB,SAG3E4qF,EAAuB1lF,cAAc,QAAQ9E,iBAAiB,SAAS,KACrEJ,KAAKyO,OAAO+D,UAAUw1E,IAAqB74E,KAAKnP,KAAK2rB,OAAQ,WAAY3rB,SAG3EA,KAAKqoF,WAAWjoF,iBAAiB,SAAS,KACxC,GAAGJ,KAAK49C,eAAe79C,MAAMX,UAAUiG,SAAS,SAC9C,OAGF,IAAIrF,KAAK49C,eAAep9C,MAAM8L,OAE5B,YADAtM,KAAK49C,eAAe79C,MAAMX,UAAUC,IAAI,SAI1C,IAUIyK,EAVA+gF,EAAWz5E,MAAMC,KAAKs5E,EAAuB7kE,UAA4BplB,MAAM,GAAGogB,QAAO,CAACC,EAAKxP,IAAOwP,KAAQxP,EAAGtO,MAAMC,SAAS,GACpI2nF,GAAW7qF,KAAK2rB,OAAOm/D,cAAcnqF,OAEjCkqF,GAKJ7qF,KAAKqoF,WAAW7oF,aAAa,WAAY,QAMvCsK,EAHE9J,KAAK2rB,OAAOnb,GAGJxQ,KAAK2S,SAASo2E,eAAeqB,mBAAmBpqF,KAAK2rB,QAFrD3rB,KAAK2S,SAASo2E,eAAegC,mBAAmB/qF,KAAK2rB,QAKjE7hB,EAAQpI,MAAM2oF,IACTA,GACDrqF,KAAKiP,WAENpB,OAAOJ,IACQ,4BAAbA,EAAIxN,KACL0rC,GAAM,yCAENj+B,QAAQC,MAAM,4BAA6BF,MAE5Cyd,SAAQ,KACTlrB,KAAKqoF,WAAW1jF,gBAAgB,gBAxBhCgnC,GAAM,uDA4BV3rC,KAAK49C,eAAe79C,MAAMK,iBAAiB,SAAS,KAClDJ,KAAK2rB,OAAO7c,MAAQ9O,KAAK49C,eAAep9C,MACxCR,KAAKgrF,wBAGP,MAAMC,EAAsD,SAAdjrF,KAAKC,KAAkB,CACnED,KAAK2S,SAASo2E,eAAemC,qBAAqBlrF,KAAK2rB,OAAOnb,GAAI,gBAClExQ,KAAK2S,SAASo2E,eAAemC,qBAAqBlrF,KAAK2rB,OAAOnb,GAAI,iBAClExQ,KAAK2S,SAASo2E,eAAemC,qBAAqBlrF,KAAK2rB,OAAOnb,GAAI,kBAChE,GAEJ,OAAOrN,QAAQC,IAAI,CACjBpD,KAAKmrF,qBAAuBtlD,GAAA,uBAAkC,CAC5D3kC,UAAWlB,KAAKgxE,iBAChB3vE,MAAM,EACNC,UAAU,EACVC,MAAO,GACPC,OAAQ,IACP,aAAaE,MAAM0pF,IACpBprF,KAAK4B,UAAYwpF,EAEVvlD,GAAA,oBAA+BulD,SAGrCH,IAIPv5E,qBACE1R,KAAKmrF,qBAAqBzpF,MAAK,KAC7B1B,KAAK4B,UAAUN,UAAW,EAC1BtB,KAAK4B,UAAUS,UAIXgpF,eAENrrF,KAAK4P,SAAS,aACd5P,KAAKsqF,QAAQlrF,UAAUC,IAAI,QAC3BW,KAAKqoF,WAAWjpF,UAAUkB,OAAO,QACjCN,KAAK49C,eAAep9C,MAAQ,GAE5B,IAAI,MAAMy3C,KAAQj4C,KAAKo3C,MAErBp3C,KAAKo3C,MAAMa,GAAMh1C,MAAMC,QAAU,OAI7BooF,aAENtrF,KAAK4P,SAAuB,WAAd5P,KAAKC,KAAoB,YAAc,oBAEpC,SAAdD,KAAKC,OACND,KAAKsqF,QAAQlrF,UAAUkB,OAAO,QAC9BN,KAAKqoF,WAAWjpF,UAAUC,IAAI,SAGhC,MAAMssB,EAAS3rB,KAAK2rB,OACpB3rB,KAAK49C,eAAep9C,OAAQ,EAAA+qF,GAAA,IAAuB,EAAAC,GAAA,GAAc7/D,EAAO7c,QAExE,IAAI,MAAMmpC,KAAQj4C,KAAKo3C,MACrBp3C,KAAKo3C,MAAMa,GAAyCh1C,MAAMC,QAAYyoB,EAAOnT,OAAOy/B,GAA2C,GAAK,OAGtI,CAAE,iBAA2B,kBAA4B7qC,SAAcyC,GAAQ,mCAC7E,MAAMsJ,EAAUnZ,KAAK6P,GACf47E,EAAK,kBAAiC,CAACC,aAAa,IAE1D,IAAInf,EAAQ5gD,EAAO9b,GAGnB,MAAM87E,EAAgBp/E,GAAmB,mCACvC,eAAgBvM,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,OAAaA,EAAO46B,UAAkF,gBAAhEnnC,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,EAAOqO,aAAahO,KAG3Js+C,QAAiB3a,GAAYg8B,GAAQhgE,GAAWo/E,EAAQp/E,KAC9DggE,EAAM5rE,OAAS,EACf4rE,EAAM16D,QAAQq5C,GAEdqhB,EAAQA,EAAM7rE,QAEd,MAAMkrF,EAAmBC,GAAoB,mCAC3C,IAAI,IAAI9/E,EAAI,EAAGpL,EAASgC,KAAKC,IAAI2pE,EAAM5rE,OAAQkrF,GAAU9/E,EAAIpL,IAAUoL,EAAG,CACxE,MAAMQ,EAASggE,EAAMr/D,QACrB,IAAGX,EAAO46B,kBAA2BnnC,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,IAClF,SAGF,MAAM,IAAC4O,GAAO,gBAA+B,CAC3C5O,OAAQA,EACRrL,UAAWuqF,EACXrwE,eAAe,EACf5N,WAAW,EACXD,WAAY,KAEd4N,EAAIE,gBAAgBzX,cAActD,SAGjCisE,EAAM5rE,OACP+tD,EAASjqD,iBAAiBg6B,aAAY,QAAK,sBAAuB,CAAC8tC,EAAM5rE,UACjE+tD,GACRA,EAASpuD,YAMb,IAAIouD,EACJ,GAHAv1C,EAAQq/B,yBAAyB94C,OAAO+rF,GAGrClf,EAAM5rE,OAAQ,CACf,MAAMoO,EAAUoK,EAAQq/B,yBACxBkW,GAAW,OAAO,yDAA0D,CAACzvD,KAAM,SACnFyvD,EAAStvD,UAAUC,IAAI,YAAa,eACpCqvD,EAAStuD,iBAAiB,SAAS,IAAMwrF,EAAW,MACpDl9B,EAAShvD,QAAO,QAAK,sBAAuB,CAAC6sE,EAAM5rE,UAEnDoO,EAAQrP,OAAOgvD,GAGjBk9B,EAAW,QAIfZ,qBACE,GAAiB,SAAdhrF,KAAKC,KAAiB,CACvB,MAAM6c,IAAW,EAAA+5B,GAAA,GAAU72C,KAAKiqF,eAAgBjqF,KAAK2rB,QACrD3rB,KAAKqoF,WAAWjpF,UAAUoE,OAAO,QAASsZ,GAC1C9c,KAAKsqF,QAAQlrF,UAAUoE,OAAO,OAAQsZ,IAI1CgsE,UAAUn9D,EAAsB2G,GAC3BtyB,KAAKkB,WAENkQ,MAAMC,KAAKrR,KAAKkB,UAAUoQ,iBAAiB,mBAAmBlE,SAASmE,GAAOA,EAAGjR,WAGhFgyB,GACDtyB,KAAKiqF,eAAiBt+D,EACtB3rB,KAAK2rB,QAAS,EAAA8rB,GAAA,GAAK9rB,KAEnB3rB,KAAK2rB,OAASA,EACd3rB,KAAKsrF,aACLtrF,KAAKgrF,sBAIF77E,KAAKwc,GAoBV,YAnBc3hB,IAAX2hB,GACD3rB,KAAK8oF,UAAU,CACbl8E,EAAG,eACH4D,GAAI,EACJ1B,MAAO,GACP0J,OAAQ,GACRiwE,aAAc,GACdqC,cAAe,GACfgB,cAAe,GACftD,cAAe,GACfqB,eAAgB,GAChBC,eAAgB,KACf,GACH9pF,KAAKC,KAAO,WAEZD,KAAK8oF,UAAUn9D,GAAQ,GACvB3rB,KAAKC,KAAO,QAGPJ,MAAMsP,OAAOzN,MAAK,KACN,SAAd1B,KAAKC,MACND,KAAK8oF,UAAU9oF,KAAKiqF,gBAAgB,GACpCjqF,KAAKsrF,cAELtrF,KAAKqrF,mB,2SCrXE,MAAMU,WAA0Bv9E,EAA/C,c,oBAOU,KAAAw9E,gBAA6C,GAGvCC,aAAaC,EAAsDhrF,EAAyBqkB,G,0CACxG,IAAIoG,EA2CAtnB,EA1CAspC,EAAc,GACdv6B,EAAmB,GACvB,GAAsB,0BAAnB84E,EAAat/E,EACd+e,EAASugE,EAAavgE,OACtBgiB,EAAcu+C,EAAav+C,gBACtB,CAQL,GAPAhiB,EAASugE,EAOa,IALDC,OAAOzuE,KAAKiO,EAAOnT,QAAQ7X,OAKvB,CACvB,MAAM6X,EAASmT,EAAOnT,OACtB,IAAIf,EACDe,EAAO67B,SAAU58B,EAAI,oBAChBe,EAAOgxE,aAAc/xE,EAAI,uBACzBe,EAAOixE,OAAQhyE,EAAI,kBACnBe,EAAOkxE,WAAYjyE,EAAI,oBACvBe,EAAOmxE,OAAMlyE,EAAI,iBAEtBA,GACDrE,EAAEvB,MAAK,QAAK4F,IAIhB,IAAIrE,EAAEzS,OAAQ,CACZ,MAAMyrF,QAAepsF,KAAK2S,SAASs2E,eAAeC,iBAAiBv9D,EAAOnb,IAC1E,IAAIm+D,EAAQ,EAAG0d,EAAW,EAAG5C,EAAS,QAChCtmF,QAAQC,IAAIgpF,EAAOzxE,KAAU6d,GAAW,0CACnCx4B,KAAK2S,SAAS2/B,gBAAgBg6C,WAAW9zD,EAAOjsB,SAASk9E,WACpDzpF,KAAK2S,SAAS2/B,gBAAgBlE,YAAY5V,EAAOjsB,SAAS8/E,IACnE1d,UAGJA,GAAOv7D,EAAEvB,MAAK,QAAK,QAAS,CAAC88D,KAC7B0d,GAAUj5E,EAAEvB,MAAK,QAAK,WAAY,CAACw6E,KACnC5C,GAAQr2E,EAAEvB,MAAK,QAAK,SAAU,CAAC43E,MAKtC,GAAIlkE,EAwBFA,EAAIkkB,SAAS9W,YAAc,IAC3B,QAAKvf,GAAGhG,SAASmE,IACfgU,EAAIkkB,SAAS/pC,OAAO6R,WAbtB,GAZAgU,EAAM,IAAI8jB,GAAI,CACZv6B,OAAO,EAAA8pB,GAAA,GAAcjN,EAAO7c,OAC5B26B,SAAUkE,EACVjjC,WAAW,IAGV0I,EAAEzS,SACH,QAAKyS,GAAGhG,SAASmE,IACfgU,EAAIkkB,SAAS/pC,OAAO6R,MAIF,iBAAnB26E,EAAat/E,EAAsB,CACpC,MAAM2/E,EAAW5gE,EAAOnb,GACpBxQ,KAAKgsF,gBAAgBrsE,eAAegM,EAAOnb,MAC7C,QAAiB+U,EAAIrkB,WAAW,IAAW,mCACzClB,KAAKyO,OAAO+D,UAAU03E,IAAkB/6E,WAAWnP,KAAK2S,SAASo2E,eAAeyD,UAAUD,QACzF,CAACtjF,eAAgBjJ,KAAKiJ,iBAG3BjJ,KAAKgsF,gBAAgBrgE,EAAOnb,IAAM+U,EAgBtC,OAPAlhB,EAAMkhB,EAAIrkB,UAENyqB,EAA0BhM,eAAe,cAE3Cm7C,GAAuBz2D,EAAKA,EAAIT,eAAiB1C,EAAYyqB,EAA0B8gE,YAC/EvrF,GAAWA,EAAUxB,OAAO2E,GAE/BA,KAGOgL,O,0CACdrP,KAAKkB,UAAU9B,UAAUC,IAAI,0BAC7BW,KAAK4P,SAAS,8BAEd5P,KAAK8L,WAAW5K,UAAU9B,UAAUC,IAAI,gBAExCW,KAAKgxE,iBAAmBlyE,SAASC,cAAc,OAC/CiB,KAAKgxE,iBAAiB5xE,UAAUC,IAAI,qBAEpC,MAAM8vC,EAAUrwC,SAASC,cAAc,OACvCowC,EAAQ/vC,UAAUC,IAAI,YACtB,QAAM,CAAC+K,QAAS+kC,EAASt/B,IAAK,2BAE9B7P,KAAK0sF,iBAAkB,OAAO,kDAAmD,CAC/EjtF,KAAM,2BACNR,KAAM,QAGRe,KAAK2sF,eAAiB,IAAIvzE,GAAe,CACvC3V,KAAM,YAERzD,KAAK2sF,eAAezrF,UAAU+B,MAAMC,QAAU,OAE9ClD,KAAK4sF,iBAAmB,IAAIxzE,GAAe,CACzC3V,KAAM,sBAERzD,KAAK4sF,iBAAiB1rF,UAAU+B,MAAMC,QAAU,OAEhDlD,KAAK8L,WAAWpM,OAAOM,KAAKgxE,iBAAkB7hC,EAASnvC,KAAK0sF,gBAAiB1sF,KAAK2sF,eAAezrF,UAAWlB,KAAK4sF,iBAAiB1rF,YAElI,QAAiBlB,KAAK0sF,iBAAiB,IAAW,mCAChD,MAAMxF,QAAkBlnF,KAAK2S,SAAS2iE,WAAW6R,eAC9CgF,OAAOzuE,KAAK1d,KAAKgsF,iBAAiBrrF,SAAW,YAAoBumF,EAAU2F,6BAA+B3F,EAAU4F,8BACrHnhD,GAAM,yCAEN3rC,KAAKyO,OAAO+D,UAAU03E,IAAkB/6E,WAEzC,CAAClG,eAAgBjJ,KAAKiJ,iBAEzB,MAAM8jF,EAA2B,KAC/B/sF,KAAK2sF,eAAezrF,UAAU+B,MAAMC,QAAUipF,OAAOzuE,KAAK1d,KAAKgsF,iBAAiBrrF,OAAS,GAAK,QA+DhG,OA5DAX,KAAK2S,SAASo2E,eAAeC,mBAAmBtnF,MAAW2rE,GAAY,mCACrE,IAAI,MAAM1hD,KAAU0hD,QACZrtE,KAAKisF,aAAatgE,EAAQ3rB,KAAK2sF,eAAe59E,SAGtDg+E,SAGF/sF,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAuB2rB,GAAW,mCAChE3rB,KAAKgsF,gBAAgBrsE,eAAegM,EAAOnb,UACtCxQ,KAAKisF,aAAatgE,EAAQ,KAAM3rB,KAAKgsF,gBAAgBrgE,EAAOnb,WAE5DxQ,KAAKisF,aAAatgE,EAAQ3rB,KAAK2sF,eAAe59E,SAGtDg+E,IAEA/sF,KAAKgtF,2BAGPhtF,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAkB2rB,IAChD3rB,KAAKgsF,gBAAgBrsE,eAAegM,EAAOnb,MAM5CxQ,KAAKgtF,sBAELhtF,KAAKgsF,gBAAgBrgE,EAAOnb,IAAItP,UAAUZ,gBACnCN,KAAKgsF,gBAAgBrgE,EAAOnb,KAGrCu8E,OAGF/sF,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAiBitF,IAClDA,EAAM7/E,SAAQ,CAACm/E,EAAUluE,KACvB,MAAMnd,EAAYlB,KAAKgsF,gBAAgBO,GAAUrrF,UACjD45D,GAAuB55D,EAAWA,EAAU0C,cAAeya,EAAM,SAIrEre,KAAKmrF,qBAAuBtlD,GAAA,uBAAkC,CAC5D3kC,UAAWlB,KAAKgxE,iBAChB3vE,MAAM,EACNC,UAAU,EACVC,MAAO,GACPC,OAAQ,IACP,aAAaE,MAAM0pF,IACpBprF,KAAK4B,UAAYwpF,EAEVvlD,GAAA,oBAA+BulD,MAGxCprF,KAAKgtF,sBAKEhtF,KAAKmrF,wBAGdz5E,qBACE1R,KAAKmrF,qBAAqBzpF,MAAK,KAC7B1B,KAAK4B,UAAUN,UAAW,EAC1BtB,KAAK4B,UAAUS,UAIX2qF,sBACN,OAAOhtF,KAAK2S,SAASo2E,eAAemE,6BAA6BxrF,MAAWyrF,GAAqB,mCAC/FntF,KAAK4sF,iBAAiB1rF,UAAU+B,MAAMC,QAAUiqF,EAAiBxsF,OAAS,GAAK,OAC/EyQ,MAAMC,KAAKrR,KAAK4sF,iBAAiB79E,QAAQ+W,UAAUplB,MAAM,GAAG0M,SAASmE,GAAOA,EAAGjR,WAE/E,IAAI,MAAMqrB,KAAUwhE,EAAkB,CACpC,MAAM9oF,QAAYrE,KAAKisF,aAAatgE,GAC9B9sB,GAAS,OAAO,gCAAiC,CAACY,KAAM,QAC9D4E,EAAI3E,OAAOb,GACXmB,KAAK4sF,iBAAiB79E,QAAQrP,OAAO2E,IAErC,QAAiBxF,GAASwB,IAGxB,IAFA,EAAA4nB,EAAA,GAAY5nB,GAET8rF,OAAOzuE,KAAK1d,KAAKgsF,iBAAiBrrF,QAAU,GAE7C,YADAgrC,GAAM,yCAIR9sC,EAAOW,aAAa,WAAY,QAEhC,MAAMirB,EAAIkB,EAAOA,OACjBlB,EAAEo/D,eAAiB,GACnBp/D,EAAEq/D,eAAiB,GACnBr/D,EAAE+9D,cAAgB,GAElBxoF,KAAK2S,SAASo2E,eAAegC,mBAAmBtgE,GAAG,GAAM/oB,MAAM2oF,IAC1DA,GACDhmF,EAAI/D,YAEL4qB,SAAQ,KACTrsB,EAAO8F,gBAAgB,iBAExB,CAACsE,eAAgBjJ,KAAKiJ,wB,2SCrPlB,MAAMmkF,WAA4Bt9E,EACrCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,0BAA2B,eACxDW,KAAK4P,SAAS,+CAEd,MAAMy9E,EAAiBzuF,IAKrB,MAAMua,EAAU,IAAIC,GAAe,CACjC3V,KAAM7E,EAAQ6E,OAGV6pF,EAAa,IAAIjkD,GAAI,CACzBG,cAAe,IAAI,KAAc,CAAC/pC,KAAMb,EAAQ2uF,SAAUnkD,SAAS,IACnEM,gBAAiB,YAGb8jD,EAAoB,IAAInkD,GAAI,CAChCG,cAAe,IAAI,KAAc,CAAC/pC,KAAM,iBAAkB2pC,SAAS,IACnEM,gBAAiB,YAGnBvwB,EAAQpK,QAAQrP,OAAO4tF,EAAWpsF,UAAWssF,EAAkBtsF,WAE/DlB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/B,MAAMusF,EAAkB,CAAC7gF,EAAGhO,EAAQqxE,UAC9B9wB,EAAMn/C,KAAK2S,SAASyrC,wBAAwBsvC,kBAAkBD,IACnEtuC,aAAeh8C,QAAUg8C,EAAMh8C,QAAQ4B,QAAQo6C,IAAMz9C,MAAMisF,IAC1D,MAAMC,EAAgB,IAAW,mCAC/B,MAAMhtD,QAAc5gC,KAAK2S,SAASyrC,wBAAwBC,QAAQsvC,GAIlE,OAHAL,EAAW9jD,cAAcJ,SAAWxI,EACpC4sD,EAAkBhkD,cAAcJ,QAAUukD,EAAeE,cAElDjtD,KAGTgtD,IAEA5tF,KAAK+P,cAAc3P,iBAAiB,WAAW,IAAW,mCACxD,MAAM0tF,GAAQR,EAAW9jD,cAAcJ,QACjC2kD,EAAeP,EAAkBhkD,cAAcJ,QAErD,GAAG0kD,WAAgB9tF,KAAK2S,SAASyrC,wBAAwBC,QAAQsvC,KAAoBI,IAAiBJ,EAAeE,cACnH,OAGF,MAAMG,GAAqB,EAAAv2C,GAAA,GAAKk2C,GAChCK,EAAcphF,EAAI,0BAClBohF,EAAcC,WAAaH,EAAO,MAAa,EAC/CE,EAAcH,cAAgBE,EAE9B/tF,KAAK2S,SAASyrC,wBAAwB8vC,qBAAqBT,EAAiBO,OAC3E,CAACxmF,MAAM,IAEVxH,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,mBAAoBq4B,IACrD,MAAM43C,EAAW8F,GAAqB19C,EAAOkc,KAAK3nC,GAC/ChO,EAAQqxE,WAAaA,IACtB0d,EAAiBt1D,EAAOimB,gBACxBsvC,YAMRP,EAAc,CACZ5pF,KAAM,4BACN8pF,SAAU,+BACVtd,SAAU,qBAGZod,EAAc,CACZ5pF,KAAM,sBACN8pF,SAAU,yBACVtd,SAAU,qBAGZod,EAAc,CACZ5pF,KAAM,wBACN8pF,SAAU,2BACVtd,SAAU,0BAGZ,CACE,MAAM92D,EAAU,IAAIC,GAAe,CACjC3V,KAAM,uBAGF0qF,EAAoB,IAAI9kD,GAAI,CAChCG,cAAe,IAAI,KAAc,CAAC/pC,KAAM,gBAAiB2pC,SAAS,IAClEM,gBAAiB,YAGb0kD,EAAW,IAAI/kD,GAAI,CACvBG,cAAe,IAAI,KAAc,CAAC/pC,KAAM,sBAAuB2pC,SAAS,EAAM+B,SAAU,iCACxFzB,gBAAiB,YAGnB,gBAA2BhoC,MAAM0pC,IAC/BgjD,EAAS5kD,cAAcJ,QAAUgC,EAAMksC,SAASjwB,cAAcgnC,SAGhEl1E,EAAQpK,QAAQrP,OAAOyuF,EAAkBjtF,UAAWktF,EAASltF,WAE7DlB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAE/BlB,KAAK2S,SAASyrC,wBAAwBkwC,+BAA+B5sF,MAAMy8C,IACzEgwC,EAAkB3kD,cAAcJ,QAAU+U,EAE1Cn+C,KAAK+P,cAAc3P,iBAAiB,WAAW,KAC7C,MAAMs3E,EAAWyW,EAAkB3kD,cAAcJ,QAC9C+U,IAAYu5B,GACb13E,KAAK2S,SAASyrC,wBAAwBmwC,8BAA8B7W,KAErE,CAAClwE,MAAM,SC5HH,MAAMgnF,WAAuBhgF,EAC1Ba,O,qCACdrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAKkB,UAAU9B,UAAUC,IAAI,sBAC7BW,KAAK4P,SAAS,mCAEd,MAAMuJ,EAAU,IAAIC,GAAe,IAE7Bi2D,EAA8B,IAAIp+D,IAElCnH,EAAU9J,KAAK2S,SAAS2iE,WAAWmZ,mBAAmB,wBAAyB,CACnFC,UAAW,UACVhtF,MAAMitF,IACP,MAAM1pD,GAAS,UACf0pD,EAAUvhF,SAASwhF,IACjB,MAAMrpE,EAAM,IAAI8jB,GAAI,CAClBE,WAAY,IAAI0B,GAAW,CACzBxrC,KAAMmvF,EAASnrF,KACfA,KAAMwhC,EACNzkC,MAAOouF,EAASC,YAElBplD,SAAUmlD,EAASE,cAGrBzf,EAAUpyD,IAAI2xE,EAASC,UAAWtpE,MAGpC,MAAM4jB,EAAOkB,GAAkB,IAAIglC,EAAUp5B,WAAYz1C,IACvD,iBAAiBA,MAGnB,wBAAwBkB,MAAMg2D,IAC5B,MAAMnyC,EAAM8pD,EAAU79D,IAAIkmD,EAASm3B,WAC/BtpE,EAKJA,EAAIgkB,WAAW3oC,kBAAiB,GAJ9B8M,QAAQC,MAAM,SAAU4X,EAAKmyC,MAOjCv+C,EAAQpK,QAAQrP,OAAOypC,MAKzB,OAFAnpC,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAExB4I,G,gSC5CI,SAASilF,GAAkBnwF,GACxC,OAAO,IAAIuE,SAAwB,CAAC4B,EAASylB,KAC3C,MAAM,OAAC3rB,EAAM,SAAEq0C,GAAYt0C,EAC3BC,EAAOiG,SAAYmY,IACjBlY,EAAQkY,IAAQA,EAAIjc,UAAOgJ,IAG7B,MAAMmjC,GAAU,OAAgB,CAACtuC,IAC3BmwF,EAAe7hD,EAAQ/6B,MAAMvT,GAAWA,EAAOi0E,WACrDkc,EAAalqF,SAAW,KACtB0lB,KAGF5rB,EAAQuuC,QAAUA,EAClBvuC,EAAQkvC,WAAaoF,GAAY,CAACA,GAElC,IAAIhG,GAAU,qBAAsBtuC,GAASswC,UCpB1C,SAAS+/C,GAA4BhvF,EAAkC6O,GAC5E,MAAMqK,EAAU,IAAIC,GAAe,CAAC3V,KAAMqL,IAEpCe,EAAM,yBAA2B5P,EAAO,IACxCivF,EAAwB,IAAI,KAAc,CAC9CzvF,KAAM,uBACNgE,KAAM,WACN0nC,SAAUt7B,EAAM,WAChBm+B,YAAY,IAERmhD,EAAuB,IAAI,KAAc,CAC7C1vF,KAAM,2BACNgE,KAAM,UACN0nC,SAAUt7B,EAAM,UAChBm+B,YAAY,IAERohD,EAAsB,IAAI,KAAc,CAC5C3vF,KAAM,yBACNgE,KAAM,SACN0nC,SAAUt7B,EAAM,SAChBm+B,YAAY,IAERqhD,EAAwB,IAAI,KAAc,CAC9C5vF,KAAM,uBACNgE,KAAM,WACN0nC,SAAUt7B,EAAM,WAChBm+B,YAAY,IAUd,OAPA70B,EAAQpK,QAAQrP,OACdwvF,EAAsB31E,MACtB41E,EAAqB51E,MACrB61E,EAAoB71E,MACpB81E,EAAsB91E,OAGjBJ,EAGM,MAAMm2E,WAAgCx/E,EACzCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAK4P,SAAS,sBAEd,MAAMuJ,EAAU81E,GAA4B,QAAS,2BACrDjvF,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YC1CpB,MAAMquF,WAA+Bz/E,EACxCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAK4P,SAAS,qBAEd,MAAM4/E,GAAgB,EAAApjD,GAAA,IAAUqjD,IAC9BzvF,KAAK2S,SAASutE,gBAAgBwP,SAAS,yCAA0CD,KAChF,KAAK,GAAO,GAETt2E,EAAU81E,GAA4B,OAAQ,0BAE9CU,EAAM,OAGNC,EAAYC,SAEZJ,EAAU,2CACVjvF,EAAQmC,KAAKmE,KAAKnE,KAAKmE,MAAM2oF,EAAUE,GAAOC,IAC9CE,EAAO,IAAI,iBAAiB,CAChCjgF,IAAK,4BACLT,KAAM,CAACukB,GAAY87D,MAEfnK,EAAQ,IAAIL,GAAqB,0BAA2B,IAAMzkF,EAAO,EAAG,GAAG,GACrF8kF,EAAMp5E,SAAY1L,IAChB,MAAMivF,EAAW,SAAAjvF,EAAS,GAAIovF,EAAYD,EAAO,EAEjDG,EAAKC,iBAAiB,CAAC3gF,KAAM,CAACukB,GAAY87D,MAE1CD,EAAcC,IAGhBnK,EAAMD,eAAe3lF,OAAOowF,EAAK1lF,SAEjC+O,EAAQpK,QAAQrP,OAAO4lF,EAAMpkF,WAE7BlB,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YCxCpB,MAAM8uF,WAAgClgF,EACzCT,OACRrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAK4P,SAAS,sBAEd,MAAMuJ,EAAU81E,GAA4B,QAAS,2BACrDjvF,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,YCWnC,MAAM+uF,GAAmF,CACvF57C,SAAU,uBACV67C,QAAS,iBACTzG,OAAQ,qBACR4C,SAAU,wBAGG,MAAM8D,WAA6BrgF,EAChCT,O,qCACdrP,KAAK4O,OAAOxP,UAAUC,IAAI,eAC1BW,KAAK4P,SAAS,gBAEd,CACE,MAAMuJ,EAAU,IAAIC,GAAe,CAAC3V,KAAM,yBAA0B0rC,QAAS,0BAEvE/D,QAAc,gBAEdglD,EAAoB,IAAI,KAAc,CAC1C3wF,KAAM,oBACNgE,KAAM,OACN2lC,SAAUgC,EAAMksC,SAAS+Y,gBAAgB73E,OAAOjZ,SAChDyuC,YAAY,IAGR9hC,EAAW,MACf,EAAA6iC,GAAA,GAAiB,CAACq0C,IAChB,EAAAvsC,GAAA,GAAUzL,EAAMksC,SAAS93C,aAAc,8BACvC,EAAAqX,GAAA,GAAUzL,EAAMksC,SAAS+Y,gBAAiB,iCAGxCC,EAAe,KACnBtwF,KAAKuwF,wBAAwBC,EAAUplD,EAAMksC,SAAS93C,aAAa3f,OACnE7f,KAAKuwF,wBAAwBE,EAAUrlD,EAAMksC,SAAS93C,aAAa9O,OACnE1wB,KAAKuwF,wBAAwBG,EAAStlD,EAAMksC,SAAS93C,aAAa6hD,KAAMj2C,EAAMksC,SAAS+Y,gBAAgBM,gBAGnGC,EAAW3+E,IACf,MAAMnB,EAAM,IAAImB,EAAejS,KAAKyO,QAAQ,GAC5CqC,EAAI3B,OAEJnP,KAAKiJ,eAAe5J,IAAIyR,EAAIf,cAA5B/P,CAA2C,WAAW,KACpDswF,IACApkF,MACC,CAAC1E,MAAM,KAGNgpF,EAAW,IAAInnD,GAAI,CACvBW,aAAc,qBACdP,SAAU,GACV/+B,UAAW,KACTkmF,EAAQtB,OAINmB,EAAW,IAAIpnD,GAAI,CACvBW,aAAc,qBACdP,SAAU,GACV/+B,UAAW,KACTkmF,EAAQZ,OAINU,EAAU,IAAIrnD,GAAI,CACtBW,aAAc,oBACdP,SAAU,GACV/+B,UAAW,KACTkmF,EAAQrB,OAINnM,GAAc,OAAO,sCAAuC,CAACnkF,KAAM,SAAUQ,KAAM,iCACzF,QAAiB2jF,GAAa,KAC5B2L,GAAkB,CAChB/kD,aAAc,wCACd0D,mBAAoB,mCACpB7uC,OAAQ,CACN0sC,QAAS,WAEV7pC,MAAK,KACN,MAAM41E,EAAW,aACjBA,EAAS+Y,iBAAkB,EAAA54C,GAAA,GAAK,+BAChC6/B,EAAS93C,cAAe,EAAAiY,GAAA,GAAK,4BAC7Bz3C,KAAK2S,SAASutE,gBAAgBwP,SAAS,WAAYpY,GAEnDgZ,IACAF,EAAkBhnD,SAAWgC,EAAMksC,SAAS+Y,gBAAgB73E,OAAOjZ,eAIvE,MAAMsxF,EAAmB,KACvB,MAAMtxF,GAAY6wF,EAAkBhnD,QAE9BkuC,EAAW,aACd/3E,EACD+3E,EAAS+Y,gBAAgB73E,OAAOjZ,UAAW,SAEpC+3E,EAAS+Y,gBAAgB73E,OAAOjZ,SAGzC,CAACixF,EAAUC,EAAUC,GAAStjF,SAASmY,IACrCA,EAAIrkB,UAAU9B,UAAUoE,OAAO,cAAejE,MAGhDS,KAAK2S,SAASutE,gBAAgBwP,SAAS,WAAYpY,GAEnDprE,KAGFkkF,EAAkBrwF,MAAMK,iBAAiB,SAAUywF,GACnDA,IACAP,IAEAn3E,EAAQpK,QAAQrP,OACd0wF,EAAkB72E,MAClBi3E,EAAStvF,UACTuvF,EAASvvF,UACTwvF,EAAQxvF,UACRkiF,GAGFpjF,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAGjC,CACE,MAAMiY,EAAU,IAAIC,GAAe,CAAC3V,KAAM,kBAEpCqtF,EAAoB,IAAI,KAAc,CAC1CrxF,KAAM,cACNgE,KAAM,OACN0nC,SAAU,yBACV6C,YAAY,IAER+iD,EAAsB,IAAI,KAAc,CAC5CtxF,KAAM,gBACNgE,KAAM,SACN0nC,SAAU,2BACV6C,YAAY,IAGd70B,EAAQpK,QAAQrP,OAAOoxF,EAAkBv3E,MAAOw3E,EAAoBx3E,OAEpEvZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,a,+RAI3BqvF,wBAAwBhrE,EAAU+xD,EAAwCmY,GAChF,IAAI5/E,EAAkBT,EAA2B,GAEjD,MAAM4hF,EAAW7E,OAAOzuE,KAAK45D,GACvB2Z,EAAcD,EAASr2E,KAAK9K,GAAQynE,EAASznE,GAAOogF,GAAuBpgF,QAAO7F,IAAW2hB,OAAO6kB,SAC1G,GAAIygD,EAAYtwF,QAAsB,IAAZ8uF,EAEnB,CACL,MAAMyB,EAAQD,EAAYtwF,SAAWqwF,EAASrwF,OAQ9C,QAPeqJ,IAAZylF,GACD5/E,EAAMqhF,EAAQ,6BAA+B,wBAC7C9hF,EAAKyC,KAAK8hB,GAAY87D,KAEtB5/E,EAAMqhF,EAAQ,yBAA2B,qBAGvCA,EAAO,CACT,MAAMh8E,EAAWpW,SAASC,cAAc,QACxCmW,EAASxV,WAAU,QAAKuxF,EAAYt2E,KAAK9K,IAAQ,QAAKA,MAAO,GAAM,IACnET,EAAKyC,KAAKqD,SAbZrF,EAAM,mBAiBR,EAAAjC,EAAA,GAAe2X,EAAIkkB,UAAU,QAAK55B,EAAKT,K,2SCnK5B,MAAM+hE,WAAuB3iE,EAA5C,c,oBACU,KAAA2+B,QAOJ,GASY99B,O,0CACdrP,KAAKkB,UAAU9B,UAAUC,IAAI,sBAC7BW,KAAK4P,SAAS,YAEd,MAAM0+D,EAAU,GAAiB,GAAI,cAAe,CAAC,CACnDrvE,KAAM,SACNQ,KAAM,qBACNuoB,QAAS,KACP,IAAIklB,GAAU,SAAU,CACtBlD,aAAc,SACd0D,mBAAoB,qBACpBP,QAAS,CAAC,CACR5B,QAAS,SACTzmC,SAAU,KACR9E,KAAK2S,SAAS2iE,WAAW6b,UAE3Bp3C,UAAU,MAEX7K,WAIPlvC,KAAKmtC,QAAQikD,KAAO,EAAW,QAE/BpxF,KAAK4O,OAAOlP,OAAOM,KAAKmtC,QAAQikD,KAAM9iB,GAEtCtuE,KAAK2pD,QAAU,IAAI3C,GAAYhnD,KAAK2S,SAAU3S,KAAK8L,WAAY9L,KAAKiJ,gBAAgB,GACpFjJ,KAAK2pD,QAAQt6C,OACbrP,KAAK2pD,QAAQ7D,QAAQ,UACrB,MAAMiU,EAAc/5D,KAAK2pD,QAAQtB,sBAE3BgpC,GAAkB,OAAO,wDAAyD,CAACpyF,KAAM,cAC/FoyF,EAAgBjxF,iBAAiB,SAAS,KACxC,MAAM4C,EAASlE,SAASC,cAAc,UACtC,gBAAyB,KAAaoQ,KAAKnM,GAASsuF,IAClDA,IAAS5vF,MAAM4Y,GACNta,KAAK2S,SAASq8B,kBAAkB64C,mBAAmBvtE,WAIhEta,KAAK2pD,QAAQv/C,QAAQ3F,iBAAiBskB,kBAAkBrpB,OAAO2xF,GAE/D,MAAME,EAAwB,IAAW,mC,MACvC,MAAMh5E,QAAavY,KAAK2S,SAAS2I,gBAAgBk1D,UACjD6gB,EAAgBjyF,UAAUoE,OAAO,OAA0B,sBAAR,QAAV,EAAA+U,EAAKsH,aAAK,eAAEjT,OAGvD2kF,IACAvxF,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAkBuM,IAChD,WAAmBA,GACpBglF,OA8CJ,MAAMC,EAAa1yF,SAASC,cAAc,OAC1CyyF,EAAWpyF,UAAUC,IAAI,mBAEzB,MAQMirC,EAR0D,CAC9D,CAAC,SAAU,gCAAiC8iD,IAC5C,CAAC,OAAQ,eAAgB+C,IACzB,CAAC,OAAQ,qCAAsCla,IAC/C,CAAC,WAAY,yCAA0CsP,IACvD,CAAC,SAAU,0BAA2BwG,KAGzBpxE,KAAI,EAAE1b,EAAM4sC,EAAa55B,KAC/B,IAAIo3B,GAAI,CACbW,aAAc6B,EACd5sC,KAAAA,EACAyL,UAAW,KACT1K,KAAKyO,OAAO+D,UAAUP,GAAgB9C,YAM5Cm7B,EAAKz4B,KACH7R,KAAKyxF,WAAa,IAAIpoD,GAAI,CACxBW,aAAc,UACdC,oBAAqB,IACrBhrC,KAAM,iBACNyL,UAAW,IAAW,mCAChB1K,KAAKm1E,uBACDn1E,KAAKy2E,wBAGb,MAAM3lE,EAAM9Q,KAAKyO,OAAO+D,UAAUgiE,IAClC1jE,EAAIqkE,eAAiBn1E,KAAKm1E,eAC1BrkE,EAAIf,cAAc3P,iBAAiB,WAAW,KAC5CJ,KAAKm1E,oBAAiBnrE,EACtBhK,KAAKy2E,sBAAqB,KACzB,CAACjvE,MAAM,IACVsJ,EAAI3B,YAIRnP,KAAK0xF,YAAc,IAAIroD,GAAI,CACzBW,aAAc,2BACdC,qBAAqB,QAAK,gBAC1BhrC,KAAM,WACNyL,UAAW,KACT1K,KAAKyO,OAAO+D,UAAUg8E,IAAgBr/E,WAK5CqiF,EAAW9xF,UAAU4qC,EAAK3vB,KAAK4K,GAAQA,EAAIrkB,aAK3C,MAAMywF,EAAiB,IAAIv4E,GAC3Bu4E,EAAe5iF,QAAQrP,OAAO8xF,GAE9BxxF,KAAK8L,WAAWpM,OAAOM,KAAK2pD,QAAQv/C,QAAuCunF,EAAezwF,WAE1FlB,KAAKmtC,QAAQikD,KAAKhxF,iBAAiB,SAAS,KAC9BJ,KAAKyO,OAAO+D,UAAUy0E,IAC9B93E,UAGN02B,GAAA,sBAEA7lC,KAAKy2E,6BAEC1c,KAGA63B,kBAAkBC,GACxB,GAAG7xF,KAAK8xF,2BAA6BD,EAAW,OAAO7xF,KAAK8xF,yBAE5D,MAAMhoF,EAAU9J,KAAK8xF,yBAA2B9xF,KAAK2S,SAAS2iE,WAAWC,UAAU,6BAClFrqD,SAAQ,KACJlrB,KAAK8xF,2BAA6BhoF,IACnC9J,KAAK8xF,8BAA2B9nF,MAIpC,OAAOF,EAGF2sE,qBAAqBob,GAC1B,OAAO7xF,KAAK4xF,kBAAkBC,GAAWnwF,MAAMo2E,IAC7C93E,KAAKm1E,eAAiB2C,EAAM3C,eAC5Bn1E,KAAKyxF,WAAW3nD,WAAWnX,YAAc,GAAK3yB,KAAKm1E,eAAex0E,WC1NzD,MAAMoxF,WAAyBvjF,EAA9C,c,oBACU,KAAAuK,aAAyC,KAOvC1J,OACRrP,KAAKkB,UAAU9B,UAAUC,IAAI,yBAC7BW,KAAK4P,SAAS,cAEd5P,KAAKiZ,WAAa,IAAIrG,GAAYsG,IAChClZ,KAAK+Y,aAAeG,KAGtB,MAAMC,EAAU,IAAIC,GAAe,CACjC+1B,QAAS,wCAGL91B,EAAeva,SAASC,cAAc,OAC5Csa,EAAaja,UAAUC,IAAI,iBAE3BW,KAAKgyF,sBAAwB,IAAI,IAAW,CAC1Cz4E,MAAO,mBACPC,UAAW,MAGbxZ,KAAKiyF,6BAA+B,IAAI,IAAW,CACjD14E,MAAO,iCACPC,UAAW,MAGbH,EAAa3Z,OAAOM,KAAKgyF,sBAAsB9wF,UAAWlB,KAAKiyF,6BAA6B/wF,WAE5F,MAAMgxF,EAAiB,KACrBlyF,KAAK8Z,QAAQ1a,UAAUoE,OAAO,eAAgBxD,KAAKgyF,sBAAsBxxF,MAAMG,SAC5EX,KAAKgyF,sBAAsBjyF,MAAMX,UAAUiG,SAAS,WACpDrF,KAAKiyF,6BAA6BlyF,MAAMX,UAAUiG,SAAS,WAGhErF,KAAKgyF,sBAAsBjyF,MAAMK,iBAAiB,QAAS8xF,GAC3DlyF,KAAKiyF,6BAA6BlyF,MAAMK,iBAAiB,QAAS8xF,GAElElyF,KAAK8Z,QAAU,EAAa,CAAC7a,KAAM,eAEnCe,KAAK8Z,QAAQ1Z,iBAAiB,SAAS,KACrC,MAAM0O,EAAQ9O,KAAKgyF,sBAAsBxxF,MACnCyZ,EAAQja,KAAKiyF,6BAA6BzxF,MAEhDR,KAAK8Z,QAAQva,UAAW,EACxBS,KAAK2S,SAASoH,gBAAgBC,cAAc,CAC1ClL,MAAAA,EACAmL,MAAAA,EACA82B,WAAW,IACVrvC,MAAM8tC,IACJxvC,KAAK+Y,cACN/Y,KAAK+Y,eAAerX,MAAM4Y,IACxBta,KAAK2S,SAASoH,gBAAgBQ,UAAUi1B,EAAWl1B,MAIvD,gBAA0B,CAAC/N,OAAQijC,EAAU30B,UAAS,KAEtD,wBAAoC7a,MACpCA,KAAKyO,OAAO+D,UAAUssC,IAAkB3vC,KAAK,CAC3ClP,KAAM,UACN++C,WAAW,EACXlwC,MAAO,kBACPf,YAAa,gBACb6oC,QAAUp8B,GACDxa,KAAK2S,SAASoH,gBAAgBU,gBAAgB+0B,EAAWh1B,WAMxExa,KAAK+O,QAAQrP,OAAOM,KAAK8Z,SACzBX,EAAQpK,QAAQrP,OAAOM,KAAKiZ,WAAW/X,UAAWmY,GAClDrZ,KAAK8L,WAAWpM,OAAOyZ,EAAQjY,WAG1BsO,sBAML,OALAxP,KAAKiZ,WAAWlO,QAChB/K,KAAK+Y,aAAe,KACpB/Y,KAAKgyF,sBAAsBxxF,MAAQ,GACnCR,KAAKiyF,6BAA6BzxF,MAAQ,GAC1CR,KAAK8Z,QAAQva,UAAW,EACjBM,MAAM2P,uB,cCzFF,MAAM2iF,WAA2B,IAC9CvyF,cACEC,MAAM,wDAAyD,KAAM,CAACu2C,UAAU,EAAMg8C,YAAa,QACnGpyF,KAAKyoB,YAGOA,Y,sCACZ,QAAMzoB,KAAK8O,MAAO,oBAElB,QAAiB9O,KAAKqyF,YAAY,KAChC,MAAMvoF,EAAU9J,KAAK2S,SAAS2I,gBAAgBg3E,cAAc10C,EAAep9C,MAAOq9C,EAAmBr9C,MAAO+xF,EAAc/xF,OAE1HsJ,EAAQpI,MAAK,KACX1B,KAAKs2C,UACH7oC,IACc,YAAbA,EAAIxN,OACL2rC,GAAS,CAACC,YAAa,sCACvBmQ,EAASz8C,UAAW,MAIxBy8C,EAASjT,gBAAgBj/B,KACxB,CAACb,eAAgBjJ,KAAKiJ,iBAEzB,MAAMq/B,EAA4B,GAC5BjkC,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,eAClB,MAAMu+C,EAAiB,IAAI,IAAW,CACpCrkC,MAAO,YACP9V,KAAM,sBACN+V,UAAW,GACXgvB,UAAU,IAENqV,EAAqB,IAAI,IAAW,CACxCtkC,MAAO,WACP9V,KAAM,0BACN+V,UAAW,KAEP+4E,EAAgB,IAAI,KAAc,CAAC/pD,UAAU,IACnDF,EAAYz2B,KAAK+rC,EAAgBC,EAAoB00C,GAErD,MAAMrkF,EAAU,KACd,MAAMzK,EAAOm6C,EAAep9C,MAAQ,IAAMq9C,EAAmBr9C,MAE7Dw7C,EAASpT,WAAWxQ,UAAY30B,EAChCu4C,EAASpT,WAAWvQ,UAGtBr4B,KAAKiJ,eAAe5J,IAAIu+C,EAAe79C,MAAvCC,CAA8C,QAASkO,GACvDlO,KAAKiJ,eAAe5J,IAAIw+C,EAAmB99C,MAA3CC,CAAkD,QAASkO,GAE3DqkF,EAAcC,SAAW,MACdD,EAAc/xF,MAAMo4D,MAAM,MAGrC,MAAMrgD,QAAavY,KAAK2S,SAAS2I,gBAAgBk1D,UAC3ChzB,GAAY,EAAAD,GAAA,GAAkBhlC,EAAK+kC,OACtCE,EAAU/b,OACX8wD,EAAc/xF,MAAQ,IAAMg9C,EAAU/b,KAAKgxD,cAG7C,MAAMz2C,EAAW,IAAIhU,GAAS,CAC5BM,YAAAA,EACAr/B,eAAgBjJ,KAAKiJ,eACrB6/B,iBAAiB,EACjBhvB,QAAS9Z,KAAKqyF,WACd9kF,WAAY,MAGdlJ,EAAI3E,OAAOk+C,EAAe18C,UAAW28C,EAAmB38C,UAAW86C,EAASpT,YAC5E5oC,KAAKkB,UAAUxB,OAAO2E,EAAKkuF,EAAcrxF,WAEzClB,KAAKkvC,Q,gSChEM,MAAMwjD,WAAuBlkF,EAKhCa,OACRrP,KAAKkB,UAAUsP,GAAK,qBAIpB,MAAMmlE,EAAS,EAAa,CAAC12E,KAAM,MAAON,UAAW,eACrDqB,KAAK+O,QAAQrP,OAAOi2E,IAEpB,QAAiBA,GAAQ,KACvB,gBAAyBwc,MACxB,CAAClpF,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAK2yF,YAAc,IAAI7kF,EAAY,UAAWtN,IAC5CR,KAAK4yF,aAAapyF,MAGpBR,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,mBAAyBkb,IAAW,O,EAAA,K,OAAA,E,EAAA,YACrE,MAAMyiC,QAAkB39C,KAAK2S,SAAS2I,gBAAgBqiC,UAAUziC,GAC1D3O,EAAS2O,EAAOL,WACnB8iC,EAAW39C,KAAK6yF,eAAexzF,IAAIkN,GACjCvM,KAAK6yF,eAAenjF,OAAOnD,I,YAJqC,K,iRAOvEvM,KAAK8O,MAAM2vB,YAAYz+B,KAAK2yF,YAAYzxF,WAExClB,KAAK0uB,YAAa,UAMVokE,aACR,MAAMD,EAAiB,IAAIx2B,GAAe,CACxC1pD,SAAU3S,KAAK2S,WAEX9H,EAAOgoF,EAAehoF,KAM5B,OALAA,EAAK2F,GAAK,WACV3F,EAAKzL,UAAUC,IAAI,sBACnB,wBAAuCwL,GAAM,KAC3C7K,KAAKiP,eACJjF,GAAW,GACP6oF,EAGCtgF,UACRvS,KAAK0uB,WAAW4sC,QAMR5pD,sBACL,GAAAqhF,WAAc3hB,IAAS,IAC1BpxE,KAAK2yF,YAAY5yF,MAAM0M,QAGlBmmF,aAAajnF,GACf3L,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGdrP,KAAK0uB,WAAW4sC,QAChB,MAAM5sC,EAAa1uB,KAAK0uB,WAAWld,MACnCxR,KAAK8L,WAAWO,iBAAmB,KACnCrM,KAAK8L,WAAW5K,UAAUyxB,YAAc,GAExC3yB,KAAK2S,SAAS2I,gBAAgBq5B,mBAAmBhpC,OAAO3B,EAAW,UAAUtI,MAAM2yC,IACjF,IAAI3lB,IACF,OAGF,MAAMmkE,EAAiB7yF,KAAK6yF,eAAiB7yF,KAAK8yF,aAElD,IAAIE,EAAa,KACf,MAAMl/C,EAAY,UAAoB,GAAK,KAAO,EACtCO,EAAS91B,OAAO,EAAGu1B,GAE3B1mC,SAASb,IACXsmF,EAAexzF,IAAIkN,MAGjB8nC,EAAS1zC,SACXqyF,OAAahpF,EACbhK,KAAK8L,WAAWO,iBAAmB,OAIvC2mF,IACAhzF,KAAK8L,WAAWO,iBAAmB,KAC9B2mF,EACDA,IAEAhzF,KAAK8L,WAAWO,iBAAmB,OAIvC,EAAAuB,EAAA,GAAe5N,KAAK8L,WAAW5K,UAAW2xF,EAAehoF,SAItDsE,OAEL,OADAnP,KAAK4yF,eACE/yF,MAAMsP,QCxHF,MAAM8jF,WAAuBzkF,EAIhCa,OAMR,GALArP,KAAKkzF,YAAc,YAEnBlzF,KAAKkB,UAAUsP,GAAK,2BACpBxQ,KAAK4P,SAAS,kBAEV,eAA8BqjF,GAAe1G,UAAW,CAC1D,MAAM4G,EAAW,oBACjB,sBAAqCA,EAAU,CAAC3iF,GAAIyiF,GAAe1G,SAAUE,WAAY,IAA6BvrF,UAAUxB,OAAOyzF,GACvI,wBAAuCA,EAAU,MAAM,GAIzD,MAAMrnF,EAAa,eAA8BmnF,GAAe1G,UAIhE,OAHAvsF,KAAK8L,WAAW5K,UAAUu9B,YAAY3yB,EAAW5K,WACjDlB,KAAK8L,WAAaA,EAEX,2BAA0CmnF,GAAe1G,UAAU7qF,MAAK,EAAEuqB,OAAAA,EAAQqE,cAAAA,MACvF,GAAGrE,EACD,OAAOqE,KAMb5e,qBACE,eAA8B1R,KAAKkzF,aAAanoF,QAGlDwH,UACE,2BAA0CvS,KAAKkzF,aAGjD1jF,sBAEE,OADA,eAA8ByjF,GAAe1G,UAAUxhF,QAChDlL,MAAM2P,uBAtCA,GAAA+8E,SAA4B,ECW9B,MAAM6G,WAA2B5kF,EAAhD,c,oBAEU,KAAA6kF,mBAA6B,EA6I7BC,cAAcn8E,GACpB,MAAuC,UAApC,0BACEA,EAAW,SACL,QAAK,YAAa,CAACxU,KAAKE,MAAMsU,EAAW,SAEzC,QAAK,YAAa,CAACxU,KAAKE,MAAiB,MAAXsU,KAGpCA,GAAY,KACN,QAAK,eAAgB,CAACA,EAAW,OAEjC,QAAK,cAAe,CAACA,IAK3BhI,OACL,MAAMG,EAASzP,MAAMsP,OA4CrB,OA3CAG,EAAO5N,MAAK,KACV1B,KAAKuzF,SAASn0F,UAAUkB,OAAO,cAC/Bkb,UAAUC,YAAYC,oBAAoBC,IACxC3b,KAAKwzF,oBAAsB,CACzB13E,SAAUH,EAASE,OAAOC,SAC1BE,UAAWL,EAASE,OAAOG,UAC3By3E,SAAU93E,EAASE,OAAO43E,UAG5B/lF,QAAQomB,IAAI9zB,KAAKwzF,qBAEjBxzF,KAAK2S,SAAS2I,gBAAgBo4E,WAC5B/3E,EAASE,OAAOC,SAChBH,EAASE,OAAOG,UAChBL,EAASE,OAAO43E,UAChB/xF,MAAMya,IACN,MACMowD,EADUpwD,EAA6Bw3E,QAAQ,GAChCpnB,MACfqnB,EAAernB,EAAMjxB,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAEzvB,SAAW4zC,EAAE5zC,WACnD08E,EAAgBtnB,EAAM5gD,QAAQtrB,GAAkB,eAAZA,EAAEk0C,KAAK3nC,IAAoBjM,OAC/DmzF,EAAevnB,EAAM5gD,QAAQtrB,GAAkB,eAAZA,EAAEk0C,KAAK3nC,IAAoBjM,OACpEizF,MAAAA,GAAAA,EAAcxmF,SAASmnC,IACrB,MAAMhoC,GAAS,EAAAusC,GAAA,GAAUvE,EAAKA,MACxBp7B,EAAU5M,EAAO46B,SAAWnnC,KAAK+zF,cAAgB/zF,KAAK8a,aAC5D9a,KAAKg0F,aAAa/2E,IAAI1Q,EAAQgoC,GAC9Bp7B,EAAQ86E,WAAW50F,IAAIkN,MAGzBvM,KAAKk0F,cAAc90F,UAAUoE,OAAO,UAAWswF,IAAgBD,IAC/D7zF,KAAKk0F,cAAc5vF,UAAY,gDAE/BqJ,IACF3N,KAAKk0F,cAAc90F,UAAUkB,OAAO,QACpCN,KAAKuzF,SAASn0F,UAAUC,IAAI,cAC5BW,KAAKuzF,SAASnzF,iBAAiB,QAASJ,KAAKmP,MAC1CxB,aAAiB2O,yBAClBtc,KAAKk0F,cAAc5vF,UAAY,oDAE/BtE,KAAKk0F,cAAc5vF,UAAY,6EAK9BgL,EAGD6kF,gBACFn0F,KAAKwzF,sBAAuBxzF,KAAKqzF,oBACrCrzF,KAAKqzF,mBAAoB,EAEzB1nD,GAAM,qFAEN3rC,KAAK2S,SAAS2I,gBAAgBo4E,WAC5B1zF,KAAKwzF,oBAAoB13E,SACzB9b,KAAKwzF,oBAAoBx3E,UACzBhc,KAAKwzF,oBAAoBC,UACzB,EACA,YAGFj4E,UAAUC,YAAY24E,eAAe9kF,IACnC,MAAM+kF,EAAuB/kF,EAAOuM,OAAOG,YAAchc,KAAKwzF,oBAAoBx3E,UAC5Es4E,EAAsBhlF,EAAOuM,OAAOC,WAAa9b,KAAKwzF,oBAAoB13E,SAC1Ey4E,EAAgBv0F,KAAKw0F,kBACzBllF,EAAOuM,OAAOC,SAAUxM,EAAOuM,OAAOG,UACtChc,KAAKwzF,oBAAoB13E,SAAU9b,KAAKwzF,oBAAoBx3E,WAC1D,KAEAs4E,GAAuBD,IAAyBE,IAClDv0F,KAAK2S,SAAS2I,gBAAgBo4E,WAC5BpkF,EAAOuM,OAAOC,SACdxM,EAAOuM,OAAOG,UACd1M,EAAOuM,OAAO43E,UACd,EACA,YAEFzzF,KAAKwzF,oBAAsB,CACzB13E,SAAUxM,EAAOuM,OAAOC,SACxBE,UAAW1M,EAAOuM,OAAOG,UACzBy3E,SAAUnkF,EAAOuM,OAAO43E,eAMxBgB,eACFz0F,KAAKqzF,oBACTrzF,KAAKqzF,mBAAoB,EACzB1nD,GAAM,gGACN3rC,KAAK2S,SAAS2I,gBAAgBo4E,WAC5B,EACA,EACA,GACA,EACA,IAIIc,kBAAkBE,EAAcC,EAAeC,EAAcC,GACnE,MAAMjnD,EAAI,oBACV,OACE,MAAQjrC,KAAKmyF,KACXnyF,KAAKmE,KACF,GAAMnE,KAAK64E,KAAKoZ,EAAOF,GAAQ9mD,GAE9BjrC,KAAK64E,IAAIkZ,EAAO9mD,GAAKjrC,KAAK64E,IAAIoZ,EAAOhnD,IAClC,EAAIjrC,KAAK64E,KAAKqZ,EAAQF,GAAS/mD,GAAG,M,0BClSlC,SAASmnD,GAAaxoE,EAAeqH,EAAW,GAC7D,GAAa,IAAVrH,EAAa,MAAO,IAEvB,MACMsH,EAAKD,EAAW,EAAI,EAAIA,EAGxB7nB,EAAIpJ,KAAK6uB,MAAM7uB,KAAKmxB,IAAIvH,GAAS5pB,KAAKmxB,IAJlC,MAMV,OAAOC,YAAYxH,EAAQ5pB,KAAKqxB,IANtB,IAM6BjoB,IAAIkoB,QAAQJ,IAJrC,CAAC,GAAI,IAAK,IAAK,IAAK,KAI8B9nB,G,2SC4C3D,MAAMipF,GAA+B,uBA4mBtCr2F,GAAY,uBACX,MAAMya,GASXxZ,YAAYhB,EAAiC,IAC3C,MAAMsC,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DmC,EAAU9B,UAAUC,IAAIV,GAAY,cAEpC,MAAM8zC,EAAiBzyC,KAAKyyC,eAAiB3zC,SAASC,cAAc,OAOpE,GANA0zC,EAAerzC,UAAUC,IAAIV,IAE1BC,EAAQo0C,UACTP,EAAerzC,UAAUC,IAAI,aAG5BT,EAAQq2F,sBACTxiD,EAAe/yC,OAAO0zC,MACtBX,EAAerzC,UAAUC,IAAI,4BACxB,GAAIT,EAAQwwC,YAIjBqD,EAAerzC,UAAUC,IAAI,oBAJC,CAC9B,MAAMwuD,EAAK/uD,SAASC,cAAc,MAClC0zC,EAAe/yC,OAAOmuD,GAaxB,MAAM9+C,EAAU/O,KAAK+O,QAAU/O,KAAKw4C,yBAEpC,GAAG55C,EAAQ6E,KAAM,CACf,MAAMqL,EAAQ9O,KAAK8O,MAAQhQ,SAASC,cAAc,OAClD+P,EAAM1P,UAAUC,IAAI,kBAAmBV,GAAY,UACnD,QAAM,CAACyL,QAAS0E,EAAOe,IAAKjR,EAAQ6E,KAAM2L,KAAMxQ,EAAQmc,WACxDhM,EAAQrP,OAAOoP,GAKjB,GAFA5N,EAAUxB,OAAO+yC,GAEd7zC,EAAQuwC,QAAS,CAClB,MAAMA,EAAUnvC,KAAKmvC,QAAUnvC,KAAKw4C,yBACpCrJ,EAAQ/vC,UAAUC,IAAIV,GAAY,YAClCuC,EAAUxB,OAAOyvC,IAEM,IAApBvwC,EAAQuwC,UACT,QAAM,CAAC/kC,QAAS+kC,EAASt/B,IAAKjR,EAAQuwC,WAKrCqJ,yBACL,MAAMzpC,EAAUjQ,SAASC,cAAc,OAQvC,OAPAgQ,EAAQ3P,UAAUC,IAAIV,GAAY,YAMlCqB,KAAKyyC,eAAe/yC,OAAOqP,GACpBA,GAIJ,MAAMygE,GAAkB,CAACn8B,EAAsB5vC,EAAoB0rC,KACxE,MAAMh2B,EAAU,IAAIC,GAAe,CAAC3V,KAAAA,EAAM0rC,QAAAA,IAE1C,OADAkE,EAAS3zC,OAAOyZ,EAAQjY,WACjBiY,EAAQpK,SAGJqkC,GAAoB,KAC/B,MAAM8hD,EAAYp2F,SAASC,cAAc,OAEzC,OADAm2F,EAAU91F,UAAUC,IAAI,sBACjB61F,GAsBHC,GAAiB,IAntBhB,cAA6BjlF,EAkBlCtQ,cACEC,MAAM,CACJsR,UAAWrS,SAASstD,eAAe,eACnC77C,eAAgB,SATZ,KAAAnF,aAAuG,GAa/Gqd,UAAU9V,GACR3S,KAAK2S,SAAWA,EAGhB3S,KAAK2yF,YAAc,IAAI7kF,EAAY,UACnC,MAAMsnF,EAAgBp1F,KAAKmR,UAAUjM,cAAc,8BACnDkwF,EAAc11F,OAAOM,KAAK2yF,YAAYzxF,WAEtC,MAYMm0F,EAAkB,KACtBr1F,KAAKwS,UAAUkgF,IAAgBvjF,QAIjCnP,KAAKs1F,QAAUt1F,KAAKmR,UAAUjM,cAAc,wBAE5C,MAAMqwF,EAAoC,CACxCt2F,KAAM,UACNQ,KAAM,gBACNuoB,QAAS,KACPhoB,KAAKwS,UAAUygF,IAAgB9jF,QAEjCgP,OAAQ,IAAW,mCAEjB,eADqBne,KAAK2S,SAASs2E,eAAeC,iBAAiB,GAAG,IACtDvoF,gBAAkBX,KAAK2S,SAASs2E,eAAeuM,gBAAgB,QAI7EC,EAAqB,IAAI,KAAc,CAC3CjyF,QAAQ,EACR4lC,QAA6C,UAApCk3C,GAAA,aAA2B78E,OAEtCgyF,EAAmB11F,MAAMK,iBAAiB,UAAU,IAAW,yCACvDJ,KAAK2S,SAASutE,gBAAgBwP,SAAS,iBAAkB+F,EAAmB11F,MAAMqpC,QAAU,QAAU,OAC5G,kBAAwB,qBAG1B,qBAA2B,gBAAgB,KACzCqsD,EAAmB70F,iBAAqD,UAApC0/E,GAAA,aAA2B78E,SAGjE,MAuFMiyF,EAvFuF,CAAC,CAC5Fz2F,KAAM,QACNQ,KAAM,gBACNuoB,QAAS,KACP5hB,YAAW,KACT,WAAqB,CACnBmG,OAAQ,YAET,KAEJgpF,EAAY,CACbt2F,KAAM,OACNQ,KAAM,WACNuoB,QAASqtE,GACR,KAA2B,CAC5Bp2F,KAAM,QACNQ,KAAM,eACNuoB,QAAS,KACPhoB,KAAKwS,UAAU4gF,IAAoBjkF,cAEnCnF,EAAW,CACb/K,KAAM,WACNQ,KAAM,WACNuoB,QAAS,KACPhoB,KAAKwS,UAAU2+D,IAAgBhiE,SAEhC,CACDlQ,KAAM,WACNQ,KAAM,WACNuoB,QAAS,OAGTwhB,cAAeisD,GACd,CACDx2F,KAAM,aACNQ,KAAM,aACNuoB,QAAS,OAGTwhB,cAAe,IAAI,KAAc,CAC/BhmC,QAAQ,EACR4lC,SAAS,EACT+B,SAAU,gCAEX,CACDlsC,KAAM,OACNQ,KAAM,mBACNuoB,QAAS,KACP,MAAM1B,EAAM,YAAY,uBAAuB,GAC/C,WAAqBA,KAEtB,CACDrnB,KAAM,MACNQ,KAAM,YACNuoB,QAAS,KACP,MAAM4e,EAAI9nC,SAASC,cAAc,KACjC6nC,EAAEz/B,OAAS,SACXy/B,EAAEsvB,KAAO,kDACTp3D,SAAS8rC,KAAKlrC,OAAOknC,GACrBA,EAAEkM,QACF1sC,YAAW,KACTwgC,EAAEtmC,WACD,KAEJ,CACDrB,KAAM,SACNQ,KAAM,2BACNuoB,QAAS,KACP7kB,QAAQC,IAAI,CACVuyF,GAAA,MAAmB,CAACC,WAAY,MAChCD,GAAA,SAAsB,eACrBj0F,MAAK,KACNia,SAASu6C,KAAO,kCAGpB/3C,OAAQ,IAAM,mBACb,CACDlf,KAAM,SACNQ,KAAM,kCACNuoB,QAAS,KACP2tE,GAAA,SAAsB,aAAaj0F,MAAK,KACtCia,SAASu6C,KAAO,yCAGpB/3C,OAAQ,IAAM,oBAGoBwN,OAAO6kB,SAE3CxwC,KAAK61F,SAAW,GAAiB,GAAI,eAAgBH,GAAuBr1F,GAAM,yCAC1E8C,QAAQC,IAAIsyF,EAAgB/6E,KAAU9b,GAAW,mCAClDA,EAAOsf,QACRtf,EAAOuL,QAAQhL,UAAUoE,OAAO,eAAgB3E,EAAOsf,sBAI7Dne,KAAK61F,SAASz2F,UAAUkB,OAAO,cAC/BN,KAAK61F,SAASz2F,UAAUC,IAAI,uBAAwB,cAEpDW,KAAKs1F,QAAQ1xF,cAAcE,aAAa9D,KAAK61F,SAAU71F,KAAKs1F,SAE5D,MAAMhnB,EAAUtuE,KAAK61F,SAAS3wF,cAAc,aAEtC4wF,EAAgBh3F,SAASC,cAAc,KAC7C+2F,EAAc5/B,KAAO,iEACrB4/B,EAAc3uF,OAAS,SACvB2uF,EAAcC,IAAM,sBACpBD,EAAc12F,UAAUC,IAAI,mBAC5By2F,EAAc11F,iBAAiB,MAAmBC,IAChDA,EAAEqH,kBACF,qBAEF,MAAM2K,EAAIvT,SAASC,cAAc,QACjCsT,EAAEjT,UAAUC,IAAI,wBAChBgT,EAAE/N,UAAY,eAAiB,YAAa,IAAqB,iBACjEwxF,EAAcp2F,OAAO2S,GACrBi8D,EAAQlvE,UAAUC,IAAI,cACtBivE,EAAQ5uE,OAAOo2F,GAEf91F,KAAKg2F,WAAa,GAAiB,GAAI,WAAY,CAAC,CAClD/2F,KAAM,aACNQ,KAAM,aACNuoB,QAAS,KACPhoB,KAAKwS,UAAUu/E,IAAkB5iF,SAElC,CACDlQ,KAAM,WACNQ,KAAM,WACNuoB,QA5KsB,KACtBhoB,KAAKwS,UAAUssC,IAAkB3vC,KAAK,CACpClP,KAAM,OACN++C,WAAW,EACXpI,QAAUp8B,IACRxa,KAAKwS,UAAUsG,IAAgB3J,KAAKqL,IAEtC1L,MAAO,kBACPf,YAAa,oBAqKd,CACD9O,KAAM,aACNQ,KAAM,iBACNuoB,QAASqtE,KAEXr1F,KAAKg2F,WAAWr3F,UAAY,0EAC5BqB,KAAKg2F,WAAWxxF,mBAAmB,aAAc,6GAIjDxE,KAAKg2F,WAAWxlF,GAAK,WACrB4kF,EAAclnD,mBAAmBxuC,OAAOM,KAAKg2F,YAE7Ch2F,KAAKi2F,UAAYn3F,SAASC,cAAc,OAExCiB,KAAKi2F,UAAUt3F,UAAY,2DAC3B,EAAAkG,GAAA,GAAO7E,KAAKi2F,WACZj2F,KAAKi2F,UAAUv2F,QAAO,QAAK,YAK3B,QAAiBM,KAAKi2F,WAAW,KAC5Bj2F,KAAKi2F,UAAU72F,UAAUiG,SAAS,cAIrCsW,SAASu6E,YAGXd,EAAclnD,mBAAmBxuC,OAAOM,KAAKi2F,WAS7Cj2F,KAAK2yF,YAAY5yF,MAAMK,iBAAiB,SAAS,IAAMJ,KAAKm2F,cAAc,CAAC3uF,MAAM,IAIjFxH,KAAKo2F,cAAgBt3F,SAASC,cAAc,QAC5CiB,KAAKo2F,cAAcz3F,UAAY,2CAE/B42F,EAAWnrF,QAAQ1K,OAAOM,KAAKo2F,eAE/B,qBAA2B,iBAAkBhK,IAC3C,GAAiB,IAAdA,EAAO57E,GAAU,CAElB,MAAMzD,EAAQq/E,EAAOiK,cAAcr1F,KACnChB,KAAKo2F,cAAcn3D,UAAY,GAAK81D,GAAahoF,EAAO,GACxD/M,KAAKo2F,cAAch3F,UAAUoE,OAAO,QAASuJ,OAIjD/M,KAAK2S,SAAS2I,gBAAgBgxD,YAAY,kBAG1C,MAAMgqB,EAAiC,CACrCr2F,KAAM,sBACN0R,MAAO,KACLvL,YAAW,KACTpG,KAAK2yF,YAAY5yF,MAAM0M,UACtB,IAEI,GAET8pF,WAAW,GAEbjmF,EAAA,WAAiCgmF,GAEjC,gBAA2B50F,MAAM0pC,IAC/B,MACMorD,EAAsB5uC,aAAY,KACtC1rC,MAAM,UAAW,CAAC6P,MAAO,aACxBrqB,MAAMoL,GAAwB,MAAfA,EAAI6L,QAAkB7L,EAAI2pF,IAAM3pF,EAAIrN,QAAW0D,QAAQqnB,WACtE9oB,MAAMjC,IACFA,IAAS,mBACVO,KAAK02F,WAAY,EACjBztC,cAAcutC,GAEVx2F,KAAKg2F,WAAW52F,UAAUiG,SAAS,cACrCrF,KAAKi2F,UAAU72F,UAAUkB,OAAO,iBAIrCuN,MAAM8vB,GAAA,KAdqB,SAmB1Bw4D,aACN,MAAMQ,EAAkB32F,KAAKmR,UAAUjM,cAAc,qBAE/C4G,EAAa,IAAI,KAAW6qF,GAE5B1nF,EAAQ,KAEVjP,KAAKs1F,QAAQxiD,SAIjB9yC,KAAKoL,aAAe,CAClBipC,SAAU,IAAI7pC,EAAY,sBAAuB,gBAAYR,OAAWA,OAAWA,OAAWA,EAAWiF,GACzG+8D,eAAgB,IAAIxhE,EAAY,eAAgB,gBAAYR,OAAWA,OAAWA,OAAWA,EAAWiF,GACxGjD,SAAU,IAAIxB,EAAY,iBAAkB,YAC5CgiE,OAAQ,IAAIhiE,GAAY,EAAO,YAAY,EAAM,uBAAuB,GAAM,EAAOyE,GACrFm9D,OAAQ,IAAI5hE,EAAY,SAAU,YAAY,EAAM,uBAAuB,GAAM,EAAMyE,IAGzF,MAAM46C,EAAc7pD,KAAK6pD,YAAc,IAAIW,GAAe,CACxDC,UAAW,CAAC,CACV99C,YAAa,2BACblJ,KAAM,cACNxD,KAAM,SACL,CACD0M,YAAa,gCACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,yBACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,8BACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,2BACblJ,KAAM,kBACNxD,KAAM,SACL,CACD0M,YAAa,gCACblJ,KAAM,kBACNxD,KAAM,UAER6L,WAAAA,EACAV,aAAcpL,KAAKoL,aACnB48D,YAAY,EACZE,eAAe,EACf3tC,YAAY,EACZ5nB,SAAU3S,KAAK2S,WAGjBgkF,EAAgB9yF,QAAQgmD,EAAYC,IAAIlmD,cAAcA,eACtDkI,EAAW5K,UAAUxB,OAAOmqD,EAAY3oD,WAGtC2oD,EAAYgC,SAAS,CACnBt/C,OAAQ,GAAGsO,WACXs2B,SAAU,IAEZ0Y,EAAYt6C,UAAU,GACtBs6C,EAAY1oD,MAAK,GAKnB,IAAIy1F,EAAgC,GAChCC,EAAyB,GAAGh8E,WAC5Bi8E,EAAkB,EAClBC,EAAkB,EACtB,MAAMC,EAAe,KAEnBh3F,KAAK2yF,YAAYzxF,UAAU9B,UAAUoE,OAAO,kBAA6C,IAA1BozF,EAAej2F,QAC9EX,KAAK2yF,YAAYzxF,UAAU9B,UAAUoE,OAAO,cAAeozF,EAAej2F,QAEvEi2F,EAAej2F,OAChBX,KAAK2yF,YAAY5yF,MAAMkD,MAAMmgD,YAAY,gBAAkBwzC,EAAeA,EAAej2F,OAAS,GAAG8F,wBAAwB6+B,MAAQtlC,KAAK2yF,YAAY5yF,MAAM0G,wBAAwBE,KAAQ,MAE5L3G,KAAK2yF,YAAY5yF,MAAMkD,MAAMg0F,eAAe,kBAI1CC,EAASp4F,SAASC,cAAc,OACtCm4F,EAAO93F,UAAUC,IAAI,iBACrB63F,EAAO92F,iBAAiB,SAAUC,IAChC,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,iBACzC,IAAIA,EACF,OAGF,MAAM0I,EAAM1I,EAAOS,QAAQiI,IAC3B,GAA4B,IAAzBA,EAAI2G,QAAQ,SAAgB,CAC7B,MAAO5J,EAAG+J,EAASC,GAAW/G,EAAI6yB,MAAM,KACxCo0D,GAAmBngF,EACnBogF,GAAmBngF,OAEnBigF,EAAiBhnF,EAAIgL,WAGvB1T,EAAO/G,iBAAiB,SAAS,KAC/B+2F,EAAehwF,MAGjBnH,KAAK2yF,YAAYzxF,UAAUxB,OAAOyH,GAClCnH,KAAK2yF,YAAYzmF,SAASlM,KAAK2yF,YAAYnyF,MAAQ,IACnDo2F,EAAe/kF,KAAK1K,GACpB6vF,OAGFntC,EAAYC,IAAIlmD,cAAclE,OAAOw3F,GAErC,MAAME,EAAe,CAACvnF,EAAsBf,KAC1C,MAAMzK,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,iBAElB,MAAMguC,EAAW,IAAIC,GA0BrB,OAzBAD,EAASjuC,UAAUC,IAAI,uBAAwB,QAAS,aACxDguC,EAASE,UAAW,EAEpBlpC,EAAIuD,QAAQiI,IAAM,GAAKA,EACpBA,EAAIwiC,iBACQroC,IAAV8E,IACDA,EAAQ,IAAIwpB,GAAU,CAAC/rB,OAAQsD,EAAIgL,aAAazQ,SAGlDijC,EAASxE,kBAAkB,CAACt8B,OAAQsD,KAEpCw9B,EAASjuC,UAAUC,IAAI,wBAGtByP,IACoB,iBAAZ,EACPzK,EAAIC,UAAYwK,IAEhB,EAAAlB,EAAA,GAAevJ,EAAKyK,GACpBzK,EAAI3E,OAAOoP,KAIfzK,EAAIsxC,sBAAsB,aAActI,GAEjChpC,GAGH8yF,EAAkBhwF,IAEM,IADhBA,EAAOS,QAAQiI,IACpB2G,QAAQ,SACbsgF,EAAkBC,EAAkB,EAEpCF,EAAiB,GAAGh8E,WAGtB1T,EAAO7G,UACP,EAAAyR,EAAA,GAAiB6kF,EAAgBzvF,GAEjCf,YAAW,KACT4wF,IACAh3F,KAAK2yF,YAAYzmF,SAASlM,KAAK2yF,YAAYnyF,SAC1C,IAGLR,KAAK2yF,YAAYtkF,QAAU,KACzBuoF,EAAexpF,SAASmE,IACtB4lF,EAAe5lF,OAInBvR,KAAK2yF,YAAYzmF,SAAY1L,IAgB3B,GAfAqpD,EAAYhC,cACZgC,EAAYgC,SAAS,CACnBt/C,OAAQsqF,EACR1lD,SAAU0lD,OAAiB7sF,EAAY,EACvC2B,MAAOnL,EACPmW,QAASmgF,EACTlgF,QAASmgF,IAEXltC,EAAY1oD,MAAK,GAEjB+1F,EAAO5yF,UAAY,GACnBulD,EAAYC,IAAI1qD,UAAUkB,OAAO,SAI7Bu2F,GAAkBr2F,EAAM8L,OAAQ,CAClC,MAAMoiB,EAAam7B,EAAYn7B,WAAWld,MAC1CrO,QAAQC,IAAI,CAEVpD,KAAK2S,SAAS40B,mBAAmBwM,iBAAiBvzC,GAAOkB,MAAK,EAAEkyC,QAAAA,KAAaA,EAAQj5B,KAAKvH,GAAMA,EAAE7G,WAClGvM,KAAK2S,SAAS2I,gBAAgBq5B,mBAAmBn0C,GAAO,KACvDkB,MAAM6oB,IACHmE,MACY,IAAI9P,IAAI2L,EAAQ,GAAGjK,OAAOiK,EAAQ,KAE1Cnd,SAASb,IACf2qF,EAAOx3F,OAAO03F,EAAa7qF,OAG7Bs9C,EAAYC,IAAI1qD,UAAUoE,OAAO,SAAU0zF,EAAO5yF,eAKtD,IAAIwyF,GAAmBt2F,EAAM8L,OAAQ,CACnC,MAAMgK,EAAoB,GAC1BD,EAAa7V,EAAO8V,GACpBA,EAAMlJ,SAASiqF,IACbH,EAAOx3F,OAAO03F,EAAa,QAAUC,EAAS1gF,QAAU,IAAM0gF,EAASzgF,QAASygF,EAASvoF,WAG3F+6C,EAAYC,IAAI1qD,UAAUoE,OAAO,SAAU0zF,EAAO5yF,aAItDulD,EAAYp6C,KAAKm8D,yBAAyBxrE,iBAAiB,aAAcC,IACvE,MAAM8G,GAAS,EAAAsxC,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IACnC,IAAIvxC,EACF,OAGF,MAAMgG,GAAc,EAAAwsB,GAAA,GAAgBxyB,EAAQ,gBAC5C,IAAIgG,GAAeA,EAAY/N,UAAUiG,SAAS,wBAA0B8H,EAAY/N,UAAUiG,SAAS,uBACzG,OAGF,MAAMkH,EAASpF,EAAOg1E,aAAa,gBAAgBthE,WACnD7a,KAAK2S,SAAS2I,gBAAgBg8E,iBAAiB/qF,KAC9C,CAAC+mB,SAAS,IAEb,IAAIikE,EAAkBz4F,SAASC,cAAc,OAC7Cw4F,EAAgBn4F,UAAUC,IAAI,2BAC9Bk4F,EAAgB73F,OAAOM,KAAKoL,aAAaohE,OAAO3hE,MAChD7K,KAAKoL,aAAaohE,OAAOtrE,UAAUxB,OAAO63F,GACnB,IAAI,KAAYA,GAAvC,IAGIC,EADAnzE,GAAQ,EAGZ,MAAM4lC,GAAa,OAAiB0sC,EAAgB/yF,cAAe,YAAa,KAAM4M,IACjFgnF,GAAuBrpF,aAAaqpF,GAE7B,IAAPhnF,GAAa6T,IACdwlC,EAAYt6C,UAAU,GAAG,GACzBvP,KAAK2yF,YAAYvkF,eACjBopF,EAAwB1xF,OAAOM,YAAW,KACxCoxF,EAAwB,EACxBx3F,KAAKg2F,WAAW52F,UAAUkB,OAAO,aACjCN,KAAK02F,WAAa12F,KAAKi2F,UAAU72F,UAAUkB,OAAO,eACjD,MAGL+jB,GAAQ,KAGV4lC,EAAW,GAEX,MAAMwtC,EAAkB,aAClBC,EAAU,KACd13F,KAAK61F,SAASz2F,UAAUkB,OAAOm3F,GAC/Bz3F,KAAKs1F,QAAQl2F,UAAUC,IAAIo4F,GAC3Bz3F,KAAKg2F,WAAW52F,UAAUC,IAAI,aAC9BW,KAAKi2F,UAAU72F,UAAUC,IAAI,aAC7BW,KAAK61F,SAASjyF,cAAcmlB,kBAAkB3pB,UAAUoE,OAAO,cAAc,GAE7E,MAAM+M,EAAyC,gBAC3C,GAAAsxC,kBAAqBvxC,EAAA,iBAAuCC,IAC9DD,EAAA,WAAiC,CAC/BqB,MAAO,KACL1C,KAEFhP,KAAMsQ,IAIV05C,EAAW,IAGbjqD,KAAK2yF,YAAY5yF,MAAMK,iBAAiB,QAASs3F,GACjDA,IAEA13F,KAAKs1F,QAAQl1F,iBAAiB,SAAUC,IACtCL,KAAK61F,SAASz2F,UAAUC,IAAIo4F,GAC5Bz3F,KAAKs1F,QAAQl2F,UAAUkB,OAAOm3F,GAC9Bz3F,KAAK61F,SAASjyF,cAAcmlB,kBAAkB3pB,UAAUoE,OAAO,cAAc,GAE7E8M,EAAA,eAAqC,iBAErC25C,EAAW,MAGb,MAAM0tC,EAAuB,EAAW,SACxC33F,KAAKoL,aAAaghE,OAAOthE,OAAOpL,OAAOi4F,GACvCA,EAAqBv3F,iBAAiB,SAAS,KAC7C2uF,GAAkB,CAChBrhD,mBAAoB,8BACpB7uC,OAAQ,CACN0sC,QAAS,cACTwO,UAAU,KAEXr4C,MAAK,IACC1B,KAAK2S,SAAS2I,gBAAgBs8E,oBAAoBl2F,MAAK,KAC5D1B,KAAKoL,aAAaghE,OAAOrhE,kBA4HnC,oBAAgCoqF,GAChC,YC3uBA,MAAM0C,GAYJj4F,YAAYwiC,EAAYqnD,EAAsB5b,GAC5C7tE,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,iBAC7BW,KAAKoiC,KAAOA,EACZpiC,KAAKypF,OAASA,EACdzpF,KAAKyc,MAAQ,GACbzc,KAAK6tE,cAAgBA,EACrB7tE,KAAKgkB,OAAS,EAGhB8zE,aAAazqF,GACX,GAAGrN,KAAK+3F,kBACN,OAAO/3F,KAAK+3F,kBACP,GAAiB,mBAAd1qF,EAAQT,EAChB,OAGF5M,KAAK+uD,gBAAkBjwD,SAASC,cAAc,OAC9CiB,KAAK+uD,gBAAgB3vD,UAAUC,IAAI,oCACjCW,KAAKgkB,OAEP,MAAMg0E,EAAU3qF,EAAQ2qB,SAClBigE,EAAY5qF,EAAQ4qF,UACpBC,EAAuB7qF,EAAQ8qF,SAAiC,gBAAtB9qF,EAAQ8qF,QAAQvrF,GAAuBS,EAAQC,SAAW2qF,EACpGG,EAAgBp4F,KAAKoiC,KAAK71B,OAYhC,OAXAvM,KAAK2jD,OAAS,IAAIrW,GAClBttC,KAAK2jD,OAAOvkD,UAAUC,IAAI,uBAAwB,cAAe,aACjEW,KAAK+3F,kBAAoB/3F,KAAK2jD,OAAO9a,kBAAkB,CACrDpa,cAAezuB,KAAKoiC,KAAKqJ,QAAQhd,cACjCliB,QAAUyrF,IAAYI,IAAkB,UAAkBA,IAAkB,QAAqBF,EAAuBD,EAAY5qF,EAAQC,SAAW,MACvJ8qB,WAAY6/D,GAAaD,GAAWA,EAAQ//D,UAA4B+/D,EAAQ//D,eAAYjuB,IAG9FhK,KAAK+uD,gBAAgBrvD,OAAOM,KAAK2jD,QACjC3jD,KAAKkB,UAAUxB,OAAOM,KAAK+uD,iBAEpB/uD,KAAK+3F,kBAGVM,qBACF,OAAOr4F,KAAKs4F,UAAUlkF,UAGpBmkF,eACF,OAAOv4F,KAAKs4F,UAAUrrF,IAGpBqrF,gBACF,OAAOt4F,KAAKyc,MAAMzc,KAAKyc,MAAM9b,OAAS,GAGpC63F,oBACF,OAAOx4F,KAAKy4F,SAASrkF,UAGnBskF,cACF,OAAO14F,KAAKy4F,SAASxrF,IAGnBwrF,eACF,OAAOz4F,KAAKyc,MAAM,GAGpBk8E,mBACE,MAAMl8E,EAAQzc,KAAKyc,MACb9b,EAAS8b,EAAM9b,OACrB,IAAIA,EACF,OAWF,MAAM0jB,EAAQ5H,EAAM9b,EAAS,GAAG0mC,OAEhC,GAAoB,IAAjB5qB,EAAM9b,OAGP,YAFA0jB,EAAMjlB,UAAUC,IAAI,iBAAkB,iBAItCglB,EAAMjlB,UAAUkB,OAAO,iBACvB+jB,EAAMjlB,UAAUC,IAAI,kBAItB,IAAI,IAAI0M,EAAI,EAAG8/E,EAAUlrF,EAAS,EAAGoL,EAAI8/E,IAAW9/E,EACnC0Q,EAAM1Q,GAAGs7B,OACjBjoC,UAAUkB,OAAO,gBAAiB,kBAI3C,MAAMigD,EAAO9jC,EAAM,GAAG4qB,OACtBkZ,EAAKnhD,UAAUkB,OAAO,kBACtBigD,EAAKnhD,UAAUC,IAAI,iBAIrBu5F,WAAW75E,GACT,MAAM,MAACtC,GAASzc,MAChB,EAAAo8D,GAAA,GAA2B3/C,EAAOsC,EAAM/e,KAAKypF,OAAOoP,mBAEpD95E,EAAKohB,MAAQngC,KACO,IAAjByc,EAAM9b,QACPX,KAAKypF,OAAOqP,YAAY94F,MAI5B+4F,WAAWh6E,IACT,EAAAhN,EAAA,GAAiB/R,KAAKyc,MAAOsC,GAEzB/e,KAAKyc,MAAM9b,SACb,EAAAoR,EAAA,GAAiB/R,KAAKypF,OAAOA,OAAQzpF,MAGvC+e,EAAKohB,WAAQn2B,EAGfgvF,MAAML,GACJ,IAAI34F,KAAKypF,OAAOA,OAAOriF,SAASpH,QAAUA,KAAKyc,MAAM9b,OAOnD,YAJGX,KAAKqkE,SACNrkE,KAAKi5F,iBAMT,MAAM,OAACj1E,EAAM,MAAEvH,GAASzc,MAClB,OAACW,GAAU8b,GACjB,EAAA8rE,GAAA,GAAe9rE,GAAO,CAACsC,EAAMV,KAC3Bre,KAAKk5F,UAAUn6E,EAAMpe,EAAS,EAAI0d,EAAK2F,MAGtC20E,GACD34F,KAAK24F,mBAGP34F,KAAKm5F,cAGPD,UAAUn6E,EAAiBV,EAAMre,KAAKyc,MAAMjG,QAAQuI,GAAOiF,EAAShkB,KAAKgkB,QACpEjF,EAAKslD,UAIRvJ,GAAuB/7C,EAAKsoB,OAAQrnC,KAAKkB,UAAW8iB,EAAS3F,GAC7DU,EAAKslD,SAAU,GAGjB+0B,YAAYr6E,GACNA,EAAKslD,UAITtlD,EAAKsoB,OAAO/mC,SACZye,EAAKslD,SAAU,EACfrkE,KAAKi5F,iBAGPE,cACE,GAAGn5F,KAAKqkE,QACN,OAGF,MAAMg1B,EAAgBr5F,KAAKoiC,KAAKqJ,QAAQ6tD,4BAA4Bt5F,KAAK6tE,cAAgB,KAEnF0rB,EAAav5F,KAAKypF,OAAOA,OAAO99D,QAAQ6tE,GAAWA,EAAO3rB,gBAAkB7tE,KAAK6tE,gBACjF4rB,EAAmBF,EAAW54F,OAC9B0d,EAAMk7E,EAAW/iF,QAAQxW,MACzB05F,EAAkBH,EAAW74F,MAAM2d,EAAM,GAAGyC,QAAO,CAACC,EAAK8lB,IAAM9lB,GAAO8lB,EAAEw9B,QAAU,EAAI,IAAI,GAChGvJ,GAAuB96D,KAAKkB,UAAWm4F,EAAcn4F,UAAWy4F,GAAgBF,EAAmB,EAAIp7E,EAAMq7E,GAC7G15F,KAAKqkE,SAAU,EAGjB40B,gBACMj5F,KAAKqkE,UAILrkE,KAAKyc,MAAM9b,OAKbX,KAAK24F,oBAJL34F,KAAKkB,UAAUZ,SACfN,KAAKoiC,KAAKqJ,QAAQmuD,wBAClB55F,KAAKqkE,SAAU,KAsBN,MAAMw1B,GASnBj6F,YAAoBwiC,GAAA,KAAAA,KAAAA,EARb,KAAA03D,SAA6B,GAC5B,KAAAC,SAAwC,IAAI9oF,IAC7C,KAAAw4E,OAA6B,GAC5B,KAAAuQ,aAAe,IAMrBh6F,KAAKi6F,aAA6B,cAAd73D,EAAKniC,KAAuB,YAAc,MAC9DD,KAAKk6F,cAA8B,cAAd93D,EAAKniC,KAAuB,gBAAkB,UACnED,KAAK64F,kBAAoE,WAG3EE,WAAWh6E,GACTA,EAAKohB,MAAM44D,WAAWh6E,GACtB/e,KAAKm6F,oBAAoBp7E,GAG3Bq7E,uBAAuB/yD,GACrB,MAAMtoB,EAAO/e,KAAKq6F,gBAAgBhzD,GAClC,IAAItoB,EACF,OAGF,MAAMtC,EAAQzc,KAAK85F,SACbx0E,EAAQ7I,EAAMjG,QAAQuI,GACtBu7E,EAAWt6F,KAAKu6F,mBAAmBj1E,EAAO7I,GAE1C0jB,EAAQphB,EAAKohB,MACnBngC,KAAK+4F,WAAWh6E,GAChBohB,EAAMi5D,YAAYr6E,GAElB,MAAMy7E,EAAmC,IAAI57E,IAC7C47E,EAAen7F,IAAI8gC,GAEnB,MAAOs6D,EAAiBz2F,GAAes2F,EACvC,GACEG,GACGz2F,GACAhE,KAAK06F,kBAAkBD,EAAiBz2F,IACxCy2F,EAAgBt6D,QAAUn8B,EAAYm8B,MACzC,CACA,MAAMA,EAAQn8B,EAAYm8B,MAC1BngC,KAAKyqB,EAAEzmB,EAAYm8B,MAAM1jB,OACzB0jB,EAAM84D,gBACNuB,EAAen7F,IAAIo7F,EAAgBt6D,OACnCngC,KAAK26F,iBAGP36F,KAAK46F,mBAAmBxpF,MAAMC,KAAKmpF,IAGrCI,mBAAmBnR,GAGjB,MAAOoR,EAASC,GClTL,SAAsBl6E,EAAU9b,GAC7C,MAAM63D,EAAY,GAAIo+B,EAAW,GACjC,IAAI,IAAIhvF,EAAI,EAAGpL,EAASigB,EAAIjgB,OAAQoL,EAAIpL,IAAUoL,EAAG,CACnD,MAAMgT,EAAO6B,EAAI7U,ID+S+Bo0B,EC9StCphB,ED8SkDohB,EAAM1jB,MAAM9b,OC9S9Cg8D,EAAOo+B,GAAKlpF,KAAKkN,GD8SI,IAACohB,EC3SlD,MAAO,CAACw8B,EAAMo+B,GD2SiBC,CAAUvR,GACvCqR,EAAU1tF,SAAS+yB,IACjBA,EAAM84D,mBAGR4B,EAAQztF,SAAS+yB,IACfA,EAAM64D,OAAM,MAQhBvuE,EAAEhO,EAAoB6I,EAAgB,EAAG3kB,EAAS8b,EAAM9b,QACtD,KAAM2kB,EAAQ3kB,IAAU2kB,EAAO,CAC7B,MAAMvG,EAAOtC,EAAM6I,GACnBvG,EAAKslD,SAAU,EACftlD,EAAKohB,MAAM44D,WAAWh6E,KACpBpe,IACA2kB,GAIN+0E,gBAAgBhzD,GACd,OAAOrnC,KAAK+5F,SAASvoF,IAAI61B,GAG3B4zD,eACE,OAAOj7F,KAAKypF,OAAO,GAGrByR,gBAAgB7zD,EAAqBp6B,GACnC,MAAM8R,EAAO/e,KAAKq6F,gBAAgBhzD,GAC9BtoB,IAIJA,EAAK9R,IAAMA,GAOX,EAAA8E,EAAA,GAAiB/R,KAAK85F,SAAU/6E,GAChC/e,KAAKm7F,kBAAkBp8E,EAAM/e,KAAK85F,WAGpCsB,iBAAiBr8E,EAAiBsoB,GAChCrnC,KAAK+5F,SAASrqF,OAAOqP,EAAKsoB,QAC1BtoB,EAAKsoB,OAASA,EACdrnC,KAAK+5F,SAAS98E,IAAIoqB,EAAQtoB,GAG5Bs8E,qBAAqBhqF,EAAmBixB,GACtC,MAAMvjB,EAAO/e,KAAKq6F,gBAAgBhpF,GAC9B0N,GAIJ/e,KAAKo7F,iBAAiBr8E,EAAMujB,GAG9Bo4D,kBAAkBY,EAAkBC,GAClC,OAAOA,EAAMjuF,SAAWguF,EAAMhuF,QACzB3K,KAAKoE,IAAIw0F,EAAMnnF,UAAYknF,EAAMlnF,YAAcpU,KAAKg6F,cACpDsB,EAAMztB,gBAAkB0tB,EAAM1tB,gBAC7BytB,EAAMtvC,SACNuvC,EAAMvvC,OAGduuC,mBAAmBiB,EAAmB/+E,GACpC,MAAO,CAACA,EAAM++E,EAAY,GAAI/+E,EAAM++E,EAAY,IAOlDC,uBAAuB18E,EAAiBtC,GACtCA,EAAQA,EAAM/b,QACd,MAAM2d,EAAMre,KAAKm7F,kBAAkBp8E,EAAMtC,GAEzC,OAAOzc,KAAK07F,wBAAwB38E,EAAMtC,EAAO4B,GAGnDq9E,wBAAwB38E,EAAiBtC,EAAoB6I,EAAQ7I,EAAMjG,QAAQuI,GAAOpe,EAAS8b,EAAM9b,QACvG,MAAMg7F,EAAel/E,EAAM6I,EAAQ,GACnC,IAAIs2E,EACJ,IAAGD,MAAAA,OAAY,EAAZA,EAAcx7D,QAASngC,KAAK06F,kBAAkB37E,EAAM48E,GACrDC,EAAqBD,OAErB,IAAI,IAAIlkF,EAAI6N,EAAQ,EAAG7N,EAAI9W,IAAU8W,EAAG,CACtC,MAAMokF,EAAWp/E,EAAMhF,GACvB,IAAGzX,KAAK06F,kBAAkB37E,EAAM88E,GAK9B,MAJGA,EAAS17D,QACVy7D,EAAqBC,GAQ7B,OAAOD,EAGTE,eAAe/8E,EAAiBohB,GAC9BA,EAAMy4D,WAAW75E,GACjB/e,KAAK+7F,eAAeh9E,GAGtBo8E,kBAAkBp8E,EAAiBb,GACjC,OAAO,EAAAk+C,GAAA,GAA2Bl+C,EAAOa,EAAM/e,KAAKi6F,cAGtDnB,YAAY34D,GACV,OAAO,EAAAi8B,GAAA,GAA2Bp8D,KAAKypF,OAAQtpD,EAAOngC,KAAKk6F,eAG7D6B,eAAeh9E,GACb/e,KAAKm7F,kBAAkBp8E,EAAM/e,KAAK85F,UAClC95F,KAAK+5F,SAAS98E,IAAI8B,EAAKsoB,OAAQtoB,GAGjCo7E,oBAAoBp7E,IAClB,EAAAhN,EAAA,GAAiB/R,KAAK85F,SAAU/6E,GAChC/e,KAAK+5F,SAASrqF,OAAOqP,EAAKsoB,QAG5B20D,iBAAiB3uF,GACf,IAAIC,EAASD,EAAQ4uF,UAAY5uF,EAAQC,OAOzC,OAJGA,IAAW,UAAkBD,EAAQd,SAAW,UAAmBc,EAA4B4qF,YAAc3qF,IAC9GA,EAASA,EAAOuN,UAAS,IAGpBvN,EAGT4uF,WAAW70D,EAAqBh6B,GAC9B,MAAM2+C,IAAyB,YAAd3+C,EAAQT,GAAoBS,EAAQ22C,QAAUm4C,GAAmBhqD,IAAI9kC,EAAQ22C,OAAOp3C,KAC/F,IAACK,EAAKkG,KAAMiB,GAAa/G,GACzB,cAACwgE,GAAiB7tE,KAAKoiC,KAAKqJ,QAAQ2wD,wBAAwBhoF,GAclE,MAbwB,CACtBnH,IAAAA,EACAovF,SAA6B,cAAnBr8F,KAAKoiC,KAAKniC,MAAwB,IAAgB,IAAZmU,EAAmBy5D,GAAiB,OAAQ5gE,IAAQA,EACpGK,OAAQtN,KAAKg8F,iBAAiB3uF,GAC9Bg6B,OAAAA,EAEAjzB,UAAAA,EACAy5D,cAAAA,EACAxJ,SAAS,EACTrY,OAAAA,EACA3+C,QAAAA,GAMJivF,wBAAwBhC,GACtB,MAAOG,EAAiBz2F,GAAes2F,EACjCiC,EAAgB9B,MAAAA,OAAe,EAAfA,EAAiBt6D,MAGvC,GAFkBn8B,MAAAA,GAAAA,EAAam8B,OAE3Bo8D,EACF,OAKA,MAAM9/E,EAAQ8/E,EAAc9/E,MACtB6I,EAAQ7I,EAAMjG,QAAQikF,GAAmB,EACzC95F,EAAS8b,EAAM9b,OACrB,GAAG2kB,IAAU3kB,EACX,OAGF,MAAM65F,EAAgC,CAAC+B,GAMvC,OADAv8F,KAAKyqB,EAAEhO,EAAO6I,EAAO3kB,GACd65F,EAIXgC,mBAAmBn1D,EAAqBh6B,GAEtC,GADkBrN,KAAKq6F,gBAAgBhzD,GAGrC,OAGF,MAAMtoB,EAAO/e,KAAKk8F,WAAW70D,EAAQh6B,GACrCrN,KAAK+7F,eAAeh9E,GAGtB47E,iB,MACE,MAAMl+E,EAAQzc,KAAK85F,SACbn5F,EAAS8b,EAAM9b,OACf65F,EAAmC,IAAI57E,IAE7C,IAAI,IAAI7S,EAAI,EAAGA,EAAIpL,IAAUoL,EAAG,CAC9B,MAAMgT,EAAOtC,EAAM1Q,GACnB,GAAGgT,EAAKohB,MACN,SAGF,IAAIs8D,GAAW,EACf,MAAMnC,EAAWt6F,KAAKu6F,mBAAmBxuF,EAAG0Q,GAItCigF,EAHqB18F,KAAK07F,wBAAwB38E,EAAMtC,EAAO1Q,EAAGpL,GAIlEw/B,EAAwB,QAAhB,EAAAu8D,MAAAA,OAAS,EAATA,EAAWv8D,aAAK,SAAKs8D,GAAW,EAAO,IAAI5E,GAAY73F,KAAKoiC,KAAMpiC,KAAM+e,EAAK8uD,gBAK3F,GAHA2sB,EAAen7F,IAAI8gC,GACnBA,EAAMy4D,WAAW75E,IAEb09E,EAAU,CACZ,MAAME,EAAiB38F,KAAKs8F,wBAAwBhC,GACjDqC,GACDA,EAAevvF,SAAS+yB,GAAUq6D,EAAen7F,IAAI8gC,MAK3D,OAAOq6D,EAkFTvqF,UACEjQ,KAAK85F,SAAW,GAChB95F,KAAKypF,OAAS,GACdzpF,KAAK+5F,SAAShvF,SExmBH,MAAM6xF,WAAwB,IAqB3Ch9F,YAAYi9F,EAAuBC,EAA+Cl+F,EAO9D,IA4ClB,GA3CAiB,MAAM,oBAAqBjB,EAAQm+F,UAAY,GAAK,CAAC,CACnDxxD,QAAS,aACTzmC,SAAU,KACL9E,KAAK88F,QACN98F,KAAK88F,OAAO98F,KAAKg9F,aAAahpF,UAAY,IAAO,KAGpD,CACDu3B,QAAS,SACTunC,UAAU,IACR,OAAF,QAAGloC,MAAM,EAAMwC,iBAAiB,GAASxuC,IAlBV,KAAAk+F,OAAAA,EAA+C,KAAAl+F,QAAAA,EAsKlF,KAAAq+F,YAAe58F,IACbL,KAAKk9F,cAAc/kF,SAASnY,KAAKk9F,cAAc3pF,WAAa,GAC5DvT,KAAKmY,WAEFnY,KAAKk9F,cAAclpF,YAAchU,KAAKm9F,SAASnpF,WAChDhU,KAAKo9F,QAAQ59F,aAAa,WAAY,QAGxCQ,KAAK8Z,QAAQnV,gBAAgB,aAG/B,KAAA04F,YAAeh9F,IACbL,KAAKk9F,cAAc/kF,SAASnY,KAAKk9F,cAAc3pF,WAAa,GAC5DvT,KAAKmY,WAEFnY,KAAKk9F,cAAclpF,YAAchU,KAAKs9F,SAAStpF,WAChDhU,KAAK8Z,QAAQta,aAAa,WAAY,QAGxCQ,KAAKo9F,QAAQz4F,gBAAgB,aAG/B,KAAA44F,YAAel9F,IAEb,MAAM8G,EAAS9G,EAAE8G,OAEjB,IAAIA,EAAOS,QAAQwM,UAAW,OAE9B,GAAGpU,KAAKw9F,WAAY,CAClB,GAAGx9F,KAAKw9F,aAAer2F,EAAQ,OAC/BnH,KAAKw9F,WAAWp+F,UAAUkB,OAAO,UAGnCN,KAAKw9F,WAAar2F,EAElBA,EAAO/H,UAAUC,IAAI,UACrB,MAAM+U,GAAajN,EAAOS,QAAQwM,UAElCpU,KAAKg9F,aAAe,IAAIt3F,KAAK0O,GAE7BpU,KAAK4P,WACL5P,KAAKy9F,gBA3LLz9F,KAAK2W,QAAU/X,EAAQ+X,SAAW,IAAIjR,KAAK,uBAExCm3F,EAAW78F,KAAK2W,SACjBkmF,EAASpmF,YAAYzW,KAAK2W,QAAQrD,cAAetT,KAAK2W,QAAQpD,WAAYvT,KAAK2W,QAAQnD,WAIzFxT,KAAK09F,YAAc5+F,SAASC,cAAc,OAC1CiB,KAAK09F,YAAYt+F,UAAUC,IAAI,wBAE/BW,KAAKo9F,QAAUt+F,SAASC,cAAc,UACtCiB,KAAKo9F,QAAQh+F,UAAUC,IAAI,WAAY,aAAc,qBACrD,QAAiBW,KAAKo9F,QAASp9F,KAAKi9F,YAAa,CAACh0F,eAAgBjJ,KAAKiJ,iBAEvEjJ,KAAK8Z,QAAUhb,SAASC,cAAc,UACtCiB,KAAK8Z,QAAQ1a,UAAUC,IAAI,WAAY,aAAc,qBACrD,QAAiBW,KAAK8Z,QAAS9Z,KAAKq9F,YAAa,CAACp0F,eAAgBjJ,KAAKiJ,iBAEvEjJ,KAAK29F,WAAa7+F,SAASC,cAAc,OACzCiB,KAAK29F,WAAWv+F,UAAUC,IAAI,2BAE9BW,KAAK09F,YAAYh+F,OAAOM,KAAKo9F,QAASp9F,KAAK29F,WAAY39F,KAAK8Z,SAG5D9Z,KAAK49F,gBAAkB9+F,SAASC,cAAc,OAC9CiB,KAAK49F,gBAAgBx+F,UAAUC,IAAI,uBACnC,QAAiBW,KAAK49F,gBAAiB59F,KAAKu9F,YAAa,CAACt0F,eAAgBjJ,KAAKiJ,iBAE/EjJ,KAAK4qC,KAAKlrC,OAAOM,KAAK09F,YAAa19F,KAAK49F,iBAGrCh/F,EAAQy7B,SAAU,CACnBr6B,KAAKi9B,QAAUn+B,SAASC,cAAc,OACtCiB,KAAKi9B,QAAQ79B,UAAUC,IAAI,oBAE3B,MAAM61F,EAAYp2F,SAASC,cAAc,OACzCm2F,EAAU91F,UAAUC,IAAI,8BACxB61F,EAAUx1F,OAAO,KAEjB,MAAMm+F,EAAkB,CAACr7F,EAAaD,EAAwB2L,EAAmC4vF,KAC/F,MAAMC,EAAY,GAAKv7F,EACvBxC,KAAKiJ,eAAe5J,IAAIkD,EAAWxC,MAAnCC,CAA0C,SAAUK,IAClD,IAAIG,EAAQ+B,EAAW/B,MAAMC,QAAQ,MAAO,IACzCD,EAAMG,OAAS,EAChBH,EAAQA,EAAME,MAAM,EAAG,IAEF,IAAjBF,EAAMG,SAAiBH,EAAM,IAAMu9F,EAAU,IAAyB,IAAjBv9F,EAAMG,SAAiBH,EAAQgC,KAClE,IAAjBhC,EAAMG,QAAgBm9F,GACvBA,GAAYt9F,EAAM,IAGpBA,EAAQ,IAAMA,EAAM,IAIxB+B,EAAW3B,iBAAiBJ,GAC5B0N,EAAQ1N,EAAMG,YAIlBX,KAAKg+F,gBAAkB,IAAI,IAAW,CAACl+F,WAAW,IAClDE,KAAKi+F,kBAAoB,IAAI,IAAW,CAACn+F,WAAW,IAEpD+9F,EAAgB,GAAI79F,KAAKg+F,iBAAkBr9F,IAC3B,IAAXA,GACDX,KAAKi+F,kBAAkBl+F,MAAM0M,QAG/BzM,KAAKy9F,kBACHS,IACFl+F,KAAKi+F,kBAAkBz9F,OAAS09F,EAASl+F,KAAKi+F,kBAAkBz9F,OAAOE,MAAM,EAAG,MAElFm9F,EAAgB,GAAI79F,KAAKi+F,mBAAoBt9F,IACvCA,GACFX,KAAKg+F,gBAAgBj+F,MAAM0M,QAG7BzM,KAAKy9F,kBAGPz9F,KAAKg9F,aAAeH,EAEpBA,EAASsB,WAAWtB,EAASrnF,aAAe,IAE5CxV,KAAKg+F,gBAAgBp9F,kBAAkB,IAAMi8F,EAAStnF,YAAY7U,OAAO,IACzEV,KAAKi+F,kBAAkBr9F,kBAAkB,IAAMi8F,EAASrnF,cAAc9U,OAAO,IAE7Em8F,EAASnmF,SAAS,EAAG,EAAG,EAAG,GAE3B1W,KAAKi9B,QAAQv9B,OAAOM,KAAKg+F,gBAAgB98F,UAAWg0F,EAAWl1F,KAAKi+F,kBAAkB/8F,YAEtF,QAAiBlB,KAAKqyF,YAAY,KAC7BryF,KAAK88F,SACN98F,KAAKg9F,aAAatmF,UAAU1W,KAAKg+F,gBAAgBx9F,OAAS,GAAIR,KAAKi+F,kBAAkBz9F,OAAS,EAAG,EAAG,GACpGR,KAAK88F,OAAO98F,KAAKg9F,aAAahpF,UAAY,IAAO,IAGnDhU,KAAKs2C,SACJ,CAACrtC,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAK4qC,KAAKlrC,OAAOM,KAAKi9B,SAEtBj9B,KAAKo9F,QAAQh+F,UAAUC,IAAI,WAC3BW,KAAK8Z,QAAQ1a,UAAUC,IAAI,WAG7B,MAAM++F,EAAgBt/F,SAASC,cAAc,OAC7Cq/F,EAAch/F,UAAUC,IAAI,kBAC5B++F,EAAc1+F,OAAOM,KAAKkB,WAC1BlB,KAAKoK,QAAQ1K,OAAO0+F,GAIpBvB,EAASnmF,SAAS,EAAG,EAAG,EAAG,GAC3B1W,KAAKg9F,aAAeH,EAEpB78F,KAAK4W,QAAUhY,EAAQgY,SAAW,IAAIlR,KACtC1F,KAAK4W,QAAQF,SAAS,EAAG,EAAG,EAAG,GAE/B1W,KAAKk9F,cAAgB,IAAIx3F,KAAK1F,KAAKg9F,cACnCh9F,KAAKk9F,cAAcnmF,QAAQ,GAE3B/W,KAAKs9F,SAAW,IAAI53F,KAAK1F,KAAK4W,SAC9B5W,KAAKs9F,SAASvmF,QAAQ,GAEtB/W,KAAKm9F,SAAW,IAAIz3F,KAAK1F,KAAK2W,SAC9B3W,KAAKm9F,SAASzmF,SAAS,EAAG,EAAG,EAAG,GAChC1W,KAAKm9F,SAASpmF,QAAQ,GAEnB/W,KAAKk9F,cAAclpF,YAAchU,KAAKm9F,SAASnpF,WAChDhU,KAAKo9F,QAAQ59F,aAAa,WAAY,QAGrCQ,KAAKk9F,cAAclpF,YAAchU,KAAKs9F,SAAStpF,WAChDhU,KAAK8Z,QAAQta,aAAa,WAAY,QAGrCZ,EAAQ4uC,UACTxtC,KAAK4P,SAAW,QAGlB5P,KAAKy9F,eACLz9F,KAAK4P,WACL5P,KAAKmY,WA+CAslF,eACL,GAAGz9F,KAAKqyF,YAAcryF,KAAKg9F,aAAc,CACvC,IAAIntF,EAAkBT,EAAc,GACpC,MAAM+D,EAAO,IAAIzN,KACjByN,EAAKuD,SAAS,EAAG,EAAG,EAAG,GAEvB,MAAM2nF,EAA0C,CAC9C/pF,OAAQ,UACRD,KAAM,WAGFiqF,EAAW,IAAI54F,KAAK1F,KAAKg9F,aAAahpF,WAG5C,GAFAsqF,EAAS5nF,UAAU1W,KAAKg+F,gBAAgBx9F,OAAQR,KAAKi+F,kBAAkBz9F,OAEpER,KAAKg9F,aAAahpF,YAAcb,EAAKa,UACtCnE,EAAM,yBAGE,CACRA,EAAM,oBAEN,MAAM0uF,EAA0C,CAC9C9pF,MAAO,QACPD,IAAK,WAGJ8pF,EAAShrF,gBAAkBH,EAAKG,gBACjCirF,EAAYhqF,KAAO,WAGrBnF,EAAKyC,KAAK,IAAI,qBAAqB,CACjCsB,KAAMmrF,EACN1/F,QAAS2/F,IACRn0F,SAGLgF,EAAKyC,KAAK,IAAI,qBAAqB,CACjCsB,KAAMmrF,EACN1/F,QAASy/F,IACRj0F,SAEHpK,KAAKqyF,WAAWlnB,WAAW1sC,aAAY,QAAK5uB,EAAKT,KAI9CQ,WAGL5P,KAAK8O,MAAM6jB,YAAc,GACzB3yB,KAAK8O,MAAMpP,OAAO,IAAI,qBAAqB,CACzCyT,KAAMnT,KAAKg9F,aACXp+F,QAAS,CACP4V,IAAK,UACLC,MAAO,OACPC,QAAS,WAEVtK,SAGGo0F,cAAcj/F,EAAmB0/B,EAAkC,IACzE,MAAM1tB,EAAKzS,SAASC,cAAc,UAWlC,OAVAwS,EAAGnS,UAAUC,IAAI,WAAY,0BAE1BE,GACDgS,EAAG/R,aAAa,WAAY,QAG3By/B,GACD1tB,EAAG7R,OAAOu/B,GAGL1tB,EAGF4G,WACL,MAAMsmF,EAAY,IAAI/4F,KAAK1F,KAAKk9F,eAE1Bt+F,EAAsC,CAC1C2V,KAAM,UACNE,MAAOzU,KAAKi9B,SAAW5N,EAAA,WAAsB,QAAU,QAGzDrvB,KAAK29F,WAAWhrE,YAAc,GAC9B3yB,KAAK29F,WAAWj+F,OAAO,IAAI,qBAAqB,CAACyT,KAAMsrF,EAAW7/F,QAAAA,IAAUwL,SAGzEpK,KAAKyU,OACNzU,KAAKyU,MAAMnU,SAGbN,KAAKyU,MAAQ3V,SAASC,cAAc,OACpCiB,KAAKyU,MAAMrV,UAAUC,IAAI,qBAEzB,MAAMq/F,EAAgB,IAAIh5F,KACpB8O,EAAMkqF,EAAcznF,SACf,IAARzC,GACDkqF,EAAchoF,UAAU,IAAMlC,EAAM,IAGtC,IAAI,IAAIzI,EAAI,EAAGA,EAAI,IAAKA,EAAG,CACzB,MAAMwF,EAAKvR,KAAKw+F,eAAc,EAAM,IAAI,qBAAqB,CAACrrF,KAAMurF,EAAe9/F,QAAS,CAAC8V,QAAS,YAAYtK,SAClHmH,EAAGnS,UAAUkB,OAAO,0BACpBiR,EAAGnS,UAAUC,IAAI,yBACjBW,KAAKyU,MAAM/U,OAAO6R,GAClBmtF,EAAc3nF,QAAQ2nF,EAAclrF,UAAY,GAIlD,IAAImrF,EAAWF,EAAUxnF,SAAW,GACnB,IAAd0nF,IAAiBA,EAAW,GAE/B,MAAMC,EAAa,IAAIl5F,KAAK+4F,EAAUzqF,WACtC4qF,EAAW7nF,QAAQ6nF,EAAWprF,UAAYmrF,EAAW,GAGrD,IAAI,IAAI5yF,EAAI,EAAGA,EAAI4yF,IAAY5yF,EAC1B/L,KAAKpB,QAAQigG,oBACdD,EAAW7nF,QAAQ6nF,EAAWprF,UAAY,GAC1CxT,KAAKyU,MAAM/U,OAAOM,KAAKw+F,eAAc,EAAM,GAAKI,EAAWprF,aAE3DxT,KAAKyU,MAAM/U,OAAOM,KAAKw+F,eAAc,IAIzC,EAAG,CACD,MAAMrrF,EAAOsrF,EAAUjrF,UACjBjC,EAAKvR,KAAKw+F,cAAcC,EAAYz+F,KAAK4W,SAAW6nF,EAAYz+F,KAAK2W,QAAS,GAAKxD,GACzF5B,EAAG3J,QAAQwM,UAAY,GAAKqqF,EAAUzqF,UAEnCyqF,EAAUzqF,YAAchU,KAAKg9F,aAAahpF,YAC3ChU,KAAKw9F,WAAajsF,EAClBA,EAAGnS,UAAUC,IAAI,WAGnBW,KAAKyU,MAAM/U,OAAO6R,GAElBktF,EAAU1nF,QAAQ5D,EAAO,SACK,IAAxBsrF,EAAUjrF,WAElB,MAAM87C,EAAYtvD,KAAKyU,MAAMxJ,kBAAoB,EACjD,GAAGjL,KAAKpB,QAAQigG,oBAAsBvvC,EACpC,IAAI,IAAIvjD,EAAIujD,EAAWvjD,EAAI,IAAKA,EAC9B/L,KAAKyU,MAAM/U,OAAOM,KAAKw+F,eAAc,EAAM,GAAKC,EAAUjrF,YAC1DirF,EAAU1nF,QAAQ0nF,EAAUjrF,UAAY,GAI5C,MAAMsrF,EAAQn8F,KAAKoR,KAAK/T,KAAKyU,MAAMxJ,kBAAoB,GACvDjL,KAAKkB,UAAU0G,QAAQk3F,MAAQ,GAAKA,EAEpC9+F,KAAK49F,gBAAgBl+F,OAAOM,KAAKyU,QCnYtB,MAAMsqF,GAInBn/F,YAAoBsB,EAAgCiE,GAAhC,KAAAjE,UAAAA,EAAgC,KAAAiE,QAAAA,EAClDnF,KAAKg/F,iBACLh/F,KAAKi/F,kBAQCD,iBACNh/F,KAAKk/F,gBAAkB,IAAItiF,sBAAsBC,IAC/C,IAAI,MAAME,KAASF,EAAS,CAC1B,MAAMsiF,EAAapiF,EAAMqiF,mBACnBC,EAAetiF,EAAM5V,OAAOvD,cAC5B07F,EAAiBviF,EAAMwiF,WAG1BJ,EAAW7oE,OAASgpE,EAAez4F,KACpC7G,KAAKmF,SAAQ,EAAMk6F,GAIlBF,EAAW7oE,QAAUgpE,EAAez4F,KACnCs4F,EAAW7oE,OAASgpE,EAAehpE,QACrCt2B,KAAKmF,SAAQ,EAAOk6F,MAGvB,CAACG,UAAW,EAAGC,KAAMz/F,KAAKkB,YAGvB+9F,kBACNj/F,KAAK0/F,iBAAmB,IAAI9iF,sBAAsBC,IAChD,MAAME,EAAQF,EACb8O,QAAQ5O,GAAUA,EAAMqiF,mBAAmBv4F,IAAMkW,EAAMwiF,WAAW14F,MAClEy0C,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAEw4D,mBAAmBv4F,IAAMkkD,EAAEq0C,mBAAmBv4F,MAAK,GACrE,IAAIkW,EAAO,OAEX,MAAM7b,EAAY6b,EAAMC,eAAiBD,EAAM5V,OAAS4V,EAAM5V,OAAO+mC,mBACrEluC,KAAKmF,SAAQ,EAAMjE,KAClB,CAACu+F,KAAMz/F,KAAKkB,YAOTy+F,YAAYz+F,EAAwBvC,GAC1C,MAAMihG,EAAW9gG,SAASC,cAAc,OAExC,OADA6gG,EAASxgG,UAAUC,IAAI,kBAAmBV,GACnCuC,EAAUqD,YAAYq7F,GAQxBC,2BAA2Bz1F,GAChC,MAAM01F,EAAiB9/F,KAAK2/F,YAAYv1F,EAAS,wBACjDpK,KAAKk/F,gBAAgBvhF,QAAQmiF,GAE7B9/F,KAAK0/F,iBAAiB/hF,QAAQvT,GAGzBmT,aACLvd,KAAKk/F,gBAAgB3hF,aACrBvd,KAAK0/F,iBAAiBniF,aAGjBM,UAAUzT,EAAsB01F,GACrC9/F,KAAK0/F,iBAAiB7hF,UAAUzT,GAChCpK,KAAKk/F,gBAAgBrhF,UAAUiiF,I,eCrDpB,MAAMC,WAAwBvsE,YAU3C5zB,cACEC,QACAG,KAAKZ,UAAUC,IAtBA,YAuBfW,KAAK2S,SAAW,aAGPqtF,oBACT,OAAOhgG,KAAKigG,eAGHD,kBAAcA,GACvBhgG,KAAKigG,eAAiBD,EAGbjzF,YACT,OAAO/M,KAAKggG,cAAcjzF,MAGrBsC,KAAKpP,GACVD,KAAKC,KAAOA,EACZD,KAAKZ,UAAUC,IAAI,YAAmBY,GAGjCigG,oBAAoBC,GACzBngG,KAAKmgG,iBAAmBA,EAGnB3vE,OAAO4vE,GACZ,MAAMC,IAAwBrgG,KAAKgxE,iBAC/BqvB,IACFrgG,KAAKgxE,iBAAmBlyE,SAASC,cAAc,OAC/CiB,KAAKgxE,iBAAiB5xE,UAAUC,IAAI,oBACpCW,KAAKN,OAAOM,KAAKgxE,mBAGnB,MAAMgvB,EAAgBhgG,KAAKggG,cAC3B,IAAII,IAAuBC,EAAqB,CAC9C,MAAMvlD,EAAoB96C,KAAK2S,SAASwnC,oBAAoBmmD,YAAYN,EAAcjlD,WACtF,EAAAwlD,GAAA,GAAYzlD,GAAoBA,I,MAC1BA,EAAkB0lD,aACpBxgG,KAAKgxE,iBAAiB5xE,UAAUC,IAAI,aAGnCy7C,EAAkBtiC,OAAO+jC,UAC1Bv8C,KAAKZ,UAAUC,IAAI,eAGrB,MAAM2B,EAAqB,WAAdhB,KAAKC,KAjEG,GACD,GAiEdwgG,EAAczgG,KAAK0gG,mBAAqB,GAAY,CACxDr8F,IAAKrE,KAAKgxE,iBACVx2C,IAAkC,QAA7B,EAAAsgB,EAAkB0lD,mBAAW,QAAI1lD,EAAkBI,YACxD35C,MAAOP,EACPQ,OAAQR,EACRyiB,QAAQ,EACR9Q,SAAU3S,KAAK2S,WACdjR,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQtF,SAAQ,KACjClrB,KAAK0gG,qBAAuBD,IAC7BzgG,KAAK0gG,wBAAqB12F,UAO7B22F,gB,MACL,MAAMX,EAAgBhgG,KAAKggG,cACrBY,EAA0B,WAAd5gG,KAAKC,KAjFuB,EACD,EAiF7C,GAAG+/F,EAAcjzF,OAAS6zF,GAA4B,UAAd5gG,KAAKC,OAAqBD,KAAKmgG,iBAAmB,CACpFngG,KAAKytE,UACPztE,KAAKytE,QAAU3uE,SAASC,cAA4B,WAAdiB,KAAKC,KAAoB,IAAM,QACrED,KAAKytE,QAAQruE,UAAUC,IAAI,qBAG7B,MAAMm+C,EAAYu3C,GAAaiL,EAAcjzF,OAC1C/M,KAAKytE,QAAQ96C,cAAgB6qB,IAC9Bx9C,KAAKytE,QAAQ96C,YAAc6qB,GAGzBx9C,KAAKytE,QAAQ7pE,eACf5D,KAAKN,OAAOM,KAAKytE,cAEC,QAAZ,EAAAztE,KAAKytE,eAAO,eAAE7pE,iBACtB5D,KAAKytE,QAAQntE,SACbN,KAAKytE,aAAUzjE,GAIZ62F,cAAcC,GACF,WAAd9gG,KAAKC,OAILD,KAAKggG,cAAcjzF,OA1GuB,IA0GwB/M,KAAKmgG,iBACrEngG,KAAK6zD,iBACN7zD,KAAK6zD,eAAe3yD,UAAUZ,SAC9BN,KAAK6zD,oBAAiB7pD,IAMtBhK,KAAK6zD,iBACP7zD,KAAK6zD,eAAiB,IAAI/E,GAAe,CACvCvhD,WAAY,KAGdvN,KAAKN,OAAOM,KAAK6zD,eAAe3yD,YAGlClB,KAAK6zD,eAAerjC,OAAOswE,EAAgBnmF,KAAKogC,IAAa,EAAAjC,GAAA,GAAUiC,EAASgmD,cAG3EC,YAAYC,IAAajhG,KAAKggG,cAAcxnF,OAAO66C,QACvC,WAAdrzD,KAAKC,OACUD,KAAKZ,UAAUiG,SAAS,eAAiBrF,KAAKZ,UAAUiG,SAAS,gBAClE47F,IACf,QAAcjhG,KAAM,YAAaihG,EAAUjhG,KAAKqK,YAAc,IAAM,GAIjE62F,uBACL,EAAAX,GAAA,GAAYvgG,KAAK2S,SAASwnC,oBAAoBmmD,YAAYtgG,KAAKggG,cAAcjlD,WAAYD,IACvF,MAAM95C,EAAqB,WAAdhB,KAAKC,KAAoBkhG,GAA4BC,GAC5D/8F,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,6BAElB8D,QAAQC,IAAI,CACV,GAAY,CACViB,IAAKA,EACLm2B,IAAKsgB,EAAkB0lD,YACvBj/F,MAAOP,EACPQ,OAAQR,EACR0jC,WAAW,EACXe,aAAa,EACbpjC,MAAM,EACNkiC,UAAW,EACXpE,MAAO,OACP9Y,YAAY,EACZ1U,SAAU3S,KAAK2S,WACdjR,MAAK,EAAE8uB,OAAAA,KAAYA,IAEtB6T,GAAqB,CACnB7J,IAAKsgB,EAAkBumD,iBACvBrgG,KAAM,GACNmG,OAAQnH,KAAKgxE,iBACb1sC,KAAM,SACNC,UAAW,EACXliC,MAAM,EACNsQ,SAAU3S,KAAK2S,WACd8xB,iBACF/iC,MAAK,EAAE4/F,EAAYC,MACpB,MAAMjhG,EAAS,MAEb,UAAQ,KAENghG,EAAWhhG,SACX+D,EAAI/D,SACJN,KAAKgxE,iBAAiB5xE,UAAUkB,OAAO,qBAI3CghG,EAAWlhG,iBAAiB,cAAewkC,IACtCA,IAAY08D,EAAWz8D,WACrB7kC,KAAK0gG,mBACN1gG,KAAK0gG,mBAAmBh/F,MAAK,KAC3B0E,WAAW9F,EAAQ,QAGrBA,QAKNghG,EAAWlhG,iBAAiB,cAAc,KACxCJ,KAAKgxE,iBAAiBtxE,OAAO2E,GAC7BrE,KAAKgxE,iBAAiB5xE,UAAUC,IAAI,iBACpCiiG,EAAWj/F,OACXk/F,EAAal/F,SACZ,CAACmF,MAAM,WAMlBwtB,eAAeC,OA3ME,mBA2Me8qE,ICjNhC,MAGMyB,GAAyD,IAAIvwF,IAGpD,MAAMwwF,WAAyBjuE,YAS5C5zB,cACEC,QACAG,KAAKZ,UAAUC,IAjBA,aAkBfW,KAAKq7D,OAAS,GACdr7D,KAAK2S,SAAW,aAGlB8gB,oBACE,IAAIxW,EAAMukF,GAAmBhwF,IAAIxR,KAAK6P,KAClCoN,GACFukF,GAAmBvkF,IAAIjd,KAAK6P,IAAKoN,EAAM,IAAI2B,KAG7C3B,EAAI5d,IAAIW,MAELA,KAAK0hG,mBAAqB1hG,KAAKqK,cAChCrK,KAAK0hG,oBACL1hG,KAAK0hG,uBAAoB13F,GAI7B0pB,uBACE,MAAMzW,EAAMukF,GAAmBhwF,IAAIxR,KAAK6P,KACxCoN,EAAIvN,OAAO1P,MACPid,EAAIjc,MACNwgG,GAAmB9xF,OAAO1P,KAAK6P,KAI5B8xF,iBAAiBC,GACtB,OAAO5hG,KAAKq7D,OAAOr7D,KAAKq7D,OAAO7kD,QAAQorF,IAAkB5B,cAGpD6B,aACL,OAAO7hG,KAAKqN,QAGPgC,KAAKhC,EAA0BpN,EAA0B6hG,QAC9C93F,IAAbhK,KAAK6P,KACN7P,KAAK0zB,uBAGP1zB,KAAKqN,QAAUA,EACfrN,KAAK6P,IAAM7P,KAAKqN,QAAQd,OAAS,IAAMvM,KAAKqN,QAAQJ,IACpDjN,KAAK8hG,cAAgBA,EAElB9hG,KAAKC,OAASA,IACfD,KAAKC,KAAOA,EACZD,KAAKZ,UAAUC,IAAI,aAAmBY,IAGxCD,KAAKyzB,oBAGAsuE,cAAc10F,GACnB,OAAOrN,KAAKqP,KAAKhC,EAASrN,KAAKC,KAAMD,KAAK8hG,eAGrCzpE,OAAOhrB,EAA0B20F,GACtChiG,KAAKqN,QAAUA,EACfrN,KAAKwwB,OAAOwxE,GAGPxxE,OAAOwxE,GACZ,MAAMxlD,EAAYx8C,KAAKqN,QAAQmvC,UACzBylD,KAAkBzlD,IAAaA,EAAUjyB,QAAQ5pB,QAEvD,GADAX,KAAKZ,UAAUoE,OAAO,oBAAqBy+F,IACvCA,IAAiBjiG,KAAKq7D,OAAO16D,OAAQ,OAEzC,MAAMuhG,EAA2BliG,KAAK2S,SAASwnC,oBAAoBmC,wBAE3D13B,EAASq9E,EACbC,aAAoC/+F,QAClCq5C,EAAUjyB,QACViyB,EAAUjyB,QAAQoB,QAAQq0E,GACjBhgG,KAAK2S,SAASwnC,oBAAoBgoD,iBAAiBnC,EAAcjlD,YAE1E,IAEJ,EAAAwtC,GAAA,GAAevoF,KAAKq7D,QAAQ,CAACumC,EAAiBvjF,EAAKuC,KACjD,MAAMm6B,EAAW6mD,EAAgB5B,cAAcjlD,SACjCn2B,EAAOw9E,MAAMpC,GAAkBA,EAAcjlD,WAAaA,MAEtEn6B,EAAIrC,OAAOF,EAAK,GAChBujF,EAAgBthG,aAIpB,MAAM+hG,EAAiBz9E,EAAO9D,QAAO,CAACC,EAAKjK,IAAMiK,EAAMjK,EAAE/J,OAAO,GAC1DozF,EAAmB3jD,KAAeA,EAAUhkC,OAAO8pF,cAAgBD,ED7F9B,ECuI7C,GAzCEriG,KAAKq7D,OAASz2C,EAAOjK,KAAI,CAACqlF,EAAe3hF,KACvC,MAAMkkF,EAAqBviG,KAAKq7D,OAAO/8C,WAAWsjF,GAAoBA,EAAgB5B,cAAcjlD,WAAailD,EAAcjlD,WAC/H,IAAI6mD,GAA0C,IAAxBW,GAA6BviG,KAAKq7D,OAAOknC,GAC3DX,IACFA,EAAkB,IAAI7B,GACtB6B,EAAgBvyF,KAAKrP,KAAKC,OAG5B66D,GAAuB8mC,EAAiB5hG,KAAMqe,GAE9C,MAAMyiF,EAAkBtkD,EAAUgmD,iBAAmBhmD,EAAUgmD,iBAAiB72E,QAAQovB,GAAaA,EAASA,WAAailD,EAAcjlD,WAAY,GAQrJ,OAPA6mD,EAAgB5B,cAAgB,OAAH,UAAOA,GACpC4B,EAAgB1B,oBAAoBC,GACpCyB,EAAgBpxE,OAAOxwB,KAAK8hG,eAC5BF,EAAgBjB,gBAChBiB,EAAgBf,cAAcC,GAC9Bc,EAAgBZ,cAETY,MAWL5hG,KAAK8hG,gBAAiBE,MAAAA,OAAc,EAAdA,EAAgBrhG,UACrCX,KAAKqK,YACNrK,KAAKyiG,qBAAqBT,GAE1BhiG,KAAK0hG,kBAAoB,KACvB1hG,KAAKyiG,qBAAqBT,MAO9BhiG,KAAKq7D,OAAO16D,QAAwB,UAAdX,KAAKC,KAAkB,CAC/C,MAAM2D,EAAgB5D,KAAK4D,cAG3B,GAFA5D,KAAKM,SAEFsD,EAAcxE,UAAUiG,SAAS,sBAAwBzB,EAAc8+F,WAAW/hG,OAEnF,YADAiD,EAActD,SAIhB,MAAMqiG,EAAW3iG,KAAKkF,cAAc,SACjCy9F,GACD/+F,EAAclE,OAAOijG,IAKnBF,qBAAqBT,GAExBhiG,KAAKqN,QAAQd,SAAW,gBAE3By1F,EAAe50F,SAAS4yF,IACtB,MAAM4B,EAAkB5hG,KAAKq7D,OAAOjpD,MAAMwvF,GAAoBA,EAAgB5B,cAAcjlD,WAAailD,EAAcjlD,WACpH6mD,GACDA,EAAgBV,0BAMxBlsE,eAAeC,OA9KE,oBA8KewsE,IC1KhC,qBAA2B,mBAAoBp0F,IAC5C+D,MAAMC,KAAKvS,SAASwS,iBAA4B,kCAAmBjE,EAAQd,UAAUc,EAAQJ,UAA+BG,SAAShD,IACpIA,EAAQiD,QAAUA,EAClBjD,EAAQomB,eAIG,MAAMoyE,WAAuBpvE,YAW1C5zB,cACEC,QAHM,KAAAgjG,SAAU,EAIhB7iG,KAAK2S,SAAW,aAGXtD,OACLrP,KAAKwwB,SACLxwB,KAAK4H,QAAQk7F,QAAU9iG,KAAKqN,QAAQd,OAAS,IAAMvM,KAAKqN,QAAQJ,IAChEjN,KAAKZ,UAAUC,IAAI,UAAW,WAAaW,KAAKC,MAG3CuwB,SACL,MAAMtC,EAAUluB,KAAKqN,QAAQ6gB,QAM7B,GAAiB,WAAdluB,KAAKC,KAAmB,CACzB,IAAI8iG,EACD/iG,KAAK+oB,oBACNg6E,EAAW/iG,KAAK+oB,oBAGfmF,MAAAA,OAAO,EAAPA,EAAS80E,kBACPD,IAAaA,EAAS3jG,UAAUiG,SAAS,4BAC1CrF,KAAKsE,UAAY,GACjBy+F,EAAW,MAGT/iG,KAAK6zD,iBACP7zD,KAAK6zD,eAAiB,IAAI/E,GAAe,CACvCrgC,cAAezuB,KAAKyuB,cACpBlhB,WAAY,KAGdvN,KAAK6zD,eAAe3yD,UAAU9B,UAAUC,IAAI,2BAG9C0jG,EAAW/iG,KAAK6zD,eAAe3yD,UAE/BlB,KAAK6zD,eAAerjC,OAAOtC,EAAQ80E,gBAAgBroF,KAAK45B,IAAS,EAAAuE,GAAA,GAAUvE,KAAQv0C,KAAK4uB,gBAErFm0E,IAAaA,EAAS3jG,UAAUiG,SAAS,oBAC1C09F,EAASziG,SACTyiG,EAAW,MAGTA,IACFA,EAAWjkG,SAASC,cAAc,QAClCgkG,EAAS3jG,UAAUC,IAAI,oBAIvB0jG,EAASn/F,eACX5D,KAAK6D,QAAQk/F,GAGX/iG,KAAKP,OACPO,KAAKP,KAAO,IAAI,kBAGlB,MAAMA,EAAOO,KAAKP,KAWlB,GAVGyuB,EACEA,EAAQA,QACTzuB,EAAKswF,iBAAiB,CAAClgF,IAAK,WAAYT,KAAM,CAAC8e,EAAQA,WAEvDzuB,EAAKswF,iBAAiB,CAAClgF,IAAK,kBAG9BpQ,EAAKswF,iBAAiB,CAAClgF,IAAK,eAG3Bqe,EAAS,CAEV,IAAI+0E,GAAW,EACZ/0E,EAAQA,cACkBlkB,IAAxBkkB,EAAQg1E,kBAAgDl5F,IAAnBkkB,EAAQi1E,SAC9CF,EAAW/0E,EAAQg1E,YAAch1E,EAAQi1E,QAK7CnjG,KAAKZ,UAAUoE,OAAO,YAAay/F,GAGrC,IAAIG,EAAWpjG,KAAK8lB,SAAS,GAC7B,IAAIs9E,EAAU,CACZA,EAAWtkG,SAASC,cAAc,QAClCqkG,EAAShkG,UAAUC,IAAI,uBAEvB,MAAMgkG,EAAWvkG,SAASC,cAAc,QACxCskG,EAASjkG,UAAUC,IAAI,cAEvB,MAAMikG,EAAkBxkG,SAASC,cAAc,QAC/C,EAAA8F,GAAA,GAAOy+F,GAEPtjG,KAAKN,OAAO0jG,EAAUC,EAAUC,IAGlC,EAAA11F,EAAA,GAAew1F,EAAU3jG,EAAK2K,cAE9BpK,KAAKZ,UAAUC,IAAI,wBACnBW,KAAKsE,UAAY,iFAAgF4pB,MAAAA,OAAO,EAAPA,EAASA,SAAU6mE,GAAa7mE,EAAQA,QAAS,GAAK,aAGtJA,GAAYluB,KAAK6iG,SAAY7iG,KAAKqN,QAAQmL,OAAOqiB,cAClD76B,KAAK2S,SAAS40B,mBAAmBg8D,uBAAuBvjG,KAAKqN,QAAQd,OAAQvM,KAAKqN,QAAQJ,KAC1FjN,KAAK2S,SAAS40B,mBAAmBi8D,cAAcxjG,KAAKqN,QAAQd,OAAQvM,KAAKqN,QAAQJ,IAAK,mBACtFjN,KAAK6iG,SAAU,GAGd7iG,KAAK4uB,eACN5uB,KAAK4uB,kBAAe5kB,IAK1BgrB,eAAeC,OA1IE,kBA0Ie2tE,ICtIhC,MAEMa,GAAa,KACjB,MAAMC,EAAS5kG,SAASC,cAAc,KAGtC,OAFA2kG,EAAOtkG,UAAUC,IAAI,WACrB,QAAMqkG,EAAQ,iBACPA,GAGHC,GAAgB,KAAM,QAAK,oBAE1B,IAAUC,IAAjB,SAAiBA,GAKF,EAAAxsF,QAAWxY,I,MAKtB,MAAM,SAACilG,EAAQ,QAAEx2F,GAAWzO,EACtBuU,EAAO,IAAIzN,KAAoB,IAAf2H,EAAQ8F,MACxB/D,EAAiC,GAEvC,IAAI00F,EAAyBC,EAA4BC,EAAoCC,EAE7F,MAAMC,IAAiB72F,EAA4BmL,OAAO2rF,UACpDC,IAAc,WAAY/2F,KAAa62F,EAC7C,IAAIjC,EAEA/tF,EAAoBgwF,OAAcl6F,EAAY6K,EAAW1B,GAC7D,GAAGixF,EAAW,CACZ,GAAG/2F,EAAQg3F,MAAO,CAChB,MAAMC,EAAaj3F,EAAQk3F,cAA+B,QAAhB,EAAAl3F,EAAQ2qB,gBAAQ,eAAEusE,aAEtDC,EAAgB1lG,SAASC,cAAc,QAC7CylG,EAAcplG,UAAUC,IAAI,cAC5BmlG,EAAclgG,UAAYywF,GAAa1nF,EAAQg3F,MAAO,GAEtD,MAAMI,EAAe3lG,SAASC,cAAc,KAI5C,GAHA0lG,EAAarlG,UAAUC,IAAI,qBAAsB,aAEjD+P,EAAKyC,KAAK2yF,EAAeC,GACtBH,EAAY,CACb,MAAM/6F,EAAOzK,SAASC,cAAc,SACpC,EAAA45B,EAAA,GAAapvB,GAAM,EAAAqvB,GAAA,GAAc0rE,IACjC/6F,EAAK/E,mBAAmB,YAAa,WACrC4K,EAAKyC,KAAKtI,IAQd,GAJG8D,EAAQq3F,WAA0B,cAAbb,IAA6Bx2F,EAAQmL,OAAOmsF,WAClEv1F,EAAKiQ,QAAQykF,EAAaL,MAGZ,WAAbI,GAAyBx2F,EAAQmL,OAAOosF,OAAQ,CACjD,MAAM74F,EAAIjN,SAASC,cAAc,KACjCgN,EAAE3M,UAAUC,IAAI,mBAAoB,aACpC+P,EAAKiQ,QAAQtT,GAGU,aAAtBsB,EAAQ0zF,QAAQn0F,IACjBq1F,GAAe,EAEfgC,EAAmBrlG,EAAQqlG,iBAC3BD,EAAmB,IAAIvC,GACvBuC,EAAiB30F,KAAK40F,EAAkB,UAAU,GAClDD,EAAiBxzE,SACjBphB,EAAKiQ,QAAQ2kF,SAEPE,GACR90F,EAAKyC,KAAKkyF,EAAgBJ,MAGzBzvF,GACD9E,EAAKyC,KAAKqC,GAGZ,IAAIpF,EAAQo1F,OAAcl6F,EAAYoL,EAAYjC,GAC/CixF,IACDt1F,IAAUzB,EAAQq3F,YAAcr3F,EAAQmL,OAAOmsF,UAAY,aAAavvF,EAAY,IAAI1P,KAAyB,IAApB2H,EAAQq3F,cAAuB,KACvHr3F,EAAQ2qB,SAAW,eAAe5iB,EAAY,IAAI1P,KAA6B,IAAxB2H,EAAQ2qB,SAAS7kB,SAAkB,KAGjG,MAAMwvF,EAAW7jG,SAASC,cAAc,QACxC4jG,EAASvjG,UAAUC,IAAI,OAAQ,SAE/BsjG,EAASjjG,UAAU0P,GAEnB,MAAMy1F,EAAQ/lG,SAASC,cAAc,OACrC8lG,EAAMzlG,UAAUC,IAAI,QAAS,SAC1ByP,IAAO+1F,EAAM/1F,MAAQA,GAExB,IAAIg2F,EAAa11F,EAOjB,GANG00F,IACDgB,EAAWA,EAAWtuF,QAAQstF,IAAeL,MAE5CM,IACDe,EAAWA,EAAWtuF,QAAQutF,IAAkBJ,MAE/CK,EAAkB,CACnB,MAAMe,EAAoBD,EAAWA,EAAWtuF,QAAQwtF,IAAqB,IAAIvC,GACjFsD,EAAkB11F,KAAK40F,EAAkB,UACzCc,EAAkBv0E,SAUpB,OARAs0E,EAAaA,EAAWnqF,KAAKisB,GAAMA,aAAapT,cAAgBoT,EAAExnC,UAAUiG,SAAS,UAAYuhC,EAAExnC,UAAUiG,SAAS,aAAeuhC,EAAE7iC,WAAU,GAAuB6iC,IACrK1yB,IACD4wF,EAAWA,EAAWnkG,OAAS,GAAKkU,EAAW1B,IAEjD0xF,EAAMnlG,UAAUolG,GAEhBnC,EAASjjG,OAAOmlG,GAETlC,GAGI,EAAAqC,cAAgB,EAAE39D,OAAAA,EAAQ49D,gBAAAA,EAAiB53F,QAAAA,EAAS63F,WAAAA,EAAYt2E,aAAAA,EAAcH,cAAAA,MAQzF,MAAM02E,GAAY99D,EAAOjoC,UAAUiG,SAAS,aAAegiC,EAAOjoC,UAAUiG,SAAS,eAAiBgiC,EAAOjoC,UAAUiG,SAAS,SAC1H+/F,EAAgB,IAAIxC,GAO1B,OANAwC,EAAc/3F,QAAUA,EACxB+3F,EAAcnlG,KAAOklG,EAAW,SAAW,SAC3CC,EAAcx2E,aAAeA,EAC7Bw2E,EAAc32E,cAAgBA,EAC9B22E,EAAc/1F,OACd41F,EAAgBphG,QAAQuhG,GACjBD,GAGI,EAAAE,SAAW,EAAOjjE,KAAAA,EAAMiF,OAAAA,EAAQ49D,gBAAAA,EAAiB53F,QAAAA,MAKxD,O,EAAA,K,OAAA,E,EAAA,YACJ,MAAMi4F,GAAeL,EAClBK,IACDL,EAAkB59D,EAAOniC,cAAc,oBAGzC,MAAMqgG,EAAkBD,EAAcL,EAAgB//F,cAAc,UAAY,KAChF,IAAImI,EAAQ0gB,aAMV,OALGw3E,GACDA,EAAgBjlG,cAGlB+mC,EAAOjoC,UAAUkB,OAAO,YAK1B,MAAMklG,EAAgBn4F,EAAQo4F,SAASC,kBAAmB,EAAA5sD,GAAA,GAAUzrC,EAAQo4F,SAASC,kBAAoBtjE,EAAK71B,OAE9G,IACIo5F,EAIAC,EALAzuC,QAAwB,iDAAuDquC,EAAen4F,EAAQ0gB,cAO1G,GAAIopC,EAMG,CACL,MAAM0uC,EAA4B1uC,EAAoC8gC,UACtE2N,EAAcv4F,EAAQ4qF,WAAa5qF,EAAQ4qF,YAAc4N,EAA2Bx4F,EAAQ4qF,UAAY9gC,EAAgB7pD,QAAUu4F,EAClIF,EAAoB,IAAIrtE,GAAU,CAChC/rB,OAAQq5F,EACRptE,QAAQ,EACRD,eAAe,EACfz4B,WAAW,IACVsK,aAZH,oDAA0DiD,GAC1D+0B,EAAKqJ,QAAQq6D,WAAWj0F,KAAK,CAAC2zF,cAAAA,EAAeO,SAAU14F,EAAQ0gB,aAAc9gB,IAAKI,EAAQJ,MAE1F04F,GAAoB,QAAK,WAY3B,MAAM,UAACzkG,EAAS,YAAE64D,GAAeH,GAAU+rC,OAAmB37F,EAAWmtD,EAAiB/0B,EAAKkqD,WAAasZ,OAAc57F,SACpH+vD,EACHwrC,EACDA,EAAgB9mE,YAAYv9B,GAE5B+jG,EAAgBvlG,OAAOwB,GAGzBmmC,EAAOjoC,UAAUC,IAAI,a,YAnDjB,K,+QAlIR,CAAiBukG,KAAAA,GAAa,K,cCxBvB,SAASoC,GAAkB9kG,EAAwBqlE,EAAgC0/B,GAExF,MAAMz/F,EAAOtF,EAAUuF,wBACjBO,EAAuB,WAAnBi/F,EAA8BtjG,KAAKoR,KAAKvN,EAAKG,MAASH,EAAK8+B,MAAQ9+B,EAAKG,MAAQ,EAAK,GAAKhE,KAAKoR,KAAKvN,EAAKG,KAAO,GACpHM,EAAqB,WAAjBs/D,EAA4B5jE,KAAK6uB,MAAMhrB,EAAKK,IAAML,EAAKhF,OAAS,GAAKmB,KAAKoR,KAAKvN,EAAKK,IAAM,GACpG,OAAO/H,SAASonG,iBAAiBl/F,EAAGC,GCPvB,SAASk/F,GAAwB/7F,GAC9CA,EAAQnH,MAAMC,QAAU,OACnBkH,EAAQ+6C,WACb/6C,EAAQnH,MAAMC,QAAU,GDO1B,uBAAmC8iG,GEhB5B,MAAMI,GAA6B,W,cCM3B,SAASC,GACtBj8F,EACAk8F,EACAC,EACA//F,EAAO4D,EAAQ3D,wBACf+/F,EAAeF,EAAgB7/F,yBAE/B,IAAKI,IAAK4/F,EAAanhE,MAAOohE,EAAepwE,OAAQqwE,EAAgBhgG,KAAMigG,GAAgBJ,EAG3F,GAAGD,EAAe,CAChB,MAAMM,EAASP,EAAgBphG,cAAc,WAC1C2hG,IAEDJ,EADmBI,EAAOpgG,wBACD6vB,QAI7B,GAAG9vB,EAAKK,KAAO8/F,GACVngG,EAAK8vB,QAAUmwE,GACfjgG,EAAK8+B,OAASshE,GACdpgG,EAAKG,MAAQ+/F,EAChB,OAAO,KAGT,MAAMI,EAAW,CACfjgG,KAAK,EACLy+B,OAAO,EACPhP,QAAQ,EACR3vB,MAAM,EACN4uB,SAAU,EACVwxE,WAAY,GAIRxmF,EAAS,mBAAoBza,OAASA,OAAOsqC,eAAiBtqC,OAC9DmgE,EAAc1lD,EAAEhf,OAASgf,EAAE8vB,WAC3B61B,EAAe3lD,EAAE/e,QAAU+e,EAAE+vB,YAEnC,MAAO,CACL9pC,KAAM,CACJK,IAAKL,EAAKK,IAAM4/F,GAA+B,IAAhBA,GAAqBK,EAASjgG,KAAM,IAAQigG,EAASvxE,SAAUkxE,GAAejgG,EAAKK,IAClHy+B,MAAO9+B,EAAK8+B,MAAQohE,GAAiBA,IAAkBzgC,GAAe6gC,EAASxhE,OAAQ,IAAQwhE,EAASC,WAAYL,GAAiBlgG,EAAK8+B,MAC1IhP,OAAQ9vB,EAAK8vB,OAASqwE,GAAkBA,IAAmBzgC,GAAgB4gC,EAASxwE,QAAS,IAAQwwE,EAASvxE,SAAUoxE,GAAkBngG,EAAK8vB,OAC/I3vB,KAAMH,EAAKG,KAAOigG,GAAiC,IAAjBA,GAAsBE,EAASngG,MAAO,IAAQmgG,EAASC,WAAYH,GAAgBpgG,EAAKG,MAE5HmgG,SAAAA,GAIHhhG,OAAeugG,eAAiBA,G,IClDrBW,GCeG,MAAMC,WAA4B,IAC/CrnG,YACUkrE,EACAo8B,GAERrnG,MAAM,0BAA0B,OAAgB,CAAC,CAC/C0rC,QAAS27D,EAAW1uF,OAAO2uF,eAAiB,qBAAwBD,EAAW1uF,OAAOu4B,UAAY,yBAA2B,uBAC7HjsC,SAAU,KACR9E,KAAK2S,SAASoH,gBAAgBqtF,iBAAiBt8B,GAC9CppE,MAAM2Y,IACL,MAAM9N,EAAS8N,EAAOQ,UAAS,GAC/B,gBAA0B,CAACtO,OAAAA,OACzBoB,IACgB,wBAAfA,EAAM1N,MACP2rC,GAAS,CAACC,YAAa,6BAI1B,CAACuK,UAAU,EAAMhJ,iBAAiB,EAAMxC,MAAM,IAhB3C,KAAAkgC,KAAAA,EACA,KAAAo8B,WAAAA,EAiBRlnG,KAAKyoB,YAGOA,Y,qCACZzoB,KAAK4O,OAAOtO,SAcZ,MAAM,WAAC4mG,EAAU,SAAEv0F,EAAQ,KAAEm4D,GAAQ9qE,KAE/B4oC,EAAa,IAAI0E,GACvB1E,EAAWxpC,UAAUC,IAAI,cACzBupC,EAAW2E,UAAW,EACI,UAAvB25D,EAAWrnF,MAAMjT,GAClBs6F,EAAWrnF,YAAclN,EAASmxC,iBAAiBujD,UAAUH,EAAWrnF,OACxEyO,GAAU,CACRptB,UAAW0nC,EACXv7B,QAAS,KACTwS,MAAOqnF,EAAWrnF,MAClBE,UAAW,IACXD,SAAU,IACV6O,kBAAkB,IAEpBia,EAAW3lC,MAAM1B,MAAQqnC,EAAW3lC,MAAMzB,OAAS,IAEnDo/C,GAAShY,EAAY,OAAc,EAAOs+D,EAAWp4F,OAGvD,MAAMA,EAAQhQ,SAASC,cAAc,OACrC+P,EAAM1P,UAAUC,IAAI,eACpB,EAAAs5B,EAAA,GAAa7pB,GAAO,EAAA8pB,GAAA,GAAcsuE,EAAWp4F,QAG7C,MAAMs/B,EAAc84D,EAAW1uF,OAAOu4B,UAChCu2D,GAAc,QAAKl5D,EAAc,cAAgB,UAAW,CAACqC,GAAuBy2D,EAAWr2D,sBAKrG,GAJAy2D,EAAYloG,UAAUC,IAAI,2BAE1BW,KAAK4qC,KAAKlrC,OAAOkpC,EAAY95B,EAAOw4F,GAEjCJ,EAAW1uF,OAAO2uF,eAAgB,CACnC,MAAMh4D,EAAUrwC,SAASC,cAAc,QACvC,QAAMowC,EAASf,EAAc,kCAAoC,iCACjEe,EAAQ/vC,UAAUC,IAAI,0BAA2B,mBAEjDW,KAAK4qC,KAAKlrC,OAAOyvC,GAGnBnvC,KAAKkvC,Q,iSD5FT,SAAY83D,GACV,yBACA,mCACA,iCACA,6BACA,+BACA,6CANF,CAAYA,KAAAA,GAAkB,K,eEMf,MAAMO,GAYnB3nG,YACUkM,EACAH,EACAwuB,GAFA,KAAAruB,WAAAA,EACA,KAAAH,MAAAA,EACA,KAAAwuB,QAAAA,EAKEj5B,gBACV,OAAOlB,KAAK8L,WAAW5K,UAGlBsmG,WACL,MAAO,CACLzhC,aAAc/lE,KAAK+lE,aACnBthB,UAAWzkD,KAAKykD,UAChBgjD,aAAcznG,KAAKynG,cAIhBC,eACL,MAAM,UAACxmG,GAAalB,KACd2nG,EAAgBzmG,EAAUuF,wBAC1BglC,EAAUr6B,MAAMC,KAAKnQ,EAAUoQ,iBAAiBtR,KAAK2L,QACrDsuB,EAAoC,GAC1C,IAAI,MAAMoN,KAAUoE,EAAS,CAC3B,MAAMm8D,EAAcvgE,EAAO5gC,wBAE3B,GADoB4/F,GAAeh/D,EAAQnmC,OAAW8I,EAAW49F,EAAaD,GAE5E1tE,EAASpoB,KAAK,CAACzH,QAASi9B,EAAQ7gC,KAAMohG,SAEjC,GAAG3tE,EAASt5B,OACjB,MAIJ,IAAIs5B,EAASt5B,OAAQ,CACnB,MAAM0mC,EAASoE,EAAQ,GACpBpE,GACDpN,EAASpoB,KAAK,CAACzH,QAASi9B,EAAQ7gC,KAAM6gC,EAAO5gC,0BAIjD,OAAOwzB,EAGF4tE,aAAax2F,EAAmBixB,GACrC,IAAItiC,KAAKi6B,SACP,OAGF,MAAM5b,EAAMre,KAAKi6B,SAAS3b,WAAU,EAAElU,QAAAA,KAAaiH,IAASjH,KAChD,IAATiU,IACDre,KAAKi6B,SAAS5b,GAAKjU,QAAUk4B,GAI1BwlE,qBACL9nG,KAAKi6B,SAAWj6B,KAAK0nG,eAGhBpkE,OACLtjC,KAAK8nG,qBAEL9nG,KAAK+nG,QAGAA,QACL,MAAM,UAACtjD,EAAS,aAAEshB,EAAY,aAAE0hC,GAAgBznG,KAAKkB,UAIrDlB,KAAK+lE,aAAeA,EACpB/lE,KAAKykD,UAAYA,EACjBzkD,KAAKynG,aAAeA,EACpBznG,KAAKgoG,qBAAuBhoG,KAAKm6B,QAAU4rC,EAAethB,EAAYA,EAUhEwjD,UAAUC,GACb,GAAAv7E,WAAau7E,GACd/B,GAAwBnmG,KAAKkB,WAIzBinG,aAAaC,EAAsBF,GAGzCloG,KAAK8L,WAAWu8F,qBAAqBroG,KAAKykD,UAAY2jD,GAItDpoG,KAAKioG,UAAUC,GAGVI,QAAQJ,G,MACb,MAAM,UAACzjD,EAAS,aAAEshB,GAAgB/lE,KAAK8L,WAGvC,IAAIwtB,EAUJ,GAZAt5B,KAAK+lE,aAAeA,EAUpBzsC,EAASt5B,KAAKi6B,SAASj6B,KAAKi6B,SAASt5B,OAAS,KAE3B,QAAf,EAAA24B,MAAAA,OAAM,EAANA,EAAQlvB,eAAO,eAAExG,iBACnB5D,KAAK8nG,qBACLxuE,EAASt5B,KAAKi6B,SAASj6B,KAAKi6B,SAASt5B,OAAS,IAE1C24B,GAEF,YADAt5B,KAAKuoG,SAASL,GAKlB,MAAM,QAAC99F,EAAO,KAAE5D,GAAQ8yB,EAElBzgB,EADUzO,EAAQ3D,wBACH6vB,OAAS9vB,EAAK8vB,OACnCt2B,KAAKmoG,aAAa1jD,EAAY5rC,EAAMqvF,GAK/BK,SAASL,GACd,MAAOF,qBAAsBQ,EAA4B,WAAE18F,GAAc9L,KAMnE+lE,EAAe/lE,KAAK+lE,aAsBpBqiC,EAAepoG,KAAKm6B,QAAU4rC,EAAeyiC,EAA+BA,EAMlFxoG,KAAKmoG,aAAaC,EAAcF,IAQpC,OAAmB,iBAA6BX,IC/LjC,MAAMkB,GAMnB7oG,YAAYyP,GACVrP,KAAK0oG,UAAY,IAAIz3F,IACrBjR,KAAK2oG,eAAiB,IAAI13F,IAC1BjR,KAAK4oG,qBAAsB,EAE3B5oG,KAAK2c,SAAW,IAAIC,sBAAsBC,IACxC,MAAM6rF,EAAY1oG,KAAK0oG,UACvB,IAAI,IAAI38F,EAAI,EAAGpL,EAASkc,EAAQlc,OAAQoL,EAAIpL,IAAUoL,EAAG,CACvD,MAAMgR,EAAQF,EAAQ9Q,GAChB88F,EAAYH,EAAUl3F,IAAIuL,EAAM5V,QAKtC,IAAI,MAAMrC,KAAY+jG,EACpB,IACE/jG,EAASiY,GACT,MAAMtP,GACNC,QAAQC,MAAM,uCAAwCF,OAI3D4B,GAGEkO,aACLvd,KAAK0oG,UAAU39F,QACf/K,KAAK2oG,eAAe59F,QACpB/K,KAAK2c,SAASY,aAGTurF,mBAAmBtoG,GACxB,GAAGR,KAAK4oG,sBAAwBpoG,EAC9B,OAGFR,KAAK4oG,oBAAsBpoG,EAE3B,MAAMke,EAAQ1e,KAAK2oG,eACnB,IAAInoG,GAASke,EAAM1d,KAAM,CACvB,IAAI,MAAOmG,EAAQ0hG,KAAcnqF,EAC/B,IAAI,MAAM5Z,KAAY+jG,EACpB7oG,KAAK2d,QAAQxW,EAAQrC,GAIzB4Z,EAAM3T,SAIHonC,IAAIhrC,EAA4BrC,EAAgC4jG,EAAY1oG,KAAK0oG,WACtF,MAAMG,EAAYH,EAAUl3F,IAAIrK,GAChC,SAAU0hG,IAAaA,EAAU12D,IAAIrtC,IAGhC6Y,QAAQxW,EAA4BrC,GACzC,GAAG9E,KAAK4oG,qBAAuB5oG,KAAKmyC,IAAIhrC,EAAQrC,GAC9C,OAGF,MAAM4jG,EAAY1oG,KAAK4oG,oBAAsB5oG,KAAK2oG,eAAiB3oG,KAAK0oG,UACxE,IAAIG,EAAYH,EAAUl3F,IAAIrK,GAC3B0hG,GAAaA,EAAU12D,IAAIrtC,KAI1B+jG,IACFA,EAAY,IAAIjqF,IAChB8pF,EAAUzrF,IAAI9V,EAAQ0hG,GAEnBH,IAAc1oG,KAAK0oG,WACpB1oG,KAAK2c,SAASgB,QAAQxW,IAI1B0hG,EAAUxpG,IAAIyF,IAGT+Y,UAAU1W,EAA4BrC,GAC3C,MAAM4jG,EAAY1oG,KAAK4oG,sBAAwB5oG,KAAKmyC,IAAIhrC,EAAQrC,GAAY9E,KAAK2oG,eAAiB3oG,KAAK0oG,UACjGG,EAAYH,EAAUl3F,IAAIrK,GAC5B0hG,IAIJA,EAAUn5F,OAAO5K,GACb+jG,EAAU7nG,OACZ0nG,EAAUh5F,OAAOvI,GACjBnH,KAAK2c,SAASkB,UAAU1W,MCnGf,SAAS4hG,GAAgB17F,G,MACtC,IAAIA,EACF,OAAO,EAGT,MAAMmtB,EAA+E,QAAxE,EAACntB,EAA4B2gB,aAA2C,eAAElvB,SACvF,SACEuO,EAAQmL,OAAOwiB,eACf3tB,EAAQmL,OAAOwwF,WAEZxuE,GACC,CAAC,QAAS,SAAkCpzB,SAASozB,EAAIv6B,O,qCCTlD,SAASgpG,GAAkBv6E,EAA2Bw6E,EAAiB,IACpF,OAAWp/F,IACT,KAAKA,aAAmB3G,SAAU,CAChC,GAAG2G,aAAmBg2B,MACpB,MAAMh2B,EAEN,OAAOA,EAIX,OAAQA,EAAgCpI,MAAM4N,IAC5C,IAAIof,IACF,MAAMw6E,EAGR,OAAO55F,M,qCClBE,SAAS65F,GAAwB3jE,GAC9C,MAAO,CACL54B,EAAG,qBACHoX,OAAQ,EACRrjB,OAAQ6kC,EAAM7kC,OACdyoG,SAAS,SAAa5jE,GAAO7hB,KAAK,KAAKljB,QAAQ,UAAW,KCmB9D,MAAM,GAA0B,IAAIme,IAC7B,SAASyqF,GAAY7jE,EAAetkC,EAAwB2C,GAAU,EAAOylG,GAAQ,G,MAK1F,MAAMC,EAAYzqG,SAASC,cAAc,QAGzC,IAAIyqG,EAiBJ,GAnBAD,EAAUnqG,UAAUC,IAAI,eAGrBiqG,IAAU,KACXE,EC7BW,SAAyBhkE,GACtC,OAAO,EAAAijB,GAAA,GAAajjB,EAAO,CACzBytB,SAAU,CAACk2C,GAAwB3jE,MD2B7BikE,CAAgBjkE,IAEtBA,GAAQ,EAAAkkE,GAAA,GAASlkE,GACjBgkE,GAAM,EAAA5wE,GAAA,GAAc4M,IAUtB+jE,EAAU7pG,OAAO8pG,GAEdD,EAAUzjF,SAASnlB,OAAS,EAAG,CAChC,MAAM0jB,EAAQklF,EAAUxgF,kBACxBwgF,EAAUjlG,UAAY,GACtBilG,EAAU7pG,OAAO2kB,GAGnB,GAA4C,SAAd,QAA3B,EAAAklF,EAAUxgF,yBAAiB,eAAE1hB,SAAmB,CACjD,MAAM+f,EAAQmiF,EAAUxgF,kBAElBzC,EAAMc,EAAMX,IAClB,IAAI,GAAW0rB,IAAI7rB,GAAM,CACvBc,EAAM5nB,aAAa,UAAW,QAC9B,MAAMuO,EAAcjP,SAASC,cAAc,QAC3CgP,EAAY3O,UAAUC,IAAI,qBAEvB,iCACD+nB,EAAMnkB,MAAM0gE,QAAU,IACtB51D,EAAY9K,MAAM0gE,QAAU,KAG9Bv8C,EAAMhnB,iBAAiB,QAAQ,MAC7B,UAAQ,KACH,iCACDgnB,EAAMnkB,MAAM0gE,QAAU,GACtB51D,EAAY9K,MAAM0gE,QAAU,IAG9B4lC,EAAUnqG,UAAUkB,OAAO,SAE3B,GAAWjB,IAAIinB,QAEhB,CAAC9e,MAAM,IAEV+hG,EAAU7pG,OAAOqO,IAMlBlK,EAAS3C,EAAU2C,QAAQ0lG,GACzBroG,EAAUqD,YAAYglG,GAGtB,SAASI,GAAoBv/F,GAClC,OAAI,EAAAuvB,GAAA,GAAgBvvB,EAAS,eAEL,IAArBA,EAAQw/F,SAAuBx/F,EAAQy/F,WACnB,SAApBz/F,EAAQ/C,UAAuB+C,EAAQhL,UAAUiG,SAAS,UAAY+E,EAAQ2e,oBAC/E3e,EAAUA,EAAQ2e,mBAGb3e,EAAQ+xE,aAAa,QAAU/xE,EAAQ60B,WAPM,GAUvC,MAAM6qE,GAYnBlqG,YAAoB+S,GAAA,KAAAA,SAAAA,EAHZ,KAAAo3F,eAAiB,EA+KzB,KAAAC,eAAkB3pG,KAChB,EAAA4nB,EAAA,GAAY5nB,GAEZ,MAAMmlC,EAAQmkE,GAAoBtpG,EAAE8G,QAChCq+B,IAIJ,8BAAwCA,GAAO,GAC5C,OACD,EAAA68B,GAAA,OAlLJhzD,OACErP,KAAK+O,QAAUjQ,SAASstD,eAAe,iBAEvC,MAAMs+B,EAA4B,CAChC,wBACA,yBACA,qBACA,wBACA,yBACA,gBAEA,cACA,cAEIuf,EAEF,GAEE5uC,EAAqC,IAAIpqD,IAAI,CACjD,CACE,eACA,MAIJ,IAAI,MAAMu0B,KAAS,KAAO,CACxB,MACMz5B,EAAI,GADM,KAAMy5B,GAEhB0kE,EAAWxf,GAAY3+E,EAAE,GAAK,GACpC,IAAIm+F,EAAU,SAEd,IAAInwE,EAAIshC,EAAO7pD,IAAI04F,GACfnwE,IACFA,EAAI,GACJshC,EAAOp+C,IAAIitF,EAAUnwE,IAGvBA,GAAGhuB,EAAErL,MAAM,IAAM,GAAK8kC,EAOxB61B,EAAO3rD,OAAOg7E,EAAW95E,OAGzByqD,EAAOjuD,SAAQ,CAAC+8F,EAAQD,KACtB,MAAM7lG,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,kBAElB,MAAM+qG,EAAWtrG,SAASC,cAAc,OACxCqrG,EAAShrG,UAAUC,IAAI,kBACvB+qG,EAAS1qG,QAAO,QAAKwqG,IAErB,MAAMG,EAAWvrG,SAASC,cAAc,OACxCsrG,EAASjrG,UAAUC,IAAI,gBAEvBgF,EAAI3E,OAAO0qG,EAAUC,GAErBF,EAAO/8F,SAASk9F,IAsBdjB,IAjBY,SAAoBiB,GAiBoCD,GAAU,MAOhFJ,EAAKC,GAAY7lG,KAKnB,MAAMw5D,EAAO79D,KAAK69D,KAAO79D,KAAK+O,QAAQ8Z,uBAChC0hF,EAAcvqG,KAAK01C,OAAS,IAAI,KAAW11C,KAAK+O,QAAS,SAIzDmZ,GAAY,EAAAjkB,GAAA,GAAajE,KAAK+O,SAAS,GAE7C5L,QAAQC,IAAI,EACV,QAAM,KACNpD,KAAK2S,SAAS63F,gBAAgBC,kBAAkB/oG,MAAM0qE,IACpD,MAAMs+B,IAAct+B,EAAOzrE,OACrBgqG,EAAWD,EAAY,EAAI,EACjC1qG,KAAK69D,KAAK/3C,SAAS,GAAG1mB,UAAUoE,OAAO,QAASknG,GAChD1qG,KAAK69D,KAAK/3C,SAAS6kF,GAAUvrG,UAAUC,IAAI,UAC3C,MAAMwsB,EAAI++E,GAAkBC,YAAYhtC,EAAM0sC,OAAavgG,EAAW2gG,GAGtE,OAFA3qG,KAAK8qG,kBAAoBj/E,EAAEi/E,kBAC3B9qG,KAAK+qG,cAAgBl/E,EAAE7gB,UAChBohE,OAER1qE,MAAK,EAAEkL,EAAGw/D,MACXlkD,EAAU5nB,SAEVN,KAAKgrG,eAAiBf,EAAK,gBAAgB/kG,cAAc,iBACzD,IAAI,MAAMsgC,KAAS4mC,EACjBi9B,GAAY7jE,EAAOxlC,KAAKgrG,gBAG1BhrG,KAAKgrG,eAAepnG,cAAcxE,UAAUoE,OAAO,QAASxD,KAAKgrG,eAAe//F,mBAEhFy/E,EAAWrrE,QAAQ,gBACnBqrE,EAAW/vE,KAAKuvF,IACd,MAAM7lG,EAAM4lG,EAAKC,GAQjB,OANI7lG,GACFqJ,QAAQC,MAAM,sBAAuBu8F,GAGvCK,EAAYrpG,UAAUxB,OAAO2E,GAC7BrE,KAAK8qG,kBAAkBjL,2BAA2Bx7F,GAC3CA,QAIXrE,KAAK+O,QAAQ3O,iBAAiB,QAASJ,KAAKgqG,gBAC5ChqG,KAAKqP,KAAO,KAEZ,qBAA2B,gBAAiBm2B,IAC1C,MAAM1f,EAAW1U,MAAMC,KAAKrR,KAAKgrG,eAAellF,UAChD,IAAI,IAAI/Z,EAAI,EAAGpL,EAASmlB,EAASnlB,OAAQoL,EAAIpL,IAAUoL,EAAG,CACxD,MAAMwF,EAAKuU,EAAS/Z,GAEpB,GAAGy5B,KADY,EAAAkkE,GAAA,GAASC,GAAoBp4F,IACvB,CACnB,GAAS,IAANxF,EACD,OAGFwF,EAAGjR,UAIP+oG,GAAY7jE,EAAOxlC,KAAKgrG,gBAAgB,GACxChrG,KAAKgrG,eAAepnG,cAAcxE,UAAUkB,OAAO,QACnDN,KAAK69D,KAAK/3C,SAAS,GAAG1mB,UAAUkB,OAAO,QAEnCN,KAAK+pG,gBACP/pG,KAAK+qG,cAAc,MAIvB,oBAAmC,SAAS,KAC1C/qG,KAAK+pG,eAAiB/pG,KAAK01C,OAAO+O,aAkBtClyC,YEvSa,MAAM04F,WAA6BzsF,GAChD5e,YAAY6e,EAAkCjC,GAC5C3c,MAAM4e,GADsC,KAAAjC,mBAAAA,EAG5Cxc,KAAK6e,YAAc,IAAItC,IAAsB,CAACpV,EAAQ+V,KACpD,MAAMguF,EAAUjtF,GAAiBje,KAAK0e,OAAQ3S,GAAMA,EAAE1H,MAAQ8C,IAC3D+V,GAAWguF,EAAQvqG,QACpBuqG,EAAQ99F,SAAS2R,IACf/e,KAAK0e,MAAMW,QAAQN,MAIvB/e,KAAKwc,oBAAsBxc,KAAKwc,mBAAmBrV,EAAQ+V,GAC3Dld,KAAKkf,4BAIFvB,QAAQpM,GACbvR,KAAK6e,YAAYlB,QAAQpM,I,2SCV7B,MAEM/P,GAAS,IAEA,MAAM2pG,GAMnBvrG,YACUwK,EACA+1B,EACAr0B,EACR0d,GAAS,GAHD,KAAApf,QAAAA,EACA,KAAA+1B,MAAAA,EACA,KAAAr0B,WAAAA,EAPF,KAAAs/F,cAA0CjoG,QAAQ4B,UAClD,KAAAkJ,QAAkB,EAiClB,KAAA62B,SAAW,KACd9kC,KAAKiO,QACNE,aAAanO,KAAKiO,SAElBjO,KAAKorG,eAAgB,UAIvBprG,KAAKiO,QAAUnI,OAAOM,YAAW,KAC/BpG,KAAKiO,QAAU,EACfjO,KAAKorG,cAAcrmG,YAElB,MA4EE,KAAAsmG,oBAAuBhnG,GACrBrE,KAAKorG,cAAc1pG,MAAK,IAAW,mCAGxC,GAAG1B,KAAKyuB,cAAc5P,YAAYvB,UAAUjZ,GAC1C,OAGF,MAAMqsB,EAAQrsB,EAAIa,cAAc,SAC1BomB,EAAMjnB,EAAIa,cAAc,OAE3BomB,IACDA,GAAOA,EAAIlsB,UAAUkB,OAAO,cAEtB,aAGLN,KAAKyuB,cAAc5P,YAAYvB,UAAUjZ,IAIzCqsB,IACDA,EAAMpwB,SACNowB,EAAMjK,IAAM,GACZiK,EAAMvvB,OACaygC,EAAA,gBAAmClR,GAC3CtjB,SAAS2R,IAClB6iB,EAAA,iBAAoC7iB,GAAM,GAAM,YA3ItD/e,KAAK2S,SAAW,aAEhB3S,KAAKyuB,cAAgB,IAAIw8E,QAAqBjhG,GAAW,CAAC7C,EAAQ+V,KAC7DA,EACDld,KAAKsrG,kBAAkBnkG,GAEvBnH,KAAKqrG,oBAAoBlkG,MAa1BqiB,GACDxpB,KAAKwpB,SAmBFA,SACLxpB,KAAK8L,WAAW5K,UAAUd,iBAAiB,SAAUJ,KAAK8kC,UAGrDvb,SACLvpB,KAAK+K,QACL/K,KAAK8L,WAAW5K,UAAUmF,oBAAoB,SAAUrG,KAAK8kC,UAGxD/5B,QACL/K,KAAKyuB,cAAc1jB,QAGbugG,kBAAkBjnG,GACVA,EAAIa,cAAc,UAwDhClF,KAAKyuB,cAAc5c,KAAK,CAACxN,IAAAA,EAAKlD,KAjDjB,KACX,MAAM2hC,EAAQz+B,EAAIuD,QAAQk7B,MA2C1B,OA1CgB3/B,QAAQC,IAAI,CAACpD,KAAK2S,SAAS6wB,eAAeC,OAAOX,GAAQ9iC,KAAKorG,gBAAgB1pG,MAAK,EAAO84B,KAAS,mCACjH,MASM1wB,SATYm2B,GAAU,CAC1BzF,IAAAA,EACAt5B,UAAWmD,EACXoqB,cAAe,KAEf0R,MAAOngC,KAAKmgC,MACZD,QAAQ,KAGU9+B,YAyBpB,OAxBA0I,EAAQohB,SAAQ,KACd,MAAMwF,EAAQrsB,EAAIa,cAAc,SAEhCb,EAAIpB,MAAM0gE,QAAU,GACpB,MAAMr4C,EAAMjnB,EAAIa,cAAc,OAC9BomB,GAAOA,EAAIlsB,UAAUC,IAAI,QAEtBqxB,IAAUA,EAAM9sB,eACjBwC,YAAW,KACTsqB,EAAMjK,IAAM,GACZiK,EAAMvvB,OACaygC,EAAA,gBAAmClR,GAC3CtjB,SAAS2R,IAClB6iB,EAAA,iBAAoC7iB,GAAM,GAAM,QAEjD,GAID/e,KAAKyuB,cAAc5P,YAAYvB,UAAUjZ,IAC3CrE,KAAKqrG,oBAAoBhnG,MAItByF,UAgDNzK,IAAIm7B,EAAiB6Y,EAAWrzC,KAAKoK,SAC1C,IAAImhG,EAAW/wE,EAAIja,EACfirF,EAAYhxE,EAAIha,EACjBgrF,EAAYhqG,KACb+pG,GAAW/pG,GAASgqG,EACpBA,EAAYhqG,IAGd,MAAMiqG,EAAe9oG,KAAKC,IAxKPrB,IADT,IAyK2CgqG,GAC/CvqG,GAAO,EAAA0f,GAAA,GAAe6qF,EAAUC,EAAWC,EAAcjqG,IAezD6C,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,MAAO,sBACzBgF,EAAIpB,MAAM1B,MAAQP,EAAKO,MAAQ,KAC/B8C,EAAIpB,MAAM0gE,QAAU,IAEpBt/D,EAAIuD,QAAQk7B,MAAQ,GAAKtI,EAAIhqB,GAE7B6iC,EAAS3zC,OAAO2E,GAGhBrE,KAAKyuB,cAAc9Q,QAAQtZ,ICzMhB,MAAMqnG,GAGnB9rG,YAAoB+S,GAAA,KAAAA,SAAAA,EAIpBtD,OACErP,KAAK+O,QAAUjQ,SAASstD,eAAe,gBACvC,MAAMu/C,EAAgB3rG,KAAK+O,QAAQga,kBACnC4iF,EAAcvrG,iBAAiB,QAASwqG,GAAkBrhC,cAE1D,MAAM7zB,EAAS,IAAI,KAAW11C,KAAK+O,QAAS,QACtC68F,EAAU,IAAIT,GAAYQ,EAAeE,GAAuBn2D,GAChExtB,GAAY,EAAAjkB,GAAA,GAAajE,KAAK+O,SAAS,GAE7C/O,KAAK2S,SAAS6wB,eAAesoE,UAAUpqG,MAAMqqG,IAC3CA,EAAK3+F,SAASotB,IACZoxE,EAAQvsG,IAAIm7B,MAGdtS,EAAU5nB,YAGZ,0BAAyCsrG,EAAQn9E,cAAem9E,EAAQP,qBAExErrG,KAAKqP,KAAO,KAGdkD,YC/Ba,MAAMy5F,WAA4BxtF,GAG/C5e,YAAY6e,EAAkCjC,GAC5C3c,MAAM4e,GADsC,KAAAjC,mBAAAA,EAFtC,KAAAyvF,OAA4C,IAAIh7F,IAKtDjR,KAAK6e,YAAc,IAAItC,IAAsB,CAACpV,EAAQ+V,KACpD,MAAMguF,EAAUjtF,GAAiBje,KAAK0e,OAAQ3S,GAAMA,EAAE1H,MAAQ8C,IAC3D+V,IACaguF,EAAQvqG,OAASuqG,EAAU,CAAClrG,KAAKisG,OAAOz6F,IAAIrK,KACpDiG,SAAS2R,IACb/e,KAAK0e,MAAMW,QAAQN,GAAQ/e,KAAKisG,OAAOz6F,IAAIrK,OAI/CnH,KAAKwc,oBAAsBxc,KAAKwc,mBAAmBrV,EAAQ+V,GAC3Dld,KAAKkf,4BAIFnU,QACLlL,MAAMkL,QACN/K,KAAKisG,OAAOlhG,QAYP4S,QAAQpM,GACbvR,KAAKisG,OAAOhvF,IAAI1L,EAAGlN,IAAKkN,GACxBvR,KAAK6e,YAAYlB,QAAQpM,EAAGlN,M,2SCrBzB,MAAM6nG,GAIXtsG,YACUusG,EACAhsE,EACAxtB,GAFA,KAAAw5F,qBAAAA,EACA,KAAAhsE,MAAAA,EACA,KAAAxtB,SAAAA,EALF,KAAAy5F,aAAoC,IAAIxtF,IAkDxC,KAAAytF,wBAA0B,CAAChoG,EAAkB6Y,KAEnC0kB,EAAA,gBAAmCv9B,GAC3C+I,SAASg+E,IACXluE,EAGF0kB,EAAA,iBAAoCwpD,GAAQ,GAF5CxpD,EAAA,iBAAoCwpD,GAAQ,GAAM,OAOhD,KAAAkgB,kBAA0BjnG,GAAqB,mCACrD,MAAMy+B,EAAQz+B,EAAIuD,QAAQk7B,MACpBtI,QAAYx6B,KAAK2S,SAAS6wB,eAAeC,OAAOX,GAEhD9hC,EAAOquB,EAAA,0BAIPvlB,EAAU,GAAY,CAC1B0wB,IAAAA,EACAn2B,IAAKA,EACL9C,MAAOP,EACPQ,OAAQR,EACRytB,cAAe,KACf0R,MAAOngC,KAAKmgC,MACZoF,WAAW,EACXljC,MAAM,EACNhB,MAAM,IACLK,MAAK,EAAE8uB,OAAAA,KAAYA,IAWtB,OATA1mB,EAAQpI,MAAK,KAEX1B,KAAKqsG,wBAAwBhoG,EAAKrE,KAAKyuB,cAAc5P,YAAYvB,UAAUjZ,OAOtEyF,KAGF,KAAAuhG,oBAA4BhnG,GAAqB,mCACtD,MAAMy+B,EAAQz+B,EAAIuD,QAAQk7B,MACpBtI,QAAYx6B,KAAK2S,SAAS6wB,eAAeC,OAAOX,GAItD9iC,KAAKqsG,wBAAwBhoG,GAAK,GAElCA,EAAIC,UAAY,GAChBtE,KAAKssG,cAAc9xE,EAAKn2B,MAhGxBrE,KAAKyuB,cAAgB,IAAIu9E,QAAoBhiG,GAAW,CAAC7C,EAAQ+V,KAC3DA,GACFld,KAAKqrG,oBAAoBlkG,MAKxB4D,QACL/K,KAAKyuB,cAAc1jB,QAGduhG,cAAc9xE,EAAiBn2B,EAAsBuqB,GAoB1D,OAnBIvqB,KACFA,EAAMvF,SAASC,cAAc,QACzBK,UAAUC,IAAI,YAAa,iBAE5Bm7B,EAAI6/B,UACLr6D,KAAKusG,mBAAmBloG,IAK5B,GAAY,CACVm2B,IAAAA,EACAn2B,IAAAA,EACAoqB,cAAezuB,KAAKmsG,qBACpBhsE,MAAOngC,KAAKmgC,MACZoF,UAAW/K,EAAI6/B,SACfzrC,aAAAA,IAGKvqB,EAGFkoG,mBAAmBloG,GACxBrE,KAAKosG,aAAa/sG,IAAIgF,GAEtBrE,KAAKyuB,cAAc9Q,QAAQ,CACzBtZ,IAAAA,EACAlD,KAAMnB,KAAKsrG,qBA6DF,MAAMkB,GAwBnB5sG,YAAoB+S,GAAA,KAAAA,SAAAA,EApBZ,KAAAg0E,YAGH,GAGG,KAAA8lB,eAA+B,GAM/B,KAAApoC,SAAU,EAEV,KAAAqoC,kBAAgE,GAUxEC,aAAaC,EAA0BC,EAA2C,GAAI/iG,EAAgCjG,GAGpH,MAAMwmG,EAAWvrG,SAASC,cAAc,OACxCsrG,EAASjrG,UAAUC,IAAI,iBAAkB,kBAEzC,MAAM+qG,EAAWtrG,SAASC,cAAc,OAoCxC,OAnCAqrG,EAAShrG,UAAUC,IAAI,kBAEpBwtG,IAC4B,iBAApB,EAA8BzC,EAAS9lG,UAAYuoG,EACvDzC,EAAS1qG,OAAOmtG,IAGvBD,EAAYltG,OAAO0qG,EAAUC,GAE7BrqG,KAAK8qG,kBAAkBjL,2BAA2B+M,GAElD5sG,KAAK0sG,kBAAkB76F,KAAK,CAACzH,QAASwiG,EAAa/oG,QAAAA,IAEnDiG,EAAQpI,MAAMi5D,IACZA,EAAUvtD,SAASotB,IAEjB6vE,EAAS3qG,OAAOM,KAAK8sG,qBAAqBR,cAAc9xE,OAGvDx6B,KAAK0sG,kBAAkB/rG,SACxBX,KAAK0sG,kBAAkBt/F,SAAQ,EAAEhD,QAAAA,EAASvG,QAAAA,MACrCA,EACE7D,KAAK+sG,UAAUnpG,eAChB5D,KAAKukF,YAAY1gF,QAAQuG,GACzBpK,KAAKukF,YAAY1gF,QAAQ7D,KAAK+sG,YAE9B/sG,KAAKukF,YAAY1gF,QAAQuG,GAEtBpK,KAAKukF,YAAY7kF,OAAO0K,MAGjCpK,KAAK0sG,kBAAkB/rG,OAAS,MAI7B,CAACypG,SAAAA,GAGJvjB,iBAAiB5pE,EAA4BpZ,GAAU,G,0CAC3D,MAAM+oG,EAAc9tG,SAASC,cAAc,OAC3C6tG,EAAYxtG,UAAUC,IAAI,oBAC1ButG,EAAYhlG,QAAQ4I,GAAK,GAAKyM,EAAIzM,GAClCo8F,EAAYhlG,QAAQquD,YAAc,GAAKh5C,EAAIg5C,YAE3C,MAAMp3D,EAASC,SAASC,cAAc,UACtCF,EAAOO,UAAUC,IAAI,WAAY,4BAEjCW,KAAK2mF,YAAY1pE,EAAIzM,IAAM,CACzBw8F,SAAUJ,EACV97F,IAAKjS,GAGJgF,EACD7D,KAAK69D,KAAK/5D,aAAajF,EAAQmB,KAAK69D,KAAK90C,kBAAkB/kB,aAE3DhE,KAAK69D,KAAKn+D,OAAOb,GAKnB,MAAMiL,EAAU9J,KAAK2S,SAASo0B,mBAAmB0zB,cAAcx9C,GAC/Djd,KAAK2sG,aAAaC,GAAa,EAAAh0E,GAAA,GAAc3b,EAAInO,OAAQhF,EAAQpI,MAAMg5D,GAAeA,EAAWC,YAA4B92D,SACpGiG,EAIzBowD,GAAoB,CAClBj9C,IAAAA,EACA/b,UAAWrC,EACXshC,MAAO0rE,GACPp9E,cAAem8E,GAAkBn8E,cACjCltB,MAAO,GACPC,OAAQ,GACRF,UAAU,OAId+N,OACErP,KAAK+O,QAAUjQ,SAASstD,eAAe,oBAGvCpsD,KAAK+sG,UAAYjuG,SAASC,cAAc,OACxCiB,KAAK+sG,UAAU3tG,UAAUC,IAAI,mBAAoB,mBAEjD,IAAI4tG,EAAcjtG,KAAK+O,QAAQ8Z,uBAC/B7oB,KAAK69D,KAAOovC,EAAYlkF,kBAExB,IAAImkF,EAAa,IAAI,KAAYD,GAEjCjtG,KAAKukF,YAAczlF,SAASC,cAAc,OAC1CiB,KAAKukF,YAAYnlF,UAAUC,IAAI,uBAC/BW,KAAK+O,QAAQrP,OAAOM,KAAKukF,aAmBzB,qBAA2B,sBAAuBlkF,IAChD,MAAM4c,EAA6B5c,GAE/BL,KAAK2mF,YAAY1pE,EAAIzM,KAAOxQ,KAAKqkE,SACnCrkE,KAAK6mF,iBAAiB5pE,GAAK,MAI/B,qBAA2B,oBAAqB5c,IAC9C,MAAM4c,EAA6B5c,EAEnC,GAAGL,KAAK2mF,YAAY1pE,EAAIzM,KAAOxQ,KAAKqkE,QAAS,CAC3C,MAAMpqC,EAAWj6B,KAAK2mF,YAAY1pE,EAAIzM,IACtCypB,EAAS+yE,SAAS1sG,SAClB25B,EAASnpB,IAAIxQ,gBACNN,KAAK2mF,YAAY1pE,EAAIzM,QAIhCxQ,KAAKukF,YAAYnkF,iBAAiB,SAAUC,IAC1C,MAAM8G,EAAS9G,EAAE8G,OACjB,IAAG,EAAAwyB,GAAA,GAAgBxyB,EAAQ,kBAA3B,CACE,MAAMoK,GAAK,EAAA0hC,GAAA,GAAgB9rC,EAAQ,WACnC,IAAI+8E,GAAc,CAAC1zE,GAAIe,EAAG3J,QAAQ4I,GAAIylD,YAAa1kD,EAAG3J,QAAQquD,cAAc/mB,YAI9E07D,GAAkBrhC,aAAalpE,MAGjC,MAAMmnC,EAAY,CAACpf,GAAS,KAC1B,kBAAwB,oBAAqBA,IAG/CpoB,KAAK01C,OAAS,IAAI,KAAW11C,KAAK+O,QAAS,YAC3C/O,KAAK01C,OAAOzpC,oBAAoBjM,KAAKukF,aACrCvkF,KAAK01C,OAAOkU,mBAAqB,KAC/BpiB,KAGF,oBAAmC,UAAU,KAC3CA,GAAU,MAGZ,oBAAmC,UAAU,KAC3CA,OAGFxnC,KAAK8qG,kBAAoBF,GAAkBC,YAAY7qG,KAAK69D,KAAM79D,KAAK01C,OAAQw3D,GAAYpC,kBAE3F,MAAM5iF,GAAY,EAAAjkB,GAAA,GAAajE,KAAK+O,SAAS,GAE7C5L,QAAQC,IAAI,CACVpD,KAAK2S,SAASo0B,mBAAmBomE,oBAAoBzrG,MAAMsrG,IACzDhtG,KAAKysG,eAAiBO,EAASA,SAAStsG,MAAM,EAAG,IAIjDV,KAAK2mF,YAAoB,OAAI,CAC3BqmB,SAAUhtG,KAAK+sG,UACfj8F,IAAK9Q,KAAK69D,KAAK90C,mBAGjBb,EAAU5nB,SACV,MAAM,SAAC8pG,GAAYpqG,KAAK2sG,aAAa3sG,KAAK+sG,UAAW,GAAI5pG,QAAQ4B,QAAQ/E,KAAKysG,iBAAiB,GAC/FrC,EAAS1qG,QAAO,QAAK,uBAGvBM,KAAK2S,SAASo0B,mBAAmB+/C,iBAAiBplF,MAAMoL,IACtDob,EAAU5nB,SAEV,IAAI,IAAI2c,KAAQnQ,EAAgDk6E,KAC9DhnF,KAAK6mF,iBAAiB5pE,QAGzBiO,SAAQ,KACTlrB,KAAKqkE,SAAU,EACf78B,OAGFxnC,KAAK8sG,qBAAuB,IAAIZ,GAAqBtB,GAAkBn8E,cAAeo9E,GAAuB7rG,KAAK2S,UAElH,0BAAyC3S,KAAK8sG,qBAAqBr+E,cAAezuB,KAAK8sG,qBAAqBzB,qBAU5GrrG,KAAKqP,KAAO,KAGd+9F,kBAAkB5yE,G,MAGhB,GAFAx6B,KAAK2S,SAASo0B,mBAAmBqmE,kBAAkB5yE,KAEjC,QAAd,EAAAx6B,KAAK+sG,iBAAS,eAAEnpG,eAClB,OAGF,IAAIS,EAAMrE,KAAK+sG,UAAU7nG,cAAc,iBAAiBs1B,EAAIhqB,QACxDnM,IACFA,EAAMrE,KAAK8sG,qBAAqBR,cAAc9xE,IAGhD,MAAM/d,EAAQzc,KAAK+sG,UAAU7nG,cAAc,mBAC3CuX,EAAM5Y,QAAQQ,GAEXoY,EAAMxR,kBAAoB,IAC1BmG,MAAMC,KAAKoL,EAAMqJ,UAA4BplB,MAAM,IAAI0M,SAASmE,GAAOA,EAAGjR,WAI/EiS,YCvXF,MAAM86F,GAAiB,cAER,MAAMC,WAAmB9+F,EAAxC,c,oBAIU,KAAA++F,WAAa,GACb,KAAAC,WAAY,EA2BZ,KAAAC,YAAeptG,IACrB,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,OACzC,IAAIA,EAAQ,OAEZ,MAAMk9E,EAASl9E,EAAOS,QAAQk7B,MAC3B,sCAAgDuhD,GAC9Ch1D,EAAA,YACD,qBAGF3hB,QAAQ+7D,KAAK,oBAAqB4a,IA9B5Bh1E,OACRrP,KAAKkB,UAAUsP,GAAK,wBAEpBxQ,KAAK2yF,YAAc,IAAI7kF,EAAY,mBAAoBtN,IACrDR,KAAKmM,QACLnM,KAAK0tG,OAAOltG,MAGdR,KAAK8O,MAAM2vB,YAAYz+B,KAAK2yF,YAAYzxF,WAExClB,KAAK2tG,QAAU7uG,SAASC,cAAc,OACtCiB,KAAK2tG,QAAQvuG,UAAUC,IAAI,iBAC3B,QAAiBW,KAAK2tG,QAAS3tG,KAAKytG,YAAa,CAACxkG,eAAgBjJ,KAAKiJ,iBAEvEjJ,KAAK8L,WAAWpM,OAAOM,KAAK2tG,SAE5B3tG,KAAK4rG,QAAU,IAAIT,GAAYnrG,KAAK2tG,QAASN,GAAgBrtG,KAAK8L,YAkB7DyG,UACLvS,KAAK8L,WAAWO,iBAAmB,OAG9BmD,sBAKL,OAJAxP,KAAKmM,QACLnM,KAAK2tG,QAAQrpG,UAAY,GACzBs9B,EAAA,uBAAqC53B,EAAWqjG,IAChDrtG,KAAK2yF,YAAYryF,SACVT,MAAM2P,sBAGPrD,QACNnM,KAAKyL,cAAgB,KACrBzL,KAAKutG,WAAa,GAClBvtG,KAAKwtG,WAAY,EACjBxtG,KAAK4rG,QAAQ7gG,QAGRoE,OACL,MAAMgwC,EAAMt/C,MAAMsP,OAQlB,OAPA,kBAA8B,GAAMzN,MAAK,KACvC1B,KAAK0tG,OAAO,IAAI,GAEhB1tG,KAAK8L,WAAWO,iBAAmB,KACjCrM,KAAK0tG,OAAO1tG,KAAK2yF,YAAYnyF,OAAO,OAGjC2+C,EAGIuuD,OAAO/hG,EAAeiiG,GAAY,G,qCAC7C,IAAG5tG,KAAKyL,gBAAiBzL,KAAKwtG,UAA9B,CAEIxtG,KAAK6tG,eACP7tG,KAAK6tG,oBAAsB7tG,KAAK2S,SAAS2I,gBAAgBwyF,gBAAgB,QAAQt9F,GAAGqK,UAAS,IAG/F,IACE7a,KAAKyL,cAAgBzL,KAAK2S,SAASo7F,qBAAqBC,iBAAiB,MAAchuG,KAAK6tG,aAAcliG,EAAO3L,KAAKutG,YACtH,MAAM,QAAEhjF,EAAO,YAAEokC,SAAsB3uD,KAAKyL,cAE5C,GAAGzL,KAAK2yF,YAAYnyF,QAAUmL,EAC5B,OAGF3L,KAAKyL,cAAgB,KACrBzL,KAAKutG,WAAa5+C,EACfi/C,IACD5tG,KAAK2tG,QAAQrpG,UAAY,IAGxBimB,EAAQ5pB,OACT4pB,EAAQnd,SAASkC,IACC,yBAAbA,EAAO1C,GAAgC0C,EAAOxQ,UAC/CkB,KAAK4rG,QAAQvsG,IAAIiQ,EAAOxQ,aAI5BkB,KAAKwtG,WAAY,EAGnBxtG,KAAK8L,WAAWg5B,WAChB,MAAMr3B,GAGN,MAFAzN,KAAKyL,cAAgB,KACrBiC,QAAQC,MAAM,sBAAuBF,GAC/BA,K,gSC/GG,MAAMwgG,WAAuBz/F,EAKhCa,OACRrP,KAAKkB,UAAUsP,GAAK,qBACpBxQ,KAAKkB,UAAU9B,UAAUC,IAAI,sBAE7BW,KAAKyuB,cAAgB,IAAInP,GAEzBtf,KAAK2yF,YAAc,IAAI7kF,EAAY,iCAAkCtN,IACnER,KAAK0tG,OAAOltG,MAGdR,KAAK8O,MAAM2vB,YAAYz+B,KAAK2yF,YAAYzxF,WAExClB,KAAKkuG,QAAUpvG,SAASC,cAAc,OACtCiB,KAAKkuG,QAAQ9uG,UAAUC,IAAI,gBAC3BW,KAAK8L,WAAWpM,OAAOM,KAAKkuG,UAE5B,QAAiBluG,KAAKkuG,SAAU7tG,IAC9B,MAAMulC,GAAU,EAAAjM,GAAA,GAAgBt5B,EAAE8G,OAAQ,uBAC1C,GAAGy+B,EAAS,CACV,MAAM9C,EAAQ8C,EAAQh+B,QAAQk7B,MAE9B,YADA,sCAAgDA,GAIlD,MAAM37B,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,eACzC,IAAIA,EAAQ,OAEZ,MAAMqJ,EAAKrJ,EAAOS,QAAQ8yD,WACpBzE,EAAc9uD,EAAOS,QAAQquD,YAE7Bp3D,GAAS,EAAA86B,GAAA,GAAgBt5B,EAAE8G,OAAQ,sBACtCtI,GACDwB,EAAEu0B,iBACFv0B,EAAEoH,cAAe,EAEjB5I,EAAOW,aAAa,WAAY,QAEhCQ,KAAK2S,SAASo0B,mBAAmB0zB,cAAc,CAACjqD,GAAAA,EAAIylD,YAAAA,IAAcv0D,MAAMwtB,IACtElvB,KAAK2S,SAASo0B,mBAAmB69C,iBAAiB11D,EAAKjS,KAAKvb,MAAMob,IAC7DA,IACDje,EAAO8zB,YAAc,GACrB9zB,EAAOa,QAAO,QAAKwvB,EAAKjS,IAAI0nE,eAAiB,uBAAyB,uBACtE9lF,EAAOO,UAAUoE,OAAO,SAAU0rB,EAAKjS,IAAI0nE,oBAE5Cz5D,SAAQ,KAETrsB,EAAO8F,gBAAgB,mBAI3B3E,KAAK2S,SAASo0B,mBAAmB0zB,cAAc,CAACjqD,GAAAA,EAAIylD,YAAAA,IAAcv0D,MAAMwtB,IACtE,IAAIg1D,GAAch1D,EAAKjS,KAAKiyB,YAG/B,CAACjmC,eAAgBjJ,KAAKiJ,iBAGpBuG,sBAGL,OAFAxP,KAAKkuG,QAAQ5pG,UAAY,GACzBs9B,EAAA,uBAAqC53B,EAAW,mBACzCnK,MAAM2P,sBAGR2+F,UAAUlxF,GAEf,MAAM5Y,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,eAElB,MAAMuP,EAAS9P,SAASC,cAAc,OACtC6P,EAAOxP,UAAUC,IAAI,sBAErB,MAAMqqB,EAAU5qB,SAASC,cAAc,OACvC2qB,EAAQtqB,UAAUC,IAAI,uBACtBqqB,EAAQplB,UAAY,wCAEpB,EAAAq0B,EAAA,GAAajP,EAAQX,mBAAmB,EAAA6P,GAAA,GAAc3b,EAAInO,QAE1D,MAAMs/F,EAAWtvG,SAASC,cAAc,OACxCqvG,EAAShvG,UAAUC,IAAI,qBACvB+uG,EAAS1uG,QAAO,QAAK,WAAY,CAACud,EAAIlQ,SACtC2c,EAAQhqB,OAAO0uG,GAEf,MAAMvvG,EAASC,SAASC,cAAc,UACtCF,EAAOO,UAAUC,IAAI,cAAe,oBAAqB,sBACzDR,EAAOa,QAAO,QAAKud,EAAI0nE,eAAiB,uBAAyB,uBAG9D1nE,EAAI0nE,gBACL9lF,EAAOO,UAAUC,IAAI,QAKvBuP,EAAOlP,OAAOgqB,EAAS7qB,GAEvB,MAAM0lF,EAAczlF,SAASC,cAAc,OAC3CwlF,EAAYnlF,UAAUC,IAAI,wBAE1B,MAAM0N,EAAQpK,KAAKC,IAAI,EAAGqa,EAAIlQ,OAC9B,IAAI,IAAIhB,EAAI,EAAGA,EAAIgB,IAAShB,EAAG,CAC7B,MAAMsiG,EAAavvG,SAASC,cAAc,OAC1CsvG,EAAWjvG,UAAUC,IAAI,uBAEzBklF,EAAY7kF,OAAO2uG,GAGrBruG,KAAK2S,SAASo0B,mBAAmB0zB,cAAcx9C,GAAKvb,MAAMub,IAGxD,IAAI,IAAIlR,EAAI,EAAGA,EAAIgB,IAAShB,EAAG,CAC7B,MAAM1H,EAAMkgF,EAAYz+D,SAAS/Z,GAC3ByuB,EAAMvd,EAAI09C,UAAU5uD,GACb,kBAAVyuB,EAAI5tB,GAIP,GAAY,CACV4tB,IAAAA,EACAn2B,IAAAA,EACAoqB,cAAezuB,KAAKyuB,cACpB0R,MAAO,kBAGP99B,MAAM,EACNhB,MAAM,EACNE,MAAO,GACPC,OAAQ,SA8Bd6C,EAAIuD,QAAQ8yD,WAAa,GAAKz9C,EAAIzM,GAClCnM,EAAIuD,QAAQquD,YAAc,GAAKh5C,EAAIg5C,YACnC5xD,EAAIuD,QAAQkH,MAAQmO,EAAInO,MAExBzK,EAAI3E,OAAOkP,EAAQ21E,GAEnBvkF,KAAKkuG,QAAQxuG,OAAO2E,GAGf8K,OACL,MAAMgwC,EAAMt/C,MAAMsP,OAKlB,OAJA,kBAA8B,GAAMzN,MAAK,KACvC1B,KAAKsuG,oBAGAnvD,EAGFmvD,iBACL,OAAOtuG,KAAK2S,SAASo0B,mBAAmBwnE,sBAAsB7sG,MAAM8sG,IAC/DxuG,KAAK2yF,YAAYnyF,QAIpBguG,EAAcxuG,KAAKyuG,eAAe,GAAID,IAC1BphG,SAAS6P,IACnBjd,KAAKmuG,UAAUlxF,EAAIA,WAKjBwxF,eAAe9iG,EAAe6iG,GACpCA,EAAcA,EAAY9tG,QAE1B,MAAMolB,EAAW1U,MAAMC,KAAKrR,KAAKkuG,QAAQpoF,UAczC,OAbA,EAAAyiE,GAAA,GAAeziE,GAAUvU,IACvB,MAAMf,EAAKe,EAAG3J,QAAQ8yD,WAChBp1C,EAAQkpF,EAAYlwF,WAAWowF,GAAYA,EAAQzxF,IAAIzM,KAAOA,KAEtD,IAAX8U,EACDkpF,EAAYjwF,OAAO+G,EAAO,GACjB3Z,GAAU4F,EAAG3J,QAAQkH,MAAMjG,cAAczB,SAASuE,EAAM9C,gBACjE0I,EAAGjR,YAIPshC,EAAA,uBAAqC53B,EAAW,mBAEzCwkG,EAGFd,OAAO/hG,GACZ,OAAIA,EAIG3L,KAAK2S,SAASo0B,mBAAmB4nE,kBAAkBhjG,GAAO,GAAOjK,MAAM8sG,IACzExuG,KAAK2yF,YAAYnyF,QAAUmL,IAM9B6iG,EAAcxuG,KAAKyuG,eAAe9iG,EAAO6iG,IAC7BphG,SAAS6P,IACnBjd,KAAKmuG,UAAUlxF,EAAIA,WAZdjd,KAAKsuG,kBC3NH,MAAMM,WAAsB,IAWzChvG,YAAYhB,GAGViB,OAAM,GANE,KAAAgvG,YAAa,EACb,KAAAC,QAAS,EAoCX,KAAAC,WAAc1uG,IAGpB,GADA8N,aAAanO,KAAKgvG,iBACdhvG,KAAKivG,WAAY,OAErB,MAAMC,EAAa7uG,EAAU6uG,UAC1BA,IAAa,EAAApvC,GAAA,GAAcovC,EAAWlvG,KAAKoK,WAI9CpK,KAAKgvG,eAAiBlpG,OAAOM,YAAW,KACtCpG,KAAKwD,QAAO,KA3DK,OA6Ed,KAAAA,OAAeupD,IAAqB,O,EAAA,K,OAAA,E,EAAA,YAEzC,MAAMoiD,IAAkBnvG,KAAKoK,QAAQnH,MAAMC,cAAsB8G,IAAX+iD,GAAyBA,EAC/E,GAAG/sD,KAAKqP,KAAM,CACZ,IAAG8/F,EAID,OAHAnvG,KAAKqP,OACLrP,KAAKqP,KAAO,KAMhB,GAAG8/F,IAAiBnvG,KAAKivG,WAIzB,GAAIjvG,KAAKoK,QAAQnH,MAAMC,cAAsB8G,IAAX+iD,GAAyBA,EAAQ,CACjE,MAAMjgD,EAAM9M,KAAKovG,wBAAwB,cACnCjsG,QAAQC,IAAI0J,GAElB9M,KAAKoK,QAAQnH,MAAMC,QAAU,GACxBlD,KAAKoK,QAAQ+6C,WAClBnlD,KAAKoK,QAAQhL,UAAUC,IAAI,UAE3B8O,aAAanO,KAAKgvG,gBAClBhvG,KAAKgvG,eAAiBlpG,OAAOM,YAAW,KACtCpG,KAAK6uG,YAAa,EAClB7uG,KAAKgQ,cAAc,YAClB,KAAqB,EAxGH,UAqHrBhQ,KAAKgQ,cAAc,SAEnBhQ,KAAKoK,QAAQhL,UAAUkB,OAAO,UAE9B6N,aAAanO,KAAKgvG,gBAClBhvG,KAAKgvG,eAAiBlpG,OAAOM,YAAW,KACtCpG,KAAKoK,QAAQnH,MAAMC,QAAU,OAC7BlD,KAAK6uG,YAAa,EAClB7uG,KAAKgQ,cAAc,YAClB,KAAqB,EA9HH,M,YA4EkB,K,gRA3DzC,EAAAgB,EAAA,GAAWhR,KAAMpB,GAGZywG,qBAAqBxwG,EAAqBoK,GAC/C,IAAIqpB,GAAY,EACb,MACD,QAAiBzzB,GAAQ,KACpByzB,GACDA,GAAY,EACZtyB,KAAKwD,QAAO,IAEZxD,KAAKwD,WAEN,CAACyF,eAAAA,IAEJA,EAAe5J,IAAIR,EAAnBoK,CAA2B,aAAc5I,IAEpCiyB,IACDrpB,EAAe5J,IAAIR,EAAnBoK,CAA2B,WAAYjJ,KAAK+uG,YAC5Cz8E,GAAY,GAGdnkB,aAAanO,KAAKgvG,gBAClBhvG,KAAKgvG,eAAiBlpG,OAAOM,YAAW,KACtCpG,KAAKwD,QAAO,KA1CC,QA+DX6L,OACJ,OACFrP,KAAKoK,QAAQklG,WAAatvG,KAAK+uG,WAC/B/uG,KAAKoK,QAAQmlG,YAAelvG,IACvBL,KAAK6uG,YAKR1gG,aAAanO,KAAKgvG,kBAyEjBC,WACL,OAAOjvG,KAAKoK,QAAQhL,UAAUiG,SAAS,WChIpC,MAAMwmG,GAAwB,qBAO9B,MAAMjB,WAA0BgE,GAqBrChvG,cACEC,MAAM,CACJuK,QAAStL,SAASstD,eAAe,oBAd7B,KAAAojD,OAAS,EA6IT,KAAAC,iBAAoBj/F,IACvBxQ,KAAKwvG,QAAUh/F,IAIlBoxB,EAAA,mBAAqC,EAAMiqE,IAE3C7rG,KAAKwvG,MAAQh/F,EACbxQ,KAAK0vG,aAAatwG,UAAUoE,OAAO,OAAuB,IAAfxD,KAAKwvG,OAChDxvG,KAAK2vG,UAAUvwG,UAAUoE,OAAO,OAAuB,IAAfxD,KAAKwvG,SAGvC,KAAAI,YAAc,KACpB,MAAM,OAACrjG,EAAM,SAAEV,GAAY,QACrBia,EAAW9lB,KAAK6vG,OAAO/pF,SACvBgqF,EAAe1+F,MAAMC,KAAKyU,GAE1BiqF,EAAkB/vG,KAAK2S,SAAS40B,mBAAmByoE,cAAczjG,EAAQV,EAAU,iBACzFikG,EAAa,GAAGpnE,gBAAgB,YAAaqnE,GAE7C,MAAME,EAAcjwG,KAAK2S,SAAS40B,mBAAmByoE,cAAczjG,EAAQV,EAAU,aACrFikG,EAAa,GAAGpnE,gBAAgB,YAAaunE,GAE7C,MAAMjjD,EAAShtD,KAAK6vG,OAAO3qG,cAAc,YACtC8nD,GAAiC,KAAvB,EAAAiO,GAAA,GAAWjO,IAAmB+iD,GAAoBE,GAC7DjwG,KAAKuP,UAAU,GAAG,IArJpBvP,KAAKI,iBAAiB,QAAQ,KAAW,O,EAAA,K,OAAA,E,EAAA,YACpC,OAEE,EAAAiiE,GAAA,aACK,QAAM,MAIbriE,KAAKoK,QAAQxG,gBAAkB,yBAChC,+BAAyC5D,KAAKoK,SAGhDpK,KAAKkwG,WAAalwG,KAAKmwG,eAEvBvF,GAAkBn8E,cAAczQ,OAEhC4jB,EAAA,wBAA2CiqE,K,YAhBJ,K,iRAmBzC7rG,KAAKI,iBAAiB,UAAU,KAC9BwhC,EAAA,0BAA6CiqE,IAC7CjB,GAAkBn8E,cAAc3Q,SAChC8sF,GAAkBn8E,cAAcjR,UAEhCxd,KAAKkB,UAAU9B,UAAUkB,OAAO,oBAGlCN,KAAKI,iBAAiB,SAAS,KAC7BwqG,GAAkBn8E,cAAczQ,OAIhC4jB,EAAA,wBAA2CiqE,IAC3CjqE,EAAA,mBAAqC,EAAMiqE,OAG7C7rG,KAAKI,iBAAiB,UAAU,KAE9BwhC,EAAA,0BAA6CiqE,IAC7CjB,GAAkBn8E,cAAc3Q,SAChC8sF,GAAkBn8E,cAAcjR,UAEhCxd,KAAKkB,UAAU9B,UAAUkB,OAAO,iBAEhCN,KAAKkwG,gBAAalmG,KAIZqF,OACRrP,KAAK2S,SAAW,aAChB3S,KAAKowG,SAAW,IAAItG,GAAS9pG,KAAK2S,UAClC3S,KAAKqwG,YAAc,IAAI7D,GAAYxsG,KAAK2S,UACxC3S,KAAKswG,QAAU,IAAI5E,GAAQ1rG,KAAK2S,UAEhC3S,KAAKyP,KAAO,CACV,EAAGzP,KAAKowG,SACR,EAAGpwG,KAAKqwG,YACR,EAAGrwG,KAAKswG,SAGVtwG,KAAKkB,UAAYlB,KAAKoK,QAAQlF,cAAc,oCAC5ClF,KAAK6vG,OAAS7vG,KAAKoK,QAAQlF,cAAc,eACzClF,KAAKuP,WAAY,EAAAw5D,GAAA,GAAe/oE,KAAK6vG,OAAQ7vG,KAAKkB,UAAWlB,KAAKyvG,kBAAkB,KAClF,MAAM3+F,EAAM9Q,KAAKyP,KAAKzP,KAAKwvG,OACxB1+F,EAAIzB,MACLyB,EAAIzB,OAGNyB,EAAItB,qBAAuBsB,EAAItB,sBAC/BoyB,EAAA,mBAAqC,EAAOiqE,OAG9C7rG,KAAK0vG,aAAe1vG,KAAKoK,QAAQlF,cAAc,sBAC/ClF,KAAK0vG,aAAatvG,iBAAiB,SAAS,KACxB,IAAfJ,KAAKwvG,MACF,eAA4BvB,KAC9B,aAA0BA,IAAgB9+F,OAGxC,eAA4Bm+F,KAC9B,aAA0BA,IAAYn+F,UAK5CnP,KAAK2vG,UAAY3vG,KAAKoK,QAAQlF,cAAc,sBAC5ClF,KAAK2vG,UAAUvvG,iBAAiB,SAAUC,I,MACxC,MAAMN,EAAQ,4BACa,QAAvB,EAAAA,EAAMy+B,iBAAiB,eAAEn3B,SAC3BtH,EAAM0E,iBAAiBnE,SACfP,EAAMy+B,YACVz+B,EAAMy+B,UAAU7L,YAAYhyB,OAG9BZ,EAAMy+B,UAAU7L,YAAc5yB,EAAMy+B,UAAU7L,YAAYjyB,MAAM,GAAI,GAFpEX,EAAMy+B,UAAUl+B,UAMpB,MAAMg0B,EAAQ,IAAIkX,MAAM,QAAS,CAACC,SAAS,EAAM7jB,YAAY,IAC7D,yCAAmD0M,IAGnD,EAAArM,EAAA,GAAY5nB,MAGd,MAAMkwG,EAAiB,GAAAC,gBAEjBC,EAAcF,EAAiB,EAAI,EAczC,OAZGA,GACAvwG,KAAK6vG,OAAO/pF,SAAS,GAAmB1mB,UAAUC,IAAI,QAGxDW,KAAK6vG,OAAO/pF,SAAS2qF,EAAc,GAAqB39D,QACtD9yC,KAAKyP,KAAKghG,GAAaphG,MACxBrP,KAAKyP,KAAKghG,GAAaphG,OAGzB,oBAA8B,eAAgBrP,KAAK4vG,aACnD5vG,KAAK4vG,cAEE/vG,MAAMwP,OA8HRqhG,uBAAuBjiF,EAAyC48E,GACrErrG,KAAKI,iBAAiB,SAAS,KAC7BquB,EAAczQ,UAGhBhe,KAAKI,iBAAiB,UAAU,KAC9B,MAAM6pG,EAAOx7E,EAAc5P,YAAYzB,aAEvC,IAAI,MAAM/Y,KAAO4lG,EACfoB,EAAoBhnG,GAGtBoqB,EAAc5P,YAAYxB,kBAG5Brd,KAAKI,iBAAiB,UAAU,KAC9BquB,EAAc1Q,sBAIX4yF,gBACL,OAAO3wG,KAAKmwG,gBAAkBnwG,KAAKkwG,WAG7BC,eACN,MAAMpxD,EAAMjgD,SAAS+/D,eACrB,GAAG9f,EAAI6xD,YAAc9xG,SAAS+xG,gBAAkB,2BAC9C,OAAO9xD,EAAI+xD,WAAW,IA3SZ,GAAAriF,cAAgB,IAAInP,GAkLpB,GAAAurF,YAAc,CAAChtC,EAAmBnoB,EAAoBw3D,EAA0BxkC,EAAS,KACrG,IAAIqoC,GAAY,EAEhB,MAAM/lG,EAAawF,GACdA,IAAOk4D,IAIV7K,EAAK/3C,SAAS4iD,GAAQtpE,UAAUkB,OAAO,UACvCu9D,EAAK/3C,SAAStV,GAAIpR,UAAUC,IAAI,UAChCqpE,EAASl4D,GAEF,GAGHs6F,EAAoB,IAAI/L,GAAkBrpD,EAAOx0C,WAAW,CAAC8vG,EAAO7pG,KAGxE,GAAGxE,KAAKoE,IAAIgqG,EAAWr7D,EAAOx0C,UAAUujD,YAAc,EACpD,OAEAssD,GAAY,EAGd,MAAME,GAAQ,EAAAh2C,GAAA,GAAW9zD,IACrB6pG,GAASC,IAIbjmG,EAAUimG,GAEP/D,IACE+D,EAAQpzC,EAAK5yD,kBAAoB,EAClCiiG,EAAWhsG,UAAUgwG,WAA2B,IAAbD,EAAQ,GAE3C/D,EAAWhsG,UAAUgwG,WAAqB,GAARD,OA+BxC,OA1BApzC,EAAKz9D,iBAAiB,SAAUC,IAC9B,IAAI8G,EAAS9G,EAAE8G,OAGf,GAFAA,GAAS,EAAAwyB,GAAA,GAAgBxyB,EAAQ,6BAE7BA,EACF,OAGF,MAAM8pG,GAAQ,EAAAh2C,GAAA,GAAW9zD,GAMzB,IAAI6D,EAAUimG,GACZ,OAGF,MACM5nC,GADW3zB,EAAOzD,SAAWyD,EAAOx0C,WAAW4kB,SAASmrF,GACpC5nC,UAAY,EAEtC3zB,EAAOx0C,UAAUujD,UAAYssD,EAAW1nC,KAKnC,CAACyhC,kBAAAA,EAAmB9/F,UAAAA,IAGf,GAAAu+D,aAAe,CAAClpE,EAAoC8wG,GAAa,KAC7E,IAAIhqG,EAAS9G,EAAE8G,OAGf,GAFAA,GAAS,EAAAsxC,GAAA,GAAUtxC,EAAQ,QAEvBA,EAAQ,OAAO,EAEnB,MAAMk9E,EAASl9E,EAAOS,QAAQk7B,MAC9B,QAAIuhD,IAED,sCAAgDA,OAAQr6E,EAAWmnG,IAGjEC,GAAkBlwG,YACnBkwG,GAAkBvC,YAAa,EAC/BuC,GAAkBlwG,UAAU9B,UAAUC,IAAI,iBAC1C+xG,GAAkB5tG,QAAO,KAGpB,IAEPkK,QAAQ+7D,KAAK,oBAAqB4a,IAC3B,KAoCb,MAAM+sB,GAAoB,IAAIxG,GAC9B,uBAAmCwG,GACnC,Y,sTC3OA,MACMC,GAA6D,IAAIzyF,IAAI,CACzE,4BACA,4BAIWu9E,GAAiE,IAAIv9E,IAE/E,MACDu9E,GAAmB98F,IAAI,0BAGzB,MAAMiyG,QAA4BtnG,EAClC,IAAIunG,GAAcD,GAEdnhF,GAAU,EAId,MACawpE,GAAgB,EAEvB6X,GAAqB,IAAI1xE,MAAM,gBAgBrC,SAAS2xE,GAAqBt4E,GAC5B,OAAOx2B,KAAKH,OAAO22B,GAGN,MAAMu4E,GAwGnB9xG,YACUwiC,EACAzvB,GAkbR,IAAI+b,EAnbI,KAAA0T,KAAAA,EACA,KAAAzvB,SAAAA,EAhGF,KAAAg/F,UAAY,IAAI/yF,IACjB,KAAAknF,WAAuE,GAEvE,KAAAr6D,QAAwC,GACxC,KAAAw5B,YAA2B,IAAIrmD,IAC/B,KAAAgzF,sBAAqD,GACrD,KAAAC,WAAsC,GACrC,KAAAC,aAKH,GAEG,KAAAC,cAAe,EACf,KAAAC,mBAAqB,EAIrB,KAAAC,SAAqC,IAAIhhG,IACzC,KAAAihG,aAA4B,IAAItzF,IAKhC,KAAAsJ,UAAkC,KAEnC,KAAAiqF,qBAAsC,KACrC,KAAAC,cAAgE,GAEhE,KAAAC,gCAA8C,KAE9C,KAAAC,kBAAiC,KAKjC,KAAA5jF,YAAa,UAMb,KAAA6jF,mBAA+B,GAE/B,KAAApoD,4BAA6B,EAG7B,KAAAqoD,aAAc,EAKd,KAAAC,aAEH,GAOG,KAAAC,UAAyB,IAAI9zF,IAG7B,KAAA+zF,iBAAkB,EAclB,KAAAC,kBAAiC,IAAIh0F,IAIrC,KAAAi0F,eAAmC,IAAIj0F,IACvC,KAAAk0F,iBAAkD,IAAI7hG,IAItD,KAAA8hG,cAAwB,EAExB,KAAAC,kBAAuC,IAAIp0F,IA4uB3C,KAAAq0F,yBAA4Bl2F,IAClC,GAAGA,EAAMC,eAAgB,CACvB,MAAM7V,EAAS4V,EAAM5V,OACf8F,EAAMjN,KAAKiyG,SAASzgG,IAAIrK,GAC9BnH,KAAKkzG,qBAAqB/rG,EAAQ8F,KAI9B,KAAAkmG,sBAAyBp2F,IAC/B,GAAGA,EAAMC,eAAgB,CACvB,MAAM/P,GAAQ8P,EAAM5V,OAAuBS,QAAQqF,IAGnD,GAFAjN,KAAK2c,SAASkB,UAAUd,EAAM5V,OAAQnH,KAAKmzG,uBAExClmG,EACDjN,KAAK0yG,UAAUrzG,IAAI4N,GACnBjN,KAAKozG,gCACA,CACL,MAAM,iBAACC,GAAoBrzG,KACxBqzG,GAAoBA,EAAiBC,mBAC/BD,EAAiBC,UACxBtzG,KAAK2S,SAASoH,gBAAgBw5F,qBAAqBvzG,KAAKuM,OAAO8hB,WAAYglF,EAAiBC,eA4H5F,KAAAE,mBAA2BnzG,GAAkB,mCACnD,MAAM0O,GAAU,EAAA4qB,GAAA,GAAgBt5B,EAAE8G,OAAQ,kBAC1C,GAAG4H,IAAY/O,KAAKoiC,KAAKkpB,UAAUC,YAAa,CAC9C,MAAMlkB,GAAS,EAAA1N,GAAA,GAAgB5qB,EAAS,UACxC,IAAI/O,KAAKoiC,KAAKkpB,UAAUwY,gBAAgBz8B,GAEtC,YADArnC,KAAKyzG,kBAIP,IAAI,YAACC,EAAW,cAAEC,GAAiB3zG,KACnC,GAAGqnC,IAAWqsE,EACZ,OAQF,GALA1zG,KAAKyzG,kBAELC,EAAc1zG,KAAK0zG,YAAcrsE,EACjCssE,EAAgB3zG,KAAK2zG,cAEjBA,EA0DMA,EAAc/rG,QAAQooC,QAC9BhwC,KAAK4zG,gBAAgBD,GAAe,OA3DnB,CACjBA,EAAgB3zG,KAAK2zG,cAAgB70G,SAASC,cAAc,OAC5D40G,EAAcv0G,UAAUC,IAAI,yBAE5B,MAAMw0G,EAAiB/0G,SAASC,cAAc,OAC9C80G,EAAez0G,UAAUC,IAAI,iCAC7Bs0G,EAAcj0G,OAAOm0G,GAErB9kG,EAAQrP,OAAOi0G,GAEf,IAAItmG,QAAiBrN,KAAKoiC,KAAKy/D,YAAYx6D,EAAOz/B,QAAQqF,KAC1DI,QAAgBrN,KAAK2S,SAAS40B,mBAAmBusE,sBAAsBzmG,GAEvE,MAAMqhB,EAAa1uB,KAAK+zG,eAAc,IAAM/zG,KAAK2zG,gBAAkBA,IACnExwG,QAAQC,IAAI,CACVpD,KAAK2S,SAASwnC,oBAAoB65D,+BAA+B3mG,IACjE,QAAM,OACL3L,MAAK,EAAEw4C,MACR,MAAMY,EAAoBZ,EAAmB,GACzCY,EAKJ,GAAY,CACVz2C,IAAKwvG,EACLr5E,IAAKsgB,EAAkBm5D,iBACvB1yG,MAAO,GACPC,OAAQ,GACRikC,aAAa,EACb/W,WAAAA,EACAyR,MAAOq5B,GACP90B,WAAW,EACXrd,YAAY,IACX3lB,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQ9uB,MAAM0pF,KAClC,EAAAzmD,GAAA,GAA0BymD,GACtB18D,MAIJ08D,EAAOhrF,iBAAiB,cAAc,KAChCsuB,MAKJilF,EAAc/rG,QAAQooC,OAAS,IAC/BhwC,KAAK4zG,gBAAgBD,GAAe,MACnC,CAACnsG,MAAM,KAEV,QAAiBmsG,GAAgBtzG,KAC/B,EAAA4nB,EAAA,GAAY5nB,GAEZL,KAAK2S,SAASwnC,oBAAoB+5D,aAAa7mG,EAASytC,EAAkBC,UAC1E/6C,KAAKyzG,oBACJ,CAACxqG,eAAgBjJ,KAAKiJ,qBAnCzB0qG,EAAcrzG,kBA0CpBN,KAAKyzG,qBAiBD,KAAAA,gBAAkB,KACxB,MAAM,YAACC,EAAW,cAAEC,GAAiB3zG,KAClC0zG,IACD1zG,KAAK4zG,gBAAgBD,GAAe,GACpC3zG,KAAK0zG,iBAAc1pG,EACnBhK,KAAK2zG,mBAAgB3pG,IAqJlB,KAAAmqG,eAAuB9zG,GAAa,mC,MACzC,IAAI8G,EAAS9G,EAAE8G,OACXkgC,EAAsB,KAC1B,IACEA,GAAS,EAAA1N,GAAA,GAAgBxyB,EAAQ,UACjC,MAAMsG,IAER,IAAI45B,IAAWrnC,KAAKoiC,KAAKkpB,UAAUC,YAAa,CAC9C,MAAM5H,GAAS,EAAAhqB,GAAA,GAAgBxyB,EAAQ,eACvC,IAAIw8C,EACF,OAGF,MAAMp3C,EAASo3C,EAAO/7C,QAAQ2E,OAAOsO,WAMrC,YALGtO,IAAW,MACZvM,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAAC9nG,OAAAA,IAErCo/B,GAAM,YAAY,cAAc,KAKpC,GAAGtE,EAAOjoC,UAAUiG,SAAS,aAAc,EAAAs0B,GAAA,GAAgBxyB,EAAQ,kBAAmB,CACpF,GAAGkgC,EAAOjoC,UAAUiG,SAAS,eAAiBrF,KAAKs0G,UAAUl1G,UAAUiG,SAAS,gBAC9E,OAGF,IAAI,MAAM+O,KAAapU,KAAK8xG,aAE1B,GADU9xG,KAAK8xG,aAAa19F,GACvB/P,MAAQgjC,EAAQ,CACnB,gBAAyBu1D,GAAiB,IAAIl3F,MAAM0O,GAAYpU,KAAKu0G,YAAYrlE,OACjF,MAIJ,OAGF,IAAI,OAAsB,EAAAvV,GAAA,GAAgBxyB,EAAQ,QAEhD,YADAnH,KAAKoiC,KAAKkpB,UAAUE,gBAAgBnkB,GAKtC,GAAGrnC,KAAKoiC,KAAKkpB,UAAUC,aAAelrD,EAAEkjC,UAAW,CACjD,GAAG8D,EAAOjoC,UAAUiG,SAAS,iBAAqC2E,IAAvBq9B,EAAOz/B,QAAQqF,IACxD,OAMF,OAHA,EAAAgb,EAAA,GAAY5nB,GAGT,MAAsBL,KAAKoiC,KAAKkpB,UAAU6V,kBAC3CnhE,KAAKoiC,KAAKkpB,UAAU6V,kBAAen3D,QAKrChK,KAAKoiC,KAAKkpB,UAAUE,iBAAgB,EAAA7xB,GAAA,GAAgBxyB,EAAQ,iBAAmBkgC,GAIjF,MAAMmtE,GAA0B,EAAA76E,GAAA,GAAgBxyB,EAAQ,WACxD,GAAGqtG,EAID,YAHAx0G,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQioG,EAAW5sG,QAAQ2E,OAAOsO,aAKtC,MAAM45F,GAAuB,EAAA96E,GAAA,GAAgBxyB,EAAQ,eACrD,GAAGstG,EAED,YADAz0G,KAAKoiC,KAAKgyE,aAAaM,SAAS10G,KAAKuM,OAAOqO,WAAY65F,EAAQ7sG,QAAQ3H,MAI1E,MAAM00G,GAAuB,EAAAh7E,GAAA,GAAgBxyB,EAAQ,WACrD,GAAGwtG,EAAS,CACV,MAAMzP,GAAa,EAAAvrE,GAAA,GAAgBg7E,EAAS,WAEtCh2G,EAAY,qBACZ2e,EAAY4nF,EAAW9lG,UAAUiG,SAAS1G,GAC5C2e,IACF,EAAA2K,EAAA,GAAY5nB,GAGd,MAAMwF,EAAW,IACX+uG,EAAe,IACf9qF,EAAWxM,EAAgB,EAAJ,EAC1BwM,GACDo7E,EAAW9lG,UAAUC,IAAI,eAG3B,MAAMw1G,EAAiB3P,EAAWt9F,QAAQitG,eAe1C,OAdsB,OAAnBA,IACD1mG,cAAc0mG,UACP3P,EAAWt9F,QAAQitG,qBAG5B,QAAc3P,EAAYvmG,GAAW,EAAMkH,GAAU,KACnDq/F,EAAWt9F,QAAQitG,eAAiB,GAAK/uG,OAAOM,YAAW,MACzD,QAAc8+F,EAAYvmG,GAAW,EAAOkH,GAAU,KACpDq/F,EAAW9lG,UAAUkB,OAAO,sBACrB4kG,EAAWt9F,QAAQitG,oBAE3BD,KACF9qF,GAKL,MAAM83E,GAAkB,EAAAnpD,GAAA,GAAUtxC,EAAQ,oBAC1C,GAAGy6F,EAAiB,CAElB,IADA,EAAA35E,EAAA,GAAY5nB,GACTuhG,EAAgBxiG,UAAUiG,SAAS,eACpC,OAGF,MAAM2+F,EAAmBpC,EAAgBh+F,cACnCo8F,EAAgBgE,EAAiBrC,iBAAiBC,GAElDv0F,EAAU22F,EAAiBnC,aAGjC,YAFA7hG,KAAK2S,SAASwnC,oBAAoB+5D,aAAa7mG,EAAS2yF,EAAcjlD,UAMxE,IADiC,EAAAphB,GAAA,GAAgBxyB,EAAQ,WACzC,CACd,MAAM2tG,GAAaztE,EAAOz/B,QAAQqF,IAClC,GAAGjN,KAAKuM,SAAW,MAAiB,CAClC,MAAMc,QAAgBrN,KAAKoiC,KAAKy/D,WAAWiT,GACrCvoG,GAAS,EAAAusC,GAAA,GAAUzrC,EAAQo4F,SAASC,kBACpC75F,EAAWwB,EAAQo4F,SAASsP,gBAC5BzxC,EAAYj2D,EAAQ2qB,SAASg9E,kBACnCh1G,KAAKoiC,KAAKgyE,aAAaa,WAAW1oG,EAAQ+2D,EAAWz3D,OAChD,CACL,MAAMqpG,QAAiBl1G,KAAKoiC,KAAKy/D,WAAWiT,GACtCznG,QAAgBrN,KAAK2S,SAAS40B,mBAAmB4tE,sBAAsBD,GACvEhnF,EAAU7gB,EAAQ6gB,QACrBA,GACDluB,KAAK2S,SAAS40B,mBAAmB6tE,qBAAqBp1G,KAAKuM,OAAQc,EAAQJ,KAAKvL,MAAM2L,IACpFrN,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQ2hB,EAAQE,WAAWvT,UAAS,GACpC5a,KAAM,aACN4L,SAAWwB,EAAsBJ,SAMzC,OAGF,MAAMooG,GAAM,EAAA17E,GAAA,GAAgBxyB,EAAQ,UACpC,GAAGkuG,EAAK,CACN,MAAM9jG,EAAK8jG,EAAInwG,cAAc,eAC7B,GAAGiC,IAAWoK,IAAM,EAAAuuD,GAAA,GAAc34D,EAAQoK,GAAK,CAC7C,MAAMlE,EAAUkE,EAAG0tB,UAAY,IAI/B,OAHAj/B,KAAK2S,SAASilE,iBAAiB09B,SAASt1G,KAAKuM,OAAQvM,KAAKoiC,KAAKv2B,SAAUwB,QACzE,EAAA4a,EAAA,GAAY5nB,IAMhB,MAAM+iC,GAAU,EAAAzJ,GAAA,GAAgBxyB,EAAQ,gBAAiB,EAAAsxC,GAAA,GAAUtxC,EAAQ,oBAAqB,EAAA8rC,GAAA,GAAgB9rC,EAAQ,mBACxH,GAAGi8B,GAAWA,IAAYiE,EAAQ,CAChClgC,EAASi8B,GAAWj8B,EACpB,MAAMouG,EAAYpuG,EAAOS,QAAQ2E,QAAUpF,EAAOg1E,aAAa,SAAYh1E,EAAyBoF,OAC9FwqD,EAAY5vD,EAAOS,QAAQmvD,UACjC,GAAyB,iBAAhB,GAA4BA,EACnC,GAAGA,EAAW,CACZ,MAAOxqD,EAAQU,GAAO8pD,EAAUr0B,MAAM,KAEtC1iC,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQA,EAAOsO,WACfyoD,WAAYr2D,QAET,CACL,MAAMV,EAASgpG,EAAU16F,WACtBtO,IAAW,MACZvM,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAAC9nG,OAAAA,IAErCo/B,GAAM,YAAY,cAAc,IAKtC,OAaF,GAAGtE,EAAOjoC,UAAUiG,SAAS,YAAc8B,EAAOvD,cAAcxE,UAAUiG,SAAS,cAAe,CAChG,MAAMmwG,GAAanuE,EAAOz/B,QAAQqF,IAG5ButB,EAA+E,QAAxE,SAFSx6B,KAAKoiC,KAAKy/D,WAAW2T,IAEDxnF,aAA2C,eAAElvB,SAMvF,aAJG07B,MAAAA,OAAG,EAAHA,EAAK2pD,kBACN,IAAID,GAAc1pD,EAAI2pD,iBAAiBj1C,QAM3C,MAAMumE,GAAc,EAAA97E,GAAA,GAAgBxyB,EAAQ,uBAC5C,GAAuB,QAAnBA,EAAOE,UAAsBF,EAAO/H,UAAUiG,SAAS,WAAa8B,EAAO/H,UAAUiG,SAAS,mBAC7F8B,EAAO/H,UAAUiG,SAAS,eAEN,UAAnB8B,EAAOE,UAAwBggC,EAAOjoC,UAAUiG,SAAS,UACzDowG,IAAgBA,EAAYvwG,cAAc,yBAC3CiC,EAAO/H,UAAUiG,SAAS,oBAAqB,CAClD,MAAMqwG,GAAc,EAAA/7E,GAAA,GAAgBxyB,EAAQ,gBAAiB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,sBAC/EquG,IAAcE,GAAeruE,GAAQz/B,QAAQqF,IAC7CI,QAAgBrN,KAAKoiC,KAAKy/D,WAAW2T,GAC3C,IAAInoG,EAEF,YADArN,KAAK8zB,IAAI21C,KAAK,2BAA4B+rC,GAI5C,MAAMttF,GAAawtF,GAAeruE,GAAQniC,cAA2B,wBACrE,GAAGgjB,EAGD,OAFA,QAAmBA,QACnB,EAAAD,EAAA,GAAY5nB,GAId,MAAMs1G,EAAyB,UACzBC,EAAgBvuE,EAAOjoC,UAAUiG,SAASswG,GAE1ClrF,EAAIgrF,EAAeznF,GAChB07C,GAAemsC,mCAAmC7nF,GACtDA,GACgB,UAAZA,EAAMphB,GAAiB,CAAC,QAAS,OAAOxF,SAAS4mB,EAAM/tB,MAG1Dwd,EAAiE,GACjEuvD,EAAM4oC,EAAgB,CAACJ,UAAoBryG,QAAQC,IAAI+oF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9wB,KAAKlD,IAAOA,IAAGkD,KAAU1N,GAAQ,mCAMtH,MAAMI,QAAgBrN,KAAKoiC,KAAKy/D,WAAW50F,GACrC+gB,GAAQ,EAAAyM,GAAA,GAAoBptB,GAElC,OAAO2gB,GAASvD,EAAEuD,IAAU/gB,SACzB0e,OAAO6kB,SAAS8K,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IAExCiiB,EAAI5/D,SAASoD,IACX,IAAIwpB,EACDy7E,EACDz7E,EAAW,uBAGXA,EAAW,qEAETA,GAHeh6B,KAAKyrC,QAAQj7B,GAAIpR,UAAUiG,SAAS,mBAGvC,2BAEA,sCAIhB,MAAM40B,EAAW7oB,MAAMC,KAAKrR,KAAKyrC,QAAQj7B,GAAIc,iBAAiB0oB,IACxD87E,EAA4B,IAAIl3F,IACtC,GAAG62F,EACDx7E,EAAS7sB,SAAShD,IAChBqT,EAAQ5L,KAAK,CACXzH,QAASA,EAAQlF,cAAc,iBAC/B+H,KAAM7C,EAAQxC,QAAQqF,IACtBV,OAAQvM,KAAKuM,gBAGZ,CACL,MAAMwpG,IAAgB/1G,KAAKyrC,QAAQj7B,GAAItL,cAAc,6BACrD+0B,EAAS7sB,SAAShD,IAChB,GAAG2rG,KAAgB,EAAAp8E,GAAA,GAAgBvvB,EAAS,4BAA6B,OACzE,IAAI4rG,GAAY,EAAAr8E,GAAA,GAAgBvvB,EAAS,cACzC,MAAMs2D,EAASs1C,GAAa5rG,EAAQxG,cACjCkyG,EAAQ3jE,IAAIuuB,KACfo1C,EAAQz2G,IAAIqhE,GACZjjD,EAAQ5L,KAAK,CACXzH,QAAAA,EACA6C,IAAK+oG,GAAaA,EAAUpuG,QAAQqF,IAAMuD,EAC1CjE,OAAQvM,KAAKuM,iBAMrBkR,EAAQ69B,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAE35B,IAAM89C,EAAE99C,MAEjC,IAAIoR,EAAMZ,EAAQa,WAAWjM,GAAMA,EAAEpF,MAAQuoG,IAM7C,OAJG,MACDx1G,KAAK8zB,IAAI,oCAAqCk5C,EAAK3uD,EAAKZ,GAGtDA,EAAQY,KAKZ,IAAIqrD,IACHC,iBAAiB,CAChB99D,SAAU7L,KAAKoiC,KAAKv2B,SACpBU,OAAQvM,KAAKuM,OACbI,YAAa,CAACC,EAAG6oG,EAAc,8BAAgC,iCAC/Dp2E,UAA8B,cAAnBr/B,KAAKoiC,KAAKniC,OAAyB21G,EAC9C5zC,YAAgC,cAAnBhiE,KAAKoiC,KAAKniC,OAExB4pE,UAAUx8D,EAASoQ,EAAQY,GAAKjU,QAAS,GAAG,EAAMqT,EAAQ/c,MAAM,EAAG2d,GAAMZ,EAAQ/c,MAAM2d,EAAM,SAE9F,EAAA4J,EAAA,GAAY5nB,SAdVL,KAAK8zB,IAAI,8BAA+B3sB,GAqB5C,IAFkE,IAA/D,CAAC,MAAO,MAAO,QAAmBqP,QAAQrP,EAAOE,WAAiBF,GAAS,EAAAsxC,GAAA,GAAUtxC,EAAQ,SAEhD,IAA7C,CAAC,MAAO,QAAQqP,QAAQrP,EAAOE,SAAiD,CACjF,GAAGF,EAAO/H,UAAUiG,SAAS,iBAAkB,CAC7C,MAAM0xD,EAAY1vB,EAAOz/B,QAAQmvD,WAC1BxqD,EAAQU,GAAO8pD,EAAUr0B,MAAM,KAMtC,YAJA1iC,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQA,EAAOsO,WACfyoD,WAAYr2D,IAGT,GAAG9F,EAAO/H,UAAUiG,SAAS,WAAY,CAC9C,MAAM4H,GAAOo6B,EAAOz/B,QAAQqF,IACtBI,QAAgBrN,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiB92D,KAAKuM,OAAQU,GAKrF,YAJA,IAAI6wD,GAAa,CACf,CAAC99D,KAAKuM,cAAevM,KAAK2S,SAAS40B,mBAAmB+wB,iBAAiBjrD,KAM3E,IAAI4oG,GAAe,EAEnB,IACEA,KAAiB,EAAAt8E,GAAA,GAAgBt5B,EAAE8G,OAAQ,SAC3C,MAAMsG,IAER,GAAGwoG,GAAgB5uE,EAAOjoC,UAAUiG,SAAS,YAA6D,CACxG,MAAMyvG,GAAaztE,EAAOz/B,QAAQqF,IAClCjN,KAAKuyG,mBAAmB1gG,KAAKijG,GAE7B,MAAMznG,QAAiBrN,KAAKoiC,KAAKy/D,WAAWiT,GAEtCtP,EAAgBn4F,EAAQo4F,SAASC,kBAAmB,EAAA5sD,GAAA,GAAUzrC,EAAQo4F,SAASC,kBAAoB1lG,KAAKuM,OACxG2pG,EAAa7oG,EAAQo4F,SAAS0Q,gBAEpCn2G,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQi5F,EACRliC,UAAW4yC,EACXj2G,KAAMD,KAAKoiC,KAAKniC,KAChB4L,SAAU7L,KAAKoiC,KAAKv2B,gBAwLrB,KAAAi5B,SAAW,CAACsxE,EAAgCC,K,QAGjD,GAAGr2G,KAAKmqD,4BAMN,GALGnqD,KAAKs2G,wBACNt2G,KAAKs2G,uBAAuBnoG,eAI3BnO,KAAK+xG,eAAiBqE,EACvB,YAGCp2G,KAAKoiC,KAAKm0E,OAAO1/C,eAClB72D,KAAKoiC,KAAKm0E,OAAO1/C,cAAc2/C,yBAAyBx2G,KAAK8L,WAAW2qG,qBAGvEz2G,KAAKs2G,wBACNt2G,KAAKs2G,yBAGPt2G,KAAK02G,wBAKP,GAAGL,GAAoBA,EAAiBM,cApzDZ,KAozDuD32G,KAAK+xG,aACtF,OAGF,MAAM4E,EAA+C,QAA/B,EAAAN,MAAAA,OAAgB,EAAhBA,EAAkBM,qBAAa,QAAI32G,KAAK8L,WAAW8qG,oBACA,IAAxC52G,KAAK8L,WAAW2qG,qBAA6BE,EAAgB,GAAMN,KAE/Fr2G,KAAKgyG,mBACN7jG,aAAanO,KAAKgyG,oBACThyG,KAAKs0G,UAAUl1G,UAAUiG,SAAS,iBAC3CrF,KAAKs0G,UAAUl1G,UAAUC,IAAI,gBAG/BW,KAAKgyG,mBAAqBlsG,OAAOM,YAAW,KAC1CpG,KAAKs0G,UAAUl1G,UAAUkB,OAAO,gBAChCN,KAAKgyG,mBAAqB,IACzB,MAAkC,QAA1B,EAAAqE,MAAAA,OAAgB,EAAhBA,EAAkBxwG,gBAAQ,QAAI,KAGxC8wG,EAv0DyB,MAu0DmB32G,KAAK8L,WAAW0hG,UAAUl3E,QAAUt2B,KAAKoiC,KAAKy0E,iBAAmB72G,KAAKuM,SACnHvM,KAAKkB,UAAU9B,UAAUC,IAAI,iBAC7BW,KAAK+xG,cAAe,GACZ/xG,KAAKkB,UAAU9B,UAAUiG,SAAS,mBAC1CrF,KAAKkB,UAAU9B,UAAUkB,OAAO,iBAChCN,KAAK+xG,cAAe,IA4gFjB,KAAAwC,WAAcngG,IACnB,MAAM7H,EAASvM,KAAKuM,OACpBvM,KAAK2S,SAAS40B,mBAAmBuvE,eAAevqG,EAAQ,EAAG,GAAI,EAAG6H,EAAWpU,KAAKoiC,KAAKv2B,UAAUnK,MAAMsL,I,OAChF,QAAjB,EAAAA,MAAAA,OAAO,EAAPA,EAAShB,gBAAQ,eAAErL,QAGbX,KAAKuM,SAAWA,GAI1BvM,KAAKoiC,KAAK20E,aAAc/pG,EAAQhB,SAAS,GAAiBiB,KANxDjN,KAAK8zB,IAAInmB,MAAM,mBA3tInB3N,KAAK8zB,IAAM9zB,KAAKoiC,KAAKtO,IAGrB9zB,KAAKiJ,eAAiB,IAAI,IAE1BjJ,KAAKg3G,mBAILh3G,KAAKi3G,aAAe,IAAIpd,GAAa75F,KAAKoiC,MAC1CpiC,KAAKkoB,UAAY,IAAIV,GAAqB,CACxCI,YAAY,IAEd5nB,KAAKyuB,cAAgB,IAAInP,GACzBtf,KAAKyuB,cAAc0B,UAAYA,GAO/BnwB,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAOo3D,WAAAA,EAAY8/C,WAAAA,EAAY7pG,QAAAA,KAAa,mCAC/F,GAAGrN,KAAKoiC,KAAK+0E,qBAAuB//C,GAAiC,cAAnBp3D,KAAKoiC,KAAKniC,KAC1D,OAGF,MAAM,IAACgN,GAAOI,EAIRg6B,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,IAAIo6B,EAAQ,OAYZ,GAVGrnC,KAAKgzG,kBAAkBhyG,aAElBmC,QAAQC,IAAIgO,MAAMC,KAAKrR,KAAKgzG,qBAGjChzG,KAAKmyG,6BAEAnyG,KAAKmyG,sBAGVnyG,KAAKyrC,QAAQx+B,KAASo6B,EAAQ,OAIjC,MAAMtoB,EAAO/e,KAAKi3G,aAAa5c,gBAAgBhzD,GAC/C,IAAItoB,EAEF,OACK,GAAGA,EAAK9R,MAAQA,EAErB,OAGF,GAAGiqG,EAAY,CACb,MAAM/2E,EAAQphB,EAAKohB,MACbi3E,EAAUp3G,KAAKi3G,aAAa/a,WAAW70D,EAAQh6B,GAE/CgqG,EAASr3G,KAAKi3G,aAAand,SAASp5F,SAC1C,EAAAqR,EAAA,GAAiBslG,EAAQt4F,GACzB,MAAM29E,EAAY18F,KAAKi3G,aAAaxb,uBAAuB2b,EAASC,GACpE,GACEl3E,KAAUu8D,MAAAA,OAAS,EAATA,EAAWv8D,QACjBA,IAAUngC,KAAKi3G,aAAahc,gBAAyC,IAAvB96D,EAAM1jB,MAAM9b,QAAgBy2G,EAAQvpC,gBAAkB9uD,EAAK8uD,eACzG7tE,KAAKuM,SAAW,UAAkB2qG,GAAcE,EAAQvpC,gBAAkB9uD,EAAK8uD,cAInF,YADA7tE,KAAKi3G,aAAa/b,gBAAgB7zD,EAAQp6B,GAW9CjN,KAAKi3G,aAAa7c,uBAAuB/yD,GAoCzC,MAAM,OAACoiD,GAAUzpF,KAAKs3G,aAAa,CAAC,CAACjwE,OAAAA,EAAQh6B,QAAAA,KAC7CrN,KAAKi3G,aAAarc,mBAAmBnR,GAElCzpF,KAAKu3G,mBACNv3G,KAAKw3G,mBAQTx3G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAgB,EAAEuM,OAAAA,MAChDvM,KAAKuM,SAAWA,GACjBvM,KAAKy3G,oBAAoBtrB,OAAOzuE,KAAK1d,KAAKyrC,SAAS9wB,KAAKkR,IAAOA,QAKnE7rB,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAsBK,GAAM,mCAC7D,MAAM,WAAC+2D,EAAU,OAAE3vC,EAAM,YAAEiwF,EAAW,IAAEzqG,EAAG,QAAEI,GAAWhN,EAGxD,GAAGL,KAAKoiC,KAAK+0E,qBAAuB//C,EAClC,OAGF,MAAM3rB,EAAUzrC,KAAKyrC,QACfksE,EAAUlsE,EAAQhkB,GACxB,GAAGkwF,EAAS,CACV,MAAMtwE,EAASoE,EAAQhkB,GACvBgkB,EAAQx+B,GAAOo6B,EACfA,EAAOz/B,QAAQqF,IAAM,GAAKA,SACnBw+B,EAAQhkB,IAEf,UAAQ,KACN,MAAMxa,GAAOo6B,EAAOz/B,QAAQqF,IACzBw+B,EAAQx+B,KAASo6B,GAAUA,EAAOjoC,UAAUiG,SAAS,iBACtDgiC,EAAOjoC,UAAUkB,OAAO,aAAc,eACtC+mC,EAAOjoC,UAAUC,IAAKW,KAAKuM,SAAW,UAAqC,cAAnBvM,KAAKoiC,KAAKniC,OAA0BD,KAAK2xG,UAAUx/D,IAAIllC,GAAO,UAAY,eAmBxI,GAdGjN,KAAK2xG,UAAUx/D,IAAI1qB,KACpBznB,KAAK2xG,UAAUjiG,OAAO+X,GACtBznB,KAAK2xG,UAAUtyG,IAAI4N,IAIC,cAAnBjN,KAAKoiC,KAAKniC,OACOyF,KAAKC,MAAQ,IAAO,IACjB+xG,EAAYvkG,KAAO,IAEtCnT,KAAKy3G,oBAAoB,CAACxqG,KAI1B0qG,EACF,OAGF,IAAI3rG,EAAwD0lC,EAC5D,MAAMkmE,EAAavqG,EAA4BgrD,WAC/C,GAAGu/C,EAAW,CACZ5rG,QAAiBhM,KAAK2S,SAAS40B,mBAAmBswE,mBAAmBD,GACrE,MAAMz+E,EAAOntB,EAAS2O,KAAI,EAAE1N,IAAAA,KAASA,IACrC,IAAIksB,EAAKx4B,QAAU8wG,GAAqBt4E,KAAUlsB,GAAOw+B,EAAQx+B,KAAS0qG,EACxE,OAGF,GAAGlsE,EAAQx+B,KAAS0qG,EAClB,OAGFjmE,EAAWtgC,MAAMC,KAAKsmG,EAAQrmG,iBAAiB,kBAAoCqJ,KAAKpJ,IAAQA,EAAG3J,QAAQqF,WAE3GjB,EAAW,CAACqB,GACZqkC,EAAU,CAACjqB,GAGb,MAAMqwF,EAAoB1mG,MAAMC,KAAKsmG,EAAQrmG,iBAAiB,sBAC3DwmG,EAAkBn3G,QACnBm3G,EAAkB1qG,SAAS42F,IACzBA,EAAiBjC,cAAc10F,MAIlCrB,EAA+BoB,SAAQ,CAACC,EAASgR,K,cAChD,IAAIhR,EACF,OAGF,MAAMoa,EAASiqB,EAAQrzB,GACjBpR,EAAMI,EAAQJ,IACdo6B,EAAsBswE,EAAQzyG,cAAc,iCAAiC+H,QAAY0qG,EAE/F,GAAiB,YAAdtqG,EAAQT,EACT,OAGF,GAAGS,EAAQ6gB,QAAS,CAClB,MAAM6pF,EAAiBJ,EAAQzyG,cAAc,mBAC1C6yG,IACDA,EAAe1qG,QAAUA,EACzB0qG,EAAe1oG,QAInB,MAAM2e,EAAqB,QAAb,EAAA3gB,EAAQ2gB,aAAK,QAAI,GACzBwM,EAAOxM,EAA4ClvB,SACnDuuD,EAAQr/B,EAAwCq/B,KAChDgY,EAAWr3C,EAA2CC,QAC5D,GAAGuM,EAAK,CACN,MAAMn2B,EAAMgjC,EAAOniC,cAAc,iCAAiCuiB,iBAClE,GAAGpjB,EAAK,CACN,MAAMnD,GAAY,EAAAy4B,GAAA,GAAgBt1B,EAAK,wBAEA,QAAnC,EAA2B,QAA3B,EAAiB,QAAjB,EAAAqzG,EAAY1pF,aAAK,eAAElvB,gBAAQ,eAAEuhB,cAAM,eAAE1f,UAAoB,QAAV,EAAA65B,EAAIna,cAAM,eAAE1f,UAC7D,WAA2Be,MAAK,IAAW,mCACzC,MAAMihG,EAAWt+F,EAAIa,cAAc,SAC7B8yG,QAAez1E,GAAa,CAACl1B,QAAAA,IACnChJ,EAAIo6B,YAAYu5E,GAEbrV,GACDqV,EAAO9yG,cAAc,kBAAkBxF,OAAOijG,QAKjDzhG,IACDA,EAAU0G,QAAQqF,IAAM,GAAKA,GAIjC,MAAM7C,EAAUi9B,EAAOniC,cAAc,2BAA2BuiB,+BAAoCA,+BAAoCA,OACrIrd,IACEA,aAAmBgwB,IAAgBhwB,EAAQhL,UAAUiG,SAAS,gBAC/D+E,EAAQxC,QAAQqF,IAAM,GAAKI,EAAQJ,WAC5B7C,EAAQxC,QAAQgzB,WACtBxwB,EAAgBiD,QAAUA,EAC1BjD,EAAgB2lB,QAAO,IAExB3lB,EAAQxC,QAAQk7B,MAAQ,GAAKtI,EAAIhqB,SAGhC,GAAG68C,EAAM,CACd,MAAMmC,EAAcnoB,EAAOniC,cAAc,gBACtCsqD,IACDA,EAAYniD,QAAUA,EACtBmiD,EAAYhwD,aAAa,UAAW,GAAK6tD,EAAK78C,IAC9Cg/C,EAAYhwD,aAAa,aAAc,GAAKyN,SAEtCo4D,IAAYh+B,EAAOniC,cAAc,UACzC,WAA2BxD,MAAK,KAC9B1B,KAAKi4G,kBAAkB5qG,GAAS,EAAMg6B,GACtCrnC,KAAKk4G,qBAAqB7wE,MAK9B,GAAGuwE,EAAW,CACZ,MAAM74F,EAAQsoB,EAAOniC,cAAc,2BAA2BuiB,QAA+B4f,EAC1FtoB,IACDA,EAAKnX,QAAQqF,IAAM,GAAKA,YAMhCjN,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAgB,EAAEo3D,WAAAA,EAAY/pD,QAAAA,MAC/D,GAAG+pD,IAAep3D,KAAKoiC,KAAK+0E,mBAAoB,OAEhD,MAAM9vE,EAASrnC,KAAKyrC,QAAQp+B,EAAQJ,KAChCo6B,GAEJrnC,KAAKi4G,kBAAkB5qG,GAAS,EAAMg6B,MAGxCrnC,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,cAAc,EAAEuM,OAAAA,EAAQP,SAAAA,EAAUmsG,YAAAA,MACnE,GAAG5rG,IAAWvM,KAAKuM,OAAQ,OAE3B,MAAM4sB,EAAOntB,EAAS2O,KAAI,EAAE1N,IAAAA,KAASA,IAE/BmrG,EAAa3G,GADHt4E,EAAK7Y,OAAOlP,MAAMC,KAAK8mG,KAEjC9wE,EAASrnC,KAAKyrC,QAAQ2sE,GAC5B,IAAI/wE,EACF,OAGF,MAAMgxE,EAAU5G,GAAqBt4E,GAC/B9rB,EAAUrB,EAASoG,MAAM/E,GAAYA,EAAQJ,MAAQorG,IAC3Dr4G,KAAKi4G,kBAAkB5qG,GAAS,EAAMg6B,MAGlB,cAAnBrnC,KAAKoiC,KAAKniC,MACXD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,sBAA4B4gB,GAAQ,mCACrE,IAAI03F,EAEJ,MAAM1xE,EAAIhmB,EAAIjG,KAAI,EAAOtN,QAAAA,EAAS20F,eAAAA,KAAoB,mCACpD,GAAGhiG,KAAKuM,SAAWc,EAAQd,OACzB,OAGF,MAAM+C,QAAetP,KAAKskE,iBAAiBj3D,EAAQJ,IAAKI,GACxD,OAAIiC,EAIG,CAAC+3B,OAAQ/3B,EAAO+3B,OAAQh6B,QAAAA,EAAS20F,eAAAA,QAJxC,cAQK7+F,QAAQC,IAAIwjC,IAAIjb,OAAO6kB,SAASpjC,SAAQ,EAAEi6B,OAAAA,EAAQh6B,QAAAA,EAAS20F,eAAAA,MAC5DsW,IACFA,EAAct4G,KAAKu4G,mBAAkB,GACrCD,EAAYh1E,QAGd,MAAMzzB,EAAMxC,EAAQd,OAAS,IAAMc,EAAQJ,IACrCgQ,EAAMukF,GAAmBhwF,IAAI3B,GACnC,GAAGoN,EACD,IAAI,MAAM7S,KAAW6S,EACnB7S,EAAQiuB,OAAOhrB,EAAS20F,OAErB,KAAI30F,EAAQmvC,YAAcnvC,EAAQmvC,UAAUjyB,QAAQ5pB,OACzD,OAEAX,KAAKw4G,+BAA+BnxE,EAAQh6B,EAASA,EAAS20F,OAI/DsW,GACDA,EAAYhQ,eAKctoG,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,uBAAuB,EAAOuM,OAAAA,EAAQ4sB,KAAAA,KAAU,mCACjH,MAAMzK,EAAa1uB,KAAK+zG,sBAClB,WACFrlF,KAEHyK,EAAkB/rB,SAASH,IACPjN,KAAK8lG,WAAxB,MACM56C,EAAmC,IACzC,EAAAq9B,GAAA,GAAevoF,KAAK8lG,YAAY,CAACviC,EAAKllD,KACjCklD,EAAIwiC,WAAa94F,GAAOs2D,EAAIiiC,gBAAkBj5F,IAC/CvM,KAAK8lG,WAAWvnF,OAAOF,EAAK,GAAG,GAC/B6sC,EAASr5C,KAAK0xD,OAIlBrY,EAAS99C,SAAQ,EAAOH,IAAAA,EAAK84F,SAAAA,EAAUP,cAAAA,KAAmB,mCACxD,MAAMn+D,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,IAAIo6B,EAAQ,OAEZ,MAAMh6B,QAAiBrN,KAAKoiC,KAAKy/D,WAAW50F,GAE5C22F,GAAcyB,SAAS,CACrBjjE,KAAMpiC,KAAKoiC,KACXiF,OAAAA,EACAh6B,QAAAA,kBAMR,QAAiBrN,KAAK8L,WAAW5K,UAAWlB,KAAKm0G,eAAgB,CAAClrG,eAAgBjJ,KAAKiJ,iBAGvFjJ,KAAKiJ,eAAe5J,IAAIW,KAAK8L,WAAW5K,UAAxClB,CAAmD,aAAcK,IAC/D,GAAgB,IAAbA,EAAExB,OAAc,OAEnB,MAAM4iC,GAAoB,EAAAgX,GAAA,GAAUp4C,EAAE8G,OAAQ,QAC9C,OAAGs6B,IACD,EAAAxZ,EAAA,GAAY5nB,GCnoBlBkqC,GDooBsB9I,ECpoBM9O,kBDqoBtBiZ,GAAS,CAACC,YAAa,qBAHzB,KAQc7rC,KAAK8qG,kBAAoB,IAAI/L,GAAkB/+F,KAAK8L,WAAW5K,WAAW,CAAC8vG,EAAO7pG,KAChG,IAAI,MAAMiN,KAAapU,KAAK8xG,aAAc,CACxC,MAAM2G,EAAcz4G,KAAK8xG,aAAa19F,GACtC,GAAGqkG,EAAYv3G,YAAciG,EAAQ,CACnC,MAAMuxG,EAAaD,EAAYp0G,IAS/Bq0G,EAAWt5G,UAAUoE,OAAO,YAAawtG,GACtCA,IACDhxG,KAAK24G,mBAAqBD,GAG5B,OAID14G,KAAK24G,sBAON,GAAAhsF,YACF3sB,KAAKs2G,wBAAyB,EAAAlqE,GAAA,GAASpsC,KAAK44G,cAAc1vG,KAAKlJ,MAAO,KAAM,GAAO,KAIrF,EAAAgqE,GAAA,KAAuB,KACrBhqE,KAAKmqD,4BAA6B,EAClCnqD,KAAKyuB,cAAczQ,OACnB0Q,EAAa1uB,KAAK+zG,mBAKjB,KACD/zG,KAAKmqD,4BAA6B,EAE/Bz7B,GAAcA,MACf1uB,KAAKyuB,cAAc3Q,SACnB9d,KAAKyuB,cAAcjR,WAOrBkR,EAAa,OACZ1uB,KAAKiJ,gBAGF+tG,mBACN,MAAM91G,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DmC,EAAU9B,UAAUC,IAAI,UAAW,kBAEjBW,KAAKs0G,UAAYx1G,SAASC,cAAc,QAChDK,UAAUC,IAAI,iBAExBW,KAAK64G,YAEL33G,EAAUxB,OAAOM,KAAK8L,WAAW5K,WAG5B43G,2BACL,MAAM53G,EAAYlB,KAAKkB,UAgBvB,GAdAlB,KAAKoiC,KAAK22E,YAAYhyC,SAAS7lE,GAC/BlB,KAAKoiC,KAAKkpB,UAAU4V,gBAAgBhgE,EAAW,IAAI,KAEhD,MACDlB,KAAKiJ,eAAe5J,IAAI6B,EAAxBlB,CAAmC,YAAkBK,GAAM,mCACzD,MAAMgnC,GAAS,EAAA1N,GAAA,GAAgBt5B,EAAE8G,OAAQ,kBAAmB,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,UACtF,GAAGkgC,EAAQ,CACT,MAAMp6B,GAAOo6B,EAAOz/B,QAAQqF,IAC5BjN,KAAK8zB,IAAI,uBAAwB9zB,KAAKoiC,KAAKy/D,WAAW50F,IACtDjN,KAAKg5G,gBAAgB3xE,SAKL,WAAnBrnC,KAAKoiC,KAAKniC,MAAwC,cAAnBD,KAAKoiC,KAAKniC,KAC1C,GAAI,GAAA8yF,WAqBG,GAAG,KAAoB,CAC5B,MAAMp0F,EAAY,qBACZkxF,EAAM,GACNopB,EAAmB,IAANppB,EACnB,IACI1oF,EACAlI,EAFAi6G,GAAc,EAGlB97C,GAAsB,CACpBhzD,QAASlJ,EACT6hD,kBAAyB1iD,GAAM,mCAC7B,QAAGL,KAAKoiC,KAAKkpB,UAAUC,qBAAuBvrD,KAAKoiC,KAAK+2E,aAKxDhyG,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,UAChCA,KACD,QAAcA,EAAQxI,GAAW,EAAM,KAClCwI,EAAOg+C,WAERlmD,GAIFA,EAAKG,UAAUkB,OAAO,cACtBrB,EAAKgE,MAAM0gE,QAAU,KAJrB1kE,EAAOH,SAASC,cAAc,QAC9BE,EAAKG,UAAUC,IAAI,qBAAsB,8BAM3C8H,EAA8CzH,OAAOT,KAG9CkI,OAEXo8C,QAAS,CAACL,EAAOC,KACf+1D,EAAch2D,GAAS+1D,EAEpBC,IAAgBj6G,EAAKG,UAAUiG,SAAS,eACzCpG,EAAKG,UAAUC,IAAI,cAErBJ,EAAKgE,MAAM0gE,QAAU,GAAKhhE,KAAKC,IAAI,EAAGsgD,EAAQ+1D,GAE9C,MAAMjyG,GAAKrE,KAAKH,IAAI,EAAGG,KAAKC,IAAIitF,EAAK3sC,IACrC/7C,EAAOlE,MAAMkzB,UAAY,cAAcnvB,OACvC+1D,MAEFna,QAAS,KACP,MAAMw2D,EAAUjyG,GAChB,QAAciyG,EAASz6G,GAAW,EAAO,KAAK,KACzCM,EAAK2E,gBAAkBw1G,IACxBn6G,EAAKG,UAAUkB,OAAO,cACtBrB,EAAKqB,cAIT,UAAQ,KAGN,GAFA84G,EAAQn2G,MAAMkzB,UAAY,GAEvB+iF,EAAa,CACd,MAAM,IAACjsG,GAAOmsG,EAAQxxG,QACtB5H,KAAKoiC,KAAKriC,MAAMs5G,kBAAkBpsG,GAClCisG,GAAc,OAIpB52D,gBAAiB,CAAChvB,SAAS,WApF7BtzB,KAAKiJ,eAAe5J,IAAI6B,EAAxBlB,CAAmC,YAAkBK,GAAM,mCACzD,GAAGL,KAAKoiC,KAAKkpB,UAAUC,qBACbvrD,KAAKoiC,KAAK+2E,WAClB,OAGF,MAAMhyG,EAAS9G,EAAE8G,OACXkgC,EAASlgC,EAAO/H,UAAUiG,SAAS,UACvC8B,EACCA,EAAO/H,UAAUiG,SAAS,sBAAwB8B,EAAOvD,cAAgB,KAC5E,GAAGyjC,IAAWA,EAAOjoC,UAAUiG,SAAS,gBAAiB,CACvD,MAAM4H,GAAOo6B,EAAOz/B,QAAQqF,IAE5B,UADsBjN,KAAKoiC,KAAKy/D,WAAW50F,IAChCuL,OAAOqiB,YAChB,OAGF76B,KAAKoiC,KAAKriC,MAAMs5G,iBAAiBpsG,SAyEpCqsG,uBAELt5G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAOo3D,WAAAA,EAAY/pD,QAAAA,KAAa,mCACnF,GAAG+pD,IAAep3D,KAAKoiC,KAAK+0E,qBAExBn3G,KAAK8L,WAAW0hG,UAAUl3E,OAG5Bt2B,KAAKu5G,iBAAiBlsG,GAAS,GAF/BrN,KAAKoiC,KAAK20E,eAKT,gCAAsC,CACvC,MAAMh6B,EAAmB/8E,KAAKoiC,KAAK26C,iBAChCA,GACDA,EAAiBR,uBAKvBv8E,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,uBAAwBqN,IACtDrN,KAAKuM,SAAWc,EAAQd,QAC3BvM,KAAKu5G,iBAAiBlsG,MAGxBrN,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAEuM,OAAAA,EAAQ+9C,KAAAA,MAC1D/9C,IAAWvM,KAAKuM,QACjBvM,KAAKy3G,oBAAoBrmG,MAAMC,KAAKi5C,OAIxCtqD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAiB,EAAEuM,OAAAA,MACjDA,IAAWvM,KAAKuM,SACjBvM,KAAKoiC,KAAKriC,MAAMy5G,kBAEhB,WAA2B93G,MAAK,KAC9B1B,KAAKy5G,8BAKXz5G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,uBAAwB4zC,IACtDA,EAAQ5zC,KAAKuM,SACdvM,KAAKoiC,KAAKriC,MAAMy5G,oBAIpBx5G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,0BAA2Bw4B,IACzDx4B,KAAKuM,SAAWisB,EAAOjsB,QACxBvM,KAAKoiC,KAAKriC,MAAMy5G,oBAIpBx5G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAqBqa,GAAW,mCAC9Dra,KAAKuM,SAAW8N,EAAOQ,UAAS,IACf7a,KAAKs0G,UAAUl1G,UAAUiG,SAAS,uBAC5BrF,KAAKoiC,KAAK+2E,mBAGRh2G,QAAQC,IAAI,CAClCpD,KAAK05G,mBACL15G,KAAKoiC,KAAKriC,MAAM25G,sBAGRtsG,SAAStI,GAAaA,WAKtC9E,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAoB,EAAO6P,IAAAA,KAAS,mCACrE,GAAW,uBAARA,EAA8B,CAC/B,MAAM6e,EAAa1uB,KAAK+zG,gBAElBloF,GADO,EAAAoiD,GAAA,GAAqBjuE,KAAKyrC,QAAS,QACjC9wB,KAAU1N,GAAQ,mCAC/B,MAAMo6B,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,GAAGo6B,EAAOjoC,UAAUiG,SAAS,sBAC3B,MAAO,CAACgiC,OAAAA,EAAQh6B,cAAerN,KAAKoiC,KAAKy/D,WAAW50F,SAIlDs+D,QAAgBpoE,QAAQC,IAAIyoB,GAClC,IAAI6C,IACF,OAGF68C,EAAQn+D,SAAQ,EAAEi6B,OAAAA,EAAQh6B,QAAAA,MACrBrN,KAAKyrC,QAAQp+B,EAAQJ,OAASo6B,GAIjCrnC,KAAKi4G,kBAAkB5qG,GAAS,EAAMg6B,YAKZrnC,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAmB4gB,KACpF,UAAQ,KACN,IAAI03F,EACJ,IAAI,MAAM,OAAC/rG,EAAM,MAAE83F,EAAK,IAAEp3F,KAAQ2T,EAAK,CACrC,GAAG5gB,KAAKuM,SAAWA,EAAQ,SAE3B,MAAM86B,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,IAAIo6B,EAAQ,SAEZ,MAAMsyE,EAAoBvoG,MAAMC,KAAKg2B,EAAO/1B,iBAAiB,gBAC7D,IAAIqoG,EAAkBh5G,OAAQ,SAE9B,MAAMywB,EAAM2jE,GAAasP,EAAO,GAChC,IAAIuV,GAAY,EAChBD,EAAkBvsG,SAASysG,KACtBD,GAAaC,EAAUlnF,cAAgBvB,KACpCknF,IACFA,EAAct4G,KAAKu4G,mBAAkB,GACrCD,EAAYh1E,QAGds2E,GAAY,EACZC,EAAUlnF,YAAcvB,MAK3BknF,GACDA,EAAYhQ,gBAKlBtoG,KAAK2c,SAAW,IAAI8rF,GAA0B,CAAChJ,KAAMz/F,KAAK8L,WAAW5K,YAErElB,KAAKiJ,eAAe5J,IAAIW,KAAKoiC,KAAKgyE,aAAlCp0G,CAAgD,iBAAiB,EAAEsiC,GAAAA,MACjE,MAAMqiB,EAASriB,IAAOtiC,KAAKoiC,KAErBl8B,EAAK,KACTlG,KAAK2c,SAASmsF,mBAAmBnkD,IAG/BA,EAKFz+C,IAJAE,YAAW,KACTF,MACC,QAMPlG,KAAKozG,2BAA4B,EAAAhnE,GAAA,IAAS,KACxC,MAAMjT,EAAO,IAAIn5B,KAAK0yG,WACtB1yG,KAAK0yG,UAAU3nG,QAEf/K,KAAK2S,SAAS40B,mBAAmBuyE,sBAAsB95G,KAAKuM,OAAQ4sB,KACnE,KAAM,GAAO,GAGN5sB,aACV,OAAOvM,KAAKoiC,KAAK71B,OAGXgsG,kBAAkBp+E,GAAU,GAElC,OADoB,IAAIotE,GAAYvnG,KAAK8L,WAAY,wBAAyBquB,GA8BxE4/E,uBACN,KAAK,mBAAoBj0G,SAAW9F,KAAKg6G,eACvC,OAGF,MAAM94G,EAAYlB,KAAK8L,WAAW5K,UAClC,IAAI+4G,EAAY,EACZC,GAAW,EACXC,GAAO,EACPC,EAAW,EACXliD,EAAO,EACPmiD,EAAM,EAGV,MAAMC,EAAc,KAClB,MAAM94G,EAASN,EAAUq5G,aACnBC,EAAiBx6G,KAAK8L,WAAW0uG,eACpCh5G,IAAWy4G,GAAeE,GAASK,IACpCtiD,GAAQ+hD,EAAYz4G,GAOnB02D,GACDl4D,KAAK8L,WAAWu8F,qBAAqBroG,KAAK8L,WAAW24C,UAAY9hD,KAAKE,MAAMq1D,IAG9E+hD,EAAYz4G,EACZ44G,EAAW,EACXC,EAAM,EACNniD,EAAO,EACPgiD,GAAW,EACXC,GAAO,GAGHM,EAAazuD,IACdquD,GAAKv0G,OAAOgxB,qBAAqBujF,GACpCA,EAAMv0G,OAAOS,sBAAsBylD,EAASsuD,EAAc,KACxDD,EAAMv0G,OAAOS,sBAAsB+zG,MAgEjCN,EAAiBh6G,KAAKg6G,eAAiB,IAAIU,gBA3DD79F,IAM9C,GAAGs9F,EAED,YADAM,GAAU,GAIZ,MACMj5G,EADQqb,EAAQ,GACD89F,YAAYn5G,OAEjC,IAAIy4G,EAEF,YADAA,EAAYz4G,GAId,MAAMo5G,EAAWX,EAAYz4G,EAC7B,IAAIqX,EAAO+hG,EAAW1iD,EACtB,MAAM2iD,EAAQhiG,EAAO,EAGrB,GAFAA,GAAQgiG,GAEJX,IACFA,GAAW,EAMRU,EAAW,GAAK56G,KAAK8L,WAAW0uG,gBAOjC,OALEtiD,GAAQ0iD,EAGVT,GAAO,OACPM,GAAU,GAWd,GANAL,GAAYvhG,EAMTA,EAAM,CACP,MAAMiiG,EAAgB96G,KAAK8L,WAAW24C,UAAY5rC,EAClD7Y,KAAK8L,WAAWu8F,qBAAqByS,GAGvCL,GAAU,GAEVviD,EAAO2iD,EACPZ,EAAYz4G,KAIdw4G,EAAer8F,QAAQzc,GAGjB65G,wBACN,MAAMf,EAAiBh6G,KAAKg6G,eACxBA,IAIJA,EAAez8F,aACfvd,KAAKg6G,oBAAiBhwG,GAwFjBgxG,6BACLh7G,KAAKiJ,eAAe5J,IAAI,GAAxBW,CAA+C,SAAUA,KAAKyzG,iBAC9DzzG,KAAKiJ,eAAe5J,IAAI47G,GAAA,EAAxBj7G,CAAwC,SAAUA,KAAKyzG,iBACvDzzG,KAAKiJ,eAAe5J,IAAIW,KAAKoiC,KAAKkpB,UAAlCtrD,CAA6C,SAAUA,KAAKyzG,iBAC5DzzG,KAAKiJ,eAAe5J,IAAIW,KAAKkB,UAA7BlB,CAAwC,YAAaA,KAAKwzG,oBAGpDI,gBAAgBD,EAA4Bz2F,IAClD,QAAcy2F,EAAe,aAAcz2F,EAAS,IAAKA,OAAUlT,EAAY,KAC7E2pG,EAAcrzG,UACb,GAYEo2G,yBA+CAwE,oBACL,OAAO/uB,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,OAASX,KAAKilE,YAAYjkE,KAGrDkyG,qBAAqB/rG,EAAqB8F,GAChDjN,KAAKkyG,aAAa7yG,IAAI4N,GACtBjN,KAAK2c,SAASkB,UAAU1W,EAAQnH,KAAKizG,0BACrCjzG,KAAKiyG,SAASviG,OAAOvI,GACrBnH,KAAKm7G,eAGCA,eACN,GAAGn7G,KAAKo7G,YAAa,OAErB,MAAM1sF,EAAa1uB,KAAK+zG,gBACxB/zG,KAAKo7G,YAAcC,GAAA,oBAAiC35G,MAAK,IAAW,mCAClE,IAAIgtB,IAAc,OAClB,IAAIhiB,EAAQ/J,KAAKH,OAAO4O,MAAMC,KAAKrR,KAAKkyG,eAGxC,GAAGlyG,KAAK8L,WAAW0hG,UAAUl3E,OAAQ,CACnC,MAAMglF,EAAe34G,KAAKH,OAAO2pF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9wB,KAAK5O,IAAOA,KACpEW,GAAS4uG,IACV5uG,EAAQ/J,KAAKH,WAAWxC,KAAKoiC,KAAKm5E,oBAAsB,EAAG7uG,IAI/D1M,KAAKiyG,SAAS7kG,SAAQ,CAACH,EAAK9F,KACvB8F,GAAOP,GACR1M,KAAKkzG,qBAAqB/rG,EAAQ8F,MAItC,MAAMuuG,EAAyB,GAC/B,IAAI,MAAMvuG,KAAOjN,KAAKkyG,aAEjBnJ,SAD8B/oG,KAAKoiC,KAAKy/D,WAAW50F,KAEpDuuG,EAAa3pG,KAAK5E,GActB,OAVAjN,KAAK2S,SAAS40B,mBAAmBk0E,aAAaz7G,KAAKuM,OAAQivG,GAE3Dx7G,KAAKkyG,aAAannG,QAEf,MACD/K,KAAK8zB,IAAI,6BAA8BpnB,GAKlC1M,KAAK2S,SAAS40B,mBAAmBm0E,YAAY17G,KAAKuM,OAAQG,EAAO1M,KAAKoiC,KAAKv2B,UAAUgC,OAAOJ,IACjGzN,KAAK8zB,IAAInmB,MAAM,mBAAoBF,GACnCzN,KAAK2S,SAAS40B,mBAAmBm0E,YAAY17G,KAAKuM,OAAQG,EAAO1M,KAAKoiC,KAAKv2B,aAC1Eqf,SAAQ,KACLwD,MACJ1uB,KAAKo7G,iBAAcpxG,EAEhBhK,KAAKkyG,aAAalxG,MACnBhB,KAAKm7G,wBAMNQ,yBACL37G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,wBAAyBK,IAC1D,MAAM,OAACkM,EAAM,KAAE4sB,EAAI,OAAEyrE,GAAUvkG,EAC5BkM,IAAWvM,KAAKuM,QAEhB4sB,IACGyrE,GACF5kG,KAAKy3G,oBAAoBt+E,OAM1ByiF,4BACL,MAAMz/C,EAAW,IAAW,mCAC1Bn8D,KAAKoiC,KAAKm0E,OAAO3mG,gBAAgB5P,KAAK2S,SAAS40B,mBAAmBs0E,4BAA4B77G,KAAKuM,SAASvL,SAG9GhB,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAkBqN,IAChDA,EAAQd,SAAWvM,KAAKuM,SAE3BvM,KAAKu5G,iBAAiBlsG,GACtB8uD,QAGFn8D,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAoB,EAAEuM,OAAAA,EAAQ4sB,KAAAA,MAC5D5sB,IAAWvM,KAAKuM,SAEnBvM,KAAKy3G,oBAAoBt+E,GACzBgjC,QAoYS2/C,gB,0CACX,IAAI97G,KAAKuyG,mBAAmB5xG,OAW1B,YAVAX,KAAKoiC,KAAK20E,eAaZ,MAAMroF,EAAa1uB,KAAK+zG,gBAClBrzG,EAAQV,KAAKuyG,mBAAmB7xG,QAChCsL,QAAiB7I,QAAQC,IAAI1C,EAAMia,KAAK1N,GAAQjN,KAAKoiC,KAAKy/D,WAAW50F,MAC3E,IAAIyhB,IAAc,OAElBhuB,EAAM0M,SAAQ,CAACH,EAAKoR,KAClB,MAAMhR,EAAUrB,EAASqS,GAEnBgpB,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,IAAI8tF,GAAM,EACV,GAAG1zD,EAAQ,CACT,MAAM7gC,EAAO6gC,EAAO5gC,wBACpBs0F,EAAO,UAAoB,EAAKv0F,EAAKK,SAC7BwG,IACR0tF,GAAM,GAGLA,GACD/6F,KAAKuyG,mBAAmBh0F,OAAOve,KAAKuyG,mBAAmB/7F,QAAQvJ,GAAM,MAIzEjN,KAAKuyG,mBAAmBj3D,MAAK,CAAC1U,EAAGmkB,IAAMA,EAAInkB,IAE3C,MAAM35B,EAAMjN,KAAKuyG,mBAAmB3hG,MACpC5Q,KAAKoiC,KAAK20E,aAAa9pG,MAGlB8uG,iBAAiBx1C,GACtB,IAAIn8D,EAAU47F,GAAkBhmG,KAAK8L,WAAW5K,UAAWqlE,EAAc,UAkBzE,OAFGn8D,IAASA,GAAU,EAAAuvB,GAAA,GAAgBvvB,EAAS,WAExCA,EAGI4xG,iBAAiBC,G,0CAC5B,MAAM9iF,QAAan5B,KAAK2S,SAAS40B,mBAAmB20E,eAAeD,GACnE,IAAI,MAAMhvG,KAAOksB,EACf,GAAGn5B,KAAKyrC,QAAQx+B,KAASjN,KAAKilE,YAAY9yB,IAAIllC,GAE5C,MAAO,CACLo6B,OAAQrnC,KAAKyrC,QAAQx+B,GACrBA,IAAKA,MAONg3D,sBAAsB58B,GAC3B,OAAOj2B,MAAMC,KAAKg2B,EAAO/1B,iBAAiB,kBAG/BgzD,iBAAiBr3D,EAAaI,G,0CAKzC,QAJerD,IAAZqD,IACDA,QAAgBrN,KAAKoiC,KAAKy/D,WAAW50F,KAGnCI,EACF,OAGF,MAAMuqG,EAAavqG,EAA4BgrD,WAC/C,GAAGu/C,EAAW,CACZ,MAAMhxE,QAAU5mC,KAAKg8G,iBAAiBpE,GACtC,GAAGhxE,EAED,OADAA,EAAES,OAAST,EAAES,OAAOniC,cAAc,iCAAiC+H,QAAY25B,EAAES,OAC1ET,EAIX,MAAMS,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,OAAIo6B,EAEG,CAACA,OAAAA,EAAQp6B,IAAAA,QAFhB,KAKMkvG,6BAA6BlvG,EAAausB,GAChD,MAAML,GAAO,EAAA80C,GAAA,GAAqBjuE,KAAKyrC,QAASjS,EAAO,OAAS,OAEhE,IAAI4iF,EACKA,EAAN5iF,EAAwB6iF,GAASA,EAAOpvG,EACpBovG,GAASpvG,EAAMovG,EAEtC,MAAMC,EAAWnjF,EAAK/mB,MAAMiqG,I,MAC1B,QAAID,EAAeC,OACQ,QAAlB,EAAAr8G,KAAKyrC,QAAQ4wE,UAAK,eAAEz4G,kBAG/B,OAAO5D,KAAKyrC,QAAQ6wE,GAGfC,gBAAgB11G,EAAcolD,GAAW,GAI9C,IACGjsD,KAAKuM,QAENvM,KAAKoiC,KAAKy0E,gBACV72G,KAAKmqD,4BACJtjD,IAAQ7G,KAAKw8G,sBAAwBx8G,KAAK8L,WAAW0hG,UAAU3mG,OAC9DA,IAAQ7G,KAAKy8G,yBAA2Bz8G,KAAK8L,WAAW0hG,UAAUl3E,QAEpE,OAKF,MAAMtpB,EAAUm/E,OAAOzuE,KAAK1d,KAAKyrC,SAChC9wB,KAAKnK,IAAQA,IACbmb,QAAQnb,GAAOA,EAAK,IAAMxQ,KAAKilE,YAAY9yB,IAAI3hC,KAC/C8qC,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IAChB/9C,EAAQrM,SAETkG,GACE,MACD7G,KAAK8zB,IAAI,qCAAsC9mB,EAAQ,GAAI,SAAUA,EAAQA,EAAQrM,OAAS,GAAIsrD,GAGpGjsD,KAAK08G,YAAY1vG,EAAQ,IAAI,OAAMhD,OAAWA,EAAWiiD,KAWtD,MACDjsD,KAAK8zB,IAAI,uCAAwC9mB,EAAQA,EAAQrM,OAAS,GAAIsrD,GAGhFjsD,KAAK08G,YAAY1vG,EAAQA,EAAQrM,OAAS,IAAI,GAAO,OAAMqJ,EAAWiiD,KA0DnE4sD,YACF74G,KAAK8L,YACN9L,KAAK28G,oBAGP38G,KAAK8L,WAAa,IAAI,KAAW,KAAM,KAAiB,KACxD9L,KAAK48G,UAAU,OAAO,GAAO,GAC7B58G,KAAK48G,UAAU,UAAU,GAAO,GAEhC58G,KAAK8L,WAAW5K,UAAUxB,OAAOM,KAAKs0G,WAatCt0G,KAAK8L,WAAW89C,mBAAqB5pD,KAAK8kC,SAC1C9kC,KAAK8L,WAAW+wG,cAAgB,IAAM78G,KAAKu8G,iBAAgB,GAC3Dv8G,KAAK8L,WAAWO,iBAAmB,IAAMrM,KAAKu8G,iBAAgB,GAG3D,KA0BQ9C,uB,0CACX,MAAM3tD,QAAuB9rD,KAAKoiC,KAAK06E,oBACjCpwG,EAAQ1M,KAAKuM,SAAW,SAAiBu/C,EAAeixD,UAAYjxD,EAAekxD,gBAIzF,IAAI,MAAMC,KAASj9G,KAAK2xG,UACtB,GAAGsL,EAAQ,GAAKA,GAASvwG,EAAO,CAC9B,MAAM26B,EAASrnC,KAAKyrC,QAAQwxE,GAC5B,GAAG51E,EAAQ,CAGT,GAFArnC,KAAK2xG,UAAUjiG,OAAOutG,GAEnB51E,EAAOjoC,UAAUiG,SAAS,eAC3B,SAGFgiC,EAAOjoC,UAAUkB,OAAO,UAAW,aAAc,eACjD+mC,EAAOjoC,UAAUC,IAAI,gBAMtBo4G,oBAAoBt+E,EAAgB+jF,GAAY,EAAMC,GAC3D,IAAI3qE,GAAU,EACdrZ,EAAK/rB,SAASH,IACZ,MAAMo6B,EAASrnC,KAAKyrC,QAAQx+B,GACxBo6B,IAEJmL,GAAU,SAIHxyC,KAAKyrC,QAAQx+B,GACpBjN,KAAKilE,YAAYv1D,OAAOzC,GAErBjN,KAAKsyG,oBAAsBjrE,IAC5BrnC,KAAKsyG,kBAAoB,MAG3BtyG,KAAKi3G,aAAa7c,uBAAuB/yD,GACtCrnC,KAAK2c,WACN3c,KAAK2c,SAASkB,UAAUwpB,EAAQrnC,KAAKizG,0BACrCjzG,KAAKiyG,SAASviG,OAAO23B,GAErBrnC,KAAK2c,SAASkB,UAAUwpB,EAAQrnC,KAAKmzG,uBACrCnzG,KAAK0yG,UAAUhjG,OAAOzC,IAGrBjN,KAAKo9G,yBAA2B/1E,IACjCrnC,KAAKo9G,4BAAyBpzG,OAM9BwoC,IAIJxyC,KAAK8L,WAAWuxG,wBACbH,GAAal9G,KAAKoiC,KAAKkpB,UAAUC,aAClCvrD,KAAKoiC,KAAKkpB,UAAUqX,mBAAmB3iE,KAAKuM,OAAQ4sB,GAGtDyI,EAAA,mBAAqC,EAAO43B,IAC5Cx5D,KAAK45F,wBAEDujB,GACFn9G,KAAK8L,WAAWg5B,YAKZw4E,cAAc5uF,EAAa1uB,KAAK+zG,iBACtC,IACIwJ,EADAC,GAAkB,EAEtB,IAAIx9G,KAAK2yG,iBAAsC,cAAnB3yG,KAAKoiC,KAAKniC,KAAsB,CAC1D,MAAM,aAACwnG,EAAY,aAAE1hC,GAAgB/lE,KAAK8L,WAAW5K,UACrDs8G,EAAkB/V,IAAiB1hC,EAShCy3C,IAIDD,EAAev9G,KAAKs0G,UACpBiJ,EAAat6G,MAAMkjE,WAAashC,EAAe,KAC/CznG,KAAK8L,WAAWu8F,qBAAqBtiC,GACrC/lE,KAAK2yG,iBAAkB,GAI3B,MAAO,CACL6K,gBAAAA,EACAC,aAAcD,EAAkB,KAC3B9uF,KAAgB8uF,IACjBD,EAAat6G,MAAMkjE,WAAa,GAChCnmE,KAAK2yG,iBAAkB,SAEvB3oG,GAIAuvG,iBAAiBlsG,EAAoB0kG,GAC3C,MAAMjoG,EAAU9J,KAAK09G,kBAAkBrwG,EAAS0kG,GAKhD,OAJA/xG,KAAKgzG,kBAAkB3zG,IAAIyK,GAC3BA,EAAQ+D,MAAM8vB,GAAA,GAAMzS,SAAQ,KAC1BlrB,KAAKgzG,kBAAkBtjG,OAAO5F,MAEzBA,EAGK4zG,kBAAkBrwG,EAAoB0kG,G,0CAClD,IAAI/xG,KAAK8L,WAAW0hG,UAAUl3E,OAAQ,CAEpC,MAAMugF,EAAiB72G,KAAKoiC,KAAKy0E,eACjC,GAAGA,EAAgB,CACjB,MAAMnoF,EAAa1uB,KAAK+zG,gBACxB8C,EAAen1G,MAAK,IAAW,mCAC7B,IAAIgtB,IAAc,OAClB,MAAMivF,QAAmB39G,KAAKoiC,KAAKy/D,WAAWx0F,EAAQJ,KAClDyhB,KACJ1uB,KAAKu5G,iBAAiBoE,QAI1B,OAGF,GAAG39G,KAAKoiC,KAAKv2B,SAAU,CACrB,MAAM+xG,EAAUvwG,MAAAA,OAAO,EAAPA,EAASo4F,SACzB,IAAKmY,IAAYA,EAAQ7I,iBAAmB6I,EAAQzH,mBAAqBn2G,KAAKoiC,KAAKv2B,SACjF,OAIJ,GAAG7L,KAAKyrC,QAAQp+B,EAAQJ,KACtB,OAOE8kG,IACFA,EAAe/xG,KAAK+xG,gBACjB/xG,KAAKu3G,mBACNv3G,KAAKu3G,oBAAsBv3G,KAAK69G,iBAChC79G,KAAKu3G,oBAAsBv3G,KAAKs0G,YAIpC,MAAM5lF,EAAa1uB,KAAK+zG,iBAClB,gBAACyJ,EAAe,aAAEC,GAAgBz9G,KAAKs9G,cAAc5uF,GAErD5kB,EAAU9J,KAAK89G,qBAAqB,CAAC9wG,QAAS,CAACK,KAAW,GA2BhE,OA1BG0kG,GACDjoG,EAAQpI,MAAK,KACX,IAAIgtB,IAAc,OAKlB,IAAI2Y,EACkB,cAAnBrnC,KAAKoiC,KAAKniC,OACXonC,EAASrnC,KAAKyrC,QAAQp+B,EAAQJ,MAGhC,MAAMnD,EAAUu9B,EAASrnC,KAAK+9G,kBAAkB12E,GAAUrnC,KAAKw3G,cAC5DgG,GAED1zG,EAAQpI,KAAK+7G,MAWZ3zG,KAGF+zG,gB,MACL,MAAM19E,EAAQngC,KAAKi3G,aAAahc,eAChC,OAAsB,QAAf,EAAA96D,MAAAA,OAAK,EAALA,EAAOs4D,gBAAQ,eAAEpxD,OAGnB22E,eACL5zG,EACAugC,EACAuL,EACA+nE,GAEA,MAAM52E,GAAS,EAAA1N,GAAA,GAAgBvvB,EAAS,UAMxC,IAAI8zG,EAEJ,GANI9zG,EAAQxG,eACV5D,KAAK8zB,IAAInmB,MAAM,2BAA4B05B,GAK1CA,GAAuB,QAAbsD,EAAoB,CAC/B,MAAM5rB,EAAO/e,KAAKi3G,aAAa5c,gBAAgBhzD,GAC5CtoB,EAAKohB,MAAMm4D,YAAcv5E,IAAQ,EAAAk8C,GAAA,GAAWl8C,EAAKohB,MAAMj/B,cAAgBlB,KAAK8qG,kBAAoBnR,GAAgB,KAG/GukB,EAFgBn/F,EAAKohB,MAAMj/B,UAAU0C,eAmB3C,MAAMu6G,EAAoBn+G,KAAKoiC,KAAKriC,MAAMq+G,cAAgBp+G,KAAKoiC,KAAKriC,MAAMq+G,aAAah/G,UAAUiG,SAAS,uBAA0BrF,KAAKoiC,KAAKlhC,UAAU9B,UAAUiG,SAAS,sBACrKyE,EAAU9J,KAAK8L,WAAW8pC,kBAAkB,CAChDxrC,QAAAA,EACAugC,SAAAA,EACA0zE,OATW,EAUXnoE,eAAAA,EACA+nE,cAAAA,EACAK,KAAM,IACNC,cAAeJ,EAAmB,EAAE33G,KAAAA,MAGlC,IAAIhF,EAAS,UAIb,OAFAA,GAAUxB,KAAKkB,UAAUmoE,UACzB7nE,GAAU6tB,EAAA,YAAuB,UAAoB,IAAM,GAAK,GACzD7tB,QAKLwI,EACJk0G,oCAAAA,EACAh1C,cAAgBs1C,IAEdx+G,KAAK8kC,UAAS,EAAM05E,MASxB,OAJGtoE,IAAmB,cACpBl2C,KAAK8L,WAAW2yG,mBAAqBz+G,KAAK8L,WAAW24C,WAGhD36C,EAGF0tG,cACL,OAAOx3G,KAAK+9G,kBAAkB/9G,KAAKs0G,WAGxByJ,kBAAkB12E,G,0CAK7B,GAAGA,EAAQ,CACTrnC,KAAKu3G,kBAAoBlwE,EACzB,MAAM3Y,EAAa1uB,KAAK+zG,gBAExB,SADM/zG,KAAKg+G,eAAe32E,EAAQ,WAAOr9B,OAAWA,IAChD0kB,IAAc,OAClB1uB,KAAKu3G,uBAAoBvtG,MAkBhBkuG,qBAAqB7wE,G,0CAChC,GAAGrnC,KAAK69G,kBAAoBx2E,EAE1B,OAAOrnC,KAAKw3G,iBAITwB,gBAAgB5uG,GACrB,MAAMs0G,EAAa,mBAChBt0G,EAAQxC,QAAQ82G,KACjBvwG,cAAc/D,EAAQxC,QAAQ82G,IAC9Bt0G,EAAQhL,UAAUkB,OAAO,kBACpB8J,EAAQyrC,aAGfzrC,EAAQhL,UAAUC,IAAI,kBACtB+K,EAAQxC,QAAQ82G,GAAc,GAAKt4G,YAAW,KAC5CgE,EAAQhL,UAAUkB,OAAO,yBAClB8J,EAAQxC,QAAQ82G,KACtB,KAGGC,iBAAiBvqG,EAAmBjB,EAAa,IAAIzN,KAAiB,IAAZ0O,IAChE,IAAI25D,EAEJ,MAAM55D,EAAQ,IAAIzO,KAClByO,EAAMuC,SAAS,EAAG,EAAG,EAAG,GAExB,MAAMsrD,EAAiC,cAAnBhiE,KAAKoiC,KAAKniC,KAE9B,GAAGkU,EAAMH,YAAcb,EAAKa,UAC1B+5D,GAAc,QAAK/L,EAAc,8BAAgC,mBAC5D,GAAGA,GAAe5tD,IAAcgyF,GACrCr4B,GAAc,QAAK,mCACd,CACL,MAAMnvE,EAAsC,CAC1C4V,IAAK,UACLC,MAAO,QAGNtB,EAAKG,gBAAkBa,EAAMb,gBAC9B1U,EAAQ2V,KAAO,WAGjBw5D,EAAc,IAAI,qBAAqB,CACrC56D,KAAAA,EACAvU,QAAAA,IACCwL,QAEA43D,IACD+L,GAAc,QAAK,yBAA0B,CAACA,KAIlD,MAAM1mC,EAASvoC,SAASC,cAAc,OACtCsoC,EAAO1oC,UAAY,yBACnB,MAAMigH,EAAgB9/G,SAASC,cAAc,OAC7C6/G,EAAcx/G,UAAUC,IAAI,kBAC5B,MAAMw/G,EAAa//G,SAASC,cAAc,OAQ1C,OAPA8/G,EAAWz/G,UAAUC,IAAI,eAEzBw/G,EAAWn/G,OAAOquE,GAElB6wC,EAAcl/G,OAAOm/G,GACrBx3E,EAAO3nC,OAAOk/G,GAEPv3E,EAGF+0D,wBAAwBhoF,GAC7B,MAAMjB,EAAO,IAAIzN,KAAiB,IAAZ0O,GAEtB,OADAjB,EAAKuD,SAAS,EAAG,EAAG,GACb,CAACvD,KAAAA,EAAM06D,cAAe16D,EAAKa,WAG7BslF,4BAA4BllF,GACjC,MAAM,KAACjB,EAAI,cAAE06D,GAAiB7tE,KAAKo8F,wBAAwBhoF,GAC3D,IAAIpU,KAAK8xG,aAAajkC,GAAgB,CACpC,MAAMxmC,EAASrnC,KAAK2+G,iBAAiBvqG,EAAWjB,GAE1C2rG,EAAa9+G,KAAK2+G,iBAAiBvqG,EAAWjB,GACpD2rG,EAAW1/G,UAAUC,IAAI,WAEzB,MAAM6B,EAAYpC,SAASC,cAAc,WACzCmC,EAAUvC,UAAY,qBACtBuC,EAAUxB,OAAO2nC,EAAQy3E,GAEzB9+G,KAAK8xG,aAAajkC,GAAiB,CACjCxpE,IAAKgjC,EACLnmC,UAAAA,EACAm3F,eAAgBllF,EAAKa,WAGvB,MAAMg6D,GAAiB,EAAAC,GAAA,GAAqBjuE,KAAK8xG,aAAc,OAC/D,IAA2ChuG,EAAvCiI,EAAI,EAAGpL,EAASqtE,EAAertE,OACnC,KAAMoL,EAAIiiE,EAAertE,SAAUoL,EAAG,CACpC,MAAMsG,EAAI27D,EAAejiE,GAEzB,GADAjI,EAAe9D,KAAK8xG,aAAaz/F,GAAGnR,UACjC2sE,EAAgBx7D,EACjB,MAIDtG,IAAMpL,GAAUmD,IACjBA,EAAeA,EAAaoqC,oBAG1BpqC,EAGF9D,KAAKs0G,UAAUxwG,aAAa5C,EAAW4C,GAFvC9D,KAAKs0G,UAAU50G,OAAOwB,GAKrBlB,KAAK8qG,mBACN9qG,KAAK8qG,kBAAkBjL,2BAA2B3+F,GAGjDlB,KAAKs0G,UAAU1wG,eAChB5D,KAAKkB,UAAU9B,UAAUC,IAAI,cAIjC,OAAOW,KAAK8xG,aAAajkC,GAGnB8uC,oBACN38G,KAAK8L,WAAWyqB,kBAChBv2B,KAAK8L,WAAW+wG,cAAgB78G,KAAK8L,WAAWO,iBAAmBrM,KAAK8L,WAAW89C,mBAAqB,KAGnGZ,UAGLhpD,KAAK28G,oBAEL38G,KAAKiJ,eAAe0G,YAEpB3P,KAAKyuB,cAAc1jB,QACnB/K,KAAK2c,UAAY3c,KAAK2c,SAASY,aAC/Bvd,KAAK8qG,mBAAqB9qG,KAAK8qG,kBAAkBvtF,oBAE1Cvd,KAAKyuB,cACZzuB,KAAK2c,iBAAmB3c,KAAK2c,SAC7B3c,KAAK8qG,0BAA4B9qG,KAAK8qG,kBAGjC76F,QAAQ8uG,GAAa,GAC1B/+G,KAAKyrC,QAAU,GAEfzrC,KAAK48G,UAAU,OAAO,GAAO,GAC7B58G,KAAK48G,UAAU,UAAU,GAAO,IAGhC,SAAqB58G,KAAK8L,WAAW5K,YAGrC,gBAEmB8I,IAAhBunG,KACDA,GAAcD,IAGhBtxG,KAAKilE,YAAYl6D,QACjB/K,KAAK8xG,aAAe,GACpB9xG,KAAKi3G,aAAahnG,UAClBjQ,KAAK2xG,UAAU5mG,QACf/K,KAAK8lG,WAAWnlG,OAAS,EACzBX,KAAKyuB,cAAc1jB,QACnB/K,KAAKgzG,kBAAkBjoG,QAGpBg0G,IACD/+G,KAAK8L,WAAW5K,UAAUyxB,YAAc,GACxC3yB,KAAKg/G,uBAGPh/G,KAAKsyG,kBAAoB,KACzBtyG,KAAKi/G,sBAAuB,EAE5Bj/G,KAAKoyG,cAAczxG,OAAS,EAC5BX,KAAKmyG,qBAAuB,KAE5BnyG,KAAKw8G,qBAAuBx8G,KAAKy8G,6BAA0BzyG,EAC3DhK,KAAKk/G,qBAAkBl1G,EACvBhK,KAAKm/G,gCAA6Bn1G,EAE/BhK,KAAK8qG,mBACN9qG,KAAK8qG,kBAAkBvtF,aAGtBvd,KAAK2c,WACN3c,KAAK2c,SAASY,aAEdvd,KAAKiyG,SAASlnG,QACd/K,KAAKkyG,aAAannG,QAClB/K,KAAKo7G,iBAAcpxG,EAEnBhK,KAAK0yG,UAAU3nG,SAGjB/K,KAAK0uB,WAAW4sC,QAEhBt7D,KAAKo/G,qBAAkBp1G,EACvBhK,KAAKq/G,4BAAyBr1G,EAC9BhK,KAAKs/G,+BAA4Bt1G,EACjChK,KAAKo9G,4BAAyBpzG,EAC9BhK,KAAKqzG,sBAAmBrpG,EACxBhK,KAAK24G,wBAAqB3uG,EAE1BhK,KAAKu3G,uBAAoBvtG,EAGzBhK,KAAK2yG,iBAAkB,EAEvB3yG,KAAK4yG,kBAAkB7nG,QACvB/K,KAAK6yG,eAAe9nG,QACpB/K,KAAK8yG,iBAAiB/nG,QAInB/K,KAAKgyG,qBACN7jG,aAAanO,KAAKgyG,oBAClBhyG,KAAKgyG,mBAAqB,GAG5BhyG,KAAKkB,UAAU9B,UAAUkB,OAAO,oBAChCN,KAAK8L,WAAWyzG,gBAGVP,oBAAoB33E,EAASrnC,KAAKo9G,wBACrC/1E,IACDA,EAAO/mC,SAEJN,KAAKo9G,yBAA2B/1E,IACjCrnC,KAAKo9G,4BAAyBpzG,IAKvB87C,QAAQ05D,EAAmBjzG,EAAgB+2D,EAAoBm8C,G,gDAC1E,MAAMh4F,IAAWznB,KAAK+yG,cAEtB,IAAIxmG,EAGF,OAFAvM,KAAKiQ,SAAQ,GACbjQ,KAAKkoB,UAAUqB,SACR,KAGT,MAAMm2F,EAAO/0F,YAAYhlB,MACnBmuB,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,WAChC7rF,EAAI21C,KAAK,SAET,MAAM/6C,EAAa,IACV1uB,KAAK+yG,gBAAkBtrF,EAG1BoE,EAAIo9E,GAAkBv6E,EAAY8iF,IAEpCgO,UACI3zF,EAAE7rB,KAAKoiC,KAAKw9E,aAAa/zF,KAOjC,MAAMg4E,EAAW7jG,KAAKoiC,KAAKniC,MAEX,cAAb4jG,GAA4B7jG,KAAKoiC,KAAKymB,gBACvCya,EAAY,GAGd,MAAMxX,QAAuBjgC,EAAE7rB,KAAKoiC,KAAK06E,qBACzC,IAAI+C,EAA0B,WAAbhc,QAA8Bh4E,EAAE7rB,KAAK2S,SAAS40B,mBAAmBu4E,uBAAuBvzG,IAA+B,QAApB,EAAAu/C,EAAep/C,aAAK,QAAI,EAC5I,MAAMqzG,OAAyB/1G,IAAds5D,EAOjB,IAAI08C,EACeC,EAAiEC,EAAhFnD,EAAY,EAChB,IAAIgD,EAKF,GAJIP,IACFS,EAAgBjgH,KAAKoiC,KAAKgyE,aAAa+L,qBAAqBngH,KAAKoiC,OAGhE69E,QAEI,GAAGJ,EAAY,CACpB9C,QAAkBlxF,EAAE7rB,KAAK2S,SAAS40B,mBAAmB64E,qBAAqB7zG,EAAQvM,KAAKoiC,KAAKv2B,WAC5F,MAAM2sB,QAAe3M,EAAE7rB,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,IACtE,IAA4BwwG,GAAcyC,GAAchnF,GAAkC,IAAxBA,EAAO6nF,aASvE/8C,EAAYu8C,MATgF,CAC5F,MAAMS,EAAax0D,EAAe9+C,QAAQuzG,gBAAgBxD,GACvDuD,GAAcA,EAAW5/G,MAAM0zC,MAAM,eACtC8rE,EAAwBI,EAAW5/G,MAAM4/G,EAAWt8F,OAAS,KAAOs8F,EAAW5/G,MAAM,IAAMq8G,GAG7FiD,GAAmBD,EACnBz8C,EAAYy5C,GAQlB,MAAMyD,EAASl9C,IAAcu8C,EAM7B,QAJkB71G,IAAfy1G,UAAkC5zF,EAAE7rB,KAAKoiC,KAAKq+E,0BAC/ChB,EAAa,OAGZD,EAAU,CACX,MAAMn7C,QAAgBx4C,EAAE7rB,KAAKskE,iBAAiBhB,IAC9C,GAAGe,EAgBD,OAfG07C,GACD//G,KAAKg+G,eAAe35C,EAAQh9B,OAAQ,UACpCrnC,KAAKg5G,gBAAgB30C,EAAQh9B,QAC7BrnC,KAAKoiC,KAAKpyB,cAAc,UAAWszD,GAAW,IACtCu8C,IAAeW,IAGvBxgH,KAAKw3G,cACLx3G,KAAKoiC,KAAKpyB,cAAc,UAAWszD,GAAW,SAG9Bt5D,IAAfy1G,GACDz/G,KAAKoiC,KAAKriC,MAAM2gH,cAAcjB,GAGzB,UAGNz/G,KAAKuM,SACNvM,KAAKyuB,cAAc0B,UAAYA,GAC/BnwB,KAAK2S,SAASovB,eAAe4+E,WAAW3gH,KAAKoiC,KAAKqJ,QAAQhd,cAAc0B,UAG1EnwB,KAAKuyG,mBAAmB5xG,OAAS,EAEjCX,KAAKyyG,aAAe,CAClBmO,+BAA+B/0F,EAAE7rB,KAAK2S,SAAS2/B,gBAAgBg6C,WAAW//E,aAAkBsf,EAAE7rB,KAAK2S,SAAS2I,gBAAgBulG,MAAMt0G,MAInI,MACDunB,EAAI,kBAAmBvnB,EAAQu/C,EAAgBwX,EAAWu8C,GAI5D,MAAMiB,EAAgBZ,MAAAA,EAAAA,EAA0BM,GAAuB,cAAb3c,GAA4B7jG,KAAKoiC,KAAKymB,aAAe,EAAIg3D,EAEnH,IAAIkB,EAAc,EAClB,GAAGvB,EAAU,CACX,IAAIjuG,EAAKvR,KAAK+7G,iBAAiB,UAE5BxqG,IACDwvG,GAAexvG,EAAG3J,QAAQqF,KAGzB8zG,GAAe,IAChBA,EAAcp+G,KAAKH,OAAO2pF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9wB,KAAK1N,IAASA,WAGpEjN,KAAKwyG,aAAc,EACnBxyG,KAAK+6G,wBAGP,MAAMiG,EAAehhH,KAAKs0G,UACpB2M,EAAuBjhH,KAAKo9G,uBAClCp9G,KAAKiQ,UACL,MAAMqkG,EAAYt0G,KAAKs0G,UAAYx1G,SAASC,cAAc,OACvDygH,GACDlL,EAAU31G,UAAYqiH,EAAariH,UACnC21G,EAAUl1G,UAAUkB,OAAO,gBAAiB,iBAE5Cg0G,EAAUl1G,UAAUC,IAAI,iBAG1BW,KAAKyuB,cAAczQ,OAGnB,MAAMkjG,EAAuB1B,GAAaK,GAAcW,GAAWT,EAC7DoB,EAASJ,EAAc,KAAOz9C,GAAay9C,EAAcz9C,GAAaA,EAAY,GAClF89C,GAAkBD,GAAU3B,EAC5B6B,GAAgBD,GAAkBD,EAQxC,IAAI7xG,EAPJtP,KAAKshH,iBAAmBF,GAAkBC,EAE1CrhH,KAAKuhH,eAAiB,CACpBj+C,UAAAA,EACAu8C,WAAAA,GAOAvwG,EAHE2wG,EAGO,CACPn2G,SAAS,WAA2BpI,MAAK,IAChC1B,KAAK89G,qBAAqB,CAAC9wG,QAASizG,EAAc9mF,OAAO,KAElElN,QAAQ,EACRu1F,YAAar+G,QAAQ4B,iBAPR8mB,EAAE7rB,KAAK08G,YAAYp5C,GAAW,EAAMk9C,EAAQM,IAW7D9gH,KAAKyhH,cAAgBnyG,EAAO2c,OAE5B6H,EAAI21C,KAAK,eAET,MAAM,QAAC3/D,EAAO,OAAEmiB,GAAU3c,EAEtB2c,GAAWuzF,UACP3zF,EAAE7rB,KAAKoiC,KAAKs3E,iBAAiBqG,EAAUS,EAAQl9C,EAAWm8C,IAChEz/G,KAAK8L,WAAW5K,UAAUyxB,YAAc,GAGxC3yB,KAAKkoB,UAAUsB,OAAOxpB,KAAKkB,YAM7B0gC,EAAA,YAA+B43B,IAC/B,MAAMq9C,EAAiBhrF,EAAE/hB,GAASpI,MAAK,IAAW,mCAChDoyB,EAAI21C,KAAK,qBAET,IAAIi4C,EAAqBR,QAA6Br1F,EAAEy3C,EAAYtjE,KAAKskE,iBAAiBhB,GAAa,CAACj8B,OAAQrnC,KAAK69G,uBAAoB7zG,EACtIiiB,IAAWuzF,IACZ1rF,EAAI21C,KAAK,+BACH59C,EAAE7rB,KAAKoiC,KAAKs3E,iBAAiBqG,EAAUS,EAAQl9C,EAAWm8C,IAChE3rF,EAAI21C,KAAK,yBAGXzpE,KAAKkoB,UAAUqB,SAEZvpB,KAAKq/G,yBACNr/G,KAAKq/G,yBACLr/G,KAAKq/G,4BAAyBr1G,GAGhChK,KAAKyhH,mBAAgBz3G,EAIrB,MAAM8B,EAAa9L,KAAK8L,WA8BxB,GA7BAA,EAAW2qG,oBAAsB,EACjC3qG,EAAW2yG,mBAAqB,GAChC,EAAA7wG,EAAA,GAAe9B,EAAW5K,UAAWozG,GAGlC2M,GACDjhH,KAAKg/G,oBAAoBiC,GAGxBjhH,KAAKs/G,2BACNt/G,KAAKs/G,4BAGHS,GAA+B,SAAnB//G,KAAKoiC,KAAKniC,MACxBD,KAAKoiC,KAAKm0E,OAAO1/C,cAAc8qD,gBAAgB,GAGjD3hH,KAAKkB,UAAU9B,UAAUoE,OAAO,eAAgB2oF,OAAOzuE,KAAK1d,KAAK8xG,cAAcnxG,QAE/EmzB,EAAI21C,KAAK,eAAgBzpE,KAAKs0G,YAAcA,EAAWt0G,KAAKs0G,UAAU1wG,cAAe+mB,YAAYhlB,MAAQ+5G,GAEzG99E,EAAA,cAAiC43B,IACjC53B,EAAA,mBAAqC,EAAO43B,IAG1Cx5D,KAAKyuB,cAAc3Q,SAIlBmiG,EACDn0G,EAAWu8F,qBAAqB4X,EAAcp5G,UAYzC,GAAGq6G,EAAsB,CAC9B,IAAIzD,EACJ,GAAG2D,EACDt1G,EAAWu8F,qBAAqB,YAC3B,GAAGgZ,EAAc,CACtB,MAAMpkG,EAAMjd,KAAKs9G,gBACdrgG,EAAIugG,kBACLC,EAAexgG,EAAIwgG,cAGrB3xG,EAAWu8F,qBAAqB,GAIlC,IAKIv+F,EALAu9B,EAAuB24E,GAAmBhgH,KAAKsyG,oBAAsBoP,MAAAA,OAAkB,EAAlBA,EAAoBr6E,QAO7F,IANIA,MAAAA,OAAM,EAANA,EAAQzjC,iBACVyjC,EAASrnC,KAAKm8G,6BAA6B74C,GAAW,IAAUtjE,KAAKm8G,6BAA6B74C,GAAW,IAK5Gj8B,EAAQ,CACT,MAAMu6E,EAAa5hH,KAAK69G,gBAClBlzE,EAAkCq1E,EAAkB,QAAYQ,GAAWT,GAAY6B,IAAev6E,EAAiB,SAAR,MAGnHv9B,EADc,QAAb6gC,GAAsBi3E,IAAev6E,GAAUm4E,EACtCx/G,KAAKw3G,cAELx3G,KAAKg+G,eAAe32E,EAAQsD,EAAW60E,OAAmCx1G,EAAxB,cAG1Dg2G,GAAmBD,GACrB//G,KAAKg5G,gBAAgB3xE,GAItBo2E,IACA3zG,GAAW3G,QAAQ4B,WAAWrD,MAAK,KAClC+7G,YAIJ3xG,EAAWu8F,qBAAqB,OAIhCroG,KAAK6hH,oBAGP7hH,KAAK8kC,WAEL,MAAMg9E,EAAkB3+G,QAAQC,IAAI,CAACyzG,GAAgB,aA4BrD,GA3BAiL,EAAgBpgH,MAAK,KACnBoK,EAAWokC,sBAOblwC,KAAKoiC,KAAKpyB,cAAc,UAAWszD,GAAYk9C,GAE/Cr9G,QAAQC,IAAI,CACVpD,KAAK+hH,0BAA0BD,GAC/B9hH,KAAKgiH,wBAAwB,CAC3BF,gBAAAA,EACAx+C,UAAAA,EACAk8C,SAAAA,EACAS,cAAAA,EACAJ,WAAAA,MAEDn+G,MAAK,KACNoyB,EAAI,mBAAoBhoB,EAAW0hG,UAAUl3E,QAE1CxqB,EAAW0hG,UAAUl3E,QAAUupF,IAAe7/G,KAAKiyG,SAASjxG,MAC7DhB,KAAKiiH,uBAIO,SAAbpe,EAAqB,CACtB,MAAMrrE,QAAe3M,EAAE7rB,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,KACnEisB,MAAAA,OAAM,EAANA,EAAQhgB,OAAO0pG,cAChBliH,KAAK2S,SAAS40B,mBAAmB46E,iBAAiB51G,GAAQ,SAK7DsB,OAAOJ,IAMR,MALAqmB,EAAInmB,MAAM,4BAA6BF,GACnCihB,KACF1uB,KAAKkoB,UAAUqB,SAGX9b,KAGR,MAAO,CAACwe,OAAAA,EAAQniB,QAAS+sG,MAGbkL,0BAA0BD,G,0CACtC,MAAMpzF,EAAa1uB,KAAK+zG,gBAExB,SADoC/zG,KAAK2S,SAAS2/B,gBAAgB6G,UAAUn5C,KAAKuM,QACvD,CACxB,MAAM61G,EAAiB,IAAW,mCAChC,IAAI1zF,IAAc,OAElB,MAAMyK,EAAiB,GACvB,IAAI,MAAMlsB,KAAOjN,KAAKyrC,QAAS,CAC7B,IAAIp+B,QAAgBrN,KAAKoiC,KAAKy/D,YAAY50F,GACxB,aAAfI,MAAAA,OAAO,EAAPA,EAAST,KAIZS,QAAgBrN,KAAK2S,SAAS40B,mBAAmBusE,sBAAsBzmG,GACvE8rB,EAAKtnB,KAAKxE,EAAQJ,OAGJksB,EAAKx4B,OAASX,KAAK2S,SAASwnC,oBAAoBkoE,qBAAqBriH,KAAKuM,OAAQ4sB,GAAQh2B,QAAQ4B,WAC1GrD,MAAK,KACX0E,WAAWg8G,EAAgB,WAI/Bj/G,QAAQC,IAAI,CAAC0+G,GAAiB,YAA4B,QAAM,OAAOpgH,MAAK,KAC1E0gH,WAKQJ,yBAAwB,UACpC1+C,EAAS,WACTu8C,EAAU,gBACViC,EAAe,cACf7B,EAAa,SACbT,I,0CAQA,MAAM9wF,EAAa1uB,KAAK+zG,gBAClBxnG,EAASvM,KAAKuM,OAEd+1G,QAA0BtiH,KAAK2S,SAAS40B,mBAAmBg7E,sBAAsBh2G,GAEvF,IADqB0zG,IAAiBqC,EAEpC,OAIF,SADMR,GACFpzF,IACF,OAMF,GAHA1uB,KAAK48G,UAAU,UAAU,GACzB58G,KAAK8L,WAAWokC,oBAEZoyE,EACF,OAGF,MAAM73F,EAAI,KACRzqB,KAAKk/G,gBAAkB,IAAI/7G,SAAoB4B,GAAY,mCACrD2pB,YAAwB1uB,KAAK2S,SAAS40B,mBAAmBg7E,sBAAsBh2G,IAKnFvM,KAAK2S,SAAS40B,mBAAmBi7E,cAAcj2G,EAAQvM,KAAKoiC,KAAKv2B,UAAUnK,MAAM4N,IAC/E,IAAIof,MAAiBpf,EAEnB,YADAvK,IAIF,MAAM,YAAC09G,GAAenzG,EACnBtP,KAAK8L,WAAW0hG,UAAUl3E,QAAUt2B,KAAK8L,WAAW0hG,UAAUl3E,SAAWmsF,IAC1EziH,KAAK48G,UAAU,SAAU6F,GACzBziH,KAAK8kC,YAGP1+B,WAAWqkB,EAAG,KACd1lB,OAjBAA,SAmBDmmB,SAAQ,KACTlrB,KAAKk/G,qBAAkBl1G,MAIxBw1G,EACDp5G,WAAWqkB,EAAG,KAEdA,OAISw3F,oB,0CACX,GAAsB,SAAnBjiH,KAAKoiC,KAAKniC,MAAsC,eAAnBD,KAAKoiC,KAAKniC,KAAuB,CAC/D,MAAMyiH,QAAqB1iH,KAAKoiC,KAAKm5E,kBACrCv7G,KAAK2S,SAAS40B,mBAAmBm0E,YAAY17G,KAAKuM,OAAQm2G,EAAc1iH,KAAKoiC,KAAKv2B,UAAU,OAInF6tG,mB,0CACX,MAAOvgE,EAAWwpE,EAAUr2B,SAAoBnpF,QAAQC,IAAI,CAC1DpD,KAAK2S,SAAS2/B,gBAAgB6G,UAAUn5C,KAAKuM,QAC7CvM,KAAKoiC,KAAK+2E,UACVn5G,KAAKoiC,KAAKkqD,aAGZ,MAAO,KACLtsF,KAAKs0G,UAAUl1G,UAAUoE,OAAO,aAAcm/G,GAC9C3iH,KAAKkB,UAAU9B,UAAUoE,OAAO,wBAAyBm/G,GAEzD3iH,KAAKs0G,UAAUl1G,UAAUoE,OAAO,UAAW8oF,GAC3CtsF,KAAKs0G,UAAUl1G,UAAUoE,OAAO,aAAc21C,GAE9Cn5C,KAAK+5G,2BAIF6I,oBAAoBhkH,GAEzB,OADAoB,KAAKoyG,cAAcvgG,KAAKjT,GACjBoB,KAAK6iH,0BAGPA,0BACL,IAAI7iH,KAAKoyG,cAAczxG,OAAQ,OAAOwC,QAAQ4B,UAE9C,GAAG/E,KAAKmyG,qBACN,OAAOnyG,KAAKmyG,qBAGd,MAAMzjF,EAAa1uB,KAAK+zG,gBAClBjgF,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,SAE1B9zF,EAAIo9E,GAAkBv6E,EADN8iF,IAGhBpyF,EAAe,IAA0B,mC,MAC7C0U,EAAI,SAEJ,MAAMgvF,EAAc9iH,KAAKoyG,cAAc1xG,QACvCV,KAAKoyG,cAAczxG,OAAS,EAE5B,MAAMoiH,EAAsBD,EAAYnoG,KAAK7Q,IAC3C,MAAM41G,EAAO/0F,YAAYhlB,MAKzB,OAJAmE,EAAQpI,MAAMgoB,IACZoK,EAAI,sBAAuBnJ,YAAYhlB,MAAQ+5G,EAAMh2F,MAGhD5f,KAGT,IAAIk5G,QAAkBn3F,EAAE1oB,QAAQC,IAAI2/G,IACpC,MAAME,EAAevkG,GACZA,EAAMiN,QAAQjC,GAEZA,GAAW1pB,KAAKyrC,QAAQ/hB,EAAQ2d,OAAOz/B,QAAQqF,OAASyc,EAAQ2d,SAI3E27E,EAAYC,EAAYD,GAExBlvF,EAAI,qBAEJ,MAAMqG,EAAsB,QAAZ,EAAA6oF,EAAU,UAAE,eAAE7oF,SAExB,OAACsvD,EAAM,eAAEy5B,GAAkBljH,KAAKs3G,aAAa0L,EAAUr3F,QAAQjC,GAAYA,EAAQy5F,kBAMnF15G,EAAWu5G,EAAUliG,QAAO,CAACC,EAAK2I,KACtC,MAAMg2F,EAAO/0F,YAAYhlB,MAEnB8D,EAAWigB,EAAQjgB,SAAS/I,QAC5B0iH,EAAe35G,EAASkR,KAAU7Q,GAAY,gDAAOA,EAAS6gB,YAAYhlB,MAAQ+5G,OAmBxF,OAlBAv8G,QAAQC,IAAIggH,GAAc1hH,MAAM2yD,IAC9BvgC,EAAIuvF,eAAe,qBAAsB14F,YAAYhlB,MAAQ+5G,EAAMh2F,EAAS2qC,GAC5EA,EAAMjnD,SAAQ,CAAC8G,EAAMmK,KACnByV,EAAI,qBAAsB5f,EAAMmK,EAAK5U,EAAS4U,OAEhDyV,EAAIwvF,cAYNviG,EAAIlP,QAAQ6X,EAAQjgB,UACbsX,IACN,IAEHtX,EAASoI,QAAQqxG,GAOjBpvF,EAAI,yBAA0BrqB,EAAUu5G,EAAWhjH,KAAKmqD,kCAClDt+B,EAAE1oB,QAAQC,IAAI,IAAIqG,EAAUzJ,KAAKujH,8BACjC13F,GAAE,YACRiI,EAAI,sBAEJkvF,EAAYC,EAAYD,GAExB,MAAM,cAACQ,EAAa,YAAElL,GAAet4G,KAAKyjH,oBAAoBtpF,GAK3Dn6B,KAAKqyG,iCACNryG,KAAKqyG,kCAGPryG,KAAK0jH,eACL,IAAI,MAAOr8E,EAAQs8E,KAAc3jH,KAAK8yG,iBAAkB,CAKtD,GAJGwF,GACDA,EAAYzQ,aAAa8b,EAAWt8E,IAGlC27E,EAAU5wG,MAAMsX,GAAYA,EAAQ2d,SAAWA,IACjD,SAGF,MAAMtoB,EAAO/e,KAAKi3G,aAAa5c,gBAAgBhzD,GAC/CtoB,EAAKslD,SAAU,EACXolB,EAAOriF,SAAS2X,EAAKohB,QACvBspD,EAAO53E,KAAKkN,EAAKohB,OAGnBngC,KAAK8yG,iBAAiBpjG,OAAO23B,GA6B/B,GA1BGrnC,KAAKoiC,KAAKkpB,UAAUC,aACrBy3D,EAAU51G,SAAQ,EAAEi6B,OAAAA,MAClBrnC,KAAKoiC,KAAKkpB,UAAUkW,sBAAsBn6B,GAAQ,MAItD27E,EAAU51G,SAAQ,EAAEC,QAAAA,EAASg6B,OAAAA,EAAQ87E,eAAAA,MAChC91G,EAAQmL,OAAOorG,OAAST,GACzBnjH,KAAKs0G,UAAWjnG,EAA4BmL,OAAO2rF,UAAY,SAAW,WAAW98D,MAKzFrnC,KAAKi3G,aAAarc,mBAAmBnR,GAGlCzpF,KAAK6jH,2BACN7jH,KAAK6jH,4BAGJL,GACDA,IAKCxjH,KAAKoyG,cAAczxG,OAEpB,OADAmzB,EAAI,+BACG1U,IAEP0U,EAAI,UAIRA,EAAI,iBACJ,MAAMhqB,EAAU9J,KAAKmyG,qBAAuBtmF,GAAE,QAAM,IAAInqB,KAAK0d,GAAc8L,SAAQ,KAC9ElrB,KAAKmyG,uBAAyBroG,IAC/B9J,KAAKmyG,qBAAuB,SAIhC,OAAOroG,EAGD45G,eACN,IAAI,MAAMr8E,KAAUrnC,KAAK6yG,eACvBxrE,EAAO/mC,SAITN,KAAK6yG,eAAe9nG,QAGfusG,aAAa76F,GAOlB,IAAI+9E,EAEkB,cAAnBx6F,KAAKoiC,KAAKniC,OACXu6F,EAAiB,IAAI57E,IACrBnC,EAAMrP,SAAQ,EAAEi6B,OAAAA,EAAQh6B,QAAAA,MACtB,MAAM0R,EAAO/e,KAAKi3G,aAAa5c,gBAAgBhzD,GACzClH,EAAQphB,MAAAA,OAAI,EAAJA,EAAMohB,MACjBA,GAASphB,EAAK1R,QAAQ8F,OAAS9F,EAAQ8F,OACxCnT,KAAKi3G,aAAale,WAAWh6E,GAC7By7E,EAAen7F,IAAI8gC,QAKzB1jB,EAAMrP,SAAQ,EAAEi6B,OAAAA,EAAQh6B,QAAAA,MACtBrN,KAAKi3G,aAAaza,mBAAmBn1D,EAAQh6B,MAG/C,MAAMo8E,EAASzpF,KAAKi3G,aAAatc,iBAE3BuoB,EAAiB9xG,MAAMC,KAAKo4E,GAAQ9uE,KAAKwlB,IAC7C,GAAGA,EAAMwjB,OAAQ,OACjB,MAAM20C,EAAYn4D,EAAMm4D,UACxB,OAAGA,GAAat4F,KAAKoiC,KAAK0hF,eAAexrB,EAAUjrF,SAC1C8yB,EAAM23D,aAAaQ,EAAUjrF,cADtC,KAGCse,OAAO6kB,SAEV,GAAGgqD,EACD,IAAI,MAAMr6D,KAASq6D,EACjB/Q,EAAOpqF,IAAI8gC,GAIf,MAAO,CACLspD,OAAQ,IAAIA,GACZy5B,eAAAA,GAIGnP,cAAcgQ,GACnB,OAAO/jH,KAAK0uB,WAAWld,IAAIuyG,GAGf9L,kBACZ5qG,EACA8sB,EACAkN,EACA87E,GAAiB,EACjBa,G,0CAEA,IAAI32G,GAAWrN,KAAK4yG,kBAAkBzgE,IAAI9kC,EAAQJ,MAASjN,KAAKyrC,QAAQp+B,EAAQJ,OAASo6B,EACvF,OAGF,MAAM3Y,EAAa1uB,KAAK+zG,gBAExB,IAAIzkG,EACJ,IACEtP,KAAK4yG,kBAAkBvzG,IAAIgO,EAAQJ,KAGnC,MAAMg3G,EAAYnlH,SAASC,cAAc,OACzCklH,EAAUr8G,QAAQqF,IAAM,GAAKI,EAAQJ,IACrCg3G,EAAUr8G,QAAQ2E,OAAS,GAAKc,EAAQd,OACxC03G,EAAUr8G,QAAQwM,UAAY,GAAK/G,EAAQ8F,KAUxCk0B,IACDrnC,KAAKilE,YAAYv1D,OAAOrC,EAAQJ,KAEhCjN,KAAK6yG,eAAexzG,IAAIgoC,GACxBrnC,KAAK8yG,iBAAiBpjG,OAAO23B,GAC7BrnC,KAAK8yG,iBAAiB71F,IAAIgnG,EAAW58E,GACrCrnC,KAAKi3G,aAAa5b,qBAAqBh0D,EAAQ48E,IAGjD58E,EAASrnC,KAAKyrC,QAAQp+B,EAAQJ,KAAOg3G,EACrC,IAAIC,EAAkBlkH,KAAKmkH,cAAc92G,EAAS8sB,EAASkN,GACxD28E,IACDE,EAAkBF,EAAcE,EAAiB78E,IAGnD,MAAMv9B,EAAUo6G,EAAgBxiH,MAAM0D,GAAQA,GAAKspB,IAAe,OAAD,wBAAKtpB,GAAC,CAAE+9G,eAAAA,SAAkBn5G,IAK3F,GAHAhK,KAAK4iH,oBAAoB94G,EAAQ+D,OAAM,UAEvCyB,QAAexF,GACX4kB,IACF,OAGEpf,GACFtP,KAAKilE,YAAY5lE,KAAKgO,EAAQJ,KAEhC,MAAMQ,GACNzN,KAAK8zB,IAAInmB,MAAM,uBAAwBF,GAGzC,OAAIihB,KAIJ1uB,KAAK4yG,kBAAkBljG,OAAOrC,EAAQJ,KAC/BqC,QALP,KASY60G,cACZ92G,EACA8sB,GAAU,EACVkN,G,kDAYA,MAAM+8D,EAA0B,YAAd/2F,EAAQT,EACpBgrG,EAAYxT,GAAa/2F,EAAQgrD,WACvC,IAAI+rD,EAAqBngB,EACzB,MAAMogB,EAAgBzM,QAAkB53G,KAAK2S,SAAS40B,mBAAmBswE,mBAAmBD,QAAa5tG,EAEnGs6G,EAA6C,WAAnBtkH,KAAKoiC,KAAKniC,KAE1C,GAAG23G,GAAa0M,EAAyB,CACvCF,EAAYC,EAAc1pG,KAAKtN,GAAYA,EAAQJ,MACnD,MAAMorG,EAAU5G,GAAqB2S,GACrC,GAAG/2G,EAAQJ,MAAQorG,EACjB,OAIDjU,IACDH,EAAmB2T,EAAYyM,EAAc,GAAKh3G,GAIpD,MAAMk3G,EAAMvkH,KAAKoiC,KAAKoiF,aAAan3G,GAE7B63F,EAAapmG,SAASC,cAAc,OAG1C,IAAIkmG,EACAwf,EAHJvf,EAAW9lG,UAAUC,IAAI,WAKzBolH,EAAiB3lH,SAASC,cAAc,OACxC0lH,EAAerlH,UAAUC,IAAI,0BAE7B4lG,EAAkBnmG,SAASC,cAAc,OACzCkmG,EAAgB7lG,UAAUC,IAAI,kBAE9BgoC,EAAOjoC,UAAUC,IAAI,UACrBolH,EAAe/kH,OAAOulG,GACtB59D,EAAO3nC,OAAO+kH,GAEVF,GAAQl3G,EAAQmL,OAAO4F,MAAOpe,KAAK2c,WAEpBtP,EAAQmL,OAAOksG,QAC9B3b,GAAgB17F,MAGhBrN,KAAK2c,SAASgB,QAAQ0pB,EAAQrnC,KAAKizG,0BACnCjzG,KAAKiyG,SAASh1F,IAAIoqB,EAAQh6B,EAAQJ,MAItC,MAAM2hB,EAA+B,GAC/BuwB,EAAM,CACV9X,OAAAA,EACA59B,SAAUmlB,EACVvhB,QAAAA,EACA8sB,QAAAA,GAGF,KAAiB,mBAAd9sB,EAAQT,GAA4BS,EAAQ22C,QAAWm4C,GAAmBhqD,IAAI9kC,EAAQ22C,OAAOp3C,IAAK,CACnG,MAAMo3C,EAAS32C,EAAQ22C,OACvB,GAAGA,EAAQ,CACT,MAAMp3C,EAAIo3C,EAAOp3C,EACjB,GAAGykG,GAAel/D,IAAIvlC,IAAO8qD,EAAA,kBAAwB9qD,KAAO8qD,EAAA,GAAS9qD,GACnE,OAIJy6B,EAAO1oC,UAAY,iBAEnBsmG,EAAgB3gG,UAAY,GAC5B,MAAMy1B,EAAIj7B,SAASC,cAAc,OAEjC,GADAg7B,EAAE36B,UAAUC,IAAI,eACb2kD,EAAQ,CACT,IAAIl6C,EACJ,GAAgB,oCAAbk6C,EAAOp3C,EAAyC,CACjD,MAAMwrB,EAAY,IAAIE,GACtBxuB,EAAUsuB,EAAUC,OAAO,CAAC9rB,OAAQy3C,EAAO2gE,QAAQ9pG,UAAS,KAC5Dkf,EAAEr6B,QAAO,QAAK,qBAAsB,CAAC04B,EAAUhuB,gBAC1C,GAAgB,+BAAb45C,EAAOp3C,EAAoC,CACnD,MAAMwrB,EAAY,IAAIE,GACtBxuB,EAAUsuB,EAAUC,OAAO,CAAC9rB,OAAQy3C,EAAO51B,WAAWvT,UAAS,KAC/Dkf,EAAEr6B,QAAO,QAAK,mBAAoB,CAAC04B,EAAUhuB,gBAE7C2vB,EAAEr6B,aAAay2D,GAAyB9oD,IAS5C,OANA43F,EAAgBvlG,OAAOq6B,GAEpB1sB,EAAQmL,OAAOosG,WAChBv9E,EAAOjoC,UAAUC,IAAI,iBAGhB8/C,EAGT,IAEI0lE,EAAwB1sD,EAFxB2sD,EAA6B1gB,GAAa/2F,EAAQ2gB,MAGtD,GAAGo2E,EACD,IAAI0gB,MAAAA,OAAY,EAAZA,EAAoDhmH,YACrD,CAAC,QAAS,OAAOsI,SAAW09G,EAAmDhmH,SAAwBmB,YAEnG,GAAG23G,GAAa0M,EAAyB,CAC9C,MAAMjyG,GAAI,EAAAmmD,GAAA,GAAa6rD,GACvBQ,EAAiBxyG,EAAEhF,QAEnB8qD,EAAgB9lD,EAAE8lD,kBAC8E,aAAX,QAA3E,EAAA2sD,MAAAA,OAAY,EAAZA,EAAoDhmH,gBAAuB,eAAEmB,QACvF4kH,EAAiBx3G,EAAQA,QAEzB8qD,EAAgB9qD,EAAQ8qD,mBAGF,2BAArB9qD,EAAQ22C,OAAOp3C,IAChBk4G,EAAe,CACbl4G,EAAG,mBACHo3C,OAAQ32C,EAAQ22C,SAQtB,IAAI+gE,GAAW,EAAAt8D,GAAA,GAAao8D,EAAgB,CAC1C5xD,SAAUkF,EACVs6C,aAAczyG,KAAKyyG,eAGjBuS,GAAc,EACdC,GAAoB,EACpBC,GAAgB,EACpB,GAAG/sD,IAAkB2sD,EAAc,CACjC,IAAIK,EAAgBhtD,EAAcxsC,QAAQtrB,GAAc,uBAARA,EAAEuM,IAC9Cw4G,EAAYP,EAAelkH,OAG/B,GAFqBwkH,EAAcrkG,QAAO,CAACC,EAAKskG,IAAStkG,EAAMskG,EAAK1kH,QAAQ,KAEtDykH,GAAaD,EAAcxkH,QAAU,GAAKw3D,EAAcx3D,SAAWwkH,EAAcxkH,OAAQ,CAC7G,GAAG,uBAA8B,CAC/B,IAAIilC,QAAgB5lC,KAAK2S,SAASo0B,mBAAmBK,wBAAwBy9E,GAC7E,GAA4B,IAAzBM,EAAcxkH,SAAiBmkH,GAAgBl/E,EAChDk/E,EAAe,CACbl4G,EAAG,uBACH9N,SAAU8mC,OAEP,CACL,IAAI1D,EAAgBpjC,SAASC,cAAc,OAC3CmjC,EAAc9iC,UAAUC,IAAI,eAE5B,EAAAs5B,EAAA,GAAauJ,EAAe6iF,GAE5B19E,EAAOjoC,UAAUC,IAAI,SAAW8lH,EAAcxkH,OAAS,KAEvDskG,EAAgBvlG,OAAOwiC,GAGzBmF,EAAOjoC,UAAUC,IAAI,mBAAoB,aACzC4lH,GAAoB,EACpBD,GAAc,EACdE,GAAgB,EAGlB79E,EAAOjoC,UAAUC,IAAI,uBAStB6lH,IACD,EAAAvsF,EAAA,GAAausE,EAAY6f,GAG3B,MAAMpiB,EAAWiB,GAAcxsF,QAAQ,CACrCysF,SAAU7jG,KAAKoiC,KAAKniC,KACpBoN,QAAAA,EACA42F,iBAAAA,IAMF,GAJAiB,EAAWxlG,OAAOijG,GAClBsC,EAAgBphG,QAAQqhG,GAGrBd,GAAa/2F,EAAQg3F,MAAO,CAG7B,GAFAh9D,EAAOjoC,UAAUC,IAAI,kBAED,QAAhB,EAAAgO,EAAQ2qB,gBAAQ,eAAEg9E,oBAAwC,WAAnBh1G,KAAKoiC,KAAKniC,KAAmB,CACtE,MAAMqlH,EAAUxmH,SAASC,cAAc,OACvCumH,EAAQlmH,UAAUC,IAAI,uBAAwB,UAAW,wBACzD4lG,EAAgBphG,QAAQyhH,GACxBj+E,EAAOjoC,UAAUC,IAAI,uBAGnBgO,EAAQmL,OAAOqiB,aAAe76B,KAAK2c,UACrC3c,KAAK2c,SAASgB,QAAQ0pB,EAAQrnC,KAAKmzG,uBAIvC,MAAMoS,EAAcnhB,GAAa/2F,EAAQm4G,aACzC,GAAGD,GAAiC,sBAAlBA,EAAY34G,GAA6B24G,EAAYj7E,MAAQi7E,EAAYj7E,KAAK3pC,OAAQ,CACtG,MAAM2pC,EAAOi7E,EAAYj7E,KAEnBm7E,EAAe3mH,SAASC,cAAc,OAC5C0mH,EAAarmH,UAAUC,IAAI,gBAC3BirC,EAAKl9B,SAASmY,IACZ,MAAM4nB,EAAU5nB,EAAI4nB,QACpB,IAAIA,IAAYA,EAAQxsC,OAAQ,OAEhC,MAAM+kH,EAAS5mH,SAASC,cAAc,OACtC2mH,EAAOtmH,UAAUC,IAAI,oBAErB8tC,EAAQ//B,SAASvO,IACf,MAAMY,GAAO,EAAAgpD,GAAA,GAAa5pD,EAAOY,KAAM,CAACw5D,SAAS,EAAM5C,cAAc,IAErE,IAAIsvD,EAEJ,OAAO9mH,EAAO+N,GACZ,IAAK,oBAUH+4G,EAAWjxD,IATD,EAAAjM,GAAA,GAAa,IAAK,CAC1BwK,SAAU,CAAC,CACTrmD,EAAG,uBACHjM,OAAQ,EACRqjB,OAAQ,EACRsC,IAAKznB,EAAOynB,SAIqByC,kBACrC48F,EAASvmH,UAAUC,IAAI,UAAW,SAElC,MAGF,IAAK,6BACHsmH,EAAW7mH,SAASC,cAAc,UAClC4mH,EAASvmH,UAAUC,IAAI,mBAAoB,UAC3C,QAAiBsmH,GAAWtlH,KAC1B,EAAA4nB,EAAA,GAAY5nB,GAEZ,MAAMulH,EAAQv4G,EAAQ4uF,UAAY5uF,EAAQC,OAC1C,IAAIxD,EACwBA,EAAzBjL,EAAO2Z,OAAOqtG,UAAqB1iH,QAAQ4B,QAAQ/E,KAAKuM,QAC5CvM,KAAK2S,SAASo7F,qBAAqB+X,kBAAkBF,GAAOlkH,MAAM6K,GAC5EA,GAII,IAAIpJ,SAAgB,CAAC4B,EAASylB,KACnC,MAAMu7F,EAAQ,IAAIjoD,GAAa,CAC7B,CAAC99D,KAAKuM,QAAS,KACbA,IACFxH,EAAQwH,MACP,GAEHw5G,EAAM3lH,iBAAiB,SAAS,KAC9BoqB,YAKN1gB,EAAQpI,MAAM6K,IACZ,MAAMV,EAAW7L,KAAKuM,SAAWA,EAASvM,KAAKoiC,KAAKv2B,cAAW7B,EAC/DhK,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAAC9nG,OAAAA,IACrCvM,KAAK2S,SAASo7F,qBAAqBiY,kBAAkBz5G,EAAQV,EAAU+5G,EAAO/mH,EAAO8M,aAGzF,MAGF,QACEg6G,EAAW7mH,SAASC,cAAc,UAKtC4mH,EAASvmH,UAAUC,IAAI,sBAAuB,MAC1B,iBAAX,EACPsmH,EAASnhH,mBAAmB,YAAa/E,GAEzCkmH,EAASjmH,OAAOD,IAGlB,EAAAoF,GAAA,GAAO8gH,GAEPD,EAAOhmH,OAAOimH,MAGhBF,EAAa/lH,OAAOgmH,OAGtB,QAAiBD,GAAeplH,IAC9B,IAAI8G,EAAS9G,EAAE8G,OAGf,GADIA,EAAO/H,UAAUiG,SAAS,yBAAwB8B,GAAS,EAAAwyB,GAAA,GAAgBxyB,EAAQ,yBACnFA,GAAUA,EAAO/H,UAAUiG,SAAS,YAAc8B,EAAO/H,UAAUiG,SAAS,oBAAqB,QAErG,EAAA4iB,EAAA,GAAY5nB,GAEZ,MAAM4lH,GAAS,EAAAhrD,GAAA,GAAW9zD,GACpBoe,EAAM+kB,GAAK,EAAA2wB,GAAA,GAAW9zD,EAAOvD,gBAEnC,IAAI2hB,EAAI4nB,UAAY5nB,EAAI4nB,QAAQ84E,GAE9B,YADAjmH,KAAK8zB,IAAI21C,KAAK,iBAAkBlkD,EAAK0gG,EAAQ54G,GAI/C,MAAMxO,EAAS0mB,EAAI4nB,QAAQ84E,GAC3BjmH,KAAK2S,SAASo7F,qBAAqBmY,oBAAoBlmH,KAAKuM,OAAQc,EAAQJ,IAAKpO,GAAQ6C,MAAMykH,IACxD,iBAA3BA,EAAe94G,SAAwB84G,EAAe94G,QAAQ1M,QACtEgrC,IAAM,EAAA8c,GAAA,GAAa09D,EAAe94G,QAAS,CAAC4rD,SAAS,EAAM5C,cAAc,WAO/E2uD,GAAc,EACd39E,EAAOjoC,UAAUC,IAAI,qBACrBolH,EAAe/kH,OAAO+lH,GAGxB,MAAM7qF,EAAavtB,EAAQmL,OAAOqiB,YAClC,GAAG0pF,EAAK,EACHl3G,EAAQmL,OAAOksG,QAAU9pF,IAAY56B,KAAK2xG,UAAUtyG,IAAIgO,EAAQJ,KACnE,IAAI0L,EAAS,GACEA,EAAZiiB,EAAqB,aACVvtB,EAAQmL,OAAOksG,QAAWr3G,EAA4BmL,OAAOknB,aAAe,UAAY,UACtG2H,EAAOjoC,UAAUC,IAAIsZ,GAGpBiiB,GACDyM,EAAOjoC,UAAUC,IAAI,eAGvB,MAAM+mH,EAAqBhiB,UAAmBpkG,KAAK2S,SAAS40B,mBAAmB8+E,6BAA6Bh5G,IACtGi5G,IAAgBF,GAAsB/4G,EAAQJ,IAAM,EAEvDq5G,GACDj/E,EAAOjoC,UAAUC,IAAI,gBAGvB,MAAM24F,EAAUoM,GAAa/2F,EAAQ2qB,SAC/BigE,EAAYmM,GAAa/2F,EAAQ4qF,UAEjCzpE,EAAQxuB,KAAKoiC,KAAKmkF,aAAal5G,GACrC,IAAIm5G,EAA6BvhB,EAEjC,MAAMwhB,IAAsBp5G,EAAQ4uF,UAAa5uF,EAAQC,SAAW,UAAmBD,EAAQmL,OAAO4F,KAGtG,GAAG0mG,EAA8D,CAC/D,IAAI5iF,EAAgBpjC,SAASC,cAAc,OAC3CmjC,EAAc9iC,UAAUC,IAAI,cAExBwlH,GACFx9E,EAAOjoC,UAAUC,IAAI,oBAGvB,IAAIqnH,GAAoB,EAEJ,OAAO5B,EAAal4G,GACtC,IAAK,oBAAqB,CACxB,MAAMiT,EAAQilG,EAAajlG,MAa3B,GAVIglG,IACFG,GAAc,GAGbyB,GACDp/E,EAAOjoC,UAAUC,IAAI,aAGvBgoC,EAAOjoC,UAAUC,IAAI,SAElBilH,GAA2B1M,GAAkC,IAArBwM,EAAUzjH,OAAc,CACjE0mC,EAAOjoC,UAAUC,IAAI,WAAY,cACjC4iC,GAAU,CACRj2B,SAAUq4G,EACVniF,cAAAA,EACAxT,WAAY1uB,KAAK+zG,gBACjBvlF,MAAO+1F,EACP91F,cAAezuB,KAAKyuB,cACpB2T,KAAMpiC,KAAKoiC,KACXxT,aAAAA,EACA4Q,aAAcx/B,KAAKoiC,KAAK5C,eAG1B,MAGF,MAAMjR,GAAY,GAAAo4F,YAAc3B,IAAgBsB,IA7kHlC,EA8kHX/3F,GAAU8Y,EAAOjoC,UAAUC,IAAI,mBAClCivB,GAAU,CACRzO,MAAOA,EACPxS,QAAAA,EACAnM,UAAWghC,EACX3T,SAAAA,EACAC,MAAAA,EACAC,cAAezuB,KAAKyuB,cACpBC,WAAY1uB,KAAK+zG,gBACjBnlF,aAAAA,EACAC,iBAAkB7uB,KAAKoiC,KAAK5C,aAAa3f,QAG3C,MAGF,IAAK,sBAAuB,CAC1B6mG,GAAoB,EAEpB,IAAIrhD,EAAmBy/C,EAAa72F,QAEpC,GAAiB,YAAdo3C,EAAQz4D,EACT,MAGFy6B,EAAOjoC,UAAUC,IAAI,WAErB,IAAIk+E,EAAMz+E,SAASC,cAAc,OACjCw+E,EAAIn+E,UAAUC,IAAI,OAElB,IAGIunH,EAAgCC,EAHhCC,EAAQhoH,SAASC,cAAc,OACnC+nH,EAAM1nH,UAAUC,IAAI,SAGpB,MAAMwgB,EAAqBwlD,EAAQxlD,OAChCA,GAASwlD,EAAQvmE,YAClB8nH,EAAiB9nH,SAASC,cAAc,OACxC6nH,EAAexnH,UAAUC,IAAI,mBAC7BwnH,EAAU/nH,SAASC,cAAc,OACjC8nH,EAAQznH,UAAUC,IAAI,WACtBunH,EAAelnH,OAAOmnH,IAGxB,IAAIE,EAAejoH,SAASC,cAAc,OAC1CgoH,EAAa3nH,UAAUC,IAAI,cAE3B,MAAMm7B,EAAM6qC,EAAQvmE,SACpB,GAAG07B,EACD,GAAgB,QAAbA,EAAIv6B,MAA+B,UAAbu6B,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,KAAkB,CAErE,MAAM2gF,EAAyB,UAAbpmD,EAAIv6B,KAAmBovB,EAAA,eAA0BA,EAAA,iBACnD,UAAbmL,EAAIv6B,MACLonC,EAAOjoC,UAAUC,IAAI,SACrBwnH,EAAQznH,UAAUC,IAAI,aAEtBgoC,EAAOjoC,UAAUC,IAAI,SAEvB4gC,GAAU,CACRzF,IAAAA,EACAt5B,UAAW2lH,EACXx5G,QAASA,EACTyS,SAAU8gE,EAAUr/E,MACpBwe,UAAW6gE,EAAUp/E,OACrBitB,cAAezuB,KAAKyuB,cACpBC,WAAY1uB,KAAK+zG,gBACjBvlF,MAAAA,EACA2R,MAAOq5B,GACP5qC,aAAAA,EACA4Q,aAAcx/B,KAAKoiC,KAAK5C,mBAGrB,CACL,MAAMqD,QAAeN,GAAa,CAChCl1B,QAASA,EACTwhB,iBAAkB7uB,KAAKoiC,KAAK5C,aAAa6hD,KACzC5yD,cAAezuB,KAAKyuB,cACpBG,aAAAA,EACAwD,SAAU,eACVgN,cAAe,CACbC,WAAW,EACX9yB,OAAQvM,KAAKuM,OACbI,YAAa,CACXC,EAAG,+BAITi6G,EAAQnnH,OAAOmjC,GACfgkF,EAAQznH,UAAUC,IAAI,yBACtB0nH,EAAa3nH,UAAUC,IAAI,gBAU/B,IAAIgT,EACJ,GALGu0G,GACDG,EAAarnH,OAAOknH,GAInBvhD,EAAQK,UAAW,CACpB,MACM9+B,EAAuB8tB,IADhB,EAAAjM,GAAA,GAAa4c,EAAQ/+C,MACwByC,kBAC1D6d,EAAExnC,UAAUC,IAAI,gBAChB,MAAM2nH,EAASloH,SAASC,cAAc,WACtC,EAAA45B,EAAA,GAAaquF,GAAQ,EAAApuF,GAAA,GAAcysC,EAAQK,YAC3C9+B,EAAEjU,YAAc,GAChBiU,EAAElnC,OAAOsnH,GACTD,EAAarnH,OAAOknC,GACpBv0B,EAAIu0B,EAGN,MAAM93B,EAAQy2D,GAAiBF,GAC/B,GAAGv2D,EAAM6jB,YAAa,CACpB,IAAIy3E,EAAWtrG,SAASC,cAAc,OACtCqrG,EAAShrG,UAAUC,IAAI,SACvB,MAAM2nH,EAASloH,SAASC,cAAc,WACtC,EAAA45B,EAAA,GAAaquF,EAAQl4G,GACrBs7F,EAAS1qG,OAAOsnH,GAChBD,EAAarnH,OAAO0qG,GACpB/3F,EAAI+3F,EAGN,MAAMz8D,EAAcy3B,GAAuBC,GAC3C,GAAG13B,EAAYhb,YAAa,CAC1B,IAAIs0F,EAAUnoH,SAASC,cAAc,OACrCkoH,EAAQ7nH,UAAUC,IAAI,SACtB,EAAAs5B,EAAA,GAAasuF,EAASt5E,GACtBo5E,EAAarnH,OAAOunH,GACpB50G,EAAI40G,EAWN,GAFAH,EAAMpnH,OAAOqnH,GAEVlnG,IAAU2a,EAAK,CAChB6M,EAAOjoC,UAAUC,IAAI,SAErB,MAAM2B,EAA4B6e,EAAMO,MAAMP,EAAMO,MAAMzf,OAAS,GACnE,IAAIumH,GAAW,EACZlmH,EAAKuf,IAAMvf,EAAKwf,GAAKnO,GACtBg1B,EAAOjoC,UAAUC,IAAI,mBACrB6nH,GAAW,EACX15F,GAAkB3N,EAAOgnG,EAAS,GAAI,IAAI,IAKlC7lH,EAAKwf,EAAIxf,EAAKuf,GACtB8mB,EAAOjoC,UAAUC,IAAI,qBAGvBivB,GAAU,CACRzO,MAAAA,EACAxS,QAAAA,EACAnM,UAAW2lH,EACX/mG,SAAUonG,EAAW,EAAI73F,EAAA,uBACzBtP,UAAWmnG,EAAW,EAAI73F,EAAA,wBAC1Bb,MAAAA,EACAC,cAAezuB,KAAKyuB,cACpBC,WAAY1uB,KAAK+zG,gBACjBnlF,aAAAA,EACAD,iBAAkBu4F,EAClBr4F,iBAAkB7uB,KAAKoiC,KAAK5C,aAAa3f,QAI7C09D,EAAI79E,OAAOonH,GAIT5hB,EAAWphG,aAAay5E,EAAKolB,GAO/B,MAGF,IAAK,uBAAwB,CAC3B,MAAMnoE,EAAMsqF,EAAahmH,SAIzB,GAAG07B,EAAIoL,QAAkC,CACvCyB,EAAOjoC,UAAUC,IAAI,WACrB2lH,GAAc,EACdC,GAAoB,EAEjBzqF,EAAI6/B,UACLhzB,EAAOjoC,UAAUC,IAAI,oBAGvB,MAAM+gB,EAAQiP,EAAA,SACRruB,EAAOqmC,EAAOjoC,UAAUiG,SAAS,aAAe+a,EAAM+mG,aAAgB3sF,EAAI6/B,SAAWj6C,EAAMgnG,gBAAkBhnG,EAAMinG,cACzH75F,GAAkBgN,EAAK0H,EAAelhC,EAAKO,MAAOP,EAAKQ,QAEvDyjG,EAAgBhiG,MAAMie,SAAWghB,EAAcj/B,MAAM1B,MACrD0jG,EAAgBhiG,MAAMkrD,UAAYjsB,EAAcj/B,MAAMzB,OAEtD,GAAY,CACVg5B,IAAAA,EACAn2B,IAAK69B,EACLxT,WAAY1uB,KAAK+zG,gBACjBtlF,cAAezuB,KAAKyuB,cACpB0R,MAAOq5B,GAEPn3D,MAAM,EACNhB,MAAM,EACNmkC,MAAO6B,EAAOjoC,UAAUiG,SAAS,aAAew/G,OAAiB76G,EACjE06B,WAAW,EACX9V,aAAAA,SAEG,GAAgB,UAAb4L,EAAIv6B,MAAiC,QAAbu6B,EAAIv6B,MAA+B,UAAbu6B,EAAIv6B,KAA4C,CAGtG,MAAMq5D,EAAuB,UAAb9+B,EAAIv6B,KAcpB,GAbGq5D,IACD2rD,GAAoB,IAGnB3rD,GAAYurD,IACbG,GAAc,GAGbyB,GACDp/E,EAAOjoC,UAAUC,IAAI,aAGvBgoC,EAAOjoC,UAAUC,IAAIi6D,EAAU,QAAU,SACtCgrD,GAA2B1M,GAAkC,IAArBwM,EAAUzjH,OACnD0mC,EAAOjoC,UAAUC,IAAI,WAAY,cAEjC4iC,GAAU,CACRj2B,SAAUq4G,EACVniF,cAAAA,EACAxT,WAAY1uB,KAAK+zG,gBACjBvlF,MAAO+1F,EACP91F,cAAezuB,KAAKyuB,cACpB2T,KAAMpiC,KAAKoiC,KACXxT,aAAAA,EACA4Q,aAAcx/B,KAAKoiC,KAAK5C,mBAErB,CACL,MAAMjR,GAAY,GAAAo4F,aAAe,GAAAzpD,WAAa5D,GAAW0rD,IAAgBsB,IAx0H/D,EAy0HP/3F,GAAU8Y,EAAOjoC,UAAUC,IAAI,mBAClC4gC,GAAU,CACRzF,IAAAA,EACAt5B,UAAWghC,EACX70B,QAASA,EACTyS,SAAUuP,EAAA,uBACVtP,UAAWsP,EAAA,wBACXd,SAAAA,EACAC,MAAAA,EACAC,cAAezuB,KAAKyuB,cACpBC,WAAY1uB,KAAK+zG,gBACjB5zE,MAAOq5B,GACP5qC,aAAAA,EACA4Q,aAAcx/B,KAAKoiC,KAAK5C,aACxBJ,cAAek6B,EAAU,CACvB/sD,OAAQvM,KAAKuM,OACbI,YAAa,CAACC,EAAG,iCACjBf,SAAU7L,KAAKoiC,KAAKv2B,SACpBwzB,WAAahyB,EAA4BmL,OAAOknB,aAChDsiC,YAAc30D,EAA4BmL,OAAOknB,mBAC/C11B,SAGH,CACL,MAAMs9G,QEh8HH,UAAoC,wBAAChD,EAAuB,QAAEj3G,EAAO,OAAEg6B,EAAM,WAAE69D,EAAU,KAAE9iE,EAAI,aAAExT,EAAY,iBAAEC,EAAgB,cAAEJ,EAAa,cAAE2Q,EAAa,UAAEC,EAAS,SAAEjN,EAAQ,SAAEzf,I,0CAejM,IAAI6zG,EACJ,MAAMrtF,EAAOmrF,QAAgCliF,EAAKmlF,aAAal6G,EAAQJ,KAAO,CAACI,EAAQJ,KAKjFxD,EAAW0vB,EAAKxe,KAAI,CAAM1N,EAAKoR,IAAQ,mCAC3C,MAAMhR,QAAiB+0B,EAAKy/D,WAAW50F,GACjC5I,QAAYk+B,GAAa,CAC7Bl1B,QAAAA,EACAuhB,aAAAA,EACAC,iBAAAA,EACAJ,cAAAA,EACA2Q,cAAAA,EACAhN,SAAAA,EACAzf,SAAAA,IAGIzR,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI,sBACxB6B,EAAU0G,QAAQqF,IAAM,GAAKA,EAC7B/L,EAAU0G,QAAQ2E,OAAS,GAAKc,EAAQd,OAExC,MAAMi7G,EAAU1oH,SAASC,cAAc,OAGvC,GAFAyoH,EAAQpoH,UAAUC,IAAI,oBAEnBgO,EAAQA,QAAS,CAClB,MAAM63F,EAAapmG,SAASC,cAAc,OAC1CmmG,EAAW9lG,UAAUC,IAAI,oBAEzB,MAAM0lH,GAAW,EAAAt8D,GAAA,GAAap7C,EAAQA,QAAS,CAC7C4lD,SAAU5lD,EAAQ8qD,iBAGpB,EAAAx/B,EAAA,GAAausE,EAAY6f,GACzByC,EAAQ9nH,OAAOwlG,GAGjB,GAAG/rE,EAAKx4B,OAAS,EAAG,CAClB,MAAM2qD,EAAYxsD,SAASC,cAAc,OACzCusD,EAAUlsD,UAAUC,IAAI,sBACxB6B,EAAUxB,OAAO4rD,GAEjBpqD,EAAU9B,UAAUC,IAAI,gBAEb,IAARgf,IACDmoG,EAAgBgB,GAMpB,OAFAA,EAAQ9nH,OAAO2E,GACfnD,EAAUxB,OAAO8nH,GACVtmH,OAGH4sE,QAAmB3qE,QAAQC,IAAIqG,GAOrC,OANAy7F,EAAWxlG,UAAUouE,GAElB30C,EAAKx4B,OAAS,GACf0mC,EAAOjoC,UAAUC,IAAI,wBAAyB,cAGzCmnH,KFm3HkCiB,CAAqB,CAClDnD,wBAAAA,EACAj3G,QAAAA,EACAg6B,OAAAA,EACA69D,WAAAA,EACA9iE,KAAMpiC,KAAKoiC,KACXxT,aAAAA,EACAC,iBAAkB7uB,KAAKoiC,KAAK5C,aAAa6hD,KACzC5yD,cAAezuB,KAAKyuB,cACpB2Q,cAA4B,UAAb5E,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,KAAmB,CAC5DsM,OAAQvM,KAAKuM,OACbI,YAAa,CAACC,EAAgB,UAAb4tB,EAAIv6B,KAAmB,gCAAkC,4BAC1E4L,SAAU7L,KAAKoiC,KAAKv2B,SACpBwzB,WAAahyB,EAA4BmL,OAAOknB,aAChDsiC,YAAc30D,EAA4BmL,OAAOknB,mBAC/C11B,EACJooB,SAAU,iBAGTk1F,IACDd,EAAgBc,GAGlB,MAAMI,EAAgBxiB,EAAWzgG,iBAAiBS,cAAc,6CAEhEwiH,GAAiBA,EAAchoH,OAAOijG,GAEtCt7D,EAAOjoC,UAAUkB,OAAO,oBACxB4kG,EAAW9lG,UAAUC,KAAO,CAAC,QAAS,OAAgC+H,SAASozB,EAAIv6B,MAAiC,WAAzBu6B,EAAIv6B,MAAQ,YAA2B,YAClIymH,GAAoB,EAGtB,MAGF,IAAK,mBAAoB,CACvB,MAAM1iE,EAAS8gE,EAAa9gE,OACtB3/C,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI,cAAe2kD,EAAOxrC,OAAOkY,MAAQ,oBAAsB,eAE7E,MAAMzwB,EAAiB+jD,EAAOxrC,OAAOkY,MAAQ,QAAU,QACvDrsB,EAAIuD,QAAQ3H,KAAOA,EAEnB,MAAM6O,EAAQhQ,SAASC,cAAc,OACrC+P,EAAM1P,UAAUC,IAAI,sBAEpB,QAAMyP,EAAO0f,EACVw1B,EAAOxrC,OAAOkY,MAAQ,2BAA6B,sBACnDszB,EAAOxrC,OAAOkY,MAAQ,2BAA6B,uBAEtD,MAAM+Y,EAAW3qC,SAASC,cAAc,OAGxC,GAFA0qC,EAASrqC,UAAUC,IAAI,6BAEA2K,IAApBg6C,EAAOn+C,SACR4jC,EAAS/pC,OAAO61D,GAAmBvR,EAAOn+C,eACrC,CACL,IAAIgmC,EACJ,OAAOmY,EAAOiR,OAAOroD,GACnB,IAAK,6BACHi/B,EAAc,kBACd,MACF,IAAK,+BACHA,EAAc,2BACd,MAEF,QACEA,EAAc,8BAIlBpC,EAASrqC,UAAUC,IAAI,cACvB,QAAMoqC,EAAUoC,GAGlBpC,EAASrqC,UAAUC,IAAI,QAAS,eAAgC2K,IAApBg6C,EAAOn+C,SAAyB,QAAU,QAEtFxB,EAAI3E,OAAOoP,EAAO26B,GAElBi9E,GAAoB,EAEpBr/E,EAAOjoC,UAAUkB,OAAO,oBACxB4kG,EAAW9lG,UAAUC,IAAI,gBACzB6lG,EAAWxlG,OAAO2E,GAElB,MAGF,IAAK,sBAAuB,CAG1B,MAAMsjH,EAAU7C,EACVtQ,EAAa11G,SAASC,cAAc,OAC1Cy1G,EAAWp1G,UAAUC,IAAI,WACzBm1G,EAAW5sG,QAAQ2E,OAAS,GAAKo7G,EAAQl5D,QAEzCi4D,GAAoB,EAEpB,MAAMkB,EAAiB9oH,SAASC,cAAc,OAC9C6oH,EAAejpH,UAAY,kBAC3B,MAAMkpH,EAAiB/oH,SAASC,cAAc,OAC9C8oH,EAAelpH,UAAY,eAC3BkpH,EAAenoH,QACb,EAAAk5B,GAAA,GAAc,CACZ+uF,EAAQ5pE,WACR4pE,EAAQ3pE,WACRryB,OAAO6kB,SAAS7sB,KAAK,OAGzB,MAAMmkG,EAAmBhpH,SAASC,cAAc,OAChD+oH,EAAiBnpH,UAAY,iBAC7BmpH,EAAiBn1F,YAAcg1F,EAAQI,aAAe,KAAM,EAAAxqE,GAAA,GAAkBoqE,EAAQI,cAAcvqE,UAAY,uBAEhHg3D,EAAW90G,OAAOkoH,GAClBA,EAAeloH,OAAOmoH,EAAgBC,GAEtC,MAAMl/E,EAAa,IAAI0E,GACvB1E,EAAWC,kBAAkB,CAC3Bpa,cAAezuB,KAAKyuB,cACpBliB,OAAQo7G,EAAQl5D,QAAQ5zC,aAE1B+tB,EAAWxpC,UAAUC,IAAI,iBAAkB,aAE3Cm1G,EAAW3wG,QAAQ+kC,GAEnBvB,EAAOjoC,UAAUkB,OAAO,oBACxB4kG,EAAW9lG,UAAUC,IAAI,mBACzB6lG,EAAWxlG,OAAO80G,GAElB,MAGF,IAAK,mBAAoB,CACvBntE,EAAOjoC,UAAUkB,OAAO,oBAExB,MAAMkvD,EG5kID,SAAkBniD,EAAcsF,EAAwB,cACrE,MAAMzO,EAAO,IAAI2rD,GAOjB,OANA3rD,EAAKmJ,QAAUA,EACfnJ,EAAKyO,SAAWA,EAChBzO,EAAK1E,aAAa,UAAW,GAAK6N,EAAQd,QAC1CrI,EAAK1E,aAAa,UAAW6N,EAAQ2gB,MAAMq/B,KAAK78C,IAChDtM,EAAK1E,aAAa,aAAc,GAAK6N,EAAQJ,KAC7C/I,EAAKssB,SACEtsB,EHokIqB8jH,CAAS36G,GAC7B63F,EAAWrhG,QAAQ2rD,GACnB01C,EAAW9lG,UAAUC,IAAI,gBAEzB,MAGF,QACE6iC,OAAgBl4B,EAChBq9B,EAAOjoC,UAAUkB,OAAO,oBACxB4kG,EAAWxlG,QAAO,QAAK,MAA4BijG,GACnD3iG,KAAK8zB,IAAI21C,KAAK,2BAA4Bq7C,EAAal4G,EAAGS,IAI1Dq5G,GAAqBxkF,GACvB+iE,EAAgBvlG,OAAOwiC,GAYxB+iF,GACD59E,EAAOjoC,UAAUC,IAAI,cAGvB,IAAI03D,EAAY,GAGhB,MAAMkxD,EAAY56G,EAAQC,SAAW,UAAkBtN,KAAKoiC,KAAKkqD,YAAej/E,EAAQ4uF,UAAa5uF,EAA4BmL,OAAO2rF,UACxI,GAAG8jB,GAAYjwB,GAAW3qF,EAAQ0gB,aAAc,CAC9C,IAAIjf,EACAo5G,EAEJ,MAAMhwB,EAAuB7qF,EAAQ8qF,SAAiC,gBAAtB9qF,EAAQ8qF,QAAQvrF,GAAuBS,EAAQC,SAAW2qF,EAE1G,IA8BI70D,EA9BA+kF,EAAWnwB,IAAYA,EAAQG,QA+BnC,GA9BG9qF,EAAQ4uF,WACTisB,EAAWppH,SAASC,cAAc,QAClCmpH,EAASjpF,UAAY,WAAaj/B,KAAK2S,SAAS2I,gBAAgBC,QAAQlO,EAAQ4uF,WAAWjwD,SAC3Fk8E,EAAS9oH,UAAUC,IAAI,cACvBgoC,EAAOjoC,UAAUC,IAAI,mBAGpB8oH,GAEDr5G,EAAQhQ,SAASC,cAAc,SAC/B,EAAA45B,EAAA,GAAa7pB,GAAO,EAAA8pB,GAAA,GAAco/D,EAAQ//D,YAC1CnpB,EAAM1P,UAAUC,IAAI,cAEpBgoC,EAAOjoC,UAAUC,IAAI,mBAErByP,EAAQ,IAAIwpB,GAAU,CAAC/rB,OAAQ0rF,GAAa5qF,EAAQC,SAASlD,QAG5DiD,EAAQ0gB,cAAgB1gB,EAAQ0gB,eAAiB/tB,KAAKoiC,KAAKv2B,UAAYu4F,UAClER,GAAcyB,SAAS,CAC3BjjE,KAAMpiC,KAAKoiC,KACXiF,OAAAA,EACA49D,gBAAAA,EACA53F,QAAAA,KAOA4qF,GAAaD,EAaf,GAZGh4F,KAAKuM,SAAW,UAAmB2rF,GACpC7wD,EAAOjoC,UAAUC,IAAI,aAGpBgO,EAAQ0pD,YACTA,EAAY1pD,EAAQ0pD,UACpBjoD,EAAMlH,QAAQmvD,UAAYA,GAG5B3zB,EAAUtkC,SAASC,cAAc,OACjC+P,EAAMlH,QAAQ2E,OAAS,GAAK0rF,EAExBj4F,KAAKuM,SAAW,UAAkBvM,KAAKuM,SAAW,QAAmB2rF,GAA0B+sB,EAG5F,CAGL,MAAM71G,EAA2B,CAACN,GAC/Bm2G,GACD71G,EAAKiQ,QAAQvgB,SAASC,cAAc,OAEtCqkC,EAAQ1jC,QAAO,QAAK,gBAAiB,CAAC0P,UATtCg0B,EAAQngC,MAAMqlB,MAAQ43B,GAAiB+3C,GAAW,GAClD70D,EAAQ1jC,OAAOoP,QAUZ,IAAIzB,EAAQ4uF,SACjB,IAAIgpB,GAAqBgD,EAAU,CACjC7kF,EAAUtkC,SAASC,cAAc,OACjCqkC,EAAQ1jC,OAAOoP,GAEf,MAAMylC,QAAav0C,KAAK2S,SAAS2/B,gBAAgBC,QAAQllC,EAAQC,QAC3DkL,EAAU+7B,MAAAA,OAAI,EAAJA,EAAoB/7B,OACjCA,IAAWA,EAAOsnC,MAAQtnC,EAAOqnC,OAClCzc,EAAQ1jC,OAAO4/C,GAAiB9mC,EAAOsnC,OAGrCykE,IACFnhF,EAAQngC,MAAMqlB,MAAQ43B,GAAiB7yC,EAAQC,QAAQ,IAGzD81B,EAAQx7B,QAAQ2E,OAAS,GAAKc,EAAQC,YAEtC+5B,EAAOjoC,UAAUC,IAAI,aAIzB,GAAGgO,EAAQ4uF,SAAU,CACf74D,EAGFA,EAAQ1jC,OAAO,KAFf0jC,EAAUtkC,SAASC,cAAc,OAKnC,MAAMwK,EAAOzK,SAASC,cAAc,QACpCwK,EAAK7J,QAAO,QAAK,UAAW,IAAKwoH,GACjC3+G,EAAKnK,UAAUC,IAAI,UAEnB+jC,EAAQ1jC,OAAO6J,GAGd65B,IACDA,EAAQhkC,UAAUC,IAAI,QACtBmnH,EAAc9mH,OAAO0jC,SAGvBiE,EAAOjoC,UAAUC,IAAI,aAYvB,GATsB,WAAnBW,KAAKoiC,KAAKniC,OACX82D,EAAY,GAAG/2D,KAAKoiC,KAAK71B,UAAUc,EAAQJ,OAGrBm5G,GAAsBA,EAAmBn5G,MAAQjN,KAAKoiC,KAAKv2B,UAEjFw7B,EAAOjoC,UAAUC,IAAI,oBAAqB,iBAGzC03D,IAAiC,WAAnB/2D,KAAKoiC,KAAKniC,MAAqB+3F,EAAQgd,oBAAsBh1G,KAAKuM,SAAW,MAAiB,CAC7G,MAAM67G,EAAOtpH,SAASC,cAAc,OACpCqpH,EAAKhpH,UAAUC,IAAI,uBAAwB,gBAAiB,oBAC5D4lG,EAAgBvlG,OAAO0oH,GACvB/gF,EAAOz/B,QAAQmvD,UAAYA,EAC3B1vB,EAAOjoC,UAAUC,IAAI,sBAoCvB,OAjCAgoC,EAAOjoC,UAAUC,IAAImvB,EAAQ,SAAW,SAErC83F,GACgB1iB,GAAcoB,cAAc,CAC3C39D,OAAAA,EACA49D,gBAAAA,EACA53F,QAAS+4G,EACTlhB,WAAAA,EACAt2E,aAAAA,EACAH,cAAezuB,KAAKyuB,kBAIpBu2F,GAAc,GAIf5gB,GACDpkG,KAAKw4G,+BAA+BnxE,EAAQh6B,EAAS42F,GASpD+gB,IACD39E,EAAOjoC,UAAUC,IAAI,iBAErB4lG,EAAgBvlG,OAAO2oH,OAGlBlpE,KAGDq5D,+BAA+BnxE,EAAqBh6B,EAA0B42F,EAAmCjC,GACvH,GAAGhiG,KAAKuM,OAAO46B,SACb,OAGF,KAAI88D,MAAAA,OAAgB,EAAhBA,EAAkBznD,aAAcynD,EAAiBznD,UAAUjyB,QAAQ5pB,OACrE,OAKF,MAAMqjG,EAAmB,IAAIvC,GAI7B,GAHAuC,EAAiB30F,KAAK40F,EAAkB,SACxCD,EAAiBxzE,OAAOwxE,GAErB36D,EAAOjoC,UAAUiG,SAAS,oBAC3BgiC,EAAOniC,cAAc,2BAA2BxF,OAAOskG,OAClD,CACL,MAAMkB,EAAa79D,EAAOniC,cAAc,YACxC,GAAGmiC,EAAOjoC,UAAUiG,SAAS,yBAA0B,CACrD,MAAMijH,EAAoBpjB,EAAWzgG,iBACrC,IAAI8jH,EAAqBD,EAAkBpjH,cAAc,qBAErDy9F,EAAwB4lB,GAAsBA,EAAmBrjH,cAAc,SAC/Ey9F,IACFA,EAAWiB,GAAcxsF,QAAQ,CAC/BysF,SAAU7jG,KAAKoiC,KAAKniC,KACpBoN,QAAAA,EACA42F,iBAAAA,KAIJD,EAAiBtkG,OAAOijG,GAEpB4lB,IACFA,EAAqBzpH,SAASC,cAAc,OAC5CwpH,EAAmBnpH,UAAUC,IAAI,oBACjCipH,EAAkBpjH,cAAc,qBAAqBrB,QAAQ0kH,IAG/DA,EAAmB7oH,OAAOskG,OACrB,CACL,MAAMrB,EAAWvxF,MAAMC,KAAKg2B,EAAO/1B,iBAAiB,UAAUV,MAC9DozF,EAAiBtkG,OAAOijG,GAExBuC,EAAWxlG,OAAOskG,KAKhByf,oBAAoBtpF,GAE1B,IADoBn6B,KAAKs0G,UAAU1wG,cAEjC,MAAO,GAGT,MAAMkwB,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,uBAChC7rF,EAAI,QACJ,MAAMwkF,EAAct4G,KAAKu4G,kBAAkBp+E,GAG3C,GAFAm+E,EAAYh1E,OAETtjC,KAAKk7G,sBAAwBl7G,KAAKoiC,KAAKy0E,eAAgB,CACxD,MAAM2R,EAAgBxoH,KAAKyoH,mBAC3BzoH,KAAK0oH,oBAAoBF,GAAe,GAO1C,MAAO,CACLhF,cAAe,KACb1vF,EAAI,WAEJwkF,EAAYhQ,QAAQnuE,GACpBn6B,KAAK6hH,kBAAkBvJ,EAAY9Q,aAErC8Q,YAAAA,GAISwF,qBAAqB6K,EAAiGxuF,G,0CAIjI,IAAIntB,EAAU27G,EAAc37G,QAC5BA,EAAUA,EAAQtM,QAEfV,KAAK4oH,mBACNziB,GAAwBnmG,KAAK8L,WAAW5K,WACxClB,KAAK4oH,kBAAmB,GAG1B,MAUM58G,QAAiB7I,QAAQC,IAAI4J,EAAQ2N,KAAK1N,GACvB,iBAAV,EAAqBjN,KAAKoiC,KAAKy/D,WAAW50F,GAAOA,KAG1D47G,EAAoC,GAC1C,IAAI7oH,KAAK8L,WAAW0hG,UAAkB,SAAMxtG,KAAK8L,WAAW0hG,UAAe,IAAG,CAC5E,IAAIp5D,EAASu0E,EAAgCv0E,MAC7C,IAAIA,EAAO,CACT,MAAM0X,QAAuB9rD,KAAKoiC,KAAK06E,oBACjCgM,EAAah9D,EAAe9+C,QAAQqX,MACpC0kG,EAAYj9D,EAAe9+C,QAAQuzC,KACzCnM,EAAQ,CAACvtC,KAAK,EAAOyvB,QAAQ,EAAO0yF,MAAM,IACvCF,EAAW10E,MAAM,cAAsB00E,EAAWnoH,SAAUqM,EAAQ5F,SAAS0hH,EAAW,MACzF10E,EAAM9d,QAAS,IAGdyyF,EAAU30E,MAAM,WAAmB20E,EAAUpoH,SAAUqM,EAAQ5F,SAAS2hH,EAAUA,EAAUpoH,OAAS,MACtGyzC,EAAMvtC,KAAM,GAIhB,IAAIutC,EAAM9d,QAAUt2B,KAAKuhH,eAAgB,CACvC,MAAM,UAACj+C,EAAS,WAAEu8C,GAAc7/G,KAAKuhH,eACrCvhH,KAAKuhH,oBAAiBv3G,EAClBs5D,IAAatjE,KAAKyrC,QAAQo0E,IAAev8C,IAAcu8C,IACzDzrE,EAAM9d,QAAS,GAIhB8d,EAAMvtC,KAAKgiH,EAAkBh3G,KAAK7R,KAAK48G,UAAU,OAAO,IACxDxoE,EAAM9d,QAAQuyF,EAAkBh3G,KAAK7R,KAAK48G,UAAU,UAAU,UAG7Dz5G,QAAQC,IAAIylH,GAMlB,MAAMp/G,EAAWuC,EAAS2O,KAjDdtN,GACNA,EAEMA,EAAQmL,OAAOorG,MAChB5jH,KAAKipH,0BAA0B57G,GAE/BrN,KAAKi4G,kBAAkB5qG,EAAS8sB,QAJvC,UAkDEh3B,QAAQC,IAAIqG,SACZzJ,KAAKmyG,qBAERnyG,KAAK8L,WAAW0hG,UAAU3mG,KAAO7G,KAAKqyG,kCACvCryG,KAAKqyG,kCAEFryG,KAAKqyG,iCACNryG,KAAKqyG,sCAOHwP,kBAAkBz2E,GACxB,MAAMzsC,EAAY,mBAClB,GAAIqB,KAAKkB,UAAU9B,UAAUiG,SAAS1G,IACjBqB,KAAKkoB,UAAUR,WAI9B0jB,MAAAA,IAAAA,EAAU,CACR26B,aAAc/lE,KAAK8L,WAAWi6D,aAC9B0hC,aAAcznG,KAAK8L,WAAW5K,UAAUumG,eAE1Cr8D,EAAM26B,eAAiB36B,EAAMq8D,cAwBnCznG,KAAKshH,sBAAmBt3G,MAjCxB,CAiBI,MAAM0kB,EAAa1uB,KAAK+zG,gBAClBjvG,EAAW,KACX4pB,KACJ1uB,KAAKkB,UAAU9B,UAAUC,IAAIV,IAG5BqB,KAAKshH,iBACNx8G,IAEAsB,WAAWtB,EAAU,MAyBtBgyG,eAAepqG,EAAeq5C,EAAmBQ,GAEtD,MAAsB,SAAnBvmD,KAAKoiC,KAAKniC,MAAsC,eAAnBD,KAAKoiC,KAAKniC,KACjCD,KAAK2S,SAASm2C,aAAavhB,mBAAmB2hF,WAAWlpH,KAAKuM,OAAQG,EAAOq5C,EAAWQ,EAAWvmD,KAAKoiC,KAAKv2B,UACzF,WAAnB7L,KAAKoiC,KAAKniC,KACXD,KAAK2S,SAASm2C,aAAavhB,mBAAmB6e,UAAU,CAC7D75C,OAAQvM,KAAKuM,OACbI,YAAa,CAACC,EAAG,6BACjBF,MAAAA,EACAG,MAAOk5C,EACPQ,UAAAA,IACC7kD,MAAMynH,IACA,CACLl9F,OAAQk9F,EAAYl9F,OACpB3c,OAAQnM,QAAQ4B,QAAQokH,EAAY75G,QAAQ5N,MAAMlB,IACzC,CAACwM,QAASxM,EAAMwM,QAAQ2N,KAAKkR,GAAMA,EAAE5e,cAIvB,cAAnBjN,KAAKoiC,KAAKniC,KACXD,KAAK2S,SAASm2C,aAAavhB,mBAAmB6hF,qBAAqBppH,KAAKuM,QAAQ7K,MAAMynH,IAGpF,CACLl9F,OAAQk9F,EAAYl9F,OACpB3c,OAAQnM,QAAQ4B,QAAQokH,EAAY75G,QAAQ5N,MAAMy3B,IAAS,CAAEnsB,QAASmsB,EAAKz4B,QAAQy5B,uBANlF,EAYKkvF,gBAAgBvI,EAAuBwI,EAA0BC,EAA2BhjE,EAAmB75C,G,0CAI3H,MAAMonB,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,UAChC,GAAG3/G,KAAKoiC,KAAKy0E,iBAAmB72G,KAAKq/G,uBAInC,OAHAvrF,EAAI21C,KAAK,wBAETzpE,KAAKq/G,uBAAyBr/G,KAAKqpH,gBAAgBngH,KAAKlJ,KAAM8gH,EAAewI,EAAgBC,EAAkBhjE,EAAW75C,IAQ5H,IAAIy/E,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,OAE5B,YADAmzB,EAAI21C,KAAK,cAIX,IAMI+/C,EANAC,GAAa,EAAAx7C,GAAA,GAAqBjuE,KAAKyrC,QAAS,QAEjD89E,GAAoBD,EAAe3oH,SACpC8oH,EAAaA,EAAW99F,QAAQ1e,IAASq8G,EAAeliH,SAAS6F,MAKjEu8G,EADCjjE,EACW75C,GAAS/J,KAAKH,OAAOinH,GAE9B3I,GAGWn+G,KAAKH,OAAOinH,GAI5B,MAAMC,EAASD,EAAW/oH,MAAM+oH,EAAWnrG,WAAWrR,GAAQu8G,EAAYv8G,KACpE08G,EAAYJ,EAAmB,GAAK,CAACC,GACrCI,EAAYL,EAAmB,GAAKE,EAAW/oH,MAAM,EAAG+oH,EAAWnrG,WAAWrR,GAAQu8G,GAAav8G,KAAMktB,UAE5G,MACDrG,EAAI,iBAAkB01F,EAAW98G,EAAOo0G,EACtC4I,EAAO/uG,KAAKkR,IAAM,EAAA6b,GAAA,GAAmB7b,KACrC+9F,EAAUjvG,KAAKkR,IAAM,EAAA6b,GAAA,GAAmB7b,MAG5C,MAAMg+F,EAA4B,GAElC7pH,KAAKs0G,UAAUl1G,UAAUC,IAAI,eAC7B,MAAM8G,EAAQojH,EAAmB,GAAK,GAChCn4E,EAAcm4E,EAAmB,EAAI,EACrCF,EAAkB,CAAClwF,EAAgBiY,EAAc,KACrD,MAAM8b,GAAmB,UACzB,IAAI48D,EAAc,EA4ClB,OA3CA3wF,EAAK/rB,SAAQ,CAACH,EAAKoR,KACjB,MAAMgpB,EAASrnC,KAAKyrC,QAAQx+B,GAC5B,IAAIo6B,GAAUrnC,KAAKilE,YAAY9yB,IAAIllC,GAEjC,YADA6mB,EAAI21C,KAAK,oBAAqBx8D,GAIhC68G,GAAgBzrG,EAAM+yB,GAAgB,IAAOjrC,EAI7C,MAAMs+G,EAAiBp9E,EAAO5iC,iBACxBslH,EAAmC,CAACtF,GACpC1lG,EAAO/e,KAAKi3G,aAAa5c,gBAAgBhzD,GAU/C,GATGtoB,GAAQA,EAAKohB,MAAMwjB,QAAU5kC,EAAKohB,MAAMs4D,WAAa15E,GACtDgrG,EAAkBl4G,KAAKkN,EAAKohB,MAAMwjB,QAGpComE,EAAkB38G,SAAShD,IACzBA,EAAQhL,UAAUC,IAAI,YAAa,iBACnC+K,EAAQnH,MAAM+mH,gBAAkBF,EAAc,QAG7CzrG,IAAS8a,EAAKx4B,OAAS,EAAI,CAC5B,MAAMynE,EAAmB/nE,IACpBA,EAAE8G,SAAWs9G,IAIhBv3D,EAAiBnoD,UACjB0/G,EAAep+G,oBAAoB,gBAAiB+hE,KAGtDq8C,EAAerkH,iBAAiB,gBAAiBgoE,GAGnDyhD,EAAWh4G,QAAQk4G,MAGjB5wF,EAAKx4B,QACPusD,EAAiBnoD,UAGZ,CAAC+kH,YAAAA,EAAa58D,iBAAAA,IAGjB+8D,EAASZ,EAAgBK,EAAQt4E,GACjC84E,EAAYb,EAAgBM,GAC5BQ,EAAYd,EAAgBO,EAAWx4E,GACvC3nC,EAAW,CAACwgH,EAAO/8D,iBAAkBg9D,EAAUh9D,iBAAkBi9D,EAAUj9D,kBAC3Ek9D,EAAmB,CAACH,EAAOH,YAAaI,EAAUJ,YAAaK,EAAUL,aAc/E,IAAIhgH,EAuBJ,OAnCG9J,KAAKo/G,wBACAp/G,KAAKo/G,oBAGb,UAAQ,KACNp/G,KAAK02G,wBAELmT,EAAWz8G,SAAShD,IAClBA,EAAQhL,UAAUkB,OAAO,oBAK1BopH,EAAO/oH,QAAUgpH,EAAUhpH,QAAUipH,EAAUjpH,UAChDmJ,EAAU3G,QAAQC,IAAIqG,IAEtB,SAA4BK,EAASnH,KAAKH,OAAO4nH,GAAU,KAC1D1oH,MAAK,MACJ,UAAQ,KACNmoH,EAAWz8G,SAAShD,IAClBA,EAAQnH,MAAM+mH,gBAAkB,GAChC5/G,EAAQhL,UAAUkB,OAAO,oBAG3BN,KAAKs0G,UAAUl1G,UAAUkB,OAAO,sBAW/BwJ,KAGKugH,uBACZpqH,EACAonC,EACAh6B,EACA4sB,G,0CAEA,MAAM2pB,EAAa,2BAGnB,IAAI90C,EAaAw7G,EACJ,GAhBAjjF,EAAOjoC,UAAUC,IAAIukD,EAAYA,EAAa,IAAM3jD,GAGxC,UAATA,EAAkB6O,GAAQ,QAAK,oBACjB,UAAT7O,EAAkB6O,GAAQ,QAAK,qBACtB,eAAT7O,GAAkC,aAATA,EAAqB6O,GAAQ,QAAK,cAClD,wBAAT7O,EAAgC6O,GAAQ,QAAK,uBACpC,eAAT7O,IACN6O,EAAQhQ,SAASC,cAAc,QAC/B+P,EAAMmwB,gBAAkBj/B,KAAK2S,SAAS2/B,gBAAgBi4E,yBAAyBvqH,KAAKuM,SAEtFuC,EAAM1P,UAAUC,IAAI,SAAUukD,EAAa,UAE3C3pB,EAASpoB,KAAK/C,GAGF,UAAT7O,EACDg6B,EAASpoB,MAAK,QAAK,qBACnBy4G,EAAe,EACb,QAAK,sBACL,QAAK,sBACL,QAAK,sBACL,QAAK,2BAEF,GAAY,UAATrqH,EACRqqH,EAAe,EACb,QAAK,6BACL,QAAK,6BACL,QAAK,6BACL,QAAK,kCAEF,GAAY,aAATrqH,EAAqB,CAC7B,MAAMwpC,GAAW,QAAK,kCACtBA,EAASrqC,UAAUC,IAAI,SAAUukD,EAAa,aAI9C,MAAMyqD,EAAavvG,SAASC,cAAc,OAC1CsvG,EAAWjvG,UAAUC,IAAIukD,EAAa,YAEtC,MAAMl1B,EAAa1uB,KAAK+zG,sBAElB/zG,KAAK2S,SAASo0B,mBAAmByjF,qBAAqB9oH,MAAW84B,GAAQ,mCAC7E,IAAI9L,IAAc,OAElB,MAAME,EAA+B,GAoBrC,aAnBM,GAAY,CAChB4L,IAAAA,EAEAn2B,IAAKgqG,EACL3/E,WAAAA,EACAD,cAAezuB,KAAKyuB,cACpB0R,MAAOq5B,GAEPn3D,MAAM,EACNhB,MAAM,EACNqjC,WAAW,EACX9V,aAAAA,KAGF,QAAiBy/E,GAAahuG,KAC5B,EAAA4nB,EAAA,GAAY5nB,GACZuqG,GAAkBrhC,aAAa,CAACpiE,OAAQ9G,EAAE8G,YAGrChE,QAAQC,IAAIwrB,QAUrBqL,EAASpoB,KAAK43B,EAAU4kE,GAGvBic,IACDrwF,EAASpoB,QACJy4G,EAAa3vG,KAAKzW,IACnB,MAAMqF,EAAOzK,SAASC,cAAc,QAGpC,OAFAwK,EAAKnK,UAAUC,IAAIukD,EAAa,cAChCr6C,EAAK7J,OAAOwE,GACLqF,MAIC,UAATtJ,EACDqqH,EAAal9G,SAASlJ,IACpB,MAAM6H,EAAIjN,SAASC,cAAc,QACjCgN,EAAE3M,UAAUC,IAAI,eAChB6E,EAAKL,QAAQkI,MAEE,UAAT9L,GACRqqH,EAAal9G,SAASlJ,IACpB,MAAM6H,EAAIjN,SAASC,cAAc,QACjCgN,EAAE3M,UAAUC,IAAIukD,EAAa,gBAC7B73C,EAAEkzB,UAAY,IACd/6B,EAAKL,QAAQkI,OAKhBkuB,EAASt5B,OAAS,GACnB0mC,EAAOjoC,UAAUC,IAAI,mBAGvB46B,EAAS7sB,SAAShD,GAAiBA,EAAQhL,UAAUC,IAAIukD,EAAa,cAG1DqlE,0BAA0B57G,EAAmDoD,G,0CACzF,MAAMyzF,IAAiB72F,EAA4BmL,OAAO2rF,UAEpDt4E,EAAIo9E,GADSjpG,KAAK+zG,iBAExB,OAAO/zG,KAAKi4G,kBAAkB5qG,GAAS62F,OAA4Bl6F,GAAW,GAAasF,GAAW,mCACpG,MAAM,OAAC+3B,SAAgBxb,EAAEvc,GACzB,IAAI+3B,EACF,OAAO/3B,EAGT+3B,EAAOjoC,UAAUC,IAAI,gBAAiB,kBAEtC,MAAM8jH,EAAiB,KAClBnjH,KAAK6jH,4BAA8BV,IACpCnjH,KAAK6jH,+BAA4B75G,GAGnCqpC,EAASp0B,GAAQooB,IAGf68D,IACF78D,EAAOjoC,UAAUC,IAAI,gBACrBgoC,EAAOjoC,UAAUkB,OAAO,gBAAiB,UAG3C,MAAM25B,EAA8B,GAC9B4mF,QAAch1F,EAAE7rB,KAAK2S,SAAS2/B,gBAAgBuuE,MAAM7gH,KAAKuM,SAC/D,IAAI+jB,EAA6B+iB,EAAWrzC,KAAKkB,UAAW+d,EAA+B,SAC3F,GAAGjf,KAAKoiC,KAAKymB,aACXv4B,EAAgBtwB,KAAKqqH,uBAAuB,aAAchjF,EAAQh6B,EAAS4sB,OACtE,IAAGiqE,EAAa,CACrB,IAAIzkG,EAAmBwN,EAAawyG,EAAoB36G,EAExDuiC,EAAOjoC,UAAUC,IAAI,mBAErB,MAAMg0G,EAAmBrzG,KAAKqzG,iBAAoBhmG,EAA4BgmG,iBACxE9mG,GAAS,EAAAusC,GAAA,GAAUu6D,EAAiBlb,SAEvCkb,EAAiBoX,cAClBhrH,EAAO,kBACPwN,GAAM,EAAAy9G,GAAA,GAAkBrX,EAAiBoX,eACjCpX,EAAiBsX,aAAe9J,GACxCphH,EAAO,uBACPggH,EAAapM,EAAiBsX,aAE9BlrH,SAAaO,KAAK2S,SAAS2/B,gBAAgBg6C,WAAW//E,IAAU,yBAA2B,2BAI3FzH,EADCuuG,EAAiBuX,YACP,KACT,IAAI3jB,GAAoBoM,EAAiBwX,iBAAkBxX,EAAiBuX,cAEtEvX,EAAiBwX,iBACd,KACT,MAAMh8E,EAAqB,CACzBjiC,EAAGo6F,GAAmB8jB,UACtBC,OAAQ1X,EAAiBwX,kBAG3B7qH,KAAKoiC,KAAKgyE,aAAa4W,oBAAoBn8E,IAGlC,KACT7uC,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAAA,EACA+2D,UAAWr2D,EACXwyG,WAAAA,KAKN,MAAM5gH,GAAS,OAAO,yDAA0D,CAC9EY,KAAAA,IAWF,OARAO,KAAK2c,SAASgB,QAAQ9e,EAAQmB,KAAKmzG,uBAEhCruG,IACD,QAAiBjG,EAAQiG,GAG3BuiC,EAAOniC,cAAc,mBAAmBrB,QAAQhF,GAEzCyQ,EACF,GAAGuxG,GAAuB,YAAdxzG,EAAQT,EAAiB,CAC1C,MAAMm+C,EAAIjsD,SAASC,cAAc,KACjCgsD,EAAErrD,QAAO,QAAK,iBACdu6B,EAASpoB,KAAKk5C,EAAG,QACjB1X,EAAWrzC,KAAKs0G,UAChBr1F,EAAS,eAETqR,SADczE,EAAE7rB,KAAK2S,SAAS2/B,gBAAgBg6C,WAAWtsF,KAAKuM,kBAAmBsf,EAAE7rB,KAAK2S,SAAS2/B,gBAAgBC,QAAQvyC,KAAKuM,UAAUiM,OAAOyyG,QAC/HjrH,KAAKqqH,uBAAuB,QAAShjF,EAAQh6B,EAAS4sB,GAC3C,cAAnBj6B,KAAKoiC,KAAKniC,KACFD,KAAKqqH,uBAAuB,sBAAuBhjF,EAAQh6B,EAAS4sB,GAC5E,WAAmBj6B,KAAKuM,OAChBvM,KAAKqqH,uBAAuB,QAAShjF,EAAQh6B,EAAS4sB,GAC9Dj6B,KAAKuM,OAAO46B,WAAa05E,UAAeh1F,EAAE7rB,KAAKoiC,KAAK+2E,aAAiC,SAAnBn5G,KAAKoiC,KAAKniC,KACpED,KAAKqqH,uBAAuB,WAAYhjF,EAAQh6B,EAAS4sB,GAEzDj6B,KAAKqqH,uBAAuB,aAAchjF,EAAQh6B,EAAS4sB,GAG1E3J,UACKA,GAGL2J,EAASt5B,QACS0mC,EAAOniC,cAAc,0BAC7BrB,WAAWo2B,GAGxB,MAAMixF,IAA0BlrH,KAAKqyG,gCAC/B8Y,EAAenrH,KAAKyhH,gBAAkByJ,EAC5C,GAAGC,EAAc,CACf,MAAMC,EAAQ/jF,EAAOte,kBACrBqiG,EAAMhsH,UAAUC,IAAI,iBAEjBW,KAAKoiC,KAAKy0E,gBACX72G,KAAKoiC,KAAKy0E,eAAehpG,MAAM8vB,GAAA,GAAMzS,SAAQ,KAC3CkgG,EAAMhsH,UAAUkB,OAAO,oBAgC7B,QA3Be0J,IAAZyG,GAA0B06G,IAC3B16G,GAAU,GAGTy6G,GAAyBz6G,GAC1BzQ,KAAK6jH,0BAA4BV,EAEjCnjH,KAAKo/G,gBAAkB,KAKrB,GAHAp/G,KAAKo/G,qBAAkBp1G,GAGnBhK,KAAKmyG,qBACP,OAAO,aAGHnyG,KAAKoiC,KAAKy0E,eAClB72G,KAAKs/G,0BAA4B,KAC/Bt/G,KAAKs/G,+BAA4Bt1G,EACjCm5G,KAIFnjH,KAAK6jH,0BAA4BV,GAI/B+H,GAAyBz6G,EAAS,OAC9Bob,GAAE,YACR,MAAMy9F,GAAiB,EAAAr7C,GAAA,GAAqBjuE,KAAKyrC,UACjD,EAAA15B,EAAA,GAAiBu3G,EAAgBj8G,EAAQJ,KACzCjN,KAAKqpH,gBAAgBh8G,EAAQJ,IAAKq8G,GAAgB,EAAO,EAAG,GAO9D,OAHEtpH,KAAKo9G,uBAAyB/1E,EAGzB/3B,UAIH+7G,uBAAuBC,EAAY,GAEzC,IAAItnG,GAA6B,cAAnBhkB,KAAKoiC,KAAKniC,MAAwB,EAAI,GAAKqrH,EAGzD,MAAM96G,GAAM7N,KAAKoE,IAAIid,GAErB,MAAO,CAACxT,GAAAA,EAAIvD,KADCtK,KAAKoE,KAAI,EAAA2jH,GAAA,GAAkBl6G,KAI5B+6G,0BAA6CC,EAAah3D,EAAuD82D,EAAY,G,0CACzI,MAAM,GAAC96G,EAAE,IAAEvD,GAAOjN,KAAKqrH,uBAAuBC,GAC9C,IAAIj+G,EAA0F,CAC5FT,EAAG4+G,EAAU,iBAAmB,UAChCr4G,KAAM,EACN3C,GAAAA,EACAvD,IAAAA,EACA8zF,cAAe/gG,KAAK2S,SAAS2/B,gBAAgBm5E,cAAczrH,KAAKuM,QAChEiM,OAAQ,CACNorG,OAAO,IAiBX,OAbI4H,IACFn+G,EAAQA,QAAU,KAKpB,EAAAs3B,GAAA,GAAwCt3B,GAExCmnD,GAAQA,EAAKnnD,GAGbA,SAD4BrN,KAAK2S,SAAS40B,mBAAmBmkF,aAAa,CAACr+G,GAAU,CAACs+G,QAAS,IAAI16G,OAC3E,GACxB5D,EAAQJ,IAAMA,EACPI,KAGFo7G,mBAEL,OIx9JW,UAA0B,gBAACniB,EAAe,SAAEtsE,EAAQ,UAAE4xF,IAMnE,MAAMplB,EAAeF,EAAgB7/F,wBAC/BwzB,EAAW7oB,MAAMC,KAAKi1F,EAAgBh1F,iBAA8B0oB,IAEpE6xF,EAAkC,GACtC3uG,EAA+B,GAC/B4uG,EAAuC,GACzC,IAAIC,GAAe,EACnB,IAAI,MAAM3hH,KAAW6vB,EAAU,CAC7B,MAAMzzB,EAAO4D,EAAQ3D,wBACfulH,EAAc3lB,GAAej8F,EAASk8F,GAAiB,EAAO9/F,EAAMggG,GAG1E,IAAItoF,EADgB8tG,GAGlBD,GAAe,EACf7tG,EAAQhB,GAERgB,EADQ6tG,EACAD,EAEAD,EAGV3tG,EAAMrM,KAAK,CACTzH,QAAAA,EACA5D,KAAAA,EACAwlH,YAAAA,IAIJ,GAAGJ,GAAa1uG,EAAQvc,OAAQ,CAC9B,MACMsrH,EADS/uG,EAAQ,GAAG1W,KAAKK,IACP+kH,EAElBM,EADYhvG,EAAQA,EAAQvc,OAAS,GAAG6F,KAAK8vB,OACrBs1F,EAE9B,IAAI,IAAkC7/G,EAArB8/G,EAAalrH,OAAqB,EAAGoL,GAAK,IAAKA,EAAG,CACjE,MAAM3B,EAAUyhH,EAAa9/G,GAC1B3B,EAAQ5D,KAAKK,KAAOolH,IACrBJ,EAAattG,OAAOxS,EAAG,GACvBmR,EAAQmC,QAAQjV,IAIpB,IAAI,IAAI2B,EAAI,EAAGpL,EAASmrH,EAAgBnrH,OAAQoL,EAAIpL,IAAUoL,EAAG,CAC/D,MAAM3B,EAAU0hH,EAAgB//G,GAC7B3B,EAAQ5D,KAAK8vB,QAAU41F,IACxBJ,EAAgBvtG,OAAOxS,IAAK,KAC1BpL,EACFuc,EAAQrL,KAAKzH,KAOnB,MAAO,CAACyhH,aAAAA,EAAc3uG,QAAAA,EAAS4uG,gBAAAA,GJ25JtBrD,CAAiB,CACtBniB,gBAAiBtmG,KAAK8L,WAAW5K,UACjC84B,SAAU,4CACV4xF,UAA8C,EAAnCjpH,KAAKH,IAAI,IAAK,aAItBkmH,oBAAoBhoH,EAAoDyrH,GAK7E,MAAM,aAACN,EAAY,gBAAEC,GAAmBprH,EAClC0rH,EAAYP,EAAavrG,OAAOwrG,GACtC,IAAIM,EAAUzrH,OACZ,OAGCkrH,EAAalrH,SACdX,KAAK48G,UAAU,OAAO,GACtB58G,KAAKw8G,0BAAuBxyG,GAG3B8hH,EAAgBnrH,SACjBX,KAAK48G,UAAU,UAAU,GACzB58G,KAAKy8G,6BAA0BzyG,GAGjC,MAAMmvB,EAAOizF,EAAUzxG,KAAI,EAAEvQ,QAAAA,MAAcA,EAAQxC,QAAQqF,MAE3D,IAAIqrG,IACCuT,EAAalrH,UAAamrH,EAAgBnrH,QAAWwrH,IACxD7T,EAAct4G,KAAKu4G,oBAAoBsT,EAAalrH,QACpD23G,EAAYh1E,QAGdtjC,KAAKy3G,oBAAoBt+E,GAAM,GAAO,GAEnCm/E,EACDA,EAAYhQ,UACJujB,EAAalrH,SACrBX,KAAK8L,WAAW2yG,mBAAqBz+G,KAAK8L,WAAW24C,WAIlDm0D,cAAcxC,GAEnB,GAAG,GAAAzpF,WAAc3sB,KAAKmqD,6BAA+BisD,EACnD,OAKF,MAAM11G,EAAQV,KAAKyoH,mBAEnBzoH,KAAK0oH,oBAAoBhoH,GAIbk8G,UAAUt4E,EAAkB9jC,EAAgB6rH,GAAoB,G,0CAE5E,GADmBrsH,KAAK8L,WAAW0hG,UAAUlpE,KAAU9jC,EAYvD,OAPYR,KAAK8zB,IAAI6rF,WAAW,YAChC7rF,CAAI,SAAUwQ,EAAM9jC,GAEpBR,KAAK8L,WAAW0hG,UAAUlpE,GAAQ9jC,EAI9B6rH,GAIArsH,KAAKoiC,KAAKymB,eACA,WAATvkB,UAA2BtkC,KAAK2S,SAAS2/B,gBAAgBlE,YAAYpuC,KAAKuM,UAC3EvM,KAAKssH,uBAAuB9rH,GAGlB,QAAT8jC,GAAkB9jC,UAAeR,KAAK2S,SAAS2/B,gBAAgBuuE,MAAM7gH,KAAKuM,UACpEvM,KAAKusH,uBAITvsH,KAAKwsH,qCAdZ,KAiBYF,uBAAuB9rH,G,0CACnC,MAAMisH,EAAOzsH,KAAK8zB,IAAI6rF,WAAW,aACjC8M,EAAK,YACL,MAAM,IAACx/G,GAAOjN,KAAKqrH,uBA37Ja,GA47JhC,GAAG7qH,EAAO,CACR,MAAMkuB,EAAa1uB,KAAK+zG,eAAc,IAC7B/zG,KAAK8L,WAAW0hG,UAAUl3E,SAAWt2B,KAAKyrC,QAAQx+B,IAAQjN,KAAKm/G,6BAA+Br1G,IAGjGA,EAAU9J,KAAKm/G,2BAA6Bn/G,KAAK2S,SAASoH,gBAAgB2yG,oBAAoB1sH,KAAKuM,OAAO8hB,YAC/G3sB,MAAWirH,GAAsB,mCAChC,MAAMtZ,EAAmBsZ,EAAkB3gH,SAAS,GACpD,IAAIqnG,EAEF,YADAoZ,EAAK,cAIP,MAAMG,EAAiB5sH,KAAKurH,2BAA0B,GAAQl+G,IAC5DA,EAAQA,QAAUgmG,EAAiBhmG,QACnCA,EAAQ8qF,QAAUkb,EAAiBlb,QACnC9qF,EAAQ4lD,SAAWogD,EAAiBpgD,SACpC5lD,EAAQmL,OAAO2rF,WAAY,EAC3B92F,EAAQgmG,iBAAmBA,IA98JD,GAi9J5B,OAAOlwG,QAAQC,IAAI,CACjBwpH,EACA5sH,KAAKw8G,qBACLx8G,KAAKmyG,uBACJzwG,MAAK,EAAE2L,MACJqhB,MAEJ+9F,EAAK,YAAap/G,GACFrN,KAAK89G,qBAAqB,CAAC9wG,QAAS,CAACK,KAAW,YAEjE6d,SAAQ,KACTlrB,KAAKm/G,gCAA6Bn1G,UAGpCyiH,EAAK,oBAAqBx/G,GAC1BjN,KAAKy3G,oBAAoB,CAACxqG,IAC1BjN,KAAKm/G,gCAA6Bn1G,KAIxBuiH,uB,0CACZ,MAAME,EAAOzsH,KAAK8zB,IAAI6rF,WAAW,mBAE3BjxF,EAAa1uB,KAAK+zG,gBAClBzkG,QAAetP,KAAK2S,SAASm2C,aAAa9Z,kBAAkB+4C,WAAW/nF,KAAKuM,OAAOqO,YACzF6xG,EAAK,2BAA4Bn9G,EAAO2c,QACxC,MAAM4gG,EAAiBv9G,EAAOA,OAAO5N,MAAWomF,GAAa,mC,MAC3D,IAAIp5D,IACF,OAGF,KAAqB,QAAjB,EAAAo5D,EAASglC,gBAAQ,eAAEn/E,aAErB,OADA8+E,EAAKhjD,KAAK,kBACHzpE,KAAKwsH,gCAGd,MAAMn/G,QAAgBrN,KAAKurH,2BAA0B,GAAQl+G,IAC3DA,EAAQA,QAAUy6E,EAASglC,SAASn/E,eAGtC,OAAIjf,KAIJ+9F,EAAK,aAKE,CAACn8F,cAJctwB,KAAKipH,0BAA0B57G,GAAUiC,EAAO2c,QAAQvqB,MAAK,KACjF+qH,EAAK,kBANP,OAYF,GAAIn9G,EAAO2c,OAIX,OAAO4gG,KAGIL,gC,0CACX,GAAGxsH,KAAK8L,WAAW0hG,UAAU3mG,KAC3B7G,KAAK8L,WAAW0hG,UAAUl3E,aACMtsB,IAAhChK,KAAKo9G,yBAEHp9G,KAAKoiC,KAAKymB,sBACF7oD,KAAKoiC,KAAK06E,qBAAqB/vG,QAEpCo/E,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,QAE3BwrF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,SACzBX,KAAKk7G,qBAEY,cAAnBl7G,KAAKoiC,KAAKniC,OAAyBksF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,QAEhE,CACAX,KAAK8zB,IAAI,iCAET,MAAMzmB,QAAgBrN,KAAKurH,2BAA0B,GACrD,MAAO,CAACj7F,cAAetwB,KAAKipH,0BAA0B57G,QAInDqvG,YAAYhwG,EAAgBytB,EAAmB4yF,EAAuBjM,EAAwB70D,GACnG,MAAMv9B,EAAa1uB,KAAK+zG,cAAc9nD,OAAWjiD,EAAY,KACnDmwB,EAAUn6B,KAAKw8G,qBAAuBx8G,KAAKy8G,2BAA6B+E,GAG5ElyG,EAAStP,KAAKkpH,WAAWx8G,EAAOytB,EAAS4yF,EAAajM,EAAe70D,EAAUv9B,GAC/E8yF,EAAclyG,EAAO5N,MAAMoL,GAAQA,IAAQA,EAAI00G,aAAe10G,EAAIhD,WA8BxE,OA5BCqwB,EAAUn6B,KAAKw8G,qBAAuBgF,EAAcxhH,KAAKy8G,wBAA0B+E,EACpFA,EAAY9/G,MAAK,KACXgtB,MAIHyL,EAAUn6B,KAAKw8G,0BAAuBxyG,EAAYhK,KAAKy8G,6BAA0BzyG,EAE9EiiD,GAGsB,SAAnBjsD,KAAKoiC,KAAKniC,MAITmG,YAAW,KACN+zB,EACDn6B,KAAKu8G,iBAAgB,GAAM,GAE3Bv8G,KAAKu8G,iBAAgB,GAAO,KAE7B,OAONjtG,EAWI45G,WACXx8G,EAAQ,EACRytB,GAAU,EACV4yF,GAAc,EACdjM,EAAgB,EAChB70D,GAAW,EACXv9B,G,0CAEA,MAAMniB,EAASvM,KAAKuM,OAEd6hC,QAAoBpuC,KAAK2S,SAAS2/B,gBAAgBlE,YAAY7hC,GAE9DunC,EAAYnxC,KAAKC,IAAI,GAAI,UAAoB,GAAkB,GAIrE,IAAImjD,EAFkB3X,EAAc,GAAM+9C,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,OAAS,EAAIgC,KAAKH,IAAI,GAAIsxC,GAAaA,EAS3G,QAAmB9pC,IAAhBunG,GAA2B,CAC5B,IAAGA,GAKD,MAAO,CAACtlF,QAAQ,EAAOniB,QAAS3G,QAAQ4B,UAAWy8G,YAAar+G,QAAQ4B,WAJrEonF,OAAOzuE,KAAK1d,KAAKyrC,SAAS9qC,OAAS,KAClC4wG,GASR,IAUI+X,EAVA/iE,EAAY,EAWhB,GAVGwmE,IACDxmE,EAAYR,EAER5rB,IACF4rB,EAAY,IAMb+6D,IAAkBiM,EACnB,GAAsB,WAAnB/sH,KAAKoiC,KAAKniC,KACXqpH,EAAiB,CAACxI,OACb,CACL,MACMpgH,SADuBV,KAAKoiC,KAAK06E,qBACV9vG,QAAQtM,MACrC,GAAGA,EAAMC,OAASolD,IAAcrlD,EAAM0zC,MAAM,WAAgB,CAC1Dk1E,EAAiB5oH,EAAMA,QAGvB,IAAI,IAAIqL,EAAIu9G,EAAe3oH,OAAS,EAAGoL,GAAK,IAAKA,EAAG,CAClD,MAAMsB,QAAgBrN,KAAKoiC,KAAKy/D,WAAWynB,EAAev9G,IAC1D,KAAIsB,MAAAA,OAAO,EAAPA,EAA6BgrD,YAC5B,MADwCixD,EAAe/qG,OAAOxS,EAAG,GAIxEW,EAAQ48G,EAAeA,EAAe3oH,OAAS,IAAM+L,GAQ3D,IACIsgH,EADA19G,QAA6CtP,KAAK82G,eAAepqG,EAAOq5C,EAAWQ,GAIvF,MAAMgjE,GAAmBD,MAAAA,OAAc,EAAdA,EAAgB3oH,UAAW2O,EAAO2c,OACrDghG,EAAwBjtH,KAAKwyG,aAAejsD,IAAcj3C,EAAO2c,QAAWs9F,EAC/EA,IACDyD,EAAgB19G,EAAOA,OAEvBA,EAAS,CACP2c,QAAQ,EACR3c,OAAQnM,QAAQ4B,QAAQ,CAACiI,QAASs8G,MAMtCtpH,KAAKwyG,aAAc,EAEnB,MAAMwR,EAAsB2E,GAAoD,mC,MAC9E,GAAyC,QAArC,EAAAA,EAAgCv0E,aAAK,eAAEvtC,IAAK,CAC9C,GAAsB,eAAnB7G,KAAKoiC,KAAKniC,KAAuB,CAClC,MAAMitH,QAA8BltH,KAAK2S,SAAS40B,mBAAmB4lF,0BAA0BntH,KAAKuM,OAAQvM,KAAKoiC,KAAKv2B,UACnHqhH,GAAuBvE,EAAc37G,QAAQ6E,KAAKq7G,GACrD,MAAM/zF,QAAan5B,KAAKoiC,KAAKmlF,aAAavnH,KAAKoiC,KAAKv2B,UACpD88G,EAAc37G,QAAQ6E,QAAQsnB,EAAKgB,iBAI/Bn6B,KAAK2S,SAASq8B,kBAAkBoY,mBAAmB76C,OAMvD6gH,EAAOzE,IACJ,WAA2BjnH,MAAK,IAC9BsiH,EAAc2E,KACpBjnH,MAAK,MACF6nH,GAAoBzI,GACtB6H,EAAc37G,QAAQqS,QAAQyhG,GAGzB9gH,KAAK89G,qBAAqB6K,EAAexuF,MAI9C0yF,EAAkBQ,IACtB,MAAMvjH,EAAU3G,QAAQ4B,QAAQsoH,GAAU3rH,MAAM4N,IAC9C,GAAGof,IAAeA,IAChB,MAAM8iF,GAGR,IAAGvlD,EASH,OAAOmhE,EAAI99G,GAPTtP,KAAK8L,WAAWg5B,cAQhBr3B,IAEF,MADAzN,KAAK8zB,IAAInmB,MAAM,oBAAqBF,GAC9BA,KAGR,OAAO3D,GAGT,IAAIA,EAAwBmiB,EAC5B,GAAI3c,EAAO2c,OAGJ,IAAGggC,EAGR,OADAjsD,KAAK8L,WAAWg5B,WACT,KAEP7Y,GAAS,EACTniB,EAAUsjH,QAAU99G,EAAOA,aAR3B2c,GAAS,EACTniB,EAAU+iH,EAAev9G,EAAOA,QAUlC,MAAMkyG,EAAc+H,EAAmBsD,EAAeG,GAAiBljH,EAEvE,GAAGmjH,GAAwB,+BAAqD,CAC9E,IAAI54D,EAAQk1D,EAAmB,EAAI,EACnCvpH,KAAKqyG,gCAAkC,KACrCryG,KAAK8zB,IAAI,qCAEJugC,IAELr0D,KAAKqyG,qCAAkCroG,EAEvBhK,KAAKqpH,gBAAgBvI,EAAewI,EAAgBC,EAAkBhjE,EAAW75C,GACzFhL,MAAK,KACX0E,YAAW,KACTpG,KAAKu8G,gBAAgBpiF,GAAS,KAC7B,aAIPn6B,KAAKqyG,qCAAkCroG,EAGzC,OAAGiiD,EACM,KAGF,CAAChgC,OAAAA,EAAQniB,QAAAA,EAAS03G,YAAAA,MAGd+B,qB,0CACX,GAAwB,SAAnBvjH,KAAKoiC,KAAKniC,MAAsC,eAAnBD,KAAKoiC,KAAKniC,KAC1C,OAGF,GAAGD,KAAKi/G,qBACN,OAGF,MAAMyD,QAAqB1iH,KAAKoiC,KAAKm5E,kBACrC,IAAIwB,QAAkB/8G,KAAK2S,SAAS40B,mBAAmB64E,qBAAqBpgH,KAAKuM,OAAQvM,KAAKoiC,KAAKv2B,UACnG,GAAIkxG,IAEJA,EAAY5wB,OAAOzuE,KAAK1d,KAAKyrC,SAC5B9f,QAAQ1e,IAASjN,KAAKyrC,QAAQx+B,GAAK7N,UAAUiG,SAAS,YACtDsV,KAAK5O,IAAOA,IACZuvC,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IACnB34C,MAAMrG,GAAMA,EAAIgxG,IAEdA,GAAa/8G,KAAKyrC,QAAQsxE,IAAY,CACvC,IAAI11E,EAASrnC,KAAKyrC,QAAQsxE,GACvB/8G,KAAKsyG,mBAAqBtyG,KAAKsyG,oBAAsBjrE,IACtDrnC,KAAKsyG,kBAAkBlzG,UAAUkB,OAAO,mBACxCN,KAAKsyG,kBAAoB,MAGxByK,IAAc2F,GACfr7E,EAAOjoC,UAAUC,IAAI,mBAGvBW,KAAKsyG,kBAAoBjrE,EACzBrnC,KAAKi/G,sBAAuB,MAIzBrlB,wBACL,MAAM0zB,EAActtH,KAAK8qG,kBAAoBnR,GAAgB,EAC7D,IAAInnD,GAAU,EACd,IAAI,MAAMzmC,KAAK/L,KAAK8xG,aAAc,CAChC,MAAM2G,EAAcz4G,KAAK8xG,aAAa/lG,GAEnC0sG,EAAYv3G,UAAU+J,oBAAsBqiH,IAC7C7U,EAAYv3G,UAAUZ,SACnBN,KAAK8qG,mBACN9qG,KAAK8qG,kBAAkBjtF,UAAU46F,EAAYv3G,UAAWu3G,EAAYp0G,YAE/DrE,KAAK8xG,aAAa/lG,GACzBymC,GAAU,GASVA,IAIA25C,OAAOzuE,KAAK1d,KAAK8xG,cAAcnxG,QACjCX,KAAKkB,UAAU9B,UAAUkB,OAAO,cAGlCN,KAAKwsH,gCACLxsH,KAAK02G,0BAIF,SAAS2R,KACd,MAAMvsF,EAAMh9B,SAASs9B,gBAAgB,6BAA8B,OACnEN,EAAInV,eAAe,KAAM,UAAW,aACpCmV,EAAInV,eAAe,KAAM,QAAS,MAClCmV,EAAInV,eAAe,KAAM,SAAU,MACnCmV,EAAI18B,UAAUC,IAAI,eAElB,MAAMqgD,EAAM5gD,SAASs9B,gBAAgB,6BAA8B,OAKnE,OAJAsjB,EAAI/4B,eAAe,KAAM,OAAQ,wBAEjCmV,EAAIp8B,OAAOggD,GAEJ5jB,EKj9KM,MAAMyxF,GACnB3tH,YAAoB2M,EAAwBU,EAAqBugH,EAAsBtvD,GAAnE,KAAA3xD,OAAAA,EAAwB,KAAAU,IAAAA,EAAqB,KAAAugH,MAAAA,EAAsB,KAAAtvD,UAAAA,EACrFl+D,KAAKyoB,YAGOA,Y,qCACZ,MAAM,OAAClc,EAAM,IAAEU,EAAG,MAAEugH,EAAK,UAAEtvD,GAAal+D,KACxC,IAAI8O,EAAoB6+B,EAA0BmM,EAChD3M,EAAuC,GAAIW,EAA6C,GAE1F,MAAMn7B,EAAW,aAEX86G,QAAiB96G,EAAS2/B,gBAAgBo7E,cAAcnhH,GAExDzH,EAAW,CAACskC,EAA4CukF,EAAmBC,KAC/ExnH,YAAW,KACT,IAAI0D,EAGAA,EAFD0jH,IAAUvgH,EACRwgH,EACS96G,EAAS40B,mBAAmBsmF,iBAAiBthH,GAE7CoG,EAAS40B,mBAAmBumF,mBAAmBvhH,GAGjDoG,EAAS40B,mBAAmBwmF,oBAAoBxhH,EAAQU,EAAKugH,EAAOI,EAAQD,GAGrFzvD,GACDp0D,EAAQpI,KAAKw8D,KAEd,MAGL,GAAGsvD,EAAO,CACR,IAAIQ,EAA0B,eAC1B/gH,GAWF6B,EAAQ,yBACR6+B,EAAc,sBAXX8/E,GACD3+G,EAAQ,uBACR6+B,EAAc,oCACdmM,EAAkB,CAAC,WAAannC,EAAS40B,mBAAmB0mF,uBAAuB1hH,KAAY,MAE/FuC,EAAQ,wBACR6+B,EAAc,8BACdqgF,EAAa,oBAOjB7gF,EAAQt7B,KAAK,CACX05B,QAASyiF,EACTj0E,UAAU,EACVj1C,SAAAA,QAEG,CACLgK,EAAQ,uBACR,MAAMo/G,EAA6B,aAEhC3hH,EAAOkpC,aACRtI,EAAQt7B,KAAK,CACX05B,QAAS2iF,EACTppH,SAAWskC,GAAYtkC,EAASskC,GAAS,GAAQA,EAAQpoC,eAGlD2R,EAASoH,gBAAgBq0B,YAAY7hC,EAAO8hB,aACnDsf,EAAc,0BAEdA,EAAc,kBAEdG,EAAWj8B,KAAK,CACdpS,KAAM,YACN2pC,SAAS,OAIbuE,EAAc,sBAEXphC,IAAW,SACZ4gC,EAAQt7B,KAAK,CACX05B,QAAS2iF,EACTppH,SAAAA,KAGFqoC,EAAQt7B,KAAK,CACX05B,QAAS2iF,EACTppH,SAAWskC,GAAYtkC,EAASskC,GAAUA,EAAQpoC,QAGpD8sC,EAAWj8B,KAAK,CACdpS,KAAM,aACNu6C,SAAU,CAAC,IAAI1hB,GAAU,CAAC/rB,OAAAA,IAASnC,SACnCg/B,SAAS,OAMjB,OAAgB+D,GAEF,IAAID,GAAU,oBAAqB,CAC/C3gC,OAAAA,EACAy9B,aAAcl7B,EACd4+B,mBAAoBC,EACpBE,oBAAqBiM,EACrB3M,QAAAA,EACAW,WAAAA,IAGIoB,Q,gSCnHK,SAASi/E,GAAiB7iE,EAAYxlD,OAAO+4D,gBAC1D,IAAIvT,IAAcA,EAAUslD,WAC1B,OAAO,EAGT,MAAMwd,EAAiB9iE,EAAUwlD,WAAW,GAC5C,OAAIsd,EAAe19E,aAAe09E,EAAeC,aCCpC,SAASC,GAA4B9oF,EAAejkC,EAAgBC,GACjF,OAAO,4DAAkEgkC,GAAO9jC,MAAK,EAAE84B,IAAAA,MACrF,GAAIA,EAIJ,OAAO3K,EAAA,gBAAiC,CAAC7B,MAAOwM,IAC/C94B,MAAW0iC,IAAS,O,EAAA,K,OAAA,E,EAAA,YACnB,MAAMw8C,EAAYvxD,EAAA,sBACZ4U,GAAY,SAAkBuB,GAC9B5jC,QAAkBikC,GAAA,sBAAiC,CACvD3kC,eAAW8I,EACX08B,cAAetC,EACf7iC,MAAOA,MAAAA,EAAAA,EAASq/E,EAAUr/E,MAC1BC,OAAQA,MAAAA,EAAAA,EAAUo/E,EAAUp/E,OAC5BiC,KAAM,MAAQ+2B,EAAIhqB,GAClBlP,UAAU,EACVD,MAAM,EACN4iC,UAAAA,GACC,QAEHriC,EAAUxB,iBAAiB,cAAc,KACvC4jC,GAAkBxJ,EAAK54B,EAAUoB,OAAQihC,GACzCriC,EAAUtB,WACT,CAACkH,MAAM,K,YAjBS,K,oRCRV,MAAM+mH,WAAmCrhF,GAEtDttC,YAAY2M,EAAgB4sB,EAAgB87B,EAA2BiJ,GACrEr+D,MAAM,gCAAiC,CACrC2tC,SAAS,EACTE,mBAAoB,aACpBP,QAAS,CAAC,CACR5B,QAAS,aACTzmC,SAAU,KACJvC,EAAWgmC,YAIf21B,GAAaA,IACbl+D,KAAK2S,SAAS40B,mBAAmBinF,eAAejiH,EAAQ4sB,EAAM87B,EAAQ1yD,EAAW/B,OAAOkB,MAAM2oF,IACxFA,GAEJz+C,GAAS,CACPC,YAAa,0BAKrBjB,MAAM,IAGR,MAAMvmC,EAAMvF,SAASC,cAAc,OAEnC+xE,GAAiB,CACfzsE,IAAAA,EACAmhC,MAAO+oF,GAA2BE,cAClCltH,MAJW,IAKXC,OALW,MAMVE,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQtF,SAAQ,KACpClrB,KAAKkvC,UAGPlvC,KAAK4O,OAAOlP,OAAO2E,GAEnB,MAAM9B,EAAa,IAAI,IAAW,CAChCgX,MAAO,aACPC,UAAW,IACXzL,YAAa,0BAGfxL,EAAWxC,MAAMK,iBAAiB,SAAS,KACzCJ,KAAKmtC,QAAQ,GAAG/iC,QAAQs+B,gBAAgB,YAAanmC,EAAWgmC,cAGlEvoC,KAAK4qC,KAAKlrC,OAAO6C,EAAWrB,YAhDhB,GAAAutH,cAAgB,QCGjB,MAAMC,WAA4BxhF,GAC/CttC,YAAY2M,EAAgB4sB,EAAgB+kC,GAC1Cr+D,MAAM,wBAAyB,CAACmqC,aAAc,2BAA4BmD,QAAS,GAAIvC,MAAM,IAE7FzR,EAAOA,EAAKz4B,QAEZ,MAAMysC,EAA8C,CAClD,CAAC,iBAAkB,yBACnB,CAAC,qBAAsB,6BACvB,CAAC,kBAAmB,+BACpB,CAAC,wBAAyB,gCAC1B,CAAC,kBAAmB,0BACpB,CAAC,4BAA6B,oCAC9B,CAAC,yBAA0B,kCAI7BA,EAAQ//B,SAAS29C,IACf,MAAMlsD,GAAS,OAFC,8BAEiB,CAAqBY,KAAMsrD,EAAE,KAC9D/qD,KAAK4qC,KAAKlrC,OAAOb,MAGnB,MAAM8vH,EAAwBL,GAA4BC,GAA2BE,gBAErF,QAAiBzuH,KAAK4qC,MAAOvqC,IAC3B,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,eACnC8tD,EAAS9nB,GAAQ,EAAA8tB,GAAA,GAAW9zD,IAAS,GAE3CwnH,EAAsBjtH,MAAK,KACzB1B,KAAKs2C,OAEL,IAAIi4E,GAA2BhiH,EAAQ4sB,EAAM87B,EAAQiJ,QAEtD,CAACj1D,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAK4qC,KAAK3nC,MAAMo7G,OAAS,UACzBr+G,KAAK4uH,UAAU3rH,MAAM4rH,UAAY,QAEjC7uH,KAAKkvC,QC5CM,MAAM4/E,WAAuB5hF,GAC1CttC,cACEC,MAAM,kBAAmB,CACvBmqC,aAAc,8BACd0D,mBAAoB,uBACpBG,oBAAqB,EAAC,QAAK,gCAC3BV,QAAS,CAAC,CACR5B,QAAS,KACTunC,UAAU,GACT,CACDvnC,QAAS,2BACTzmC,SAAU,KACRgB,OAAOqJ,KAAK,YAAY,+BAA+B,KAEzD2jE,UAAU,MAId,MAAMhnE,EAAa,IAAI,UAAW9B,GAClC8B,EAAW89C,mBAAqB,KAC9B99C,EAAW5K,UAAU9B,UAAUoE,OAAO,gBAAiBsI,EAAW24C,WAClE34C,EAAW5K,UAAU9B,UAAUoE,OAAO,kBAAmBsI,EAAW0uG,iBAGtEx6G,KAAK2tC,YAAYlP,YAAY3yB,EAAW5K,WAExC4K,EAAW5K,UAAUxB,OAAOM,KAAK2tC,aACjC7hC,EAAW5K,UAAU9B,UAAUC,IAAI,gBAEnCW,KAAKkvC,Q,2SCpBM,MAAM6/E,WAAyB,IAC5CnvH,YACUyN,GAERxN,MAAM,qBAGD,KAAM,CAACu2C,UAAU,EAAMhJ,iBAAiB,EAAMxC,MAAM,IALjD,KAAAv9B,QAAAA,EAORrN,KAAKqP,OAGOA,O,0CACZ,MAAMhC,QAAgBrN,KAAK2S,SAAS40B,mBAAmBusE,sBAAsB9zG,KAAKqN,SAE5E2hH,QAAgChvH,KAAK2S,SAAS40B,mBAAmB0nF,+BAA+B5hH,GAIhG22F,EAAmB,IAAIvC,GACvBkc,EAAU,+BACXtwG,GAAO,CACVJ,IAAK,EACLuD,GAAI,EACJgsC,UAAW,OAAF,sBACP5vC,EAAG,mBACH2d,QAAS,IAENld,EAAQmvC,WAAS,CAEpBhkC,OAAQ,GACRgqF,iBAAkB,OAItBmb,EAAWnhE,UAAUjyB,QAAUozF,EAAWnhE,UAAUjyB,QAAQ5P,KAAKqlF,GACxD,OAAP,wBACKA,GAAa,CAChBxnF,OAAQ,OAIZwrF,EAAiB30F,KAAKsuG,EAAY,SAClC3Z,EAAiBxzE,SACjBwzE,EAAiB5kG,UAAUC,IAAI,aAC/B2kG,EAAiB5kG,UAAUkB,OAAO,oBAElC0jG,EAAiBtkG,OAAOM,KAAKkvH,UAE7BlvH,KAAK4O,OAAOlP,OAAOskG,GAEnB,MAAM9yF,EAAgBpS,SAASC,cAAc,OAC7CmS,EAAc9R,UAAUC,IAAI,kBAC5B6R,EAActJ,QAAQhG,UAAY,OAElC,MAAMutH,EAA8C,IAAIl+G,IAExD,IAAIm+G,GAAkB,EACtB,GAAGzR,EAAWnhE,UAAUjyB,QAAQ5pB,OAAQ,CACtC,MAAMo6C,EAAW/6C,KAAKqvH,mBAAmB,YAAa1R,EAAWnhE,UAAUjyB,QAAQzJ,QAAO,CAACC,EAAK3b,IAAM2b,EAAM3b,EAAE2H,OAAO,IAErHi3F,EAAiBngG,QAAQk3C,GACzB4iE,EAAWnhE,UAAUjyB,QAAQlL,QAAQ07B,EAASilD,eAC9CovB,GAAkB,EAGpB,IAAIE,GAAsB,EAC1B,GAAGN,EACD,IACE,MAAMO,QAAoBvvH,KAAK2S,SAAS40B,mBAAmBioF,2BAA2BniH,EAAQd,OAAQc,EAAQJ,KAC9G,IAAIsiH,EAAY5uH,OACd,KAAM,GAGR,MAAMo6C,EAAW/6C,KAAKqvH,mBAAmB,SAAUE,EAAY5uH,QAE/DqjG,EAAiBngG,QAAQk3C,GACzB4iE,EAAWnhE,UAAUjyB,QAAQlL,QAAQ07B,EAASilD,eAC9CsvB,GAAsB,EACtB,MAAM7hH,IAKVkwG,EAAWnhE,UAAUjyB,QAAQnd,SAAS4yF,IACpC,MAAMl0F,EAAa,IAAI,UAAW9B,GAClC8B,EAAW5K,UAAU9B,UAAUC,IAAI,YAEnC,MAAM8Z,EAAU,IAAIC,GAAe,CACjC45B,UAAU,EACV5D,aAAa,IAGTqgF,EAAW,kBAAiC,CAChDC,WAAY,KAGd,wBAAuCD,GAAU,KAC/CzvH,KAAKs2C,cACJtsC,GAAW,GAAO,GAErBmP,EAAQpK,QAAQrP,OAAO+vH,GACvB3jH,EAAW5K,UAAUxB,OAAOyZ,EAAQjY,WAEpC,MAAMyuH,EAAkD,WAA3B3vB,EAAcjlD,SACrC60E,EAA+C,WAA3B5vB,EAAcjlD,SAKxC,IAAIwyD,EAJD,CAAC,SAAU,aAAanmG,SAAS44F,EAAcjlD,YAChDilD,EAAcjlD,cAAW/wC,GAI3B,MAAMgd,EAAS,IAAI8oB,GAAiB,CAClChkC,WAAAA,EACAmkC,WAAY,IAAW,mCACrB,MAAM3gC,QAAetP,KAAK2S,SAAS40B,mBAAmBsoF,2CAA2CxiH,OAASrD,EAAWg2F,EAAcjlD,SAAUwyD,EAAYoiB,EAAsBC,GA+B/K,OA9BAriB,EAAaj+F,EAAOi+F,iBAEdpqG,QAAQC,IAAIkM,EAAOwgH,SAASn1G,KAAI,EAAOpO,OAAAA,EAAQwuC,SAAAA,KAAc,mCACjE,MAAM,IAAC5/B,GAAO,gBAA+B,CAC3C5O,OAAQA,EACR5B,YAAY,EACZzJ,UAAWuuH,EACXliH,WAAY,GACZ6N,eAAe,EACf5N,WAAW,IAGb,GAAGutC,EAAU,CACX,MAAMi2B,EAAmBlyE,SAASC,cAAc,OAChDiyE,EAAiB5xE,UAAUC,IAAI,8BAG/B,GAAY,CACVm7B,WAH8Bx6B,KAAK2S,SAASwnC,oBAAoB41E,kBAAkBh1E,IAG3DG,YACvB72C,IAAK2sE,EACLzvE,MAAO,GACPC,OAAQ,KAGV2Z,EAAI49B,OAAOr5C,OAAOsxE,IAGpB,EAAApjE,EAAA,GAAeuN,EAAIE,gBAAiB/C,SAA0BtY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,EAAOqO,qBAGrG2yF,OAIZ4hB,EAAQlyG,IAAInR,EAAW5K,UAAW8lB,GAElC9V,EAAcxR,OAAOoM,EAAW5K,cAGlClB,KAAK4qC,KAAKlrC,OAAOwR,GAEjB,MAAM3B,GAAY,EAAAw5D,GAAA,GAAei7B,EAAkB9yF,GAAe,CAACV,EAAIw4D,KACrE,GAAGx4D,IAAQwzF,EAAiB/4F,kBAAoB,EAC9C,OAAO,EAGT,MAAM8vC,EAAWipD,EAAiBl+E,SAAStV,GACrCk4D,EAASn5D,EAAUm5D,UACV,IAAZA,GACAs7B,EAAiBl+E,SAAS4iD,GAA4Bs4B,aAAY,GAGrEjmD,EAASimD,aAAY,GAENmuB,EAAQ39G,IAAIw3D,GACpB7nE,UAIToO,EAAU,GAAG,GAEbvP,KAAKkvC,UAGCmgF,mBAAmBpwH,EAAc8N,GACvC,MAAMguC,EAAW,IAAIglD,GACrBhlD,EAAS1rC,KAAK,SACd0rC,EAASilD,cAAgB,CACvBpzF,EAAG,gBACHG,MAAOA,EACPguC,SAAU97C,GAEZ87C,EAASmlD,qBAAoB,GAC7BnlD,EAAS4lD,gBAET,MAAMqvB,EAAsBlxH,SAASC,cAAc,OAInD,OAHAixH,EAAoB5wH,UAAUC,IAAI,mBAAoB,wBAAyB,SAAWJ,GAC1F87C,EAASl3C,QAAQmsH,GAEVj1E,GC5LX,MACMk1E,GAAsBC,8BAMtBC,IAAqB,GAAAxjG,UASpB,MAAMyjG,GASXxwH,YACU+S,EACA1S,EACRyuB,GAFQ,KAAA/b,SAAAA,EACA,KAAA1S,KAAAA,EA8EF,KAAA6kC,SAAW,KACjB9kC,KAAKqwH,aAAajjH,SAAQ,CAACkjH,EAASjsH,KAClCrE,KAAKuwH,oBAAoBlsH,EAAKisH,OAuI1B,KAAAj8F,YAAeh0B,I,MACrB,MAAMmwH,GAAc,EAAA72F,GAAA,GAAgBt5B,EAAE8G,OAAQ8oH,IAC9C,IAAIO,EACF,OAGF,MAAMF,EAAUtwH,KAAKqwH,aAAa7+G,IAAIg/G,GACtC,IAAIF,EACF,OAIF,KAAkB,QAAd,EAAAA,EAAQG,cAAM,eAAE55F,QAClB,OAGF,MAAMu0D,EAASklC,EAAQzlF,OACnBugD,GAIDA,EAAOv0D,SACRu0D,EAAO9pF,UAAW,EAClB8pF,EAAOlkD,YA3OT,MAAMwpF,EAAiB1wH,KAAK0wH,eAAiB5xH,SAASC,cAAc,OACpE2xH,EAAetxH,UAAUC,IAAI6wH,gCAC7BQ,EAAetxH,UAAUC,IAAI6wH,gCAAuCjwH,GAEpE,MAAM0wH,EAAqB3wH,KAAKkB,UAAYpC,SAASC,cAAc,OACnE4xH,EAAmBvxH,UAAUC,IAnCJ,sBAqCzB,MAAMuxH,EAAsB5wH,KAAK8L,WAAsB,aAAT7L,EAAsB,IAAI,UAAW+J,GAAa,IAAI,UAAYA,GAChH2mH,EAAmBjxH,OAAOkxH,EAAoB1vH,WAC9C0vH,EAAoBhnE,mBAAqB5pD,KAAK8kC,SAC9C8rF,EAAoB56F,eAEpB46F,EAAoB1vH,UAAU9B,UAAUC,IAAI,gBAQ5CW,KAAKqwH,aAAe,IAAIp/G,IACxBjR,KAAK6wH,eAAiB,uBAAyBnrH,KAAKC,MACpDi8B,EAAA,uBAA0C5hC,KAAK6wH,gBAAgB,GAE3D,MACFF,EAAmBvwH,iBAAiB,YAAaJ,KAAKq0B,cAGxD,QAAiBs8F,GAAqBtwH,IACpC,MAAMmwH,GAAc,EAAA72F,GAAA,GAAgBt5B,EAAE8G,OAAQ8oH,IAC9C,IAAIO,EAAa,OAEjB,MAAMF,EAAUtwH,KAAKqwH,aAAa7+G,IAAIg/G,GAClCF,GAEJtwH,KAAK2S,SAASwnC,oBAAoB+5D,aAAal0G,KAAKqN,QAASijH,EAAQv1E,aAGvE21E,EAAehxH,OAAOixH,GAEtB3wH,KAAK0uB,WAAaA,MAAAA,EAAAA,GAAc,UAG3Brf,KAAKhC,GACVrN,KAAKqN,QAAUA,EAEf,MAAMqhB,EAAa1uB,KAAK0uB,WAAWld,MAE7BlC,EAAStP,KAAK2S,SAASwnC,oBAAoB65D,+BAA+B3mG,IAChF,EAAAkzF,GAAA,GAAYjxF,GAASktC,IACnB,IAAI9tB,MAAiB8tB,EAAU77C,OAAQ,OACvC67C,EAAUpvC,SAAS2tC,IACjB/6C,KAAK8wH,eAAe/1E,MAGtB,MAAMg2E,EAAa,KACjB/wH,KAAKkB,UAAU9B,UAAUC,IAAI,eAG5BiQ,aAAkBnM,SACnB,SAAQ4tH,GAERA,OAKC9gH,UACLjQ,KAAK0uB,WAAW4sC,QAChBt7D,KAAK8L,WAAWyqB,kBAChBv2B,KAAKqwH,aAAatlH,QAClB62B,EAAA,uBAA0C5hC,KAAK6wH,gBAAgB,GAC/DjvF,EAAA,mBAAqC,EAAM5hC,KAAK6wH,gBAAgB,GAS1DG,mBACN,OAAO,iCAAyC,GAAAj+B,UAG1C+9B,eAAe/1E,GACrB,MAAMy1E,EAAc1xH,SAASC,cAAc,OAC3CyxH,EAAYpxH,UAAUC,IAAI4wH,IAE1B,MAAMgB,EAAiBnyH,SAASC,cAAc,OAC9CkyH,EAAe7xH,UAAUC,IAAI4wH,GAAsB,UAEnD,MAAMiB,EAAgBpyH,SAASC,cAAc,OAC7C,IAAIoyH,EACJD,EAAc9xH,UAAUC,IAAI4wH,GAAsB,WAE/CjwH,KAAKgxH,qBACNG,EAAgBryH,SAASC,cAAc,OACvCoyH,EAAc/xH,UAAUC,IAAI4wH,GAAsB,UAAW,SAG/D,MAAMK,EAAoC,CACxCa,cAAAA,EACAD,cAAAA,EACAn2E,SAAUA,EAASA,UAErB/6C,KAAKqwH,aAAapzG,IAAIuzG,EAAaF,GAEnC,MAAM5hG,EAAa1uB,KAAK0uB,WAAWld,MAG7BxQ,EA1IY,IAyIC,KAAqB,EAAI,MAGtCpC,EAAU,CACd2C,MAAOP,EACPQ,OAAQR,EACRujC,UAAW,EACXld,YAAY,EACZqd,WAAW,EACXvE,MAAOngC,KAAK6wH,eACZniG,WAAAA,GAGF,GAAI1uB,KAAKgxH,mBASF,CACL,IAAIz/C,GAAU,EACd,GAAY,OAAD,QACT/2C,IAAKugB,EAASq2E,iBACd/sH,IAAK6sH,EACL7uH,MAAM,GACHzD,IACF8C,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQ9uB,MAAM0pF,KAClC,EAAAzmD,GAAA,GAA0BymD,GAE1BklC,EAAQG,OAASrlC,EAEjBA,EAAOhrF,iBAAiB,cAAewkC,IAClCwmD,EAAOvmD,WAAaD,GACrBysF,EAAkB3vH,MAAM4vH,KACtB,EAAA3sF,GAAA,GAA0B2sF,GAC1BJ,EAAc9xH,UAAUC,IAAI,QAC5B8xH,EAAc/xH,UAAUkB,OAAO,QAE5BixE,IACD++C,EAAQzlF,OAASymF,EACjB//C,GAAU,KAEX5zC,GAAA,QAGNA,GAAA,GAEH,MAAM0zF,EAAoB,GAAY,OAAD,QACnC72F,IAAKugB,EAASk5D,iBACd5vG,IAAK8sH,GACFvyH,IACF8C,MAAK,EAAE8uB,OAAAA,KAAYA,IAAQ9uB,MAAM0pF,KAClC,EAAAzmD,GAAA,GAA0BymD,GAEnBvlD,GAAA,oBAA+BulD,MACrCv9E,MAAM8vB,GAAA,eA5CF/+B,EAAQyoB,kBACRzoB,EAAQ8lC,UAEf,GAAY,OAAD,QACTlK,IAAKugB,EAASG,YACd72C,IAAK6sH,GACFtyH,IAyCPqyH,EAAevxH,OAAOwxH,GACtBC,GAAiBF,EAAevxH,OAAOyxH,GACvCX,EAAY9wH,OAAOuxH,GACnBjxH,KAAK8L,WAAWpM,OAAO8wH,GAGjBD,oBAAoBlsH,EAAkBisH,GAG5C,MAAMW,EAAiB5sH,EAAI0kB,kBACrBijG,EAAc3lB,GAAehiG,EAAKrE,KAAK8L,WAAW5K,WACxD,IAAIi1B,EACJ,GAAI61F,EAeG,GAAGA,EAAYllB,SAASngG,MAAQqlH,EAAYllB,SAASxhE,MAAO,CACjE,MAAMzsB,EAAOlW,KAAKoE,IAAIilH,EAAYxlH,KAAKG,KAAOqlH,EAAYxlH,KAAK8+B,OAG/DnP,EAAY,SAFExzB,KAAKC,IAAI,SAAAiW,EAAQ,GAAI,SAjOF04G,GAiO6B,GAAG,GAElC,SAE/Bp7F,EAAY,OArBG,CACf,IAAIm6F,EAAQY,cAAc9xH,UAAUiG,SAAS,UAAYirH,EAAQG,OAC/D,OAGCH,EAAQzlF,QACTylF,EAAQzlF,OAAO9nC,OAGjButH,EAAQG,OAAO1tH,OACfutH,EAAQG,OAAOnvH,UAAW,EAC1BgvH,EAAQY,cAAc9xH,UAAUkB,OAAO,QACvCgwH,EAAQa,cAAc/xH,UAAUC,IAAI,QAEpC82B,EAAY,GAUXg6F,KACDc,EAAehuH,MAAMkzB,UAAYA,I,2SC5NxB,MAAMq7F,GA0BnB5xH,YACUwiC,EACAzvB,GADA,KAAAyvB,KAAAA,EACA,KAAAzvB,SAAAA,EA2CF,KAAA8+G,cAAiBpxH,IACvB,IAAIgnC,EAAqBo9E,EAEzB,IACEA,GAAiB,EAAA9qF,GAAA,GAAgBt5B,EAAE8G,OAAQ,0BAC3CkgC,EAASo9E,EAAiBA,EAAe7gH,eAAgB,EAAA+1B,GAAA,GAAgBt5B,EAAE8G,OAAQ,UACnF,MAAM9G,IAGR,IAAIgnC,GAAUA,EAAOjoC,UAAUiG,SAAS,gBAAiB,OAEzD,IAAI+E,EAAUpK,KAAKoK,QAEnB,IADG/J,aAAao9B,YAAcp9B,EAAEsf,eAAe,oBAAoBtf,EAAUu0B,iBAC1ExqB,GAAWA,EAAQhL,UAAUiG,SAAS,UACvC,OAAO,GAENhF,aAAao9B,YAAcp9B,EAAEsf,eAAe,mBAAkBtf,EAAUoH,cAAe,GAE1F,IAAIwF,GAAOo6B,EAAOz/B,QAAQqF,IACtBA,GAEM,MAAW,mCACnB,MAAMi3F,EAAclkG,KAAKkkG,YAAcj3F,EAAM,EAa7C,GAZAjN,KAAK0xH,aAAe1xH,KAAKoiC,KAAKkpB,UAAUwY,gBAAgBz8B,GACxDrnC,KAAKuM,OAASvM,KAAKoiC,KAAK71B,OAExBvM,KAAKmH,OAAS9G,EAAE8G,OAChBnH,KAAK2xH,gBAAkBxD,KACvBnuH,KAAK4xH,eAAyC,MAAxB5xH,KAAKmH,OAAOE,UACc,WAA7CrH,KAAKmH,OAA6BA,QACnCnH,KAAKmH,OAAO/H,UAAUiG,SAAS,eAEjCrF,KAAK6xH,iBAA2C,MAAxB7xH,KAAKmH,OAAOE,SAAmBrH,KAAKmH,OAAO/H,UAAUiG,SAAS,WAGnFrF,KAAKoiC,KAAKkpB,UAAUC,cAAgBk5D,EAAgB,CACrD,GAAGvgB,EACD,OAGF,MAAM/qE,QAAan5B,KAAKoiC,KAAKmlF,aAAat6G,GAC1C,GAAGksB,EAAKx4B,OAAS,EAAG,CAClB,MAAMmxH,EAAc9xH,KAAKoiC,KAAKkpB,UAAUsU,cAAc5/D,KAAKuM,OAAQU,GACjEA,EACAksB,EAAK/mB,MAAMnF,GAAQjN,KAAKoiC,KAAKkpB,UAAUsU,cAAc5/D,KAAKuM,OAAQU,KACjE6kH,IACD7kH,EAAM6kH,IAKZ9xH,KAAK+xH,eAAiBtN,EAEtB,MAAM/O,GAAc,EAAA/7E,GAAA,GAAgB35B,KAAKmH,OAAQ,gBACjDnH,KAAKgyH,uBAAyBtc,EAE5B11G,KAAKiN,IADJyoG,GACWA,EAAY9tG,QAAQqF,IAErBA,EAGbjN,KAAK2/D,WAAa3/D,KAAKoiC,KAAKkpB,UAAUsU,cAAc5/D,KAAKuM,OAAQvM,KAAKiN,KACtEjN,KAAKqN,cAAgBrN,KAAKoiC,KAAKy/D,WAAW7hG,KAAKiN,KAC/CjN,KAAKiyH,YAAc/tB,WAAuBlkG,KAAK2S,SAAS40B,mBAAmB+/B,WAAWtnE,KAAKqN,UAC3FrN,KAAKkyH,kBAAeloH,EACpBhK,KAAKmyH,wBAAqBnoH,EAE1B,MAAMooH,QAAmBpyH,KAAKqP,OAC9B,IAAI+iH,EACF,OAGFhoH,EAAUgoH,EAAWhoH,QACrB,MAAM,QAAC6F,EAAO,QAAE+4C,EAAO,YAAEqpE,EAAW,cAAEC,EAAa,sBAAEC,GAAyBH,EAC9E,IAAII,GAAyB,EAC7B,GAAGF,EAAe,CAChB,MAAM3zH,EAAY,aAIlB,GAHA6zH,EAAyBF,EAAcpxH,UAAU9B,UAAUiG,SAAS1G,GACjE6zH,GAAwBF,EAAcpxH,UAAU9B,UAAUkB,OAAO3B,GAEvC,eAA1B4zH,EAAwC,CACzC,MAAME,EAAaroH,EAAmF,YAI9FsoH,GADiBD,EADS,GDvKLlB,GCyKa,EAClCoB,EAAwB,IAC9B,GAAGD,EAAkBC,EAAuB,CAC1C,MAAMC,EAAWH,ED5KQlB,IC4KMoB,EAAwBD,GAA8C,EACrGtoH,EAAQnH,MAA2E,SAAI2vH,EAAU,OAMzG,MAAMtuF,EAAyB+C,EAAOjoC,UAAUiG,SAAS,SAAW,OAAS,QAG7EsgE,GAActlE,EAAiBkH,QAAWlH,EAAiBkH,QAAQ,GAAKlH,EAAiB+J,EAASk6B,EAAM+tF,GAErGC,IACDA,EAAc5B,eAAeztH,MAAM4D,IAAMuD,EAAQnH,MAAM4D,IACvDyrH,EAAc5B,eAAeztH,MAAM0D,KAAOyD,EAAQnH,MAAM0D,KACxD2rH,EAAc5B,eAAeztH,MAAMmgD,YAAY,eAAgBh5C,EAAkC,aAA1BmoH,EAAuC,eAAiB,eAAiB,MAChJnoH,EAAQxG,cAAclE,OAAO4yH,EAAc5B,gBACxC8B,GAA6BF,EAAcpxH,UAAUikD,YAG1D,eAAkC/6C,GAAS,KACtCkoH,GACDA,EAAcpxH,UAAU9B,UAAUkB,OAAO,cAG3CN,KAAKiN,IAAM,EACXjN,KAAKuM,YAASvC,EACdhK,KAAKmH,OAAS,KACdnH,KAAKkyH,kBAAeloH,EACpBhK,KAAKmyH,wBAAqBnoH,EAC1BiG,IAEA7J,YAAW,KACT4iD,MACC,QAGFwpE,GACDF,EAAcpxH,UAAU9B,UAAUC,IAAI,kBAI1C+F,IA2aM,KAAAytH,qBAAuB,IAAW,mCACrC7yH,KAAKoiC,KAAKkpB,UAAUC,aACrB,QAAmBvrD,KAAKoiC,KAAKkpB,UAAUsZ,qBAEvC,IAAIlG,GAAa1+D,KAAKuM,aAAcvM,KAAKoiC,KAAKmlF,aAAavnH,KAAKiN,SAI5D,KAAA6lH,aAAe,KACrB9yH,KAAKoiC,KAAKriC,MAAMs5G,iBAAiBr5G,KAAKiN,MAGhC,KAAA8lH,YAAc,KACpB/yH,KAAKoiC,KAAKriC,MAAMizH,mBAAmBhzH,KAAKiN,MAGlC,KAAAgmH,YAAc,IAAW,mCAC/B,GAAG9E,KAAoB,CACrB,MAAMh1F,EAAOn5B,KAAKoiC,KAAKkpB,UAAUC,YAC/B,IAAIvrD,KAAKoiC,KAAKkpB,UAAU4T,aAAa1tD,IAAIxR,KAAKuM,SAAS+uC,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAImkB,IAC1E,CAAC/qD,KAAKiN,KASRs9B,UAP8BpnC,QAAQC,IAAI+1B,EAAKxe,KAAU1N,GAAQ,mCAC/D,MAAMI,QAAiBrN,KAAKoiC,KAAKy/D,WAAW50F,GAC5C,OAAOI,MAAAA,OAAO,EAAPA,EAASA,SAAUA,EAAQA,QAAU,KAAO,UAGnCsW,KAAK,UAIvB7kB,SAASgsC,YAAY,WAKjB,KAAAooF,sBAAwB,KAC9B3oF,GAAqBvqC,KAAKmH,OAA6B+uD,OAGjD,KAAAi9D,gBAAkB,IAAW,mCACnC,IAAIC,EACJ,MAAM,OAAC7mH,EAAM,IAAEU,GAAOjN,KAChB6L,EAAW7L,KAAKoiC,KAAKv2B,SACL,eAAnB7L,KAAKoiC,KAAKniC,OACXmzH,QAAuBpzH,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBvqD,EAAQV,IAGnF,MAAMmgC,QAAiBhsC,KAAK2S,SAAS2/B,gBAAgB2V,gBAAgBmrE,EAAgBA,EAAc9lH,OAASf,GACtG0wG,GAAQ,EAAAv1E,GAAA,GAAmBz6B,GACjC,IACI4C,EADAyW,EAAM,gBAEP0lB,GACD1lB,GAAO0lB,EAAW,KAAOonF,GAAgB,EAAA1rF,GAAA,GAAmB0rF,EAAcp7F,SAASyyF,cAAgBxN,GAChGmW,IAAe9sG,GAAO,YAAc22F,GACvCptG,EAAM,eAENyW,GAAO,KAAO/Z,EAAO8hB,WAAa,IAAM4uF,EACrCmW,IAAe9sG,GAAO,YAAa,EAAAohB,GAAA,GAAmB0rF,EAAcnmH,MACvE4C,EAAM,yBAGR87B,GAAM,YAAY97B,GAAK,IAEvB06B,GAAoBjkB,MAGd,KAAA+sG,WAAa,KACnB,IAAI9F,GAAgBvtH,KAAKuM,OAAQvM,KAAKiN,MAGhC,KAAAqmH,aAAe,KACrB,IAAI/F,GAAgBvtH,KAAKuM,OAAQvM,KAAKiN,KAAK,IAGrC,KAAAsmH,cAAgB,KACtBvzH,KAAK2S,SAAS26C,gBAAgBoG,SAAS1zD,KAAKqN,QAAS,KAG/C,KAAAmmH,WAAa,KACnBxzH,KAAK2S,SAAS26C,gBAAgBmmE,SAASzzH,KAAKqN,UAGtC,KAAA45D,eAAiB,IAAW,mCAClC,GAAGjnE,KAAKoiC,KAAKkpB,UAAUC,aACrB,QAAmBvrD,KAAKoiC,KAAKkpB,UAAU0X,yBAClC,CACL,MAAMz2D,EAASvM,KAAKuM,OACd4sB,EAAOn5B,KAAKgyH,qBAAuB,CAAChyH,KAAKiN,WAAajN,KAAKoiC,KAAKmlF,aAAavnH,KAAKiN,KACxF,IAAI6wD,GAAa,CACf,CAACvxD,GAAS4sB,QAKR,KAAA+tC,cAAgB,KACtBlnE,KAAKoiC,KAAKkpB,UAAUE,iBAAgB,EAAA7xB,GAAA,GAAgB35B,KAAKmH,OAAQ,kBAAmB,EAAAwyB,GAAA,GAAgB35B,KAAKmH,OAAQ,YAG3G,KAAAggE,sBAAwB,KAC9BnnE,KAAKoiC,KAAKkpB,UAAUsT,mBAGd,KAAAwI,cAAgB,IAAW,mCAC9BpnE,KAAKoiC,KAAKkpB,UAAUC,aACrB,QAAmBvrD,KAAKoiC,KAAKkpB,UAAU2X,oBAEvC,IAAIhF,GAAoBj+D,KAAKuM,OAAQvM,KAAKgyH,qBAAuB,CAAChyH,KAAKiN,WAAajN,KAAKoiC,KAAKmlF,aAAavnH,KAAKiN,KAAMjN,KAAKoiC,KAAKniC,SAjsBlID,KAAKiJ,eAAiB,IAAI,IAC1BjJ,KAAK0zH,qBAAuB,IAAI,IAChC1zH,KAAK0uB,YAAa,UAGbq4C,SAAS38D,GACdpK,KAAK0zH,qBAAqB/jH,YAEvB,MACD,QAAiBvF,GAAU/J,IACtBL,KAAKoiC,KAAKkpB,UAAUC,cAIvBvrD,KAAKoiC,KAAKtO,IAAI,WAAYzzB,IAgBbA,EAAE8G,OAAuBwsH,QAdjB,CACnB,QACA,cACA,SACA,YACA,gBACA,iBACA,IACA,wBACA,kBACA,iCACA,eACA,cAEyDhwG,KAAK,UAE9D,EAAAsE,EAAA,GAAY5nB,GAGZL,KAAKyxH,cAAcpxH,OAEpB,CAAC4I,eAAgBjJ,KAAK0zH,uBACpB12D,GAA0B5yD,EAASpK,KAAKyxH,cAAezxH,KAAK0zH,sBAwI9DzjH,UACLjQ,KAAKiJ,eAAe0G,YACpB3P,KAAKsyH,eAAiBtyH,KAAKsyH,cAAcriH,UACzCjQ,KAAK0uB,WAAW4sC,QAGXtS,UACLhpD,KAAKiQ,UACLjQ,KAAK0zH,qBAAqB/jH,YAGdikH,cAAczmF,G,0CAC1B,OAAGntC,KAAKkkG,YACC/2D,EAAQxhB,QAAQ9sB,GACdA,EAAOqlG,cAGT3zD,GAAYpD,GAAetuC,GAAW,mCAC3C,IAAI89D,EAWJ,OARG38D,KAAKoiC,KAAKkpB,UAAUC,cAAgB1sD,EAAOwoE,cAC5C1K,GAAO,GAEA38D,KAAK+xH,cAAgB,KAA5Bp1D,QACQ99D,EAAOsf,YAIRw+C,UAKPk3D,aACN7zH,KAAKmtC,QAAU,CAAC,CACdluC,KAAM,QACNQ,KAAM,sBACNuoB,QAAShoB,KAAK6yH,qBACd10G,OAAQ,IAAyB,cAAnBne,KAAKoiC,KAAKniC,OAAyBD,KAAKqN,QAAQmL,OAAOqiB,aACpE,CACD57B,KAAM,QACNQ,KAAM,oCACNuoB,QAAShoB,KAAK6yH,qBACd10G,OAAQ,IAAyB,cAAnBne,KAAKoiC,KAAKniC,MAAwBD,KAAK2/D,aAAe3/D,KAAKoiC,KAAKkpB,UAAUsZ,oBAAoBkvD,aAAa,YACzHC,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,WACNQ,KAAM,0BACNuoB,QAAS,KACPhoB,KAAKoiC,KAAKriC,MAAMi0H,iBAAgB,MAC9B,EAAArvF,GAAA,GAA4B3kC,KAAKqN,SACjCrN,KAAK2S,SAAS40B,mBAAmB0sF,YAAYj0H,KAAKqN,QAASrN,KAAKqN,QAAQA,QAAS,CAC/E6mH,aAAcl0H,KAAKoiC,KAAKriC,MAAMm0H,aAC9BjhE,SAAUjzD,KAAKqN,QAAQ4lD,WAGzBjzD,KAAKoiC,KAAKriC,MAAMo0H,eAAc,GAAO,KACpC,IAAIzuH,KAAyB,IAApB1F,KAAKqN,QAAQ8F,QAE3BgL,OAAQ,IAAyB,cAAnBne,KAAKoiC,KAAKniC,MACvB,CACDhB,KAAM,QACNQ,KAAM,QACNuoB,QAAShoB,KAAK8yH,aACd30G,OAAQ,IAAW,gDAAMne,KAAKoiC,KAAK+2E,aAChCn5G,KAAKqN,QAAQmL,OAAOqiB,eACnB76B,KAAKoiC,KAAKriC,MAAMq+G,cACC,cAAnBp+G,KAAKoiC,KAAKniC,SAEX,CACDhB,KAAM,OACNQ,KAAM,OACNuoB,QAAShoB,KAAK+yH,YACd50G,OAAQ,IAAW,gDAAOne,KAAK2S,SAAS40B,mBAAmB6sF,eAAep0H,KAAKqN,QAAS,YAAcrN,KAAKoiC,KAAKriC,MAAMq+G,iBACrH,CACDn/G,KAAM,OACNQ,KAAM,OACNuoB,QAAShoB,KAAKizH,YACd90G,OAAQ,MAAOne,KAAKiyH,aAAiBjyH,KAAKqN,QAA4BA,SAAYrN,KAAK2xH,gBAAoB3xH,KAAK4xH,gBAAmB5xH,KAAKqN,QAA4BA,UAAYrN,KAAKmH,OAAO83B,YAC3L,CACDhgC,KAAM,OACNQ,KAAM,wBACNuoB,QAAShoB,KAAKizH,YACd90G,OAAQ,KAAOne,KAAKiyH,cAAiBjyH,KAAKqN,QAA4BA,SAAWrN,KAAK2xH,gBACrF,CACD1yH,KAAM,OACNQ,KAAM,iCACNuoB,QAAShoB,KAAKizH,YACd90G,OAAQ,IAAW,mCACjB,IAAIne,KAAK2/D,YAAc3/D,KAAKiyH,WAC1B,OAAO,EAGT,IAAI,MAAO1lH,EAAQ4sB,KAASn5B,KAAKoiC,KAAKkpB,UAAU4T,aAAc,CAC5D,MAAM9H,EAAiC,GAAG7qD,KAA6B,cAAnBvM,KAAKoiC,KAAKniC,KAAuB,YAAc,YACnG,IAAI,MAAMgN,KAAOksB,EAEf,UADuBn5B,KAAK2S,SAAS40B,mBAAmB8sF,sBAAsBj9D,EAAYnqD,IAC7EI,QACX,OAAO,EAKb,OAAO,KAET0mH,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,WACNuoB,QAAShoB,KAAKkzH,sBACd/0G,OAAQ,IAAMne,KAAK4xH,eACnBvqD,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,6BACNuoB,QAAS,KACPuiB,GAAoBvqC,KAAKmH,OAAO7C,YAElC6Z,OAAQ,IAAMne,KAAK6xH,iBACnBxqD,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,4BACNuoB,QAAS,KACPuiB,GAAoBvqC,KAAKmH,OAAO7C,YAElC6Z,OAAQ,IAAMne,KAAKmH,OAAO/H,UAAUiG,SAAS,kBAC7CgiE,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,kCACNuoB,QAAShoB,KAAKmzH,gBACdh1G,OAAQ,IAAW,gDAAMne,KAAK2S,SAAS2/B,gBAAgB6G,UAAUn5C,KAAKuM,WAAYvM,KAAKqN,QAAQmL,OAAOqiB,gBACrG,CACD57B,KAAM,MACNQ,KAAM,sBACNuoB,QAAShoB,KAAKqzH,WACdl1G,OAAQ,IAAW,0CAACne,KAAKqN,QAAQmL,OAAOqiB,aACnB,mBAAnB76B,KAAKqN,QAAQT,IACZ5M,KAAKqN,QAAQmL,OAAOosF,eACf5kG,KAAK2S,SAAS2/B,gBAAgBo7E,cAAc1tH,KAAKuM,UACpC,cAAnBvM,KAAKoiC,KAAKniC,SACX,CACDhB,KAAM,QACNQ,KAAM,wBACNuoB,QAAShoB,KAAKszH,aACdn1G,OAAQ,IAAW,0CAACne,KAAKqN,QAA4BmL,OAAOosF,eAAgB5kG,KAAK2S,SAAS2/B,gBAAgBo7E,cAAc1tH,KAAKuM,aAC5H,CACDtN,KAAM,WACNQ,KAAM,+BACNuoB,QAAS,KACP6H,EAAA,iBAAkC,CAAC7B,MAAQhuB,KAAKqN,QAAgB2gB,MAAMlvB,YAExEqf,OAAQ,K,MACN,GAAGne,KAAKqN,QAAQmL,OAAOqiB,YACrB,OAAO,EAGT,MAAML,EAAgG,QAA7E,EAACx6B,KAAKqN,QAA4B2gB,aAA2C,eAAElvB,SACxG,IAAI07B,EAAK,OAAO,EAEhB,IAAI85F,IAAc,KAClB,MAAMC,GAAc/5F,EAAIv6B,OAAU,CAAC,MAAO,QAAS,WAAoCmH,SAASozB,EAAIv6B,MAEpG,OADGs0H,IAAYD,EAAYA,MAAe,EAAA36F,GAAA,GAAgB35B,KAAKmH,OAAQ,gBAAiB,EAAAwyB,GAAA,GAAgB35B,KAAKmH,OAAQ,UAC9GotH,GAAcD,IAEtB,CACDr1H,KAAM,eACNQ,KAAM,mBACNuoB,QAAShoB,KAAKuzH,cACdp1G,OAAQ,K,MACN,MAAMkvC,EAAkC,QAA1B,EAAArtD,KAAKqN,QAAgB2gB,aAAK,eAAEq/B,KAC1C,OAAOA,GAAQA,EAAKuC,cAAcjvD,SAAW0sD,EAAK70C,OAAOk3C,SAAWrC,EAAK70C,OAAOg1C,OAGjF,CACDvuD,KAAM,OACNQ,KAAM,iBACNuoB,QAAShoB,KAAKwzH,WACdr1G,OAAQ,IAAW,mC,MACjB,MAAMkvC,EAAkC,QAA1B,EAAArtD,KAAKqN,QAAgB2gB,aAAK,eAAEq/B,KAC1C,aAAartD,KAAK2S,SAAS40B,mBAAmB6sF,eAAep0H,KAAKqN,QAAS,UAAWggD,IAASA,EAAK70C,OAAOk3C,SAAW1vD,KAAKqN,QAAQmL,OAAOqiB,gBAG3I,CACD57B,KAAM,UACNQ,KAAM,UACNuoB,QAAShoB,KAAKinE,eACd9oD,OAAQ,MAAOne,KAAKiyH,YAAiC,cAAnBjyH,KAAKoiC,KAAKniC,MAA0BD,KAAKqN,QAAQmL,OAAOqiB,aAAe76B,KAAKqN,QAAQC,SAAW,OAAuC,mBAAnBtN,KAAKqN,QAAQT,IACjK,CACD3N,KAAM,UACNQ,KAAM,oCACNuoB,QAAShoB,KAAKinE,eACd9oD,OAAQ,IAAMne,KAAKoiC,KAAKkpB,UAAU0X,qBAChChjE,KAAK2/D,aACJ3/D,KAAKoiC,KAAKkpB,UAAU0X,oBAAoB8wD,aAAa,YACxDC,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,aACNuoB,QAAS,KACP,IAAI0mG,GAAoB1uH,KAAKuM,OAAQ,CAACvM,KAAKiN,OAE7CkR,OAAQ,IAAW,0CAACne,KAAKqN,QAAQmL,OAAO4F,KAA0B,YAAnBpe,KAAKqN,QAAQT,IAAoB5M,KAAKqN,QAAQmL,OAAOqiB,oBAAqB76B,KAAK2S,SAAS2/B,gBAAgB6G,UAAUn5C,KAAKuM,YACtKwnH,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,SACNQ,KAAM,yBACNuoB,QAAShoB,KAAKknE,cACd/oD,OAAQ,KAAQne,KAAKqN,QAAmC22C,SAAWhkD,KAAK2/D,YAAc3/D,KAAK0xH,aAC3FqC,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,SACNQ,KAAM,kCACNuoB,QAAShoB,KAAKmnE,sBACdhpD,OAAQ,IAAMne,KAAK2/D,WACnBo0D,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDr/C,QAAS,KACP,GAAGhoB,KAAKkyH,aACNlyH,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQvM,KAAKkyH,mBAEV,KAAGlyH,KAAKmyH,mBAGb,OAAO,EAFP,IAAIpD,GAAiB/uH,KAAKqN,WAK9B8Q,OAAQ,IAAW,kDAACne,KAAKuM,OAAO46B,cAA4E,QAA7D,EAA2C,QAA3C,EAACnnC,KAAKqN,QAA4BmvC,iBAAS,eAAEgmD,wBAAgB,eAAE7hG,gBAAgBX,KAAK2S,SAAS40B,mBAAmB0nF,+BAA+BjvH,KAAKqN,cACnM0mH,UAAW,KAAM,GAChB,CACD90H,KAAM,gBACNQ,KAAM,SACNuoB,QAAShoB,KAAKonE,cACdjpD,OAAQ,IAAW,GAAAne,UAAA,6BAAAA,KAAK2S,SAAS40B,mBAAmBggC,iBAAiBvnE,KAAKqN,aACzE,CACDpO,KAAM,gBACNQ,KAAM,mCACNuoB,QAAShoB,KAAKonE,cACdjpD,OAAQ,IAAMne,KAAK2/D,aAAe3/D,KAAKoiC,KAAKkpB,UAAU2X,mBAAmB6wD,aAAa,YACtFC,UAAW,KAAM,EACjB1sD,eAAe,GACd,CACDpoE,KAAM,OACNQ,KAAM,8BACNuoB,QAAS,KACP,IAAI8mG,IAEN3wG,OAAQ,KAAM,EACd+lF,aAAa,IAIH70F,O,0CACZrP,KAAKiQ,UACLjQ,KAAK6zH,aAEL,MAAMn+B,QAAwB11F,KAAK4zH,cAAc5zH,KAAKmtC,SACtD,IAAIuoD,EAAgB/0F,OAClB,OAGF,MAAMyJ,EAAUpK,KAAKoK,QAAU,GAAWsrF,EAAiB11F,KAAKiJ,gBAChEmB,EAAQoG,GAAK,qBACbpG,EAAQhL,UAAUC,IAAI,eAEtB,MAAMm1H,EAAc9+B,EAAgBtjF,MAAMvT,IAAYA,EAAOI,OAC7D,GAAGu1H,EAAa,CACd,MAAMh4E,EAAax8C,KAAKqN,QAA4BmvC,UAC9CskD,EAAkBtkD,MAAAA,OAAS,EAATA,EAAWgmD,iBAC7BiyB,KAAuB3zB,MAAAA,OAAe,EAAfA,EAAiBngG,QACxC+zH,SAA0B10H,KAAK2S,SAAS40B,mBAAmB0nF,+BAA+BjvH,KAAKqN,iBAAmBrN,KAAK2S,SAAS2/B,gBAAgBC,QAAQvyC,KAAKuM,SAAyBskC,wBAAqB7mC,EAC3M2qH,EAAgBn4E,EAAYA,EAAUjyB,QAAQzJ,QAAO,CAACC,EAAK3b,IAAM2b,EAAM3b,EAAE2H,OAAO,QAAK/C,EAE3FwqH,EAAYpqH,QAAQhL,UAAUC,IAAI,UAAYo1H,EAAqB,YAAc,WACjF,MAAMG,EAAW,IAAI,iBAAiB,CACpC/kH,IAAK4kH,OACmBzqH,IAAtB0qH,EAAkC,2BAA6B,uBAC7D,eACJtlH,KAAMqlH,OACkBzqH,IAAtB0qH,EAAkC,CAACC,GAAiB,CAACD,EAAmBA,QACtE1qH,EACJI,QAASoqH,EAAY92D,cAGvB,IAAIm3D,EAGAA,EAFDJ,OACwBzqH,IAAtB0qH,GACU,QAAK,2BAA4B,CAACC,KAElC,QACT7zB,EAAgBngG,SAAW+zH,EAAoB,2BAA6B,uBAC5E,CAAC5zB,EAAgBngG,OAAQ+zH,KAIlB,QAAK,WAGlBG,EAASz1H,UAAUC,IAAI,2BACvBm1H,EAAYpqH,QAAQ1K,OAAOm1H,GAE3B,MAAMC,EAAc,GACdC,EAAc,EACdC,EAAqB,MAC3BJ,EAASxqH,QAAQnH,MAAMgyH,WAAa,SACpCL,EAASxqH,QAAQnH,MAAMmjE,aAAequD,EAAqBO,EAAqBryH,KAAKC,IAAImyH,EAAaj0B,EAAgBngG,QAAU,MAAQ,OACxI,MAAM+tB,EAAa1uB,KAAK0uB,WAAWld,MACnCxR,KAAK2S,SAAS40B,mBAAmBsoF,2CAA2C7vH,KAAKqN,SAA4B3L,MAAM4N,IACjH,IAAIof,IACF,OAGCmmG,GACDA,EAASv0H,SAGX,MAAMk8C,EAAYltC,EAAOwgH,SACnB6E,OAAsC3qH,IAAtB0qH,EACpBplH,EAAO4lH,eAELT,EACEj4E,EAAU7wB,QAAQovB,GAAaA,EAASA,WAAUp6C,OAClD67C,EAAU77C,OAGhB,IAAIw0H,EACJ,GAAwB,IAArB34E,EAAU77C,OACXw0H,EAAW,IAAI78F,GAAU,CACvB/rB,OAAQiwC,EAAU,GAAGjwC,OACrBgsB,eAAe,EACfC,QAAQ,IACPpuB,UAECqqH,GAAsBnlH,EAAO8lH,iBAAiBz0H,QAAU,KAC1DX,KAAKkyH,aAAe11E,EAAU,GAAGjwC,aAE9B,GAAGkoH,EAAoB,CAC5B,MAAMY,EAASV,IAAkBn4E,EAAU77C,aAAgCqJ,IAAtB0qH,EACrDS,GAAW,QACTE,EAAS,2BAA6B,uBACtCA,EAAS,CAACV,GAAiB,CAACA,EAAen4E,EAAU77C,cAGnD67C,EAAU77C,OAGZw0H,GAAW,QAAK,cAAe,CAAC34E,EAAU77C,SAF1Ci0H,EAASxqH,QAAQnH,MAAMgyH,WAAa,GAYxC,GANGE,IACDA,EAASlyH,MAAMmjE,aAAe4uD,EAAqBryH,KAAKC,IAAImyH,EAAaJ,GAAiB,MAC1FQ,EAAS/1H,UAAUC,IAAI,2BACvBm1H,EAAYpqH,QAAQ1K,OAAOy1H,IAG1B34E,EAAU77C,OAAQ,CACnB,MAAMkjD,EAAU,IAAIiL,GAAe,CAACvhD,WAAYunH,IAChDjxE,EAAQrzB,OAAOswE,EAAkBA,EAAgBnmF,KAAKvV,IAAM,EAAA0zC,GAAA,GAAU1zC,EAAE27F,WAAYvkD,EAAU7hC,KAAKogC,GAAaA,EAASxuC,UACzHioH,EAAYpqH,QAAQ1K,OAAOmkD,EAAQ3iD,WAIjClB,KAAKmyH,oBAAqB,MAMlC,IAAIE,EACAC,EACAC,EACJ,GAAsB,YAAnBvyH,KAAKqN,QAAQT,IAAoB5M,KAAKoiC,KAAKkpB,UAAUC,cAAgBvrD,KAAKqN,QAAQmL,OAAOqiB,cAAgB76B,KAAKqN,QAAQmL,OAAOknB,aAAc,CAC5I6yF,EAAyB,GAAAr1D,UAAY,KAAqC,aAAe,WACzFo1D,EAAgBtyH,KAAKsyH,cAAgB,IAAIlC,GAAkBpwH,KAAK2S,SAAU4/G,EAAuBvyH,KAAK0uB,YACtG4jG,EAAcjjH,WAAWrP,KAAK2S,SAAS40B,mBAAmBusE,sBAAsB9zG,KAAKqN,UAGrF,MAEMioH,EAAYt0H,GACZslE,EAAc,EAAGF,EAAe,EAEpCisD,EAD2B,aAA1BE,EACa,CACZ1rH,IAAKy/D,EAEL3/D,KAAM2uH,GAGM,CACZzuH,IAAKyuH,EACLhwF,MAAO8gC,EACPz/D,KAAM2/D,GAOZ,OAFAtmE,KAAKoiC,KAAKlhC,UAAUxB,OAAO0K,GAEpB,CACLA,QAAAA,EACA6F,QAAS,KACPjQ,KAAKiQ,UACLqiH,GAAiBA,EAAcriH,WAEjC+4C,QAAS,KACP5+C,EAAQ9J,SACRgyH,GAAiBA,EAAc5B,eAAepwH,UAEhD+xH,YAAAA,EACAC,cAAAA,EACAC,sBAAAA,O,qCC9oBS,MAAMgD,GAKnB31H,YAAYhB,GAQVoB,KAAKw1H,gBAAkB,CAAC,CACtBv2H,KAAM,OACNQ,KAAM,yBACNuoB,QAASppB,EAAQ62H,cACjBt3G,OAAQ,IAAoB,aAAdne,KAAKC,MAClB,CACDhB,KAAM,WACNQ,KAAM,6BACNuoB,QAASppB,EAAQ82H,gBACjBv3G,OAAQ,IAAoB,aAAdne,KAAKC,MAClB,CACDhB,KAAM,WACNQ,KAAM,wBACNuoB,QAASppB,EAAQ82H,gBACjBv3G,OAAQ,IAAoB,aAAdne,KAAKC,OAGrBD,KAAK21H,SAAW,GAAW31H,KAAKw1H,gBAAiB52H,EAAQqK,gBACzDjJ,KAAK21H,SAASv2H,UAAUC,IAAI,YAAaT,EAAQg3H,UAEjD54D,GAA0Bp+D,EAAQi3H,kBAAmBx1H,IAChDzB,EAAQ6S,SAAW7S,EAAQ6S,WAI9BzR,KAAKw1H,gBAAgBpoH,SAASvO,IAC5BA,EAAOuL,QAAQhL,UAAUoE,OAAO,QAAS3E,EAAOsf,cAGlD,EAAA8J,EAAA,GAAY5nB,GACZ,eAAkCL,KAAK21H,aACtC/2H,EAAQqK,gBAGN6sH,UAAUvpH,GACfvM,KAAKC,KAAOsM,IAAW,SAAiB,WAAa,Y,iUCnC1C,MAAMwpH,WAAwB,IAc3Cn2H,YAAoBwiC,GAClBviC,MAAM,oCAAqC,KAAM,CAACu2C,UAAU,EAAMg8C,YAAa,SAAUxnD,MAAM,IAD7E,KAAAxI,KAAAA,EAVZ,KAAA3a,OAAS,EAsKT,KAAAuuG,cAAgB,KACtBh2H,KAAKi2H,QAwGP,KAAA/nH,QAAW7N,IACT,MAAM8G,EAAS9G,EAAE8G,OAEX+uH,GAAa,EAAAz9E,GAAA,GAAUtxC,EAAQ,SAC/BgvH,GAAU,EAAAC,GAAA,GAAajvH,GACzBgvH,IACFhvH,EAAOvD,cAAcxE,UAAUC,IAAI,aACnC62H,EAAW92H,UAAUkB,OAAO,iBAC5B41H,EAAWntG,kBAAkBpkB,gBAAgB,cAG/BuxH,EAAWhoF,qBACbioF,GAAWn2H,KAAKq2H,UAAUprH,kBAAoB,IAC1DjL,KAAKs2H,kBAGPt2H,KAAKyoC,gBAGP,KAAA2+B,cAAiB/mE,IACf,MAAM8G,EAAS9G,EAAE8G,OACXoS,GAAQ,EAAAk/B,GAAA,GAAUtxC,EAAQ,SAC1BkX,GAAM,EAAA48C,GAAA,GAAW1hD,GAEpBvZ,KAAKu2H,gBAAkBv2H,KAAKu2H,eAAe,GAAG,KAAOl4G,IACtDre,KAAKu2H,oBAAiBvsH,GAGxBuP,EAAMjZ,SACNN,KAAKw2H,kBAAkBj4G,OAAOF,EAAK,GAEnCre,KAAKw2H,kBAAkBppH,SAAQ,CAAC7K,EAAY8b,KAC1C9b,EAAW3D,QAAQ63H,aAAa91H,OAAS,EACzC4B,EAAW3D,QAAQ63H,aAAa5kH,KAAKwM,EAAM,GACvB,iBAAiB9b,EAAWgX,MAAMwP,mBAC1CsP,YAGdr4B,KAAKyoC,gBAzSLzoC,KAAKyoB,YAGOA,Y,0CAgBZ,IAfA,QAAMzoB,KAAK8O,MAAO,WAElB9O,KAAK02H,mBAAqB,IAAI,IAAW,CACvC3oH,YAAa,eACbwL,MAAO,eACP9V,KAAM,WACN+V,UA9BsB,MAiCxBxZ,KAAKiJ,eAAe5J,IAAIW,KAAK02H,mBAAmB32H,MAAhDC,CAAuD,SAAS,KAC9DA,KAAKyoC,kBAGPzoC,KAAKw2H,kBAAoB,GAEH,cAAnBx2H,KAAKoiC,KAAKniC,KAAsB,CACjC,MAAM01H,EAAW,IAAI,GAAgB,CACnCF,cAAe,KACbz1H,KAAKoiC,KAAKriC,MAAM42H,YAAa,EAC7B32H,KAAKi2H,QAEPP,gBAAiB,KACf11H,KAAKoiC,KAAKriC,MAAMi0H,iBAAgB,KAC9Bh0H,KAAKi2H,WAGTL,SAAU,cACVC,iBAAkB71H,KAAKqyF,aAGzBsjC,EAASG,UAAU91H,KAAKoiC,KAAK71B,QAE7BvM,KAAK4O,OAAOlP,OAAOi2H,EAASA,UAG9B31H,KAAK4O,OAAOlP,OAAOM,KAAK02H,mBAAmBx1H,WAE3C,MAAM2sD,EAAK/uD,SAASC,cAAc,MAC5BqU,EAAItU,SAASC,cAAc,OACjCqU,EAAEhU,UAAUC,IAAI,YAChB,QAAM+T,EAAG,eAETpT,KAAKq2H,UAAYv3H,SAASC,cAAc,QACxCiB,KAAKq2H,UAAUj3H,UAAUC,IAAI,yBAE7B,MAAMu3H,EAAK93H,SAASC,cAAc,OAClC63H,EAAGx3H,UAAUC,IAAI,wBAEjB,MAAMw3H,EAAkB/3H,SAASC,cAAc,OAC/C83H,EAAgBz3H,UAAUC,IAAI,YAC9B,QAAMw3H,EAAiB,mBAEZ72H,KAAKoiC,KAAKzvB,SAAS2/B,gBAAgBlE,YAAYpuC,KAAKoiC,KAAK71B,WAClEvM,KAAK82H,uBAAyB,IAAI,KAAc,CAC9Cr3H,KAAM,oBACNgE,KAAM,cAERzD,KAAK82H,uBAAuB/2H,MAAMqpC,SAAU,EAC5CwtF,EAAGl3H,OAAOM,KAAK82H,uBAAuBv9G,QAGxCvZ,KAAK+2H,sBAAwB,IAAI,KAAc,CAC7Ct3H,KAAM,yBACNgE,KAAM,aAERzD,KAAKg3H,kBAAoB,IAAI,KAAc,CACzCv3H,KAAM,eACNgE,KAAM,SAGRzD,KAAKiJ,eAAe5J,IAAIW,KAAK+2H,sBAAsBh3H,MAAnDC,CAA0D,UAAU,KAClE,MAAMopC,EAAUppC,KAAK+2H,sBAAsBh3H,MAAMqpC,QACjDppC,KAAKg3H,kBAAkBj3H,MAAM2oC,gBAAgB,WAAYU,MAG3DppC,KAAKiJ,eAAe5J,IAAIW,KAAKg3H,kBAAkBj3H,MAA/CC,CAAsD,UAAU,KAC9D,MAAMopC,EAAUppC,KAAKg3H,kBAAkBj3H,MAAMqpC,QAE5Ch4B,MAAMC,KAAKrR,KAAKq2H,UAAUvwG,UAA4BnL,KAAKpJ,IAC1DA,EAAGnS,UAAUoE,OAAO,cAAe4lC,MAGjCA,IACFppC,KAAKu2H,oBAAiBvsH,EACtBhK,KAAKi3H,kBAAkBr2H,iBAAiB,KAG1Cs2H,EAAa9pH,SAASmE,GAAOA,EAAGnS,UAAUoE,OAAO,QAAS4lC,KAE1DppC,KAAK+2H,sBAAsBh3H,MAAM2oC,gBAAgB,WAAYU,GAC7DppC,KAAKyoC,kBAGPmuF,EAAGl3H,OAAOM,KAAK+2H,sBAAsBx9G,MAAOvZ,KAAKg3H,kBAAkBz9G,OAEnE,MAAM29G,EAA8B,GAE9BC,EAAsBr4H,SAASC,cAAc,OACnDo4H,EAAoB/3H,UAAUC,IAAI,YAClC,QAAM83H,EAAqB,2BAE3B,MAAMC,EAASt4H,SAASC,cAAc,MAEhCs4H,EAAwBv4H,SAASC,cAAc,OACrDs4H,EAAsBj4H,UAAUC,IAAI,yBAEpCW,KAAKi3H,kBAAoB,IAAI,IAAW,CACtClpH,YAAa,kCACbwL,MAAO,kCACP9V,KAAM,WACN+V,UApIsB,MAuIxBxZ,KAAKiJ,eAAe5J,IAAIW,KAAK02H,mBAAmB32H,MAAhDC,CAAuD,SAAS,KAC9DA,KAAKyoC,kBAGP,MAAM6uF,EAAuBx4H,SAASC,cAAc,OACpDu4H,EAAqBl4H,UAAUC,IAAI,aACnC,QAAMi4H,EAAsB,wBAE5BD,EAAsB33H,OAAOM,KAAKi3H,kBAAkB/1H,UAAWo2H,GAE/DJ,EAAarlH,KAAKulH,EAAQD,EAAqBE,GAC/CH,EAAa9pH,SAASmE,GAAOA,EAAGnS,UAAUC,IAAI,UAE9CW,KAAK4qC,KAAKhnC,cAAcE,aAAa+pD,EAAI7tD,KAAK4qC,MAC9C5qC,KAAK4qC,KAAKlrC,OAAO0T,EAAGpT,KAAKq2H,UAAWv3H,SAASC,cAAc,MAAO83H,EAAiBD,KAAOM,IAE1F,QAAiBl3H,KAAKqyF,WAAYryF,KAAKg2H,cAAe,CAAC/sH,eAAgBjJ,KAAKiJ,iBAE5EjJ,KAAK8L,WAAa,IAAI,KAAW9L,KAAK4qC,MACtC5qC,KAAKs2H,kBAELt2H,KAAKu3H,SAAW,KACNv3H,KAAKw3H,mBAAmB72H,OAGlCX,KAAKyoC,kBAGC+uF,mBAMN,OALgBpmH,MAAMC,KAAKrR,KAAKq2H,UAAUvwG,UAAUnL,KAAI,CAACpJ,EAAI8M,KAC3D,MAAMte,EAAQwR,EAAGrM,cAAc,sBAC/B,OAAOnF,aAAiB03H,iBAAmB13H,EAAMS,OAAQ,EAAAk3H,GAAA,GAAa33H,GAAO,GAAOS,SACnFmrB,QAAQkb,KAAQA,EAAEv6B,SASfkmF,W,MACN,MAAM/kC,EAAWztD,KAAK02H,mBAAmBl2H,MACzC,IAAIitD,EACF,OAAO,EAGT,GAAGA,EAAS9sD,OAxLY,IAyLtB,OAAO,EAGT,GAAGX,KAAKg3H,kBAAkBj3H,MAAMqpC,WAA+B,QAAnB,EAAAppC,KAAKu2H,sBAAc,eAAE51H,QAC/D,OAAO,EAGT,MAAMotD,EAAU/tD,KAAKw3H,mBACrB,GAAGzpE,EAAQptD,OAAS,EAClB,OAAO,EAIT,GADsBotD,EAAQ37C,MAAMw0B,GAAMA,EAAEjmC,OApMtB,MAsMpB,OAAO,EAGT,MAAOH,MAAOm3H,IAAgB,EAAAD,GAAA,GAAa13H,KAAKi3H,kBAAkBl3H,OAAO,GACzE,QAAG43H,EAAah3H,OAzMQ,KAgNlB8nC,eACN,MAAMo1C,EAAQ79E,KAAKwyF,WACnBxyF,KAAKqyF,WAAW3pD,gBAAgB,YAAam1C,GAGlCo4C,KAAK2B,GAAQ,G,0CACxB,MAAMnqE,EAAWztD,KAAK02H,mBAAmBl2H,MAEnCutD,EAAU/tD,KAAKw3H,oBAEdh3H,MAAOm3H,EAAc1kE,SAAU4kE,IAAwB,EAAAH,GAAA,GAAa13H,KAAKi3H,kBAAkBl3H,OAElG,GAAsB,cAAnBC,KAAKoiC,KAAKniC,OAAyB23H,EAKpC,YAJA53H,KAAKoiC,KAAKriC,MAAMi0H,iBAAgB,KAC9Bh0H,KAAKi2H,MAAK,MAMdj2H,KAAKs2C,OAKL,MAAM99B,EAAyB,GAE5BxY,KAAK82H,yBAA2B92H,KAAK82H,uBAAuB/2H,MAAMqpC,UACnE5wB,EAAOy4C,eAAgB,GAGtBjxD,KAAK+2H,sBAAsBh3H,MAAMqpC,UAClC5wB,EAAO04C,iBAAkB,GAGxBlxD,KAAKg3H,kBAAkBj3H,MAAMqpC,UAC9B5wB,EAAOg1C,MAAO,GAGhB,MAAMH,EAAa,CACjBzgD,EAAG,OACH4L,OAAAA,EACAi1C,SAAAA,EACAM,QAASA,EAAQpzC,KAAI,CAACna,EAAO6d,KACpB,CACLzR,EAAG,aACHnN,KAAMe,EACN6tD,OAAQ,IAAI3hC,WAAW,CAACrO,QAG5B7N,QAAIxG,GAIA8tH,QAAuB93H,KAAKoiC,KAAKzvB,SAAS26C,gBAAgByqE,kBAAkB1qE,EAAMrtD,KAAKu2H,eAAgBoB,EAAcE,GAI3H73H,KAAKoiC,KAAKzvB,SAAS40B,mBAAmBywF,UAAUh4H,KAAKoiC,KAAK71B,OAAQurH,EAAgB,OAAF,UAC3E93H,KAAKoiC,KAAK61F,4BAGmB,UAA/Bj4H,KAAKoiC,KAAKriC,MAAMm4H,YACjBl4H,KAAKoiC,KAAKriC,MAAMo4H,cAGlBn4H,KAAKoiC,KAAKriC,MAAMo0H,eAAc,GAAO,MA4C/BmC,kBACN,MAAM7uG,EAASznB,KAAKynB,SACdpJ,EAAMre,KAAKq2H,UAAUprH,kBAAoB,EACzCmtH,EAAgB,IAAI,IAAW,CACnCrqH,YAAa,2BACbwL,MAAO,sBACPk9G,aAAc,CAACp4G,GACf5a,KAAM,YAAcgkB,EACpBjO,UAvUoB,MAyUtBxZ,KAAKiJ,eAAe5J,IAAI+4H,EAAcr4H,MAAtCC,CAA6C,QAASA,KAAKkO,SAE3D,MAAMq7B,EAAa,IAAI0B,GAAW,CAChCxrC,KAAM,GACNgE,KAAM,aAER8lC,EAAW+B,KAAK5rC,OAAO04H,EAAcl3H,YACrC,QAAiBk3H,EAAcr4H,MAAOkoB,EAAA,EAAa,CAAChf,eAAgBjJ,KAAKiJ,iBACzEsgC,EAAWhwB,MAAMna,UAAUC,IAAI,iBAC/BkqC,EAAWxpC,MAAMR,UAAW,EACxBS,KAAKg3H,kBAAkBj3H,MAAMqpC,SAC/BG,EAAWhwB,MAAMna,UAAUkB,OAAO,eAEpCN,KAAKiJ,eAAe5J,IAAIkqC,EAAWxpC,MAAnCC,CAA0C,UAAU,KAElD,GADgBupC,EAAWxpC,MAAMqpC,QACrB,CACV,MAAM/qB,GAAM,EAAA48C,GAAA,GAAW1xB,EAAWhwB,OAClCvZ,KAAKu2H,eAAiB,CAAC,IAAI7pG,WAAW,CAACrO,KACvCre,KAAKyoC,mBAIT,MAAMknE,EAAY7wG,SAASC,cAAc,QACzC4wG,EAAUvwG,UAAUC,IAAI,WAAY,eACpC+4H,EAAcl3H,UAAUxB,OAAOiwG,IAE/B,QAAiBA,EAAW3vG,KAAKonE,cAAe,CAACn+D,eAAgBjJ,KAAKiJ,eAAgBzB,MAAM,IAE5FxH,KAAKq2H,UAAU32H,OAAO6pC,EAAWhwB,OAEjCvZ,KAAK8L,WAAW8pC,kBAAkB,CAChCxrC,QAASpK,KAAKq2H,UAAU5xH,iBACxBkmC,SAAU,WAIZ3qC,KAAKw2H,kBAAkB3kH,KAAKumH,ICzXzB,SAASC,GAAsBrqG,GACpC,IAAIzsB,EAAeC,EASnB,OARGwsB,aAAiBxH,kBAClBjlB,EAAQysB,EAAM6T,WACdrgC,EAASwsB,EAAMsqG,cAEf/2H,EAAQysB,EAAMwzD,aACdhgF,EAASwsB,EAAMyzD,eAGVd,GAAkB,CACvB3yD,MAAAA,EACA4yD,WAAW,QAAcr/E,EAAOC,GAChCmsB,SAAS,QAAc,IAAK,KAC5BmzD,QAAS,K,eCtBE,SAASy3C,GAAenxG,GACrC,MAAMX,EAAMW,EAAMX,IAElB,OAAOvK,MAAMuK,GACZ/kB,MAAMya,GAAaA,EAASq8G,gBAC5B92H,MAAM82H,IACL,MAAMplH,EAAI,IAAIsZ,WAAW8rG,GAGzB,IAAI3yH,EAAW,EACf,IAAI,IAAIkG,EAAI,EAAGpL,EAASyS,EAAEzS,OAAQoL,EAAIpL,IAAUoL,EAE9C,GAAW,IAARqH,EAAErH,IACW,KAAZqH,EAAErH,EAAI,IACM,GAAZqH,EAAErH,EAAI,IACM,GAAZqH,EAAErH,EAAI,GAAY,CAEpB,MAAM5F,EAASiN,EAAErH,EAAI,IAAM,EAAiB,IAAXqH,EAAErH,EAAI,GAIvClG,GAAYM,EAAQ,EAAI,GAAKA,EAIjC,OAAON,EAAW,O,2SCiBtB,IAAI4yH,GAEG,SAASC,KACd,OAAOD,GAGM,MAAME,WAAsB,IAgBzC/4H,YAAoBwiC,EAAoBk/C,EAAes3C,GACrD/4H,MAAM,mCAAoC,KAAM,CAACu2C,UAAU,EAAMg8C,YAAa,aAAcymC,+BAA+B,EAAMjuF,MAAM,IADrH,KAAAxI,KAAAA,EAAoB,KAAAk/C,MAAAA,EA6IhC,KAAAw3C,UAAaz4H,IACnB,MAAM8G,EAAS9G,EAAE8G,OACjB,GAAGA,IAAWnH,KAAKD,MAAO,CACxB,GAAsB,UAAnBoH,EAAOE,SAAuBF,EAAO2sH,aAAa,mBACnD,OAGF9zH,KAAKD,MAAM0M,SACX,EAAAssH,GAAA,GAAgB/4H,KAAKD,SA+MjB,KAAAi5H,WAAc33C,IACpB,MAAM43C,EAAaj5H,KAAKi5H,WAClBC,EAAiBl5H,KAAKk5H,eAAe73C,EAAKphF,MAE1Ck5H,EAAyB,GAC/BA,EAAO93C,KAAOA,EAEd,MAAM+3C,EAAUt6H,SAASC,cAAc,OACvCq6H,EAAQh6H,UAAUC,IAAI,cAEtB85H,EAAOC,QAAUA,EAEjB,MAAMtvH,EAAUovH,EAAiBl5H,KAAKq5H,YAAYF,EAAQC,GAAWp5H,KAAKs5H,eAAeH,EAAQC,GAEjG,OADAH,EAAWM,gBAAgB1nH,KAAKsnH,GACzBrvH,GAhXP9J,KAAKyoB,UAAUmwG,GAGHnwG,UAAUmwG,G,0CACtB54H,KAAKi5H,WAAa,CAChBh5H,KAAM24H,EACNW,gBAAiB,GACjBp5F,OAAO,GAGT,MAAMq5F,QAAex5H,KAAK2S,SAAS2iE,WAAWmkD,YAK9C,GAJAz5H,KAAK05H,iBAAmBF,EAAOG,oBAE/B,QAAiB35H,KAAKqyF,YAAY,IAAMryF,KAAKi2H,QAAQ,CAAChtH,eAAgBjJ,KAAKiJ,iBAErD,cAAnBjJ,KAAKoiC,KAAKniC,KAAsB,CACjC,MAAM01H,EAAW,IAAI,GAAgB,CACnCF,cAAe,KACbz1H,KAAKoiC,KAAKriC,MAAM42H,YAAa,EAC7B32H,KAAKi2H,QAEPP,gBAAiB,KACf11H,KAAKoiC,KAAKriC,MAAMi0H,iBAAgB,KAC9Bh0H,KAAKi2H,WAGTL,SAAU,cACVC,iBAAkB71H,KAAKqyF,WACvBppF,eAAgBjJ,KAAKiJ,iBAGvB0sH,EAASG,UAAU91H,KAAKoiC,KAAK71B,QAE7BvM,KAAK4O,OAAOlP,OAAOi2H,EAASA,UAG9B31H,KAAK45H,eAAiB96H,SAASC,cAAc,OAC7CiB,KAAK45H,eAAex6H,UAAUC,IAAI,eAClC,MAAMyM,EAAa,IAAI,KAAW,MAClCA,EAAW5K,UAAUxB,OAAOM,KAAK45H,gBAEjC55H,KAAKuC,WAAa,IAAI,IAAW,CAC/BwL,YAAa,mCACbwL,MAAO,UACP9V,KAAM,gBACN+V,UAAWxZ,KAAK05H,mBAElB15H,KAAKD,MAAQC,KAAKuC,WAAWxC,MAE7BC,KAAKuC,WAAW/B,MAAQR,KAAK65H,cAAgB75H,KAAKoiC,KAAKriC,MAAM+5H,kBAAkB/5H,MAAMuE,UACrFtE,KAAKoiC,KAAKriC,MAAM+5H,kBAAkBt5H,MAAQ,GAE1CR,KAAK4qC,KAAKlrC,OAAOoM,EAAW5K,WAC5BlB,KAAKkB,UAAUxB,OAAOM,KAAKuC,WAAWrB,WAEtClB,KAAK+5H,cAEL/5H,KAAKI,iBAAiB,SAAS,KAC7BJ,KAAKshF,MAAQ,GACbm3C,QAAezuH,KAGjByuH,GAAez4H,QAGVg6H,YAAY5vH,GACjBpK,KAAK4qC,KAAKlrC,OAAO0K,GAGfnK,WACF,OAAOD,KAAKi5H,WAAWh5H,KAGrBA,SAAKA,GACPD,KAAKi5H,WAAWh5H,KAAOA,EAGjBg6H,2B,MACN,MAAMt9D,EAAO38D,KAAKshF,MAAM3gF,OAAS,EAC9Bg8D,IAAS38D,KAAKk6H,oBACfl6H,KAAKk6H,mBAAqB,IAAI,KAAc,CAC1Cz6H,KAAM,2BACNgE,KAAM,gBAERzD,KAAKkB,UAAUxB,UAAU,CAACM,KAAKk6H,mBAAmB3gH,MAA8B,QAAvB,EAAAvZ,KAAKm6H,0BAAkB,eAAE5gH,MAAOvZ,KAAKuC,WAAWrB,WAAWyqB,OAAO6kB,UAE3HxwC,KAAKi5H,WAAW94F,OAAQ,EACxBngC,KAAKk6H,mBAAmBt5H,iBAAiBZ,KAAKi5H,WAAW94F,OAEzDngC,KAAKiJ,eAAe5J,IAAIW,KAAKk6H,mBAAmBn6H,MAAhDC,CAAuD,UAAU,KAC/D,MAAMopC,EAAUppC,KAAKk6H,mBAAmB9wF,QAExCppC,KAAKi5H,WAAW94F,MAAQiJ,EAExBppC,KAAK+5H,kBAEC/5H,KAAKk6H,oBACbl6H,KAAKk6H,mBAAmB3gH,MAAMna,UAAUoE,OAAO,QAASm5D,GAIpDy9D,2B,MACN,MAAMz9D,IAAS38D,KAAKshF,MAAMlvE,MAAMivE,GAAS,QAA+BA,EAAKphF,QAC1E08D,IAAS38D,KAAKm6H,oBACfn6H,KAAKm6H,mBAAqB,IAAI,KAAc,CAC1C16H,KAAM,6BACNgE,KAAM,mBAERzD,KAAKkB,UAAUxB,UAAU,CAAwB,QAAvB,EAAAM,KAAKk6H,0BAAkB,eAAE3gH,MAAOvZ,KAAKm6H,mBAAmB5gH,MAAOvZ,KAAKuC,WAAWrB,WAAWyqB,OAAO6kB,UAE3HxwC,KAAKm6H,mBAAmBv5H,iBAA0C,UAAzBZ,KAAKi5H,WAAWh5H,MAEzDD,KAAKiJ,eAAe5J,IAAIW,KAAKm6H,mBAAmBp6H,MAAhDC,CAAuD,UAAU,KAC/D,MAAMopC,EAAUppC,KAAKm6H,mBAAmB/wF,QAExCppC,KAAKi5H,WAAWh5H,KAAOmpC,EAAU,QAAU,WAE3CppC,KAAK+5H,kBAEC/5H,KAAKm6H,oBACbn6H,KAAKm6H,mBAAmB5gH,MAAMna,UAAUoE,OAAO,QAASm5D,GAIrD09D,SAAS/4C,GACd,MAAMg5C,EAASh5C,EAAM31D,QAAQ01D,IACbrhF,KAAKshF,MAAMlvE,MAAMmoH,GACtBA,EAAMC,eAAiBn5C,EAAKm5C,cAAgBD,EAAM92H,OAAS49E,EAAK59E,MAAQ82H,EAAMv5H,OAASqgF,EAAKrgF,SAMpGs5H,EAAO35H,SACRX,KAAKshF,MAAMzvE,QAAQyoH,GACnBt6H,KAAK+5H,eAgBD9D,KAAK2B,GAAQ,GACnB,GAAsB,cAAnB53H,KAAKoiC,KAAKniC,OAAyB23H,EAKpC,YAJA53H,KAAKoiC,KAAKriC,MAAMi0H,iBAAgB,KAC9Bh0H,KAAKi2H,MAAK,MAMd,IAAI9mF,EAAUnvC,KAAKuC,WAAW/B,MAC9B,GAAG2uC,EAAQxuC,OAASX,KAAK05H,iBAEvB,YADA/tF,GAAM,YAAY,sCAAsC,IAI1D3rC,KAAKs2C,OACL,MAAM2iF,EAAaj5H,KAAKi5H,WACxBA,EAAWwB,QAA8B,UAApBxB,EAAWh5H,WAA0B+J,EAC1D,MAAM,gBAACuvH,EAAe,QAAEkB,GAAWxB,GAI7B,OAAC1sH,EAAM,MAAExM,GAASC,KAAKoiC,KAE7Bm3F,EAAgBnsH,SAASgG,IACvBA,EAAEgmH,aAAUpvH,KAGd,MAAM,OAACrJ,GAAU44H,EACXmB,EAAgB16H,KAAKoiC,KAAK61F,0BAChCj4H,KAAKm0D,SAASolE,IACTpqF,GAAWoqF,EAAgB54H,SAAWA,IACvCX,KAAK2S,SAAS40B,mBAAmBozF,SAASpuH,EAAQ4iC,EAAS,OAAF,wBACpDurF,GAAa,CAChBvpB,YAAY,KAGdhiE,OAAUnlC,GAGZ,MAAMuW,EAAI,OAAH,wBACF04G,GAAU,CACbM,gBAAAA,IAGFv5H,KAAK2S,SAAS40B,mBAAmBqzF,UAAUruH,EAAQgU,EAAEg5G,gBAAgB5+G,KAAKvH,GAAMA,EAAEiuE,OAAO8K,OAAO0uC,OAAO,OAAD,wBACjGH,GAAa,CAChBvrF,QAAAA,EACAsrF,QAASA,EACTtpB,YAAY,IACX5wF,IAEH4uB,OAAUnlC,KAGZjK,EAAM+6H,aAAe96H,KAAKoiC,KAAKv2B,SAC/B9L,EAAMo0H,gBAGMkF,YAAYF,EAAwBC,G,0CAChDA,EAAQh6H,UAAUC,IAAI,oBAEtB,MAAMgiF,EAAO83C,EAAO93C,KAGpB,IAAIv3E,EACJ,GAHgBu3E,EAAKphF,KAAK86H,WAAW,UAGzB,CACV,MAAMrqG,EAAQD,KACRuqG,EAASl8H,SAASC,cAAc,UACtCi8H,EAAOv0G,IAAM0yG,EAAO8B,gBAAkB,YAAuB,kBAAmB55C,GAChF3wD,EAAMpvB,UAAW,EACjBovB,EAAMwqG,UAAW,EACjBxqG,EAAMkQ,OAAQ,EAEdlQ,EAAMtwB,iBAAiB,cAAc,KACnCswB,EAAM1uB,UACL,CAACwF,MAAM,IAEVsC,GAAU,EAAA63B,GAAA,GAAYjR,GAAOhvB,MAAK,IAAW,mCAC3Cy3H,EAAO53H,MAAQmvB,EAAMmR,WACrBs3F,EAAO33H,OAASkvB,EAAM4nG,YACtBa,EAAOtzH,SAAWlD,KAAK6uB,MAAMd,EAAM7qB,UAEnC,MAAMs1H,EAAyBzqG,EAAc0qG,iCAChBpxH,IAA1BmxH,IACDhC,EAAOkC,SAAWF,GAGpB/B,EAAQ15H,OAAOgxB,GACf,MAAMzD,QFxRP,SAA+ByD,GACpC,OAAO,IAAIvtB,SAAQ,CAAC4B,EAASylB,KAC3BkG,EAAM4qG,SAAW,KACf5qG,EAAM4qG,SAAW,KACfjD,GAAsB3nG,GAAOhvB,KAAKqD,GAElC2rB,EAAM4qG,cAAWtxH,GAGnB0mB,EAAM0G,YAAc,GAGtB1G,EAAM6qG,QAAU/wG,EAChBkG,EAAM0G,YAAcz0B,KAAKC,IAAI8tB,EAAM7qB,SAAU,ME2QrB21H,CAAsB9qG,GAC1CyoG,EAAOlsG,MAAQ,OAAH,QACV3G,UAAW,YAAuB,kBAAmB2G,EAAMmX,OACxDnX,QAIPyD,EAAMhxB,OAAOs7H,OACR,CACL,MAAM1vG,EAAM,IAAIrE,MAChBnd,EAAU,IAAI3G,SAAe4B,IAC3BumB,EAAIY,OAAS,KACXitG,EAAO53H,MAAQ+pB,EAAIk2D,aACnB23C,EAAO33H,OAAS8pB,EAAIm2D,cAEpB23C,EAAQ15H,OAAO4rB,GAEE,cAAd+1D,EAAKphF,MACNk5H,EAAOkC,SAAU,EAEjBl4H,QAAQC,IAAI,CACVm1H,GAAejtG,GAAK5pB,MAAMmE,IACxBszH,EAAOtzH,SAAWlD,KAAKoR,KAAKlO,MAG9BwyH,GAAsB/sG,GAAK5pB,MAAWurB,GAAU,mCAC9CksG,EAAOlsG,MAAQ,OAAH,QACV3G,UAAW,YAAuB,kBAAmB2G,EAAMmX,OACxDnX,UAGNvrB,MAAK,KACNqD,QAGFA,QAKNumB,EAAI7E,IAAM0yG,EAAO8B,gBAAkB,YAAuB,kBAAmB55C,GAG/E,OAAOv3E,KAGKwvH,eAAeH,EAAwBC,G,0CACnDA,EAAQh6H,UAAUC,IAAI,uBACtB,MAAMgiF,EAAO83C,EAAO93C,KAEdo6C,EAAUp6C,EAAKphF,KAAK86H,WAAW,UAC/BW,EAAUr6C,EAAKphF,KAAK86H,WAAW,WAClCU,GAAWC,GAAWr6C,EAAKrgF,KAAO,OACnCm4H,EAAO8B,gBAAkB,YAAuB,kBAAmB55C,IAGrE,MAAM7mD,EAAM,CACV5tB,EAAG,WACHy0E,KAAMA,EACNljD,UAAWkjD,EAAK59E,MAAQ,GACxBzC,KAAMqgF,EAAKrgF,KACXf,KAAMw7H,EAAU,QAAU,OAG5B,IAAIpuG,EACD8rG,EAAO8B,YACR5tG,EAAe,CACb/G,IAAK6yG,EAAO8B,UACZ1tG,WAAY8zD,EAAKrgF,KACjBf,KAAM,SAIV,MAAM4iC,QAAeN,GAAa,CAChCl1B,QAAS,CACPT,EAAG,UACH4L,OAAQ,CACNqiB,aAAa,GAEf5tB,IAAK,EACLV,OAAQ,EACRyhB,MAAO,CACLphB,EAAG,uBACH9N,SAAU07B,IAGdnN,aAAAA,IAyBF,OAtBgB,IAAIlqB,SAAe4B,IACjC,MAAM42H,EAAS,KACbvC,EAAQ15H,OAAOmjC,GACf99B,KAGF,GAAG02H,EAAS,CACV,MAAMnwG,EAAM,IAAIrE,MAChBqE,EAAI7E,IAAM0yG,EAAO8B,UACjB3vG,EAAIY,OAAS,KACXitG,EAAO53H,MAAQ+pB,EAAIk2D,aACnB23C,EAAO33H,OAAS8pB,EAAIm2D,cAEpBk6C,KAGFrwG,EAAIiwG,QAAUI,OAEdA,UAwBEzC,eAAezsG,GACrB,MAAgC,UAAzBzsB,KAAKi5H,WAAWh5H,MAAoB,QAA+BwsB,GAGpEmvG,WAEF57H,KAAKoK,QAAQhL,UAAUiG,SAAS,YAClCrF,KAAKiJ,eAAe5J,IAAIP,SAAS8rC,KAAjC5qC,CAAuC,UAAWA,KAAK84H,WACvD94H,KAAKI,iBAAiB,SAAS,KAC1BJ,KAAK65H,gBACN75H,KAAKoiC,KAAKriC,MAAM+5H,kBAAkBt5H,MAAQR,KAAK65H,kBAGnD75H,KAAKkvC,QAIDt/B,WACN,MAAM,WAACqpH,EAAU,MAAEnqH,EAAK,MAAEwyE,GAASthF,KACnC,IAAI6P,EACJ,MAAMT,EAA2B,GACjC,GAAuB,aAApB6pH,EAAWh5H,KACZ4P,EAAM,yBACNT,EAAKyC,KAAKyvE,EAAM3gF,YACX,CACL,IAAIk7H,EAAc,EAAGC,EAAc,EAAGC,EAAa,EACnDz6C,EAAMl0E,SAASi0E,IACVA,EAAKphF,KAAK86H,WAAW,YAAac,EAC7Bx6C,EAAKphF,KAAK86H,WAAW,YAAae,IACnCC,KAGN,CAACF,EAAaC,EAAaC,GAAYpwG,QAAQqwG,GAAMA,EAAI,IAAGr7H,OAAS,GACtEkP,EAAM,yBACNT,EAAKyC,KAAKyvE,EAAM3gF,SAQLk7H,GACXhsH,EAAM,0BACNT,EAAKyC,KAAKgqH,IACFC,IACRjsH,EAAM,0BACNT,EAAKyC,KAAKiqH,KAId,EAAAluH,EAAA,GAAekB,GAAO,QAAKe,EAAKT,IAG1B6sH,uBAAuB53H,EAAkB80H,GAC/C,GAAGn5H,KAAKk5H,eAAeC,EAAO93C,KAAKphF,MAAO,CACxC,MAAMe,GAAO,EAAA0f,GAAA,GAAey4G,EAAO53H,MAAO43H,EAAO33H,OAAQ,IAAK,KAC9D6C,EAAIpB,MAAM1B,MAAQP,EAAKO,MAAQ,KAC/B8C,EAAIpB,MAAMzB,OAASR,EAAKQ,OAAS,KAGnCxB,KAAK45H,eAAel6H,OAAO2E,GAGrB8vD,QAAQjuD,GACd,MAAM,gBAACqzH,GAAmBv5H,KAAKi5H,WAC/B,IAAIj5H,KAAKi5H,WAAW94F,MAElB,YADAo5F,EAAgBnsH,SAASwgC,GAAM1nC,EAAG,CAAC0nC,MAIrC,MAAMjtC,EAAS44H,EAAgB54H,OAC/B,IAAI,IAAIoL,EAAI,EAAGA,EAAIpL,GAAS,CAC1B,MAAMu7H,EAAY3C,EAAgBxtH,GAAGs1E,KAAKphF,KAC1C,IAAIwX,EAAI,EACR,KAAMA,EAAI,IAAM1L,EAAIpL,IAAUoL,IAAK0L,EAAG,CACpC,MAAMxX,EAAOs5H,EAAgBxtH,GAAGs1E,KAAKphF,KACrC,GAAGD,KAAKk5H,eAAegD,KAAel8H,KAAKk5H,eAAej5H,GACxD,MAIJiG,EAAGqzH,EAAgB74H,MAAMqL,EAAI0L,EAAG1L,KAI5BguH,cACN,MAAM,MAACz4C,EAAK,WAAE23C,EAAU,eAAEW,GAAkB55H,KAC5Ci5H,EAAWM,gBAAgB54H,OAAS,EAEpCX,KAAKi6H,2BACLj6H,KAAKo6H,2BAELj3H,QAAQC,IAAIk+E,EAAM3mE,IAAI3a,KAAKg5H,aAAat3H,MAAK,KAC3Ck4H,EAAet1H,UAAY,GAEvBg9E,EAAM3gF,SAIVX,KAAK4P,WAEL5P,KAAKm0D,SAASolE,IACZ,GAAGv5H,KAAKk5H,eAAeK,EAAgB,GAAGl4C,KAAKphF,OAASs5H,EAAgB54H,OAAS,EAAG,CAClF,MAAMw7H,EAAiBr9H,SAASC,cAAc,OAC9Co9H,EAAe/8H,UAAUC,IAAI,mBAAoB,cACjD88H,EAAez8H,UAAU65H,EAAgB5+G,KAAKof,GAAMA,EAAEq/F,WAEtDzzG,GAAa,CACXzkB,UAAWi7H,EACX1/G,MAAO88G,EAAgB5+G,KAAKozB,IAAM,CAAExtB,EAAGwtB,EAAExsC,MAAOif,EAAGutB,EAAEvsC,WACrDyf,SAAU,IACVC,SAAU,IACVC,QAAS,IAGXy4G,EAAel6H,OAAOy8H,QAEtB5C,EAAgBnsH,SAAS+rH,IACvBn5H,KAAKi8H,uBAAuB9C,EAAOC,QAASD,aAIjDz3H,MAAK,KACN1B,KAAK47H,eCviBX,MAAMQ,GAAe,UACfC,GAAoB,SAEpBC,GAA0B,CAAC,UAAW,aACtCC,GAA0B,CAAC,YAAa,cCF/B,MAAMC,WAA2B,IAoB9C58H,YAAYhB,GAOViB,OAAM,GAtBE,KAAA48H,QAAS,EA4CT,KAAAC,UAAY,KACjB18H,KAAKupB,QACNvpB,KAAKupB,SAGP,MAAM1e,EAAO7K,KAAK6K,MACZ,OAAC2e,EAAM,OAAED,EAAM,YAAEozG,GDnDZ,UAA8B,KAAC9xH,EAAI,KAAE5K,EAAI,SAAEo2C,EAAQ,KAAE7uC,EAAI,WAAEo1H,IAOxE,IAAIC,GAAgBD,MAAAA,OAAU,EAAVA,EAAYj8H,QAAS,IAAIie,IAAIg+G,QAAc5yH,EAC/D,MAAM8yH,EAAW,IAAIl+G,IAAa,OAAT3e,EAAgBq8H,GAAYh8G,OAAOi8G,IAAyB,MAATt8H,EAAes8H,GAAcD,IAEzG,IAAIn1H,EACJ,MAAM41H,EAAmB,IAChB51H,GAAU0D,EAAK3F,cAAc,YAA4B2F,EAAKke,kBAGjEi0G,EAAmB,CAAC5jB,EAAkB6jB,KAC1C,GAAG91H,IAAWiyG,EACZ,OAGF,IAAI8jB,GAAY,EACb/1H,IACD+1H,GAAY,EACZ/1H,EAAO/H,UAAUkB,OAAO+7H,KAG1Bl1H,EAASiyG,EACLjyG,IACJA,EAAO/H,UAAUC,IAAIg9H,IAElBa,GAAapxH,GAAcmxH,IAC5B,EAAAE,GAAA,GAAiB,CACfj8H,UAAW4K,EACX1B,QAASjD,EACTwjC,SAAU,SACVszE,cAAe,IACfK,KAAe,MAATr+G,EAAe,IAAM,QAK3Bm9H,EAAiB,CAACC,EAAwBC,KAC9C,IAAIC,EAIJ,OAHWA,EAARD,EAAqBD,EAAcnvF,oBAAsBrjC,EAAKke,kBAC/Cs0G,EAAcx0G,wBAA0Bhe,EAAKpG,iBAExD84H,GAqBT,IAAIC,EAEFA,EADU,OAATv9H,EACgB,CAACo9H,EAAextH,IACpB,YAARA,GAA6B,cAARA,EArBL,EAACwtH,EAAwBC,KAC9C,MAAMG,EAAWH,EAAS,qBAAuB,yBAC3CI,EAAcJ,EAAS,oBAAsB,mBAC7CK,EAAcN,EAAc52H,wBAElC,IAAI82H,EAAaF,EAAcI,IAAa5yH,EAAK6yH,GACjD,KAAMH,IAAeF,GAAe,CAClC,MAAMO,EAAaL,EAAW92H,wBAC9B,GAAGm3H,EAAW52H,IAAM22H,EAAY32H,GAAK42H,EAAW32H,IAAM02H,EAAY12H,EAChE,MAGFs2H,EAAaA,EAAWE,IAAa5yH,EAAK6yH,GAG5C,OAAOH,GAM+CM,CAAeR,EAAuB,cAARxtH,GACtEutH,EAAeC,EAAuB,eAARxtH,GAG3B,CAACwtH,EAAextH,IAAQutH,EAAeC,EAAuB,eAARxtH,GAAgC,cAARA,GAGjG,IAAIipH,EAAaz4H,IACf,MAAMwP,EAAMxP,EAAEwP,IACd,GAAIitH,EAAS3qF,IAAItiC,IAWjB,IAFA,EAAAoY,EAAA,GAAY5nB,GAETwK,EAAKI,kBAAoB,EAAG,CAC7B,IAAIoyH,EAAgBN,IACpBM,EAAgBG,EAAeH,EAAextH,GAC9CmtH,EAAiBK,GAAe,SAbrB,UAARxtH,GAA6B,OAAT5P,GAAyB,QAAR4P,MACtC,EAAAoY,EAAA,GAAY5nB,GACZy9H,EAAWf,OAejB,MAAMjxH,GAAa,EAAA6tB,GAAA,GAAgB9uB,EAAM,cACzCA,EAAKzL,UAAUC,IAAI,kBAEnB,MAAMg1B,EAAeh0B,IACnB,MAAM8G,GAAS,EAAA24D,GAAA,GAAcz/D,EAAE8G,OAAQ0D,GACnC1D,GAIJ61H,EAAiB71H,GAAQ,IAGrB6gB,EAAW3nB,KACf,EAAA4nB,EAAA,GAAY5nB,GAEZ,MAAM8G,GAAS,EAAA24D,GAAA,GAAcz/D,EAAE8G,OAAQ0D,GACnC1D,IAIJ61H,EAAiB71H,GAAQ,GACzB22H,EAAWf,OAGPe,EAAc32H,IAClB,MAAM42H,EAAc1nF,EAASlvC,SACV6C,IAAhB+zH,GAA6BA,EAAcv2H,IAC5C+hB,KAIJ,IAAIy0G,GAAW,EACf,MAAMx0G,EAAS,KACVw0G,IACHA,GAAW,EAGXl/H,SAASsB,iBAAiBg8H,GAActD,EAAW,CAACxlG,SAAS,EAAM3rB,SAAS,IAC5EkD,EAAKzK,iBAAiB,YAAai0B,EAAa,CAAC1sB,SAAS,KAC1D,QAAiBkD,EAAMmd,KAGnBuB,EAAS,KACTy0G,IACJA,GAAW,EAEXl/H,SAASuH,oBAAoB+1H,GAActD,EAAW,CAACxlG,SAAS,IAChEzoB,EAAKxE,oBAAoB,YAAaguB,IACtC,QAAiBxpB,EAAMmd,KAGnB20G,EAAc,KACfE,GACHG,EAAiBnyH,EAAKke,mBAAmB,IAG3C,GAAG8zG,EAAe,CAChB,MAAMoB,EAAanF,EACnBA,EAAaz4H,IACRw8H,EAAc1qF,IAAI9xC,EAAEwP,QACrB,EAAAoY,EAAA,GAAY5nB,GAEZvB,SAASuH,oBAAoB+1H,GAActD,EAAW,CAACxlG,SAAS,IAChEwlG,EAAYmF,EACZn/H,SAASsB,iBAAiBg8H,GAActD,EAAW,CAACxlG,SAAS,EAAM3rB,SAAS,IAE5Ek1H,OAAgB7yH,EAChB2yH,WAIJA,IAKF,OAFAnzG,IAEO,CACLA,OAAAA,EACAD,OAAAA,EACAozG,YAAAA,GC7HsCuB,CAAqB,CACzDrzH,KAAAA,EACA5K,KAAMD,KAAKm+H,SACX9nF,SAAUr2C,KAAKq2C,SACf7uC,MAAM,EACNo1H,WAAY58H,KAAK48H,aAGnB58H,KAAKwpB,OAASA,EACdxpB,KAAKupB,OAASA,EACdvpB,KAAK28H,YAAcA,EACf,GAAA5pC,WAAc/yF,KAAKs2F,iBACrBt2F,KAAKs2F,eAAiB,CACpBr2F,KAAM,sBACN0R,MAAO,KACL3R,KAAKs2F,oBAAiBtsF,EACtBhK,KAAKwD,QAAO,IAEd46H,aAAa,GAGf9tH,EAAA,WAAiCtQ,KAAKs2F,iBAGxCt2F,KAAKI,iBAAiB,UAAU,KAC9BJ,KAAK28H,iBAAc3yH,EACnBhK,KAAKwpB,YAASxf,EACdhK,KAAKupB,YAASvf,EAEda,EAAKvG,UAAY,GACjBilB,IAEGvpB,KAAKs2F,iBACNhmF,EAAA,aAAmCtQ,KAAKs2F,gBACxCt2F,KAAKs2F,oBAAiBtsF,KAEvB,CAACxC,MAAM,MA9DV,EAAAwJ,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,sBAAuB,aAEpDT,EAAQy0C,SAAS3zC,OAAOM,KAAKkB,WAE7BlB,KAAKq+H,mBAELr+H,KAAKs+H,YAAct+H,KAAKs+H,WAAWC,UAAUv+H,MAGxCw+H,qBAAqBrgF,GACvBA,EACDn+C,KAAKwpB,QAAUxpB,KAAKwpB,SAEpBxpB,KAAKupB,QAAUvpB,KAAKupB,SAiDd80G,mBACRr+H,KAAKI,iBAAiB,UAAWJ,KAAK08H,WAGjCl5H,OAAO8yC,EAAgBmoF,GAAiB,EAAOC,GACpD,GAAG1+H,KAAKqP,KACN,OAOF,QAJYrF,IAATssC,IACDA,EAAOt2C,KAAKkB,UAAU9B,UAAUiG,SAAS,gBAAkBrF,KAAKkB,UAAU9B,UAAUiG,SAAS,cAG5FrF,KAAKy8H,SAAWnmF,EAKjB,YAJIA,GACFt2C,KAAKgQ,cAAc,YAMvBhQ,KAAKy8H,OAASnmF,EAEVA,GAICt2C,KAAKs2F,iBACNhmF,EAAA,aAAmCtQ,KAAKs2F,gBACxCt2F,KAAKs2F,oBAAiBtsF,IAGpBy0H,GAAkBz+H,KAAKs+H,YACzBt+H,KAAKs+H,WAAWK,mBAGf3+H,KAAKupB,QACNvpB,KAAKupB,WAbPvpB,KAAKs+H,YAAct+H,KAAKs+H,WAAWK,iBAAiB3+H,MACpDA,KAAKgQ,cAAc,YAgBrB,MAAM8Z,EAAU9pB,KAAKs+H,YAAchoF,EAAO,EAAI,EAE3CA,GACDt2C,KAAKgQ,cAAc,WAGrB,QACEhQ,KAAKkB,UACL,cACCo1C,EACD,iCAAyCooF,EAAgB,IAAM,GAC/D,KACE1+H,KAAKy8H,QAAUz8H,KAAKgQ,cAAc,YAEpC8Z,ICjJS,MAAM80G,WAAuBpC,GAM1C58H,YACEyzC,EACAirF,EACQ3rH,GAER9S,MAAM,CACJwzC,SAAAA,EACAirF,WAAAA,EACAH,SAAU,KACV9nF,SAAWlvC,IACDyjG,GAAkBrhC,aAAa,CAACpiE,OAAAA,IAAS,GAEnDy1H,WAAY,CAAC,UAAW,eATlB,KAAAjqH,SAAAA,EAYR3S,KAAKkB,UAAU9B,UAAUC,IAAI,mBAE7BW,KAAKI,iBAAiB,WAAW,KAC/BgG,YAAW,KACTpG,KAAK8L,WAAW5K,UAAUujD,UAAY,IACrC,GAEH,kBAAwB,oBAAoB,MAG9CzkD,KAAKI,iBAAiB,UAAU,KAC3BJ,KAAK6+H,iBACNxvG,EAAA,sBAA+B,eAAgBrvB,KAAK6+H,gBACpD7+H,KAAK6+H,oBAAiB70H,GAGxB,kBAAwB,oBAAoB,MAIzC80H,cAAcn3F,GACnB,MAAMjZ,EAAa1uB,KAAKs+H,WAAWvqB,gBAEhC/zG,KAAKyuB,eACNzuB,KAAKyuB,cAAc1jB,QAGrBujH,GAA4B3mF,GAC5B3nC,KAAK2S,SAASo0B,mBAAmBg4F,sBAAsBp3F,GACtDjmC,MAAMsrG,IACL,IAAIt+E,IACF,OAGC1uB,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGd,MAAMnO,EAAYlB,KAAK6K,KAAK9G,YAE5B,IAAIi7H,EAEJh/H,KAAKyuB,cAAc1jB,QAEjBi0H,EADChyB,EAASrsG,OACF,IAAIwC,SAAe4B,IACzB,MAAM0E,EAA2B,GACjCujG,EAAS5/F,SAASw4B,IAChB1kC,EAAUxB,OAAOM,KAAK8sG,qBAAqBR,cAAc1mE,OAAuB57B,EAAWP,OAG5FtG,QAAQC,IAAIqG,GAA2ByhB,QAAQnmB,MAG1C5B,QAAQ4B,UAGlBi6H,EAAMt9H,MAAK,KACT1B,KAAK6K,KAAK4zB,YAAYv9B,GACtBlB,KAAK6K,KAAO3J,EAERlB,KAAK6+H,iBACP7+H,KAAK6+H,eAAiB,KACpB,MAAMt9H,EAASvB,KAAK6K,KAAKI,kBAAoBokB,EAAA,2BAAuCrvB,KAAK6K,KAAKI,kBAAoB,GAClHjL,KAAK6K,KAAK5H,MAAM1B,MAAQA,EAAQ,MAElC8tB,EAAA,mBAA4B,eAAgBrvB,KAAK6+H,iBAGnD7+H,KAAK6+H,iBAEL7+H,KAAKwD,QAAQwpG,EAASrsG,QACtBX,KAAK8L,WAAW24C,UAAY,QAKxBp1C,OACRrP,KAAK6K,KAAO/L,SAASC,cAAc,OACnCiB,KAAK6K,KAAKzL,UAAUC,IAAI,2BAA4B,kBAEpDW,KAAKkB,UAAUxB,OAAOM,KAAK6K,MAE3B7K,KAAK8L,WAAa,IAAI,KAAW9L,KAAKkB,WACtClB,KAAKyuB,cAAgB,IAAInP,GACzBtf,KAAK8sG,qBAAuB,IAAIZ,GAAqBlsG,KAAKyuB,cAAe+qC,GAAsBx5D,KAAK2S,WClHxG,MAAMssH,GAAa,KACjB,MAAM9rH,EAAO,IAAIzN,KAGjB,OADAyN,EAAKuD,SAAS,EAAG,EAAG,EAAG,GAChBvD,GAGH+rH,GAAa,KACjB,MAAM/rH,EAAO,IAAIzN,KAGjB,OAFAyN,EAAKsD,YAAYtD,EAAKG,cAAgB,GACtCH,EAAK4D,QAAQ5D,EAAKK,UAAY,GACvBL,GAOM,MAAMgsH,WAAsBviC,GACzCh9F,YAAYi9F,EAAgBC,EAAqCsiC,GALjD,IAACjsH,EAuBf,GAjBAtT,OANesT,EAMC0pF,GALN7oF,UAAYkrH,KAAalrH,UAAY,IAAItO,KAASyN,EAKjC2pF,EAAQ,CACjCC,WAAW,EACXvvD,SAAS,EACT4I,UAAU,EACVg8C,aAAa,EACbz7E,QAASsoH,KACTroH,QAASsoH,KACT7kG,UAAU,EACVwkE,oBAAoB,EACpBg6B,+BAA+B,IAGjC74H,KAAKoK,QAAQhL,UAAUC,IAAI,kBAC3BW,KAAK4O,OAAOlP,OAAOM,KAAK09F,aACxB19F,KAAK8O,MAAM2vB,YAAYz+B,KAAK29F,YAC5B39F,KAAK4qC,KAAKlrC,OAAOM,KAAKqyF,YAEnB+sC,EAAmB,CACpB,MAAMC,GAAoB,OAAO,4DAA6D,CAAC5/H,KAAM,4BACrGO,KAAK4qC,KAAKlrC,OAAO2/H,IAEjB,QAAiBA,GAAmB,KAClCviC,EAAOsJ,IACPpmG,KAAKs2C,Y,gDCvCE,SAASgpF,GAAsBC,EAAoBC,GAAe,GAC/E,MAAM1gC,EAAkB,GAClB55E,EAAiB,GAEjB65B,EAAMj5C,OAAO+4D,eACnB,IAAI4gE,EACAC,EACJ,GAAG3gF,GAAOA,EAAI6xD,WAAY,CACxB,MAAMtrB,EAAQvmC,EAAI+xD,WAAW,GACvB6uB,EAAcr6C,EAAMq6C,YAC1B,GACEr6C,EAAMs6C,gBACNt6C,EAAMs6C,gBAAkBt6C,EAAMu6C,cAC9BF,GAAer6C,EAAMw6C,UACrB,CAEA,MAAMC,EAA8BJ,EAAc,EAC5Cj9B,EAAa68B,EAAM78B,WACzB,GAAGpd,EAAMs6C,iBAAmBL,GAAS78B,EAAWq9B,GAA8B,CAC5EN,EAAU/8B,EAAWq9B,GACrBL,EAAY,EAEZ,IAAI,IAAI3zH,EAAI,EAAGA,EAAIu5E,EAAMw6C,YAAa/zH,EAAG,CACvC,MAAMi0H,EAAOt9B,EAAW32F,GAClBvL,EAAQw/H,EAAKn2B,WAAcm2B,EAA0BC,IAExDz/H,IACDk/H,GAAal/H,EAAMG,cAIvB8+H,EAAUn6C,EAAMs6C,eAChBF,EAAYC,GAKlB,MAAM1sE,EAA4BusE,EAAe,QAAKx1H,GACtD,EAAAk2H,GAAA,GAAoBX,EAAOzgC,EAAO55E,EAAMu6G,EAASC,EAAWzsE,GAEzD/tC,EAAKvkB,QACNm+F,EAAMjtF,KAAKqT,EAAKvB,KAAK,KAGvB,IAAInjB,EAAQs+F,EAAMn7E,KAAK,MACvB,MAAMw8G,EAAW3/H,EAAMgW,QAAQ,KAU/B,OATgB,GAAb2pH,IACD3/H,EAAQA,EAAM4yB,OAAO,EAAG+sG,GAAY3/H,EAAM4yB,OAAO+sG,EAAW,IAE9D3/H,EAAQA,EAAMC,QAAQ,UAAW,KAE9BwyD,IACD,EAAAmtE,GAAA,GAAoBntE,GAGf,CAACzyD,MAAAA,EAAOyyD,SAAAA,EAAUktE,SAAAA,GCzDZ,MAAME,WAAoB7D,GAGvC58H,YACEyzC,EACAirF,EACAgC,EACQ3tH,GAER9S,MAAM,CACJwzC,SAAAA,EACAirF,WAAAA,EACAH,SAAU,IACV9nF,SAAWlvC,IACTm5H,EAAUC,gBAAgB52B,GAAoBxiG,IAAgB,MAP1D,KAAAwL,SAAAA,EAWR3S,KAAKkB,UAAU9B,UAAUC,IAAI,gBAGrBgQ,OACRrP,KAAK6K,KAAO/L,SAASC,cAAc,OACnCiB,KAAK6K,KAAKzL,UAAUC,IAAI,sBAAuB,gBAE/CW,KAAKkB,UAAUxB,OAAOM,KAAK6K,MAE3B7K,KAAK8L,WAAa,IAAI,KAAY9L,KAAKkB,WAEvClB,KAAKI,iBAAiB,WAAW,KAC/BgG,YAAW,KACTpG,KAAK8L,WAAW5K,UAAUgwG,WAAa,IACtC,MAIA1gF,OAAO25E,EAAkByyB,GAC9B,GAAG58H,KAAKqP,KAAM,CACZ,IAAI86F,EAAOxpG,OACT,OAGFX,KAAKqP,OACLrP,KAAKqP,KAAO,MAGd86F,EAASA,EAAOzpG,MAAM,EAAG,KAEfC,SACRX,KAAK6K,KAAKvG,UAAY,GACtB6lG,EAAO/8F,SAASo4B,IACd6jE,GAAY7jE,EAAOxlC,KAAK6K,MAAM,GAAO,OAIzC7K,KAAK48H,WAAaA,EAAa,CAAC,UAAW,kBAAe5yH,EAC1DhK,KAAKwD,QAAQ2mG,EAAOxpG,QAOf6/H,WAAW70H,EAAe80H,GAC/B,MAAM/xG,EAAa1uB,KAAKs+H,WAAWvqB,gBACnC/zG,KAAK2S,SAAS63F,gBAAgBk2B,uBAAuBh/H,MAAK,KAAW,O,EAAA,K,OAAA,E,EAAA,YACnE,IAAIgtB,IACF,OAGF,MAAMnY,EAAI5K,EAAMlL,QAAQ,KAAM,IACxB0pG,QAAenqG,KAAK2S,SAAS63F,gBAAgBm2B,aAAapqH,GAC5DmY,KAIJ1uB,KAAKwwB,OAAO25E,EAAsB,MAAds2B,I,YAX+C,K,kRChE1D,MAAMG,WAA+BpE,GAKlD58H,YACEyzC,EACAirF,EACU3/H,EACV03C,GAEAx2C,MAAM,CACJwzC,SAAAA,EACAirF,WAAAA,EACAH,SAAU,IACV9nF,SAAAA,IAPQ,KAAA13C,UAAAA,EAUVqB,KAAKkB,UAAU9B,UAAUC,IAAIuhI,GAAuBh9E,WAAYjlD,GAGxD0Q,OACRrP,KAAK6K,KAAO/L,SAASC,cAAc,OACnCiB,KAAK6K,KAAKzL,UAAUC,IAAIuhI,GAAuBh9E,WAAa,QAAS5jD,KAAKrB,UAAY,SAEtFqB,KAAKkB,UAAUxB,OAAOM,KAAK6K,MAE3B7K,KAAK8L,WAAa,IAAI,KAAW9L,KAAKkB,WAEtClB,KAAKI,iBAAiB,WAAW,KAC/BgG,YAAW,KACTpG,KAAK8L,WAAW5K,UAAUujD,UAAY,IACrC,MAIAj0B,OAAOmW,EAA+Dk6F,GAC3E,GAAG7gI,KAAKqP,KAAM,CACZ,IAAIs3B,EAAKhmC,OACP,OAGFX,KAAKqP,OACLrP,KAAKqP,KAAO,KAGXs3B,EAAKhmC,SACNX,KAAK6K,KAAKvG,UAAY,GACtBqiC,EAAKv5B,SAASgG,IACZ,MAAM/O,EAAMu8H,GAAuBE,YAAY,CAC7CniI,UAAWqB,KAAKrB,UAChB4N,OAAQ6G,EAAE7G,OACV9I,KAAM2P,EAAE3P,KACRkqC,YAAav6B,EAAEu6B,cAGjB3tC,KAAK6K,KAAKnL,OAAO2E,OAIjBw8H,GACF7gI,KAAKwD,QAAQmjC,EAAKhmC,QAIf8iB,mBAAmB7kB,GAMxB,MAAMmiI,EAAOH,GAAuBI,wBACpCpiI,EAAQD,WAAa,gBAErB,MAAM0F,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI0hI,EAAMniI,EAAQD,WAChC0F,EAAIuD,QAAQ2E,OAAS,GAAK3N,EAAQ2N,OAElC,MAAMo3C,EAAS,IAAIrW,GACnBqW,EAAOvkD,UAAUC,IAAI,YAAa0hI,EAAO,UAAWniI,EAAQD,UAAY,WACxEglD,EAAO9a,kBAAkB,CACvB0E,UAAU,EACVhhC,OAAQ3N,EAAQ2N,SAGlB,MAAM9I,EAAO3E,SAASC,cAAc,OAepC,GAdA0E,EAAKrE,UAAUC,IAAI0hI,EAAO,QAASniI,EAAQD,UAAY,SACnDC,EAAQ6E,MAQV,EAAAk1B,EAAA,GAAal1B,GAAM,EAAAm1B,GAAA,GAAch6B,EAAQ6E,OAPzCA,EAAK/D,OAAO,IAAI44B,GAAU,CACxB/rB,OAAQ3N,EAAQ2N,OAChBisB,QAAQ,EACRD,eAAe,EACfz4B,WAAW,IACVsK,SAKL/F,EAAI3E,OAAOikD,EAAQlgD,GAEhB7E,EAAQ+uC,YAAa,CACtB,MAAMA,EAAc7uC,SAASC,cAAc,OAC3C4uC,EAAYvuC,UAAUC,IAAI0hI,EAAO,eAAgBniI,EAAQD,UAAY,iBACrE,EAAAg6B,EAAA,GAAagV,GAAa,EAAA/U,GAAA,GAAch6B,EAAQ+uC,cAChDtpC,EAAI3E,OAAOiuC,GAGb,OAAOtpC,GA1GQ,GAAAu/C,WAAa,2BACb,GAAAo9E,wBAA0BJ,GAAuBh9E,WAAa,gB,eCH1E,SAASq9E,GAA2B10H,EAAgB2iB,EAAoEvjB,GAC7H,MAAMu1H,EAA8B,GAAG5gH,OAAO4O,EAAK49F,UACnD,IAAIxnG,OAEStb,IAAV2B,IACD2Z,EAAQ,IAAI,KAAoB,CAC9Bjd,YAAY,KAKhB,MAAM84H,EAA2B,IAAIlwH,IAkBrC,IAAImN,EACJ,GAlBA8iH,EAAS9zH,SAASg0H,IAChBA,EAAQD,SAAS/zH,SAAQ,EAAEi0H,QAAAA,EAAS1zF,YAAAA,GAActvB,KAChD,MAAMvH,EAAI,IAAMuqH,EAChBF,EAASlkH,IAAIokH,EAAS,CACpB90H,OAAQ60H,EAAQ3yE,QAAU2yE,EAAQ3yE,QAAQ5zC,UAAS,GAAStO,EAC5D80H,QAASA,EACT59H,KAAMqT,EACN62B,YAAaA,EACbroB,MAAOjH,IAGNiH,GACDA,EAAMg8G,YAAYD,EAASvqH,SAM7BwO,EAEG,CACL,MAAMuzC,EAAQvzC,EAAMooF,OAAO/hG,GAC3ByS,EAAMhN,MAAMC,KAAKwnD,GAAOl+C,KAAK0mH,GAAYF,EAAS3vH,IAAI6vH,UAHtDjjH,EAAM,IAAI+iH,EAASlrF,UAQrB,OAFA73B,EAAMA,EAAIk9B,MAAK,CAAC1U,EAAGmkB,IAAMo2E,EAAS3vH,IAAIo1B,EAAEy6F,SAAS/7G,MAAQ67G,EAAS3vH,IAAIu5C,EAAEs2E,SAAS/7G,QAE1ElH,EAGM,MAAMmjH,WAAuBX,GAC1ChhI,YACEyzC,EACAirF,EACAgC,EACQ3tH,GAER9S,MAAMwzC,EACJirF,EACA,mBACCn3H,IACC,MAAM7C,EAAY6C,EAAOjC,cAAc,IAAI07H,GAAuBI,gCAAgC18H,UAClG,OAAOg8H,EAAUkB,gBAAe,KAC9BlB,EAAUliB,aAAa95G,UAAYA,EACnCg8H,EAAUmB,aAAY,SATpB,KAAA9uH,SAAAA,EAeG6tH,WAAW70H,EAAeY,G,qCACrC,WAAWvM,KAAK2S,SAAS2I,gBAAgBulG,MAAMt0G,IAC7C,OAAO,EAGT,MAAMmiB,EAAa1uB,KAAKs+H,WAAWvqB,gBAWnC,OAVA/zG,KAAK2S,SAASq8B,kBAAkBoY,mBAAmB76C,GAAQ7K,MAAMwtB,IAC/D,IAAIR,IACF,OAGF,MAAMw8B,EAAW+1E,GAA2B10H,EAAQ2iB,EAAMvjB,GAC1D3L,KAAKwwB,OAAO06B,OAIP,G,gSClFI,MAAMw2E,GAArB,cACU,KAAAC,QAAmC,IAAI/iH,IACvC,KAAA8P,YAAa,UAWd8vG,qBAAqBrgF,GAC1B,IAAI,MAAM+4C,KAAUl3F,KAAK2hI,QACvBzqC,EAAOsnC,qBAAqBrgF,GAIzB41D,gBAEL,OADA/zG,KAAK0uB,WAAW4sC,QACTt7D,KAAK0uB,WAAWld,MAGlB+sH,UAAUrnC,GACfl3F,KAAK2hI,QAAQtiI,IAAI63F,GAGZynC,iBAAiBiD,GACtB5hI,KAAK2hI,QAAQv0H,SAAS8pF,IACjBA,IAAW0qC,GACZ1qC,EAAO1zF,QAAO,GAAM,MAIpBo+H,GACF5hI,KAAK0uB,WAAW4sC,S,2SCjCP,MAAMumE,WAAuBjB,GAC1ChhI,YACEyzC,EACAirF,EACAgC,EACQ3tH,GAER9S,MACEwzC,EACAirF,EACA,mBACCn3H,IACC,MAAM+T,EAAU/T,EAAuBS,QAAQ2E,OAAOqO,WACzCzX,QAAQ4B,QAAQ4N,EAAS2I,gBAAgBC,QAAQL,IAASxZ,MAAM6W,IAC3E,IAAciyD,EAAVp5C,EAAM,GACP7Y,EAAKyzB,SACN5a,EAAM,IAAM7Y,EAAKyzB,UAEjB5a,EAAM7Y,EAAKwlC,YAAcxlC,EAAKylC,UAC9BwsB,EAAS,CACP59D,EAAG,2BACHjM,OAAQywB,EAAIzwB,OACZqjB,OAAQ,EACRyqC,QAASl2C,EAAK/H,KAIlB4gB,GAAO,IACPkvG,EAAUwB,cAAc1wG,EAAKo5C,SAvB3B,KAAA73D,SAAAA,EA6BH6tH,WAAW70H,EAAeY,EAAgBw1H,GAC/C,MAAMC,EAAUr2H,EAAMW,OACtB,GAAGX,EAAMhL,SAAWqhI,EAAQrhI,OAAQ,OAAO,EAE3C,MAAM+tB,EAAa1uB,KAAKs+H,WAAWvqB,gBAqBnC,OApBA/zG,KAAK2S,SAASq8B,kBAAkBizF,YAAY11H,GAAUA,EAAO8hB,WAAY2zG,EAASD,GAAUrgI,MAAW8Y,GAAY,mCACjH,IAAIkU,IAAc,OAElB,MAAMsd,EAAWg2F,EAAQthI,MAAM,GAAGmI,cAE5B+kC,EAAIpzB,EAAQG,KAAUpO,GAAW,mCACrC,MAAMgM,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,GACzD,IAAGgM,EAAKyzB,UAAYzzB,EAAKyzB,SAASnjC,gBAAkBmjC,EAIpD,MAAO,CACLz/B,OAAAA,EACAohC,YAAap1B,EAAKyzB,SAAW,IAAMzzB,EAAKyzB,cAAWhiC,QAIvDhK,KAAKwwB,cAAcrtB,QAAQC,IAAIwqC,IAAIjiB,OAAO6kB,gBAGrC,G,sTCjDI,MAAM0xF,WAAsBtzB,GAUzChvG,YAAYhB,GAOViB,MAAM,CACJuK,QAAStL,SAASC,cAAc,SAsE5B,KAAAojI,iBAAoB9hI,IAC1B,MAAM8G,EAAS9G,EAAEkH,QAAQ,GAAGJ,QACxB,EAAA24D,GAAA,GAAc34D,EAAQnH,KAAKoK,UAAYjD,IAAWnH,KAAKoiI,YACzD,EAAAn6G,EAAA,GAAY5nB,GACZL,KAAKwD,QAAO,MAvEd,EAAAwN,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKoK,QAAQhL,UAAUC,IAAI6iI,GAAct+E,YACzC5jD,KAAKoK,QAAQnH,MAAMC,QAAU,OAE7BlD,KAAKqvG,qBAAqBrvG,KAAKoiI,SAAUpiI,KAAKiJ,gBAC9CjJ,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,wBAAwB,EAAOuM,OAAAA,KAAY,mCACzEvM,KAAKuM,SAAWA,IACdvM,KAAKqiI,qBAAuBriI,KAAKivG,mBAC5BjvG,KAAKwwB,WAGb,WAA2B9uB,MAAK,KAC9B1B,KAAKsiI,2BAMHjzH,OA6CR,OA5CArP,KAAKqzC,SAAS3zC,OAAOM,KAAKoK,SAE1BpK,KAAKiJ,eAAe5J,IAAIW,KAAxBA,CAA8B,QAAQ,IAAW,yCACzCA,KAAKwwB,SAER,OACDxwB,KAAKuiI,cAAgBviI,KAAKiJ,eAAe5J,IAAIP,SAAS8rC,KAAjC5qC,CAAuC,aAAcA,KAAKmiI,iBAAkB,CAACx6H,SAAS,EAAO2rB,SAAS,IAC3HtzB,KAAKiJ,eAAe5J,IAAIW,KAAxBA,CAA8B,SAAS,KACrCA,KAAKiJ,eAAe3I,OAAON,KAAKuiI,iBAC/B,CAAC/6H,MAAM,UAIdxH,KAAKiJ,eAAe5J,IAAIW,KAAKoK,QAA7BpK,CAAsC,SAAUK,IAC9C,MAAM8G,GAAS,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,OACzC,IAAIA,EACF,OAGF,MAAMlH,EAAOkH,EAAOS,QAAQ3H,MACtB,OAACsM,GAAUvM,KAEV,+BADAC,EAEH8uF,GAAkB,CAChB/kD,aAAc,2BACdnrC,OAAQ,CACN0sC,QAAS,MAEXmC,mBAAoB,oCACnBhsC,MAAK,KACN1B,KAAK2S,SAAS40B,mBAAmBi7F,YAAYj2H,EAAQ,aAMvDvM,KAAK2S,SAAS40B,mBAAmBozF,SAASpuH,EAAQpF,EAAOS,QAAQnI,MAKrEO,KAAKwD,QAAO,MAGP3D,MAAMwP,OAWFizH,kB,0CACX,MAAM/c,QAAoBvlH,KAAKyiI,iBACV,4BAAlBld,EAAY34G,GACZ24G,EAAY/sG,OAAOikH,QACnBlX,EAAY/sG,OAAOs0D,OACpBy4C,EAAY/sG,OAAOs0D,MAAO,EAC1B9sE,KAAKsgI,UAAUjnB,iBAAiBkM,EAAYt4G,SAIlCw1H,iB,gDACZ,OAAsG,QAA9F,SAAMziI,KAAK2S,SAAS40B,mBAAmBm7F,8BAA8B1iI,KAAKuM,SAASg5G,mBAAW,QAAI,CACxG34G,EAAG,wBAIM4jB,OAAO+0F,G,+CACCv7G,IAAhBu7G,IACDA,QAAoBvlH,KAAKyiI,kBAG3BziI,KAAKoK,QAAQuoB,YAAc,GAE3B,IAAI,MAAMpN,KAAOggG,EAAYj7E,KAAM,CACjC,MAAMjmC,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI6iI,GAAct+E,WAAa,QAE7C,IAAI,MAAM/kD,KAAU0mB,EAAI4nB,QAAS,CAC/B,MAAMs3C,EAAM3lF,SAASC,cAAc,UACnC0lF,EAAIrlF,UAAUC,IAAI6iI,GAAct+E,WAAa,UAAW,QACxD,EAAAjrB,EAAA,GAAa8rD,GAAK,EAAA7rD,GAAA,GAAc/5B,EAAOY,OACvCglF,EAAI78E,QAAQnI,KAAOZ,EAAOY,KAC1BglF,EAAI78E,QAAQ3H,KAAOpB,EAAO+N,EAC1BvI,EAAI3E,OAAO+kF,GAGbzkF,KAAKoK,QAAQ1K,OAAO2E,OAIXg+H,kBAAkB9c,G,qDACVv7G,IAAhBu7G,IACDA,QAAoBvlH,KAAKyiI,kBAG3B,MAAMnsF,EAAyB,sBAAlBivE,EAAY34G,KAAiF,QAAnD,EAAC24G,EAA8Cj7E,YAAI,eAAE3pC,QAO5G,OANAX,KAAKoiI,SAAShjI,UAAUoE,OAAO,OAAQ8yC,GAEpCA,GACDt2C,KAAKwD,QAAO,IAGN8yC,KAGHwP,QAAQv5C,GACbvM,KAAKuM,OAASA,EAEdvM,KAAKqiI,oBACLriI,KAAKsiI,mBA1JQ,GAAA1+E,WAAa,iB,yBCQ9B,MAAM,GAAkB,gBAGT,MAAM++E,WAAqBnG,GAQxC58H,YACEyzC,EACAirF,EACQl8F,EACAzvB,GAER9S,MAAM,CACJwzC,SAAAA,EACAirF,WAAAA,EACAH,SAAU,KACVvB,WAAY,CAAC,UAAW,aACxBvmF,SAAWlvC,IACT,IAAIA,EAAQ,OAAO,EACnB,MAAM,OAACoF,EAAM,MAAEq5G,EAAK,QAAEgd,GAAW5iI,KAAK6K,KAAKjD,QAC3C,OAAO5H,KAAKoiC,KAAKriC,MAAMyhI,gBAAe,KACpC,MAAMqB,GAAoB,EAAAC,GAAA,GAAYF,EAAUz7H,EAAuBS,QAAQm7H,UAC/E/iI,KAAK2S,SAASo7F,qBAAqBi1B,iBAAiBz2H,EAAOsO,WAAY+qG,EAAOid,EAAmB,OAAF,wBAC1F7iI,KAAKoiC,KAAK61F,2BAAyB,CACtC9mB,YAAY,KAGdnxG,KAAKoiC,KAAKriC,MAAMo0H,eAAc,GAAM,SAlBlC,KAAA/xF,KAAAA,EACA,KAAAzvB,SAAAA,EAwCH,KAAAswH,YAAc,CAAM12H,EAAgBy/B,EAAkBrgC,KAAkB,O,EAAA,K,OAAA,E,EAAA,YAC7E,MAAM+iB,EAAa1uB,KAAKs+H,WAAWvqB,gBAE7Bx/D,QAAav0C,KAAK2S,SAAS2I,gBAAgBwyF,gBAAgB9hE,GACjE,IAAItd,IACF,KAAM,eAGR,GAAc,SAAX6lB,EAAK3nC,EACN,KAAM,YAGR,MAAM0jB,EAAgBtwB,KAAK2S,SAASo7F,qBAAqBC,iBAAiBzhG,EAAQgoC,EAAK/jC,GAAI7E,GAAOjK,MAAMwhI,IACtG,IAAIx0G,IACF,KAAM,eAGL1uB,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGd,MAAMxE,EAAO7K,KAAK6K,KAAK9G,YACvB8G,EAAKjD,QAAQ2E,OAAS,GAAKA,EAC3B1B,EAAKjD,QAAQg+G,MAAQ,GAAKrxE,EAAK/jC,GAC/B3F,EAAKjD,QAAQg7H,QAAU,GAAKM,EAAWC,SAEvC,MAAMC,EAAc,IAAIj4B,GAAY,KAAM,GAAiBnrG,KAAK8L,YAAY,GAE5E9L,KAAKyuB,cAAc1jB,QACnB/K,KAAK8sG,qBAAqB/hG,QAE1B,MAAM6jB,EAA+B,GAC/By0G,IAAcH,EAAW1qH,OAAO8qH,QAEtC,IAAI,MAAMvkH,KAAQmkH,EAAW34G,QAAS,CACpC,MAAMrpB,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI,wBACxB6B,EAAU0G,QAAQm7H,SAAWhkH,EAAKvO,GAElC,MAAMq2G,EAAUwc,OAAYr5H,EAAYlL,SAASC,cAAc,OAS/D,GARG8nH,IACDA,EAAQznH,UAAUC,IAAI,gCAEtB6B,EAAUxB,OAAOmnH,IAGnBh8G,EAAKnL,OAAOwB,GAERmiI,EAsBFniI,EAAU9B,UAAUC,IAAI,iBAtBX,CACbwnH,EAAQznH,UAAUC,IAAI,UACtB,EAAAs5B,EAAA,GAAakuF,GAAS,EAAAjuF,GAAA,GAAc,IAAI7Z,EAAKjQ,MAAMxC,QAAQ,KAE3D,MAAMwC,EAAQhQ,SAASC,cAAc,OACrC+P,EAAM1P,UAAUC,IAAI,+BACpB,EAAAs5B,EAAA,GAAa7pB,GAAO,EAAA8pB,GAAA,GAAc7Z,EAAKjQ,QAEvC,MAAM6+B,EAAc7uC,SAASC,cAAc,OAC3C4uC,EAAYvuC,UAAUC,IAAI,qCAC1B,EAAAs5B,EAAA,GAAagV,GAAa,EAAA8a,GAAA,GAAa1pC,EAAK4uB,YAAa,CACvD41F,YAAY,EACZtqE,SAAS,KAGX/3D,EAAUxB,OAAOoP,EAAO6+B,GAExB,MAAM61F,EAAY1kI,SAASC,cAAc,OACzCykI,EAAUpkI,UAAUC,IAAI,2BAExBwL,EAAKnL,OAAO8jI,GAKd,GAAc,oBAAXzkH,EAAKnS,GACN,GAAGmS,EAAKkO,OAAoD,IAA3ClO,EAAKkO,MAAMuC,UAAUhZ,QAAQ,UAAiB,CAC7D,IAAIojH,EACD/S,GACD+S,EAAiB96H,SAASC,cAAc,OACxC8nH,EAAQnnH,OAAOk6H,IAEfA,EAAiB14H,EAGnB04H,EAAex6H,UAAUC,IAAI,mBAC7BgkI,GAAazJ,EAAex6H,UAAUC,IAAI,oBAE1CW,KAAKyuB,cAAc5c,KAAK,CACtBxN,IAAKnD,EACLC,KAAM,IACG0uB,EAAA,WAA4B,CACjC4zG,KAAM,EACN9nH,SAAU,CACR/O,EAAG,uBACHqpD,YAAcl3C,EAAKkO,MAAkCgpC,YACrD3vC,IAAKvH,EAAKkO,MAAM3G,KAElBtlB,KAAM+d,EAAKkO,MAAMjsB,KACjByrB,SAAU1N,EAAKkO,MAAMuC,YACpB9tB,MAAM0iC,IACP,MAAMhd,EAAQ,IAAIH,MAClBG,EAAMhoB,UAAUC,IAAI,gBACpB,EAAAqkI,GAAA,GAAkBt/F,GAAM1iC,MAAMiiI,IAC5Bx8G,GAAsByyG,EAAgBxyG,EAAOu8G,GAAS,gBAM3D,CACL,MAAM31G,EAAQjP,EAAKjgB,UAA0BigB,EAAKc,MAClD,GAAI,CAAC,UAAW,OAAgCzY,SAAU4mB,MAAAA,OAAK,EAALA,EAAsB/tB,OAASojI,GACvF,EAAA1+F,GAAA,GAAuB3W,GAEL,QAAfA,EAAM/tB,KACPmjI,EAAY/jI,IAAI2uB,EAAO9sB,GACA,YAAf8sB,EAAM/tB,OACdiB,EAAU9B,UAAUC,IAAI,iBACxBW,KAAK8sG,qBAAqBR,cAAct+E,EAAO9sB,EAAW0tB,GACrC,IAAlBZ,EAAM4X,SACP5lC,KAAK8sG,qBAAqBP,mBAAmBrrG,SAG5C,GAAG8sB,EAAO,CACf,MAAMhtB,EAAOqiI,EAAY,QAAKr5H,EAC9Bq5H,GAAaniI,EAAU9B,UAAUC,IAAI,oBACrCivB,GAAU,CACRzO,MAAOmO,EACP9sB,UAAWmiI,EAAYniI,EAAY2lH,EACnC/mG,SAAU9e,EACV+e,UAAW/e,EACX0tB,WAAAA,EACAD,cAAezuB,KAAKyuB,cACpBG,aAAAA,MAMR,OAAOzrB,QAAQC,IAAIwrB,GAAcltB,MAAK,KACpC,IAAIgtB,IAEF,YADA00G,EAAYr4H,QAIdF,EAAKzL,UAAUoE,OAAO,aAAc6/H,GACpCx4H,EAAKzL,UAAUoE,OAAO,iBAAkB6/H,GACxCrjI,KAAKkB,UAAU9B,UAAUoE,OAAO,aAAc6/H,GAQ9C,MAAM3iE,EAAS1gE,KAAK6K,KAAKjH,cAEzB,GADA88D,EAAO/tC,YAAc,GAClBuwG,EAAWU,UAAW,CACvB,MAAMC,GAAgB,OAAO,8DAC7B,EAAAlrG,EAAA,GAAakrG,GAAe,EAAAjrG,GAAA,GAAcsqG,EAAWU,UAAUnkI,QAC/D,QAAiBokI,GAAgBxjI,IAC/BL,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAAC9nG,OAAAA,IACrCvM,KAAK2S,SAASo7F,qBAAqB+1B,WAAWv3H,EAAQgoC,EAAK/jC,GAAI0yH,EAAWU,UAAUjZ,gBAEtFjqD,EAAOhhE,OAAOmkI,GAEhBnjE,EAAOhhE,OAAOM,KAAK6K,KAAOA,GAEvB7K,KAAKojI,aACNpjI,KAAKojI,YAAY75G,SAEnBvpB,KAAKojI,YAAcA,EACnBA,EAAY55G,SAERxpB,KAAK6+H,iBACP7+H,KAAK6+H,eAAiB,KACpB,GAAG7+H,KAAK6K,KAAKzL,UAAUiG,SAAS,cAAe,CAC7C,MAAM9D,EAASvB,KAAK6K,KAAKI,kBAAoBokB,EAAA,2BAAuCrvB,KAAK6K,KAAKI,kBAAoB,GAClHjL,KAAK6K,KAAK5H,MAAM1B,MAAQA,EAAQ,UAEhCvB,KAAK6K,KAAK5H,MAAM1B,MAAQ,IAG5B8tB,EAAA,mBAA4B,eAAgBrvB,KAAK6+H,iBAGnD7+H,KAAK6+H,iBAEL7+H,KAAKwD,QAAQ0/H,EAAW34G,QAAQ5pB,SAAWuiI,EAAWU,WACtD5jI,KAAK8L,WAAW24C,UAAY,QAIhC,MAAO,CAAClsC,KAAMg8B,EAAMjkB,cAAAA,I,YAjMyD,K,+QAlB7EtwB,KAAKkB,UAAU9B,UAAUC,IAAI,iBAE7BW,KAAKI,iBAAiB,WAAW,KAC/BgG,YAAW,KACTpG,KAAK8L,WAAW5K,UAAUujD,UAAY,IACrC,MAGLzkD,KAAKwgI,YAAa,EAAAp0F,GAAA,GAASpsC,KAAKijI,YAAa,KAAK,GAAM,GAExDjjI,KAAKI,iBAAiB,UAAU,KAC3BJ,KAAK6+H,iBACNxvG,EAAA,sBAA+B,eAAgBrvB,KAAK6+H,gBACpD7+H,KAAK6+H,oBAAiB70H,MAyMlBqF,OACRrP,KAAK6K,KAAO/L,SAASC,cAAc,OACnCiB,KAAK6K,KAAKzL,UAAUC,IAAI,yBAExBW,KAAKkB,UAAUxB,OAAOM,KAAK6K,MAE3B7K,KAAK8L,WAAa,IAAI,KAAW9L,KAAKkB,WACtClB,KAAKyuB,cAAgB,IAAInP,GACzBtf,KAAK8sG,qBAAuB,IAAIZ,GAAqBlsG,KAAKyuB,cAAe,GAAiBzuB,KAAK2S,W,eCrRpF,MAAMoxH,WAAwBnD,GAG3ChhI,YACEyzC,EACAitF,EACQ3tH,GAER9S,MAAMwzC,OAAUrpC,EATD,gBASyB7C,IACtC,MAAM7C,EAAY6C,EAAOjC,cAAc,IAAI07H,GAAuBI,gCAAgC18H,UAClG,OAAOg8H,EAAUkB,gBAAe,KAC9BlB,EAAUliB,aAAa95G,UAAYA,EACnCg8H,EAAUmB,aAAY,GACtBzhI,KAAKwD,QAAO,SAPR,KAAAmP,SAAAA,EAYHqxH,UAAU9oH,EAAgBwT,G,MAC/B,GAAG1uB,KAAKkb,SAAWA,KAAmB,QAAT,EAAAlb,KAAK6K,YAAI,eAAEI,mBAMxC,OADAjL,KAAKkb,OAASA,GACP,EAAAqlF,GAAA,GAAYvgG,KAAK2S,SAASq8B,kBAAkB+4C,WAAW7sE,IAAUgU,IACtE,IAAIR,IAAc,OAClB,MAAMw8B,EAAW+1E,GAA2B/lH,EAAOL,UAAS,GAAQqU,GAK9D1tB,EAA2B,GAAlB0pD,EAASvqD,OAHJ,EAEG,GAEvBX,KAAKkB,UAAU+B,MAAMmgD,YAAY,WAAY5hD,EAAS,MAEtDxB,KAAKwwB,OAAO06B,MAfZlrD,KAAKwD,QAAO,I,qCCxBH,SAAeygI,GAAqBC,G,qCACjD,MAAO,CACLj4G,OAAQi4G,EAAMj4G,OACd3c,OAAQ40H,EAAMj4G,aAAei4G,EAAM50H,OAAS40H,EAAM50H,S,+RAI/C,SAAS60H,GAAsBr6H,GACpC,OAAOA,EAAQpI,KAAKuiI,I,2SCSP,MAAMG,GAanBxkI,YACU+S,EACAgwE,EACAz2E,GAFA,KAAAyG,SAAAA,EACA,KAAAgwE,QAAAA,EACA,KAAAz2E,SAAAA,EAERlM,KAAK0uB,YAAa,UAClB1uB,KAAKiJ,eAAiB,IAAI,IAC1BjJ,KAAKyoB,YAGCA,YACNzoB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,iCAE7BW,KAAK6O,SAAW/P,SAASC,cAAc,OACvCiB,KAAK6O,SAASzP,UAAUC,IAAI,4BAA6B,6BAA8B,eAEvF,MAAMglI,EAAyC,CAAC,CAC9C5kI,KAAM,qBACNuoB,aAAShe,IAGX,IAAIs6H,EACJ,MAAMC,EAAsBrnH,IACvBA,IACDonH,EAAiBtkI,KAAK2jD,QAGxB,MAAMzb,EAAYloC,KAAK2jD,SAAW2gF,EAC5Bx6G,GAAW5M,GAAWgrB,EAAY,EAAI,GAE5C,QAAcloC,KAAK6O,SAAU,aAAcqO,EA9Cd,SA8CmDlT,EAAW8f,GACvFoe,IACF,QAAco8F,EAAgB,cAAepnH,EAhDlB,SAgDuDlT,EAAW8f,IAIjG,GAAiB,CACf5qB,UAAU,EACV+J,eAAgBjJ,KAAKiJ,eACrB/H,UAAWlB,KAAKkB,WACf,YAAamjI,GAAe,KAC7BE,GAAmB,MAClB,KACDA,GAAmB,MAGrBF,EAAc,GAAGj6H,QAAQhL,UAAUC,IAAI,wBACvCW,KAAKsuE,QAAUtuE,KAAKkB,UAAU6nB,kBAC9B/oB,KAAKsuE,QAAQlvE,UAAUC,IAAI,aAAc,gBACzCW,KAAKkB,UAAUxB,OAAOM,KAAK6O,UAGf21H,cAAchqH,G,0CAC1B,MAAM/Q,EAA6C+Q,EAAQG,KAAI,CAAM8pH,EAAcpmH,IAAQ,mCACzF,MAAMq/C,EAAc5+D,SAASC,cAAc,OAErC0qC,EAAW3qC,SAASC,cAAc,OAexC,OAdA0qC,EAASrqC,UAAUC,IAAI,0BACpBolI,EAAat9F,SACdsC,EAAS/pC,QAAO,QAAK,gCACb+kI,IAAiBzkI,KAAKuM,OAC9Bk9B,EAAS/pC,QAAO,QAAK,8BAErB+pC,EAAS/pC,aAAaixC,GAAqB8zF,EAAap2G,aAG1DqvC,EAAYh+D,OACV,IAAI44B,GAAU,CAAC/rB,OAAQk4H,IAAer6H,QACtCq/B,GAGK,CACLzhB,QAAS3J,EAAM,IAAW,mCACxB,MAAM+5E,EAAgBp4F,KAAKuM,OAC3BvM,KAAK0kI,mBAAmBD,GAExB,MAAM/1G,EAAa1uB,KAAK0uB,WAAWld,MAC7BmzH,EAAuB,KAC3B,GAAG3kI,KAAKykI,eAAiBA,IAAiB/1G,IAAc,OACxD,MAAMlU,EAAUxa,KAAK4kI,cAAclkI,SACnC,EAAAqR,EAAA,GAAiByI,EAASiqH,GAC1BjqH,EAAQ6E,QAAQolH,GAChBzkI,KAAKwkI,cAAchqH,IAGlB,+BACDpU,WAAWu+H,EAAsB,KAEjCA,IAIF3kI,KAAK2S,SAAS40B,mBAAmBs9F,kBAAkBzsC,EAAeqsC,WAChEz6H,EACJ0zD,YAAAA,QAIEvwB,QAAgBhqC,QAAQC,IAAIqG,GAC5B6kE,EAAU,GAAWnhC,GAC3BA,EAAQ//B,SAAQ,CAACvO,EAAQwf,KACvB,MAAM9R,EAASiO,EAAQ6D,GACjBslC,EAAS,IAAIrW,GACnBqW,EAAOvkD,UAAUC,IAAI,YAAa,sBAClCskD,EAAO9a,kBAAkB,CAACt8B,OAAAA,IAEtB8R,GACFslC,EAAOvkD,UAAUC,IAAI,UAGvBR,EAAOuL,QAAQvG,QAAQ8/C,MAGzBvyC,MAAMC,KAAKrR,KAAKsuE,QAAQxoD,UAAUplB,MAAM,GAAG0M,SAAS4yH,GAASA,EAAK1/H,WAClEN,KAAKsuE,QAAQ5uE,UAAU0R,MAAMC,KAAKi9D,EAAQxoD,cAG9Bg/G,aAAaL,EAAsB/F,G,0CAC/C,MAAM4F,EAAiBtkI,KAAK2jD,OAC5B,GAAG2gF,GACEA,EAAe/3H,SAAWk4H,EAC3B,OAIAH,IACF5F,GAAgB,GAGlB,IAAI50G,EAAU40G,EAAgB,EAAI,EAClC,MAAM74H,EAAW64H,EAAgB,EAlJF,IAmJzB/6E,EAAS3jD,KAAK2jD,OAAS,IAAIrW,GACjCqW,EAAOvkD,UAAUC,IAAI,6BAA8B,mBAC7CskD,EAAO9a,kBAAkB,CAC7B0E,UAAU,EACVhhC,OAAQk4H,KAGV,QAAc9gF,EAAQ,cAAc,EAAM99C,OAAUmE,EAAW8f,GAC5Dw6G,IACD,QAAcA,EAAgB,cAAc,EAAOz+H,GAAU,KAC3Dy+H,EAAehkI,WACdwpB,GAGL9pB,KAAKkB,UAAUxB,OAAOikD,MAGhB+gF,mBAAmBD,EAAsB/F,GAG/C,OAFA1+H,KAAKykI,aAAeA,EACpBzkI,KAAKkM,SAASu4H,GACPzkI,KAAK8kI,aAAaL,EAAc/F,GAGjCqG,mBAEN,OAAO/kI,KAAK2S,SAASm2C,aAAa9Z,kBAAkBg2F,eAAehlI,KAAKuM,OAAO8hB,YAAY3sB,MAAMwiI,IACxF,CACLj4G,OAAQi4G,EAAMj4G,OACd3c,OAAQ40H,EAAM50H,OAAO5N,MAAMujI,GAClBA,EAAYC,iBAAkB,EAAApsF,GAAA,GAAUmsF,EAAYC,sBAAmBl7H,QAMzEm7H,aAAazG,G,0CACxB,MAAMnyH,EAASvM,KAAKuM,OACpB,GAAGvM,KAAKolI,yBAA2BplI,KAAK2S,SAAS2/B,gBAAgB6G,UAAU5sC,IACzE,OAGF,MAAMmiB,EAAa1uB,KAAK0uB,WAAWld,KAAI,KAC7BxR,KAAKolI,iBAAmBplI,KAAKolI,kBAAoBA,KAGrD,UAAClkI,GAAalB,KACdqa,EAAS9N,EAAO8hB,WAChB/e,SAAgB60H,GAAmBnkI,KAAK+kI,qBAAqBz1H,OAG7D+1H,EAAuB3G,EAC1BpvH,aAAkBnM,UACnBu7H,OAAgB10H,GAGlB,MAAMs7H,EAAOD,IAAyB3G,EAEhC0G,EAAkBplI,KAAKolI,iBAAkB,EAAA7kC,GAAA,GAAYjxF,GAAcm1H,GAAiB,mCACxF,IAAI/1G,UAAiC1kB,IAAjBy6H,EAA4B,OAGhD,SADMzkI,KAAK0kI,mBAAmBD,EAAc/F,IACxChwG,IAAc,OAElB1uB,KAAK2S,SAASoH,gBAAgBwrH,UAAUlrH,GAAQ3Y,MAAM6qE,IACpD,IAAI79C,IAAc,OAElB,MAAMlU,EAAU+xD,EAAM5xD,KAAK45B,IAAS,EAAAuE,GAAA,GAAUvE,KAC9Cv0C,KAAK4kI,cAAgBpqH,EAAQ9Z,SAE7B,EAAAqR,EAAA,GAAiByI,EAASiqH,GAC1BjqH,EAAQ6E,QAAQolH,GAChBzkI,KAAKwkI,cAAchqH,MAGrB,MAAM1V,EAAW,KACf9E,KAAK2iF,QAAQzhF,EAAWw9H,GAEpB1+H,KAAKwlI,gBACPxlI,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAqBuM,IACnDvM,KAAKuM,SAAWA,GACjBvM,KAAKq4B,YAITr4B,KAAKwlI,eAAgB,IAIzB,IAAGF,EAKH,OAAOxgI,EAJLA,SAaJ,OANAsgI,EAAgBl6G,SAAQ,KACnBlrB,KAAKolI,kBAAoBA,IAC1BplI,KAAKolI,qBAAkBp7H,MAIvBs7H,OAAJ,EACSF,KAIJ/sG,OAAOqmG,GACZ,OAAO1+H,KAAKmlI,aAAazG,GAAeh9H,MAAMoD,GAAaA,GAAYA,MAGlEgxH,UAAUvpH,GAMfvM,KAAK0uB,WAAW4sC,QAChBt7D,KAAKolI,qBAAkBp7H,EACvBhK,KAAKuM,OAASA,EAGTy8C,UACLhpD,KAAKkB,UAAUZ,SACfN,KAAK81H,YACL91H,KAAKiJ,eAAe0G,a,2SCxMxB,MACM81H,GAA4B,qDAInB,MAAMC,GA6HnB9lI,YACUwiC,EACAgyE,EACAzhG,GAFA,KAAAyvB,KAAAA,EACA,KAAAgyE,aAAAA,EACA,KAAAzhG,SAAAA,EAvHF,KAAAgzH,QAAU,GACV,KAAAC,aAAe,EAiBf,KAAAC,cAIJ,GAeI,KAAAC,gBAA2B,KAW5B,KAAAjiE,WAAY,EACX,KAAAkiE,gBAAiB,EAGjB,KAAAC,gBAAkB,EAclB,KAAAC,UAAW,EACX,KAAAC,gBAAkB,GACT,KAAAC,YAAwB,GACxB,KAAAC,gBAA4B,GACrC,KAAAC,gBAAkB,GA+zBlB,KAAAC,oBAAuBjmI,IAC1BA,IACD,EAAA4nB,EAAA,GAAY5nB,GAGdL,KAAK+lI,gBAAiB,EACtB/lI,KAAKumI,SAASxjI,OACdyjI,GAAA,gBAAkC,IAG5B,KAAAC,gBAAkB,KACxB,MAAMC,EAAc,KAAqB,YAAc,SACvD1mI,KAAK2mI,mBAAmBvnI,UAAUoE,OAAOkjI,GAAa,IAGhD,KAAAE,iBAAmB,KACzB,MAAMF,EAAc,KAAqB,YAAc,SACvD1mI,KAAK2mI,mBAAmBvnI,UAAUoE,OAAOkjI,GAAa,IAOjD,KAAA1S,gBAAkB,CAAMlvH,EAAuB9E,KAAKyhI,YAAYv4H,KAAKlJ,MAAM,GAAO68F,EAAW,IAAIn3F,OAAW,mCACjH,MAAM,OAAC6G,GAAUvM,KAAKoiC,KAChB1T,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBAC/BqrB,EAAoB,WAAmB7yH,GAAUA,EAAO46B,iBAAkBnnC,KAAK2S,SAAS2I,gBAAgBurH,oBAAoBt6H,IAElI,IAAI4yH,GAActiC,GAAWzoF,IACvBsa,MAKDta,GAD4C,IAAzB1O,KAAKC,MAAQ,IAAO,KAExCyO,OAAYpK,GAGdhK,KAAKk0H,aAAe9/G,EACpBtP,IAEsB,cAAnB9E,KAAKoiC,KAAKniC,MAAwBmU,GACnChO,YAAW,KACLsoB,KAIJ1uB,KAAKo0G,aAAa0yB,cAAcv6H,KAC/B,MAEJ6yH,GAAmBlwF,UAgehB,KAAA63F,uBAAyB,KAC/B/mI,KAAKomI,gBAAgBv0H,KAAK7R,KAAKo+G,aAAa95G,WACrC,IAAMtE,KAAKqmI,gBAAkBrmI,KAAKo+G,aAAa95G,WAGhD,KAAA0iI,SAAW,CAAC3mI,EAAUJ,EAAuBgnI,MACnD,EAAAh/G,EAAA,GAAY5nB,GAEZ,IAAI+D,EAAOpE,KAAKo+G,aAAa95G,UAC7B,GAAGF,GAAQA,IAAS6iI,EAAU,CAC5BjnI,KAAKimI,UAAW,EAEhB,IAAIiB,EAAgB,EACpB,EAAG,CACDpoI,SAASgsC,YAAY7qC,GAAM,EAAO,MAClC,MAAMknI,EAAcnnI,KAAKo+G,aAAa95G,UACtC,GAAGF,IAAS+iI,GACV,KAAKD,EAAgB,EACnB,WAGFA,EAAgB,EAGlB9iI,EAAO+iI,QACD/iI,IAAS6iI,GAEjBjnI,KAAKimI,UAAW,IA0GZ,KAAAmB,uBAA0B/mI,IAEhC,MAAMgnI,EAA4C,CAChD,KAAQ,OACR,KAAQ,SACR,KAAQ,YACR,KAAQ,gBACR,KAAQ,YACR,KAAQ,WAGPrnI,KAAKo0G,aAAakzB,gBACnBD,EAAiB,KAAI,QAGvB,MAAM5lG,EAAOphC,EAAEohC,KACT8lG,EAAgBF,EAAW5lG,GAejC,GAbkB3iC,SAAS+/D,eACdnuB,WAAWpkC,OAAO3L,QAAU4mI,IAE3B,SAAT9lG,EACDzhC,KAAKo0G,aAAakzB,cAAcE,iBAEhCxnI,KAAKunI,cAAcA,IAGrB,EAAAt/G,EAAA,GAAY5nB,IAIF,SAATohC,EAAiB,CAClB,IAAIr9B,EAAOpE,KAAKo+G,aAAa95G,UAE1BjE,EAAEonI,SACAznI,KAAKmmI,YAAYxlI,SAClBX,KAAKomI,gBAAgBv0H,KAAKzN,GAC1BA,EAAOpE,KAAKmmI,YAAYv1H,MACxB5Q,KAAKgnI,SAAS3mI,EAAG,OAAQ+D,GACzBA,EAAOpE,KAAKo+G,aAAa95G,UACzBtE,KAAKkmI,gBAAkBlmI,KAAKmmI,YAAYxlI,OAASyD,EAAO,GACxDpE,KAAKqmI,gBAAkBjiI,IAItBpE,KAAKomI,gBAAgBzlI,QAAYX,KAAKqmI,iBAAmBjiI,IAASpE,KAAKqmI,kBACxErmI,KAAKmmI,YAAYt0H,KAAKzN,GACtBA,EAAOpE,KAAKomI,gBAAgBx1H,MAC5B5Q,KAAKgnI,SAAS3mI,EAAG,OAAQ+D,GAGzBpE,KAAKqmI,gBAAkBrmI,KAAKkmI,gBAAkBlmI,KAAKo+G,aAAa95G,aAMhE,KAAAojI,eAAkBrnI,I,MAexB,MAAOG,MAAOmnI,EAAW10E,SAAU20E,EAAgB,SAAEzH,GAAYb,GAAsBt/H,KAAK85H,kBAAkB/5H,OAGxGS,GAAQ,EAAAqnI,GAAA,GAAcF,EAAWC,GAAkB,GACnD30E,GAAW,EAAA60E,GAAA,GAAcF,GAAkB,EAAAG,GAAA,GAAcvnI,IAI5DR,KAAKkmI,kBAAoBlmI,KAAKimI,UAAYjmI,KAAKo+G,aAAa95G,YAActE,KAAKkmI,kBAChFlmI,KAAKkmI,gBAAkB,GACvBlmI,KAAKmmI,YAAYxlI,OAAS,GAG5B,MAAMqnI,KAA4G,QAAhB,EAAAhoI,KAAKi0H,mBAAW,eAAEjmG,QAAsC,wBAA7BhuB,KAAKi0H,YAAYjmG,MAAMphB,IAAgCqmD,EAAStnC,QAAQtrB,GAAc,qBAARA,EAAEuM,GAAoC,yBAARvM,EAAEuM,IAC3O,GAAGo7H,EAAYrnI,OACb,IAAI,MAAM6pE,KAAUw9D,EAAa,CAC/B,IAAI1hH,EACJ,GAAgB,yBAAbkkD,EAAO59D,EACR0Z,EAAMkkD,EAAOlkD,SAIb,GAFAA,EAAMqhH,EAAUjnI,MAAM8pE,EAAOxmD,OAAQwmD,EAAOxmD,OAASwmD,EAAO7pE,SAEvD2lB,EAAIlf,SAAS,aAAckf,EAAIlf,SAAS,YAC3C,SAMJ,GAAGpH,KAAK2lI,UAAYr/G,EAAK,CACvBtmB,KAAK2lI,QAAUr/G,EAEf,MAAMxc,EAAU9J,KAAKioI,kBAAoBjoI,KAAK2S,SAASu1H,mBAAmBC,WAAW7hH,GAAK5kB,MAAMusB,IAC3FjuB,KAAKioI,oBAAsBn+H,IAAS9J,KAAKioI,uBAAoBj+H,GAC7DhK,KAAK2lI,UAAYr/G,IACF,YAAf2H,EAAQrhB,GAGT5M,KAAKooI,WAAW,WAAW,QAAUn6G,EAAQy3C,WAAaz3C,EAAQnf,OAAS,UAAWmf,EAAQ0f,aAAe1f,EAAQ3H,KAAO,WACrHtmB,KAAKqoI,UACZroI,KAAK8lI,gBAAkB73G,GACfjuB,KAAK8lI,iBACb9lI,KAAKsoI,qBAKX,WAEMtoI,KAAK2lI,UACb3lI,KAAK2lI,QAAU,UACR3lI,KAAKqoI,UACZroI,KAAK8lI,gBAAkB,KAEpB9lI,KAAKk4H,WACNl4H,KAAKuoI,aAELvoI,KAAKm4H,eAKT,GADiBwP,EAAUr7H,OAqBpB,CACL,MAAM4H,EAAOxO,KAAKC,MACfuO,EAAOlU,KAAK4lI,cAAgB,MAC7B5lI,KAAK4lI,aAAe1xH,EACpBlU,KAAK2S,SAAS40B,mBAAmBC,UAAUxnC,KAAKoiC,KAAK71B,OAAQ,CAACK,EAAG,6BAGhE5M,KAAKwoI,aACNxoI,KAAKwoI,YAAYhlI,QAAO,QA3BvBxD,KAAK4lI,cACN5lI,KAAK2S,SAAS40B,mBAAmBC,UAAUxnC,KAAKoiC,KAAK71B,OAAQ,CAACK,EAAG,4BAGhE5M,KAAKo0G,aAAakzB,eACnBtnI,KAAKo0G,aAAakzB,cAAchxF,OAK/Bx3C,SAAS+xG,gBAAkB7wG,KAAKo+G,cAEjCh4G,YAAW,KACNtH,SAAS+xG,gBAAkB7wG,KAAKo+G,cACjCp+G,KAAKyoI,2BAEN,GAeJzoI,KAAKwoI,aACNxoI,KAAK0oI,0BAGH1oI,KAAK2oI,WACP3oI,KAAK4oI,qBAGP5oI,KAAK6oI,kBAAkBlB,EAAWxH,EAAUltE,GAE5CjzD,KAAK8oI,iBA0EA,KAAAvI,gBAAkB,CAAC/6F,EAAetlC,KACvCF,KAAK8hI,cAAct8F,EAAO2jE,GAAwB3jE,GAAQtlC,IA0HpD,KAAA6oI,eAAuB1oI,GAAa,mCAG1C,IAFA,EAAA4nB,EAAA,GAAY5nB,IAERL,KAAKumI,UAAYvmI,KAAK6jE,YAAc7jE,KAAKo2H,gBAAkBp2H,KAAKgpI,YAAchpI,KAAK2oI,UAClF3oI,KAAK6jE,UACFn+D,KAAKC,MAAQ3F,KAAKgmI,gBAr6DN,IAs6DdhmI,KAAKsmI,sBAELtmI,KAAKumI,SAASxjI,OAGhB/C,KAAKyhI,kBAEF,CACL,GAAGzhI,KAAKoiC,KAAK71B,OAAOkpC,qBAAuBz1C,KAAKoiC,KAAK+2E,QAAQ,eAE3D,YADAxtE,GAAM85F,IAIRzlI,KAAKsgI,UAAUlhI,UAAUC,IAAI,cAC7B,EAAAgjE,GAAA,KAEAriE,KAAKumI,SAAS77G,QAAQhpB,MAAK,KACzB1B,KAAKipI,qBAAuBzxG,GAAA,mBAC5Bx3B,KAAK+lI,gBAAiB,EAEtB/lI,KAAKkpI,cAAa,GAClB1C,GAAA,gBAAkC,GAElC,MAAM2C,EAAmB,KACvB,IAAIj8F,GAAU,sBAAuB,CACnClD,aAAc,2BACd0D,mBAAoB,iCACpBP,QAAS,CAAC,CACR5B,QAAS,4BACTzmC,SAAU,MACR,QAAmB9E,KAAKopI,mBAEzB,CACD79F,QAAS,WACTunC,UAAU,MAEX5jC,QAGLlvC,KAAKqpI,yBAA2BrpI,KAAKiJ,eAAe5J,IAAIP,SAAS8rC,KAAjC5qC,CAAuC,aAAcK,KAC/E,EAAAs5B,GAAA,GAAgBt5B,EAAE8G,OAAQ,gBAAkB,EAAAwyB,GAAA,GAAgBt5B,EAAE8G,OAAQ,0BACxE,EAAA8gB,EAAA,GAAY5nB,GACZ8oI,OAED,CAAC71G,SAAS,EAAM3rB,SAAS,IAE5B2I,EAAA,WAAiCtQ,KAAKspI,wBAA0B,CAC9DrpI,KAAM,QACN0R,MAAO,KACLvL,YAAW,KACT+iI,MACC,IAEI,KAIXnpI,KAAKgmI,gBAAkBtgI,KAAKC,MAE5B,MAAM4jI,EAAyCvpI,KAAKumI,SAASgD,WAGvDC,EAFUD,EAAWx+G,QAEF0+G,iBACzBF,EAAWG,QAAQF,GAEnBA,EAASG,QAAU,GAEnB,MAAMC,EAAgB,IAAIl9G,WAAW88G,EAASK,mBACxCrnI,EAA6B,IAAvBonI,EAAcjpI,OAE1B,IAAIyE,EAAI,KACN,IAAIpF,KAAK6jE,UAAW,OAEpB2lE,EAASM,qBAAqBF,GAE9B,IAAI3lH,EAAM,EACV2lH,EAAcx8H,SAAS5M,IACrByjB,GAAOzjB,KAGT,IAAImpB,EAAWhnB,KAAKC,IAAI,EAAIqhB,EAAMzhB,EAXxB,KAcVxC,KAAK+pI,eAAe9mI,MAAMkzB,UAAY,SAASxM,KAE/C,IAAI9Q,EAAOnT,KAAKC,MAAQ3F,KAAKgmI,gBACzBgE,EAAKnxH,EAAO,IAEZ2kC,EAAYrsB,GAAStY,EAAO,KAAQ,KAAO,KAAOlW,KAAKE,MAAMmnI,EAAK,KAAKtpI,OAAO,GAElFV,KAAKiqI,aAAahrG,UAAYue,GAE9B,SAAQp4C,IAGVA,OACCyI,OAAOxN,IACR,OAAOA,EAAEoD,MACP,IAAK,kBACHkoC,GAAM,0CACN,MAGF,IAAK,mBACHA,GAAMtrC,EAAEgN,SACR,MAGF,QACEK,QAAQC,MAAM,wBAAyBtN,EAAGA,EAAEoD,KAAMpD,EAAEgN,SACpDs+B,GAAMtrC,EAAEgN,SAIZrN,KAAKkpI,cAAa,GAClBlpI,KAAKsgI,UAAUlhI,UAAUkB,OAAO,oBAK9B,KAAAgoI,eAAiB,CAAMjoI,EAAWu3H,IAAoB,mCAK5D,GAJGv3H,IACD,EAAA4nB,EAAA,GAAY5nB,GAGXL,KAAK8lI,gBAAiB,CACvB,MAAMH,EAAU3lI,KAAK2lI,QACrB,IAAIuE,GAAa,EAcjB,GAbGlqI,KAAKk4H,mBAEEl4H,KAAKuoI,aAGb2B,GAAa,GAIflqI,KAAK2lI,QAAUA,EACf3lI,KAAKqoI,WAAY,EACjBroI,KAAK8lI,gBAAkB,KAEpBoE,EAAY,OAGjB,GAAuB,SAApBlqI,KAAKk4H,aAA0BN,EAAO,CACvC,MAAMvqH,EAAUrN,KAAKi0H,YACfzzH,GAAQ,EAAAqnI,GAAA,GAAc7nI,KAAK85H,kBAAkBt5H,MAAO,IAC1D,GAAG6M,EAAQA,UAAY7M,EAWrB,YAVA,IAAI0sC,GAAU,kBAAmB,CAC/BC,QAAS,CAAC,CACR5B,QAAS,wBACTzmC,SAAU,KACR9E,KAAKsoI,oBAAet+H,GAAW,MAGnC0jC,mBAAoB,0BACnBwB,OAMPlvC,KAAKm4H,cACLn4H,KAAK8oI,mBAGC,KAAAqB,cAAiB9pI,IAGvB,IAFA,EAAA4nB,EAAA,GAAY5nB,IAER,EAAAs5B,GAAA,GAAgBt5B,EAAE8G,OAAQ,SAC9B,GAAuB,YAApBnH,KAAKk4H,WAA0B,CAChC,MAAM,gBAACkS,GAAmBpqI,KACvBoqI,GAAmB,OAAuBA,EAAgBlpI,UAAU9B,UAAUiG,SAAS,WACxF,eAAkC+kI,EAAgBlpI,eAExB,UAApBlB,KAAKk4H,WACbl4H,KAAKoiC,KAAK20E,aAAa/2G,KAAK86H,cACA,SAApB96H,KAAKk4H,YACbl4H,KAAKoiC,KAAK20E,aAAa/2G,KAAK2oI,YAj9D9B3oI,KAAKiJ,eAAiB,IAAI,IAGrBwf,YACLzoB,KAAKsgI,UAAYxhI,SAASC,cAAc,OACxCiB,KAAKsgI,UAAUlhI,UAAUC,IAAI,aAAc,QAE3CW,KAAKglE,eAAiBlmE,SAASC,cAAc,OAC7CiB,KAAKglE,eAAe5lE,UAAUC,IAAI,wBAElCW,KAAKqqI,mBAAqBvrI,SAASC,cAAc,OACjDiB,KAAKqqI,mBAAmBjrI,UAAUC,IAAI,wBAEtCW,KAAKsqI,YAAcxrI,SAASC,cAAc,OAC1CiB,KAAKsqI,YAAYlrI,UAAUC,IAAI,eAAgB,sBAE/CW,KAAKqqI,mBAAmB3qI,OAAOM,KAAKsqI,aAEpC,MAAM1vD,EAAOytC,KACbroH,KAAKsqI,YAAY5qI,OAAOk7E,GAExB,MAAM2vD,EAAkBvqI,KAAKuqI,gBAAkBzrI,SAASC,cAAc,OACtEwrI,EAAgBnrI,UAAUC,IAAI,eAAgB,qBAE9C,MAAMmrI,EAAuBxqI,KAAKwqI,qBAAuB1rI,SAASC,cAAc,OAChFyrI,EAAqBprI,UAAUC,IAAI,eAAgB,0BAEnDW,KAAKglE,eAAetlE,OAAOM,KAAKqqI,mBAAoBE,EAAiBC,GACrExqI,KAAKsgI,UAAU5gI,OAAOM,KAAKglE,gBAE3BhlE,KAAKyqI,UAAY,EAAa,CAACxrI,KAAM,aAAcN,UAAW,+CAC9DqB,KAAKglE,eAAetlE,OAAOM,KAAKyqI,YAEhC,QAAiBzqI,KAAKyqI,WAAYpqI,KAChC,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKoiC,KAAKqJ,QAAQqwE,kBACjB,CAAC7yG,eAAgBjJ,KAAKiJ,iBAqEzB,MAAM6N,EAAI9W,KAAK0qI,iBAAmB5rI,SAASC,cAAc,OACzD+X,EAAE1X,UAAUC,IAAI,qBAAsB,sBACtCW,KAAKglE,eAAetlE,OAAOoX,GAGtBwiG,uBACLt5G,KAAK6lI,cAAc3kI,UAAYpC,SAASC,cAAc,OACtDiB,KAAK6lI,cAAc3kI,UAAU9B,UAAUC,IAAI,iBAE3CW,KAAK6lI,cAAc8E,QAAU,EAAW,IACxC3qI,KAAK6lI,cAAc+E,UAAY,EAAW,qBAAsB,CAAC1rI,UAAU,IAE3Ec,KAAK6lI,cAAc3kI,UAAUxB,OAAOM,KAAK6lI,cAAc8E,QAAS3qI,KAAK6lI,cAAc+E,WAInF,MAAMC,EAAoB,KACxBC,GAAmB,EACZ9qI,KAAK+qI,uBAGRC,EAAqB,KACzBF,GAAmB,GAGfV,EAAgDpqI,KAAKoqI,gBAAkB,GAC7E,IAAIU,GAAmB,EACvB,MAAMG,EAA0C,CAC9Cb,EAAgB7vG,WAAa,CAC3B96B,KAAM,kCACNuoB,QAAS6iH,EACTrhG,cAAe,IAAI,KAAc,CAACJ,SAAS,KAE7CghG,EAAgBc,WAAa,CAC3BzrI,KAAM,kCACNuoB,QAAS6iH,EACTrhG,cAAe,IAAI,KAAc,CAACJ,SAAS,KAE7CghG,EAAgBe,YAAc,CAC5B1rI,KAAM,wCACNuoB,QAASgjH,EACTxhG,cAAe,IAAI,KAAc,CAACJ,SAAS,KAE7CghG,EAAgBgB,YAAc,CAC5B3rI,KAAM,wCACNuoB,QAASgjH,EACTxhG,cAAe,IAAI,KAAc,CAACJ,SAAS,KAE7CghG,EAAgBiB,WAAa,CAC3B5rI,KAAM,oCACNuoB,QAAS,KACPhoB,KAAKsrI,0BAEPrsI,KAAM,YAGJssI,EAAiBnB,EAAgBlpI,UAAY,GAAW+pI,EAAgBjrI,KAAKiJ,gBAG7E6c,EAAW1U,MAAMC,KAAKk6H,EAAezlH,UA4E3C,GAxEM,CAAC,CACLmU,SAAUnU,EAASplB,MAAM,EAAG,GAC5BwL,SAAU,CAAC1L,EAAOH,KAChB,MAAM+oC,KAAa5oC,EAChBsqI,IACD9qI,KAAKwrI,0BAA4BpiG,GAGnC,MAAMqiG,EAAazrI,KAAK6lI,cAAc3kI,UAAUgE,cAAc,gBAC9D,GAAGumI,EAAY,CACb,MAAMl6H,EAAKk6H,EAAW1iH,kBAChBhd,EAAI,iBAAiBwF,GACrBs6B,EAA2Bu+F,EAAgB7vG,WAAWiP,cAAcJ,QAAU,yBAA2B,wBAC/Gr9B,EAAE8D,IAAMg8B,EACR9/B,EAAEssB,YAGL,CACD4B,SAAUnU,EAASplB,MAAM,EAAG,GAC5BwL,SAAW1L,IACT,MAAM4oC,KAAa5oC,EACnB,IAAIuqD,EAEFA,EADC3hB,QAA6Cp/B,IAAlChK,KAAKwrI,yBACbxrI,KAAKwrI,yBAA2BpB,EAAgBc,WAAad,EAAgB7vG,WAE7E6O,EAAUghG,EAAgB7vG,WAAa6vG,EAAgBc,WAG7DngF,EAAEvhB,cAAcJ,SAAU,KAGvBh8B,SAAS+yB,IACd,MAAMj/B,EAAY+nC,GAAU9I,EAAMlG,SAAStf,KAAKta,IACvC,CACLa,UAAWb,EACXN,MAAOM,EAAE6E,cAAc,aAEvBi7B,EAAMj0B,UAEJ2hD,EAAK/uD,SAASC,cAAc,MAClCmC,EAAUxB,OAAOmuD,GACjB09E,EAAe7rI,OAAOwB,MAGxBqqI,EAAe7rI,OAAO0qI,EAAgBiB,WAAWjhI,SAE7C,OACmBpK,KAAK0rI,aAAe,IAAI98B,GAAc,CACzDxkG,QAASmhI,KAIbnB,EAAgBuB,WAAaV,EAAevqI,MAAM,GAAI,GACtDV,KAAK6lI,cAAc3kI,UAAUxB,OAAO6rI,GAEpCnB,EAAgBuB,WAAWv+H,SAAQ,CAAC29C,EAAG1sC,KACrC,MAAM,MAACte,GAASgrD,EAAEvhB,cAClBzpC,EAAME,KAAO,QACbF,EAAM0D,KAAO4a,EAAM,EAAI,SAAW,UAClCte,EAAMS,MAAQ,OAAQ6d,EAAM,MAK9Bre,KAAK4rI,kBAAoB9sI,SAASC,cAAc,OAChDiB,KAAK4rI,kBAAkBxsI,UAAUC,IAAI,uBAErCW,KAAK2mI,mBAAqB,EAAW,wBAAyB,CAACznI,UAAU,IAEzEc,KAAK6rI,sBAAwB/sI,SAASC,cAAc,OACpDiB,KAAK6rI,sBAAsBzsI,UAAUC,IAAI,2BAEnB,SAAnBW,KAAKoiC,KAAKniC,KAAiB,CAC5BD,KAAK8rI,kBAAoBhtI,SAASC,cAAc,QAChDiB,KAAK8rI,kBAAkB1sI,UAAUC,IAAI,QAAS,WAAY,iBAC1DW,KAAKyqI,UAAU/qI,OAAOM,KAAK8rI,mBAE3B9rI,KAAK+rI,aAAe,EAAa,CAAC9sI,KAAM,UAAWN,UAAW,6CAC9DqB,KAAKgsI,qBAAuBltI,SAASC,cAAc,QACnDiB,KAAKgsI,qBAAqB5sI,UAAUC,IAAI,QAAS,WAAY,iBAC7DW,KAAK+rI,aAAarsI,OAAOM,KAAKgsI,sBAC9BhsI,KAAKglE,eAAetlE,OAAOM,KAAK+rI,eAEhC,QAAiB/rI,KAAK+rI,cAAe1rI,KACnC,EAAA4nB,EAAA,GAAY5nB,GACZ,MAAMquB,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBACrC/zG,KAAK2S,SAAS40B,mBAAmB0kG,gBAAgBjsI,KAAKoiC,KAAK71B,QAAQ7K,MAAMuL,IACnEyhB,KAIDzhB,GACDjN,KAAKoiC,KAAK20E,aAAa9pG,QAG1B,CAAChE,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAKksI,aAAe,EAAW,qCAAsC,CAAChtI,UAAU,KAEhF,QAAiBc,KAAKksI,cAAe7rI,IACnCL,KAAKo0G,aAAa0yB,cAAc9mI,KAAKoiC,KAAK71B,UACzC,CAACtD,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAiB,EAAEuM,OAAAA,MACjDvM,KAAKoiC,KAAK71B,SAAWA,GAIxBvM,KAAKksI,aAAa9sI,UAAUkB,OAAO,WAGrCN,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAoB,EAAEuM,OAAAA,MACpDvM,KAAKoiC,KAAK71B,SAAWA,GAIxBvM,KAAK2S,SAAS40B,mBAAmB6hF,qBAAqBppH,KAAKoiC,KAAK71B,QAAQ7K,MAAMlB,IAC5ER,KAAKksI,aAAa9sI,UAAUoE,OAAO,QAAShD,EAAMG,cAItDX,KAAKmsI,qBAAuB,EAAW,wCAAyC,CAACjtI,UAAU,IAC3Fc,KAAKosI,cAAgB,IAAIlK,GAAc,CACrC7uF,SAAUrzC,KAAKsqI,YACfrhI,eAAgBjJ,KAAKiJ,eACrB0J,SAAU3S,KAAK2S,SACfyvH,SAAUpiI,KAAKmsI,qBACf7L,UAAWtgI,OAEbA,KAAKiJ,eAAe5J,IAAIW,KAAKosI,cAA7BpsI,CAA4C,QAAQ,IAAMA,KAAKmsI,qBAAqB/sI,UAAUC,IAAI,YAClGW,KAAKiJ,eAAe5J,IAAIW,KAAKosI,cAA7BpsI,CAA4C,SAAS,IAAMA,KAAKmsI,qBAAqB/sI,UAAUkB,OAAO,YAEtGN,KAAKwoI,YAAc,IAAIzE,GAAgB/jI,KAAKsqI,YAAatqI,KAAMA,KAAK2S,UACpE3S,KAAKqsI,kBAAoBvtI,SAASC,cAAc,OAChDiB,KAAKqsI,kBAAkBjtI,UAAUC,IAAI,4BAErC,MAAMitI,EAASxtI,SAASC,cAAc,OACtCutI,EAAOltI,UAAUC,IAAI,uCAErB,MAAMJ,EAAOe,KAAKusI,gBAAkBztI,SAASC,cAAc,OAC3DE,EAAKG,UAAUC,IAAI,qBAAsB,4BACzCitI,EAAO5sI,OAAOT,GACde,KAAKqsI,kBAAkB3sI,OAAO4sI,IAE9B,QAAiBtsI,KAAKqsI,mBAAoBhsI,KACxC,EAAA4nB,EAAA,GAAY5nB,GACIpB,EAAKG,UAAUiG,SAAS,eAEtCrF,KAAKwoI,YAAYhlI,QAAO,GACxBvE,EAAKG,UAAUkB,OAAO,gBAEtBN,KAAKwoI,YAAYxE,UAAUhkI,KAAKoiC,KAAK71B,OAAOqO,WAAY5a,KAAKoiC,KAAKqJ,QAAQsoE,iBAC1E90G,EAAKG,UAAUC,IAAI,iBAEpB,CAAC4J,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAKwoI,YAAYpoI,iBAAiB,WAAW,KAC3CnB,EAAKG,UAAUC,IAAI,iBAGrBW,KAAKwoI,YAAYpoI,iBAAiB,UAAU,KAC1CnB,EAAKG,UAAUkB,OAAO,iBAI1BN,KAAKwsI,kBAAoB,CAAC,CACxBvtI,KAAM,QACNQ,KAAM,iCACNuoB,QAAS,KACPhoB,KAAKysI,UAAUjsI,MAAQ,GACvB,MAAM4gF,EAAS,IAAI,KAA4Bz9D,KAAK,MACpD3jB,KAAKysI,UAAUjtI,aAAa,SAAU4hF,GACtCphF,KAAK44H,eAAiB,QACtB54H,KAAKysI,UAAU35F,SAEjB30B,OAAQ,IAAMne,KAAKoiC,KAAK+2E,QAAQ,eAC/B,CACDl6G,KAAM,WACNQ,KAAM,6BACNuoB,QAAS,KACPhoB,KAAKysI,UAAUjsI,MAAQ,GACvBR,KAAKysI,UAAU9nI,gBAAgB,UAC/B3E,KAAK44H,eAAiB,WACtB54H,KAAKysI,UAAU35F,SAEjB30B,OAAQ,IAAMne,KAAKoiC,KAAK+2E,QAAQ,eAC/B,CACDl6G,KAAM,OACNQ,KAAM,OACNuoB,QAAS,KACP,gBAAyB+tG,GAAiB/1H,KAAKoiC,MAAM8M,QAEvD/wB,OAAS5R,GAAWA,EAAOkpC,aAAez1C,KAAKoiC,KAAK+2E,QAAQ,gBAG9Dn5G,KAAK0sI,WAAa,GAAiB,CAACxtI,UAAU,EAAM+J,eAAgBjJ,KAAKiJ,gBAAiB,WAAYjJ,KAAKwsI,mBAC3GxsI,KAAK0sI,WAAWttI,UAAUC,IAAI,cAAe,gBAC7CW,KAAK0sI,WAAWttI,UAAUkB,OAAO,cAIjCN,KAAKiqI,aAAenrI,SAASC,cAAc,OAC3CiB,KAAKiqI,aAAa7qI,UAAUC,IAAI,eAEhCW,KAAKysI,UAAY3tI,SAASC,cAAc,SACxCiB,KAAKysI,UAAUxsI,KAAO,OACtBD,KAAKysI,UAAUE,UAAW,EAC1B3sI,KAAKysI,UAAUxpI,MAAMC,QAAU,OAE/BlD,KAAK4rI,kBAAkBlsI,UAAU,CAACM,KAAKqsI,kBAAmBrsI,KAAK2mI,mBAAoB3mI,KAAK6rI,sBAAuB7rI,KAAKksI,aAAclsI,KAAKmsI,qBAAsBnsI,KAAK0sI,WAAY1sI,KAAKiqI,aAAcjqI,KAAKysI,WAAW9gH,OAAO6kB,UAExNxwC,KAAKsqI,YAAY5qI,OAAOM,KAAK6lI,cAAc3kI,WAC3ClB,KAAK4sI,6BAA+B,IAAIlL,GACxC1hI,KAAK6sI,eAAiB,IAAIjO,GAAe5+H,KAAKsqI,YAAatqI,KAAK4sI,6BAA8B5sI,KAAK2S,UACnG3S,KAAK8sI,YAAc,IAAIzM,GAAYrgI,KAAKsqI,YAAatqI,KAAK4sI,6BAA8B5sI,KAAMA,KAAK2S,UACnG3S,KAAK+sI,eAAiB,IAAIxL,GAAevhI,KAAKsqI,YAAatqI,KAAK4sI,6BAA8B5sI,KAAMA,KAAK2S,UACzG3S,KAAKgtI,eAAiB,IAAInL,GAAe7hI,KAAKsqI,YAAatqI,KAAK4sI,6BAA8B5sI,KAAMA,KAAK2S,UACzG3S,KAAKitI,aAAe,IAAItK,GAAa3iI,KAAKsqI,YAAatqI,KAAK4sI,6BAA8B5sI,KAAKoiC,KAAMpiC,KAAK2S,UAC1G3S,KAAKsqI,YAAY5qI,OAAOM,KAAK4rI,mBAE7B5rI,KAAKopI,gBAAkB,EAAW,iDAElCppI,KAAKktI,iBAAmBpuI,SAASC,cAAc,OAC/CiB,KAAKktI,iBAAiB9tI,UAAUC,IAAI,sBAEpCW,KAAK+pI,eAAiBjrI,SAASC,cAAc,OAC7CiB,KAAK+pI,eAAe3qI,UAAUC,IAAI,iBAElCW,KAAKmtI,QAAU,EAAW,2DAC1BntI,KAAKmtI,QAAQ3oI,mBAAmB,aAAc,4MAO9CxE,KAAKktI,iBAAiBxtI,OAAOM,KAAK+pI,eAAgB/pI,KAAKmtI,SAEjC,cAAnBntI,KAAKoiC,KAAKniC,OACXD,KAAK21H,SAAW,IAAIJ,GAAS,CAC3BE,cAAe,KACbz1H,KAAK22H,YAAa,EAClB32H,KAAKyhI,eAEP/L,gBAAiB,KACf11H,KAAKg0H,qBAAgBhqH,IAEvBf,eAAgBjJ,KAAKiJ,eACrB2sH,SAAU,WACVC,iBAAkB71H,KAAKmtI,QACvB17H,OAAQ,KACEzR,KAAKo2H,kBAAoBjqC,OAAOzuE,KAAK1d,KAAKgpI,YAAYroI,SAIlEX,KAAKktI,iBAAiBxtI,OAAOM,KAAK21H,SAASA,WAG7C31H,KAAKglE,eAAetlE,OAAOM,KAAKopI,gBAAiBppI,KAAKktI,kBAEtD,wBAAuCltI,KAAK2mI,mBAAoB3mI,KAAKiJ,gBACrEjJ,KAAKiJ,eAAe5J,IAAI,GAAxBW,CAA2C,OAAQA,KAAKymI,iBACxDzmI,KAAKiJ,eAAe5J,IAAI,GAAxBW,CAA2C,QAASA,KAAK4mI,kBAEzD5mI,KAAKotI,0BAWLptI,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAoB,MAClDA,KAAK6sI,gBAAkB7sI,KAAK8sI,eAE7B9sI,KAAKqtI,cAAgB,GACrBrtI,KAAK6oI,qBAQJ7oI,KAAK85H,mBACN95H,KAAK85H,kBAAkBwT,iBAI3BttI,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,iBAAiB,EAAEuM,OAAAA,EAAQV,SAAAA,EAAU0hI,MAAAA,EAAO3V,MAAAA,MAC1E53H,KAAKoiC,KAAKv2B,WAAaA,GAAY7L,KAAKoiC,KAAK71B,SAAWA,GAC3DvM,KAAKs1G,SAASi4B,GAAO,EAAM3V,MAG7B53H,KAAKiJ,eAAe5J,IAAIW,KAAKo0G,aAA7Bp0G,CAA2C,iBAAkBoiC,IACxDpiC,KAAKoiC,OAASA,GACfpiC,KAAKwtI,eAITxtI,KAAKiJ,eAAe5J,IAAIW,KAAKo0G,aAA7Bp0G,CAA2C,iBAAiB,EAAEqR,KAAAA,EAAMixB,GAAAA,MAC/DtiC,KAAKoiC,OAAS/wB,EACfrR,KAAK4sI,6BAA6BpO,sBAAqB,GAC/Cx+H,KAAKoiC,OAASE,GACtBtiC,KAAK4sI,6BAA6BpO,sBAAqB,MAIrC,cAAnBx+H,KAAKoiC,KAAKniC,KACXD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAoB,EAAEuM,OAAAA,EAAQ4sB,KAAAA,MAC5Dn5B,KAAKoiC,KAAK71B,SAAWA,GAAU4sB,EAAK/xB,SAASpH,KAAK2oI,YACnD3oI,KAAKm0H,oBAITn0H,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,kBAAkB,EAAEuM,OAAAA,EAAQ+9C,KAAAA,MAC1DtqD,KAAKoiC,KAAK71B,SAAWA,IACnB+9C,EAAKnY,IAAInyC,KAAK2oI,YACf3oI,KAAKm0H,gBAGJn0H,KAAK86H,cAAgBxwE,EAAKnY,IAAInyC,KAAK86H,eACpC96H,KAAKm4H,YAAY,aASvBn4H,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,uBAAwB4zC,IACtDA,EAAQ5zC,KAAKoiC,KAAK71B,UAChBvM,KAAKy/G,aAAe,MACrBz/G,KAAK0gH,gBAEL1gH,KAAK0kE,QAAO,QAMpB,IACE1kE,KAAKumI,SAAW,IAAI,KAAJ,CAAa,CAG3BkH,kBAAmB,KACnBC,YAAa,EACbC,iBAAkB,EAClBC,cAAe,EACfC,aAAa,IAEf,MAAMpgI,GACNC,QAAQC,MAAM,8BAA+BF,GAG/CzN,KAAK8oI,gBAEL9oI,KAAKiJ,eAAe5J,IAAIW,KAAKysI,UAA7BzsI,CAAwC,UAAWK,IACjD,IAAIihF,EAASjhF,EAAE8G,OAA0Cm6E,MACrDA,EAAM3gF,SAIV,gBAAyBg4H,GAAe34H,KAAKoiC,KAAMhxB,MAAMC,KAAKiwE,GAAO5gF,QAASV,KAAK44H,gBACnF54H,KAAKysI,UAAUjsI,MAAQ,OACtB,IAkBH,QAAiBR,KAAKmtI,QAASntI,KAAK+oI,eAAgB,CAAC9/H,eAAgBjJ,KAAKiJ,eAAgBE,gBAAgB,IAEvGnJ,KAAKumI,YACN,QAAiBvmI,KAAKopI,gBAAiBppI,KAAKsmI,oBAAqB,CAACr9H,eAAgBjJ,KAAKiJ,iBAEvFjJ,KAAKumI,SAASuH,OAAS,KACrB9tI,KAAKkpI,cAAa,GAClBlpI,KAAKsgI,UAAUlhI,UAAUkB,OAAO,aAChCN,KAAK+pI,eAAe9mI,MAAMkzB,UAAY,IAGxCn2B,KAAKumI,SAASwH,gBAAmBC,IAgB/B,GAfGhuI,KAAKipI,uBACNjpI,KAAKipI,uBACLjpI,KAAKipI,0BAAuBj/H,GAG3BhK,KAAKqpI,2BACNrpI,KAAKiJ,eAAe3I,OAAON,KAAKqpI,0BAChCrpI,KAAKqpI,8BAA2Br/H,GAG/BhK,KAAKspI,0BACNh5H,EAAA,aAAmCtQ,KAAKspI,yBACxCtpI,KAAKspI,6BAA0Bt/H,GAG9BhK,KAAK+lI,eACN,OAGF,MAAM,OAACx5H,EAAM,SAAEV,GAAY7L,KAAKoiC,KAC1B04F,EAAe96H,KAAK86H,aAEpBj1H,GAAYH,KAAKC,MAAQ3F,KAAKgmI,iBAAmB,IAAO,EACxDiI,EAAW,IAAIC,KAAK,CAACF,GAAa,CAAC/tI,KAAM,cAK/CumI,GAAA,SAA4BwH,GAAY,GAAMtsI,MAAM4N,IAGlDk3H,GAAA,gBAAkC,GAGlCxmI,KAAK2S,SAAS40B,mBAAmB4mG,SAAS5hI,EAAQ0hI,EAAU,CAC1DG,gBAAgB,EAChB3T,SAAS,EACT50H,SAAAA,EACAs1B,SAAU7rB,EAAO6rB,SACjB8/F,UAAW3rH,EAAOgX,IAClBw0G,aAAAA,EACAjvH,SAAAA,EACAslG,YAAY,IAGdnxG,KAAKm0H,eAAc,GAAO,SAKhC,QAAiBn0H,KAAK6lI,cAAc+E,UAAW5qI,KAAKsoI,eAAgB,CAACr/H,eAAgBjJ,KAAKiJ,kBAC1F,QAAiBjJ,KAAK6lI,cAAc3kI,UAAWlB,KAAKmqI,cAAe,CAAClhI,eAAgBjJ,KAAKiJ,iBAEzFjJ,KAAK4oI,oBAAqB,EAAAx8F,GAAA,IAAS,IAAMpsC,KAAKwtI,aAAa,MAAM,GAAO,GAExExtI,KAAKquI,aAAc,OAAO,mEAC1BruI,KAAKquI,YAAY3uI,QAAO,QAAK,cAE7B,QAAiBM,KAAKquI,aAAa,KACjC,MAAM,WAAC5uB,GAAcz/G,KACrB,QAAkBgK,IAAfy1G,EACD,OAGF,MAAMj8G,EAASxD,KAAKsuI,6BAA8B,EAAAv/F,GAAA,GAAiB,CAAC/uC,KAAKquI,cAAc,GACjF9hI,EAASvM,KAAKoiC,KAAK71B,OACnBmiB,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,eAAc,IAC1C/zG,KAAKoiC,KAAK71B,SAAWA,GAAUvM,KAAKy/G,aAAeA,GAAcz/G,KAAKsuI,8BAAgC9qI,IAG/GxD,KAAK2S,SAAS40B,mBAAmBgnG,SAAShiI,EAAOqO,gBAAY5Q,EAAWy1G,GAAY/9G,MAAK,KACpFgtB,MACDlrB,IACAxD,KAAKsuI,iCAA8BtkI,EACnChK,KAAK0gH,sBAGR,CAACz3G,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAK0qI,iBAAiBhrI,OAAOM,KAAKquI,aAG7B1yB,yBACL37G,KAAKwuI,kBAAmB,OAAO,kEAAmE,CAACvvI,KAAM,UACzGe,KAAK0qI,iBAAiBhrI,OAAOM,KAAKwuI,kBAElCxuI,KAAKiJ,eAAe5J,IAAIW,KAAKwuI,iBAA7BxuI,CAA+C,SAAS,KACtD,MAAMuM,EAASvM,KAAKoiC,KAAK71B,OAEzB,IAAIghH,GAAgBhhH,EAAQ,GAAG,GAAM,KACnCvM,KAAKoiC,KAAKgyE,aAAatuD,UAGvB,MAAM2oF,EAAezuI,KAAKoiC,KAAKgyE,aAAahyE,KACzCqsG,EAAal4B,OAAO1/C,eACrB43E,EAAal4B,OAAO1/C,cAAc63E,uBAAuBlrI,QAAO,SAKtExD,KAAKsgI,UAAUlhI,UAAUC,IAAI,eAGxBsvI,QAAQC,EAAkCn+H,GAC/C,IAAIm+H,IAAwB5uI,KAAKglE,eAAe5lE,UAAUiG,SAAS,gBACjE,OAGF,GAAGupI,IAAwB5uI,KAAK6uI,cAC9B,OAUF,MAAMrE,EAAuBoE,GAAuB5uI,KAAK6uI,cACnDvsE,IAAassE,EACbE,EAAmB9uI,KAAK6uI,cAC9B,IAAuCtqE,EAAnCpuC,EAAY,GAAI44G,EAAe,GAEjC,MAAMC,EAAoBxE,EAAqB/jI,wBACzCwoI,EAAejvI,KAAKuqI,gBAAgB9jI,wBACpC+9D,EAAYyqE,EAAa1tI,MACzBkjE,EAAUuqE,EAAkBztI,MAElC,GAAGijE,IAAcC,EAAS,CACxB,MAAMyqE,EAAQ,EAAsB1qE,EAC9B2qE,GAAkB3qE,EAAYC,GAAW,EAG/C,GAFAF,EAAiByqE,EAAkBroI,KAAOsoI,EAAatoI,KAAOwoI,EAE3D7sE,IACDnsC,EAAY,cAAcouC,eAA4B2qE,KAGnDA,EAAQ,GAAG,CACZ,MAAME,EAAK,GACXL,EAAqBK,EAAKA,GAAM,EAAIF,GAAU,MAOtDlvI,KAAK6uI,cAAgBD,EAErB,MAAM/oI,EAAW4K,EAAU,IAAM,EAMjC,OALA,QAAczQ,KAAKglE,eAAgB,eAAgB1C,EAAUz8D,IAC7D,QAAc7F,KAAKqqI,mBAAoB,6BAA8B/nE,GAAYssE,GAAuBA,EAAoBxvI,UAAUiG,SAAS,uBAAwBQ,GACvK7F,KAAKsqI,YAAYrnI,MAAMkzB,UAAYA,EACnCn2B,KAAKsqI,YAAYrnI,MAAM8rI,aAAeA,EAE/B,CACL54G,UAAAA,EACA44G,aAAAA,EACAxqE,eAAgBuqE,IAEVF,GACAA,EAAoBxvI,UAAUiG,SAAS,uBACvCypI,IAAqB9uI,KAAKwqI,sBACvBsE,EAAiB1vI,UAAUiG,SAAS,wBACrB,GAAlBk/D,EAAuBA,EAC7BC,UAAAA,EACAC,QAAAA,GAISC,OAAOj0D,GAAU,G,0CAC5B,OAAOzQ,KAAK2uI,cAAc3uI,KAAKqvI,yBAA0B5+H,MAGpDiwG,cAAcjB,GAChBz/G,KAAKy/G,aAAeA,IAIvBz/G,KAAKy/G,WAAaA,EAClBz/G,KAAK0kE,QAAO,IAGD2qE,uBAAuB5vB,EAAaz/G,KAAKy/G,Y,0CACpD,OAAGz/G,KAAKoiC,KAAKkpB,UAAUC,YACdvrD,KAAKwqI,0BAEGxgI,IAAfy1G,WACQz/G,KAAKoiC,KAAK+2E,YACC,WAAnBn5G,KAAKoiC,KAAKniC,aACJD,KAAKoiC,KAAKq+E,uBAETzgH,KAAK0qI,sBANP,KA+CFlJ,eAAe18H,GACpB,MAA0B,cAAnB9E,KAAKoiC,KAAKniC,MAAwBD,KAAKg0H,gBAAgBlvH,IAAW,IAASA,KAAY,GAiCnF00G,iB,0CACX,IAAIx5G,KAAK8rI,kBACP,OAGF,MAAMtzG,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAct3D,KAAKoiC,KAAK71B,QACxEQ,EAAQyrB,MAAAA,OAAM,EAANA,EAAQ6nF,aAItB,GAHArgH,KAAK8rI,kBAAkB7sG,UAAY,IAAMlyB,GAAS,IAClD/M,KAAK8rI,kBAAkB1sI,UAAUoE,OAAO,mBAAoBxD,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKoiC,KAAK71B,QAAQ,IAElIvM,KAAKgsI,sBAA2C,SAAnBhsI,KAAKoiC,KAAKniC,KAAiB,CACzD,MAAMqvI,MAAiB92G,MAAAA,OAAM,EAANA,EAAQ+2G,yBAAyB/2G,EAAO6nF,cAC/DrgH,KAAKgsI,qBAAqB/sG,UAAYqwG,EAAc,GAAM92G,EAA4B,sBAAI,GAC1Fx4B,KAAK+rI,aAAa3sI,UAAUoE,OAAO,aAAc8rI,OAI9C9B,YACL,IAAIxtI,KAAKoiC,KAAK71B,QAAUvM,KAAK2oI,WAAgC,cAAnB3oI,KAAKoiC,KAAKniC,KAAsB,OAE1E,MAAM,MAACO,EAAK,SAAEyyD,IAAY,EAAAykE,GAAA,GAAa13H,KAAK85H,kBAAkB/5H,OAE9D,IAAIwtI,GACD/sI,EAAMG,QAAUX,KAAK86H,gBACtByS,EAAQ,CACN3gI,EAAG,eACHuG,MAAM,EAAAq8H,GAAA,IAAM,GACZniI,QAAS7M,EACTyyD,SAAUA,EAAStyD,OAASsyD,OAAWjpD,EACvCwO,OAAQ,CACNi3H,WAAYzvI,KAAKqoI,WAEnBlyB,gBAAiBn2G,KAAK86H,eAI1B96H,KAAK2S,SAASilE,iBAAiB83D,UAAU1vI,KAAKoiC,KAAK71B,OAAQvM,KAAKoiC,KAAKv2B,SAAU0hI,GAG1EvkF,UAGLhpD,KAAKiJ,eAAe0G,YAGfM,QAAQ0/H,GAAY,GACrB3vI,KAAKoiC,KAAK71B,SACZvM,KAAKsgI,UAAUlhI,UAAUC,IAAI,QAC7BW,KAAKyqI,UAAUrrI,UAAUC,IAAI,SAG/Bu/D,KAEA5+D,KAAK4lI,aAAe,EACpB5lI,KAAKy/G,gBAAaz1G,EAEfhK,KAAKsuI,8BACNtuI,KAAKsuI,8BACLtuI,KAAKsuI,iCAA8BtkI,GAGlChK,KAAKo+G,eACNp+G,KAAK4vI,aACLD,GAAa3vI,KAAKm4H,eAIT7iB,SAASi4B,EAAwBsC,GAAa,EAAMjY,GAAQ,G,0CACvE,IAAKA,KAAU,EAAAxB,GAAA,GAAap2H,KAAKo+G,eAAqC,cAAnBp+G,KAAKoiC,KAAKniC,KAAsB,OAAO,EAE1F,IAAIstI,KACFA,QAAcvtI,KAAK2S,SAASilE,iBAAiBk4D,SAAS9vI,KAAKoiC,KAAK71B,OAAQvM,KAAKoiC,KAAKv2B,WAqBhF,OAlBG+rH,IAIE53H,KAAKoiC,KAAKlhC,UAAU9B,UAAUiG,SAAS,qBACxCrF,KAAKqS,IAGPrS,KAAK85H,kBAAkBiW,UAAUp9G,YAAc,GAC/C3yB,KAAK85H,kBAAkBwT,aAAY,IAEjCttI,KAAKoiC,KAAKqJ,QAAQ0mE,sBAAwBhvG,QAAQ4B,WAA4BrD,MAAK,MACnF,UAAQ,KACN1B,KAAKm0H,wBAKJ,EAIX,MAAM6b,EC7nCK,SAAmBzC,GAChC,MAAM0C,GAAa,EAAAlI,GAAA,GAAcwF,EAAMlgI,SACjC6iI,EAAc3C,EAAMt6E,UAAY,GAChCkF,GAAgB,EAAA2vE,GAAA,GAAcoI,EAAYxvI,QAASuvI,GAEzD,OAAO,EAAA1kD,GAAA,IAAuB,EAAAC,GAAA,GAAc+hD,EAAMlgI,QAAS,CAAC4lD,SAAUkF,KDwnC/Cg4E,CAAU5C,GAE/B,OAAGvtI,KAAK85H,kBAAkBt5H,QAAUwvI,GAAgBhwI,KAAK86H,eAAiByS,EAAMp3B,mBAE7E05B,GACD7vI,KAAKm4H,cAGPn4H,KAAKqoI,UAAYkF,EAAM/0H,OAAOi3H,WAC3BlC,EAAMp3B,iBACPn2G,KAAKq5G,iBAAiBk0B,EAAMp3B,iBAG9Bn2G,KAAKowI,cAAcJ,EAAcH,EAAYA,IACtC,MAGDQ,eAGN,GAFArwI,KAAKykI,kBAAez6H,EAEE,SAAnBhK,KAAKoiC,KAAKniC,MAAsC,eAAnBD,KAAKoiC,KAAKniC,KAAuB,CAC/D,IAAIqwI,GAAc,EAClBtwI,KAAKuwI,OAAS,IAAInM,GAChBpkI,KAAK2S,UACL,CAACzR,EAAWw9H,KACV,IAAI50G,EAAU,EACV5oB,EAAU0C,gBACZ5D,KAAK4rI,kBAAkB/nI,QAAQ3C,GAC/B4oB,EAAU,GAGZ9pB,KAAKwwI,aAAa,MAAM,EAAM9R,EAAe50G,MAE9C26G,IACCzkI,KAAKykI,aAAeA,EAGjB6L,EACDA,GAAc,EAIhBtwI,KAAKywI,oBAAoB/uI,MAAMmO,IAC7B7P,KAAK0wI,8BAA8B7gI,cAKzC7P,KAAKuwI,YAASvmI,EAGhB,OAAOhK,KAAKuwI,OAGD72B,iBAAiB+F,G,0CAC5B,MAAMlzG,EAASvM,KAAKoiC,KAAK71B,QAEnB,gBAAC69H,EAAe,aAAE8B,EAAY,cAAEE,EAAa,SAAEzW,EAAQ,UAAE8U,EAAS,UAAEnK,EAAS,kBAAE+L,GAAqBrsI,KAEpG2wI,EAAiB3wI,KAAKuwI,OACtBA,EAASvwI,KAAKqwI,gBAGlBjiG,EACAs/E,EACA7M,EACA1H,EACAy1B,EACAgC,EACAC,EACAC,EACAC,SACQ5tI,QAAQC,IAAI,CACpBpD,KAAK2S,SAAS2/B,gBAAgBlE,YAAY7hC,GAC1CvM,KAAK2S,SAAS2/B,gBAAgBo7E,cAAcnhH,GAC5CvM,KAAK2S,SAAS2/B,gBAAgBuuE,MAAMt0G,GACpCvM,KAAKoiC,KAAK+2E,UACVn5G,KAAKqvI,uBAAuB5vB,GAC5B0kB,GAAmBnkI,KAAK2S,SAASm2C,aAAa9Z,kBAAkBoY,mBAAmB76C,IACnF2/H,EAAe/H,GAAmBnkI,KAAK2S,SAASm2C,aAAavhB,mBAAmB6hF,qBAAqB78G,SAAWvC,EAChHumI,GAAUA,EAAOza,UAAU91H,KAAKoiC,KAAK71B,QAASgkI,EAAOpL,cAAa,SAASn7H,EAC3EhK,KAAKgxI,4BAGDC,EAAiBjxI,KAAKo+G,mBAAqBp+G,KAAKywI,yBAAsBzmI,EAE5E,MAAO,KAsBL,GAnBAs2H,EAAUlhI,UAAUkB,OAAO,QAC3BmqI,EAAUrrI,UAAUoE,OAAO,eAAgB4qC,GAC3Cq8F,EAAUrrI,UAAUkB,OAAO,QAExBN,KAAK8rI,mBACN9rI,KAAKw5G,iBAGe,WAAnBx5G,KAAKoiC,KAAKniC,MACXqgI,EAAUlhI,UAAUoE,OAAO,UAAWkqH,GAIrC0c,IACDpqI,KAAKwrI,0BAA2B,EAChCpB,EAAgBe,YAAY3hG,cAAc5oC,kBAAiB,GAC3DwpI,EAAgB7vG,WAAWiP,cAAc5oC,kBAAiB,IAGzDsrI,GAAgB2E,EAAoB,CACrC3E,EAAa9sI,UAAUC,IAAI,QAC3B,MAAMqvB,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,iBACrC,EAAAxT,GAAA,GAAYswC,EAAmBvhI,QAAS6pB,IAClCzK,KAAiByK,GACrB+yG,EAAa9sI,UAAUoE,OAAO,QAAS21B,EAAKx4B,WAQhD,GAJGX,KAAK4rI,mBACN5rI,KAAKwwI,aAAa,MAAM,GAAO,GAG9BnE,IACDrsI,KAAKkxI,oBAAiBlnI,EACtBhK,KAAKwoI,YAAYhlI,QAAO,OAAMwG,GAAW,GACzChK,KAAK0oI,yBAAwB,GAC7B2D,EAAkB/rI,SACfugH,GAAO,CACR,MAAMnyF,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBAC/BzkG,EAASshI,EAActhI,QAC7B,EAAAixF,GAAA,GAAYjxF,GAASw4E,IACfp5D,KACJ1uB,KAAKmxI,kBAAkBrpD,IAAiCx4E,aAAkBnM,aAK7EwtI,GACDA,EAAe3nF,UAGd8nF,GACDA,IAGC1E,GACDA,EAActmF,QAAQv5C,GAGrBopH,GACDA,EAASG,UAAUvpH,GAGlBvM,KAAKo+G,aACNp+G,KAAKoxI,mBAAmBj4B,EAAS83B,EAAgBF,GACzC/wI,KAAKwuI,kBACbxuI,KAAKwuI,iBAAiB9uI,QAAO,QAAKguH,EAAgB,sBAAwB,yBAM5E1tH,KAAKy/G,WAAaA,EAElBz/G,KAAK2uI,QAAQC,GAAqB,OAM9B4B,aAAavwI,EAAyBqiE,EAAmBo8D,EAAyB50G,GACrF7pB,EACDD,KAAK4rI,kBAAkBhkI,QAAQoc,OAAS/jB,SAEjCD,KAAK4rI,kBAAkBhkI,QAAQoc,QAGxC,QAAchkB,KAAK4rI,kBAAmB,aAActpE,EAAUo8D,EAAgB,EAAI,SAAK10H,EAAW8f,GAG5FqnH,kBAAkBrpD,EAA6B42C,G,QACrD1+H,KAAKkxI,kBAA8C,QAA3B,EAAiB,QAAjB,EAAAppD,EAASglC,gBAAQ,eAAEqU,gBAAQ,eAAExgI,QACrDX,KAAK0oI,wBAAwBhK,GAGvBgK,wBAAwBhK,GAC9B,MAAM,kBAAC2N,EAAiB,eAAE6E,GAAkBlxI,KAEtCkvC,IAASgiG,GAAkBlxI,KAAKo2H,eACtC,IAAI8a,EAAgB,CAClB,IAAI7E,EAAkBzoI,cACpB,OAGFyoI,EAAkB/rI,SAGpB,MAAMgiE,EAAWpzB,EACXplB,EAAUuiH,EAAkBzoI,cAAgB,EAAI,EAElDyoI,EAAkBzoI,eACpB5D,KAAK4rI,kBAAkB/nI,QAAQwoI,GAGjCrsI,KAAKwwI,aAAa,WAAYluE,EAAUo8D,EAAe50G,GAG3C2mH,oB,0CACZ,MAAM,OAAClkI,EAAM,SAAEV,GAAY7L,KAAKoiC,KAChC,IAAIvyB,EAcJ,OAZEA,EADChE,EACK,iBACQ7L,KAAK2S,SAAS2/B,gBAAgBlE,YAAY7hC,IAClD,wBAEiBvC,IAAtBhK,KAAKykI,cAA8BzkI,KAAKykI,eAAiB,iBACpDzkI,KAAK2S,SAAS40B,mBAAmB8pG,mBAAmB9kI,IAEpD,kBAEA,UAGDsD,KAGD6gI,8BAA8B7gI,GAEpC,MAAM9D,EAAI,iBAAiB/L,KAAKo+G,cAC5BryG,GAIJA,EAAEgkF,iBAAiB,CAAClgF,IAAAA,IAGdmhI,0BACN,IAAIhxI,KAAKwsI,kBAAmB,OAC5B,MAAM,OAACjgI,EAAM,SAAEV,GAAY7L,KAAKoiC,KAChC,OAAOmO,GAAYvwC,KAAKwsI,mBAAoB3tI,GACnCA,EAAOsf,OAAO5R,EAAQV,KAI1BulI,mBAAmBj4B,EAAkB83B,EAA6B/zH,GACvE,MAAM,UAACojH,EAAS,WAAEoM,EAAU,aAAEtuB,GAAgBp+G,MACxC,OAACuM,EAAM,SAAEV,GAAY7L,KAAKoiC,KACfk+F,EAAUlhI,UAAUiG,SAAS,gBACxB8zG,IAEpBmnB,EAAUlhI,UAAUC,IAAI,iBACxBihI,EAAUlhI,UAAUoE,OAAO,aAAc21G,GACpCmnB,EAAUn7E,WACfm7E,EAAUlhI,UAAUkB,OAAO,kBAG7BN,KAAK0wI,8BAA8BO,GAEnCjxI,KAAKwsI,mBAAqBxsI,KAAKwsI,kBAAkBp/H,SAASvO,IACxDA,EAAOuL,QAAQhL,UAAUoE,OAAO,QAAS0Z,EAAQ9V,SAASvI,OAGxDs6G,GAGFiF,EAAa5+G,aAAa,kBAAmB,QAC7CQ,KAAKs1G,cAAStrG,GAAW,GAErBo0G,EAAa95G,WACftE,KAAK85H,kBAAkBwT,eANzBlvB,EAAaz5G,gBAAgB,mBAU5B+nI,IACDA,EAAWhkG,gBAAgB,YAAaxrB,EAAQvc,QAChD+rI,EAAWttI,UAAUoE,OAAO,gBAAiB0Z,EAAQvc,SAGvDX,KAAK8oI,gBAGCsE,0BACN,MAAMkE,EAAgBtxI,KAAK85H,kBAC3B95H,KAAK85H,kBAAoB,IAAI,IAAW,CACtC/rH,YAAa,UACbtK,KAAM,UACNgN,SAAS,IAGXzQ,KAAK85H,kBAAkB/5H,MAAMX,UAAUqB,QAAQ,oBAAqB,uBACpET,KAAK85H,kBAAkBiW,UAAU3wI,UAAUqB,QAAQ,oBAAqB,uBACxET,KAAKo+G,aAAep+G,KAAK85H,kBAAkB/5H,MAC3CC,KAAKo+G,aAAah/G,UAAUC,IAAI,gBAChCW,KAAKuxI,8BAEF,OACD,EAAAC,GAAA,GAA6BxxI,KAAKo+G,cAGjCkzB,GACDA,EAAcvxI,MAAM0+B,YAAYz+B,KAAK85H,kBAAkB/5H,OACvDuxI,EAAcvB,UAAUtxG,YAAYz+B,KAAK85H,kBAAkBiW,YAE3D/vI,KAAK6rI,sBAAsBnsI,OAAOM,KAAK85H,kBAAkB/5H,MAAOC,KAAK85H,kBAAkBiW,WAInFwB,8BACNvxI,KAAKiJ,eAAe5J,IAAIW,KAAKo+G,aAA7Bp+G,CAA2C,WAAYK,IACrD,MAAMwP,EAAMxP,EAAEwP,IACd,IAAG,EAAA4hI,GAAA,GAAsBpxI,IACvB,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKyhI,mBACA,GAAGphI,EAAEqxI,SAAWrxI,EAAEsxI,QACvB3xI,KAAKonI,uBAAuB/mI,QACvB,IAAY,WAARwP,GAA4B,aAARA,KAAwBxP,EAAEonI,SAGvD,GAFApnI,EAAEu0B,iBAES,WAAR/kB,EAAkB,CACnB,MAAMy1E,EAAQxmF,SAASsiE,cACjBriB,EAAMj5C,OAAO+4D,eAEnBymB,EAAMssD,SAAS5xI,KAAKo+G,aAAa1b,WAAW,IAAM1iG,KAAKo+G,aAAc,GACrE94B,EAAMusD,UAAS,GAEf9yF,EAAIggB,kBACJhgB,EAAI+yF,SAASxsD,QAEb,EAAAyzC,GAAA,GAAgB/4H,KAAKo+G,iBAKxB,OACD,QAAiBp+G,KAAKo+G,cAAe/9G,IACnCL,KAAKo0G,aAAa7kG,UAAU,GAE5B,WAAyB,KACxB,CAACtG,eAAgBjJ,KAAKiJ,iBA8B3BjJ,KAAKiJ,eAAe5J,IAAIW,KAAKo+G,aAA7Bp+G,CAA2C,QAASA,KAAK0nI,gBACzD1nI,KAAKiJ,eAAe5J,IAAIW,KAAKo+G,aAA7Bp+G,CAA2C,SAAS,KAClDA,KAAK6oI,uBAGe,SAAnB7oI,KAAKoiC,KAAKniC,MAAsC,eAAnBD,KAAKoiC,KAAKniC,MACxCD,KAAKiJ,eAAe5J,IAAIW,KAAKo+G,aAA7Bp+G,CAA2C,WAAW,KACjDA,KAAKoiC,KAAKqJ,QAAQ3/B,WAAW0hG,UAAUl3E,QACxCt2B,KAAK2S,SAAS40B,mBAAmBwqG,eAAe/xI,KAAKoiC,KAAK71B,OAAQvM,KAAKoiC,KAAKv2B,aAqC7E07H,cAActnI,EAAoBi2D,GACvC,MAEM87E,EAAsE,CAC1EzpH,KAAM,OACN0pH,OAAQ,SACRC,UAAW,YACXC,cAAe,gBACfC,UAAW,IAAMtzI,SAASgsC,YAAY,YAAY,EAP7B,yBAQrB+D,KAAMqnB,EAAO,IAAMp3D,SAASgsC,YAAY,cAAc,EAAOorB,GAAQ,IAAMp3D,SAASgsC,YAAY,UAAU,EAAO,MACjH6pE,QAAS,IAAM71G,SAASgsC,YAAY,YAAY,EAR7B,YAWrB,IAAIknG,EAAY/xI,GACd,OAAO,EAGT,MAAMohI,EAAU2Q,EAAY/xI,GAItBoyI,EAAeryI,KAAK+mI,yBACpBuL,EAAkB,GAuCxB,GAFAA,EAASzgI,KAAK/S,SAASgsC,YAAY,gBAAgB,EAAO,SAE9C,cAAT7qC,GAAiC,YAATA,EAAoB,CAC7C,IAAIsyI,GAAe,EAGnB,MAAMjnF,EAAYxlD,OAAO+4D,eACzB,IAAIvT,EAAUknF,YAAa,CACzB,MAAMltD,EAAQh6B,EAAUwlD,WAAW,GAC7B2hC,EAAM,KAAaxyI,GAEnB+/H,EAAO16C,EAAMotD,yBACf1S,EAAK9wE,WAA2B73C,QAAQo7H,EAAI75E,QAAWonE,aAAgBxsG,aAAewsG,EAAK3oH,QAAQo7H,EAAI75E,UACzG25E,GAAe,GAMhBA,EACDD,EAASzgI,KAAK7R,KAAKyoI,0BAEnB6J,EAASzgI,KAAyB,mBAAd,EAA2BwvH,IAAYviI,SAASgsC,YAAYu2F,GAAS,EAAO,YAGlGiR,EAASzgI,KAAyB,mBAAd,EAA2BwvH,IAAYviI,SAASgsC,YAAYu2F,GAAS,EAAO,OAWlG,OARAiR,EAASzgI,KAAK/S,SAASgsC,YAAY,gBAAgB,EAAO,UAG1DunG,IACGryI,KAAKo0G,aAAakzB,eACnBtnI,KAAKo0G,aAAakzB,cAAcqL,yBAG3B,EAGDlK,yBACN,OAAO3pI,SAASgsC,YAAY,YAAY,EAAO,UAsL1Cg3F,cAAc8Q,EAAoBC,EAA8BC,GAAW,GAChF,MAAOtyI,MAAOuyI,EAAS,SAAE5S,EAAQ,SAAEltE,GAAYqsE,GAAsBt/H,KAAKo+G,cACpErjD,EAAMolE,GAAY,EAAIA,EAAW4S,EAAUpyI,OAC3Cm5B,EAASi5G,EAAU3/G,OAAO,EAAG2nC,GAC7Bi4E,EAASD,EAAU3/G,OAAO2nC,GAE1B1jD,EAAUy7H,EAAWh5G,EAAO8+B,MAAM8sE,GAAUuN,uBAAyB,KAErEC,EAAa77H,EAAUA,EAAQiO,OAASjO,EAAQ,GAAG1W,OAAS0W,EAAQ,GAAG1W,QAAUm5B,EAAOn5B,OAExFwyI,EADYr5G,EAAOp5B,MAAM,EAAGwyI,GACLN,EAAaI,EAGpCI,GAAc,EAAArL,GAAA,GAAcgL,IAClC,EAAAjL,GAAA,GAAc70E,EAAUmgF,GAGxB,MAAMC,EAAeR,EAAelwI,KAAKH,IAAIqwI,EAAalyI,OAAQiyI,EAAWjyI,QAAUiyI,EAAWjyI,OAC5F2yI,EAA+B,GAClCT,IACDS,EAAYzhI,KAAKghI,GACjBA,EAAa7uH,OAASkvH,GAIxB,MAAMr6H,EAAOxB,EAAUg8H,EAAeh8H,EAAQ,GAAG1W,OAAS0yI,EAC1DpgF,EAAS7lD,SAASo9D,IACbA,EAAOxmD,QAAUkvH,IAClB1oE,EAAOxmD,QAAUnL,OAIrB,EAAAivH,GAAA,GAAc70E,EAAUqgF,GAEuC,CAC7D,MAAMC,EAAgD,CACpD3mI,EAAG,qBACHoX,OAAQkvH,EAAaG,EACrB1yI,OAAQ,GAGV,IAAI6yI,EAAqB,EACzB,IAAI,IAAI7yI,EAASsyD,EAAStyD,OAAQ6yI,EAAqB7yI,KACtCsyD,EAASugF,GACdxvH,OAASuvH,EAAYvvH,UAFgCwvH,GAOjEvgF,EAAS10C,OAAOi1H,EAAoB,EAAGD,GAKzC,MAAM/yI,GAAQ,EAAA+qF,GAAA,IAAuB,EAAAC,GAAA,GAAc2nD,EAAU,CAAClgF,SAAAA,KAC9DjzD,KAAK85H,kBAAkBl5H,iBAAiBJ,GAAO,GAE/C,MAAMizI,EAAQzzI,KAAKo+G,aAAal5G,cAAc,iBAC3CuuI,IEl3DQ,SAAoBzT,GAGjC,MAAM0T,EAAe1T,EAGrB,GAAqB,KAFrBA,EAAOA,EAAKvlC,iBAEJmP,SAAgB,CACtB,MAAM+pC,EAAU70I,SAAS80I,eAAe,IACxC5T,EAAK9wE,WAAWprD,aAAa6vI,EAAUD,EAAa1vI,aAAe0vI,EAAa1vI,YAAY4lG,WAAao2B,EAAKp2B,SAA0B8pC,EAAa1vI,YAA5B0vI,GACzH1T,EAAO2T,EAGT,GAAG7tI,OAAO+4D,cAAgB//D,SAASsiE,YAAa,CAC9C,MAAMkkB,EAAQxmF,SAASsiE,cACpB4+D,IACD16C,EAAMuuD,cAAc7T,GACpB16C,EAAMwuD,WAAW9T,GACjB16C,EAAMssD,SAAS5R,EAAMA,EAAKn2B,UAAUlpG,SAGtC2kF,EAAMusD,UAAS,GAEf,MAAM9yF,EAAMj5C,OAAO+4D,eACnB9f,EAAIggB,kBACJhgB,EAAI+yF,SAASxsD,IF21DXyuD,CAAWN,GACXA,EAAMnzI,UAIRN,KAAK0nI,iBAWOmB,kBAAkBroI,EAAgB2/H,EAAmBltE,G,0CAGjE,QAAajpD,IAAVxJ,EAAqB,CACtB,MAAM4E,EAAIk6H,GAAsBt/H,KAAK85H,kBAAkB/5H,OAAO,GAC9DS,EAAQ4E,EAAE5E,MACV2/H,EAAW/6H,EAAE+6H,SACbltE,EAAW7tD,EAAE6tD,SAOf,IAJiB,IAAdktE,IACDA,EAAW3/H,EAAMG,aAGHqJ,IAAbipD,EAAwB,CACzB,MAAM+gF,GAAS,EAAAnM,GAAA,GAAcrnI,EAAOyyD,GAAU,GAC9CA,GAAW,EAAA60E,GAAA,GAAc70E,GAAU,EAAA80E,GAAA,GAAciM,IAKnD,GAFAxzI,EAAQA,EAAME,MAAM,EAAGy/H,GAEpBngI,KAAKqtI,gBAAkB7sI,EACxB,OAGFR,KAAKqtI,cAAgB7sI,EAErB,MAAM6W,EAAU7W,EAAMo4D,MAAM8sE,GAAUuN,uBACtC,IAAIgB,EACJ,GAAG58H,EAAS,CACV,MAAMmzD,EAASvX,EAAS,GAExB,IAAItnD,EAAQ0L,EAAQ,GACpB,MAAMopH,EAAY90H,EAAM,GAExB,GAAG3L,KAAK6sI,gBACN,sCACM7sI,KAAKoiC,KAAK+2E,QAAQ,mBACV,wBAAd3uC,MAAAA,OAAM,EAANA,EAAQ59D,IAA8B49D,EAAO7pE,SAAWH,EAAMG,SAAW6pE,EAAOxmD,OAChFiwH,EAAcj0I,KAAK6sI,eACnB7sI,KAAK6sI,eAAe/N,cAAct+H,QAC7B,GAAiB,MAAdigI,EAAmB,CAC3B,MAAMsB,EAAW/hI,KAAKoiC,KAAKv2B,UAAW,EAAA67B,GAAA,GAAmB1nC,KAAKoiC,KAAKv2B,eAAY7B,SACtEhK,KAAKgtI,eAAexM,WAAW70H,EAAO3L,KAAKoiC,KAAK71B,OAAO46B,SAAW,MAAennC,KAAKoiC,KAAK71B,OAAQw1H,MAC1GkS,EAAcj0I,KAAKgtI,qBAEZ31H,EAAQ,IAAoB,MAAdopH,EAIf,6BACR90H,EAAQA,EAAMlL,QAAQ,OAAQ,IAC1BD,EAAMo4D,MAAM,mBAAsBp4D,EAAMo4D,MAAM,uBAAwBjtD,IACxEsoI,EAAcj0I,KAAK8sI,YACnB9sI,KAAK8sI,YAAYtM,WAAW70H,EAAO80H,YAP5BzgI,KAAK+sI,eAAevM,WAAW70H,EAAO3L,KAAKoiC,KAAK71B,WACvD0nI,EAAcj0I,KAAK+sI,gBAWzBkH,EAAcj0I,KAAKk0I,wBAAwB1zI,EAAOyzI,GAElDj0I,KAAK4sI,6BAA6BjO,iBAAiBsV,MAG7CC,wBAAwB1zI,EAAeyzI,GAC7C,IAAIE,GAAkB,EAEtB,IAAIF,EAAa,CACf,MAAMG,EAAc5zI,EAAMo4D,MAAM,4BAChC,GAAGw7E,EAAa,CACd,MAAMpoG,EAAWooG,EAAY,GACvBzoI,EAAQnL,EAAME,MAAM0zI,EAAY,GAAGzzI,QACzCwzI,EAAkBC,EAAY,GAAGzzI,SAAWH,EAAMG,OAElDszI,EAAcj0I,KAAKitI,aAEfjtI,KAAKq0I,cAKP,QAAcr0I,KAAKq0I,aAAc,QAAQ,EAAM,MAJ/Cr0I,KAAKq0I,aAAe,EAAW,8CAA+C,CAACn1I,UAAU,KACzF,EAAA+E,GAAA,GAAajE,KAAKq0I,cAAc,GAChCr0I,KAAK6rI,sBAAsBjoI,cAAcE,aAAa9D,KAAKq0I,aAAcr0I,KAAK6rI,sBAAsB7nI,cAKtGhE,KAAKitI,aAAazM,WAAWxgI,KAAKoiC,KAAK71B,OAAQy/B,EAAUrgC,GAAOjK,MAAK,EAAE6W,KAAAA,EAAM+X,cAAAA,MACxE6jH,GAAmB57H,EAAK+7H,yBACzBt0I,KAAKo+G,aAAax2G,QAAQ2sI,kBAAoBh8H,EAAK+7H,wBAGrDhkH,EAAc5uB,MAAK,MACjB,QAAc1B,KAAKq0I,aAAc,QAAQ,EAAO,WAEjDxmI,MAAM8vB,GAAA,IAcb,OAVIw2G,UACKn0I,KAAKo+G,aAAax2G,QAAQ2sI,kBAGhCN,IAAgBj0I,KAAKitI,cACnBjtI,KAAKq0I,eACN,QAAcr0I,KAAKq0I,aAAc,QAAQ,EAAO,KAI7CJ,EAGD/K,aAAa1oI,GAChBR,KAAK6jE,YAAcrjE,KAItB,QAAcR,KAAKsgI,UAAW,eAAgB9/H,EAAO,KACrDR,KAAK6jE,UAAYrjE,EACjBR,KAAK8oI,iBA+LCwC,yBACN,GAAGtrI,KAAKw0I,qBAAsB,OAC9Bx0I,KAAKw0I,sBAAuB,EAE5B,MAAMxL,GAAa,EAAAvxF,GAAA,GAAKz3C,KAAKgpI,YACvBT,EAAavoI,KAAKuoI,WACxBvoI,KAAKm4H,cACLn4H,KAAK8oI,gBACL,IAAI53F,GAAW,EACD,IAAI4sB,GAAakrE,GAAY,KACzC93F,GAAW,KAGP9wC,iBAAiB,SAAS,KAC9BJ,KAAKw0I,sBAAuB,EAExBtjG,GACFq3F,OAKOqH,WAAW6E,GAAc,EAAMC,GAAY,EAAMC,EAAa,I,0CACzE,GAAG71I,SAAS+xG,gBAAkB7wG,KAAKo+G,cAAgB,GAAAv8D,iBAAkB,CACnE,MAAM91C,EAAIjN,SAASC,cAAc,SACjCD,SAAS8rC,KAAKlrC,OAAOqM,IACrB,EAAA6oI,GAAA,GAAqB7oI,GACrB/L,KAAK85H,kBAAkBl5H,iBAAiB+zI,IACxC,EAAAC,GAAA,GAAqB50I,KAAKo+G,cAC1BryG,EAAEzL,cAEFN,KAAK85H,kBAAkBl5H,iBAAiB+zI,GAGvC,OAOD30I,KAAKkmI,gBAAkB,GACvBlmI,KAAKmmI,YAAYxlI,OAAS,EAC1BX,KAAKomI,gBAAgBzlI,OAAS,EAC9BX,KAAKqmI,gBAAkB,IAGzB,IAAIppH,GAAM,EACPw3H,IACDx3H,QAAYjd,KAAKs1G,cAAStrG,GAAW,KAGnCiT,GAAOy3H,GACT10I,KAAK0nI,oBAIFtR,eACL,OAAO,EAAAA,GAAA,GAAap2H,KAAKo+G,cAGpB0qB,gBACL,IAAI7pI,EAEJ,MAAMm3H,EAAep2H,KAAKo2H,eAEPn3H,EAAhBe,KAAK2oI,UAAkB,QACjB3oI,KAAKumI,UAAYvmI,KAAK6jE,YAAcuyD,GAAgBp2H,KAAKgpI,WAAsC,cAAnBhpI,KAAKoiC,KAAKniC,KAAuB,WAAa,OACvH,SAEZ,CAAC,OAAQ,SAAU,OAAQ,YAAYmN,SAASrB,IAC9C/L,KAAKmtI,QAAQ/tI,UAAUoE,OAAOuI,EAAG9M,IAAS8M,MAGzC/L,KAAKksI,cACNlsI,KAAKksI,aAAa9sI,UAAUoE,OAAO,OAAQ4yH,GAG1Cp2H,KAAKmsI,sBACNnsI,KAAKmsI,qBAAqB/sI,UAAUoE,OAAO,OAAQ4yH,GAIhDjC,cAAcyb,GAAa,EAAMiF,GAChB,cAAnB70I,KAAKoiC,KAAKniC,MACXD,KAAK2S,SAAS40B,mBAAmBwqG,eAAe/xI,KAAKoiC,KAAK71B,OAAQvM,KAAKoiC,KAAKv2B,UAAU,GAGxF7L,KAAKk0H,kBAAelqH,EACpBhK,KAAK22H,gBAAa3sH,EAElB,MAAMxJ,EAAQR,KAAK85H,kBAAkBt5H,OACpB,EAAAunI,GAAA,GAAcvnI,GACoCmrB,QAAQ6+C,GAAwB,uBAAbA,EAAO59D,IAC/EQ,SAASo9D,IACrB,MAAMhlC,GAAQ,SAAoBglC,EAAO4+B,SACzCppG,KAAK2S,SAAS63F,gBAAgBsqC,gBAAgBtvG,MAG7CoqG,IACD5vI,KAAK2lI,QAAU,UACR3lI,KAAKqoI,UACZroI,KAAK8lI,gBAAkB,KACvB9lI,KAAK4vI,eAGJiF,GAAcjF,IACf5vI,KAAKm4H,cAGPn4H,KAAK8oI,gBAGArH,YAAY7J,GAAQ,GACzB,MAAM,UAAC+Q,EAAS,KAAEvmG,GAAQpiC,KAC1B,GAAiB,cAAdoiC,EAAKniC,OAAyB23H,IAAU+Q,EAEzC,YADA3oI,KAAKg0H,kBAIP,MAAM,OAACznH,GAAU61B,GACX,UAACimG,GAAaroI,KACd06H,EAAgB16H,KAAKoiC,KAAK61F,2BAE1B,MAACz3H,EAAK,SAAEyyD,IAAY,EAAAykE,GAAA,GAAa13H,KAAK85H,kBAAkB/5H,OAG9D,GAAG4oI,EAAW,CACZ,MAAMt7H,EAAUrN,KAAKi0H,YACrB,IAAGzzH,EAAM8L,SAAUe,EAAQ2gB,MAUzB,YAFA,IAAIiwC,GAAoB1xD,EAAQ,CAACo8H,GAAYvmG,EAAKniC,MAPlDD,KAAK2S,SAAS40B,mBAAmB0sF,YAAY5mH,EAAS7M,EAAO,CAC3DyyD,SAAAA,EACAo1E,UAAWA,IAGbroI,KAAKm0H,qBAMC3zH,EAAM8L,SACdtM,KAAK2S,SAAS40B,mBAAmBozF,SAASpuH,EAAQ/L,EAAO,OAAF,sBACrDyyD,SAAAA,GACGynE,GAAa,CAChB2N,UAAWA,EACXhjE,QAASrlE,KAAKioI,uBAAoBj+H,EAAYhK,KAAK8lI,gBACnD30B,YAAY,KAGQ,cAAnBnxG,KAAKoiC,KAAKniC,KACXD,KAAKm0H,eAAc,GAEnBn0H,KAAKm0H,eAAc,GAAO,IAM9B,GAAGn0H,KAAKgpI,WAAY,CAClB,MAAMA,GAAa,EAAAvxF,GAAA,GAAKz3C,KAAKgpI,YAE3B,IAAI,MAAMxlE,KAAcwlE,EACtBhpI,KAAK2S,SAAS40B,mBAAmBwtG,gBAAgBxoI,EAAQi3D,EAAW3oD,WAAYmuH,EAAWxlE,GAAa,OAAF,wBACjGk3D,GAAa,CAChBsa,WAAYh1I,KAAKoqI,iBAAmBpqI,KAAKoqI,gBAAgBc,WAAW1hG,cAAcJ,QAClF6rG,aAAcj1I,KAAKk1I,wBAInB10I,GACFR,KAAKm0H,iBAQAghB,wBAAwBr2I,EAA+B84H,GAAQ,EAAOzmB,GAAa,G,gDAG9F,MAAMl5D,EAAyB,aAF/Bn5C,QAAiBkB,KAAK2S,SAAS6wB,eAAeC,OAAO3kC,IAE/BmB,KAAqB,gBAAqC,QAAlBnB,EAASmB,KAAiB,YAAc,aACtG,OAAGD,KAAKoiC,KAAK71B,OAAOkpC,qBAAuBz1C,KAAKoiC,KAAK+2E,QAAQlhE,KAC3DtM,GAAM85F,KACC,GAGa,cAAnBzlI,KAAKoiC,KAAKniC,MAAyB23H,IAKnC94H,IACDkB,KAAK2S,SAAS40B,mBAAmB4mG,SAASnuI,KAAKoiC,KAAK71B,OAAQzN,EAAU,OAAF,wBAC/DkB,KAAKoiC,KAAK61F,2BAAyB,CACtCwC,SAAS,EACTtpB,WAAYA,QAAcnnG,KAE5BhK,KAAKm0H,cAAchjB,GAAY,GAEV,YAAlBryG,EAASmB,OACmB,QAA7B,wBAA6B,SAAEmtG,kBAAkBtuG,KAG5C,IAhBPkB,KAAKg0H,iBAAgB,IAAMh0H,KAAKm1I,wBAAwBr2I,GAAU,EAAMqyG,MACjE,MAqBH45B,sBACN,MAAM,gBAACX,GAAmBpqI,KAC1B,IAAIoqI,EAAiB,OAAO,EAC5B,MAAMgL,EAA2BhL,EAAgBgB,YAAY5hG,cAC7D,OAAQ4rG,EAAyBhsG,UAC/B,EAAAqP,GAAA,GAAU28F,EAAyB77H,MAAO,QAAQna,UAAUiG,SAAS,QAGjE6vI,qBACN,OAAQl1I,KAAK+qI,sBAeF/X,mBAAmB/lH,G,0CAC9B,MAAMI,QAAiBrN,KAAKoiC,KAAKy/D,WAAW50F,GAE5C,IAAIlN,GAAQ,EAAAwrF,GAAA,IAAuB,EAAAC,GAAA,GAAcn+E,EAAQA,QAAS,CAAC4lD,SAAU5lD,EAAQ8qD,iBACrF,MAAM1tC,EAAI,IAAW,mCACnB,MAAM4qH,QAAsBp+E,GAAoB5pD,OAASrD,EAAW,CAACqD,EAAQJ,MAC7EjN,KAAKooI,WAAW,OAAQ39G,GAAG,QAAK,mBAAoB4qH,EAAet1I,EAAOsN,GAE1ErN,KAAK2oI,UAAY17H,EACjBjN,KAAKi0H,YAAc5mH,EACnBtN,OAAQiK,KAEVygB,OAGK6qH,oBAAoBC,GACzB,MAAM9qH,EAAI,IAAW,mCAEnB,MAAM+qH,EAAcrpD,OAAOzuE,KAAK63H,GAAiB56H,KAAK6oD,GAAeA,EAAW3oD,aAC1EsC,EAAoB,IAAIyB,IAC9B,IAAIje,EAAS,EAAG80I,EAA6B,EAE7C,MAAM7nG,EAAI4nG,EAAY76H,KAAU6oD,GAAe,mCAC7C,MAAMrqC,EAAOo8G,EAAgB/xE,GACvB/5D,EAAW0vB,EAAKxe,KAAU1N,GAAQ,mC,MACtC,MAAMI,QAAiBrN,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiB0M,EAAYv2D,KAClE,QAAhB,EAAAI,EAAQ2qB,gBAAQ,eAAEC,YAAc5qB,EAAQC,QAAWD,EAAQ4qF,UAG5D96E,EAAK9d,IAAI,IAAMgO,EAAQC,QAFvB6P,EAAK9d,IAAI,IAAMgO,EAAQ2qB,SAASC,WAK/B5qB,EAAQ2gB,OAAS3gB,EAAQA,WACxBooI,aAIAtyI,QAAQC,IAAIqG,GAElB9I,GAAUw4B,EAAKx4B,kBAGXwC,QAAQC,IAAIwqC,GAElB,MAAMrV,EAAgBpb,EAAKnc,KAAO,EAC5B00I,EAAa,IAAIv4H,GAAMxC,KAAKwC,IAChC,MAAMld,EAAOkd,EAAK,GAElB,GADAA,EAAOA,EAAKzc,MAAM,GACN,MAATT,EAAc,CACf,MAAMsM,EAAS4Q,EAAKtC,WACpB,OAAOtO,IAAW,UAAiB,QAAK,8BAAgC,IAAI+rB,GAAU,CAAC/rB,OAAAA,EAAQisB,QAAQ,EAAOD,cAAAA,IAAgBnuB,QAE9H,OAAOmuB,EAAgBpb,EAAKulB,MAAM,KAAK,GAAKvlB,MAI1C,gBAACitH,GAAmBpqI,MACb,EAAAy4C,GAAA,GAAU2xF,EAAgBe,YAAY3hG,cAAcjwB,MAAO,QACnEna,UAAUoE,OAAO,QAASiyI,GAC/B,MAAMrK,EAAchB,EAAgBgB,YAAY5hG,cAAcJ,QAC3DqsG,GAA8BrK,EAC/BhB,EAAgBc,WAAW1hG,cAAc5oC,kBAAiB,QAChBoJ,IAAlChK,KAAKwrI,2BACZxrI,KAAKwrI,yBAA2BpB,EAAgBc,WAAad,EAAgB7vG,YAAYiP,cAAc5oC,kBAAiB,GAG3H,MAAM+0I,EAAwBvL,EAAgB7vG,WAAWiP,cAAcJ,QAAU,yBAA2B,wBACtGt6B,GAAQ,QAAK6mI,EAAU,CAACh1I,IAExBi1I,EAAe92I,SAASqW,yBAO9B,IAAI0gI,EAA+Bz9E,EACnC,GAPGs9E,EAAW/0I,OAAS,EACrBi1I,EAAal2I,WAAU,QAAKg2I,GAAY,IAExCE,EAAal2I,OAAOg2I,EAAW,IAAI,QAAK,WAAY,CAACA,EAAW/0I,OAAS,KAIjD,IAAvB60I,EAAY70I,OAAc,CAC3B,MAAM6iE,EAAagyE,EAAY,GACzBr8G,EAAOo8G,EAAgB/xE,GAI7B,GAHAqyE,QAAsB71I,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiB0M,EAAYrqC,EAAK,IAEzFi/B,IAAmBy9E,EAAax9E,WAC7BD,EAAgB,CACjB,MAAMgsD,QAAkBpkH,KAAK2S,SAAS40B,mBAAmB+wB,iBAAiBu9E,IACvEzxB,EAAUzjH,SAAWA,GAAUyjH,EAAUhyG,MAAMnF,IAASksB,EAAK/xB,SAAS6F,QACvEmrD,GAAiB,IAKvB,MAAM4S,EAAmBlsE,SAASqW,yBAElC,GAAGijD,GAA6B,IAAXz3D,EAAc,CACjC,MAAMw4B,EAAOo8G,EAAgBC,EAAY,IACnCH,QAAsBp+E,GAAoB4+E,OAAc7rI,EAAWmvB,GACzE6xC,EAAiBtrE,OACfk2I,EALc,KAOdP,QAGFrqE,EAAiBtrE,QACf,QAAK,+BAXS,KAadk2I,GAIJ,IAAIE,EAAW91I,KAAKooI,WAAW,UAAW39G,EAAG3b,EAAOk8D,GAEpDo/D,EAAgBuB,WAAWv+H,SAAQ,CAAC29C,EAAG1sC,KACrC,MAAM5e,EAAOsrD,EAAE2S,YACTq4E,EAAyB,iBAAiBt2I,GAChDs2I,EAAK3mI,KAAO,CAACiP,EAAM,EAAIm3H,EAAY70I,OAAS80I,GAC5CM,EAAK19G,YAGJr4B,KAAK0rI,cACN1rI,KAAK0rI,aAAar8B,qBAAqBymC,EAAU91I,KAAKiJ,gBAGxDjJ,KAAKgpI,WAAauM,KAGpB9qH,IAGW4uF,iBAAiBpsG,G,0CAC5B,GAAGjN,KAAK86H,eAAiB7tH,EACvB,OAGF,IAAII,QAAgBrN,KAAKoiC,KAAKy/D,WAAW50F,GACzC,MAAMwd,EAAI,KACR,IAAIurH,EACA3oI,EAgBF2oI,EAAc,IAAI19G,GAAU,CAC1B/rB,OAAQc,EAAQC,OAChBkrB,QAAQ,IACPpuB,SAlBH4rI,GAAc,QAAK,WAEnBh2I,KAAK2S,SAAS40B,mBAAmB0uG,kBAAkBj2I,KAAKoiC,KAAK71B,OAAQU,GAAKvL,MAAMw0I,IAC3El2I,KAAK86H,eAAiB7tH,IAIzBI,EAAU6oI,EACN7oI,EAGFod,IAFAzqB,KAAKm4H,YAAY,cAYvBn4H,KAAKooI,WAAW,QAAS39G,EAAGurH,EAAa3oI,GAAYA,EAA4BA,aAASrD,EAAWqD,GACrGrN,KAAK86H,aAAe7tH,GAEtBwd,OAGK0tG,YAAYl4H,GACM,SAApBD,KAAKk4H,YAAkC,SAATj4H,GAC/BD,KAAK4vI,aAGJ3vI,IACDD,KAAK2lI,QAAU,UACR3lI,KAAKqoI,UACZroI,KAAK8lI,gBAAkB,MAGb,UAAT7lI,IACDD,KAAK86H,kBAAe9wH,EACpBhK,KAAKgpI,gBAAah/H,GAGpBhK,KAAK2oI,UAAY3oI,KAAKi0H,iBAAcjqH,EACpChK,KAAKk4H,WAAal4H,KAAKuoI,gBAAav+H,EAEjChK,KAAKoiC,KAAKlhC,UAAU9B,UAAUiG,SAAS,sBACxCiL,EAAA,eAAqC,gBACrCtQ,KAAKoiC,KAAKlhC,UAAU9B,UAAUkB,OAAO,oBACrCN,KAAKqS,KAIDA,IACN,MAAM1T,EAAY,sBAClB,QAAcqB,KAAKoiC,KAAKlhC,UAAWvC,GAAW,EAAM,KAAK,KACvDqB,KAAKoiC,KAAKlhC,UAAU9B,UAAUkB,OAAO3B,MAIlCyxI,cAAc5vI,EAAeuK,GAAQ,EAAM0B,GAAQ,GACpDjM,IAAOA,EAAQ,IAEhBuK,EAAO/K,KAAK4vI,YAAW,GAAO,EAAOpvI,GACnCR,KAAK85H,kBAAkBl5H,iBAAiBJ,IAE7C,UAAQ,KACNiM,IAAS,EAAAssH,GAAA,GAAgB/4H,KAAKo+G,cAC9Bp+G,KAAK0nI,iBACL1nI,KAAKo+G,aAAa35D,UAAYzkD,KAAKo+G,aAAar4C,gBAI7CqiE,WACLnoI,EACAk2I,EACArnI,EAAyC,GACzC26B,EAA4C,GAC5C1pC,EACAsN,GAEA,GAAGrN,KAAK8lI,iBAA4B,UAAT7lI,EACzB,OAGU,YAATA,IACDD,KAAKm4H,YAAYl4H,GACjBD,KAAKk4H,WAAaj4H,EAClBD,KAAKuoI,WAAa4N,GAGpB,MAAMC,EAAcp2I,KAAK6lI,cAAc3kI,UACjCm1I,EAAWD,EAAY3xI,iBAAiBokB,uBACxCytH,EAAYD,EAASj3I,UAAUiG,SAAS,SAE9CrF,KAAK6lI,cAAc8E,QAAQlsG,YAAYz+B,KAAK6lI,cAAc8E,QAAU,GAAqB,YAAT1qI,EAAqB,OAASA,GAAQ,qBAAsB,CAACf,UAAU,KACvJ,MAAM,UAACgC,GAAa04D,GAAU9qD,EAAO26B,EAAUp8B,GAsC/C,OArCGipI,EACDD,EAAS53G,YAAYv9B,GAErBk1I,EAAYtyI,aAAa5C,EAAWk1I,EAAY3xI,kBAGtC,YAATxE,IACDiB,EAAU+B,MAAMo/C,OAAS,WAGvBriD,KAAKoiC,KAAKlhC,UAAU9B,UAAUiG,SAAS,sBACzCrF,KAAKoiC,KAAKlhC,UAAU9B,UAAUC,IAAI,oBAClCW,KAAKqS,KAQH,GAAA0gF,WACFziF,EAAA,WAAiC,CAC/BrQ,KAAM,eACN0R,MAAO,KACL3R,KAAKsoI,yBAKEt+H,IAAVjK,GACDC,KAAKowI,cAAcrwI,GAGrBqG,YAAW,KACTpG,KAAK8oI,kBACJ,GAEI5nI,GA/kFM,GAAA+xI,sBAAwB,yDGtFzC,MACMsD,GAAiB,mBAGR,MAAMC,GAenB52I,YAAYhB,GAJF,KAAA63I,UAAW,GAanB,EAAAzlI,EAAA,GAAWhR,KAAMpB,GAEjB,MAAM,cAAC83I,EAAa,UAAE/3I,GAAaqB,KACnC02I,EAAcx1I,UAAU9B,UAAUC,IAAIk3I,GAAgB,QACtDG,EAAc5nI,MAAM1P,UAAUC,IAAIk3I,GAAiB,UACnDG,EAAcjtG,SAASrqC,UAAUC,IAAIk3I,GAAiB,aACtDG,EAAc3nI,QAAQ3P,UAAUC,IAAIk3I,GAAiB,YAErDv2I,KAAKkvH,SAAWpwH,SAASC,cAAc,UACvCiB,KAAKkvH,SAAS9vH,UAAUC,IAAIk3I,GAAiB,SAAU,UAAU53I,UAAmB,WAAY,eAEhGqB,KAAKwnH,QAAU1oH,SAASC,cAAc,OACtCiB,KAAKwnH,QAAQpoH,UAAUC,IAAIk3I,GAAiB,aAC5C,EAAA1xI,GAAA,GAAO7E,KAAKwnH,SAEZxnH,KAAK22I,aAAe73I,SAASC,cAAc,OAC3CiB,KAAK22I,aAAav3I,UAAUC,IAAIk3I,GAAiB,kBACjDv2I,KAAK22I,aAAaj3I,OAAOM,KAAKkvH,UAE9BlvH,KAAKwnH,QAAQ9nH,UAAU0R,MAAMC,KAAKqlI,EAAcx1I,UAAU4kB,UAAW9lB,KAAK22I,cAE1ED,EAAcx1I,UAAUxB,OAAOM,KAAKwnH,SAEpCxnH,KAAK42I,mBAAmB52I,KAAKkvH,UAGxB0nB,mBAAmB1yI,IACxB,QAAiBA,GAAO7D,KACtB,EAAA4nB,EAAA,GAAY5nB,KAEVL,KAAKuS,QAAUvS,KAAKuS,UAAY,OAASpP,QAAQ4B,SAAQ,IAAOrD,MAAMm1I,IACnEA,GACD72I,KAAKwD,QAAO,QAGf,CAACyF,eAAgBjJ,KAAKiJ,iBAGpBzF,OAAO8yC,GACZ,MAAM6xE,EAAWnoH,KAAK02I,cAAcx1I,UAAU9B,UAAUiG,SAAS,QACjE,QAAY2E,IAATssC,EACDA,GAAQ6xE,OACH,GAAG7xE,IAAS6xE,EACjB,OAKF,MAAM2uB,GAAc92I,KAAKy2I,UAAYpnH,EAAA,cAAyBinB,EAG9Dt2C,KAAK02I,cAAcx1I,UAAU9B,UAAUoE,OAAO,cAAeszI,GAC7D92I,KAAK02I,cAAcx1I,UAAU9B,UAAUoE,OAAO,OAAQ8yC,GAEtDt2C,KAAKu2G,OAAOr1G,UAAU9B,UAAUoE,OAAO,qBAAsBszI,GAC7D92I,KAAKu2G,OAAOr1G,UAAU9B,UAAUoE,OAAO,aAAaxD,KAAKrB,mBAAoB23C,GAU7Et2C,KAAKu2G,OAAOwgC,cACZ/2I,KAAKu2G,OAAOygC,gBAGP15H,YACL,OAAQtd,KAAK02I,cAAcx1I,UAAU9B,UAAUiG,SAAS,QAGnDyxI,aACL,OAAO92I,KAAK02I,cAAcx1I,UAAU9B,UAAUiG,SAAS,eAGlDmvD,KAAK1lD,EAAgD26B,EAAmDp8B,GAC7GrN,KAAK02I,cAAcx1I,UAAU0G,QAAQ2E,OAAS,GAAKc,EAAQd,OAC3DvM,KAAK02I,cAAcx1I,UAAU0G,QAAQqF,IAAM,GAAKI,EAAQJ,IACxDjN,KAAK02I,cAAcliF,KAAK1lD,EAAO26B,EAAUp8B,GACzCrN,KAAKu2G,OAAOygC,iBCjHD,MAAMC,WAAuB/hH,GAK1Ct1B,YAAsBqJ,EAA0CssB,GAAW,GACzE11B,MAAM,CACJg2B,KAAM,IACNjzB,IAAK,EACLJ,IAAK,EACL+yB,SAAAA,GACC,GANiB,KAAAtsB,eAAAA,EAA0C,KAAAssB,SAAAA,EAsCxD,KAAA2hH,YAAe72I,IACrBA,IAAK,EAAA4nB,EAAA,GAAY5nB,GACjBm3B,GAAA,SAAoCA,GAAA,SAG/B,KAAA2/G,UAAY,KAEjB,MAAM,OAACC,EAAM,MAAEx2G,GAASpJ,GAAA,EACxB,IACI6/G,EAEFA,GADED,GAAUx2G,EACA,EACJw2G,EAAS,GACL,EACJA,EAAS,GAAKA,EAAS,IACnB,EAEA,EAGdH,GAAeK,MAAMlqI,SAASnO,GAASe,KAAKf,KAAKG,UAAUkB,OAAO,SAAWrB,KAC7Ee,KAAKf,KAAKG,UAAUC,IAAI,SAAW43I,GAAeK,MAAMD,IAEpDr3I,KAAKm1B,WACPn1B,KAAKmpB,YAAYyX,EAAQ,EAAIw2G,IAtD/Bp3I,KAAKg2B,eACLh2B,KAAK+1B,YAAY,CACfJ,QAASyB,IACP,MAAM52B,EAAQmC,KAAKH,IAAIG,KAAKC,IAAIw0B,EAAa,GAAI,GAIjDI,GAAA,SAAmC,EACnCA,GAAA,SAAoCh3B,KAQxC,MAAM7B,EAAY,gBACZ8lF,EAAMzkF,KAAKykF,IAAM3lF,SAASC,cAAc,OAC9C0lF,EAAIrlF,UAAUC,IAAI,WAAYV,GAC9B,MAAMM,EAAOe,KAAKf,KAAOH,SAASC,cAAc,QAChDE,EAAKG,UAAUC,IAAIV,EAAY,UAE/B8lF,EAAI/kF,OAAOT,EAAMe,KAAKkB,YAEtB,QAAiBjC,EAAMe,KAAKk3I,YAAa,CAACjuI,eAAgBjJ,KAAKiJ,iBAC/DjJ,KAAKiJ,eAAe5J,IAAIm4B,GAAA,EAAxBx3B,CAAoD,iBAAkBA,KAAKm3I,WAE3En3I,KAAKm3I,aAvCQ,GAAAG,MAAQ,CAAC,aAAc,cAAe,cAAe,aCYvD,MAAMC,WAAkBf,GAOrC52I,YAAsB22G,EAA8Bn0E,EAAsBzvB,GACxE9S,MAAM,CACJ02G,OAAAA,EACAn0E,KAAAA,EACAn5B,eAAgBstG,EAAOttG,eACvBtK,UAAW,QACX+3I,cAAe,IAAIniF,GACjB,gBACA,CAACzlD,EAAgD26B,MAC/C,EAAA77B,EAAA,GAAe5N,KAAK02I,cAAc5nI,MAAOA,IACzC,EAAAlB,EAAA,GAAe5N,KAAK02I,cAAcjtG,SAAUA,MAGhDl3B,QAAS,KACPilB,GAAA,UAEFi/G,UAAU,IAhBQ,KAAAlgC,OAAAA,EAA8B,KAAAn0E,KAAAA,EAAsB,KAAAzvB,SAAAA,EAsGlE,KAAA6kI,iBAAoBC,IAC1Bz3I,KAAK03I,SAASt4I,UAAUoE,OAAO,SAAUi0I,EAAeE,aAAe,GAEvE33I,KAAK43I,SAASx4I,UAAUkB,OAAO,qBAAsB,6BACrDN,KAAK43I,SAASx4I,UAAUC,IAAIo4I,EAAep2I,KAAO,4BAA8B,sBAChFrB,KAAK43I,SAASx4I,UAAUoE,OAAO,SAAUi0I,EAAep2I,MAAQo2I,EAAe50I,QAGzE,KAAAg1I,QAAU,KAChB73I,KAAK83I,SAAS14I,UAAUkB,OAAO,cAGzB,KAAAy3I,OAAS,KACf/3I,KAAKwD,QAAO,IAGN,KAAAw0I,YAAc,EAAEx9G,IAAAA,EAAKntB,QAAAA,EAAS2gB,MAAAA,EAAOypH,eAAAA,M,QAC3C,IAAI3oI,EAAgD26B,EACpD,MAAMwuG,EAAuB,UAAbz9G,EAAIv6B,MAAiC,UAAbu6B,EAAIv6B,KAC5C,GAAIg4I,EAKG,CACL,MAAMn6G,EAAiBtD,EAAIY,WAAWhpB,MAAMgnB,GAAoB,2BAAXA,EAAKxsB,IAC1DkC,GAAQ,EAAA8pB,GAAA,GAAmC,QAArB,EAAAkF,MAAAA,OAAc,EAAdA,EAAgBhvB,aAAK,QAAI0rB,EAAI2D,WACnDsL,GAAW3L,MAAAA,OAAc,EAAdA,EAAgBE,YAAY,EAAApF,GAAA,GAAckF,EAAeE,YAAa,QAAK,2BAPtFlvB,EAAQ,IAAIwpB,GAAU,CAAC/rB,OAAQc,EAAQC,OAAQyqB,SAA0B,QAAhB,EAAA1qB,EAAQ2qB,gBAAQ,eAAEC,YAAY7tB,QAGvFq/B,EAAWx0B,EAAmB5H,EAAQ8F,MAOxCnT,KAAK03I,SAASt4I,UAAUoE,OAAO,OAAQy0I,GACvCj4I,KAAK43I,SAASx4I,UAAUoE,OAAO,QAASy0I,GAExCj4I,KAAKw3I,iBAAiBC,GACtBz3I,KAAKk4I,eAAef,YAEpBn3I,KAAKs+B,aAAapH,SAASlJ,GAE3BhuB,KAAKw0D,KAAK1lD,EAAO26B,EAAUp8B,GAE3BrN,KAAK83I,SAAS14I,UAAUoE,OAAO,aAAcwqB,EAAM6I,QACnD72B,KAAKwD,QAAO,IA5HZxD,KAAK02I,cAAcjiF,OAAOn0D,SAE1B,MAAM63I,EAAS,EAAW,qBAAsB,CAACj5I,UAAU,IACrDk5I,EAAS,EAAW,sBAAuB,CAACl5I,UAAU,IAEtDm5I,EAAc,CAACn0I,EAAmBY,MACtC,QAAiBZ,GAAO7D,KACtB,EAAA4nB,EAAA,GAAY5nB,GACZyE,MACC,CAACmE,eAAgBjJ,KAAKu2G,OAAOttG,kBAGlCovI,EAAYF,GAAQ,KAClB3gH,GAAA,gBAGF6gH,EAAYD,GAAQ,KAClB5gH,GAAA,YAGFx3B,KAAK83I,SAAW,EAAW,GAAI,CAAC54I,UAAU,IAC1Cc,KAAK83I,SAAS14I,UAAUC,IAAI,SAAU,mBAAoB,SAC1Dg5I,EAAYr4I,KAAK83I,UAAU,KACzBtgH,GAAA,cAEFx3B,KAAKwnH,QAAQ3jH,QAAQ7D,KAAKwnH,QAAQz+F,kBAAmBovH,EAAQn4I,KAAK83I,SAAUM,GAE5Ep4I,KAAKk4I,eAAiB,IAAIjB,GAAej3I,KAAKiJ,gBAAgB,GAC9D,MAAMqvI,EAA8Bx5I,SAASC,cAAc,OAC3Du5I,EAA4Bl5I,UAAUC,IAAI,2BAC1Ci5I,EAA4B54I,OAAOM,KAAKk4I,eAAeh3I,WACvD,MAAMq3I,EAASz5I,SAASC,cAAc,OACtCw5I,EAAOn5I,UAAUC,IAAI,8BACrBW,KAAKk4I,eAAezzD,IAAIrlF,UAAUC,IAAI,sBAAuB,UAC7DW,KAAKk4I,eAAezzD,IAAI5gF,QAAQ00I,GAChCv4I,KAAKk4I,eAAezzD,IAAI/kF,OAAO44I,GAE/Bt4I,KAAK43I,SAAW,EAAW,eAAgB,CAAC14I,UAAU,IACtDm5I,EAAYr4I,KAAK43I,UAAU,KACzB,MAAMze,EAAS3hG,GAAA,sBACX2hG,EAAOt2H,MAEDs2H,EAAO93H,MACfm2B,GAAA,SAAmC,EACnCA,GAAA,QAAkC,GAElCA,GAAA,QAAmCA,GAAA,OALnCA,GAAA,SAAmC,KASvC,MAAMkgH,EAAW13I,KAAK03I,SAAW,EAAW,cAAe,CAACx4I,UAAU,IACtEm5I,EAAYX,GAAU,KACpBlgH,GAAA,eAA0CkgH,EAASt4I,UAAUiG,SAAS,UAAY,EAAI,QAGxFrF,KAAK22I,aAAa9yI,QAAQ7D,KAAKk4I,eAAezzD,IAAKizD,EAAU13I,KAAK43I,UAElE,MAAMY,EAAkB15I,SAASC,cAAc,OAC/Cy5I,EAAgBp5I,UAAUC,IAAI,iCAE9BW,KAAKs+B,aAAe,IAAI9H,QAAkBxsB,OAAWA,GAAW,GAAM,GACtEhK,KAAKs+B,aAAap9B,UAAU9B,UAAUC,IAAI,yBAC1Cm5I,EAAgB94I,OAAOM,KAAKs+B,aAAap9B,WACzClB,KAAKwnH,QAAQ1jH,aAAa00I,EAAiBx4I,KAAK22I,cAEhD32I,KAAKu2G,OAAOttG,eAAe5J,IAAIm4B,GAAA,EAA/Bx3B,CAA2D,OAAQA,KAAKg4I,aACxEh4I,KAAKu2G,OAAOttG,eAAe5J,IAAIm4B,GAAA,EAA/Bx3B,CAA2D,QAASA,KAAK63I,SACzE73I,KAAKu2G,OAAOttG,eAAe5J,IAAIm4B,GAAA,EAA/Bx3B,CAA2D,OAAQA,KAAK+3I,QACxE/3I,KAAKu2G,OAAOttG,eAAe5J,IAAIm4B,GAAA,EAA/Bx3B,CAA2D,iBAAkBA,KAAKw3I,kBAElF,MAAMiB,EAAiBjhH,GAAA,sBACpBihH,IACDz4I,KAAKg4I,YAAYS,GACjBz4I,KAAKw3I,iBAAiBiB,EAAehB,iBAIlCzuF,UACFhpD,KAAKs+B,cACNt+B,KAAKs+B,aAAa/H,mBCjIxB,IAAKmiH,IAAL,SAAKA,GACH,kBACA,kBACA,sBACA,mBACA,mBALF,CAAKA,KAAAA,GAAW,KAQhB,MAEM90F,GAAa,wBAEJ,MAAM+0F,GAArB,cAYU,KAAAC,SAAW,CAAC5xI,EAAWC,EAAW1F,EAAeC,EAAgB+pB,IAChE,IAAIvkB,KAAKC,EAAIskB,KAAUA,KAAUA,WAAgBhqB,OAAWC,EAAS,EAAI+pB,KAAUA,KAAUA,YAAiBhqB,OAG/G,KAAAs3I,YAAc,CAACroI,EAAYsoI,EAAmB/rI,KAGpD,IAAIqG,EAAI,GAKJ,GAAa,IAAVrG,EACLqG,EAAIpT,KAAK44I,SAAS,EAAG,EA5Bb,EA4BuBE,EARlB,GAQuC94I,KAAK44I,SAAS,EAAGE,EAAYC,EA5BzE,EA4ByFD,EARpF,QAUb,IAAI,IAAI/sI,EAAI,EAAGA,EAAIgB,IAAShB,EAC1BqH,GAAKpT,KAAK44I,SAAS,GAAIE,EAhCnB,GAgCsC/sI,EA/BpC,EA+B8C+sI,EAXzC,GAyBf,OAVI94I,KAAKg5I,WACPh5I,KAAKg5I,SAAWl6I,SAASs9B,gBAAgB,6BAA8B,YACvEp8B,KAAKomC,KAAOtnC,SAASs9B,gBAAgB,6BAA8B,QAEnEp8B,KAAKg5I,SAASt5I,OAAOM,KAAKomC,OAG5BpmC,KAAKg5I,SAASxoI,GAAKA,EACnBxQ,KAAKomC,KAAKzf,eAAe,KAAM,IAAKvT,GAE7BpT,KAAKg5I,UAGN,KAAAC,aAAe,CAAClsI,EAAeuY,KACrC,IAAIwzH,EAaJ,OAZG/rI,GAAS,EACV+rI,EAAYJ,GAAYQ,IACN,IAAVnsI,EACR+rI,EAAYJ,GAAYS,IACN,IAAVpsI,EACR+rI,EAAYJ,GAAYU,MACN,IAAVrsI,EACR+rI,EAAYJ,GAAYW,KAChBtsI,EAAQ,IAChB+rI,EAAYJ,GAAYY,MAGnBR,GAGD,KAAAS,cAAgB,CAACxsI,EAAeuY,KACtC,IAAIk0H,EAaJ,OAZGzsI,GAAS,EACVysI,EAAad,GAAYQ,IACP,IAAVnsI,EACRysI,EAAad,GAAYS,IACP,IAAVpsI,EACRysI,EAAad,GAAYU,MACP,IAAVrsI,EACRysI,EAAad,GAAYW,KACjBtsI,EAAQ,IAChBysI,EAAad,GAAYY,MAGpBE,GAGD,KAAAC,kBAAoB,CAACn0H,EAAewzH,EAAmB/rI,IAChD,IAAVA,EACM,EACW,IAAVA,EACAuY,EAAYwzH,EAvFd,EAuFU,EAGL,IAAV/rI,EACGuY,EAEgB,IAAVA,EACDwzH,EA9FH,EAiGa,EAAZA,EAAgBC,EAAU,EALxB,GAODD,EAnGF,GAmGqBxzH,EAIvB,KAAAo0H,mBAAqB,CAACp0H,EAAevY,EAAe+rI,EAAmBa,IAC1E5sI,GAAS,GAITuY,GAAS,EAHH,EAKCA,GAAUvY,EAAQ,EACnB4sI,EAAcjB,GAAYQ,IAAMJ,GAIjCxzH,EAAQ,GAAKwzH,EAnHb,EAmHyBxzH,EAI3B,KAAAs0H,eAAiB,CAAC7sI,EAAe+rI,IAChC/rI,GAAS,EAAI2rI,GAAYQ,IAAMJ,EAAY/rI,EAxH1C,GAwHyDA,EAAQ,GAGpEyjB,OAAOzjB,EAAeuY,GAS3B,GARItlB,KAAKy0D,SACPz0D,KAAKy0D,OAAS31D,SAASC,cAAc,OACrCiB,KAAKy0D,OAAOr1D,UAAUC,IAAIukD,IAE1B5jD,KAAKwnH,QAAU1oH,SAASC,cAAc,OACtCiB,KAAKy0D,OAAO/0D,OAAOM,KAAKwnH,UAGb,IAAVz6G,EAOD,OANG/M,KAAK+M,QAAUA,IAChB/M,KAAKwnH,QAAQ7oH,UAAYilD,GAAa,aACtC5jD,KAAKy0D,OAAOr1D,UAAUkB,OAAOsjD,GAAa,SAC1C5jD,KAAKwnH,QAAQljH,UAAYtE,KAAKwnH,QAAQvkH,MAAM42I,QAAU,IAGjD75I,KAAKy0D,OAGd,MAAMqkF,EAAY94I,KAAKi5I,aAAalsI,EAAOuY,GACrCk0H,EAAax5I,KAAKu5I,cAAcxsI,EAAOuY,GACvCq0H,EAAc35I,KAAK45I,eAAe7sI,EAAO+rI,GAEzCgB,EAAa,YAAY/sI,IACzBisI,EAAWh5I,KAAK64I,YAAYiB,EAAYhB,EAAW/rI,GAEnDgtI,EAAiB/5I,KAAKy5I,kBAAkBn0H,EAAOwzH,EAAW/rI,GAC1DitI,EAAkBh6I,KAAK05I,mBAAmBp0H,EAAOvY,EAAO+rI,EAAWa,GAwCzE,OAtCA35I,KAAKy0D,OAAOr1D,UAAUoE,OAAOogD,GAAa,QAAS72C,EAAQ,GAExDuY,GAAS,GACVtlB,KAAKy0D,OAAOr1D,UAAUC,IAAI,eAC1BW,KAAKy0D,OAAOr1D,UAAUkB,OAAO,aACrBglB,GAAUvY,EAAQ,GAC1B/M,KAAKy0D,OAAOr1D,UAAUC,IAAI,YAC1BW,KAAKy0D,OAAOr1D,UAAUkB,OAAO,gBAE7BN,KAAKy0D,OAAOr1D,UAAUC,IAAI,WAAY,eAGxCW,KAAKwnH,QAAQ7oH,UAAYilD,GAAa,WACtC5jD,KAAKwnH,QAAQvkH,MAAM42I,QAAU,mBAAmBC,2BAAoCH,+BAAyCK,QAEzHh6I,KAAK87B,MACP97B,KAAK87B,IAAMh9B,SAASs9B,gBAAgB,6BAA8B,OAClEp8B,KAAK87B,IAAInV,eAAe,KAAM,SAAU,KACxC3mB,KAAK87B,IAAInV,eAAe,KAAM,QAAS,KAEvC3mB,KAAKi6I,KAAOn7I,SAASs9B,gBAAgB,6BAA8B,QACnEp8B,KAAKi6I,KAAKv6I,OAAOs5I,GAEjBh5I,KAAK87B,IAAIp8B,OAAOM,KAAKi6I,MAErBj6I,KAAKk6I,KAAOp7I,SAASC,cAAc,OACnCiB,KAAKk6I,KAAK96I,UAAUC,IAAIukD,GAAa,UAGnC5jD,KAAK87B,IAAIl4B,eACX5D,KAAKwnH,QAAQ9nH,OAAOM,KAAK87B,IAAK97B,KAAKk6I,MAGrCl6I,KAAKk6I,KAAKj3I,MAAM42I,QAAU,WAAWL,8BAAuCO,QAE5E/5I,KAAK+M,MAAQA,EACb/M,KAAKslB,MAAQA,EAENtlB,KAAKy0D,Q,2SC9KhB,MAAM0lF,GAOJv6I,cAHA,KAAA0qC,KAAgF,GAI9EtqC,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAUvC,UAAYw7I,GAAcv2F,WAGpCw2F,OAAO90H,EAAe+0H,GAAe,GAC1C,GAAGr6I,KAAKsqC,KAAKhlB,GAAQ,OAAOtlB,KAAKsqC,KAAKhlB,GAAOlb,QAC7C,MAAMmb,EAAMzmB,SAASC,cAAc,OAC7BwyE,GAAW4a,OAAOzuE,KAAK1d,KAAKsqC,MAAM3pC,SAAW05I,EAInD,OAHA90H,EAAI5mB,UAAYw7I,GAAcv2F,WAAa,QAAU2tB,EAAU,GAAK,mBACpEvxE,KAAKsqC,KAAKhlB,GAAS,CAAClb,QAASmb,EAAKvK,KAAK,GACvChb,KAAKkB,UAAUxB,OAAO6lB,GACfA,EAGF+0H,SAASh1H,GACVtlB,KAAKsqC,KAAKhlB,KACdtlB,KAAKsqC,KAAKhlB,GAAOlb,QAAQ9J,gBAClBN,KAAKsqC,KAAKhlB,IAGZi1H,UAAUC,GACZx6I,KAAKmO,cAAcA,aAAanO,KAAKmO,cACxCnO,KAAKmO,aAAerI,OAAOM,YAAW,KACpC,IAAI,MAAM2F,KAAK/L,KAAKsqC,MACdv+B,IAAMyuI,GACVx6I,KAAKs6I,UAAUvuI,KAEhBouI,GAAcM,UAGZC,UAAUp1H,EAAeq1H,GAAS,GACvC,MAAMp1H,EAAMvlB,KAAKsqC,KAAKhlB,GACnBC,EAAIvK,MACF2/H,GACDp1H,EAAInb,QAAQhL,UAAUkB,OAAO,QACxBilB,EAAInb,QAAQ+6C,YAEjB5/B,EAAInb,QAAQhL,UAAUkB,OAAO,YAAa,eAGrCilB,EAAIvK,KAGbhb,KAAKu6I,UAAUj1H,GAGV7U,QAAQ6U,EAAes1H,EAAuBC,EAAUv1H,EAAQs1H,EAAeE,GAAiB,GACrG,GAAGx1H,IAAUs1H,EACX,OAAO56I,KAAK06I,UAAUp1H,GAGxB,MAAMC,EAAMvlB,KAAKsqC,KAAKhlB,GAChBy1H,EAAc/6I,KAAKsqC,KAAKswG,GAC9B,IAAIG,IAAgBD,EAClB,OAAO96I,KAAK06I,UAAUp1H,GAGxB,MAAM9C,EAAQ,CAAC,WAAY,eACvBq4H,GAASr4H,EAAM2X,UAEnB5U,EAAInb,QAAQhL,UAAUC,IAAImjB,EAAM,IAChC+C,EAAInb,QAAQhL,UAAUkB,OAAOkiB,EAAM,IAChCu4H,IACDA,EAAY3wI,QAAQhL,UAAUC,IAAImjB,EAAM,IACxCu4H,EAAY3wI,QAAQhL,UAAUkB,OAAOkiB,EAAM,KAG1C+C,EAAIvK,KACLhb,KAAK06I,UAAUp1H,GAAO,GAGxBC,EAAInb,QAAQhL,UAAUoE,OAAO,aAAa,GAC1Cu3I,GAAeA,EAAY3wI,QAAQhL,UAAUoE,OAAO,aAAa,GAajExD,KAAKu6I,UAAUj1H,IA5FV,GAAAm1H,SAAW,IACX,GAAA72F,WAAa,iBA+FtB,MAAMo3F,GAYJp7I,YAAoBu6B,GAAU,GAAV,KAAAA,QAAAA,EARpB,KAAAvG,SAIM,GACN,KAAAqnH,eAAiB,EAIfj7I,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAUvC,UAAYq8I,GAAgBp3F,WAG7Cs3F,WAAW51H,GACT,GAAGtlB,KAAK4zB,SAAStO,GAAQ,OAAOtlB,KAAK4zB,SAAStO,GAC9C,MAAMvG,EAAOjgB,SAASC,cAAc,OACpCggB,EAAKpgB,UAAYq8I,GAAgBp3F,WAAa,WAE9C,MAAM71C,EAAcjP,SAASC,cAAc,OAC3CgP,EAAYpP,UAAYq8I,GAAgBp3F,WAAa,uBAErD,MAAMu3F,EAAgB,IAAIhB,GAO1B,OANAgB,EAAcj6I,UAAUvC,UAAYq8I,GAAgBp3F,WAAa,mBAEjE7kC,EAAKrf,OAAOqO,EAAaotI,EAAcj6I,WAEvClB,KAAKkB,UAAUxB,OAAOqf,GAEf/e,KAAK4zB,SAAStO,GAAS,CAACpkB,UAAW6d,EAAMhR,YAAAA,EAAaotI,cAAAA,GAG/DpwI,MAAMmzF,GACDl+F,KAAKmO,cAAcA,aAAanO,KAAKmO,cAExC,MAAMylB,GAAY,GAAKsqE,GAAQv9F,OAC5BizB,GAAY5zB,KAAK4zB,SAASjzB,SAI7BX,KAAKmO,aAAerI,OAAOM,YAAW,KAClBpG,KAAK4zB,SAASrV,OAAOqV,EAAU5zB,KAAK4zB,SAASjzB,OAASizB,GAC9DxmB,SAASguI,IACjBA,EAAQl6I,UAAUZ,cAEnB65I,GAAcM,WAYnBY,SAASn9C,GACP,MAAMtqE,GAAY,GAAKsqE,GAAQv9F,OACbX,KAAK4zB,SAASlzB,MAAMkzB,GAC5BxmB,SAASguI,IACjB,MAAME,GAAyBF,EAAQrtI,YAAYkxB,WAAa,EACpDm8G,EAAQD,cAAcf,OAAOY,GAAgBO,aAAa,GACtEH,EAAQD,cAAc1qI,QAAQuqI,GAAgBO,YAAaD,EAAuBt7I,KAAKm6B,QAAU+jE,EAASl+F,KAAKi7I,eAAiB/8C,EAASl+F,KAAKi7I,gBAAgB,MAGhKj7I,KAAK+K,MAAMmzF,GAGbs9C,SAASt9C,GAGP,MAAMu9C,EAAoBrqI,MAAMC,KAAK,GAAKrR,KAAKi7I,gBAAgBtgI,KAAKqhH,IAAOA,IACzD5qH,MAAMC,KAAK,GAAK6sF,GAAQvjF,KAAKqhH,IAAOA,IAC5C5uH,SAAQ,CAACsuI,EAAer9H,K,MAChC,MAAM+8H,EAAUp7I,KAAKk7I,WAAW78H,GAE1BkH,EAAM61H,EAAQD,cAAcf,OAAOsB,GAAe,GAClDJ,EAA8C,QAAtB,EAAAG,EAAkBp9H,UAAI,QAAI28H,GAAgBO,YACxEh2H,EAAI0Z,UAAYm8G,EAAQrtI,YAAYkxB,UAAY,GAAKy8G,EAErDN,EAAQD,cAAc1qI,QAAQirI,EAAeJ,EAAuBt7I,KAAKm6B,QAAU+jE,EAASl+F,KAAKi7I,eAAiB/8C,EAASl+F,KAAKi7I,gBAAgB,MAGlJj7I,KAAKq7I,SAASn9C,GAEdl+F,KAAKi7I,eAAiB/8C,GAxFjB,GAAAq9C,aAAe,EACf,GAAA33F,WAAa,mBA2FP,MAAM+3F,GA8CnB/7I,YAAoB22G,EAA4Bn0E,EAAoBzvB,GAAhD,KAAA4jG,OAAAA,EAA4B,KAAAn0E,KAAAA,EAAoB,KAAAzvB,SAAAA,EAvC5D,KAAAipI,aAAe,EAChB,KAAAC,UAAY,EACZ,KAAAC,aAAe,EACd,KAAAC,eAAiB,EACjB,KAAAC,oBAAsB,EAEvB,KAAAt/H,QAAS,EACR,KAAAu/H,qBAAsB,EAEvB,KAAAlvI,MAAQ,EACP,KAAAosB,KAAiB,GACjB,KAAAiY,YAAc,EAEd,KAAArB,SAAU,EACV,KAAAmsG,cAAe,EACf,KAAAC,WAAY,EAOZ,KAAAC,yBAA2C,KAE5C,KAAA3f,QAAS,EAER,KAAA4f,uBAAuC,KAc7Cr8I,KAAKiJ,eAAiB,IAAI,IAC1BjJ,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,MAClB7nE,KAAKs8I,OAAQ,EACbt8I,KAAKu8I,UAAW,EAEhB,MAAMC,EAAM,IAAI9iF,GAAe,kBAC/B15D,KAAK0uI,uBAAyB,IAAI8H,GAAgB,CAChDjgC,OAAAA,EACAn0E,KAAAA,EACAn5B,eAAgBjJ,KAAKiJ,eACrBtK,UAAW,UACX+3I,cAAe8F,EACfjqI,QAAS,IAAW,mCAOlB,aANSI,EAAS2/B,gBAAgBo7E,cAAc1tH,KAAKoiC,KAAK71B,SACxD,IAAIghH,GAAgBvtH,KAAKoiC,KAAK71B,OAAQvM,KAAK67I,WAAW,GAEtD,IAAItuB,GAAgBvtH,KAAKoiC,KAAK71B,OAAQ,GAAG,IAGpC,OAIXvM,KAAKy8I,oBAAsB,IAAI9D,GAC/B6D,EAAI/nF,OAAOh2B,YAAYz+B,KAAKy8I,oBAAoBjsH,OAAO,EAAG,IAE1DxwB,KAAK08I,iBAAmB,IAAIvC,GAC5BqC,EAAI/yG,SAAS/pC,OAAOM,KAAK08I,iBAAiBx7I,WAE1ClB,KAAK28I,cAAgB,IAAIxC,GACzBn6I,KAAK28I,cAAcz7I,UAAU9B,UAAUC,IAAI,kCAC3Cm9I,EAAIztI,QAAQlL,QAAQ7D,KAAK28I,cAAcz7I,WAEvClB,KAAK48I,gBAAkB,IAAI5B,IAAgB,GAC3CwB,EAAI1tI,MAAMpP,QAAO,QAAK,iBAAkB,IAAKM,KAAK48I,gBAAgB17I,WAElE,MAAMguH,EAAWlvH,KAAK0uI,uBAAuBxf,SAASnrH,WAAU,GAChE/D,KAAK0uI,uBAAuBkI,mBAAmB1nB,GAC/CstB,EAAIt7I,UAAU2C,QAAQqrH,GAEtBlvH,KAAK68I,QAAU,EAAW,wDAAyD,CAAC39I,UAAU,IAE9Fc,KAAK0uI,uBAAuBiI,aAAa9yI,QAAQ7D,KAAK68I,UAEtD,QAAiB78I,KAAK68I,SAAUx8I,KAC9B,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKu2G,OAAOumC,YAAW,KACtB,CAAC7zI,eAAgBjJ,KAAKiJ,iBAEzBjJ,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,wBAAwB,EAAEuM,OAAAA,MACxDA,IAAWvM,KAAKoiC,KAAK71B,SAGjBvM,KAAKy8H,QACNz8H,KAAK0uI,uBAAuBlrI,OAAOxD,KAAKy8H,QAAS,GAGnDz8H,KAAKm8I,UAAYn8I,KAAKk8I,cAAe,EACrCl8I,KAAK87I,aAAe,EACpB97I,KAAK67I,UAAY,EACjB77I,KAAK+M,MAAQ,EACb/M,KAAKm5B,KAAO,GACZn5B,KAAKoxC,YAAc,EACnBpxC,KAAK47I,aAAe,EACpB57I,KAAK2hH,gBAAgB,OAK3B3hH,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,sBAAsB,EAAEuM,OAAAA,MACtDA,IAAWvM,KAAKoiC,KAAK71B,QACtBvM,KAAK0uI,uBAAuBlrI,OAAOxD,KAAKy8H,QAAS,MAMrDz8H,KAAK+8I,kBAAmB,EAAA3wG,GAAA,IAAS,IAAMpsC,KAAKg9I,qBAAqB,KAAK,GAAM,GAC5Eh9I,KAAKw2G,0BAA2B,EAAAlvE,GAAA,GAAStnC,KAAK2hH,gBAAgBz4G,KAAKlJ,MAAO,KAAK,GAE/EA,KAAKu8I,SAA8B,eAAnBv8I,KAAKoiC,KAAKniC,KAGrB+oD,UACLhpD,KAAK0uI,uBAAuBgI,cAAcx1I,UAAUZ,SACpDN,KAAK0uI,uBAAuBlrI,QAAO,GACnCxD,KAAKiJ,eAAe0G,YACpB3P,KAAKi9I,yBAAwB,GAGxBt7B,gBAAgBlL,GACrB,GAAGz2G,KAAKu8I,SAAU,OAGlB,GAAGv8I,KAAK0c,QAAU1c,KAAKy8H,OACrB,OAGF,IAAIz8H,KAAKk8I,cAAgBl8I,KAAKm8I,aAAen8I,KAAK+M,MAChD,OAIF,IAAIwE,EAAKvR,KAAKoiC,KAAKqJ,QAAQswE,iBAAiB,UAE5C,IAAIxqG,EAAI,OAIR,MAAMtE,EAAMsE,EAAG3J,QAAQqF,IACpBsE,QAAcvH,IAARiD,GAEPjN,KAAKk9I,SAASjwI,EAAKwpG,GAIhBymC,QAAQjwI,EAAawpG,GAC1B,GAAGz2G,KAAKu8I,SAAU,OAGlB,GAAGv8I,KAAKy8H,OAAQ,OAIhB,IAAI+d,EAAuBx6I,KAAKm5B,KAAK7a,WAAW+9F,GAASA,GAAQpvG,IACjE,IAAqB,IAAlButI,GAAwBx6I,KAAKm9I,aAAa3C,GAEtC,MAAGx6I,KAAKm8I,WAAalvI,EAAMjN,KAAKm5B,KAAKn5B,KAAKm5B,KAAKx4B,OAAS,IAQ7D,YAJIX,KAAKq8I,yBACPr8I,KAAKq8I,uBAAyBr8I,KAAKo9I,gBAAgBnwI,OAA6BjD,IAAxBysG,KAH1D+jC,EAAex6I,KAAKm5B,KAAKx4B,OAAS,EAAIX,KAAKoxC,iBAH3CopG,GAAgBx6I,KAAKoxC,YAqBvB,GADgBpxC,KAAK87I,cAAgBtB,EACzB,CACV,GAAGx6I,KAAKi8I,0BAA+CjyI,IAAxBysG,IACL,IAArBz2G,KAAK87I,aAAqB97I,KAAK87I,YAActB,GAC9C,OAIJx6I,KAAK87I,YAActB,EACnBx6I,KAAK67I,UAAY77I,KAAKm5B,KAAK/mB,MAAMiqG,GAASA,GAAQpvG,KAAQjN,KAAKm5B,KAAKn5B,KAAKm5B,KAAKx4B,OAAS,GACvFX,KAAK+8I,oBAIDI,aAAa3C,GACnB,OAAQx6I,KAAK+M,MAAQ4uI,GAAkB/uE,cAEjC5sE,KAAKk8I,cAAgB1B,GAAgBmB,GAAkB0B,cACvDr9I,KAAKm8I,WAAcn8I,KAAK+M,MAAQ,EAAIytI,GAAiBmB,GAAkB0B,aAKjED,gBAAgBnwI,EAAaqwI,GAAe,G,0CACxD,IAAGt9I,KAAK+vC,QAAR,CACA/vC,KAAK+vC,SAAU,EAEf,IACE,MAAMjc,EAAM9zB,KAAKs8I,MAAQt8I,KAAK8zB,IAAI6rF,WAAW,wBAAqB31G,EAClE8pB,GAAOA,EAAI,QAAS7mB,EAAKqwI,GAEzB,IAAIC,GAAU,EACd,MAAM9zI,EAAW,CACfzJ,KAAK2S,SAAS40B,mBAAmB6e,UAAU,CACzC75C,OAAQvM,KAAKoiC,KAAK71B,OAClBI,YAAa,CAACC,EAAG,6BACjBF,MAAOO,EACPJ,MAAO8uI,GAAkB/uE,WACzBrmB,UAAWo1F,GAAkB/uE,aAE9BlrE,MAAM0D,IACLm4I,GAAU,EACHn4I,MAIX,IAAIpF,KAAK47I,aAAc,CACrB,MAAM9xI,EAAU9J,KAAK2S,SAAS40B,mBAAmBi2G,iBAAiBx9I,KAAKoiC,KAAK71B,QAAQ7K,MAAMksC,IACpFA,EAAElhC,QACN1M,KAAK47I,aAAehuG,EAAElhC,OAElB6wI,GAAWD,IACbt9I,KAAKm5B,KAAO,CAACn5B,KAAK47I,cAClB57I,KAAK+M,MAAQ6gC,EAAE7gC,MACf/M,KAAK87I,YAAc,EACnB97I,KAAK67I,UAAY77I,KAAKm5B,KAAK,GAC3Bn5B,KAAK+8I,wBAKTtzI,EAASoI,KAAK/H,GAGhB,MAAMwF,SAAgBnM,QAAQC,IAAIqG,IAAW,GAE7C,IAAIg0I,EAAcnuI,EAAOtC,QAAQsR,WAAWjR,GAAYA,EAAQJ,KAAOA,KACnD,IAAjBwwI,IACDA,EAAcnuI,EAAOtC,QAAQrM,QAK/BX,KAAKoxC,YAAc9hC,EAAOouI,iBAAmBpuI,EAAOouI,iBAAmBD,EAAc,EACrFz9I,KAAKm5B,KAAO7pB,EAAOtC,QAAQ2N,KAAKtN,GAAYA,EAAQJ,MAAKvM,QACzDV,KAAK+M,MAAQuC,EAAOvC,MAEhB/M,KAAK+M,OACP/M,KAAK0uI,uBAAuBlrI,QAAO,GAGrCxD,KAAKm8I,UAAan8I,KAAKoxC,YAAcpxC,KAAKm5B,KAAKx4B,SAAYX,KAAK+M,MAChE/M,KAAKk8I,cAAgBl8I,KAAKoxC,YAE1Btd,GAAOA,EAAI,SAAU7mB,EAAKqC,EAAQmuI,EAAaz9I,KAAKoxC,YAAapxC,KAAKm8I,UAAWn8I,KAAKk8I,cACtF,MAAMzuI,GACNzN,KAAK8zB,IAAInmB,MAAM,wBAAyBF,GAG1CzN,KAAK+vC,SAAU,EAEZ/vC,KAAK0c,OACN1c,KAAKk9I,QAAQjwI,GACLqwI,GACRt9I,KAAK2hH,gBAAgB,GAGvB3hH,KAAKq8I,uBAAyB,SAIzBsB,wBACL39I,KAAKi8I,qBAAsB,EAEvBj8I,KAAKo8I,2BACPp8I,KAAKo8I,yBAA2B,IAAI,ICzf3B,SAA+Bl4I,EAAmBogC,EAAwBx/B,EAAsBmE,GAC7G,GAAG,KAAoB,CACrB,IAAI20I,EACJ,MAAMh/I,EAAU,CAAC+I,SAAS,GAC1BsB,EAAe5J,IAAI6E,EAAnB+E,CAAyB,cAAe5I,IACnCA,EAAEkH,QAAQ5G,OAAS,EACpBm0B,KAIF8oH,EAAQv9I,EAAEkH,QAAQ,GAAG/B,QAErByD,EAAe5J,IAAI6E,EAAnB+E,CAAyB,YAAa0rB,EAAa/1B,GACnDqK,EAAe5J,IAAI6E,EAAnB+E,CAAyB,WAAY6rB,EAAYl2B,MAChDA,GAEH,MAAM+1B,EAAet0B,IACnB,MAAMmF,EAAUnF,EAAEkH,QAAQ,GAAG/B,QAEvBq4I,EAASr4I,EAAUo4I,GACDC,GAAQ/4I,IAEhC84I,EAAQp4I,GAIJsvB,EAAa,KACjB7rB,EAAeg0D,aAAa/4D,EAAM,YAAaywB,EAAa/1B,GAC5DqK,EAAeg0D,aAAa/4D,EAAM,WAAY4wB,EAAYl2B,SAG5DqK,EAAe5J,IAAI6E,EAAnB+E,CAAyB,SAAU5I,IACjC,MAAMw9I,EAASx9I,EAAE+4E,OAAS,GAEFykE,GAAQ/4I,MAE/B,CAAC6C,SAAS,IDsdXm2I,CAAsB99I,KAAKoiC,KAAKqJ,QAAQ3/B,WAAW5K,UAAW,GAAU,KACtElB,KAAKi9I,4BACJj9I,KAAKo8I,2BAILa,wBAAwBc,GAAkB,GAC/C/9I,KAAKi8I,qBAAsB,EAExBj8I,KAAKo8I,2BACNp8I,KAAKo8I,yBAAyBzsI,YAC9B3P,KAAKo8I,yBAA2B,MAG/B2B,GACD/9I,KAAK2hH,gBAAgB,GAIZq8B,+B,0CACXh+I,KAAK0c,QAAS,EAEd1c,KAAKs8I,OAASt8I,KAAK8zB,IAAI,gCACvB,IACE9zB,KAAK29I,wBAEL,MAAM9mC,EAAiB72G,KAAKoiC,KAAKy0E,eAC9BA,aAA0B1zG,gBACrB0zG,SAIF,WAEH72G,KAAKq8I,+BACAr8I,KAAKq8I,wBAGbr8I,KAAKs8I,OAASt8I,KAAK8zB,IAAI,wCACvB9zB,KAAK0c,QAAS,EAOd,MAAMjP,GACNzN,KAAK8zB,IAAInmB,MAAM,sCAAuCF,GAEtDzN,KAAK0c,QAAS,EACd1c,KAAKi8I,qBAAsB,EAC3Bj8I,KAAK2hH,gBAAgB,OAIZs8B,oBAAoBhxI,G,iDACTjN,KAAKoiC,KAAKy/D,WAAW50F,MAK3CjN,KAAKoiC,KAAK20E,aAAa9pG,IACtBjN,KAAKoiC,KAAKy0E,gBAAkB1zG,QAAQ4B,WAAWrD,MAAK,KACnD1B,KAAKg+I,+BACLh+I,KAAKk9I,QAAQl9I,KAAK87I,aAAgB97I,KAAK+M,MAAQ,EAAK/M,KAAK47I,aAAe3uI,EAAM,UAIrE+vI,oB,0CAQT,MAAMjwI,EAAQ/M,KAAK+M,MACnB,GAAGA,EAAO,CACR,MAAM+uI,EAAc97I,KAAK87I,YACnBzuI,QAAgBrN,KAAKoiC,KAAKy/D,WAAW7hG,KAAK67I,WAKxCqC,EAAyB,IAAhBpC,EACf97I,KAAK48I,gBAAgB17I,UAAU9B,UAAUoE,OAAO,UAAW06I,GAEvDA,GACFl+I,KAAK48I,gBAAgBpB,SAASzuI,EAAQ+uI,GAK1C97I,KAAK0uI,uBAAuBlrI,QAAO,GAEnC,MAAMq3I,EAAUiB,EAAc97I,KAAK+7I,eAEnC/7I,KAAKs8I,OAASt8I,KAAK8zB,IAAI,4BAA6B+mH,EAASiB,EAAa97I,KAAK+7I,gBAE/E,MAAMoC,EAAUn+I,KAAK08I,iBAAiBtC,OAAO0B,GACvCsC,EAAep+I,KAAK28I,cAAcvC,OAAO0B,GAC/CsC,EAAah/I,UAAUC,IAAI,wBAE3B,MAAMuvB,EAA+B,GAC/B+qC,QAAmBP,GAAuB,CAC9CtqD,WAAO9E,EACPi0B,QAAS,KACTwL,SAAWp8B,EAA4BA,QACvCmoC,WAAY2oG,EACZ9wI,QAAAA,EACAgsD,QAAS+kF,EACTxvH,aAAAA,UAGIzrB,QAAQC,IAAIwrB,GAElB5uB,KAAK0uI,uBAAuBgI,cAAcx1I,UAAU9B,UAAUoE,OAAO,WAAYm2D,GAG/E35D,KAAK08I,iBAAiBjsI,QAAQqrI,EAAa97I,KAAK+7I,gBAC7CpiF,GACD35D,KAAK28I,cAAclsI,QAAQqrI,EAAa97I,KAAKg8I,qBAC7Ch8I,KAAKg8I,oBAAsBF,GAE3B97I,KAAK28I,cAAcpC,YAIvBv6I,KAAKy8I,oBAAoBjsH,OAAOzjB,EAAOA,EAAQ+uI,EAAc,GAC7D97I,KAAK+7I,eAAiBD,EACtB97I,KAAK0uI,uBAAuBgI,cAAcx1I,UAAU0G,QAAQqF,IAAM,GAAKI,EAAQJ,SAE/EjN,KAAK0uI,uBAAuBlrI,QAAO,GACnCxD,KAAK+7I,eAAiB,EAGxB/7I,KAAK0uI,uBAAuBgI,cAAcx1I,UAAU9B,UAAUoE,OAAO,UAAWxD,KAAK+M,MAAQ,OAlblF,GAAA6/D,WAAa,GACb,GAAAywE,YAAc,E,eE5MhB,MAAMgB,WAAkBnxG,GACrCttC,YAAY2M,GACV1M,MAAM,aAAc,CAClB0M,OAAAA,EACAy9B,aAAc,gBACdmD,QAAS,CAAC,CACR5B,QAAS,wBACTzmC,SAAU,KACR9E,KAAK2S,SAAS40B,mBAAmB+2G,SAAS/xI,GAAkB,IAAV2H,EAAc,OAAa,EAAAs7H,GAAA,IAAM,GAAQt7H,MAG/F02B,MAAM,IAGR,MAsBMN,EArBgD,CAAC,CACrDp2B,KAFe,KAGfq3B,QAAS,uBACR,CACDr3B,KAAMqqI,MACNhzG,QAAS,wBACR,CACDr3B,KAAMqqI,MACNhzG,QAAS,wBACR,CACDr3B,KAAMqqI,MACNhzG,QAAS,sBACR,CACDr3B,KAAMqqI,OACNhzG,QAAS,uBACR,CACDr3B,MAAO,EACPq3B,QAAS,0BAIQ5wB,KAAKzG,GACV,IAAIm1B,GAAI,CAClBE,WAAY,IAAI0B,GAAW,CACzBM,QAASr3B,EAAKq3B,QACd9nC,KALO,YAMPjD,MAAO,GAAK0T,EAAKA,WAOvB,IAAIA,EACJ,MAAMsqI,EAAYn0G,GAAkBC,GAAO9pC,IACzC0T,GAAQ1T,KAGV8pC,EAAKA,EAAK3pC,OAAS,GAAG4oC,WAAWH,SAAU,EAE3C,MAAMjwB,EAAU,IAAIC,GAAe,CAAC45B,UAAU,EAAM5D,aAAa,IACjEj2B,EAAQpK,QAAQrP,OAAO8+I,GACvBx+I,KAAK4qC,KAAKlrC,OAAOyZ,EAAQjY,WAEzBlB,KAAKkvC,QCjEM,MAAMuvG,GAKnB7+I,YAAoB8+I,GAAA,KAAAA,OAAAA,EAClB1+I,KAAKynB,OAAS,EAGTk3H,UAAUl7I,EAAiBpC,GAAO,KACrCrB,KAAKynB,OACPznB,KAAK4+I,UAAYn7I,EAEjB,IACE,MAAM05B,EAAQn9B,KAAK6+I,cACnB1hH,EAAM77B,UAAW,EACjB67B,EAAM1W,IAlBQ,gBAkBYhjB,EAC1B05B,EAAM97B,KAAOA,EACb87B,EAAM96B,OACN,MAAMhC,GACNqN,QAAQC,MAAM,YAAalK,EAAMpD,IAI9By+I,qBAAqBr7I,EAAiBpC,GACxCrB,KAAK4+I,YAAcn7I,GACpBzD,KAAK2+I,UAAUl7I,EAAMpC,GAIlBw9I,cACL,IAAI,MAAC1hH,GAASn9B,KACd,OAAGm9B,IAIHA,EAAQn9B,KAAKm9B,MAAQ,IAAI4hH,MACzB5hH,EAAM96B,OACC86B,GAGF6hH,YACDh/I,KAAKm9B,OAITn9B,KAAKm9B,MAAMn7B,QAGNi9I,sBACHj/I,KAAKynB,OAGFy3H,qBAAqBz7I,EAAiBpC,EAAe4M,GAE1D,MAAMwZ,IAAWznB,KAAKynB,OACtBrhB,YAAW,KACNpG,KAAKynB,SAAWA,GAInBznB,KAAK2+I,UAAUl7I,EAAMpC,KACpB4M,IC5DP,IAAIkxI,GCRW,SAASC,KACtB,MAAMC,EAAqC,CACzCC,aAAc,GAgBhB,MAb8D,CAC5D,mBACA,mBACA,mBAGQlyI,SAASmyI,KCRN,SAA6BA,G,MAC1C,UAAiC,QAAvB,EAAS,OAAT/jI,gBAAS,IAATA,eAAS,EAATA,UAAWgkI,oBAAY,eAAEC,4BAAsEF,IDQpGG,CAAoBH,KAErBF,EAAYE,IAAc,MAIvBF,EEpBM,SAASM,GAAqBC,GAC3C,MAAMP,EAA6C,CAClD3uH,MAAO,CAGJnvB,MAAO,CAACiB,IAAK,MACbhB,OAAQ,CAACgB,IAAK,MACdq9I,UAAW,CAACr9I,IAAK,MAQrB,OAJIo9I,IACFP,EAAYliH,OAAQ,GAGfkiH,ECfM,SAAeS,GAAgBT,G,qCAC5C,MAAMU,QAAqBvkI,UAAUgkI,aAAaQ,gBAAgBX,GAGlE,OAFcU,EAAaE,iBAAiB,GACtCC,YAAc,OACbH,G,+RCJM,SAAeI,GAAUd,EAAqCz+G,G,qCAG5E,MAAMw/G,QAAe5kI,UAAUgkI,aAAaa,aAAahB,GAazD,OAZAe,EAAOE,YAAYlzI,SAASpG,IAQ3BA,EAAEm3C,SAAWvd,KAIPw/G,G,+RAGPt6I,OAAeq6I,UAAYA,GCPb,SAASI,KACtB,MAAMC,EASF,CACFl1G,KAAM,GACNm1G,OAAQ,IAGV,OAAa7hJ,IAOP,O,EAAA,K,OAAA,E,EAAA,YACJ,MAAM,SAAC8hJ,EAAQ,YAAErB,GAAezgJ,EAC1BmtB,EAAQy0H,EAAOE,EAAW,SAAW,QAC3C,IAAI52I,EAAgCiiB,EAAMszH,EAAYliH,MAAQ,QAAU,SAEpErzB,IACFA,GAAW42I,EAAWZ,GAAkBK,IAAWd,EAAczgJ,EAAgBgiC,OAC9Ey+G,EAAYliH,QAAUpR,EAAMoR,QAAOpR,EAAMoR,MAAQrzB,EAAQohB,SAAQ,IAAMa,EAAMoR,WAAQnzB,KACrFq1I,EAAY3uH,QAAU3E,EAAM2E,QAAO3E,EAAM2E,MAAQ5mB,EAAQohB,SAAQ,IAAMa,EAAM2E,WAAQ1mB,MAG1F,IACE,aAAaF,EAYb,MAAM2D,GACN,MAAMA,I,YAzBJ,K,+QA8BP3H,OAAey6I,gBAAkBA,G,eC9DnB,SAASI,GAAUC,GAChCA,EAAM79I,QACN,QAAc69I,EAAO,SCOR,MAAMC,GAInBjhJ,YAAoByV,EAAS,QAAT,KAAAA,OAAAA,EAClBrV,KAAK8+F,MAAQ,GACb9+F,KAAK8gJ,QAAU,GAGVzhJ,OAAO0hJ,GAEZ,OADA/gJ,KAAK8+F,MAAMjtF,QAAQkvI,GACZ/gJ,KAGF6R,KAAKmvI,GAEV,OADAhhJ,KAAK8gJ,QAAQjvI,KAAKmvI,GACXhhJ,KAGFihJ,UAAUzd,EAAY,IAG3B,OAFAxjI,KAAKX,IAAIW,KAAK8gJ,QAAQn9H,KAAK6/G,IAC3BxjI,KAAK8gJ,QAAU,GACR9gJ,KAGF2jB,OACL,OAAO3jB,KAAK8+F,MAAMn7E,KAAK3jB,KAAKqV,QAGvB6rI,WACL,OAAOlhJ,KAAK2jB,OAAS3jB,KAAKqV,QC5BvB,SAAS8rI,GAAiBnmB,GAChC,OAAOA,GAAU,EAKX,SAASomB,GAAmBpmB,GAClC,OAAOA,IAAW,ECGZ,SAASqmB,GAAiBC,GAC/B,MAAqB,eAAdA,EAA6B,QAAUA,EAczC,SAASC,GAA8BD,GAE5C,MAAqB,gBAAdA,EAA8B,YAAc,oBAG9C,SAASE,GAAuBF,EAA2BG,EAtBjC,IAsB2DC,GAC1F,MAAMC,EAAiBJ,GAA8BD,GACrD,MAAO,KAAKD,GAAiBC,MAAcG,KAAQE,KAAkBD,EAAW/9H,KAAK,OAOhF,MAAMi+H,WAAmBf,GACvBgB,aAAa/qI,GAClB,OAAO9W,KAAKX,IA3BT,SAA0ByX,GAC/B,MAAM8J,EAAgB,GAOtB,OANAA,EAAI/O,KAAK,gBACT+O,EAAI/O,KAAK,GAAGiF,EAAEgrI,cAAchrI,EAAEirI,aAAajrI,EAAEkrI,SAAShsE,iBAAiBl/D,EAAEmrI,YAAYnrI,EAAE89D,MAAM99D,EAAE2qI,YAAY3qI,EAAE7W,aACxF+J,IAAlB8M,EAAE,aACH8J,EAAI/O,KAAK,UAAUiF,EAAE,qBAAqBA,EAAE,eAE9C8J,EAAI/O,KAAK,eAAeiF,EAAEorI,cACnBthI,EAAI+C,KAAK,IAmBEw+H,CAAiBrrI,IAuB5BsrI,UAAUC,EAAaC,GAC5B,MAAMC,EAASD,EAAW3+H,KAAK,KAC/B,OAAO3jB,KAAKX,IACV,MACA,OAAOgjJ,qBACP,MACA,QACA,uBACA,kBAAkBE,IAClB,wBAEA,yBAIGC,aAAaC,EAAyCC,GAC3D1iJ,KAAKX,IACH,eAAeojJ,EAAUE,QACzB,aAAaF,EAAUG,MACvB,yBAGF,IAAI,MAAMC,KAAeJ,EAAUK,aACjC9iJ,KAAKX,IACH,iBAAiBwjJ,EAAY/3E,QAAQ+3E,EAAYA,cACjD,WAAWA,EAAYE,SAI3B,IAAIL,GAAkBD,EAAUO,WAC9B,IAAI,MAAMC,KAAaR,EAAUO,WAC/BhjJ,KAAK6hJ,aAAaoB,GAItB,OAAOjjJ,KAGFkjJ,QAAQnmI,GACb,IAAIomI,EAAa,UACb,KAACljJ,EAAI,aAAEmjJ,GAAgBrmI,EAI3B,MAAMi+G,EAASomB,GAAmBrkI,EAAMi+G,QAExCmoB,GAAcnoB,EACd/6H,GAAQ+6H,EAOR,MAIMqoB,EAAaC,IACjBtjJ,KAAKX,IACH,UAAUikJ,WAAcH,IACxB,UAAUG,UAAaH,KAAcljJ,IACrC,UAAUqjJ,aAAgBH,IAC1B,UAAUG,WAAcrjJ,MAiB5B,MA1BgB,MACdD,KAAKX,IAAI,UAAU8jJ,KAAcljJ,MAYnCsjJ,IACGH,MAAAA,OAAY,EAAZA,EAAcziJ,QACfyiJ,EAAah2I,SAASo2I,IACpB,GAAGA,EAAUC,QAAQ9iJ,OAAQ,CAC3B,MAAM8iJ,EAAUD,EAAUC,QAAQ9oI,IAAIymI,IACtCphJ,KAAKX,IAAI,gBAAgBmkJ,EAAUE,aAAaD,EAAQ9/H,KAAK,QAC7D8/H,EAAQr2I,QAAQi2I,OAIpBA,EAAUroB,GAGLh7H,KAGF2jJ,aAAa5mI,EAAwB4pB,EAAsBi9G,GAChE,MAAMvkJ,EAAM,IAAI2H,IAAgBhH,KAAKX,OAAO2H,IAEtC,KAAC/G,EAAI,IAAEgN,EAAG,UAAEnL,EAAS,KAAE2/I,GAAQ1kI,EAC/B0lI,EAAY97G,EAAK87G,UAMjBoB,EAAyB,gBAAT5jJ,EAChB6jJ,EAAQD,OAAgB75I,EAAY28B,EAAK1mC,GAEzC8jJ,EAA2B,aAAdjiJ,EACnB,GAAGib,EAAMinI,gBAAgBJ,GACvB,OAAOvkJ,EACL,KAAKgiJ,GAAiBphJ,QAAWshJ,GAA8BthJ,OAC/D,mBACA,aACA,SAASgN,KAIb,MAAMg3I,EAAgBJ,EAAyC,CAAC,CAACrzI,GAAI,MAA/BszI,EAAM,iBACtC92E,EAAMi3E,EAAatpI,KAAK1a,GAASA,EAAKuQ,KAC5CnR,EACEmiJ,GAAuBvhJ,EAAMwhJ,EAAMz0E,GACnC,mBACA,UAAUy0E,oBAGTgB,EAAU,aACXpjJ,EAAI,cAGNA,EAAI,SAAS4N,KAKb,IAAI9K,EAAeL,EAWnB,GAViB,aAAdA,IAA4B8hJ,GAAcG,GAAcF,IACzD1hJ,EAA6B,aAAdL,EAA2B,WAAa,YAIzDzC,EAAI,KAAK8C,KAGTnC,KAAKwiJ,aAAaC,GAEdoB,EAgCFxkJ,EAAI,aAAa4kJ,EAAa,GAAGzzI,iCAhChB,CACjB,MAAM0zI,EAAUJ,EAAM,gBACnBI,MAAAA,OAAO,EAAPA,EAASvjJ,SACVujJ,EAAQ92I,SAAS+2I,IACf9kJ,EAAI,YAAY8kJ,EAAO3zI,MAAM2zI,EAAOloI,UAIxCgoI,EAAa72I,SAASnN,IACpBZ,EAAI,YAAYY,EAAKuQ,MAAMvQ,EAAKwD,QAAQxD,EAAKmkJ,YAAYnkJ,EAAKosF,UAAYpsF,EAAKosF,SAAW,EAAI,IAAIpsF,EAAKosF,WAAa,MAEpH,MAAMg4D,EAAapkJ,EAAKokJ,WACxB,GAAGjzI,MAAMwxB,QAAQyhH,GACZA,EAAW1jJ,QACZ+M,QAAQC,MAAM,yBAA0B02I,QAErC,GAAGA,GAAcl4D,OAAOzuE,KAAK2mI,GAAY1jJ,OAAQ,CACtD,MAAMitC,EAAc,GACpB,IAAI,MAAM7hC,KAAKs4I,EACbz2G,EAAE/7B,KAAK,GAAG9F,KAAKs4I,EAAWt4I,MAE5B1M,EAAI,UAAUY,EAAKuQ,MAAMo9B,EAAEjqB,KAAK,QAGlC,MAAM2gI,EAAMrkJ,EAAK,aACdqkJ,MAAAA,OAAG,EAAHA,EAAK3jJ,SACN2jJ,EAAIl3I,SAASm3I,IACXllJ,EAAI,aAAaY,EAAKuQ,MAAM+zI,EAAGtkJ,OAAOskJ,EAAGC,QAAU,IAAMD,EAAGC,QAAU,YAY9E,OAJGznI,EAAMi+G,QAA4B,aAAjB74H,GAAgD,aAAjBA,GACjDnC,KAAKkjJ,QAAQnmI,GAGR/c,KAGFykJ,cAAc7lJ,GAMnB,MAAM,WAAC8lJ,EAAU,QAAE7nI,EAAO,OAAE0lI,EAAM,SAAEqB,GAAYhlJ,EAChDoB,KAAKoiJ,UAAUsC,EAAWC,UAAWpC,GAElC,GAAAqC,YACD5kJ,KAAKwiJ,aAAakC,EAAWjC,WAG/B,IAAI,MAAM1lI,KAASF,EAEjB7c,KAAK2jJ,cAAcC,EAAW7mI,EAAM8nI,WAAa9nI,EAAM+nI,UAAY/nI,EAAM+nI,WAAa/nI,EAAM8nI,YAAc9nI,EAAO2nI,EAAYd,GAG/H,OAAO5jJ,KAGFyjB,sBAAsB7kB,GAC3B,OAAO,IAAIgjJ,IAAa6C,cAAc7lJ,GAASsiJ,YC3OnD,MAAM6D,GAKJnlJ,YAAYmrB,EAAuBq1H,GACjC,MAAM4E,EAAehlJ,KAAKglJ,aAAej6H,EAAQk6H,wBAAwB7E,GACnE5W,EAAWxpI,KAAKwpI,SAAWz+G,EAAQ0+G,iBAC5BzpI,KAAKklJ,KAAOn6H,EAAQo6H,aAGjC3b,EAAS4b,aAAe,IACxB5b,EAAS6b,aAAe,GACxB7b,EAAS8b,sBAAwB,IACjC9b,EAASG,QAAU,KAGnBqb,EAAatb,QAAQF,IAKV,MAAM+b,GAkBnB3lJ,YAAoB4lJ,GAAA,KAAAA,SAAAA,EA0Ib,KAAAC,aAAgB1mI,IACrB,MAAM,eAAC2mI,EAAc,OAAEtF,EAAM,MAAEQ,EAAK,OAAE5lB,EAAM,KAAE/6H,GAAQ8e,EAChDyqH,EAAWkc,EAAelc,SAChC,IAAIA,EAAU,OAEd,MAAMtrH,EAAQ,IAAIwO,WAAW88G,EAASK,mBACtCL,EAASM,qBAAqB5rH,GAC9B,MAAM1d,EF1MH,SAAsB0d,EAAmBgxH,EAAQ,GACvD,IAAIhxH,EAAO,OAAO,EAElB,MAAM,OAACvd,GAAUud,EACjB,IAAI2L,EAAQ,EACZ,IAAI,IAAI9d,EAAI,EAAGA,EAAIpL,IAAUoL,EAC5B8d,GAAS3L,EAAMnS,GAAKmS,EAAMnS,GAE3B,MAAM45I,EAAMhjJ,KAAKmE,KAAK+iB,EAAQlpB,GAAU,IAExC,OAAOgC,KAAKC,IAAI,EAAG+iJ,EAAMzW,GEgMRuW,CAAavnI,GAE3B,MAAO,CACLje,KAAAA,EACA+6H,OAAAA,EACAolB,OAAAA,EACAQ,MAAAA,EACApgJ,MAAAA,IAIG,KAAAolJ,QAAU,KACf,MAAMxiJ,EAAMpD,KAAKytE,QAAU,GAAM,EAG3Bo4E,GAFgBziJ,EAAMpD,KAAKyc,MAAQzc,KAAKyc,MAAMkP,QAAQ3kB,GAAiB,UAAXA,EAAE/G,QACnC0rB,QAAQ3kB,GAAiB,UAAXA,EAAE6C,OACnBnJ,MAAM,EChPc,IDgP6Bia,IAAI3a,KAAKylJ,gBACnFzlJ,KAAKytE,SAAW,MACnBztE,KAAKytE,QAAU,GAGjB83E,GAAcO,kBAAkB91I,cAAc,YAAa,CACzD61I,WAAAA,EACA5lJ,KAAMmD,EAAM,MAAQ,WAtKtBpD,KAAK+qB,QAAU,IAAKjlB,OAAOigJ,cAAiBjgJ,OAAekgJ,oBAC3DhmJ,KAAKyc,MAAQ,GACbzc,KAAKimJ,aAAe,IAAIC,YACxBlmJ,KAAKmmJ,YAAc,IAAID,YACvBlmJ,KAAKytE,QAAU,EACfztE,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,MAClB7nE,KAAK8B,UAAY,WACjB9B,KAAKomJ,0BAA2B,EAEhCpmJ,KAAKyuE,MAAQ,CAAC,QAAS,SAGlB43E,UAAUjG,EAAqBngJ,GACpCmgJ,EAAOE,YAAYlzI,SAASwzI,IAC1B5gJ,KAAKsmJ,SAASlG,EAAQQ,EAAO3gJ,MAI1BqmJ,SAASlG,EAAqBQ,EAAyB3gJ,GAC5DD,KAAK8zB,IAAI,WAAY7zB,EAAM2gJ,EAAOR,GAElC,MAAM,QAACr1H,EAAO,MAAEtO,EAAK,YAAE0pI,EAAW,aAAEF,GAAgBjmJ,KAC9C6J,EAA2B+2I,EAAM/2I,KACjCmxH,EAASuqB,GAAcgB,UAAUnG,EAAQngJ,GAG/C,OAAOA,GACL,IAAK,QACCkmJ,EAGFA,EAAYG,SAAS1F,GAFrB5gJ,KAAKmmJ,YAAc/F,EAKrB,MAGF,IAAK,SACH,IAAI,IAAIr0I,EAAI,EAAGA,EAAI0Q,EAAM9b,SAAUoL,EAAG,CACpC,MAAO60I,MAAOvuI,EAAC,KAAEpS,EAAM+6H,OAAQwrB,GAAc/pI,EAAM1Q,GACnD,GAAGy6I,IAAexrB,GAAmB,UAAT/6H,EAAkB,CAC5Cwc,EAAM8B,OAAOxS,EAAG,GAChBk6I,EAAaQ,YAAYp0I,GACzB,OAIQ,UAATxI,GACDo8I,EAAaK,SAAS1F,GAO5B5gJ,KAAK0mJ,oBAAoB,CACvBzmJ,KAAAA,EACA+6H,OAAAA,EACAolB,OAAAA,EACAQ,MAAAA,EACA/2I,KAAAA,EACA67I,eAAyB,UAAT77I,EAAmB,IAAIk7I,GAAoBh6H,EAASq1H,QAAUp2I,IAGpE,UAATH,GAAoB7J,KAAKwlJ,UAC1BxlJ,KAAK2mJ,cAIDD,oBAAoB3nI,GAC1B,MAAM,MAAC6hI,GAAS7hI,EAChB6hI,EAAMxgJ,iBAAiB,SAAS,KAC9BJ,KAAKymJ,YAAY7F,KAChB,CAACp5I,MAAM,IAEVxH,KAAKyc,MAAM5K,KAAKkN,GAGX6nI,kBAAkB/8I,GACvB,OAAO7J,KAAKyc,MAAMrK,MAAM2M,GAAuB,UAAdA,EAAK9e,MAAoB8e,EAAKlV,OAASA,IAGnE4Z,iBAAiB28H,EAAqBngJ,GAC3C,MAAgB,UAATA,EAAoBmgJ,EAAOplB,QAAUolB,EAAO5vI,GAAM,GAAK2wI,IAAkBf,EAAO5vI,GAAGq2I,UAAU,IAG/FJ,YAAY7F,GACjB5gJ,KAAK8zB,IAAI,cAAe8sH,GAExB,MAAM,MAACnkI,GAASzc,KAEhB,IAAI8mJ,GAAU,EACd,IAAI,IAAI/6I,EAAI,EAAGpL,EAAS8b,EAAM9b,QAASmmJ,GAAW/6I,EAAIpL,IAAUoL,EAAG,CACjE,MAAO60I,MAAOvuI,EAAC,KAAEpS,GAAQwc,EAAM1Q,GAC/B,OAAO9L,GACL,IAAK,SACAoS,IAAMuuI,IACPnkI,EAAM8B,OAAOxS,EAAG,GAChB/L,KAAKimJ,aAAaQ,YAAY7F,GAC9BkG,GAAU,GAGZ,MAGF,IAAK,QACAz0I,IAAMuuI,IACPnkI,EAAM8B,OAAOxS,EAAG,GAChB/L,KAAKmmJ,YAAYM,YAAY7F,GAC7BkG,GAAU,IAQA,UAAflG,EAAM/2I,MAAoB7J,KAAKwlJ,UAChCxlJ,KAAK2mJ,cAIFI,kBAAkB3G,EAAqB4G,GAC5ChnJ,KAAKymJ,YAAYO,GACjBhnJ,KAAKqmJ,UAAUjG,EAAQ,SAGjBuG,mBACY38I,IAAfhK,KAAKinJ,OACNh+F,cAAcjpD,KAAKinJ,OAGlBjnJ,KAAKyc,MAAM9b,SACZX,KAAKinJ,MAAQnhJ,OAAO8hD,YAAY5nD,KAAK4lJ,QAAS5lJ,KAAKwlJ,WAkDhD0B,mBAAmBxC,GACxB,GAAG1kJ,KAAK0c,OACN,OAGF,MAAM,YAACypI,EAAW,UAAErkJ,EAAS,yBAAEskJ,GAA4BpmJ,KACrDmnJ,EAAyC,CAACrlJ,UAAAA,EAAWslJ,QAAS,CAACjB,IAC/D13E,EAAQzuE,KAAKyuE,MAAM9zD,KAAK1a,GACrB,CACLA,EAGEknJ,KAIAE,EAASlB,EAAY7F,YAE3B,IAAI,MAAOrgJ,EAAMknJ,KAAoB14E,EAAO,CAC1C,IAAI1xD,EAAQ2nI,EAAW4C,WAAWvqI,GAAUA,EAAMjb,YAAcA,GAAaib,EAAM9c,OAASA,IAC5F,IAAI8c,EAAO,CACT,IAAIqpI,EACF,SAGFrpI,EAAQ2nI,EAAW6C,YAAYtnJ,GAOjC,IAAI,YAACunJ,GAAezqI,EAChByqI,IACFA,EAAczqI,EAAM0qI,kBAAkB/C,EAAWgD,WAAYP,IAU5DpqI,EAAMjb,YAAc0lJ,EAAY1lJ,YACjC0lJ,EAAY1lJ,UAAYib,EAAMjb,WAGhC,MAAM6lJ,EAAiBtG,GAAiBphJ,GAClC2nJ,EAAWP,EAAO/oI,WAAWsiI,GAAUA,EAAM/2I,OAAS89I,IACtD/G,GAAsB,IAAdgH,EAAkBP,EAAO9oI,OAAOqpI,EAAU,GAAG,QAAK59I,EAC1D69I,EAASL,EAAYK,OACxBA,EAAOjH,QAAUA,GAKNiH,EAAOC,aAAalH,GAAO/yI,OAAOJ,IAC5CzN,KAAK8zB,IAAInmB,MAAMF,OAQhB1K,OACL,IACiB/C,KAAKmmJ,YAAY7F,YAAYhgI,OAAOtgB,KAAKimJ,aAAa3F,aAC9DlzI,SAASwzI,IACdD,GAAUC,MAEZ,MAAMvgJ,GACNL,KAAK8zB,IAAInmB,MAAMtN,KAlRL,GAAAylJ,kBAAoB,IAAI,IEvCzB,MAAeiC,WAA2D,IAYvFnoJ,cACEC,OAAM,GAEN,MAAMurF,EAASprF,KAAKorF,OAAStsF,SAASC,cAAc,OACpDqsF,EAAOhsF,UAAUC,IAAI,eACrB+rF,EAAOnoF,MAAMC,QAAU,OACvBpE,SAAS8rC,KAAKlrC,OAAO0rF,GAErBprF,KAAKi6B,SAAW,IAAIhpB,IAGpB,MAAMksB,EAAQn9B,KAAKm9B,MAAQ,IAAI4hH,MAC/B5hH,EAAM77B,UAAW,EACjB67B,EAAMi6G,OAAS,EACfp3I,KAAKorF,OAAO1rF,OAAOy9B,GACnBn9B,KAAKi6B,SAAShd,IAAI,QAASkgB,GAE3Bn9B,KAAKgoJ,iBAELhoJ,KAAKmgJ,UAAYI,KAGR0H,qBACT,QAASjoJ,KAAKkoJ,cAActB,kBAAkB,SAGrCuB,qBACT,QAASnoJ,KAAKkoJ,cAActB,kBAAkB,SAMzCoB,iBAELhoJ,KAAKm9B,MAAM96B,OAAOwL,MAAM8vB,GAAA,GAInByqH,mBAAmBxnH,GACxB,OAAO5gC,KAAKqoJ,oBAAmB,GAAM,EAAOznH,GAGvCynH,mBAAmBlrH,EAAgBzM,EAAgBkQ,GACxD,MAAM,cAACsnH,GAAiBloJ,KACxB,GAAGkoJ,EAAe,CAChB,MAAMI,GAAenrH,GAASn9B,KAAKioJ,eAC7BM,GAAe73H,GAAS1wB,KAAKmoJ,eACnC,GAAGG,GAAeC,EAChB,OAAOplJ,QAAQ4B,UAInB,MAAMs6I,EAAsC,CAC1CliH,MAAOA,GAASiiH,KAChB1uH,MAAOA,GC1FJ,CACLnvB,MAAO,CAACqB,IAAK,KAAMJ,IAAK,MACxBhB,OAAQ,CAACoB,IAAK,IAAKJ,IAAK,MACxBq9I,UAAW,CAACj9I,IAAK,GAAIJ,IAAK,MD0F1B,OAAOxC,KAAKmgJ,UAAU,CACpBd,YAAAA,EACAz+G,MAAAA,IACCl/B,MAAM0+I,IACPpgJ,KAAKwoJ,cAAcpI,MAIhBqI,gBACL,OAAOzoJ,KAAKmgJ,UAAU,CACpBO,UAAU,EACVrB,YAAaM,IAAqB,KACjCj+I,MAAM0+I,IACPpgJ,KAAKwoJ,cAAcpI,MAIhBsI,WAAWC,GAChB,OAAO3oJ,KAAKi6B,SAASzoB,IAAI,GAAKm3I,GAOzB14I,UACLjQ,KAAKorF,OAAOz4D,YAAc,GAC1B3yB,KAAKorF,OAAO9qF,SACZN,KAAKi6B,SAASlvB,QAGd/K,KAAKkoJ,cAAcnlJ,OAEnBlD,MAAMoQ,UAGD24I,QAAQt0H,GACbt0B,KAAK6oJ,YAAY,CACfzI,OAAQ9rH,EAAM8yH,QAAQ,GACtBxG,MAAOtsH,EAAMssH,MACb3gJ,KAAM,WAIH6oJ,qBAAqB1I,EAAqBngJ,GAC/C,MAAM2gJ,EAAQR,EAAOH,iBAAiB,GACtCjgJ,KAAK6oJ,YAAY,CACfzI,OAAAA,EACAQ,MAAAA,EACA3gJ,KAAM,QACN+6H,OAAQ/6H,GAAQ,SAIb4oJ,aAAY,OAACzI,EAAM,MAAEQ,EAAK,KAAE3gJ,EAAI,OAAE+6H,IACnCA,IACFA,EAASuqB,GAAcgB,UAAUnG,EAAQngJ,IAG3CD,KAAK8zB,IAAI,cAAessH,EAAQQ,EAAO3gJ,EAAM+6H,GAE7C,MAAM+tB,EAAoB,WAAT9oJ,GAEX,OAACmrF,EAAM,SAAEnxD,EAAQ,cAAEiuH,GAAiBloJ,KAEpCqH,EAAUu5I,EAAM/2I,KAChBm/I,EAAsB,UAAZ3hJ,EAEV4hJ,EAAkBD,EAAUhuB,EAAS3zH,EAC3C,IAAI+C,EAAU6vB,EAASzoB,IAAIy3I,GAExBD,GACDpI,EAAMxgJ,iBAAiB,SAAS,KAC9BJ,KAAK8zB,IAAI,mBACTmG,EAASvqB,OAAOu5I,KAEf,CAACzhJ,MAAM,IAGTuhJ,GACDb,EAAc5B,SAASlG,EAAQQ,EAAO3gJ,GAGxC,MAAMipJ,EAAYF,EAAU5I,EAAS8H,EAAcjC,aACnD,GAAI77I,EAuBCA,EAAQysB,QACTzsB,EAAQ/H,OAAOwL,MAAM8vB,GAAA,GAKrBvzB,EAAQ++I,UAAYD,MA7BX,CAMX,GALA9+I,EAAUtL,SAASC,cAAcsI,GACjC+C,EAAQ9I,UAAW,EACnB8I,EAAQ++I,UAAYD,EACpB9+I,EAAQgtI,OAAS,EAEc,cAA3BhtI,EAAgBg/I,OAAwB,CAC1C,MAAM,eAACC,GAAkBrpJ,KACtBqpJ,GACAj/I,EAAgBk/I,UAAUD,GAI3BL,GAGF5+I,EAAQ5K,aAAa,cAAe,QACpC4K,EAAQw2B,OAAQ,GAHhBwqD,EAAO7mF,YAAY6F,GAOrB6vB,EAAShd,IAAIgsI,EAAiB7+I,GAYhC,OAAO4wH,EAGFuuB,SAAS3oH,GACd5gC,KAAKkoJ,cAAc/B,YAAYqD,iBAAiBp8I,SAASwzI,IACpC,WAAhBA,MAAAA,OAAK,EAALA,EAAO/2I,QACR+2I,EAAMziG,aAAoBn0C,IAAV42B,GAAuBggH,EAAMziG,SAAWvd,MAKpD4nH,cAAcpI,GACtB,GAAIpgJ,KAAKypJ,UAaPrJ,EAAOE,YAAYlzI,SAASwzI,IAC1BD,GAAUC,UAdM,CACER,EAAOH,iBACZt/I,QACbX,KAAK8oJ,qBAAqB1I,EAAQ,QAGpC,MAAM,cAAC8H,EAAa,YAAEv6G,GAAe3tC,KACrCkoJ,EAAc7B,UAAUjG,EAAQ,SAE7BzyG,GACDu6G,EAAchB,mBAAmBv5G,KExNlC,MAAM+7G,GAaX9pJ,YAAmBqN,EAAoBhN,GAApB,KAAAgN,IAAAA,EAAoB,KAAAhN,KAAAA,EACrCD,KAAKyhJ,KLVwB,IKaxBt/I,aAAaL,GAKlB,OAJI9B,KAAK2pJ,oBACP3pJ,KAAK2pJ,kBAAoB7nJ,GAGpB9B,KAAK8B,UAAYA,EAGnB8nJ,QAAQnI,GACb,OAAOzhJ,KAAKyhJ,KAAOA,EAGdoI,YAAYlB,GACjB,OAAO3oJ,KAAK2oJ,SAAWA,EAGlB7yB,UAAUvpH,GACf,OAAOvM,KAAKuM,OAASA,EAGhBk7I,kBAAkBC,EAA+Br4I,GAKtD,OAJGA,MAAAA,OAAI,EAAJA,EAAMvN,YACP9B,KAAKmC,aAAakN,EAAKvN,WAGlB9B,KAAKwnJ,YAAcE,EAAWoC,eAAezI,GAAiBrhJ,KAAKC,MAAOoP,GAG5E06I,UAAU/uB,GACf,IAAIooB,EACJ,GAAGhyI,MAAMwxB,QAAQo4F,GAAS,CACxB,IAAIA,EAAO,GAAI,OACfooB,EAAepoB,EACfA,EAASooB,EAAa,GAAGK,QAAQ,GAInC,OADAzjJ,KAAKojJ,aAAeA,EACbpjJ,KAAKg7H,OAASA,EAGhBgpB,gBAAgBJ,GACrB,OAAOA,GAA+B,aAAnB5jJ,KAAK8B,WAIrB,SAASkoJ,GAAa/pJ,EAAsB+6H,EAAyD2tB,GAC1G,IAAIvF,EACJ,GAAGhyI,MAAMwxB,QAAQo4F,GAAS,CACxB,IAAIA,EAAO,GAAI,OACfooB,EAAepoB,EACfA,EAASooB,EAAa,GAAGK,QAAQ,GAGnC,MAAO,CACLkF,SAAAA,EACA1oJ,KAAAA,EACA+6H,OAAAA,EACAooB,aAAAA,GAIW,MAAM6G,GAcnBrqJ,YAAmB8nJ,GAAA,KAAAA,WAAAA,EACjB1nJ,KAAK2kJ,UAAY,GAAKj/I,KAAKC,MAE3B3F,KAAKkqJ,WAAa,EAClBlqJ,KAAK6c,QAAU,GACf7c,KAAKmqJ,aAAe,IAAIl5I,IACxBjR,KAAKoqJ,gBAAkB,IAAIn5I,IAC3BjR,KAAKqqJ,gBAAkB,IAAIp5I,IAGtBq5I,QAAQ3jH,GACb,OAAO,EAAA31B,EAAA,GAAWhR,KAAM2mC,GAGnB4gH,YAAYtnJ,GACjB,MAAMgN,EAAM,MAAOjN,KAAKkqJ,UAClBntI,EAAQ,IAAI2sI,GAAgBz8I,EAAKhN,GAGvC,OAFAD,KAAK6c,QAAQhL,KAAKkL,GAClB/c,KAAKmqJ,aAAaltI,IAAIhQ,EAAK8P,GACpBA,EAGFwtI,YAAYxtI,IACjB,EAAAhL,EAAA,GAAiB/R,KAAK6c,QAASE,GAC/B/c,KAAKmqJ,aAAaz6I,OAAOqN,EAAM9P,KAC/BjN,KAAKoqJ,gBAAgB16I,OAAOqN,EAAMi+G,QAElC,MAAM/9G,EAAMjd,KAAKqqJ,gBAAgB74I,IAAIuL,EAAMxQ,QACxC0Q,IACDA,EAAIvN,OAAOqN,GACPE,EAAIjc,MACNhB,KAAKqqJ,gBAAgB36I,OAAOqN,EAAMxQ,SAKjCi+I,eAAeztI,EAAwBi+G,GAC5Cj+G,EAAMgtI,UAAU/uB,GAChBh7H,KAAKoqJ,gBAAgBntI,IAAIF,EAAMi+G,OAAQj+G,GAGlC0tI,eAAe1tI,EAAwBxQ,GAC5CwQ,EAAM+4G,UAAUvpH,GAChB,IAAI0Q,EAAMjd,KAAKqqJ,gBAAgB74I,IAAIjF,GAC/B0Q,GACFjd,KAAKqqJ,gBAAgBptI,IAAI1Q,EAAQ0Q,EAAM,IAAI2B,KAG7C3B,EAAI5d,IAAI0d,GAGHuqI,UAAUnpI,GACf,OAAOne,KAAK6c,QAAQzK,KAAK+L,GAGpBusI,sBAAsBzqJ,EAAsB0qJ,GACjD,IAAI5tI,EAAQ/c,KAAK6c,QAAQzK,MAAM2K,GACF,aAApBA,EAAMjb,WAA4Bib,EAAM9c,OAASA,KAAU0qJ,EAAY5tI,EAAM+nI,UAAY/nI,EAAM8nI,aAQxG,OALI9nI,IACFA,EAAQ/c,KAAKunJ,YAAYtnJ,GACzB8c,EAAM5a,aAAa,aAGd4a,EAGF6tI,cAAc39I,GACnB,OAAOjN,KAAKmqJ,aAAa34I,IAAIvE,GAGxB49I,iBAAiB7vB,GACtB,OAAOh7H,KAAKoqJ,gBAAgB54I,IAAIwpH,GAG3B8vB,mBAAmBv+I,GACxB,OAAOvM,KAAKqqJ,gBAAgB74I,IAAIjF,GAG3Bw+I,YAAYnsJ,GACjB,OAAOgjJ,GAAWoJ,eAAe,OAAD,QAC9BtG,WAAY1kJ,MACTpB,KC5KM,MAAeqsJ,GAY5BrrJ,YAAYhB,G,OACV,EAAAoS,EAAA,GAAWhR,KAAMpB,GAEboB,KAAK8zB,MACP9zB,KAAK8zB,KAAqB,QAAf,EAAA9zB,KAAK0nJ,kBAAU,eAAE5zH,OAAO,EAAA+zC,GAAA,IAAO,yBAG5C7nE,KAAKyjJ,QAAU,GAGVyH,qBAAqB1xB,GAC1B,OAAOx5H,KAAK0nJ,aAAe1nJ,KAAK0nJ,WCnCrB,SAA8BluB,EAA0B1lG,GACjEA,IACFA,GAAM,EAAA+zC,GAAA,IAAO,sBAGf/zC,EAAI,eAGJ,MAAM4zH,EAAa,IAAIyD,kBAAkB3xB,GAyBzC,OAxBAkuB,EAAWtnJ,iBAAiB,SAAUk0B,IACpCR,EAAI,UAAWQ,MAEjBozH,EAAWtnJ,iBAAiB,wBAAwB,KAClD0zB,EAAI,yBAA0B4zH,EAAW0D,mBAE3C1D,EAAWtnJ,iBAAiB,yBAAyB,KACnD0zB,EAAI,0BAA2B4zH,EAAW2D,oBAE5C3D,EAAWtnJ,iBAAiB,qBAAqB,KAC/C0zB,EAAI,sBAAuB4zH,EAAW0D,mBAExC1D,EAAWtnJ,iBAAiB,gBAAiBk0B,IAC3CR,EAAI,iBAAkBQ,MAExBozH,EAAWtnJ,iBAAiB,4BAA4B,KACtD0zB,EAAI,6BAA8B4zH,EAAW4D,uBAE/C5D,EAAWtnJ,iBAAiB,eAAe,KACzC0zB,EAAI,oBAGN4zH,EAAW5zH,IAAMA,EAEV,CAAC4zH,WAAAA,GDEuCwD,CAAqB1xB,EAAQx5H,KAAK8zB,IAAI6rF,WAAW,eAAe+nC,YAGxG6D,kBAAkBC,GACvB,OAAOxrJ,KAAKyrJ,cAAgBzrJ,KAAKyrJ,YEvCtB,SAA2B/D,EAA+B8D,EAA2B13H,GAG9FA,IACFA,GAAM,EAAA+zC,GAAA,IAAO,mBAGf,MAAM6jF,EAAUhE,EAAW6D,kBAAkB,OAAQC,GAcrD,OAZAE,EAAQtrJ,iBAAiB,WAAYC,IACnCyzB,EAAI,YAAazzB,MAEnBqrJ,EAAQtrJ,iBAAiB,QAAQ,KAC/B0zB,EAAI,aAEN43H,EAAQtrJ,iBAAiB,SAAS,KAChC0zB,EAAI,cAGN43H,EAAQ53H,IAAMA,EAEP43H,EFkB0CH,CAAkBvrJ,KAAK0nJ,WAAY8D,EAAMxrJ,KAAK8zB,IAAI6rF,WAAW,UAGvGgsC,oBACL,OAAO3rJ,KAAK2tC,cAAgB3tC,KAAK2tC,YAAc,IAAIs8G,GAA2BjqJ,KAAK0nJ,aAG9EkE,2BACL,OAAO5rJ,KAAKkoJ,cAAchB,mBAAmBlnJ,KAAK2tC,aAG7Ck+G,kBACL,MAAM,WAACnE,GAAc1nJ,KACrB,GAAI0nJ,EAIJ,IACEA,EAAW5zH,IAAI,SACf4zH,EAAWz4I,QACX,MAAM5O,GACNL,KAAK8zB,IAAInmB,MAAMtN,IAIZyrJ,yBAAyBC,GAC9B/rJ,KAAK6rJ,kBACLE,GAAc/rJ,KAAKkoJ,cAAcnlJ,OAK5BipJ,YAEL,OADchsJ,KAAKisJ,cAKZjsJ,KAAKisJ,YAAcjsJ,KAAKksJ,oBAAoBhhI,SAAQ,KACzDlrB,KAAKisJ,iBAAcjiJ,MAIhBmiJ,oBAAoBxlH,GACU,SAAhC3mC,KAAKyrJ,YAAY5sH,YAIpB7+B,KAAKyrJ,YAAYx1B,KAAKpuF,KAAKC,UAAUnB,K,gqBG9E1B,MAAMylH,GAInBxsJ,YAAYw1E,EAAyBi3E,GAHrC,oBACA,oBAGE,GAAArsJ,KAAI,GAAYo1E,EAAO,KACvB,GAAAp1E,KAAI,GAAUqsJ,EAAa,KAGlBj3E,cACT,OAAO,GAAAp1E,KAAI,QAGFguB,YACT,OAAO,GAAAhuB,KAAI,QAGFuiJ,aAET,OADmBviJ,KAAKo1E,QAAQ0pB,MAAM1sF,MAAM8S,IAAQ,MAAC,MAAqB,WAAV,QAAX,EAAAA,EAAKonI,cAAM,eAAEz8I,QAChDrP,MAAMkiC,MAAM,KAAKhiC,MAAM,GAG3CgwC,WACE,OAAO1wC,KAAKo1E,QAAQ0pB,MACnBx+E,UAAUtgB,KAAKguB,MAAMrT,KAAKxB,GAAYA,EAAQ2lF,SAC9CnkF,KAAKuK,GAASA,EAAKwrB,aAAY/sB,KAAK,QAAU,QCpCpC,SAAS4oI,GAA2Bn7H,EAAaoyG,EAAmB32H,GACjF,MAAMyzC,EAAWlvB,EAAIsR,MAAM8gG,GACrBplH,EAAgB,GAEtB,KAAMvR,EAAQ,GAAKyzC,EAAS3/C,QAC1Byd,EAAIvM,KAAKyuC,EAASpzC,WAChBL,EAOJ,OAJGyzC,EAAS3/C,QACVyd,EAAIvM,KAAKyuC,EAAS38B,KAAK6/G,IAGlBplH,E,isBCbM,MAAMouI,GAKnB5sJ,YAAYgD,EAAaJ,GAJzB,oBACA,oBACA,oBAGE,GAAAxC,KAAI,GAAQ,IAAI4e,IAAK,KACrB,GAAA5e,KAAI,GAAQ4C,EAAG,KACf,GAAA5C,KAAI,GAAQwC,EAAG,KAGViqJ,WACL,MAAM7pJ,EAAM,GAAA5C,KAAI,QACVwC,EAAM,GAAAxC,KAAI,QACVid,EAAM,GAAAjd,KAAI,QAEV0sJ,EAAWlqJ,EAAMI,EAAM,EAC7B,IAAIpC,EAAQmC,KAAK6uB,MAAM5uB,EAAM8pJ,EAAW/pJ,KAAKsiC,UAAW0nH,EAAO,EAC/D,KAAM1vI,EAAIk1B,IAAI3xC,IAOZ,GANGA,EAAQgC,IACPhC,EAEFA,EAAQoC,IAGL+pJ,GAAQD,EACX,OAAO,KAKX,OADAzvI,EAAI5d,IAAImB,GACDA,EAGFnB,IAAImB,GACT,GAAAR,KAAI,QAAMX,IAAImB,I,6sBCjCH,MAAMosJ,GAKnBhtJ,YAAYiQ,EAAmBrP,GAJ/B,oBACA,oBAIE,GAAAR,KAAI,GAAQ6P,EAAG,KACf,GAAA7P,KAAI,GAAUQ,EAAK,KAGVqP,UACT,OAAO,GAAA7P,KAAI,QAGFQ,YACT,OAAO,GAAAR,KAAI,S,osBCjBA,MAAM6sJ,GAMnBjtJ,YACEK,EACAwhJ,EACAO,EACAh1E,GATF,oBACA,oBACA,oBACA,oBAQE,GAAAhtE,KAAI,GAASC,EAAI,KACjB,GAAAD,KAAI,GAASyhJ,EAAI,KACjB,GAAAzhJ,KAAI,GAAagiJ,EAAQ,KACzB,GAAAhiJ,KAAI,GAAQgtE,EAAG,KAGN/sE,WACT,OAAO,GAAAD,KAAI,QAGFyhJ,WACT,OAAO,GAAAzhJ,KAAI,QAGFgiJ,eACT,OAAO,GAAAhiJ,KAAI,QAGFgtE,UACT,OAAO,GAAAhtE,KAAI,QAGb0wC,WACE,OAAO1wC,KAAKC,KAAO,IAAMD,KAAKyhJ,KAAO,IAAMzhJ,KAAKgiJ,SAAW,IAAMhiJ,KAAKgtE,IAAIrpD,KAAK,M,kuBC/BpE,MAAMmpI,GAOnBltJ,YAAYiQ,EAAqBrP,GAG/B,GATF,oBACA,oBACA,oBACA,oBAIE,GAAAR,KAAI,GAAQ6P,EAAG,KAEM,iBAAZ,GAGP,GAFA,GAAA7P,KAAI,GAAUQ,EAAK,KAER,MAARqP,EAAa,CACd,MAAMywC,EAAW9/C,EAAMkiC,MAAM,KAC7B,GAAA1iC,KAAI,GAAmB,IAAI6sJ,GAAkBvsG,EAAS,GAAWA,EAAS,GAAIA,EAAS,GAAIA,EAAS5/C,MAAM,IAAG,UAE7G,GAAW,MAARmP,EAAa,CACd,MAAMP,EAASi9I,GAA2B/rJ,EAAO,IAAK,GACtDA,EAAQ8O,EAAO,GACf,GAAAtP,KAAI,GAA6B,IAAlBsP,EAAO3O,OAAe,IAAIisJ,GAAqBpsJ,EAAc,MAAQ,IAAIosJ,GAAqBpsJ,EAAc8O,EAAO,IAAG,WAItI9O,aAAiBqsJ,IAClB,GAAA7sJ,KAAI,GAAmBQ,EAAK,KAC5B,GAAAR,KAAI,GAAUQ,EAAMkwC,WAAU,MACtBlwC,aAAiBosJ,KACzB,GAAA5sJ,KAAI,GAAWQ,EAAK,KACpB,GAAAR,KAAI,GAAUQ,EAAMA,MAAQ,GAAGA,EAAMqP,OAAOrP,EAAMA,QAAUA,EAAMqP,IAAG,MAKhEA,UACT,OAAO,GAAA7P,KAAI,QAGFQ,YACT,OAAO,GAAAR,KAAI,QAGFssJ,aACT,OAAO,GAAAtsJ,KAAI,QAGF+sJ,qBACT,OAAO,GAAA/sJ,KAAI,QAGb0wC,WACE,MAAO,GAAG1wC,KAAK6P,OAAO7P,KAAKQ,S,wuBCrDhB,MAAMwsJ,GAQnBptJ,YAAYiQ,EAA+BivF,EAAmChlE,EAAiB,IAAKmzH,GAAS,GAP7G,oBACA,oBACA,oBACA,oBACA,oBACA,oBAGE,GAAAjtJ,KAAI,GAAQ6P,EAAG,KACf,GAAA7P,KAAI,GAAU8+F,EAAK,KACnB,GAAA9+F,KAAI,GAAW85B,EAAM,KACrB,GAAA95B,KAAI,GAAWitJ,EAAM,KACrB,GAAAjtJ,KAAI,GAAcitJ,EAAS,IAAIh8I,IAAQ,KAAI,KAC3C,GAAAjR,KAAI,GAASitJ,EAAS,GAAK,KAAI,KAGtBnuD,YACT,OAAO,GAAA9+F,KAAI,QAGFQ,YACT,OAAO,GAAAR,KAAI,UAAaA,KAAK8+F,MAAMn+F,OAAS,KAAOX,KAAK8+F,MAAM,GAGrDouD,aACT,OAAQ,GAAAltJ,KAAI,QAGH6P,UACT,OAAO,GAAA7P,KAAI,QAGF0d,WAET,OADAsvI,GAAkBx4F,KAAKx0D,MAChB,GAAAA,KAAI,QAGNoN,QAAQtI,GACbkoJ,GAAkBx4F,KAAKx0D,MACvB,GAAAA,KAAI,QAAYoN,QAAQtI,GAGnB0M,IAAI3B,GAET,OADAm9I,GAAkBx4F,KAAKx0D,MAChB,GAAAA,KAAI,QAAYwR,IAAI3B,IAAQ,IAAIm9I,GAAkBn9I,EAAK,GAAI,KAAK,GAGjE4T,YAAY4X,GAClB,GAA4B,OAAzB,GAAAA,EAAS,QACV,OAGF,MAAM1gB,EAAkC,IAAI1J,IAC5CoqB,EAAUyjE,MAAM1xF,SAASgkB,IACvB,MAAOvhB,EAAKs9I,GAAQZ,GAA2Bn7H,EAAK,GAAAiK,EAAS,QAAU,GACjE4a,EAASt7B,EAAInJ,IAAI3B,IAAQ,GAC/B8K,EAAIsC,IAAIpN,EAAK,IAAIomC,EAAQk3G,GAAQ,QAGnC,MAAMC,EAAY,GAAA/xH,EAAS,GAAc2xH,GAAkBK,eAAe1yI,GAAI,KAC9E,GAAA0gB,EAAS,GAASjqB,MAAMC,KAAK+7I,EAAU1vI,QAAO,KAGxC+F,sBAAsB6pI,GAC5B,MAAMlvI,EAAsC,IAAInN,IAMhD,OAJAq8I,EAAWlgJ,SAAQ,CAAC0xF,EAAOjvF,KACzBuO,EAAInB,IAAIpN,EAAK,IAAIm9I,GAAkBn9I,EAAKivF,OAGnC1gF,G,0vBCtEI,MAAMmvI,GAInB3tJ,YAAYk/F,GAHZ,oBACA,oBAGE,GAAA9+F,KAAI,GAAU8+F,EAAK,KACnB,GAAA9+F,KAAI,GAAe,IAAIiR,IAAK,KAC5Bs8I,GAAcC,eAAextJ,MAGxBwR,IAAI3B,GACT,OAAO,GAAA7P,KAAI,QAAawR,IAAI3B,IAAQ,IAAIm9I,GAAkBn9I,EAAK,GAAI,KAAK,GAGlE4T,sBAAsB2X,GAC5B,MAAMqyH,EAA4C,IAAIx8I,IACtD,GAAAmqB,EAAU,QAAQhuB,SAAS8X,IACzB,GAAgB,MAAbA,EAAKrV,IAAa,CACnB,MAAM,IAACA,EAAG,MAAErP,GAAS0kB,EAAKonI,OAE1B,IAAIoB,EAAaD,EAAcj8I,IAAI3B,GAC/B69I,IACFA,EAAa,GACbD,EAAcxwI,IAAIpN,EAAK69I,IAGzBA,EAAW77I,KAAKrR,GAAS,QAI7BitJ,EAAcrgJ,SAAQ,CAACsgJ,EAAY79I,KACjC,GAAAurB,EAAU,QAAane,IAAIpN,EAAK,IAAIm9I,GAAkBn9I,EAAK69I,EAAY,KAAK,Q,osBC5BnE,MAAMC,GAMnB/tJ,YAAYk/F,GALZ,oBACA,oBACA,oBACA,oBAGE,GAAA9+F,KAAI,GAAU8+F,EAAK,KACnB,GAAA9+F,KAAI,GAAc8+F,EAAM,GAAE,KAC1B,GAAA9+F,KAAI,GAAe,GAAAA,KAAI,GAAc,KAAI,UAGhC8+F,YACT,OAAO,GAAA9+F,KAAI,QAGF4tJ,gBACT,OAAO,GAAA5tJ,KAAI,QAGF+sJ,qBACT,OAAO,GAAA/sJ,KAAI,QAAY+sJ,eAGdzL,gBACT,OAAOthJ,KAAK+sJ,eAAe9sJ,KAGlB6B,gBACT,IAAI,GAAA9B,KAAI,QAAa,CACnB,MAAMo7B,EAAap7B,KAAKo7B,WAExB,IAAIt5B,EACkCA,EAAnCs5B,EAAW5pB,IAAI,YAAY07I,OAAoB,WAC1C9xH,EAAW5pB,IAAI,YAAY07I,OAAoB,WAC/C9xH,EAAW5pB,IAAI,YAAY07I,OAAoB,WACtC,WAEjB,GAAAltJ,KAAI,GAAc8B,EAAS,KAG7B,OAAO,GAAA9B,KAAI,QAGF2qJ,gBACT,MAA0B,aAAnB3qJ,KAAK8B,WAA+C,aAAnB9B,KAAK8B,UAGpC+rJ,kBACT,MAA0B,aAAnB7tJ,KAAK8B,WAA+C,aAAnB9B,KAAK8B,UAGpCs5B,iBAET,OADA,GAAAp7B,KAAI,SAAiB,GAAAA,KAAI,GAAe,IAAIutJ,GAAcvtJ,KAAK8+F,OAAM,KAC9D,GAAA9+F,KAAI,QAGFiN,UACT,OAAOjN,KAAKo7B,WAAW5pB,IAAI,OAAOhR,MAG7BstJ,oBAA4CpwI,GACjD,MAAMU,EAAW,GAEjB,IAAI,MAAMvO,KAAO6N,EAAM,CACrB,MAAMpO,EAAStP,KAAKo7B,WAAW5pB,IAAI3B,GAE7Bk+I,GAAuBrwI,EAAK7N,GAIhCuO,EAAIvO,GAHFP,EAGSy+I,EAAsBz+I,EAAOwvF,MAAQxvF,EAAO9O,MAF5CutJ,EAAsB,QAAK/jJ,EAM1C,OAAOoU,G,4tBC/EI,MAAM4vI,GAInBpuJ,YAAYk/F,GAHZ,oBACA,oBAGE,GAAA9+F,KAAI,GAAU8+F,EAAK,KACnB,GAAA9+F,KAAI,GAAc8+F,EAAMnzE,QAAQzG,GAAsB,MAAbA,EAAKrV,MAAa8K,KAAKuK,GAASA,EAAK1kB,MAAMkiC,MAAM,KAAK,KAAI,GAAE,KAG5Fo8D,YACT,OAAO,GAAA9+F,KAAI,QAGF2kJ,gBACT,OAAO,GAAA3kJ,KAAI,SCTR,SAASiuJ,GAAS78H,GACvB,SAAS88H,IACJC,EACD9B,EAAcx6I,KAAK,IAAI87I,GAAgB7uD,IAEvCqvD,EAAiB,IAAIH,GAAkBlvD,GAI3C,IAAIqvD,EAAoC,KAAM9B,EAAmC,GAAIvtD,EAAmB,GAcxG,OAbA1tE,EAAIsR,MAAM,SAASt1B,SAASghJ,IAC1B,IAeG,SAA4Bh9H,GACjC,MAAO,cAAc6a,KAAK7a,GAhBpBi9H,CAAmBD,GAAU,CAC/B,MAAMlpI,EAAOopI,GAAaF,GACV,MAAblpI,EAAKrV,MACNq+I,IACApvD,EAAQ,IAGVA,EAAMjtF,KAAKqT,OAIfgpI,IACO,IAAI9B,GAAI+B,EAAgB9B,GAO1B,SAASiC,GAAal9H,GAC3B,MAAMkvB,EAAWisG,GAA2Bn7H,EAAK,IAAK,GACtD,OAAO,IAAI07H,GAAQxsG,EAAS,GAAWA,EAAS,IClCnC,SAASiuG,GAAsBC,EAAU9C,GACtD,MAAM+C,EAAa/C,EAAQoC,oBAAoB,CAC7C,aAAa,EACb,WAAW,EACXjL,aAAa,EACbE,OAAO,EACPO,MAAM,EACNr2I,KAAK,EACL,cAAc,IAGhB,IAAIwhJ,EAAW5L,YAAa,CAC1B,MAAM39H,EAAOspI,EAAIp5E,QAAQ0pB,MAAM1sF,MAAM8S,IAAQ,MAAC,MAAqB,iBAAV,QAAX,EAAAA,EAAKonI,cAAM,eAAEz8I,QAC3D4+I,EAAW5L,YAAc39H,EAAKonI,OAAO9rJ,MAGvC,MAAMkuJ,EClBD,SAA2BC,GAChC,MAAMD,EAAuBC,EAASh0I,KAAKyW,IACzC,MAAOsyH,KAAcyJ,GAAQ/7H,EAAIsR,MAAM,KASvC,MAP0D,CACxD91B,EAAG,uCACH82I,UAAAA,EAEAD,QAAS0J,EAAKxyI,KAAK2oI,GAASnC,IAAkBmC,SAYlD,OAAOoL,EAAqB/tJ,OAAS+tJ,OAAuB1kJ,EDF/B4kJ,CAAkBH,EAAW,gBACnD3jF,EAAM+3E,GAAe4L,EAAW5L,YAAYngH,MAAM,IAAK,GACxD4gH,EAAOmL,EAAWnL,MAAQnC,IAAkBsN,EAAWnL,KAAK5gH,MAAM,IAAK,GAAG,IAGhF,MAAO,CACLmsH,IAAKJ,EACL9L,MAAO8L,EAAW,aAClB7L,IAAK6L,EAAW,WAChB5L,YAAa,CACXA,YAAAA,EACAE,MAAO0L,EAAW1L,MAClBj4E,KAAAA,GAEFkwD,OAAQsoB,EACRF,aAAcsL,EACdzhJ,IAAKwhJ,EAAWxhJ,K,kCErCf6hJ,G,uSCgBU,MAAMC,WAAoC9D,GAkBvDrrJ,YAAYhB,GAMViB,MAAMjB,GAENoB,KAAKgvJ,oBAAqB,EAAA1nH,GAAA,GAAStnC,KAAKgsJ,UAAU9iJ,KAAKlJ,MAAO,GAAG,GAG5DkrJ,uBACL,OAAOlrJ,KAAK0nJ,YAAc7nJ,MAAMqrJ,qBAAqB,CACnD+D,WAAY,GACZC,mBAAoB,MACpBC,aAAc,aACdC,cAAe,UACfC,qBAAsB,IAMnB9D,oBACL,GAAGvrJ,KAAKyrJ,YACN,OAAOzrJ,KAAKyrJ,YAGd,MAAMA,EAAc5rJ,MAAM0rJ,oBAa1B,OAXAE,EAAYrrJ,iBAAiB,QAAQ,KACnCJ,KAAKsvJ,uCAGP7D,EAAYrrJ,iBAAiB,SAAS,KACjCJ,KAAKuvJ,4BACNtmG,cAAcjpD,KAAKuvJ,2BACnBvvJ,KAAKuvJ,+BAA4BvlJ,MAI9ByhJ,EAGFE,oBACL,OAAG3rJ,KAAK2tC,YACC3tC,KAAK2tC,YAGM9tC,MAAM8rJ,oBAerBC,2BACL/rJ,MAAM+rJ,2BAUM4D,oBAAoBC,EAAeC,EAAiC9wJ,G,0CAChF,MAAM,UAAC+wJ,EAAS,YAAEhiH,GAAe3tC,KAC3B4vJ,EAAcD,EAAUn/I,GAExBq/I,EAAoBH,EAAa/0I,KAAKxB,IAC1C,MAAM22I,EC5GG,SAA6BtB,EAAUxgI,GACpD,MAAM+hI,EAAcxB,GAAsBC,EAAKxgI,GAEzCszH,EAA+DtzH,EAAMszH,UACrEvkI,EAAc,CAClBi+G,OAAQ+0B,EAAY/0B,OACpBooB,aAAc2M,EAAY3M,aAC1BnjJ,KAAMqhJ,GAIRyO,EAAYlN,YAAYE,MAAQ,SAChC,MAAMiN,EAAoC,CACxClN,aAAc,CAACiN,EAAYlN,aAC3BD,IAAKmN,EAAYnN,IACjBU,KAAMyM,EAAY/0B,OAClB,cAAe+0B,EAAY3M,cAAgB,GAC3CT,MAAOoN,EAAYpN,OASrB,MAAO,CACLxpB,OANuB,CACvBvsH,EAAG,WACH+5B,KAJqBkB,KAAKC,UAAUkoH,IASpCh1B,OAAQ+0B,EAAY/0B,OACpBhtG,MAAAA,EACAo1H,aAAc2M,EAAY3M,aAC1BrmI,MAAAA,GD6EoBkzI,CAAoBR,EAAUt2I,GAIhD,OAFAnZ,KAAKyjJ,QAAQqM,EAAU/yI,MAAM9c,MAA6B6vJ,EAAU/yI,MAE7D+yI,KAGHI,EAAeL,EAAkBz9I,MAAMs5I,GAAwC,UAA5BA,EAAQ19H,MAAMszH,YACjE6O,EAAeN,EAAkBz9I,MAAMs5I,GAAwC,UAA5BA,EAAQ19H,MAAMszH,YACvE,IAAI,OAACtmB,EAAM,OAAE7B,GAAU+2B,GAAgB,GACvC,MAAME,EAAaD,GAAgBD,EAE7B7jE,EAA6D,CACjElvD,MAAO+yH,EACPx/H,MAAOy/H,GAcT,GAXAxiH,EAAY9wB,QAAQzP,SAAS2P,IAC3B,GAAuB,aAApBA,EAAMjb,UAA0B,CACjC,MAAM4pJ,EAAUr/D,EAAStvE,EAAM9c,MAC/B,IAAIyrJ,EAAS,OAEb/9G,EAAY68G,eAAeztI,EAAO2uI,EAAQtI,cAAgBsI,EAAQ1wB,QAClErtF,EAAY88G,eAAe1tI,EAAO,cAKnCo8G,IAAWi3B,EAAWj3B,OAAQ,CAC/B,MAAMxyF,EAAiCkB,KAAKwoH,MAAMD,EAAWj3B,OAAOxyF,MAEjEq0F,EAAQr0F,EAAK28G,KAAOtoB,SACXr0F,EAAK28G,KACjBnqB,EAAS,CACPvsH,EAAG,WACH+5B,KAAMkB,KAAKC,UAAUnB,IAIzB,MAAMtO,QAAer4B,KAAK2S,SAAS29I,qBAAqBC,cAAcX,EAAaz2B,EAAQv6H,GAErF+nC,EAAsCkB,KAAKwoH,MAAMh4H,EAAO8gG,OAAOxyF,MAMrE,OAJAA,EAAKxJ,MAAQwJ,EAAKxJ,OAASwyH,EAAUa,YAAYllH,KAAKqC,YAAYxQ,MAClEwQ,EAAY28G,QAAQ3jH,GE1JT,SAA4B+oH,EAAiC/oH,GAc9D,CAAC,QAAkB,SAAkBhb,QAAQ1rB,GAAS0mC,EAAK1mC,KAAO0a,KAAK1a,GAAS,CAAE0mC,EAAK1mC,GAAOA,KAG1FmN,SAAQ,EAAE02I,EAAO7jJ,MAC/B,MAAMyrJ,EAAUgE,EAAat9I,MAAM8S,GAASA,EAAKo8H,YAAcrhJ,IAC/D,IAAIyrJ,EACF,OAGF,MAAM+E,EArBc,CAAC/E,IACrB,MAAMttI,EAA8B,GAOpC,OANestI,EAAQtwH,WAAW5pB,IAAI,UAC/BpE,SAASqjJ,IACd,MAAMjgJ,EAAKigJ,EAAO5gJ,IAAI6yB,MAAM,IAAK,GAAG,GACpCtkB,EAAI5N,GAAMigJ,EAAOjwJ,SAGZ4d,GAaQsyI,CAAchF,IAC7B,EAAAnjE,GAAA,GAAeu7D,EAAM,gBAAgB,CAACtjJ,EAAO8kB,EAAO1E,KAC/C6vI,EAAOjwJ,EAAMgQ,MAAQhQ,EAAMyb,MAC5B2E,EAAIrC,OAAO+G,EAAO,GAClB5X,QAAQomB,IAAI,yBAA0BtzB,EAAO8kB,EAAOrlB,UFgIxD0wJ,CAAmBjB,EAAc/oH,GAE1BA,KAGOulH,oB,0CACd,MAAM,WAACxE,EAAU,YAAE/5G,GAAe3tC,KAC5B4wJ,EAAoD,QAAlClJ,EAAW4D,qBAAiC39G,EAAYi9G,cAAc,KAAK5vB,OAC7FlnG,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,oBAChC7rF,EAAI,SAEJ,MAAM+8H,QAAsBnJ,EAAWoJ,YAAY,CAACC,YAAY,IAE7DH,GAAmB5wJ,KAAKyrJ,aACA99G,EAAY45G,YAAY,eAChCplJ,aAAa,YAGhC,MAAOqsJ,IAAKiB,EAAQ,MAAEuB,GGzKX,SAAuBpyJ,GAMpC,MAAM,MAACoyJ,EAAK,KAAErqH,GAAQ/nC,EAChB4vJ,EAAMP,GAAS+C,EAAMxC,KAC3B,IAAIyC,GAAY,EAwEhB,GAtEIryJ,EAAQsyJ,sBACVD,EPuBG,SAAsBzC,GAC3B,IAAI2C,EAoCJ,OAnCA3C,EAAIxgI,MAAM5gB,SAAQ,CAAC+L,EAASkF,KAC1B,GAAyB,UAAtBlF,EAAQmoI,WAAyBnoI,EAAQwxI,YAAcxxI,EAAQiiB,WAAW5pB,IAAI,cAAcA,IAAI,OAAO07I,OAAQ,CAC5GiE,IACFA,EAAY,IAAI3E,GAAsB,EAAG,aAG3C,MAAM4E,EAAgBj4I,EAAQiiB,WAAW5pB,IAAI,cAAcA,IAAI,OAAOhR,MAAMkiC,MAAM,KAC5Eo8D,EAAQ3lF,EAAQ2lF,MACtBsyD,EAAchkJ,SAASk2I,GAAS6N,EAAU9xJ,KAAKikJ,KAC/C,MAAM+N,EAAQ,CAACD,EAAc,GAAID,EAAU1E,WAAY0E,EAAU1E,YAC3D6E,EAAS,CAACF,EAAc,GAAID,EAAU1E,WAAY0E,EAAU1E,YAElE3tD,EAAMjtF,KAAKy8I,GAAa,oBAAsB+C,EAAM1tI,KAAK,OAEzD,MAAM4tI,EAAgBp4I,EAAQiiB,WAAW5pB,IAAI,QAAQA,IAAI4/I,EAAc,IAAItyD,MAE3EuyD,EAAMjkJ,SAAQ,CAACk2I,EAAMjlI,KACnB,MAAMmzI,EAAQF,EAAOjzI,GAClBA,EAAM,IACPygF,EAAMjtF,KAAKy8I,GAAa,oBAAsBhL,EAAO,IAAMkO,IAE3DD,EAAcnkJ,SAASy5B,IACrBi4D,EAAMjtF,KAAKy8I,GAAa,UAAYhL,EAAO,IAAMz8G,OAGnD0qH,EAAcnkJ,SAASy5B,IACrBi4D,EAAMjtF,KAAKy8I,GAAa,UAAYkD,EAAQ,IAAM3qH,WAKxD2nH,EAAIxgI,MAAM3P,GAAO,IAAIsvI,GAAgB7uD,SAIhCqyD,EO5DKM,CAAajD,IAAQyC,IAMnC,EAAA1oE,GAAA,GAAeimE,EAAIxgI,OAAO,CAAC7U,EAASkF,EAAKuC,KAYvC,GAA0CzH,EAAQwxI,UAChD,OAGF,GAAyB,gBAAtBxxI,EAAQmoI,UACT,OAGF,MAAMsM,EAAYz0I,EAAQy0I,UACpBb,EAAiBa,EAAUb,eAE3B2E,GADgB3E,EAAe//E,IAClB4gF,EAAUl9G,YAavBihH,EAXQhrH,EAAKxtB,EAAQmoI,WACA,iBAUG3mI,KAAKq1I,GAAY,GAAKA,EAAQx/I,KAG5D,GAAGkhJ,IAFkBlQ,GAAuBroI,EAAQmoI,eAAWt3I,EAAW2nJ,GAE1C,CAC9B,MAAM5B,EAAcxB,GAAsBC,EAAKr1I,GAE/C,IAAIy4I,EAAU,OAAH,UAAOjrH,GAClBirH,EAAQnP,WAAY,EAAAhrG,GAAA,GAAKm6G,EAAQnP,WACjCmP,EAAQnP,UAAUE,MAAQoN,EAAYpN,MACtCiP,EAAQnP,UAAUG,IAAMmN,EAAYnN,IACpCgP,EAAQnP,UAAUK,aAAe,CAACiN,EAAYlN,aAC9C+O,EAAQnP,UAAUO,WAAa,GAE/B,MAAMjmI,EAAQ,IAAI2sI,GAAgBqG,EAAY9iJ,IAAK8/I,EAAe9sJ,MAClE8c,EAAM6sI,QAAQmD,EAAetL,MAC7BsO,EAAY/0B,QAAUj+G,EAAMgtI,UAAUgG,EAAY3M,cAAgB2M,EAAY/0B,QAC9Ej+G,EAAM5a,aAAagX,EAAQrX,WAE3B,MAEM+vJ,EAAa5D,IAFJ,IAAIrM,IAAa+B,aAAa5mI,EAAO60I,GAAS1Q,YAEzBlzH,MAAM,GAC1CpN,EAAIvC,GAAOwzI,EAEXZ,GAAY,MAIbA,EAAW,CACZ,MAAMa,EAAYtD,EAAI99G,WACtBsgH,EAAMxC,IAAMsD,EAGd,MAAO,CAACd,MAAAA,EAAOxC,IAAAA,GHoFkBuD,CAAc,CAC3Cf,MAAOH,EACPlqH,KAAMgH,IAGR7Z,EAAI,4BAA6Bk9H,EAAMxC,WACjC9G,EAAWsK,oBAAoBhB,GAErC,MAAMtB,EAAeD,EAASzhI,MAAMrC,QAAQqC,GACf,gBAApBA,EAAMszH,WAA+BtzH,EAAM28H,YAGpD,GAAGiG,EACD,UACQ5wJ,KAAKwvJ,oBAAoBC,EAAUC,EAAc1vJ,KAAKpB,SAC5D,MAAMyB,GACNL,KAAK8zB,IAAInmB,MAAM,8BAA+BtN,GAqBlD,MAEM4xJ,EAAqC,GACrC1P,EAASkN,EAASlN,QACxB,EAAAh6D,GAAA,GAAeg6D,GAAQ,CAACt1I,EAAKoR,EAAKuC,KAChC,MAAM7D,EAAQ4wB,EAAYi9G,cAAc39I,GACrC8P,EAAMinI,iBANM,KAObpjI,EAAIrC,OAAOF,EAAK,GAChB4zI,EAAgBpgJ,KAAKkL,OAazB,MAAMF,EAAU4yI,EAASzhI,MAAMrT,KAAKxB,IAClC,MAAMlM,EAAMkM,EAAQlM,IACpB,IAAI8P,EAAQ4wB,EAAYi9G,cAAc39I,GAMtC,OALI8P,IACFA,EAAQ,IAAI2sI,GAAgBz8I,EAAKkM,EAAQmoI,WACzCvkI,EAAM5a,aAAa,aAGd4a,KAGHm1I,EAA+C,CACnDjyJ,KAAM,SACNuuJ,IAAK7gH,EAAYo9G,YAAY,CAC3BxI,OAAAA,EACA1lI,QAAAA,EACA+mI,UArCa,KAyCjBqO,EAAgB7kJ,SAAS2P,IACvB4wB,EAAY48G,YAAYxtI,MAG1B+W,EAAI,wCAAwC4zH,EAAW0D,sBAAsB1D,EAAW4D,gCAAgC5D,EAAWyK,gCAAgCzK,EAAW2D,kBAAmB6G,EAAkB1D,WAC7M9G,EAAW0K,qBAAqBF,GAEtCp+H,EAAI,UAGCk4H,YACL,IAAIliJ,EAAU9J,KAAKisJ,YACnB,OAAGniJ,IAIHA,EAAUjK,MAAMmsJ,YAEbhsJ,KAAKqyJ,mBACNvoJ,EAAQpI,MAAK,KACX1B,KAAKsvJ,oCACLtvJ,KAAKqyJ,mBAAoB,KAIJ,iBAAtBryJ,KAAKpB,QAAQqB,MACd6J,EAAQpI,MAAK,KACX1B,KAAK0nJ,WAAW4K,kBAAkBlgJ,MAAMo1I,I,QACC,WAAX,QAAzB,EAAkB,QAAlB,EAAAA,EAAYK,cAAM,eAAEjH,aAAK,eAAE/2I,OAC5B29I,EAAYK,OAAO0K,cAAc,OAAD,wBAC3B/K,EAAYK,OAAO2K,iBAAe,CACrCC,sBAAuB,+BAO1B3oJ,GAGFwlJ,oCACL,GAAmC,SAAhCtvJ,KAAKyrJ,YAAY5sH,WAClB,OAGF7+B,KAAK8zB,IAAI,qCAIT,MAAMyvC,EAKF,CACFmvF,aAAc,2BACdrT,YAAa,GACbsT,mBAAoB,CAACvxI,UAAW,GAChCwxI,iBAAkB,IAGpB,IAAI,MAAM71I,KAAS/c,KAAK2tC,YAAY9wB,QAAS,CAC3C,GAAuB,aAApBE,EAAMjb,WAA2C,UAAfib,EAAM9c,KACzC,SAGF,MAAM,SAAC0oJ,GAAY5rI,EACnBwmD,EAAIqvF,iBAAiB/gJ,KAAK82I,GAC1BplF,EAAI87E,YAAYsJ,GAAY,CAC1Bx6F,UAAW,IACX/sC,UAAW,KAIfphB,KAAKmsJ,oBAAoB5oF,GAErBA,EAAIqvF,iBAAiBjyJ,OAKdX,KAAKuvJ,4BACdvvJ,KAAKuvJ,0BAA4BzpJ,OAAO8hD,YAAY5nD,KAAKsvJ,kCAAkCpmJ,KAAKlJ,MAAO,MALpGA,KAAKuvJ,4BACNtmG,cAAcjpD,KAAKuvJ,2BACnBvvJ,KAAKuvJ,+BAA4BvlJ,GAOhC6oJ,oBAAoBzS,GAKvBpgJ,KAAK2vJ,UAAU7G,qBAAqB1I,EAAQpgJ,KAAKC,MAGnDD,KAAKkoJ,cAAc7B,UAAUjG,EAAQ,SACrCpgJ,KAAK4rJ,6BD/VT,SAAKkD,GACH,yBACA,qBACA,uCACA,+BACA,uBALF,CAAKA,KAAAA,GAAgB,KAQrB,Y,2SKiBe,MAAMgE,WAA0B/K,GAyB7CnoJ,YAAYhB,GAOViB,SAEA,EAAAmR,EAAA,GAAWhR,KAAMpB,GAEboB,KAAK8zB,MACP9zB,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,eAGhB7nE,KAAKwwJ,cACPxwJ,KAAKwwJ,YAAc,IAGjBxwJ,KAAK+yJ,gBACP/yJ,KAAK+yJ,cAAgB,IAAI9hJ,KAG3BjR,KAAKgzJ,cAAgB,GACrBhzJ,KAAKizJ,kBAAoB,IAAIhiJ,IAC7BjR,KAAKkzJ,qBAAuB,IAAIt0I,IAChC5e,KAAKmzJ,yBAA0B,EAAA7rH,GAAA,IAAS,KACtCtnC,KAAKgQ,cAAc,SAAUhQ,KAAKozJ,gBACjC,GAAG,GAENpzJ,KAAKI,iBAAiB,SAAUgrC,IAC3BA,IAAU,WACXprC,KAAKiQ,aAKPo7I,sBACF,OAAOrrJ,KAAKwwJ,YAAYllH,KAAKo8G,WAAW4D,mBAGtClgH,YACF,MAAM,gBAACigH,GAAmBrrJ,KAC1B,GAAuB,WAApBqrJ,EACD,OAAO,UACF,GAAuB,cAApBA,GAAqC,GAAA1+H,WAAiC,cAApB0+H,EAErD,CACL,MAAM,YAACj2G,GAAep1C,KACtB,OAAIo1C,EAAY58B,OAAO66I,gBAEbj+G,EAAY58B,OAAOooB,MACpB,SAEA,WAJA,kBAJT,OAAO,cAaPkQ,mBACF,OAAO9wC,KAAK2S,SAAS29I,qBAAqBgD,sBAAsBtzJ,KAAKwQ,IAGnE+iJ,sBACF,QAASvzJ,KAAKwwJ,YAAYgD,aAGxBJ,mBACF,OAAOpzJ,KAAKgzJ,cAAchzJ,KAAKgzJ,cAAcryJ,OAAS,GAG7C09C,cACT,OAAOr+C,KAAKorC,QAAU,WAGbq+G,gBACT,MAAM,MAACr+G,GAASprC,KAChB,OAAOorC,IAAU,UAGR88G,oBACT,OAAOloJ,KAAKwwJ,YAAYllH,KAAK48G,cAGpBv6G,kBACT,OAAO3tC,KAAKwwJ,YAAYllH,KAAKqC,YAGxB8lH,UAAUz4B,IACf,EAAAjpH,EAAA,GAAiB/R,KAAKgzJ,cAAeh4B,GACrCh7H,KAAKgzJ,cAAcnhJ,KAAKmpH,GACxBh7H,KAAKmzJ,0BAGAO,YAAY14B,GACjBh7H,KAAKkzJ,qBAAqBxjJ,OAAOsrH,IACjC,EAAAjpH,EAAA,GAAiB/R,KAAKgzJ,cAAeh4B,GACrCh7H,KAAKmzJ,0BAGAQ,WACL3zJ,KAAKgzJ,cAAcryJ,OAAS,EAC5BX,KAAKmzJ,0BAGMS,uBAAuBrnJ,G,0CAClC,OAAO,QAAiBA,EAASvM,KAAKo1C,mBAAqBp1C,KAAK8wC,cAAct/B,IAAIjF,MAG7EsnJ,cACL,OAAO7zJ,KAAKooJ,oBAAmB,GAAM1mJ,MAAK,IAAM1B,KAAK8zJ,gBAAgB,SAG1DA,gBAAgBvnJ,EAAgBq0B,G,0CAC3C,MAAMwU,QAAoBp1C,KAAK4zJ,uBAAuBrnJ,GAKtD,OAJG,QAAiBA,GAAU6oC,EAAY58B,OAAO66I,kBAC/CzyH,OAAkB52B,IAAV42B,GAAuBwU,EAAY58B,OAAOooB,MAAQA,GAGrD5gC,KAAK+zJ,gBAAgB3+G,EAAa,CAACxU,MAAAA,OAGrC8nH,WAAWC,GAChB,OAAO9oJ,MAAM6oJ,WAAWC,GAGnBqL,qCAAqC5+G,EAAmCn1C,GAC7E,IAAI+6H,EAGFA,EAFC5lF,EAAY58B,OAAOgvC,KACqC,UAATvnD,EAAmB,OAAS,eAG9Dm1C,EAAYn1C,GACXg0J,cAAc,GAAGxQ,QAAQ,GAG1C,MAAMr5I,EAAUpK,KAAK0oJ,WAAW1tB,GAChC,IAAI5wH,EAAS,OAEb,MAAM8pJ,EAAQ9pJ,EAAQrG,YAEtB,OADAmwJ,EAAM/K,UAAY/+I,EAAQ++I,UACnB,CAACz4H,MAAOwjI,EAAOl5B,OAAAA,GAGjBm5B,yBAAyBv1J,GAK9B,OAAOoB,KAAKwwJ,YAAY5xJ,EAAQqB,MAAQ,IAAI8uJ,GAA4B,OAAD,QACrEY,UAAW3vJ,KACX8zB,IAAK9zB,KAAK8zB,IAAI6rF,WAAW/gH,EAAQqB,MACjC0S,SAAU3S,KAAK2S,UACZ/T,IAIAw1J,gBAAgBC,GACrB,OAAOr0J,KAAK+zJ,gBAAgB/zJ,KAAKo1C,YAAa,CAACk/G,UAAWD,IAG/CE,6B,0CACX,IACE,MAAMt0J,EAAgC,eAEhCmgJ,QAAeN,GAAgBH,MAC/BuI,EAAgB,IAAI3C,GAEpBiP,EAAqBx0J,KAAKm0J,yBAAyB,CACvDjM,cAAAA,EACAjoJ,KAAAA,EACArB,QAAS,CACPqB,KAAAA,KAIeu0J,EAAmBtJ,uBAC3B9qJ,iBAAiB,qBAAqB,KAC/Co0J,EAAmBxI,eAGrB5L,EAAOH,iBAAiB,GAAG7/I,iBAAiB,SAAS,KAChDJ,KAAKwwJ,YAAYgD,cAClBxzJ,KAAKy0J,sBAEN,CAACjtJ,MAAM,IAEVgtJ,EAAmB7I,oBACnB6I,EAAmB3B,oBAAoBzS,GACvC,MAAM3yI,GACNzN,KAAK8zB,IAAInmB,MAAM,6BAA8BF,OAI1CinJ,qB,MACL,OAAqC,QAArC,EAAO10J,KAAK20J,iCAAyB,QAA9B30J,KAAK20J,0BAA8B30J,KAAKu0J,6BAA6BrpI,SAAQ,KAClFlrB,KAAK20J,+BAA4B3qJ,KAI9ByqJ,oBACL,MAAMD,EAAqBx0J,KAAKwwJ,YAAYgD,aAC5C,OAAIgB,UAIGx0J,KAAKwwJ,YAAYgD,aACxBxzJ,KAAK0zJ,YAAY,gBACjBc,EAAmB1I,0BAAyB,UAErC9rJ,KAAKo1C,YAAYo+G,aACxBxzJ,KAAK2S,SAAS29I,qBAAqBsE,mBAAmB50J,KAAKwQ,GAAIxQ,KAAKo1C,aAE7Dp1C,KAAK2S,SAAS29I,qBAAqBuE,2BAA2B70J,KAAKwQ,KAVjErN,QAAQ4B,UAaZ+vJ,sBACL,OAAG90J,KAAKuzJ,gBACCvzJ,KAAKy0J,oBAELz0J,KAAK00J,qBAIHK,4B,0CACX,MAAM1V,EAAsC,CAC1C3uH,MvBzRG,CACLnvB,MAAO,CAACqB,IAAK,KAAMJ,IAAK,MACxBhB,OAAQ,CAACoB,IAAK,IAAKJ,IAAK,MACxBq9I,UAAW,CAACj9I,IAAK,GAAIJ,IAAK,MuByR1B,IACE,MAAM49I,QAAeD,GAAUd,GAAa,GACjBr/I,KAAKwwJ,YAAYllH,KACzBunH,oBAAoBzS,SAEjCpgJ,KAAK+zJ,gBAAgB/zJ,KAAKo1C,YAAa,CAC3C4/G,aAAa,EACbC,cAAc,IAEhB,MAAMxnJ,GACNzN,KAAK8zB,IAAInmB,MAAM,0BAA2BF,EAAK4xI,OAI5C6V,oB,MACL,OAAoC,QAApC,EAAOl1J,KAAKm1J,gCAAwB,QAA7Bn1J,KAAKm1J,yBAA6Bn1J,KAAK+0J,4BAA4B7pI,SAAQ,KAChFlrB,KAAKm1J,8BAA2BnrJ,KAIvBorJ,mB,0CACX,MAAMZ,EAAqBx0J,KAAKwwJ,YAAYllH,KACtCs1G,EAAQ4T,EAAmBtM,cAAc/B,YAAYlG,iBAAiB,GACxEW,IAIJD,GAAUC,GACV4T,EAAmBtM,cAAchB,mBAAmBsN,EAAmB7mH,mBAEjE3tC,KAAK+zJ,gBAAgB/zJ,KAAKo1C,YAAa,CAC3C6/G,cAAc,QAIXI,qBACL,OAAGr1J,KAAKmoJ,eACCnoJ,KAAKo1J,mBAELp1J,KAAKk1J,oBAIHI,OAAOC,GAAU,EAAOC,GAAS,EAAOC,GAAc,G,0CACjE,IAAI,MAAMx1J,KAAQD,KAAKwwJ,YACFxwJ,KAAKwwJ,YAAYvwJ,GACzB6rJ,0BAA0B0J,GAKvC,GAFAx1J,KAAKgQ,cAAc,QAAShQ,KAAKorC,QAE9BqqH,IAICD,EAAQ,CACV,IAAIpiJ,EAAImiJ,IAAYv1J,KAAKu3D,OAASv3D,KAAKwwJ,YAAYllH,KAAKm4G,QAAQtmH,MAAM69F,YAAShxH,GAC/EhK,KAAK2S,SAAS29I,qBAAqBgF,OAAOt1J,KAAKwQ,GAAI4C,OAIhDy1I,YAAYjqJ,GACjB,MAAM,YAAC+uC,GAAe3tC,KAChBg7H,EAASn7H,MAAMgpJ,YAAYjqJ,GAEjC,GAAoB,WAAjBA,EAAQqB,KAAmB,CAC5B,MAAM8c,EAAQ4wB,EAAYk9G,kBAAkB7vB,GAC5Ch7H,KAAK4zJ,uBAAuB72I,EAAMxQ,QAAQ7K,MAAM0zC,IAC3CA,GACD,kBAAwB,yBAA0B,CAACw6G,YAAa5vJ,KAAKwQ,GAAI4kC,YAAAA,OAK/E,OAAO4lF,EAGI+4B,gBAAgB3+G,EAAmCx2C,G,0CAQ9D,GAAIutF,OAAOzuE,KAAK9e,GAAS+B,OAAzB,CAKA,GAAGy0C,EAAa,CAGd,MACMsgH,EAA6CtgH,EAAY58B,OAAOgvC,KAEtE,GAAGkuG,QACoB1rJ,IAAlBpL,EAAQgiC,QAAwB5gC,KAAKioJ,wBAC/BrpJ,EAAQgiC,OAEXurD,OAAOzuE,KAAK9e,GAAS+B,QACvB,OAMJ,MAAMigC,EAAQhiC,EAAQgiC,WACT52B,IAAV42B,GASYwU,EAAY58B,OAAOgvC,OAC3B5mB,EACDwU,EAAY58B,OAAOooB,OAAQ,EACnBwU,EAAY58B,OAAO66I,wBACpBj+G,EAAY58B,OAAOooB,YA6BT52B,IAAtBpL,EAAQ01J,YACN11J,EAAQ01J,UAAWl/G,EAAYugH,kBAAoB,WAC1CvgH,EAAYugH,mBAGvBD,SAC2B1rJ,IAAzBpL,EAAQq2J,eACNr2J,EAAQq2J,oBAAqB7/G,EAAY1kB,MACvC0kB,EAAY1kB,OCrZOsqG,EDqZmBh7H,KAAKwwJ,YAAYllH,KAAKm4G,QAAQ/yH,QCpZhE,CACf9jB,EAAG,4BACH4L,OAAQ,GACRmwI,SAAU,GACVsL,cAAej5B,EAAOooB,aACtBwS,aAN4CC,aDwZpCzgH,EAAY58B,OAAOooB,OAASwU,EAAY58B,OAAO66I,iBACjDrzJ,KAAKupJ,UAAS,GAGhBvpJ,KAAKgQ,cAAc,QAAShQ,KAAKorC,QC5ZlC,IAA2B4vF,EDsa9B,OAAOh7H,KAAK2S,SAAS29I,qBAAqByD,gBAAgB/zJ,KAAKwQ,GAAI4kC,EAAax2C,OAG3Ek3J,oBAAoB1gH,EAAmC2gH,GAC5D,MAAMvB,EAAqBx0J,KAAKwwJ,YAAYllH,MACtC,WAACo8G,EAAU,YAAE/5G,GAAe6mH,EAE5BjoJ,GAAS,EAAAusC,GAAA,GAAU1D,EAAYb,MAC/ByhH,IAAY5gH,EAAY58B,OAAO7R,KAC/BsvJ,EAAWj2J,KAAKizJ,kBAAkBzhJ,IAAIjF,IAAW,GAEvD,GAAG6oC,EAAYo+G,eAAiBwC,EAAS,CACvC,MAAM,OAACh7B,GAAUk7B,GAAwB9gH,EAAa,QAASA,EAAYo+G,aAAaS,cAAe7+G,EAAYo+G,aAAa7K,UAC5H3oJ,KAAKkzJ,qBAAqB/gH,IAAI6oF,KAChCh7H,KAAKkzJ,qBAAqB7zJ,IAAI27H,GAC9Bh7H,KAAKyzJ,UAAUr+G,EAAY58B,OAAOgvC,KAAO,eAAiBwzE,IAI9D,GAAG5lF,EAAY58B,OAAOgvC,KAAM,CAC1BxnD,KAAKo1C,YAAcA,EAEhBo/G,EAAmB/Q,QAAQtmH,MAAM69F,SAAW5lF,EAAY4lF,QACzDh7H,KAAKs1J,SAGP,IAAIxnE,GAAO,EAiBX,OAhBI14C,EAAY58B,OAAO66I,gBAIbj+G,EAAY58B,OAAOooB,QAC3BktD,GAAO,IAJP9tF,KAAKy0J,oBACLz0J,KAAKo1J,mBACLtnE,GAAO,GAKNA,GACD9tF,KAAKupJ,UAAS,QAGbwM,IAAmCxpJ,GACpCvM,KAAKgQ,cAAc,QAAShQ,KAAKorC,QAMrC,MAAMimH,EAAQ2E,EAAU,GClerB,SAAkC5gH,G,QACvC,MAAO,CACL8gH,GAAwB9gH,EAAa,QAASA,EAAY4lF,SACzC,QAAjB,EAAA5lF,EAAY1kB,aAAK,eAAEklI,eAAgBM,GAAwB9gH,EAAa,QAASA,EAAY1kB,MAAMklI,cACnGxgH,EAAY1kB,OAASwlI,GAAwB9gH,EAAa,QAASA,EAAY1kB,MAAMujI,cAAe7+G,EAAY1kB,MAAMi4H,WAC9F,QAAxB,EAAAvzG,EAAYo+G,oBAAY,eAAEoC,eAAgBM,GAAwB9gH,EAAa,QAASA,EAAYo+G,aAAaoC,cACjHxgH,EAAYo+G,cAAgB0C,GAAwB9gH,EAAa,QAASA,EAAYo+G,aAAaS,cAAe7+G,EAAYo+G,aAAa7K,WAC3Ih9H,OAAO6kB,SD2dsB2lH,CAAyB/gH,GAElD4gH,EAGFh2J,KAAKizJ,kBAAkBvjJ,OAAOnD,GAF9BvM,KAAKizJ,kBAAkBh2I,IAAI1Q,EAAQ8kJ,GAOrC,MAAM+E,EAAqC,IAAIx3I,IAC/Cq3I,EAAS7oJ,SAASipJ,IAChB,MAAMC,EAAYD,EAAQr7B,OAE1B,IADgBq2B,EAAMj/I,MAAMkxI,GAASA,EAAKtoB,SAAWs7B,IACxC,CACXt2J,KAAK0zJ,YAAY4C,GAEjB,MAAMC,EAAW5oH,EAAYk9G,iBAAiByL,GAC3CC,GAAmC,aAAvBA,EAASz0J,YACtBy0J,EAASp0J,aAAa,YACtBi0J,EAAc/2J,IAAIk3J,EAASt2J,WAKjCoxJ,EAAMjkJ,SAASk2I,IACb,IAAIvmI,EAAQ4wB,EAAYk9G,iBAAiBvH,EAAKtoB,QAC3Cj+G,EACsB,aAApBA,EAAMjb,YACPib,EAAM5a,aAAa4a,EAAM4sI,mBACzByM,EAAc/2J,IAAI0d,EAAM9c,QAM5B8c,EAAQ4wB,EAAY45G,YAAYjE,EAAKrjJ,MACrC0tC,EAAY68G,eAAeztI,EAAOumI,EAAKF,cAAgBE,EAAKtoB,QAC5DrtF,EAAY88G,eAAe1tI,EAAOxQ,GAMlB,UAAd+2I,EAAKrjJ,MAAoB8c,EAAM8sI,YAAYvG,EAAKqF,UAChD5rI,EAAM0qI,kBAAkBC,EAAY,CAAC5lJ,UAAW,aAGlDs0J,EAAc/2J,IAAI0d,EAAM9c,UASbm2J,EAAcp1J,OACtBo1J,EAAcjkH,IAAI,WACnBqiH,EAAmBnC,mBAAoB,GAGzCmC,EAAmBxF,uB,2SCthBlB,SAASkH,GAAwB9gH,EAAmCn1C,EAAsB+6H,EAA0D2tB,GACzJ,OAAOqB,GAAa/pJ,EAAM+6H,EAAQ2tB,GAa7B,MAAM6N,WAA6B,IAQjC/tI,UAAU9V,GACf3S,KAAK2S,SAAWA,EAChB3S,KAAKm/I,WtC9CAA,MAAAA,GAAAA,GAAAA,GAAe,IAAIV,GAAiB,CACzC,yBACA,qBACA,uBACA,yBsC2CAz+I,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,OAElB,qBAA2B,qBAAsB8nF,IAC/C,MAAM,iBAAC8G,GAAoBz2J,MACxBy2J,MAAAA,OAAgB,EAAhBA,EAAkBjmJ,MAAOm/I,EAAUn/I,KACpCimJ,EAAiB9G,UAAYA,EAEV,uBAAhBA,EAAU/iJ,GACX6pJ,EAAiBnB,QAAO,GAAO,GAAO,OAK5C,qBAA2B,0BAA0B,EAAE1F,YAAAA,EAAax6G,YAAAA,MAClE,MAAM,iBAACqhH,GAAoBz2J,MACxBy2J,MAAAA,OAAgB,EAAhBA,EAAkBjmJ,MAAOo/I,GAC1B6G,EAAiBX,oBAAoB1gH,MAKvCu6G,gBACF,OAAO3vJ,KAAKy2J,iBAGPC,oBAAoB/G,GACzB3vJ,KAAKy2J,iBAAmB9G,EAErBA,GACD3vJ,KAAKgQ,cAAc,WAAY2/I,GAI5BgH,uBACL32J,KAAK42J,sBACL52J,KAAKm/I,WAAWD,qBAAqB,0BAA0B,EAAM,MAGhE0X,sBACL52J,KAAKm/I,WAAWH,YAChBh/I,KAAKm/I,WAAWF,oBAGLsR,cAAcl2I,EAAgBu1I,EAA0BhvH,GAhFxD,EAgF0E40H,EAAkBqB,G,0CAKvG,IAAI3O,EAOJ,OAXAloJ,KAAKm/I,WAAWN,cAEhB7+I,KAAK8zB,IAAI,wBAAwBzZ,QAAau1I,WAAqBhvH,YAAgB40H,KAIjFtN,EADCsN,EACex1J,KAAKy2J,iBAAiBjG,YAAYllH,KAAK48G,oBCjG9C,SAAuCtnH,EAAiBi2H,G,qCACrE,MAAMxX,EAAsC,CAC1CliH,MAAOiiH,KACP1uH,MAAOmmI,GzBdF,CACLt1J,MAAO,CAACqB,IAAK,KAAMJ,IAAK,MACxBhB,OAAQ,CAACoB,IAAK,IAAKJ,IAAK,MACxBq9I,UAAW,CAACj9I,IAAK,GAAIJ,IAAK,MyBctB0lJ,EAAgB,IAAI3C,G3BjB4B,K2BmBtD,IACE,MAAMnF,QAAeD,GAAUd,EAAaz+G,GAC5CsnH,EAAc7B,UAAUjG,EAAQ,SAChC,MAAM3yI,GACNC,QAAQC,MAAM,gCAAiCF,EAAK4xI,GACpD6I,EAAc/B,YAAc,IAAID,YAGlC,OAAOgC,G,+RDmFmB4O,CAAwBl2H,EAAOi2H,GAGhD72J,KAAK+2J,sBAAsB18I,EAAQu1I,EAAa1H,EAAetnH,EAAO40H,EAAQqB,MAG1EE,sBAAsB18I,EAAgBu1I,EAA0B1H,EAA8BtnH,EAAgB40H,GAAS,EAAOqB,G,0CACzI,MAAM/iI,EAAM9zB,KAAK8zB,IAAI6rF,WAAW,yBAChC7rF,EAAI,QAAS87H,GAEb,MAAM3vJ,EAAgC,OAEtC,IAAI,iBAACw2J,GAAoBz2J,KACzB,IAAGy2J,IAAoBjB,EAKhB,CACLiB,EAAmB,IAAI3D,GAAkB,CACvCz4I,OAAAA,EACA7J,GAAIo/I,EACJj9I,SAAU3S,KAAK2S,WAGjB8jJ,EAAiBzO,iBAEjByO,EAAiBr2J,iBAAiB,SAAUgrC,IACvCprC,KAAKy2J,mBAAqBA,GAAoBrrH,IAAU,YACzDprC,KAAK02J,oBAAoB,MACzB12J,KAAK42J,sBACL52J,KAAKm/I,WAAWR,UAAU,sBAC1B,kBAAwB,cAAe8X,EAAiBp8I,YAI5Do8I,EAAiB9G,gBAAkB3vJ,KAAK2S,SAAS29I,qBAAqB0G,iBAAiBpH,GAEvF,MAAM4E,EAAqBiC,EAAiBtC,yBAAyB,CACnEjM,cAAAA,EACAjoJ,KAAAA,EACArB,QAAS,CACPqB,KAAAA,EACAo+C,QAASzd,EACTi2H,UAAAA,EACArB,OAAAA,KAIE9N,EAAa8M,EAAmBtJ,uBAuEtC,OAtEAxD,EAAWtnJ,iBAAiB,qBAAqB,KAC/Co0J,EAAmBxI,eAGrBtE,EAAWtnJ,iBAAiB,SAAUk0B,IACpCR,EAAI,UAAWQ,GACfmiI,EAAiB7N,QAAQt0H,MAG3BozH,EAAWtnJ,iBAAiB,4BAA4B,KACtDq2J,EAAiBzmJ,cAAc,QAASymJ,EAAiBrrH,OAEzD,MAAM,mBAACkgH,GAAsB5D,EAO7B,OAN0B,iBAAvB4D,GAAgE,aAAvBA,GAA4D,QAAvBA,EAC/EtrJ,KAAK22J,uBAEL32J,KAAK42J,sBAGAtL,GACL,IAAK,WASL,IAAK,YAcL,IAAK,eAWL,IAAK,MACH,MA/BF,IAAK,SAuBL,IAAK,SAEHmL,EAAiBnB,SAEjB,MAlBF,IAAK,YACCmB,EAAiBl/F,SACnBk/F,EAAiBl/F,QAAS,EAC1Bv3D,KAAKm/I,WAAWR,UAAU,wBAC1B3+I,KAAK2S,SAAS29I,qBAAqB2G,yBAAyBrH,QAuBpE4E,EAAmB7I,oBACnB6I,EAAmBjJ,oBAEnBiJ,EAAmB5I,2BAEnB5rJ,KAAK02J,oBAAoBD,GACzB3iI,EAAI,uBAAwB87H,EAAa6G,GAEzCz2J,KAAK22J,uBAEEnC,EAAmBxI,YAzG1ByK,EAAiBS,mCAAoC,EACrDT,EAAiBU,aAAc,EAC/BrjI,EAAI,0BAA2B87H,EAAa6G,OA4GlD,MAAMW,GAAuB,IAAIZ,GACjC,OAAmB,yBAAqCY,IACxD,Y,2SE1Le,MAAMC,GA4BnBz3J,YACUwiC,EACA+pB,EACAx5C,GAFA,KAAAyvB,KAAAA,EACA,KAAA+pB,gBAAAA,EACA,KAAAx5C,SAAAA,EAmKF,KAAA2kJ,cAAiBj3J,IACvB,MAAMk3J,IAAel3J,MAAQL,KAAKw3J,UAAWx3J,KAAKw3J,QAAQp4J,UAAUiG,SAAS,cAE7EhF,IAAK,EAAA4nB,EAAA,GAAY5nB,GAEP,MAAW,mCACnB,MAAMo3J,QAAyBz3J,KAAK2S,SAAS2/B,gBAAgBolH,oBAAoB13J,KAAKuM,QACnFgrJ,GAEDv3J,KAAK23J,YAAY33J,KAAK23J,YAAYh3J,OAAS,GAAGyJ,QAAQo0B,UAAUC,aAAY,QAAKg5H,IAGnF,MAAMtqH,EAAUntC,KAAK43J,gBAAgBt3I,OAAOi3I,EAAav3J,KAAK23J,YAAc,WACtDx0J,QAAQC,IAAI+pC,EAAQxyB,KAAU9b,GAAW,mCAC7D,MAAO,CACLyQ,aAAczQ,EAAOsf,SACrBtf,OAAAA,UAIIuO,SAAQ,EAAEvO,OAAAA,EAAQyQ,OAAAA,MACxBzQ,EAAOuL,QAAQhL,UAAUoE,OAAO,QAAS8L,UAI7ClK,IAGM,KAAAyyJ,sBAA8B53J,GAAiC,mC,MACrE,IAAI,MAA2BD,KAAKuM,OAAO46B,SAAU,OAAO,EAE5D,MAAMsvH,EAAmB,GAAA9G,UACnBt1I,EAASra,KAAKuM,OAAO8hB,WAC3B,IAAGooI,MAAAA,OAAgB,EAAhBA,EAAkBp8I,UAAWA,EAC9B,OAAO,EAGT,GAAGpa,WACUD,KAAK2S,SAAS2/B,gBAAgBlE,YAAYpuC,KAAKuM,UAAqB,UAATtM,UAC5DD,KAAK2S,SAAS2/B,gBAAgBg6C,WAAWtsF,KAAKuM,UAAqB,cAATtM,GAClE,OAAO,EAIX,MAAMmiC,QAAapiC,KAAK2S,SAASoH,gBAAgB4iC,aAAatiC,GAC9D,OAAmC,QAA5B,EAAC+nB,EAAqB5pB,cAAM,eAAEs/I,eAAe,EAAArjH,GAAA,GAAUrS,EAAM,kBAG9D,KAAA21H,iBAAyB93J,GAAoB,mCACnD,IAAI,OAAsBD,KAAKuM,OAAO46B,SAAU,OAAO,EACvD,MAAMjsB,EAASlb,KAAKuM,OAAOqO,WACrBktE,QAAiB9nF,KAAK2S,SAASq8B,kBAAkBgpH,kBAAkB98I,GAEzE,QAAS4sE,MAAwB,UAAT7nF,EAAmB6nF,EAAStvE,OAAOy/I,sBAAwBnwE,EAAStvE,OAAO0/I,0BAsN7F,KAAAC,qBAAuB,KAC7Bn4J,KAAKoiC,KAAKgyE,aAAam8C,cAAcvwJ,KAAKuM,SA0IpC,KAAA2qI,YAAc,KACpB,IAAImH,GAAUr+I,KAAKuM,SAGb,KAAA6rJ,SAAW,KACjBp4J,KAAKg3I,eAAc,GACnBh3I,KAAK+2I,eAGC,KAAAlY,eAAiB,CAACxtH,EAAkBixB,KAC1CtiC,KAAKkB,UAAU9B,UAAUoE,OAAO,qBAAsB6rB,EAAA,YAEtDrvB,KAAK62D,eAAiB72D,KAAK62D,cAAc63E,uBAAuBgI,cAAcx1I,UAAU9B,UAAUoE,OAAO,cAAe8+B,IAAO,YAC/HtiC,KAAKo4J,YA2KA,KAAAphB,cAAgB,CAACqhB,GAAS,KAE5Br4J,KAAKs4J,aAAaxyJ,OAAOgxB,qBAAqB92B,KAAKs4J,aAEnD,GAAA3rI,WAAa0rI,GACdr4J,KAAKu4J,UAAUn5J,UAAUC,IAAI,QAI/BW,KAAKs4J,YAAcxyJ,OAAOS,uBAAsB,KAKvC,GAAAomB,WAAa0rI,GACdr4J,KAAKu4J,UAAUn5J,UAAUkB,OAAO,QAIlC,MAAMiB,EAAmCvB,KAAKu4J,UAAU9xJ,wBAAwBlF,MAChFvB,KAAKoiC,KAAKtO,IAAI,eAAgBvyB,GAC9BvB,KAAKkB,UAAU+B,MAAMmgD,YAAY,gBAAiB7hD,EAAQ,MAI5DvB,KAAKs4J,YAAc,MAOlB,KAAAvhB,YAAc,KACnB,MACMhqI,EADa,CAAC/M,KAAKw4J,UAAWx4J,KAAK62D,eAAiB72D,KAAK62D,cAAc63E,wBAAwB/iH,OAAO6kB,SACnF1vB,QAAO,CAACC,EAAK7f,KACpC,MAAM41I,EAAa51I,EAAU41I,aAG7B,OAFA92I,KAAKkB,UAAU9B,UAAUoE,OAAO,aAAatC,EAAUvC,qBAAsBm4I,GAEzE51I,EAAUoc,YAIPyD,IAAO+1H,EAHL/1H,IAIR,GACH/gB,KAAKkB,UAAU0G,QAAQ6uI,SAAW,GAAK1pI,GAGlC,KAAA0rJ,oBAAsB,CAAMvxG,GAAY,IAAU,mCACvD,IAAIlnD,KAAKypC,SAAU,OAEnB,MAAMl9B,EAASvM,KAAKuM,OACpB,OAAOvM,KAAKoiC,KAAKgyE,aAAantD,cAC5B16C,EACAvM,KAAKypC,SACLyd,GACA,GACA,IAAM36C,IAAWvM,KAAKuM,YAInB,KAAA06C,cAAiBC,GACflnD,KAAKy4J,oBAAoBvxG,GAAWxlD,MAAMoD,IAC5CA,GACDA,OA9yBJ9E,KAAKiJ,eAAiB,IAAI,IAE1BjJ,KAAK23J,YAAc,GACnB33J,KAAK43J,gBAAkB,GAGlBnvI,YAGLzoB,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,iBAAkB,SAAU,QACzDW,KAAKkB,UAAU0G,QAAQ6uI,SAAW,IAElCz2I,KAAK04J,QAAU,EAAW,4BAA6B,CAACx5J,UAAU,IAGlEc,KAAK24J,kBAAoB75J,SAASC,cAAc,OAChDiB,KAAK24J,kBAAkBv5J,UAAUC,IAAI,uBAErCW,KAAK44J,SAAW95J,SAASC,cAAc,OACvCiB,KAAK44J,SAASx5J,UAAUC,IAAI,aAE5B,MAAMw5J,EAAS/5J,SAASC,cAAc,OACtC85J,EAAOz5J,UAAUC,IAAI,UAErB,MAAM0P,EAAUjQ,SAASC,cAAc,OACvCgQ,EAAQ3P,UAAUC,IAAI,WAEtB,MAAMwH,EAAM/H,SAASC,cAAc,OACnC8H,EAAIzH,UAAUC,IAAI,OAElBW,KAAK8O,MAAQhQ,SAASC,cAAc,OACpCiB,KAAK8O,MAAM1P,UAAUC,IAAI,cAEzBwH,EAAInH,OAAOM,KAAK8O,OAEhB,MAAMwnB,EAASx3B,SAASC,cAAc,OACtCu3B,EAAOl3B,UAAUC,IAAI,UAElBW,KAAKypC,UACNnT,EAAO52B,OAAOM,KAAKypC,UAGrB16B,EAAQrP,OAAOmH,EAAKyvB,GACjBt2B,KAAK84J,eACND,EAAOn5J,OAAOM,KAAK84J,eAGrBD,EAAOn5J,OAAOqP,GACd/O,KAAK44J,SAASl5J,OAAOm5J,GAGrB74J,KAAKu4J,UAAYz5J,SAASC,cAAc,OACxCiB,KAAKu4J,UAAUn5J,UAAUC,IAAI,cAE7BW,KAAKw4J,UAAY,IAAIjhB,GAAUv3I,KAAMA,KAAKoiC,KAAMpiC,KAAK2S,UAElD3S,KAAK23J,YAAYh3J,SAClBX,KAAKw3J,QAAU,GAAiB,CAACvuJ,eAAgBjJ,KAAKiJ,gBAAiB,cAAejJ,KAAK23J,YAAa33J,KAAKs3J,gBAG/Gt3J,KAAKu4J,UAAU74J,UAAU,CAEvBM,KAAK62D,cAAgB72D,KAAK62D,cAAc63E,uBAAuBgI,cAAcx1I,UAAY,KACzFlB,KAAK+4J,QACL/4J,KAAKg5J,UACLh5J,KAAKi5J,QACLj5J,KAAKk5J,aACLl5J,KAAKm5J,QACLn5J,KAAKo5J,UACLp5J,KAAKw3J,SACL7rI,OAAO6kB,UAETxwC,KAAKq5J,mBAAmBr5J,KAAKi5J,QAASj5J,KAAK+3J,iBAAiB7uJ,KAAKlJ,KAAM,UACvEA,KAAKq5J,mBAAmBr5J,KAAKk5J,aAAcl5J,KAAK63J,uBAEhD73J,KAAK24J,kBAAkBj5J,OAAOM,KAAK04J,QAAS14J,KAAK44J,SAAU54J,KAAKu4J,WAChEv4J,KAAKkB,UAAUxB,OAAOM,KAAK24J,mBAExB34J,KAAKw4J,WAENx4J,KAAKkB,UAAUxB,OAAOM,KAAKw4J,UAAU9hB,cAAcx1I,WAOrDlB,KAAKiJ,eAAe5J,IAAIyG,OAAxB9F,CAAgC,SAAUA,KAAKo4J,UAC/Cp4J,KAAKiJ,eAAe5J,IAAIgwB,EAAA,EAAxBrvB,CAAoC,eAAgBA,KAAK6+H,iBAEzD,QAAiB7+H,KAAKkB,WAAYb,IAChC,MAAMa,GAAY,EAAAy4B,GAAA,GAAgBt5B,EAAE8G,OAAQ,oBAE5C,IADA,EAAAk7D,GAAA,KACGnhE,EAAW,CAGZ,IAFA,EAAA+mB,EAAA,GAAY5nB,IAET,EAAAs5B,GAAA,GAAgBt5B,EAAE8G,OAAQ,iBAC3B,OAGF,MAAM8F,GAAO/L,EAAU0G,QAAQqF,IAC/B,GAAG/L,EAAU9B,UAAUiG,SAAS,kBAE5BrF,KAAK62D,cAAconF,oBAAoBhxI,OAEpC,CACL,MAAMV,EAASrL,EAAU0G,QAAQ2E,OAAOsO,WAClCukB,EAAgB5H,GAAA,qBACtBx3B,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAAA,EACA+2D,UAAWr2D,EACXhN,KAAMm/B,EAAc4iC,YAAc,YAAe5iC,EAAcvzB,SAAW,kBAAe7B,EACzF6B,SAAUuzB,EAAcvzB,iBAIzBwjB,EAAA,iBAA4B,YAAqBvwB,SAAS8rC,KAAKxrC,UAAUiG,SAAS2vF,IACnFskE,KACQ,EAAA7gH,GAAA,GAAUp4C,EAAE8G,OAAQ,kBAC5BnH,KAAKmsD,gBAAgBG,eAAextD,SAAS8rC,KAAKxrC,UAAUiG,SAAS6mD,KAErElsD,KAAKmsD,gBAAgBG,eAAc,KAGtC,CAACrjD,eAAgBjJ,KAAKiJ,iBAEzB,MAAMqwJ,EAAkBj5J,IAOtB,GANGA,IACD,EAAA4nB,EAAA,GAAY5nB,GAKXgvB,EAAA,iBAA4B,YAAqBvwB,SAAS8rC,KAAKxrC,UAAUiG,SAAS2vF,IACnFh1F,KAAKoiC,KAAKgyE,aAAatuD,QAAQ,CAACv5C,OAAQvM,KAAKuM,aACxC,CACL,MAAMgtJ,EAAkE,IAApDv5J,KAAKoiC,KAAKgyE,aAAazlC,MAAMn4D,QAAQxW,KAAKoiC,MAC9D9xB,EAAA,OAA6BipJ,EAAc,KAAO,WAYtD,QAAiBv5J,KAAK04J,QAASY,EAAgB,CAACrwJ,eAAgBjJ,KAAKiJ,iBAG/DowJ,mBAAmBjvJ,EAAsB+T,GAC3C/T,GAIJpK,KAAK43J,gBAAgB/lJ,KAAK,CAACzH,QAAAA,EAAS+T,OAAAA,IA2D/Bq7I,iBACLx5J,KAAK23J,YAAc,CAAC,CAClB14J,KAAM,SACNQ,KAAM,SACNuoB,QAAS,KACPhoB,KAAKoiC,KAAK+zD,cAEZh4E,OAAQ,IAAMkR,EAAA,YAMX,CACHpwB,KAAM,OACNQ,KAAM,wBACNuoB,QAAShoB,KAAKk3I,YACd/4H,OAAQ,IAAW,GAAAne,UAAA,4BAAmB,SAAnBA,KAAKoiC,KAAKniC,MAAmB,WAAmBD,KAAKuM,gBAAkBvM,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKuM,QAAQ,QAC7J,CACDtN,KAAM,SACNQ,KAAM,0BACNuoB,QAAS,KACPhoB,KAAK2S,SAAS40B,mBAAmB2W,eAAel+C,KAAKuM,SAEvD4R,OAAQ,IAAW,GAAAne,UAAA,4BAAmB,SAAnBA,KAAKoiC,KAAKniC,MAAmB,WAAmBD,KAAKuM,eAAiBvM,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKuM,QAAQ,QAC5J,CACDtN,KAAM,WACNQ,KAAM,iBACNuoB,QAAS,KACP,MAAM0G,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBACrC5wG,QAAQ4B,QAAQ/E,KAAK2S,SAASq8B,kBAAkBg2F,eAAehlI,KAAKuM,OAAO8hB,aAAa3sB,MAAMujI,IACzFv2G,KAAgBu2G,EAAYw0B,gBAC7Bz5J,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQ04H,EAAYw0B,eAAe5+I,UAAS,SAKpDsD,OAAQ,IAAW,mCACjB,MAAMwwB,QAAiB3uC,KAAK2S,SAASq8B,kBAAkB4B,kBAAkB5wC,KAAKuM,OAAO8hB,YACrF,MAA0B,SAAnBruB,KAAKoiC,KAAKniC,SAAsB0uC,MAAAA,OAAQ,EAARA,EAAmC8qH,oBAE3E,CACDx6J,KAAM,QACNQ,KAAM,OACNuoB,QAAShoB,KAAK05J,YAAYxwJ,KAAKlJ,KAAM,SACrCme,OAAQne,KAAK+3J,iBAAiB7uJ,KAAKlJ,KAAM,UACxC,CACDf,KAAM,cACNQ,KAAM,YACNuoB,QAAShoB,KAAK05J,YAAYxwJ,KAAKlJ,KAAM,SACrCme,OAAQne,KAAK+3J,iBAAiB7uJ,KAAKlJ,KAAM,UACxC,CACDf,KAAM,YACNQ,KAAM,6BACNuoB,QAAShoB,KAAKm4J,qBACdh6I,OAAQne,KAAK63J,sBAAsB3uJ,KAAKlJ,KAAM,cAC7C,CACDf,KAAM,YACNQ,KAAM,4BACNuoB,QAAShoB,KAAKm4J,qBACdh6I,OAAQne,KAAK63J,sBAAsB3uJ,KAAKlJ,KAAM,UAC7C,CACDf,KAAM,SACNQ,KAAM,2BACNuoB,QAAS,KACP,MAAMsjC,EAAYtrD,KAAKoiC,KAAKkpB,UAC5BA,EAAU2V,iBAAgB,GAAM,GAChC,gBAA2Bv/D,MAAM0pC,IAC/B,GAAGA,EAAMuuH,4BACP,OAGF,MAAM1rH,EAAWqd,EAAUE,gBAAgBtiD,KAAKoiD,GAChDA,EAAUE,gBAAwBnkB,GAAW,mCAC3CrnC,KAAK2S,SAASutE,gBAAgBC,YAAY,+BAA+B,GACzEx0C,IAAM,QAAK,mBAEX2f,EAAUE,gBAAkBvd,EAC5Bqd,EAAUE,gBAAgBnkB,UAIhClpB,OAAQ,KAAOne,KAAKoiC,KAAKkpB,UAAUC,eAAiBvrD,KAAKoiC,KAAKqJ,QAAQyvE,qBACrE,CACDj8G,KAAM,SACNQ,KAAM,2BACNuoB,QAAS,KACPhoB,KAAKoiC,KAAKkpB,UAAUsT,mBAEtBzgD,OAAQ,IAAMne,KAAKoiC,KAAKkpB,UAAUC,aACjC,CACDtsD,KAAM,UACNQ,KAAM,aACNuoB,QAAS,KACP,IAAIhoB,KAAKmsD,gBAAgB75C,YAAYmrC,IAAoB,CACvD,MAAM3sC,EAAM9Q,KAAKmsD,gBAAgB35C,UAAUirC,IAC3C3sC,EAAIvE,OAASvM,KAAKuM,OAClBuE,EAAI3B,OAEJnP,KAAKmsD,gBAAgBG,eAAc,KAGvCnuC,OAAQ,IAAW,GAAAne,UAAA,6BAAAA,KAAKuM,OAAO46B,kBAAoBnnC,KAAK2S,SAAS2/B,gBAAgBqL,UAAU39C,KAAKuM,aAC/F,CACDtN,KAAM,UACNQ,KAAM,eACNuoB,QAAS,KACP,MAAM4xI,EAAgB55J,KAAKuM,OAC3B,IAAI4pC,GAAc,CAChBI,UAAW,CAAC,UAAW,YACvBF,SAAW9pC,GACF,IAAIpJ,SAAQ,CAAC4B,EAASylB,KAC3B,IAAI0iB,GAAU,GAAI,CAChBlD,aAAc,mBACd0D,mBAAoB,yBACpBG,oBAAqB,CAAC,IAAIvV,GAAU,CAAC/rB,OAAAA,EAAQisB,QAAQ,IAAOpuB,SAC5D+iC,QAAS,CAAC,CACR5B,QAAS,OACTzmC,SAAU,KACRC,IAEA/E,KAAK2S,SAAS40B,mBAAmBi7F,YAAYj2H,EAAQqtJ,GACrD55J,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAAC9nG,OAAAA,MAEtC,CACDg/B,QAAS,SACTzmC,SAAU,KACR0lB,KAEFsoD,UAAU,IAEZvmE,OAAAA,EACA6gC,iBAAiB,IAChB8B,UAGPnhC,YAAa,gCACbmmC,iBAAkB,gBAClBvC,aAAc,kBAGlBxzB,OAAQ,IAAW,qDAAmBne,KAAKuM,QAAUvM,KAAKuM,OAAO46B,iBAAmBnnC,KAAK2S,SAAS2/B,gBAAgBqL,UAAU39C,KAAKuM,mBAAqBvM,KAAK2S,SAAS2I,gBAAgBC,QAAQvb,KAAKuM,OAAOqO,aAAa0iC,UACpN,CACDr+C,KAAM,OACNQ,KAAM,YACNuoB,QAAS,KACP,IAAIklB,GAAU,GAAI,CAChB3gC,OAAQvM,KAAKuM,OACby9B,aAAc,YACd0D,mBAAoB,0BACpBG,oBAAqB,CAAC,IAAIvV,GAAU,CAAC/rB,OAAQvM,KAAKuM,SAASnC,SAC3D+iC,QAAS,CAAC,CACR5B,QAAS,YACTwO,UAAU,EACVj1C,SAAU,KACR9E,KAAK2S,SAAS2I,gBAAgBs6D,YAAY51E,KAAKuM,QAAQ,GAAM7K,MAAMlB,IAC9DA,GACDorC,GAAS,CAACC,YAAa,wBAK9BqD,QAEL/wB,OAAQ,IAAW,mC,MACjB,IAAIne,KAAKuM,OAAO46B,SAAU,OAAO,EACjC,MAAM2gD,QAAiB9nF,KAAK2S,SAASq8B,kBAAkBgpH,kBAAkBh4J,KAAKuM,OAAOqO,YACrF,OAAO5a,KAAKuM,SAAW,UAAkBu7E,KAA4B,QAAf,EAAAA,EAAStvE,cAAM,eAAEq9D,aAExE,CACD52E,KAAM,UACNQ,KAAM,UACNuoB,QAAS,KACPhoB,KAAK2S,SAAS2I,gBAAgBs6D,YAAY51E,KAAKuM,QAAQ,GAAO7K,MAAMlB,IAC/DA,GACDorC,GAAS,CAACC,YAAa,sBAI7B1tB,OAAQ,IAAW,mC,MACjB,MAAM2pE,QAAiB9nF,KAAK2S,SAASq8B,kBAAkBgpH,kBAAkBh4J,KAAKuM,OAAOqO,YACrF,SAAyB,QAAhB,EAAAktE,MAAAA,OAAQ,EAARA,EAAUtvE,cAAM,eAAEq9D,aAE5B,CACD52E,KAAM,gBACNQ,KAAM,SACNuoB,QAAS,KACP,IAAIsxB,GAAkBt5C,KAAKuM,SAE7B4R,OAAQ,IAAW,GAAAne,UAAA,4BAAmB,SAAnBA,KAAKoiC,KAAKniC,eAA4BD,KAAK2S,SAAS40B,mBAAmB+vB,cAAct3D,KAAKuM,cAG/GvM,KAAKo5J,UAAY,EAAW,UAC5Bp5J,KAAKgJ,iBAAiBhJ,KAAKo5J,WAAY/4J,IACrCL,KAAKoiC,KAAK+zD,gBACT,GAGEntF,iBAAiBuI,EAAiBrL,EAA6B4oB,IACpE,QAAiBvd,GAAKlR,KACpB,EAAA4nB,EAAA,GAAY5nB,IACXyuB,IAAU,EAAAuzC,GAAA,KACXn8D,EAAG7F,KACF,CAAC4I,eAAgBjJ,KAAKiJ,iBAGnBywJ,YAAYz5J,GAClBD,KAAKoiC,KAAKgyE,aAAaM,SAAS10G,KAAKuM,OAAOqO,WAAY3a,GAOlD45J,kBACN,MAAMf,EAAgB,IAAIxrH,GAG1B,OAFAwrH,EAAcvrH,UAAW,EACzBurH,EAAc15J,UAAUC,IAAI,YAAa,iBAClCy5J,EAGGvsJ,aACV,OAAOvM,KAAKoiC,KAAK71B,OAGZ+sG,uBAmGL,OAlGAt5G,KAAK84J,cAAgB94J,KAAK65J,kBAE1B75J,KAAKypC,SAAW3qC,SAASC,cAAc,OACvCiB,KAAKypC,SAASrqC,UAAUC,IAAI,QAE5BW,KAAK62D,cAAgB,IAAI8kF,GAAkB37I,KAAMA,KAAKoiC,KAAMpiC,KAAK2S,UAEjE3S,KAAK+4J,SAAU,OAAO,gDACtB/4J,KAAKi5J,QAAU,EAAW,SAC1Bj5J,KAAKk5J,aAAe,EAAW,aAC/Bl5J,KAAKg5J,UAAY,EAAW,WAC5Bh5J,KAAKm5J,QAAU,EAAW,QAE1Bn5J,KAAKgJ,iBAAiBhJ,KAAKi5J,QAASj5J,KAAK05J,YAAYxwJ,KAAKlJ,KAAM,UAChEA,KAAKgJ,iBAAiBhJ,KAAKk5J,aAAcl5J,KAAKm4J,sBAE9Cn4J,KAAKgJ,iBAAiBhJ,KAAKg5J,WAAW,KACpCh5J,KAAK88I,YAAW,MAGlB98I,KAAKgJ,iBAAiBhJ,KAAKm5J,QAASn5J,KAAKk3I,aAEzCl3I,KAAKgJ,iBAAiBhJ,KAAK+4J,SAAS,IAAW,mCAC7C,MAAMrqI,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBACrC/zG,KAAK+4J,QAAQv5J,aAAa,WAAY,QAEtC,MAAM6a,EAASra,KAAKuM,OAAO8hB,WAC3B,IAAIvkB,EAEFA,SADO9J,KAAK2S,SAASoH,gBAAgBo/B,UAAU9+B,IACrCra,KAAK2S,SAASoH,gBAAgB+/I,YAAYz/I,GAE1Cra,KAAK2S,SAASoH,gBAAgBkxC,YAAY5wC,EAAQ,UAG9DvQ,EAAQohB,SAAQ,KACVwD,KAIJ1uB,KAAK+4J,QAAQp0J,gBAAgB,oBAIjC3E,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAqBqa,GAAW,mC,MACjE,GAAGra,KAAKuM,SAAW8N,EAAOQ,UAAS,GAAO,CACxC,MAAMunB,QAAapiC,KAAK2S,SAASoH,gBAAgB00B,QAAQp0B,GAEzDra,KAAK+4J,QAAQ35J,UAAUoE,OAAO,SAAkC,QAAzB,EAAC4+B,MAAAA,OAAI,EAAJA,EAAkB5pB,cAAM,eAAE7R,OAClE3G,KAAKg3I,gBACLh3I,KAAKs3J,sBAITt3J,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,0BAA2Bw4B,IACzDA,EAAOjsB,SAAWvM,KAAKuM,QACxBvM,KAAK+5J,mBAIT/5J,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,gBAAgB,EAAEuM,OAAAA,MAChDvM,KAAKuM,SAAWA,GACjBvM,KAAKinD,mBAITjnD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,eAAgBkb,IAC9Clb,KAAKuM,SAAW2O,EAAOL,YACxB7a,KAAKinD,mBAITjnD,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,oBAAqBuM,IACnDvM,KAAKuM,SAAWA,GACjBvM,KAAKs3J,mBAINt3J,KAAK62D,eACN72D,KAAKoiC,KAAKhiC,iBAAiB,WAAW,CAAC6M,EAAK+sJ,KAC1C,MAAMtrI,EAAa1uB,KAAKoiC,KAAKqJ,QAAQsoE,gBACrC,gBAA2BryG,MAAM0pC,IAC3B1c,MAEJ1uB,KAAK62D,cAAc4lE,SAAWrxF,EAAM6uH,qBAAqBj6J,KAAKoiC,KAAK71B,QAEhEytJ,GACDh6J,KAAK62D,cAAcomF,0BACnBj9I,KAAK62D,cAAcqmF,QAAQjwI,EAAK,IACvBjN,KAAK62D,cAAcn6C,SAC5B1c,KAAK62D,cAAcmnF,+BACnBh+I,KAAK62D,cAAcqmF,QAAQjwI,WAMnCjN,KAAK2nD,sBAAwB7hD,OAAO8hD,YAAY5nD,KAAKinD,cAAe,KAE7DjnD,KAGF27G,yBACL37G,KAAKiJ,eAAe5J,IAAI,IAAxBW,CAAmC,wBAAwB,EAAEuM,OAAAA,EAAQ4sB,KAAAA,MAChE5sB,IAAWvM,KAAKuM,QAEhB4sB,GACDn5B,KAAK4P,cAKJsqJ,6BACLl6J,KAAK62D,cAAgB,IAAI8kF,GAAkB37I,KAAMA,KAAKoiC,KAAMpiC,KAAK2S,UAG5DmqI,WAAWqd,GAChBn6J,KAAKoiC,KAAKgyE,aAAaC,aAAa,CAClC9nG,OAAQvM,KAAKuM,OACb+2D,UAAW62F,GAAan6J,KAAK62D,cAAc63E,uBAAuBgI,cAAcx1I,UAAU0G,QAAQqF,IAAM,EACxGhN,KAAM,WAoBH+oD,UAELhpD,KAAKiJ,eAAe0G,YACpB7J,OAAOmjD,cAAcjpD,KAAK2nD,uBAEvB3nD,KAAK62D,eACN72D,KAAK62D,cAAc7N,UAGlBhpD,KAAKw4J,WACNx4J,KAAKw4J,UAAUxvG,iBAGVhpD,KAAKw4J,iBACLx4J,KAAK62D,cAGP5mD,UACDjQ,KAAKoiC,KAAK71B,QACZvM,KAAKkB,UAAU9B,UAAUC,IAAI,QAIpBq6G,iBAAiBqG,G,0CAC5B,MAAMxzG,EAASvM,KAAKuM,OAEpB,IAAI6tJ,EACDp6J,KAAK84J,gBACNsB,EAAYp6J,KAAK65J,mBAGnB,MAAOzrH,EAAaqH,EAAWrT,EAAMx1B,EAAGytJ,EAAkBC,EAAmBlvH,SAAejoC,QAAQC,IAAI,CACtGpD,KAAK2S,SAAS2/B,gBAAgBlE,YAAY7hC,GAC1CvM,KAAK2S,SAAS2/B,gBAAgBmD,UAAUlpC,GACxCA,EAAOkpC,YAAcz1C,KAAK2S,SAASoH,gBAAgB00B,QAAQliC,EAAO8hB,iBAAcrkB,EAChFowJ,EAAYA,EAAUvxH,kBAAkB,CAACt8B,OAAAA,SAAWvC,EACpDhK,KAAKu6J,iBACLv6J,KAAKy4J,qBAAoB,GACzB,kBAGF,MAAO,K,MAoBL,GAnBAz4J,KAAKm5J,SAAWn5J,KAAKm5J,QAAQ/5J,UAAUoE,OAAO,QAAS4qC,GACpDpuC,KAAK+4J,UACHtjH,IACD,EAAA7nC,EAAA,GAAe5N,KAAK+4J,SAAS,QAAK3qH,EAAc,iBAAmB,gBACnEpuC,KAAK+4J,QAAQ35J,UAAUoE,OAAO,SAAqB,QAAZ,EAAA4+B,MAAAA,OAAI,EAAJA,EAAM5pB,cAAM,eAAE7R,QAErD3G,KAAK+4J,QAAQ35J,UAAUC,IAAI,SAI5B+6J,IACDp6J,KAAK84J,cAAcr6H,YAAY27H,GAC/Bp6J,KAAK84J,cAAgBsB,GAGvBp6J,KAAKg3I,gBAELh3I,KAAKs3J,gBAEFt3J,KAAK62D,cACN,GAAsB,SAAnB72D,KAAKoiC,KAAKniC,KAAiB,CAC5B,GAAGD,KAAKoiC,KAAKo4H,eAAgB,CAC3B,MAAMC,EAAmB,IAAI9e,GAAkB37I,KAAMA,KAAKoiC,KAAMpiC,KAAK2S,UACrE3S,KAAK62D,cAAc63E,uBAAuBgI,cAAcx1I,UAAUu9B,YAAYg8H,EAAiB/rB,uBAAuBgI,cAAcx1I,WACpIlB,KAAK62D,cAAc7N,UAEnBhpD,KAAK62D,cAAgB4jG,EAGvBz6J,KAAK62D,cAAc4lE,SAAWrxF,EAAM6uH,qBAAqB1tJ,OAC9B,eAAnBvM,KAAKoiC,KAAKniC,OAClBD,KAAK62D,cAAcglF,UAAY77I,KAAKoiC,KAAKv2B,SACzC7L,KAAK62D,cAAc9pD,MAAQ,EAC3B/M,KAAK62D,cAAcilF,YAAc,EACjC97I,KAAK62D,cAAcmmF,qBAIvBqd,IACAC,GAAqBA,IACrBt6J,KAAK+5J,gBAEL/5J,KAAKkB,UAAU9B,UAAUkB,OAAO,YAIvBi6J,eAAextJ,G,0CAC1B,MAAMR,EAASvM,KAAKuM,OACdmiB,EAAa,IAAM1uB,KAAKuM,SAAWA,EACzC,IAAI0xB,EAAsBmqB,EAC1B,GAAsB,WAAnBpoD,KAAKoiC,KAAKniC,KACag+B,OAAXj0B,IAAV+C,GAA+B,QAAK,YACxB,QAAK,sBAAuB,CAACA,SAE/B/C,IAAV+C,GACD/M,KAAK2S,SAAS40B,mBAAmBgmC,kBAAkBhhE,EAAQ,CAAC,CAACK,EAAG,+BAA+B,GAAOlL,MAAM4N,IAC1G,IAAIof,IAAc,OAClB,MAAM3hB,EAAQuC,EAAO,GAAGvC,MAIxB,GAHA/M,KAAK4P,SAAS7C,IAGVA,EAAO,CACT/M,KAAKoiC,KAAKgyE,aAAatuD,UAGvB,MAAM2oF,EAAezuI,KAAKoiC,KAAKgyE,aAAahyE,KACzCqsG,EAAal4B,OAAO1/C,eACrB43E,EAAal4B,OAAO1/C,cAAc63E,uBAAuBlrI,QAAO,YAKnE,GAAsB,cAAnBxD,KAAKoiC,KAAKniC,KAClBg+B,GAAU,QAAK1xB,IAAW,SAAiB,YAAc,0BACpD,GAAsB,eAAnBvM,KAAKoiC,KAAKniC,KAAuB,CACzC,QAAa+J,IAAV+C,EAAqB,CACtB,MAAMuC,QAAetP,KAAK2S,SAASm2C,aAAavhB,mBAAmB2hF,WAAW38G,EAAQ,EAAG,EAAG,EAAGvM,KAAKoiC,KAAKv2B,UACzG,GAAGyD,EAAO2c,OAAQ,CAChB,MAAM08F,QAAsBr5G,EAAOA,OACnCvC,EAAQ47G,EAAc57G,WACjBuC,EAAOA,OAAO5N,MAAMinH,GAAkB3oH,KAAK4P,SAAS+4G,EAAc57G,SAGnDkxB,OAAXj0B,IAAV+C,GAA+B,QAAK,YACxB,QAAK,sBAAuB,CAACA,SACvC,GAAsB,SAAnB/M,KAAKoiC,KAAKniC,QACjBg+B,EAASmqB,SAAejlD,QAAQC,IAAI,CACnC0jD,GAAc,CACZv6C,OAAAA,EACAisB,QAAQ,IAEVgnB,GAAmBjzC,MAGjBmiB,KACF,OAIJ,MAAO,MACL,EAAA9gB,EAAA,GAAe5N,KAAK8O,MAAOmvB,GACxBmqB,GACDpoD,KAAK8O,MAAMpP,UAAU0oD,OAKpBx4C,SAAS7C,GACd/M,KAAKu6J,eAAextJ,GAAOrL,MAAM24J,GAAqBA,MAG3CN,gB,0CACX,IAAI/5J,KAAKm5J,QAAS,OAElB,MAAM5sJ,EAASvM,KAAKuM,OACpB,IAAIq0B,QAAc5gC,KAAK2S,SAASyrC,wBAAwBO,iBAAiBpyC,GAAQ,UACxEvM,KAAK2S,SAAS2/B,gBAAgBlE,YAAY7hC,KACjDvM,KAAKm5J,QAAQ/5J,UAAUkB,OAAO,aAAc,gBAC5CN,KAAKm5J,QAAQ/5J,UAAUC,IAAIuhC,EAAQ,eAAiB,cACpD5gC,KAAKm5J,QAAQl2J,MAAMC,QAAU,IAE7BlD,KAAKm5J,QAAQl2J,MAAMC,QAAU,WChzBpB,MAAMw3J,WAA4BlsJ,EAAjD,c,oBAMU,KAAA3C,SAAW,EACX,KAAAF,MAAQ,GAGhB+F,qBACE1R,KAAK26J,UAAUnuJ,YAAYxM,KAAKuM,OAAQvM,KAAK6L,SAAU7L,KAAK2L,OAGpD0D,OACRrP,KAAKkB,UAAUsP,GAAK,2BACpBxQ,KAAKkB,UAAU9B,UAAUC,IAAI,sBAC7BW,KAAK2yF,YAAc,IAAI7kF,EAAY,UACnC9N,KAAK8O,MAAM2vB,YAAYz+B,KAAK2yF,YAAYzxF,WAExClB,KAAK46J,YAAc,EAAW,iCAC9B56J,KAAK4O,OAAOlP,OAAOM,KAAK46J,aAExB,MAAM9jJ,EAAIhY,SAASC,cAAc,OACjC+X,EAAE1X,UAAUC,IAAI,sBAChBW,KAAK8L,WAAW5K,UAAUu9B,YAAY3nB,GACtC9W,KAAK26J,UAAY,IAAIzvJ,EAAU4L,EAAG9W,KAAK2yF,YAAa,CAClD3mF,SAAU,IAAIxB,EAAY,4BAA6B,cAI3D2E,KAAK5C,EAAgBV,EAAmB0oG,EAAgD5oG,GACtF,MAAMwzC,EAAMt/C,MAAMsP,OAsBlB,OApBInP,KAAKuM,OAiBPvM,KAAK26J,UAAUnuJ,YAAYxM,KAAKuM,OAAQvM,KAAK6L,SAAUF,IAhBvD3L,KAAK2L,MAAQA,EACb3L,KAAKuM,OAASA,EACdvM,KAAK6L,SAAWA,EAChB7L,KAAKu0G,WAAaA,EAElBv0G,KAAK46J,YAAYx7J,UAAUoE,OAAO,QAASxD,KAAKu0G,YAC7Cv0G,KAAKu0G,aACN,QAAiBv0G,KAAK46J,aAAa,KACjC,gBAAyBh+D,GAAiB,IAAIl3F,KAAQ1F,KAAKu0G,YAAYrlE,UAI3EvjC,GAAS3L,KAAK26J,UAAUxvJ,YAAY5I,WAAW3B,iBAAiB+K,GAEhE,kBAA8B,IAKzBwzC,GC7CI,MAAM07G,GAuBnBj7J,YAAoB22G,EAA4Bn0E,EAAYz2B,GAAxC,KAAA4qG,OAAAA,EAA4B,KAAAn0E,KAAAA,EANxC,KAAA52B,WAAa,EACb,KAAAsvJ,cAAgB,EA6HhB,KAAAv9D,YAAel9F,KACrB,EAAA4nB,EAAA,GAAY5nB,GACZ,gBAAyBu8F,GAAiB,IAAIl3F,KAAQ1F,KAAKoiC,KAAKqJ,QAAQ8oE,YAAYrlE,QAwC9E,KAAA6rH,eAAkB16J,IACxB,MAAM8G,GAAS,EAAAsxC,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IAChCvxC,GACDnH,KAAKg7J,aAAa7zJ,IAId,KAAA8zJ,cAAiB56J,IACpBL,KAAKwL,aACNxL,KAAKoiC,KAAKqJ,QAAQvqC,UAAU9B,UAAUoE,OAAO,yBAC7CxD,KAAKuqB,QAAQnrB,UAAUoE,OAAO,YAI1B,KAAA03J,UAAa76J,KACnB,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKg7J,aAAah7J,KAAKmN,YAAYtC,KAAKib,SAAS9lB,KAAK86J,cAAgB,KAGhE,KAAAK,YAAe96J,KACrB,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKg7J,aAAah7J,KAAKmN,YAAYtC,KAAKib,SAAS9lB,KAAK86J,cAAgB,KAtLtE96J,KAAKoK,QAAUtL,SAASC,cAAc,OACtCiB,KAAKoK,QAAQhL,UAAUC,IAAI,iBAAkB,cAAe,sBAE5DW,KAAKs1F,QAAUx2F,SAASC,cAAc,UACtCiB,KAAKs1F,QAAQl2F,UAAUC,IAAI,WAAY,aAAc,yBACrD,EAAAwF,GAAA,GAAO7E,KAAKs1F,SAEZ,MAAMrsF,EAAiBjJ,KAAKiJ,eAAiB,IAAI,IAE3CovI,EAAc,CAACjuI,EAAsBtF,MACzC,QAAiBsF,EAAStF,EAAU,CAACmE,eAAAA,KAGvCovI,EAAYr4I,KAAKs1F,SAAS,KACxBt1F,KAAKgpD,aAGPhpD,KAAK2yF,YAAc,IAAI7kF,EAAY,UAGnC9N,KAAKuqB,QAAUzrB,SAASC,cAAc,OACtCiB,KAAKuqB,QAAQnrB,UAAUC,IAAI,sBAAuB,sBAElDW,KAAKmN,YAAc,IAAI3C,GAAY,EAAO,gBAAYR,EAAW,IAAI,GACrEquI,EAAYr4I,KAAKmN,YAAYtC,KAAM7K,KAAK+6J,gBAExC/6J,KAAK26J,UAAY,IAAIzvJ,EAAUlL,KAAKuqB,QAASvqB,KAAK2yF,YAAa,CAC7D3mF,SAAUhM,KAAKmN,cACbJ,IACF/M,KAAKwL,WAAauB,EAEd/M,KAAKwL,WAOPxL,KAAKg7J,aAAah7J,KAAKmN,YAAYtC,KAAKib,SAAS,MANjD,EAAAlY,EAAA,GAAe5N,KAAKo7J,aAAcp7J,KAAK2yF,YAAYnyF,OAAQ,QAAK,YAAc,IAC9ER,KAAKuqB,QAAQnrB,UAAUkB,OAAO,UAC9BN,KAAKoiC,KAAKqJ,QAAQvqC,UAAU9B,UAAUkB,OAAO,yBAC7CN,KAAKq7J,MAAM77J,aAAa,WAAY,QACpCQ,KAAKs7J,QAAQ97J,aAAa,WAAY,YAK1CQ,KAAK26J,UAAUnuJ,YAAYxM,KAAKoiC,KAAK71B,OAAQvM,KAAKoiC,KAAKv2B,UAGvD7L,KAAKoiC,KAAKqJ,QAAQvqC,UAAUxB,OAAOM,KAAKuqB,SAGxCvqB,KAAKu7J,OAASz8J,SAASC,cAAc,OACrCiB,KAAKu7J,OAAOn8J,UAAUC,IAAI,sBAE1Bg5I,EAAYr4I,KAAKu7J,OAAQv7J,KAAKi7J,gBAC9B,EAAAp2J,GAAA,GAAO7E,KAAKu7J,QAEZv7J,KAAKo7J,aAAet8J,SAASC,cAAc,QAC3CiB,KAAKo7J,aAAah8J,UAAUC,IAAI,qBAEhCW,KAAKw7J,QAAU18J,SAASC,cAAc,UACtCiB,KAAKw7J,QAAQp8J,UAAUC,IAAI,WAAY,kBAEvCW,KAAKk7H,SAAWp8H,SAASC,cAAc,OACvCiB,KAAKk7H,SAAS97H,UAAUC,IAAI,wBAE5BW,KAAKq7J,MAAQv8J,SAASC,cAAc,UACpCiB,KAAKq7J,MAAMj8J,UAAUC,IAAI,WAAY,YACrCW,KAAKs7J,QAAUx8J,SAASC,cAAc,UACtCiB,KAAKs7J,QAAQl8J,UAAUC,IAAI,WAAY,cAEvCW,KAAKq7J,MAAM77J,aAAa,WAAY,QACpCQ,KAAKs7J,QAAQ97J,aAAa,WAAY,QAEtC64I,EAAYr4I,KAAKw7J,QAASx7J,KAAKu9F,aAC/B86C,EAAYr4I,KAAKq7J,MAAOr7J,KAAKk7J,WAC7B7iB,EAAYr4I,KAAKs7J,QAASt7J,KAAKm7J,aAC/Bn7J,KAAKk7H,SAASx7H,OAAOM,KAAKq7J,MAAOr7J,KAAKs7J,SAEtCt7J,KAAKu7J,OAAO77J,OAAOM,KAAKo7J,aAAcp7J,KAAKw7J,QAASx7J,KAAKk7H,UAEzDl7H,KAAKu2G,OAAOr1G,UAAU0C,cAAcE,aAAa9D,KAAKu7J,OAAQn5H,EAAKriC,MAAMugI,WAGzEtgI,KAAKoK,QAAQ1K,OAAOM,KAAKs1F,QAASt1F,KAAK2yF,YAAYzxF,WAEnDlB,KAAKu2G,OAAOr1G,UAAU9B,UAAUC,IAAI,eACpCW,KAAKu2G,OAAOr1G,UAAU0C,cAAclE,OAAOM,KAAKoK,SAEhDpK,KAAK2yF,YAAY5yF,MAAM0M,QAEpBd,GACD3L,KAAK6rD,SAASlgD,GAGZ,GAAAk2C,mBACF7hD,KAAKs2F,eAAiB,CACpBr2F,KAAM,gBACN0R,MAAO,KACL3R,KAAKgpD,YAIT14C,EAAA,WAAiCtQ,KAAKs2F,iBAInCttC,UACLhpD,KAAKu2G,OAAOr1G,UAAU9B,UAAUkB,OAAO,eACvCN,KAAKoK,QAAQ9J,SACbN,KAAK2yF,YAAYryF,SACjBN,KAAKuqB,QAAQjqB,SACbN,KAAKu7J,OAAOj7J,SACZN,KAAKiJ,eAAe0G,YACpB3P,KAAKoiC,KAAKqJ,QAAQvqC,UAAU9B,UAAUkB,OAAO,yBAC7CN,KAAKoiC,KAAKsrE,YAAS1jG,EACnBsG,EAAA,aAAmCtQ,KAAKs2F,gBAGnCzqC,SAASlgD,GACd3L,KAAK2yF,YAAYpwF,WAAW/B,MAAQmL,EAQ9BqvJ,aAAa92J,GACnB,GAAGlE,KAAK62G,eAAgB,OAAO72G,KAAK62G,eAEpC,MAAMtqG,EAASrI,EAAK0D,QAAQ2E,OAAOsO,WAC7ByoD,GAAap/D,EAAK0D,QAAQqF,UAAOjD,EAEjCsb,GAAQ,EAAA21C,GAAA,GAAW/2D,GAEtBohB,IAAWtlB,KAAKwL,WAAa,EAC9BxL,KAAKq7J,MAAM77J,aAAa,WAAY,QAEpCQ,KAAKq7J,MAAM12J,gBAAgB,YAGzB2gB,EAGFtlB,KAAKs7J,QAAQ32J,gBAAgB,YAF7B3E,KAAKs7J,QAAQ97J,aAAa,WAAY,QAKxCQ,KAAKuqB,QAAQnrB,UAAUkB,OAAO,UAC9BN,KAAKoiC,KAAKqJ,QAAQvqC,UAAU9B,UAAUkB,OAAO,yBAE7C,MAAMwM,EAAM9M,KAAKoiC,KAAK0jB,QAAQv5C,EAAQ+2D,GACtCtjE,KAAK62G,gBAAmB/pG,aAAe3J,QAAU2J,EAAM3J,QAAQ4B,QAAQ+H,IAAuBpL,MAAK,KACjG1B,KAAK86J,cAAgBx1I,GACrB,EAAA1X,EAAA,GAAe5N,KAAKo7J,cAAc,QAAK,KAAM,CAAC91I,EAAQ,EAAGtlB,KAAKwL,cAE9D,MAAMiwJ,EAAgBz7J,KAAKmN,YAAYtC,KAAKI,kBACzCjL,KAAK86J,eAAkBW,EAAgB,GACxCz7J,KAAK26J,UAAUvuJ,gBAEhB8e,SAAQ,KACTlrB,KAAK62G,eAAiB,SC3Lb,MAAM6kD,GAYnB97J,cACEI,KAAK27J,SAAW,IAAI/8I,IAGf6E,mBAAmB7kB,GACxB,IAAIg9J,EAAW57J,KAAK67J,UAAUzpJ,MAAMwpJ,IAC3B,EAAA/kH,GAAA,GAAU+kH,EAASh9J,QAASA,KASrC,OANIg9J,IACFA,EAAW,IAAIF,GACfE,EAASvsJ,KAAKzQ,GACdoB,KAAK67J,UAAUhqJ,KAAK+pJ,IAGfA,EAGFvsJ,KAAKzQ,GAUVoB,KAAKpB,QAAUA,EAGVk9J,eAAe94J,GAKpB,OAAOhD,KAAK6mB,mBAAmB7mB,KAAKpB,QAAQ0nB,KAAK5kB,MAAK,IAC7C1B,KAAK+7J,WAAW/4J,KAInB6jB,mBAAmBP,GACzB,GAAGtmB,KAAKknB,0BAA2B,OAAOlnB,KAAKknB,0BAC/C,MAAMoE,EAAMtrB,KAAKsrB,IAAMxsB,SAASC,cAAc,OAE9C,OADAusB,EAAI0wI,YAAc,YACXh8J,KAAKknB,0BAA4BA,GAA0BoE,EAAKhF,GAAK,GAAO5kB,MAAK,IAAM4pB,IAmCzFrb,QAAQjN,GACbhD,KAAK27J,SAASjsJ,OAAO1M,GAEjBhD,KAAK27J,SAAS36J,QAChB,EAAA+Q,EAAA,GAAiB2pJ,GAA8BG,UAAW77J,MAEvDA,KAAKi8J,WACN1hG,IAAI4T,gBAAgBnuE,KAAKi8J,YAKxBF,WAAW/4J,GAChB,MAAM+nB,EAAU/nB,EAAO6P,WAAW,OAC5B,MAACtR,EAAK,OAAEC,GAAUwB,EAMlBsoB,EAAMtrB,KAAKsrB,IAEjB,IAAI4wI,EAAa5wI,EAAI/pB,MAAO46J,EAAc7wI,EAAI9pB,OAExC46J,EAAgB,KAAOp5J,EAAOq5J,KAI9Br5J,EAAO4E,QAAQ00J,iBAAmB96J,IAAQ46J,GAAiB,MAE/DF,GADcE,EAAgBD,EAE9BA,EAAcC,EAGbp8J,KAAKpB,QAAQ29J,MACdxxI,EAAQsxD,UAAY,OACpBtxD,EAAQuxD,SAAS,EAAG,EAAG/6E,EAAOC,GAC9BupB,EAAQyxI,yBAA2B,mBAEnCzxI,EAAQyxI,yBAA2B,cAGrC,MAAMppJ,EAAKnM,IACT,IAAI,IAAID,EAAI,EAAGA,EAAIzF,EAAOyF,GAAKk1J,EAC7BnxI,EAAQa,UAAUN,EAAKtkB,EAAGC,EAAGi1J,EAAYC,IAIvCM,EAAUj7J,EAAS,EAAI26J,EAAc,EAG3C,GAFA/oJ,EAAEqpJ,GAECA,EAAU,EAAG,CACd,IAAIC,EAAOD,EACX,GACErpJ,EAAEspJ,GAAQP,SACJO,GAAQ,GAGlB,MAAMC,EAAOn7J,EAAS,EACtB,IAAI,IAAIo7J,EAAUH,EAAUN,EAAaS,EAAUD,EAAMC,GAAWT,EAClE/oJ,EAAEwpJ,GAaCC,oBAAoB75J,GACzB,MAAMkd,EAAmBvd,KAAKC,IAAI,EAAGkD,OAAOoa,kBAC5C,IAAI3e,EAAQvB,KAAKpB,QAAQ2C,MAAQ2e,EAC/B1e,EAASxB,KAAKpB,QAAQ4C,OAAS0e,EAEjCld,EAAOq5J,IAAMn8I,EACbld,EAAO4E,QAAQ00J,eAAiB,GAAK96J,EAClC6tB,EAAA,iBAA4B,YAAkB7tB,GAAU,KAC3DwB,EAAOzB,MAAQA,EACfyB,EAAOxB,OAASA,EAIXs7E,eACL,MAAM95E,EAASlE,SAASC,cAAc,UAGtC,OAFAiB,KAAK27J,SAASt8J,IAAI2D,GAClBhD,KAAK68J,oBAAoB75J,GAClBA,EAGFq1J,OAAO92J,EAAeC,GAC3BxB,KAAKqP,KAAK,OAAD,wBACJrP,KAAKpB,SAAO,CACf2C,MAAAA,EACAC,OAAAA,KAGF,MAAMiI,EAA2B,GACjC,IAAI,MAAMzG,KAAUhD,KAAK27J,SACvB37J,KAAK68J,oBAAoB75J,GACzByG,EAASoI,KAAK7R,KAAK87J,eAAe94J,IAGpC,OAAOG,QAAQC,IAAIqG,GAGdga,uBAAuBliB,EAAeC,GAC3C,OAAO2B,QAAQC,IAAIpD,KAAK67J,UAAUlhJ,KAAKihJ,GAAaA,EAASvD,OAAO92J,EAAOC,OAzM9D,GAAAq6J,UAA6C,G,2SCqB/C,MAAMiB,WAAa,IA6ChCl9J,YACSw0G,EACAzhG,GAEP9S,QAHO,KAAAu0G,aAAAA,EACA,KAAAzhG,SAAAA,EAIP3S,KAAKC,KAAO,OAEZD,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,OAAQ,YAErCW,KAAK+8J,aAAej+J,SAASC,cAAc,OAC3CiB,KAAK+8J,aAAa39J,UAAUC,IAAI,mBAIhCW,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,OAAQ,MAAAm1F,IAAe,WAAgB,YAAiB,aAG1Eh9J,KAAKuM,OAAS,MAEdvM,KAAKkB,UAAUxB,OAAOM,KAAK+8J,cAC3B/8J,KAAKo0G,aAAanjE,eAAevxC,OAAOM,KAAKkB,WAE7ClB,KAAKi9J,iBAAmB,EACxBj9J,KAAKk9J,gBAAkB,GAGlBC,cAAc72I,EAAao4G,GAChC,MAAM3+C,EAAQO,GAAA,aAEd,IAAIvhE,EAEJ,GAD4BghE,EAAMD,WAAWx3D,QAAUy3D,EAAMD,WAAWG,OAASF,EAAMD,WAAWE,WAGtD,aAA1ClhF,SAASguD,gBAAgB7pD,MAAMo/C,QAC/BriD,KAAK+8E,mBACJ/8E,KAAKo9J,gBAIN,OAFAp9J,KAAKq9J,eAAez1J,QAAQs0E,OAAS6D,EAAMD,WAAWx3D,MACtDtoB,KAAK+8E,iBAAiB1tE,KAAKrP,KAAKq9J,gBACzBl6J,QAAQ4B,UAGjB,MAAM0iB,IAAWznB,KAAKi9J,iBAEhBK,EAA2Bt9J,KAAK+8E,iBAChCwgF,EAA0Bv9J,KAAKo9J,gBAE/BI,GADyBx9J,KAAKq9J,eACNr9J,KAAKy9J,eAEnCz9J,KAAK+8E,iBACH/8E,KAAKo9J,gBACLp9J,KAAKq9J,eACLr9J,KAAKy9J,mBAELzzJ,EAEF,MAAMg2E,EAAYD,EAAMD,WAAWE,WAAaD,EAAMD,WAAWE,UAAY,IACvE09E,IAAkB19E,GAAaA,EAAY,EAEjD,IAAIo9E,EAEAC,EA2CAtgF,EA5CA0gF,EAAgB1+I,MAAAA,OAAI,EAAJA,EAAMgK,kBAE1B,IAAIhK,EAIF,GAHAA,EAAOjgB,SAASC,cAAc,OAC9BggB,EAAK3f,UAAUC,IAAI,wBAEhBinB,EACD,GAAG05D,EAAW,CACZjhE,EAAK3f,UAAUC,IAAI,cAEnB,MAAMmH,EAAOxG,KAAKo0G,aAAanjE,eAAexqC,wBAC9C22J,EAAkBp9J,KAAKo9J,gBAAkB1B,GAA8BiC,YAAY,CACjFr3I,IAAAA,EACA/kB,MAAOiF,EAAKjF,MACZC,OAAQgF,EAAKhF,OACb+6J,KAAMmB,IAGRD,EAAgBz9J,KAAKy9J,cAAgBL,EAAgBtgF,eACrD2gF,EAAcr+J,UAAUC,IAAI,8BAA+B,uCAExDq+J,GACD3+I,EAAK3f,UAAUC,IAAI,gBAcb0gF,EAAMD,WAAWG,MACzBlhE,EAAK3f,UAAUC,IAAI,iBAEb0gF,EAAMD,WAAWx3D,OACzBvJ,EAAK3f,UAAUC,IAAI,YAKvB,MAAMipB,EAAQy3D,EAAMD,WAAWx3D,MAC/B,GAAGA,EAAO,CAER,MAAM,OAACtlB,EAAQ+5E,iBAAkB6gF,GAAqBnlF,GAA+BsK,OAAOz6D,GAC5Fy0D,EAAmB/8E,KAAK+8E,iBAAmB6gF,EAC3CP,EAAiBr9J,KAAKq9J,eAAiBr6J,EACvCq6J,EAAej+J,UAAUC,IAAI,8BAA+B,qCAEzD,gCACD09E,EAAiBH,eAAc,GAQhCwgF,IACoBM,EAAgBL,EAAiBI,GACzCx6J,MAAMmgD,YAAY,gBAAiB,GAAKzgD,KAAKoE,IAAIi5E,IAGhE,MAAMl2E,EAAU,IAAI3G,SAAe4B,IACjC,MAAMmB,EAAK,KACT,GAAGlG,KAAKi9J,mBAAqBx1I,EAS3B,OARG21I,GACDA,EAAgBntJ,QAAQwtJ,QAGvB1gF,GACDA,EAAiB9sE,WAMrB,MAAMupB,EAAOx5B,KAAK+8J,aAAat4J,iBAE/B,GAAG+0B,IAASza,EAEV,YADAha,IAIF,MAAMrF,EAAS,CACb29J,EAEAI,GACA9xI,OAAO6kB,SACN9wC,EAAOiB,QACRoe,EAAKrf,UAAUA,GAGjBM,KAAK+8J,aAAar9J,OAAOqf,IAEzB,QAAcA,EAAM,cAAc,EAAO2/G,EAAsB,EAAN,IAASllG,EAAO,KACpE+jI,GACDA,EAAwBttJ,QAAQutJ,GAG/BF,GACDA,EAAyBrtJ,UAG3BupB,EAAKl5B,UACH,KAAM,GAEVyE,KAGCq4J,EAC4BA,EAAgBtB,eAAe2B,GACvC/7J,MAAK,KACxB,GAAG1B,KAAKi9J,mBAAqBx1I,EAC3B,OAGF,IAAI3d,EAIFA,EAAU3G,QAAQ4B,UAGpB+E,EAAQpI,KAAKwE,MAEPogB,EACRO,GAAmB9H,EAAMuH,EAAKpgB,GAE9BA,OAIJ,OAAOlG,KAAK69J,qBAAuB16J,QAAQ25C,KAAK,EAC9C,QAAM,KACNhzC,IAIGg0J,QAAQ79J,GACbD,KAAKC,KAAOA,EAGPoP,OAGLrP,KAAKu2G,OAAS,IAAI8gD,GAAWr3J,KAAM,GAAiBA,KAAK2S,UACzD3S,KAAKyrC,QAAU,IAAIimE,GAAY1xG,KAAMA,KAAK2S,UAC1C3S,KAAKD,MAAQ,IAAI2lI,GAAU1lI,KAAMA,KAAKo0G,aAAcp0G,KAAK2S,UACzD3S,KAAK+4G,YAAc,IAAIyY,GAAgBxxH,KAAMA,KAAK2S,UAClD3S,KAAKsrD,UAAY,IAAIsY,GAAc5jE,KAAMA,KAAKyrC,QAASzrC,KAAKD,MAAOC,KAAK2S,UAEvD,SAAd3S,KAAKC,MACND,KAAKu2G,OAAOijD,iBACZx5J,KAAKu2G,OAAO+C,wBACU,WAAdt5G,KAAKC,KACbD,KAAKu2G,OAAOoF,yBACU,eAAd37G,KAAKC,OACbD,KAAKu2G,OAAOijD,iBACZx5J,KAAKu2G,OAAO2jD,8BAGdl6J,KAAKu2G,OAAO9tF,YACZzoB,KAAKD,MAAM0oB,YAEM,SAAdzoB,KAAKC,MACND,KAAKyrC,QAAQ6tE,uBACbt5G,KAAKD,MAAMu5G,wBACW,WAAdt5G,KAAKC,MACbD,KAAKyrC,QAAQkwE,yBACb37G,KAAKD,MAAM47G,0BACW,cAAd37G,KAAKC,MACbD,KAAKyrC,QAAQmwE,4BACb57G,KAAKD,MAAMu5G,wBACW,eAAdt5G,KAAKC,OACbD,KAAKyrC,QAAQ6tE,uBACbt5G,KAAKD,MAAMu5G,wBAGI,cAAdt5G,KAAKC,MAAyB,MAC/BD,KAAKyrC,QAAQuvE,6BAGfh7G,KAAKyrC,QAAQqtE,2BAEb94G,KAAKkB,UAAU9B,UAAUC,IAAI,QAAUW,KAAKC,MAC5CD,KAAKkB,UAAUxB,OAAOM,KAAKu2G,OAAOr1G,UAAWlB,KAAKyrC,QAAQvqC,UAAWlB,KAAKD,MAAMugI,WAEhFtgI,KAAKyrC,QAAQxiC,eAAe5J,IAAI,IAAhCW,CAA2C,kBAAkB,EAAEo5C,YAAAA,EAAaC,UAAAA,MACvEr5C,KAAKuM,SAAW6sC,GACjBp5C,KAAK8lD,QAAQzM,MAIjBr5C,KAAKyrC,QAAQxiC,eAAe5J,IAAI,IAAhCW,CAA2C,eAAgBK,IACtDA,EAAEkM,SAAWvM,KAAKuM,QACnBvM,KAAKo0G,aAAatuD,aAKjBi4G,gBACL/9J,KAAKyrC,QAAQx7B,UAGP+tJ,sBACJh+J,KAAKi9J,iBACJj9J,KAAKo9J,kBACNp9J,KAAKo9J,gBAAgBntJ,QAAQjQ,KAAKy9J,eAClCz9J,KAAKo9J,qBAAkBpzJ,GAGtBhK,KAAK+8E,mBACN/8E,KAAK+8E,iBAAiB9sE,UACtBjQ,KAAK+8E,sBAAmB/yE,GAIrBg/C,UAGLhpD,KAAKu2G,OAAOvtD,UACZhpD,KAAKyrC,QAAQud,UACbhpD,KAAKD,MAAMipD,UACXhpD,KAAK+4G,aAAe/4G,KAAK+4G,YAAY/vD,UACrChpD,KAAKsrD,WAAatrD,KAAKsrD,UAAU4V,qBAAgBl3D,OAAWA,GAE5DhK,KAAKg+J,2BAEEh+J,KAAKu2G,cACLv2G,KAAKyrC,eACLzrC,KAAKD,aACLC,KAAKsrD,iBACLtrD,KAAK+4G,YAEZ/4G,KAAKkB,UAAUZ,SAKV2P,QAAQ0/H,GAAY,GACzB3vI,KAAKD,MAAMkQ,QAAQ0/H,GACnB3vI,KAAKu2G,OAAOtmG,UACZjQ,KAAKsrD,UAAUr7C,UAGJ2vG,aAAa/zF,G,0CACxB,MAAM,OAACtf,GAAUvM,KAEXi+J,EAAY,UAAuBvD,IACtCuD,GACDA,EAAUhvJ,QAGZ,MAAOgjH,EAAYppE,EAAcyjC,EAAY1/E,EAAG2xD,SAAqB1yC,EAAE1oB,QAAQC,IAAI,CACjFpD,KAAK2S,SAAS2/B,gBAAgB2/E,WAAW1lH,GACzCvM,KAAK2S,SAAS2/B,gBAAgBuW,aAAat8C,GAC3CvM,KAAKk+J,YAAY3xJ,GACjBvM,KAAKm+J,uBACLn+J,KAAK2S,SAAS2/B,gBAAgBisB,YAAYhyD,MAG5CvM,KAAKiyH,WAAaA,EAClBjyH,KAAK6oD,aAAeA,EACpB7oD,KAAKssF,WAAaA,EAClBtsF,KAAKu+D,YAAcA,EAEnBv+D,KAAKkB,UAAU9B,UAAUoE,OAAO,cAAexD,KAAKiyH,YAEpDjyH,KAAK2sD,eAAiB,0BACtB3sD,KAAKk9J,gBAAgBrrJ,KAAK7R,KAAK2sD,gBAE/B3sD,KAAK2sD,eAAe7G,QAAQv5C,EAAQvM,KAAK6L,UACzC7L,KAAKD,MAAMo4H,cACXn4H,KAAKsrD,UAAUr7C,aAGV61C,QAAQv5C,EAAgB+2D,EAAoBm8C,GAC7ClzG,EAEOvM,KAAK8uG,SACX9uG,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGdrP,KAAK8uG,QAAS,GAPd9uG,KAAK8uG,YAAS9kG,EAUhB,MAAMw1G,EAAWx/G,KAAKuM,SAAWA,EACjC,GAAIizG,GAIG,GAAGx/G,KAAK62G,eACb,YAJA72G,KAAKo0G,aAAapkG,cAAc,gBAAiBhQ,MACjDA,KAAKuM,OAASA,GAAU,MACxBvM,KAAKm3G,mBAAqB,GAAGn3G,KAAKuM,UAAwB,cAAdvM,KAAKC,KAAuB,YAAc,YAKxF,IAAIsM,EAKF,OAJA,kBAA8B,GAC9BvM,KAAKiQ,SAAQ,GACbjQ,KAAKyrC,QAAQqa,SAAQ,EAAOv5C,QAC5BvM,KAAKo0G,aAAapkG,cAAc,eAAgBzD,GAIlDvM,KAAK4rD,YAAc4zD,EAEnB,MAAM4+C,EAAwBp+J,KAAKyrC,QAAQqa,QAAQ05D,EAAUjzG,EAAQ+2D,EAAWm8C,GAC1E5I,EAAiB72G,KAAK62G,eAAiBunD,EAAsB18J,MAAM4N,GAChEA,EAAOxF,UACb+D,MAAM8vB,GAAA,GAAMzS,SAAQ,KAClBlrB,KAAK62G,iBAAmBA,IACzB72G,KAAK62G,eAAiB,SAI1B,OAAOunD,EAGFC,sBAAsBvtJ,EAAM9Q,KAAK2sD,iBACtC,EAAA56C,EAAA,GAAiB/R,KAAKk9J,gBAAiBpsJ,GACvCA,EAAIk4C,UAGOm1G,uB,0CACXn+J,KAAKw/B,mBC9cM,SAA+CjzB,G,qCAC5D,IAAItM,EAEAq+J,EAAe,EAAGC,EAAe,EAAGC,EAAc,EACtD,MAAMlnF,EAAW,aACXhlC,EAAkB,6BAmBxB,OAlBIglC,EAAS+Y,gBAAgB73E,OAAOjZ,UAAYgN,IAG1CtM,EAFDsM,EAAO46B,gBACCmL,EAAgBqL,UAAUpxC,IAC1B,WAEA,iBAEK+lC,EAAgBlE,YAAY7hC,IACnC,WAEA,SAGN+qE,EAAS93C,aAAa3f,MAAM5f,KAAOq+J,EAAehnF,EAAS+Y,gBAAgBouE,gBAC3EnnF,EAAS93C,aAAa9O,MAAMzwB,KAAOs+J,EAAejnF,EAAS+Y,gBAAgBquE,gBAC3EpnF,EAAS93C,aAAa6hD,KAAKphF,KAAOu+J,EAAclnF,EAAS+Y,gBAAgBM,gBAGvE,CACL9wE,MAAOy+I,EACP5tI,MAAO6tI,EACPl9E,KAAMm9E,I,+RDmboBG,CAAgC3+J,KAAKuM,WAG1DwqG,aAAavB,GAClB,OAAOx1G,KAAK8lD,QAAQ9lD,KAAKuM,OAAQipG,GAGtBkE,iBAAiBqG,EAAmBS,EAAiBl9C,EAAmBm8C,G,0CACnF,GAAGz/G,KAAK4rD,YAAa,OAErB,MAAMr/C,EAASvM,KAAKuM,OACpBvM,KAAK4rD,aAAc,EACnB5rD,KAAKw6J,gBAAiB,EAEtB,MAAM9rI,EAAa1uB,KAAKyrC,QAAQsoE,gBAEhC/zG,KAAKiQ,SAAQ,GAEb,MAAM08C,EAAiB3sD,KAAK2sD,eAC5BA,EAAeZ,kBAAiB,GAEhC,MAAM6yG,EAAmBz7J,QAAQC,IAAI,CACnCpD,KAAKu2G,OAAOmD,iBAAiBqG,GAC7B//G,KAAKyrC,QAAQiuE,mBACb15G,KAAKD,MAAM25G,iBAAiB+F,MAGvB5W,SAAmB1lG,QAAQC,IAAI,CACpCw7J,EACAjyG,EAAetE,wBAGb35B,MAIJm6E,EAAUz7F,SAAStI,IACjBA,OAGF,yBAAsC6nD,GAEtC3sD,KAAKk9J,gBAAgBvxI,QAAQ7a,GAAQA,IAAQ67C,IAAgBv/C,SAAS0D,GAAQ9Q,KAAKq+J,sBAAsBvtJ,KAEzG9Q,KAAK8zB,IAAI+qI,UAAU,QAAUtyJ,EAAS,IAAMvM,KAAKC,MAEjDD,KAAKo0G,aAAapkG,cAAc,eAAgBzD,OAG3Cs1F,WAAW50F,GAChB,OAAOjN,KAAK2S,SAAS40B,mBAAmB8sF,sBAAsBr0H,KAAKm3G,mBAAoBlqG,GAG5Es6G,aAAat6G,G,0CACxB,OAAOjN,KAAK2S,SAAS40B,mBAAmB+wB,uBAAuBt4D,KAAK6hG,WAAW50F,OAG1E6vG,kBAAkBgiD,GACvB,OAAO9+J,KAAK2S,SAAS40B,mBAAmBm7F,8BAA8B1iI,KAAKuM,OAAQuyJ,OAAiB90J,EAAYhK,KAAK6L,UACpHnK,MAAMq9J,GACE,OAAP,wBACKA,GAA0B,CAC7B/xJ,QAAS,cAA6B+xJ,EAA2BC,uBAKhEzjD,kBACL,OAAOv7G,KAAK88G,oBAAoBp7G,MAAMoqD,GAAmBA,EAAep/C,QAG7DwxJ,YAAY3xJ,G,0CACvB,OAAOA,IAAW,UAAkBA,IAAW,cAA0BvM,KAAK2S,SAAS2/B,gBAAgBg6C,WAAW//E,OAG7G4pF,WAAWxqF,GAChB,GAAI3L,KAAKuM,OAET,GAAG8iB,EAAA,WACGrvB,KAAK0tG,OAGP1tG,KAAK0tG,OAAO7hD,SAASlgD,GAFrB3L,KAAK0tG,OAAS,IAAImtD,GAAW76J,KAAKu2G,OAAQv2G,KAAM2L,OAI7C,CACL,IAAImF,EAAM,UAAuB4pJ,IAC7B5pJ,IACFA,EAAM,aAA0B4pJ,KAGlC5pJ,EAAI3B,KAAKnP,KAAKuM,OAAQvM,KAAK6L,SAAU7L,KAAKyrC,QAAQ8oE,WAAY5oG,IAI3DwtG,QAAQn1D,GACb,OAAOhkD,KAAK2S,SAAS40B,mBAAmByoE,cAAchwG,KAAKuM,OAAQvM,KAAK6L,SAAUm4C,GAG7Ey8D,sBACL,OAAOt9G,QAAQC,IAAI,CACjBpD,KAAK2S,SAAS2/B,gBAAgBuuE,MAAM7gH,KAAKuM,QACzCvM,KAAK2S,SAAS40B,mBAAmB+vB,cAAct3D,KAAKuM,QACpDvM,KAAK88G,mBAAkB,KACtBp7G,MAAK,EAAEm/G,EAAOroF,EAAQszB,KAChB+0D,IAAUroF,IAAWszB,EAAe9+C,QAAQrM,SAIhDs3H,0BACL,MAAO,CACLpsH,SAAU7L,KAAK6L,SACfivH,aAAc96H,KAAKD,MAAM+6H,aACzB5G,aAAcl0H,KAAKD,MAAMm0H,aACzByC,WAAY32H,KAAKD,MAAM42H,WACvB8N,aAAczkI,KAAKD,MAAM0kI,cAItBjgB,aAAan3G,GAClB,OAAOA,EAAQC,SAAW,UAAmBD,EAAQmL,OAAO4F,KAAOpe,KAAKu+D,YAGnEgoD,aAAal5G,GAClB,MAAM2qF,EAAW3qF,EAA4B2qB,SAE7C,OADch4B,KAAKwkH,aAAan3G,MAAc2qF,GAAWh4F,KAAKuM,SAAW,UAIpEu3G,eAAez2G,GACpB,OAAOrN,KAAKssF,aAAetsF,KAAKumH,aAAal5G,I,eEvkBlC,MAAM4xJ,GAcnBr/J,YAAoBw0G,GAAA,KAAAA,aAAAA,EAXZ,KAAAjnE,QAAiD,GAIjD,KAAAq4F,eAAgB,EAChB,KAAA05B,mBAAoB,EAGpB,KAAAC,eAAyB,EAiTzB,KAAAC,gBAAmB/+J,IAIzB,GAFAL,KAAKk/J,mBAAoB,EAEtB,KAAoB,CAErB,GADA7+J,IAAK,EAAA4nB,EAAA,GAAY5nB,GACY,GAA1BL,KAAKm/J,iBAIN,YADAn/J,KAAKs2C,OAFLt2C,KAAKq/J,eAAer/J,KAAKkwG,YAO7BlwG,KAAKkvC,QAxTC7/B,OACNrP,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,iBAAkB,YAAa,QAE5DW,KAAKwnH,QAAU1oH,SAASC,cAAc,OACtCiB,KAAKwnH,QAAQpoH,UAAUC,IAAI,0BAE3B,MAAMigK,EAASxgK,SAASC,cAAc,OAChCwgK,EAASzgK,SAASC,cAAc,OACtCugK,EAAOlgK,UAAUC,IAAI,wBACrBkgK,EAAOngK,UAAUC,IAAI,wBAET,CAAC,OAAQ,SAAU,YAAa,gBAAiB,YAAa,UAAW,QACjF+N,SAAS0J,IACX,MAAMjY,EAAS,EAAWiY,EAAG,CAAC5X,UAAU,IACxCogK,EAAO5/J,OAAOM,KAAKmtC,QAAQr2B,GAAKjY,GAEvB,SAANiY,EACDjY,EAAOuB,iBAAiB,aAAcC,KACpC,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKo0G,aAAahyE,KAAKriC,MAAMwnI,cAAczwH,GAC3C9W,KAAKw/J,sBAOP,QAAiB3gK,GAASwB,KACxB,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKwnI,iBACLxnI,KAAKw/J,wBAKXx/J,KAAKy/J,eAAiB,EAAW,OAAQ,CAACvgK,UAAU,IACpDc,KAAK0/J,UAAY5gK,SAASC,cAAc,UACxC,QAAMiB,KAAK0/J,UAAW,qCAAiC11J,EAAW,eAClEhK,KAAK0/J,UAAUtgK,UAAUC,IAAI,eAC7BW,KAAK0/J,UAAUt/J,iBAAiB,WAAYC,IAC1C,MAAMw9E,GAAS79E,KAAK0/J,UAAUl/J,MAAMG,WAAY,EAAAgqE,GAAA,GAAS3qE,KAAK0/J,UAAUl/J,OAE3D,UAAVH,EAAEwP,MACCguE,EAQF79E,KAAK2/J,UAAUt/J,IAPZL,KAAK0/J,UAAUtgK,UAAUiG,SAAS,WACnCrF,KAAK0/J,UAAUtgK,UAAUkB,OAAO,SAC3BN,KAAK0/J,UAAUv6G,YAGtBnlD,KAAK0/J,UAAUtgK,UAAUC,IAAI,cAOnCW,KAAK0/J,UAAUt/J,iBAAiB,SAAUC,IACxC,MAAMw9E,EAAQ79E,KAAK4/J,cAEnB5/J,KAAK0/J,UAAUtgK,UAAUoE,OAAO,WAAYq6E,GAC5C79E,KAAK0/J,UAAUtgK,UAAUkB,OAAO,YAGlCN,KAAKy/J,eAAer/J,iBAAiB,aAAcC,KAEjD,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKkB,UAAU9B,UAAUkB,OAAO,WAEhCN,KAAKq/J,iBACLr/J,KAAK6/J,qBACL7/J,KAAKw/J,qBAGPx/J,KAAK8/J,gBAAkB,EAAW,kCAAmC,CAAC5gK,UAAU,IAChFc,KAAK8/J,gBAAgB1/J,iBAAiB,aAAcC,IAElDL,KAAK2/J,UAAUt/J,MAGjB,MAAM0/J,EAAWjhK,SAASC,cAAc,OACxCghK,EAAS3gK,UAAUC,IAAI,uCAEvB,MAAM2gK,EAAalhK,SAASC,cAAc,QACpCkhK,EAAanhK,SAASC,cAAc,QACpCmhK,EAAaphK,SAASC,cAAc,QAC1CihK,EAAW5gK,UAAUC,IAAI,4BACzB4gK,EAAW7gK,UAAUC,IAAI,4BACzB6gK,EAAW9gK,UAAUC,IAAI,4BACzBigK,EAAOx7J,aAAak8J,EAAYhgK,KAAKmtC,QAAQ0B,MAC7CkxH,EAASrgK,OAAOwgK,EAAYlgK,KAAK8/J,iBACjCP,EAAO7/J,OAAOM,KAAKy/J,eAAgBQ,EAAYjgK,KAAK0/J,UAAWK,GAG/D//J,KAAKwnH,QAAQ9nH,OAAO4/J,EAAQC,GAC5Bv/J,KAAKkB,UAAUxB,OAAOM,KAAKwnH,SAC3B1oH,SAAS8rC,KAAKlrC,OAAOM,KAAKkB,WAE1B4E,OAAO1F,iBAAiB,UAAU,KAChCJ,KAAKs2C,UAIFkxF,iBACDxnI,KAAKkB,WAAclB,KAAKkB,UAAU9B,UAAUiG,SAAS,eACvDrF,KAAKkvC,OAGP,MAAMrwC,EAASmB,KAAKmtC,QAAQ0B,KAC5B7uC,KAAKkB,UAAU9B,UAAUC,IAAI,WAE7B,MAAMisD,EAAYxsD,SAAS+/D,eAG3B,GAFA7+D,KAAKkwG,WAAa5kD,EAAUwlD,WAAW,GAEpCjyG,EAAOO,UAAUiG,SAAS,UAAW,CACtC,MACMi0B,EADiBt5B,KAAKkwG,WAAW0vB,eACTh8H,cAC9B5D,KAAK0/J,UAAUl/J,MAAQ84B,EAAO48B,UAE9Bl2D,KAAK0/J,UAAUl/J,MAAQ,GAGzBR,KAAK6/J,oBAAmB,GAExBz5J,YAAW,KACTpG,KAAK0/J,UAAUjzJ,UACd,KACHzM,KAAK0/J,UAAUtgK,UAAUoE,OAAO,WAAYxD,KAAK4/J,eAG3CD,UAAUt/J,IAChB,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKq/J,iBACL,IAAI/4I,EAAMtmB,KAAK0/J,UAAUl/J,MACtB8lB,KAAQ,EAAA65I,GAAA,GAAiB75I,KAC1BA,EAAM,WAAaA,GAErBtmB,KAAKo0G,aAAahyE,KAAKriC,MAAMwnI,cAAc,OAAQjhH,GACnDlgB,YAAW,KACTpG,KAAKs2C,SACJ,GAGGspH,cACN,OAAQ5/J,KAAK0/J,UAAUl/J,MAAMG,WAAY,EAAAgqE,GAAA,GAAS3qE,KAAK0/J,UAAUl/J,OAG3D6+J,eAAe/5E,EAAetlF,KAAKkwG,YACzC,MAAM5kD,EAAYxlD,OAAO+4D,eACzBvT,EAAUyT,kBACVzT,EAAUwmF,SAASxsD,GACnBtlF,KAAKo0G,aAAahyE,KAAKriC,MAAMq+G,aAAa3xG,QAGrC6pC,OAGFt2C,KAAKqP,OAERrP,KAAKkB,UAAU9B,UAAUkB,OAAO,cAEhCxB,SAASuH,oBAAoB,UAAWrG,KAAKo/J,iBAC7Cp/J,KAAKk/J,mBAAoB,EAEzB5uJ,EAAA,eAAqC,UAElCtQ,KAAKogK,aAAajyJ,aAAanO,KAAKogK,aACvCpgK,KAAKogK,YAAct6J,OAAOM,YAAW,KACnCpG,KAAKogK,iBAAcp2J,EACnBhK,KAAKkB,UAAU9B,UAAUC,IAAI,QAC7BW,KAAKkB,UAAU9B,UAAUkB,OAAO,aAC/B,MAGE+/J,wBACL,MAAMC,EClNK,WACb,MAAMA,EAAgB,GAChBh1G,EAAYxlD,OAAO+4D,eACzB,IAAI,IAAI9yD,EAAI,EAAGA,EAAIu/C,EAAUslD,aAAc7kG,EAAG,CAC5C,MAAMu5E,EAAQh6B,EAAUwlD,WAAW/kG,GACnC,IAAI,eAAC6zH,EAAc,aAAEC,GAAgBv6C,EAGrC,IAF6B,IAA1Bu6C,EAAaj2B,WAAgBi2B,EAAeA,EAAa10D,YAEtDy0D,GAAkBA,IAAmBC,GACzCygC,EAAMzuJ,KAAiC,IAA5B+tH,EAAeh2B,SAAiBg2B,EAAiBA,EAAez0D,YAC3Ey0D,EAAiBA,EAAe57H,YAG/Bs8J,EAAMA,EAAM3/J,OAAS,KAAOk/H,GAC7BygC,EAAMzuJ,KAAKguH,GAKf,OAAOygC,EAAM30I,QAAQq0G,KAAWA,ID+LhBugC,GACRzqD,EAAU,IAAI,IAAIl3F,IAAI0hJ,EAAM3lJ,KAAKqlH,GAASA,EAAK9wE,eAG/CsxG,EAAmC,IAAI5hJ,IAY7C,OAXCk3F,EAA0B1oG,SAAS4yH,IAClC,IAAI,MAAM//H,KAAQ,KAAc,CAC9B,MAAMwyI,EAAM,KAAaxyI,GACT+/H,EAAKrM,QAAQ8e,EAAI75E,MAAQ,yBAC1B54D,KAAKo0G,aAAahyE,KAAKriC,MAAMq+G,cAC1CoiD,EAAenhK,IAAIW,KAAKmtC,QAAQltC,QAM/B,IAAIugK,GAGN7tB,wBACL,MAAM8tB,EAAgBzgK,KAAKqgK,wBAE3B,IAAI,MAAMt0J,KAAK/L,KAAKmtC,QAAS,CAE3B,MAAMtuC,EAASmB,KAAKmtC,QAAQphC,GAC5BlN,EAAOO,UAAUoE,OAAO,SAAUi9J,EAAcr5J,SAASvI,KAIrDghK,mBAAmBa,GAAe,GACxC,MACMp7E,EADYxmF,SAAS+/D,eACHiyC,WAAW,GAE7B6vD,EAAW7hK,SAAS8rC,KAAKnkC,wBACzBm6J,EAAgBt7E,EAAM7+E,wBACtBo6J,EAAY7gK,KAAKo0G,aAAahyE,KAAKriC,MAAMuqI,YAAY7jI,wBAE3DzG,KAAKkB,UAAU+B,MAAMge,SAAW4/I,EAAUt/J,MAAQ,KAElD,MAEMu/J,EAFcz6D,QAAer8F,EAAWhK,KAAKo0G,aAAahyE,KAAKriC,MAAMq+G,cAAc,EAAOwiD,GAE/Dp6J,KAAKK,KAA8C,EAAhB85J,EAAS95J,IAIvEk6J,GAFe/gK,KAAKkB,UAAU9B,UAAUiG,SAAS,WAAarF,KAAKwnH,QAAQ/iH,iBAAmBzE,KAAKwnH,QAAQz+F,mBAElFtiB,wBACzBI,EAAMi6J,EAAeC,EAAUv/J,OAAS,EAExC+jD,EAAOs7G,EAAUl6J,KACjBy4E,EAAQyhF,EAAUl6J,KAAOk6J,EAAUt/J,MAASoB,KAAKC,IAAIi+J,EAAUt/J,MAAOw/J,EAAUx/J,OACtF,IAAIoF,EACJ,GAAG+5J,EAAc,CACf,MAAM/4D,EAAgB3nG,KAAKkB,UAAUuF,wBACrCE,GAAO,EAAAkd,GAAA,GAAM8jF,EAAchhG,KAAM4+C,EAAM65B,OAClC,CACL,MAAMp4E,EAAI45J,EAAcj6J,MAAQi6J,EAAcr/J,MAAQw/J,EAAUx/J,OAAS,EACzEoF,GAAO,EAAAkd,GAAA,GAAM7c,EAAGu+C,EAAM65B,GAOxBp/E,KAAKkB,UAAU+B,MAAMkzB,UAAY,eAAexvB,QAAWE,UAGtDqoC,OAML,GALGlvC,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGX8+G,KAED,YADAnuH,KAAKs2C,OAQP,QAJwBtsC,IAArBhK,KAAKogK,aACNjyJ,aAAanO,KAAKogK,aAGjBpgK,KAAKkB,UAAU9B,UAAUiG,SAAS,cACnC,OAGFrF,KAAK2yI,wBAEL3yI,KAAKkB,UAAU9B,UAAUkB,OAAO,WAChC,MAAM0gK,EAAchhK,KAAKkB,UAAU9B,UAAUiG,SAAS,QACnD27J,IACDhhK,KAAKkB,UAAU9B,UAAUkB,OAAO,QAChCN,KAAKkB,UAAU9B,UAAUC,IAAI,kBAG/BW,KAAK6/J,qBAEFmB,IACIhhK,KAAKkB,UAAUikD,WACpBnlD,KAAKkB,UAAU9B,UAAUkB,OAAO,kBAGlCN,KAAKkB,UAAU9B,UAAUC,IAAI,cAEzB,GAAA0zF,WACFziF,EAAA,WAAiC,CAC/BrQ,KAAM,SACN0R,MAAO,KACL3R,KAAKs2C,UAmCN2qH,kBACFjhK,KAAKk/J,oBACRl/J,KAAKk/J,mBAAoB,EAIzBpgK,SAASsB,iBAAiB,UAAWJ,KAAKo/J,gBAAiB,CAAC53J,MAAM,KAG7Dg4J,kBACF,OAAuB,GAAAtiG,WACxBp+D,SAASuH,oBAAoB,UAAWrG,KAAKo/J,iBAC7CtgK,SAASsB,iBAAiB,WAAYC,KACpC,EAAA4nB,EAAA,GAAY5nB,GACZL,KAAKm/J,eAAiB,EACtBn/J,KAAKk/J,mBAAoB,EACzBl/J,KAAKihK,oBACJ,CAACz5J,MAAM,KAIP05J,kBACFlhK,KAAKwlI,gBACRxlI,KAAKwlI,eAAgB,EACrB1mI,SAASsB,iBAAiB,mBAAoBC,IAG5C,GAAGvB,SAAS+xG,gBAAkB7wG,KAAK0/J,UACjC,OAGF,MAAMthD,EAAep+G,KAAKo0G,aAAahyE,KAAKriC,MAAMq+G,aAClD,GAAGt/G,SAAS+xG,gBAAkBuN,EAE5B,YADAp+G,KAAKs2C,OAIP,MAAMgV,EAAYxsD,SAAS+/D,eAC3B,GAAGsvD,GAAiB7iE,GAClBtrD,KAAKs2C,YAIP,GAAG,KACD,GAAG,GAAA4mB,SACDl9D,KAAKkvC,OACLlvC,KAAK6/J,yBACA,CACL,GAA2B,IAAxB7/J,KAAKm/J,eAEN,YADAn/J,KAAKm/J,eAAiB,GAIxBn/J,KAAKkwG,WAAa5kD,EAAUwlD,WAAW,GACvC9wG,KAAKihK,uBAOCjhK,KAAKkB,WAAalB,KAAKkB,UAAU9B,UAAUiG,SAAS,cAC5DrF,KAAK6/J,qBACGzhD,EAAa/mG,QAAQ,WAC7BrX,KAAKihK,kBAELjhK,KAAKkvC,YE7Zb,SAASiyH,GAAaC,EAAYC,EAAYC,EAAuBC,EAAsBC,EAAmBx6J,EAAWC,GACvH,MAAO,CAACm6J,EAAI,IAAKC,EAAI,IACbC,EAAe,IACfC,EAAc,IACdC,EAAW,IACXx6J,EAAG,IAAKC,GAAI0c,KAAK,IAGZ,SAAS89I,GAAiBz6J,EAAWC,EAAW1F,EAAeC,EAAgBkgK,EAAYC,EAAYvyB,EAAYwyB,GAChI,MAAMj7H,EAAiB,GAwCvB,OArCAA,EAAK90B,KAAK,KAAO7K,EAAIzF,EAAQ,GAAK,IAAM0F,GAGxC0/B,EAAK90B,KAAK,KAAO7K,EAAIzF,EAAQogK,IAE1BA,EAAK,GAENh7H,EAAK90B,KAAK,IAAMsvJ,GAAaQ,EAAIA,EAAI,EAAG,EAAG,EAAI36J,EAAIzF,EAAS0F,EAAI06J,IAIlEh7H,EAAK90B,KAAK,KAAO5K,EAAIzF,EAAS4tI,IAE3BA,EAAK,GAENzoG,EAAK90B,KAAK,IAAMsvJ,GAAa/xB,EAAIA,EAAI,EAAG,EAAG,EAAIpoI,EAAIzF,EAAQ6tI,EAAMnoI,EAAIzF,IAIvEmlC,EAAK90B,KAAK,KAAO7K,EAAI46J,IAElBA,EAAK,GAENj7H,EAAK90B,KAAK,IAAMsvJ,GAAaS,EAAIA,EAAI,EAAG,EAAG,EAAI56J,EAAI,EAAKC,EAAIzF,EAASogK,IAIvEj7H,EAAK90B,KAAK,KAAO5K,EAAIy6J,IAElBA,EAAK,GAEN/6H,EAAK90B,KAAK,IAAMsvJ,GAAaO,EAAIA,EAAI,EAAG,EAAG,EAAI16J,EAAI06J,EAAMz6J,EAAI,IAI/D0/B,EAAK90B,KAAK,KAEH80B,EAAKhjB,KAAK,KAGnB,sBAAkC89I,GCtDnB,MAAMI,GAMnBjiK,YAAYyzC,EAA+Bz0C,GAmBzC,IAAIkjK,EAnBqC,KAAAljK,QAAAA,EA+C3C,KAAAmjK,WAAc1hK,IACZL,KAAKkB,UAAU9B,UAAUC,IAAI,gBAI/B,KAAA2iK,YAAe3hK,IACbL,KAAKkB,UAAU9B,UAAUkB,OAAO,gBAIlC,KAAA2hK,OAAU5hK,IACRL,KAAKpB,QAAQqjK,OAAO5hK,IAnDpBL,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,OAAQ,aAErCW,KAAKkiK,eAAiBpjK,SAASC,cAAc,OAC7CiB,KAAKkiK,eAAe9iK,UAAUC,IAAI,wBAElCW,KAAK87B,IAAMh9B,SAASs9B,gBAAgB,6BAA8B,OAClEp8B,KAAK87B,IAAI18B,UAAUC,IAAI,gBAEvBW,KAAKomC,KAAOtnC,SAASs9B,gBAAgB,6BAA8B,QACnEp8B,KAAKomC,KAAKhnC,UAAUC,IAAI,qBAGrBT,EAAQK,OACT6iK,EAAWhjK,SAASC,cAAc,OAClC+iK,EAAS1iK,UAAUC,IAAI,YAAa,SAAWT,EAAQK,OAGzD,MAAMkjK,EAAarjK,SAASC,cAAc,OAI1C,IAAIqjK,EAHJD,EAAW/iK,UAAUC,IAAI,eACzB8iK,EAAWziK,QAAO,QAAKd,EAAQgQ,OAAQhQ,EAAQyjK,aAG5CzjK,EAAQ6qC,WACT24H,EAAetjK,SAASC,cAAc,OACtCqjK,EAAahjK,UAAUC,IAAI,iBAC3B+iK,EAAa1iK,QAAO,QAAKd,EAAQ6qC,YAGnCzpC,KAAK87B,IAAIp8B,OAAOM,KAAKomC,MACrBpmC,KAAKkiK,eAAexiK,OAAOM,KAAK87B,KAEhC97B,KAAKkB,UAAUxB,UAAU,CAACM,KAAKkiK,eAAgBJ,EAAUK,EAAYC,GAAcz2I,OAAO6kB,UAC1F6C,EAAS3zC,OAAOM,KAAKkB,WAErBlB,KAAKkB,UAAUd,iBAAiB,WAAYJ,KAAK+hK,YACjD/hK,KAAKkB,UAAUd,iBAAiB,YAAaJ,KAAKgiK,aAClDhiK,KAAKkB,UAAUd,iBAAiB,OAAQJ,KAAKiiK,QAiB/Cj5G,iBACShpD,KAAKpB,QACZoB,KAAKkB,UAAUZ,SACfN,KAAKkB,UAAUmF,oBAAoB,WAAYrG,KAAK+hK,YACpD/hK,KAAKkB,UAAUmF,oBAAoB,YAAarG,KAAKgiK,aACrDhiK,KAAKkB,UAAUmF,oBAAoB,OAAQrG,KAAKiiK,QAGlDK,UACE,MAAM97J,EAAOxG,KAAKkiK,eAAez7J,wBACjCzG,KAAK87B,IAAInV,eAAe,KAAM,sBAAuB,QACrD3mB,KAAK87B,IAAInV,eAAe,KAAM,UAAW,OAAOngB,EAAKjF,SAASiF,EAAKhF,UACnExB,KAAK87B,IAAInV,eAAe,KAAM,QAAS,GAAGngB,EAAKjF,SAC/CvB,KAAK87B,IAAInV,eAAe,KAAM,SAAU,GAAGngB,EAAKhF,UAEhD,MAAM+pB,EAAS,GAKTnY,EAAIquJ,GADEl2I,EAAAA,EAFE/kB,EAAKjF,MAAQgqB,EACb/kB,EAAKhF,OAAS+pB,EAEuBA,EAAQA,EAAQA,EAAQA,GAC3EvrB,KAAKomC,KAAKzf,eAAe,KAAM,IAAKvT,I,eCzFzB,SAASmvJ,GAAkBtoI,GACxCA,EAAS7sB,SAASmE,GAAOA,EAAGnS,UAAUC,IAAI,oBAE1C,WAAYqC,MAAK,KACfu4B,EAAS7sB,SAASmE,GAAOA,EAAGnS,UAAUkB,OAAO,sB,yBCMlC,MAAMkiK,GASnB5iK,YAAYo8H,GACVh8H,KAAKyiK,UAAY,GACjBziK,KAAK0iK,UAAY,EAEjB1iK,KAAK2iK,EAAI3mC,EACTh8H,KAAKurB,OAAS,IAAIna,MAAM4qH,EAAI,GAE5Bh8H,KAAK4iK,WAAa,IAAIxxJ,MAAM4qH,EAAI,GAChCh8H,KAAKk9B,SAAW,IAAI9rB,MAAM4qH,EAAI,GAC9Bh8H,KAAK6iK,MAAQ,IAAIzxJ,MAAM4qH,EAAI,GAE3B,IAAI,IAAIjwH,EAAI,EAAGA,GAAKiwH,EAAGjwH,IACrB/L,KAAK8iK,aAAa9iK,KAAKurB,OAAQxf,GAC/B/L,KAAK8iK,aAAa9iK,KAAK4iK,WAAY72J,GACnC/L,KAAKk9B,SAASnxB,GAAK,EAIf+2J,aAAav3I,EAAgBxf,GACnC,MAAM,UAAC02J,EAAS,UAAEC,EAAS,MAAEG,GAAS7iK,KAEhC+iK,EAASN,EAAYC,EAC3Bn3I,EAAOxf,GAAK22J,EAAY//J,KAAKsiC,SAAW89H,EACxCF,EAAM92J,GAAK,KAAQ,KAAQpJ,KAAKsiC,SAG1B+9H,mBACN,MAAM,OAACz3I,EAAM,WAAEq3I,EAAU,SAAE1lI,EAAQ,EAAEylI,GAAK3iK,KAC1C,IAAI,IAAI+L,EAAI,EAAGA,EAAI42J,EAAG52J,IACpB/L,KAAK8iK,aAAav3I,EAAQxf,GAC1B/L,KAAK8iK,aAAaF,EAAY72J,GAC9BmxB,EAASnxB,GAAK,EAIXssB,OAAO4qI,EAAmBC,GAC/B,MAAM,EAACP,EAAC,SAAEzlI,EAAQ,MAAE2lI,EAAK,OAAEt3I,EAAM,WAAEq3I,GAAc5iK,KACjD,IAAI,IAAI+L,EAAI,EAAGA,GAAK42J,EAAG52J,IACrBmxB,EAASnxB,IArDU,GAqDH82J,EAAM92J,GAAkBk3J,EAAYJ,EAAM92J,GAtDvC,IAsDwDm3J,EACxEhmI,EAASnxB,IAAM,IAChBmxB,EAASnxB,GAAK,EACdwf,EAAOxf,GAAK62J,EAAW72J,GACvB/L,KAAK8iK,aAAaF,EAAY72J,IAK7Bo3J,KAAKx8J,EAAcE,EAAay+B,EAAehP,EAAgBtzB,EAA2BogK,EAAgDC,EAAmBC,GAClK,GAAGtgK,EAAO6P,WAAY,CACpB,MAAM4Y,EAAMzoB,EAAO6P,WAAW,MAI9B4Y,EAAI83I,YACJ93I,EAAI+3I,OAAOl+H,EAAOhP,GAClB7K,EAAIg4I,OAAO98J,EAAM2vB,GAEjB,MAAM,OAAC/K,EAAM,WAAEq3I,EAAU,EAAED,GAAK3iK,KAChC,IAAI,IAAI+L,EAAI,EAAGA,GAAK42J,EAAG52J,IACrB,GAAS,IAANA,EAAS,CACV,MAAMmxB,EAAWl9B,KAAKk9B,SAASnxB,GAEzB9E,GAAKJ,GADA0kB,EAAOxf,IAAM,EAAMmxB,GAAY0lI,EAAW72J,GAAKmxB,IACnComI,EAAmBD,GAAa,EAAMC,GAC7D73I,EAAIg4I,OAAO98J,EAAMM,OACZ,CACL,MAAMi2B,EAAWl9B,KAAKk9B,SAASnxB,EAAI,GAC7B23J,EAAKn4I,EAAOxf,EAAI,IAAM,EAAMmxB,GAAY0lI,EAAW72J,EAAI,GAAKmxB,EAC5DymI,EAAe3jK,KAAKk9B,SAASnxB,GAE7B63J,GAAMt+H,EAAQ3+B,GAAQg8J,GAAK52J,EAAI,GAC/B83J,GAAMv+H,EAAQ3+B,GAAQg8J,EAAI52J,EAC1B+3J,EAAKF,GAAMC,EAAKD,GAAM,EAEtBG,GAAMl9J,EAAM68J,GAAMJ,EAAmBD,GAAa,EAAMC,GACxDU,GAAMn9J,GAND0kB,EAAOxf,IAAM,EAAM43J,GAAgBf,EAAW72J,GAAK43J,IAMtCL,EAAmBD,GAAa,EAAMC,GAC9D73I,EAAIw4I,cAAcH,EAAIC,EAAID,EAAIE,EAAIH,EAAIG,GACnCj4J,IAAM42J,GACPl3I,EAAIg4I,OAAOn+H,EAAOhP,GAMxB8sI,EAAM33I,GACNA,EAAI+oC,OACJ/oC,EAAIy4I,cClGH,MAAMC,GAGXvkK,YAAmBwkK,GAAA,KAAAA,QAAAA,EACjBpkK,KAAKqkK,eAAeD,GAGfC,eAAeD,GACpBpkK,KAAKskK,OAAS,CAAC74I,EAAK9kB,EAAME,EAAKy+B,EAAOhP,KACpC7K,EAAI4wD,UAAY8nF,GAAaI,oBAAoB94I,EAAK24I,EAASz9J,EAAME,EAAKy+B,EAAOhP,IAKrF7S,2BAA2BgI,EAA+BxrB,EAAwBukK,EAAYC,EAAYb,EAAYG,GACpH,MAAM1/G,EAAW54B,EAAIi5I,qBAAqBF,EAAIC,EAAIb,EAAIG,GAgBtD,OAfG9jK,IAAS,mBACVokD,EAASsgH,aAAa,EAAG,WACzBtgH,EAASsgH,aAAa,GAAI,WAC1BtgH,EAASsgH,aAAa,EAAG,YACjB1kK,IAAS,YACjBokD,EAASsgH,aAAa,EAAG,WACzBtgH,EAASsgH,aAAa,EAAG,YACjB1kK,IAAS,UACjBokD,EAASsgH,aAAa,EAAG,WACzBtgH,EAASsgH,aAAa,EAAG,YACjB1kK,IAAS,gBACjBokD,EAASsgH,aAAa,EAAG,WACzBtgH,EAASsgH,aAAa,EAAG,YAGpBtgH,EAGThsB,OAAO72B,EAAgBD,EAAeqjK,EAAY3B,KAKrC,MAAM4B,GAmCnBjlK,cAmEQ,KAAAklK,8BAAiCzkK,IACvCL,KAAK+kK,UACL/kK,KAAKglK,eAGC,KAAAC,aAAe,KAClBjlK,KAAKklK,gBACN/2J,aAAanO,KAAKklK,eAClBllK,KAAKklK,cAAgB,MAGvBllK,KAAKk6G,UAAW,EAChBl6G,KAAKmlK,eACLnlK,KAAKklK,cAAgBp/J,OAAOM,YAAW,KACrCpG,KAAKk6G,UAAW,EAChBl6G,KAAKolK,eACJ,MAWE,KAAAC,YAAc,KACnBrlK,KAAKslK,SAAU,EACftlK,KAAKolK,cAGA,KAAAG,WAAa,KAClBvlK,KAAKslK,SAAU,GAGT,KAAAF,WAAa,KAChBplK,KAAK0J,KAER1J,KAAKmjK,QAGC,KAAAA,KAAO,CAACvrC,GAAQ,KAEtB,GADA53H,KAAK0J,IAAM,MACP1J,KAAKqkE,QACP,OAEF,MAAM,IAACmhG,EAAG,KAAEC,EAAI,KAAEC,EAAI,MAAEx2B,EAAK,KAAEvoI,EAAI,IAAEE,EAAG,MAAEy+B,EAAK,OAAEhP,EAAM,aAAEqvI,EAAY,cAAEC,EAAa,QAAEN,EAAO,SAAEprD,EAAQ,OAAEl3G,GAAUhD,KACnH,IAAIslK,IAAYprD,GAAYl6G,KAAK6lK,iBAAmB,EAClD,OAMF,IAAIjB,EADYl/J,KAAKC,MACD3F,KAAK8lK,eACtBlB,EAAK,KACNA,EAAK,IAIJ5kK,KAAK+lK,qBAAuB/lK,KAAKijK,YAClCjjK,KAAKijK,WAAajjK,KAAKgmK,qBAAuBpB,EAC3C5kK,KAAKgmK,qBAAuB,EAC1BhmK,KAAKijK,UAAYjjK,KAAK+lK,qBACvB/lK,KAAKijK,UAAYjjK,KAAK+lK,oBAGrB/lK,KAAKijK,UAAYjjK,KAAK+lK,qBACvB/lK,KAAKijK,UAAYjjK,KAAK+lK,qBAKzB/lK,KAAK+lK,qBAAuB/lK,KAAKimK,aAClCjmK,KAAKimK,YAAcjmK,KAAKkmK,sBAAwBtB,EAC7C5kK,KAAKkmK,sBAAwB,EAC3BlmK,KAAKimK,WAAajmK,KAAK+lK,qBACxB/lK,KAAKimK,WAAajmK,KAAK+lK,oBAGtB/lK,KAAKimK,WAAajmK,KAAK+lK,qBACxB/lK,KAAKimK,WAAajmK,KAAK+lK,qBAK1BH,IACD5lK,KAAK6lK,iBAAmBjB,EAAK,IAC1B5kK,KAAK6lK,gBAAkB,IACxB7lK,KAAK6lK,gBAAkB,EACvB7lK,KAAK4lK,cAAgB,OAIzB,MAAM,UAAC3C,EAAS,WAAEgD,EAAU,gBAAEJ,GAAmB7lK,KAE3CmmK,EAAO,EAAIF,EAAa/2B,EACxBk3B,EAAO,EAAIH,EAAa/2B,EAElBlsI,EAAO6P,WAAW,MAC1BC,UAAU,EAAG,EAAG9P,EAAOzB,MAAOyB,EAAOxB,QAEzCgkK,EAAI9C,UAAY,EAChB8C,EAAI/C,WAAa,EAAI,EAAIQ,GAAa/zB,EACtCu2B,EAAK/C,UAAY,EACjB+C,EAAKhD,WAAa,EAAI,EAAIQ,GAAa/zB,EACvCw2B,EAAKhD,UAAY,EACjBgD,EAAKjD,WAAa,EAAI,EAAIQ,GAAa/zB,EAEvCs2B,EAAIntI,OAAO4qI,EAAW,IACtBwC,EAAKptI,OAAO4qI,EAAW,IACvByC,EAAKrtI,OAAO4qI,EAAW,IAEvB,IAAI,IAAIl3J,EAAI,EAAGA,EAAI,EAAGA,IAAK,CACzB,GAAS,IAANA,IAAY65J,EACb,SAGF,IAAIl6I,EAAQ,EACR0f,EAAsB,KACjB,IAANr/B,GACD2f,EAAQ,EAAIm6I,EACZz6H,EAAQw6H,IAGRl6I,EAAQk6I,EAAgBC,EAAkB,EAC1CF,EAAattI,OAAO/B,EAASzvB,EAAKy+B,EAAQ3+B,EAAMi+J,EAAI3B,GACpD73H,EAAQu6H,GAIV,MAAMU,EAAU56I,IACdA,EAAI66I,YAAc,GAAM56I,EACxB0f,EAAMk5H,OAAO74I,EAAK9kB,EAAME,EAAKy+B,EAAOhP,IAEhC8sI,EAAS33I,IACbA,EAAI66I,YAAoB,IAANv6J,EAAU,EAAI2f,EAChC0f,EAAMk5H,OAAO74I,EAAK9kB,EAAME,EAAKy+B,EAAOhP,IAGtCmvI,EAAKtC,KAAKx8J,EAAME,EAAMs/J,EAAM7gI,EAAOhP,EAAQtzB,EAAQqjK,EAAQx/J,EAAK,GAChE6+J,EAAKvC,KAAKx8J,EAAME,EAAMu/J,EAAM9gI,EAAOhP,EAAQtzB,EAAQqjK,EAAQx/J,EAAK,GAChE2+J,EAAIrC,KAAKx8J,EAAME,EAAKy+B,EAAOhP,EAAQtzB,EAAQogK,EAAOv8J,EAAK,GAGrD+wH,IACF53H,KAAK0J,IAAMnD,uBAAsB,IAAMvG,KAAKmjK,WAIzC,KAAAoD,gBAAkB,CAACnC,EAA2B/pG,KACnD,MAAM,aAACsrG,EAAY,OAAEa,GAAUxmK,MAE5B2lK,MAAAA,OAAY,EAAZA,EAAcvB,WAAYA,IAI7BpkK,KAAK4lK,cAAgBvrG,EAAWsrG,EAAe,KAC/C3lK,KAAK2lK,aAAea,EAAOh1J,IAAI4yJ,GAC/BpkK,KAAK6lK,gBAAkB7lK,KAAK4lK,cAAgB,EAAM,IAlOlD5lK,KAAKslK,SAAU,EACftlK,KAAKk6G,UAAW,EAChBl6G,KAAK8lK,eAAiBpgK,KAAKC,MAC3B3F,KAAKijK,UAAY,EACjBjjK,KAAKimK,WAAa,EAElBjmK,KAAKwmK,OAAS,IAAIv1J,IAAI,CACpB,CAAC,WAA0B,IAAIkzJ,GAAa,aAC5C,CAAC,SAAwB,IAAIA,GAAa,WAC1C,CAAC,kBAAiC,IAAIA,GAAa,oBACnD,CAAC,cAA6B,IAAIA,GAAa,kBAEjDnkK,KAAK4lK,cAAgB,KACrB5lK,KAAK2lK,aAAe3lK,KAAKwmK,OAAOh1J,IAAI,eACpCxR,KAAK6lK,gBAAkB,EAGlBY,oBACFzmK,KAAKqkE,UAIRrkE,KAAKqkE,SAAU,EAGfv+D,OAAO1F,iBAAiB,SAAUJ,KAAKilK,cACvCjlK,KAAKguB,MAAQloB,OAAO4gK,WAAW,sCAC/B1mK,KAAKguB,MAAM5tB,iBAAiB,SAAUJ,KAAK8kK,+BAE3C9kK,KAAK+kK,UACL/kK,KAAKglK,cAELhlK,KAAKwlK,IAAM,IAAIhD,GAAiB,GAChCxiK,KAAKylK,KAAO,IAAIjD,GAAiB,GACjCxiK,KAAK0lK,KAAO,IAAIlD,GAAiB,GACjCxiK,KAAK2mK,aAAa3mK,KAAKijK,WAEvBjjK,KAAKmjK,QAGAyD,uBACL5mK,KAAKqkE,SAAU,EAGfv+D,OAAOO,oBAAoB,SAAUrG,KAAKilK,cAC1CjlK,KAAKguB,MAAM5tB,iBAAiB,SAAUJ,KAAK8kK,+BAE3C,MAAM,OAAC9hK,GAAUhD,KACLgD,EAAO6P,WAAW,MAC1BC,UAAU,EAAG,EAAG9P,EAAOzB,MAAOyB,EAAOxB,QAGnCujK,UACN/kK,KAAKkvI,MAAQppI,OAAOoa,iBACpBlgB,KAAK6G,IAAM,GAAK7G,KAAKkvI,MACrBlvI,KAAKslC,OAAStlC,KAAKqkE,QAAUrkE,KAAKkB,UAAU20C,YAAc,MAAQ71C,KAAKkvI,MACvElvI,KAAKs2B,QAAUt2B,KAAKqkE,QAAUrkE,KAAKkB,UAAUq5G,aAAe,IAAMv6G,KAAKkvI,MACvElvI,KAAK2G,KAAO,EAAI3G,KAAKkvI,MACrBlvI,KAAK6mK,gBAGCA,gBACN7mK,KAAKgD,OAAOzB,MAAQvB,KAAKslC,MACzBtlC,KAAKgD,OAAOxB,OAASxB,KAAKs2B,OAsBpB6uI,eACNnlK,KAAKkvI,MAAQppI,OAAOoa,iBACpBlgB,KAAKslC,MAAQtlC,KAAKkB,UAAU20C,YAAc71C,KAAKkvI,MAE/ClvI,KAAKglK,cACLhlK,KAAKolK,aA2IAuB,aAAanmK,GAClB,MAAM,UAACyiK,GAAajjK,KACpBA,KAAK+lK,mBAAqBvlK,EAC1BR,KAAKgmK,sBAAwBxlK,EAAQyiK,GAAa,IAClDjjK,KAAKkmK,uBAAyB1lK,EAAQyiK,GAAa,IAG7C+B,cACNhlK,KAAK6mK,gBAGAr2I,OAAO7xB,GACZ,MAAMuC,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DmC,EAAU9B,UAAUC,IAAIV,GAExB,MAAMqE,EAAShD,KAAKgD,OAASlE,SAASC,cAAc,UAKpD,OAJAiE,EAAO5D,UAAUC,IAAIV,EAAY,WAEjCuC,EAAUxB,OAAOsD,GAEV9B,GCvSX,MAAM4lK,GAAmB,IAjClB,MAILlnK,cACEI,KAAK+rB,MAAQ,GAEb,qBAA2B,gBAAgB,KACzC/rB,KAAK+mK,mBAAgB/8J,EACrB,MAAM+hB,EAAQ/rB,KAAK+rB,MACnB/rB,KAAK+rB,MAAQ,GAEb,IAAI,IAAIhgB,KAAKggB,EACX/rB,KAAKgnK,YAAYj7J,MAKhBi7J,YAAYvjK,GACjB,IAAIjD,EAAQR,KAAK+rB,MAAMtoB,GACvB,OAAGjD,IAICR,KAAK+mK,gBACP/mK,KAAK+mK,cAAgBjhK,OAAOC,iBAAiBjH,SAASguD,kBAGxDtsD,EAAQR,KAAK+mK,cAAc/gK,iBAAiB,KAAOvC,GAAM6I,OAClDtM,KAAK+rB,MAAMtoB,GAAQjD,KAK9B,MCRO,MAAMymK,GAKXrnK,YAAmBmf,EAAuBngB,GAAvB,KAAAmgB,KAAAA,GACjB,EAAA/N,EAAA,GAAWhR,KAAMpB,GAGZyD,KAAKyC,GACV,OAAO9E,KAAK+e,KAAKmoJ,SAASlnK,KAAM8E,IAM7B,MAAMqiK,GAYXvnK,YAAmBX,EAAmBL,GAAnB,KAAAK,KAAAA,EACjBe,KAAKsB,UAAW,GAEhB,EAAA0P,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAK+9B,MAAQ/9B,KAAK+9B,MAAMpjB,KAAK/b,GAAYoB,KAAKonK,WAAWxoK,KAGpDuC,O,MACL,IAAIC,EAAcpB,KAAKoB,YACvB,GAAGA,EACD,OAAOA,EAGT,MAAM,UAACF,EAAS,OAAE8B,EAAM,MAAEzB,EAAK,OAAEC,GAAUxB,KAAKf,KA+BhD,OA9BAmC,EAAcykC,GAAA,uBAAkC,CAC9C3kC,UAAAA,EACA8B,OAAAA,EACAzB,MAAAA,EACAC,OAAAA,EACA2+B,MAAO,OACP9+B,MAAM,EACNC,SAAuB,QAAb,EAAAtB,KAAKsB,gBAAQ,SACvB+lK,UAAWrnK,KAAKqnK,UAChBC,6BAA4Ct9J,IAAnBhK,KAAKqnK,UAC9B/+I,MAAOtoB,KAAKsoB,MACZi/I,aAAcvnK,KAAKunK,cAClBvnK,KAAKyD,MAAM/B,MAAM0pF,GACXvlD,GAAA,oBAA+BulD,KACrC1pF,MAAM0pF,IACPprF,KAAKorF,OAASA,EAEXprF,KAAKwnK,iBACNxnK,KAAKwnK,iBACLxnK,KAAKwnK,oBAAiBx9J,GAGrBhK,KAAKynK,gBACNznK,KAAKynK,gBACLznK,KAAKynK,mBAAgBz9J,MAIzBhK,KAAKoB,YAAcA,EACnBpB,KAAKf,KAAK2vB,aAAa3R,IAAIjd,KAAKyD,KAAMrC,GAC/BA,EAGFgmK,WAAWxoK,GAChB,OAAO,IAAIqoK,GAAoBjnK,KAAMpB,GAGhC8oK,QAAQpiJ,GACb,OAAGA,aAAiB2hJ,GAA4B3hJ,EACtB,iBAAZ,EAA6BtlB,KAAK+9B,MAAM3rB,MAAM8lD,GAASA,EAAKz0D,OAAS6hB,IACvEtlB,KAAK+9B,MAAMzY,GAGlB4hJ,SAAShvG,EAA2BpzD,GACzC,OAAO9E,KAAKf,KAAKioK,SAASlnK,KAAMk4D,EAAMpzD,IAI3B,MAAM6iK,GAWnB/nK,YAAYhB,IACV,EAAAoS,EAAA,GAAWhR,KAAMpB,GAEboB,KAAKkB,YAAWlB,KAAKkB,UAAYpC,SAASC,cAAc,QAC5DiB,KAAKkB,UAAU9B,UAAUC,IAAI,gBAE7B,MAAM,MAACkC,EAAK,OAAEC,GAAUxB,KACxBA,KAAKkB,UAAU+B,MAAM1B,MAAQA,EAAQ,KACrCvB,KAAKkB,UAAU+B,MAAMzB,OAASA,EAAS,KAEvC,MAAMwB,EAAShD,KAAKgD,OAASlE,SAASC,cAAc,UACpDiE,EAAO5D,UAAUC,IAAI,WACrB2D,EAAOzB,MAAQA,EACfyB,EAAOxB,OAASA,EAEhBxB,KAAKyc,MAAQ,IAAIxL,IACjBjR,KAAK4uB,aAAe,IAAI3d,IAGf7P,kBACT,OAAO+B,QAAQC,IAAI,IAAIpD,KAAK4uB,aAAaqnB,WAAWv0C,KAAKi8B,GAAA,GAGpDne,QAAQ/b,GACb,OAAQA,GAA4B,IAApBzD,KAAKyc,MAAMzb,KAAgDhB,KAAKyc,MAAMjL,IAAI/N,GAAlDzD,KAAKyc,MAAMw5B,SAASxc,OAAOj5B,MAG9DnB,IAAIT,GACT,MAAMmgB,EAAO,IAAIooJ,GAAgBnnK,KAAMpB,GAGvC,OAFAoB,KAAKyc,MAAMQ,IAAIre,EAAQ6E,KAAMsb,GAEtBA,EAGFmoJ,SAASnoJ,EAAuBuG,EAAkDxgB,GACvF,IAAIia,EAAKqsE,OAKP,YAJArsE,EAAK0oJ,cAAgB,KACnBznK,KAAKknK,SAASnoJ,EAAMuG,EAAOxgB,KAM/B,MAAMozD,EAAOn5C,EAAK2oJ,QAAQpiJ,GAC1BvG,EAAKqsE,OAAO87E,SAAS,CACnB71J,KAAM,iCAAyCrR,KAAK0+H,cAAgBxmE,EAAK0vG,WAAa1vG,EAAK2vG,SAC3FvlI,GAAI41B,EAAK2vG,SACT/iK,SAAAA,IAaG2e,0BAA0B9iB,EAAgBmnK,GAC/C,OAAO,IAAI12J,MAAMzQ,GAAQ6zD,KAAK,GAAG75C,KAAI,CAAC/N,EAAGyR,KACvC,MAAMupJ,EAAavpJ,EAAMypJ,EACzB,MAAO,CAACF,WAAAA,EAAYC,SAAUD,EAAaE,EAAa,OC3LvD,MAAMC,WAMFJ,GAQT/nK,YAAYhB,GAOViB,MAAM,CACJ0B,MAAO3C,EAAQ2C,MACfC,OAAQ5C,EAAQ4C,UAGlB,EAAAwP,EAAA,GAAWhR,KAAMpB,GAWZuC,KAAK6mK,EAAiCC,GAC3C,GAAGjoK,KAAKgwC,OACN,OAAOhwC,KAAKoB,YAGdpB,KAAKgwC,QAAS,EACdhwC,KAAKgoK,UAAYA,EACjBhoK,KAAKioK,WAAaA,EAElB,MAAM/vG,EAAOl4D,KAAK0nK,QAAQM,GACpB1/I,OAAuBte,IAAfi+J,GAA4BjoK,KAAKkoK,UAAYloK,KAAKkoK,SAASD,GAEnElpJ,EAAOm5C,EAAKn5C,KAClBA,EAAKsoJ,UAAYnvG,EAAK2vG,SACtB9oJ,EAAKuJ,MAAQA,EAEb,MAAM7e,EAAW,IAAIzJ,KAAKyc,MAAMw5B,UAAUt7B,KAAKoE,GAASA,EAAK5d,SAC7D,OAAOgC,QAAQC,IAAIqG,GAAU/H,KAAKi8B,GAAA,GAM7B6O,SAASw7H,EAAiCC,EAAoCE,GAC/EnoK,KAAKgwC,QAAQhwC,KAAKmB,KAAK6mK,EAAWC,GAEtC,IAAIG,GAAmB,EAAOC,GAAoB,EAIlD,YAHiBr+J,IAAdg+J,EAAyBI,EAAmBpoK,KAAKsoK,aAAaN,EAAWC,EAAYE,QACjEn+J,IAAfi+J,IAA0BI,EAAoBroK,KAAKuoK,cAAcN,IAElEG,GAAoBC,EAGtBC,aAAal9H,EAA6B68H,EAAoCnjK,GACnF,MAAOkjK,UAAWQ,GAAaxoK,KAC/B,OAAGwoK,IAAcp9H,OACOphC,IAAfi+J,GAA2BjoK,KAAKuoK,cAAcN,SAGrCj+J,IAAfi+J,GACDjoK,KAAKuoK,cAAcN,GAAY,GAGjCjoK,KAAKgoK,UAAY58H,EAEJprC,KAAK0nK,QAAQt8H,EAAOo9H,GAC5BnmK,KAAKyC,IAEH,GAGFyjK,cAAcn9H,EAA8Bq9H,GAAiB,GAClE,MAAOR,WAAYO,GAAaxoK,KAChC,GAAGwoK,IAAcp9H,IAAUprC,KAAKkoK,SAC9B,OAAO,EAGTloK,KAAKioK,WAAa78H,EAElB,MAAMrsB,EAAO/e,KAAKwf,UACZ8I,EAAQtoB,KAAKkoK,SAAS98H,EAAOo9H,GAC7BE,EAAS,KACb3pJ,EAAKqsE,OAAOtN,SAASx1D,EAAOmgJ,IAS9B,OANG1pJ,EAAKqsE,OACNs9E,IAEA3pJ,EAAKyoJ,eAAiBkB,GAGjB,EAGF1/G,UACLhpD,KAAKyc,MAAMrP,SAAS2R,IAClBA,EAAK3d,YAAYM,MAAK,KACpBqd,EAAKqsE,OAAO9qF,gBCtHL,MAAMqoK,WAAgCZ,GAGnDnoK,cACEC,MAAM,CACJ0B,MAAO,GACPC,OAAQ,GACRkmK,QAAS,CAACt8H,EAAOo9H,KACf,MAAMhC,EAASoC,GACf,IAAIC,EACJ,OAAOz9H,GACL,KAAKo7H,EAAOsC,KACVD,EAAWL,IAAchC,EAAOuC,MAAQ,gBAAkB,kBAC1D,MACF,KAAKvC,EAAOuC,MACVF,EAAWL,IAAchC,EAAOsC,KAAO,gBAAkB,OACzD,MACF,KAAKtC,EAAOwC,QACVH,EAAW,SAIf,OAAO7oK,KAAKwf,UAAUkoJ,QAAQmB,MAKlC7oK,KAAKkB,UAAU9B,UAAUC,IAAIV,wCAoD7BqB,KAAKX,IAAI,CACPoE,KAAM,cACNs6B,MApD0C,CAAC,CAC3C6pI,WAAY,EACZC,SAAU,GACVpkK,KAAM,iBACL,CACDmkK,WAAY,GACZC,SAAU,GACVpkK,KAAM,UACL,CACDmkK,WAAY,GACZC,SAAU,GACVpkK,KAAM,QACL,CACDmkK,WAAY,GACZC,SAAU,IACVpkK,KAAM,iBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,mBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,sBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,sBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,qBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,6BACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,wBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,sBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,qB,eC5EG,MAAMwlK,WAAsClB,GAIzDnoK,YAAoBspK,GAClBrpK,MAAM,CACJ0B,MAAO,GACPC,OAAQ,GACRkmK,QAAS,CAACt8H,EAAOo9H,KACf,MAAMhC,EAAS2C,GAEf,IAAI7jJ,EACJ,OAAO8lB,GACL,KAAKo7H,EAAOsC,KACVxjJ,EAAQ,EACR,MACF,KAAKkhJ,EAAOuC,MACVzjJ,EAAQkjJ,IAAchC,EAAOsC,KAAO,EAAI,EACxC,MACF,KAAKtC,EAAOwC,QACV1jJ,EAAQ,EAIZ,OAAOtlB,KAAKwf,UAAUkoJ,QAAQpiJ,IAEhC4iJ,SAAUgB,EAAU,CAAC99H,EAAOo9H,ICuC3B,SAA8Bp9H,GACnC,MAAMo7H,EAAS2C,GACf,IAAI7gJ,EAAqB8gJ,EACzB,OAAOh+H,GACL,KAAKo7H,EAAOsC,KACVM,EAAW,OACX,MACF,KAAK5C,EAAOuC,MACZ,KAAKvC,EAAO6C,aACZ,KAAK7C,EAAO8C,eACVF,EAAWh+H,IAAUo7H,EAAOuC,MAAQ,YAAc,MAClD,MACF,KAAKvC,EAAOwC,QACVI,EAAW,QAIf,MAAMG,EAAgB,eAA6B,MAAQH,EAAW,eAGtE,OAFA9gJ,GAAQ,SAASihJ,GAEVjhJ,ED1DMkhJ,CAAqBp+H,QAC1BphC,IAxBY,KAAAk/J,QAAAA,EA4BlBlpK,KAAKkB,UAAU9B,UAAUC,IAAIV,+CAE7B,MAAMo/B,EAAQ4pI,GAAY8B,mBAAmB,EAAG,IAChDzpK,KAAKX,IAAI,CACPoE,KAAM,kBACNs6B,MAAAA,IAIGyO,SAASpB,GACd,OAAOvrC,MAAM2sC,SCYV,SAAiCpB,GACtC,MAAMo7H,EAAS2C,GACf,OAAO/9H,GACL,KAAKo7H,EAAO8C,eACZ,KAAK9C,EAAO6C,aACV,OAAO7C,EAAOuC,MAChB,QACE,OAAO39H,GDnBas+H,CAAwBt+H,GAAQA,IEtC1D,MAAM,GAAY,gCACH,MAAMu+H,GAGnB/pK,YAAoBgqK,GAAA,KAAAA,UAAAA,EAClB5pK,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,GAAY,cAGpCmtC,SAASpB,EAA2CgK,GACzD,MAAMoxH,EAAS2C,GACT/gH,EAAQpoD,KAAK4pK,UAAUj+I,QAAQ1rB,KAAWm1C,EAAYn1C,KAAO0a,KAAK1a,IACtE,MAAM4pK,EAAgB,UAAkB,iBAAT5pK,EAA0B,kBAAoB,sBACvE8L,EAAIjN,SAASC,cAAc,KAEjC,OADAgN,EAAE3M,UAAUC,IAAI,GAAY,QAAS,GAAY,SAAWY,EAAM4pK,GAC3D99J,KAGT,IAAI+9J,EAAuBC,EAC3B,GAAG3+H,IAAUo7H,EAAO6C,aAClBS,GAAW,QAAK,gCAChBC,EAAkB,gBACb,GAAG3+H,IAAUo7H,EAAOwC,QACzBc,GAAW,QAAK,6BAChBC,EAAkB,mBACb,GAAG3+H,IAAUo7H,EAAOsC,KACzBgB,GAAW,QAAK,+BAChBC,EAAkB,iBACb,IAAG30H,EAAYn7B,QAAUmuC,EAAMznD,OAEpC,YADA,EAAAg4B,EAAA,GAAa34B,KAAKkB,WAAW,EAAA03B,GAAA,GAAcwc,EAAYn7B,QAGvD6vJ,GAAW,QAAK,8BAChBC,EAAkB,eAGpB,MAAMxgK,EAAOzK,SAASC,cAAc,QACpCwK,EAAKnK,UAAUC,IAAI,GAAW0qK,GAC9BxgK,EAAK7J,UAAU0oD,EAAO0hH,IAEtB,EAAAl8J,EAAA,GAAe5N,KAAKkB,UAAWqI,I,2SC9BpB,MAAMygK,WAAkC9uG,GASrDt7D,YAAoBg8J,GAClB/7J,MAAM,CACJq8D,SAAgB9xD,GAAY,gDAAOpK,KAAK47J,SAAShI,uBAAuBxpJ,EAAQoG,KAAK2C,QACrF8oD,SAAW7xD,IACTA,EAAQ+Q,IAAI49B,OAAOz4C,SACnBN,KAAKiqK,iBAAiB7/J,IAExB+xD,SAAgB/xD,GAAY,mCAC1B,MAAMgrC,QAAoBp1C,KAAK47J,SAAShI,uBAAuBxpJ,EAAQoG,IACjE46B,EAAQ8+H,GAAkC90H,GAEhDhrC,EAAQ+/J,UAAU39H,SAASpB,GAC3BhhC,EAAQuO,OAAO6zB,SAASpB,EAAOgK,MAEjComB,OAAQ,CAACpxD,EAASiU,KAChBy8C,GAAuB1wD,EAAQ+Q,IAAI49B,OAAQ/4C,KAAK6K,KAAMwT,IAExD09C,gBAAkBD,IAChB,MAAM,IAAC3gD,GAAO,gBAA+B,CAC3C5O,OAAQuvD,EAAKtrD,GACbtP,WAAW,EACXqM,WAAYvN,KAAKuN,WACjB5C,WAAY3K,KAAK2K,WACjB6C,WAAW,EACX4N,cAAepb,KAAKob,cACpBqT,cAAezuB,KAAKyuB,gBAItBtT,EAAI49B,OAAO35C,UAAUC,IADH,0BAGlB,MAAM8qK,EAAY,IAAIlB,IAA8B,GAC9CtwJ,EAAS,IAAIgxJ,GAAkC,CAAC,eAAgB,UAetE,OAdA,EAAA/7J,EAAA,GAAeuN,EAAIE,gBAAiB1C,EAAOzX,WAC3Cia,EAAI49B,OAAOr5C,OAAOyqK,EAAUjpK,WAC3B46D,EAA2BquG,UAAYA,EACvCruG,EAA2BnjD,OAASA,EASpCmjD,EAA2B3gD,IAAMA,EAE3B2gD,GAETX,kBAAmB,QAjDH,KAAAygG,SAAAA,EALV,KAAAruJ,WAAa,GACb,KAAA6N,eAAgB,EAChB,KAAAzQ,YAAa,EACb,KAAA8xD,sBAA4E,CAAkBizD,WAAY,IAsDlH1vH,KAAK6K,KAAO,kBAAiC7K,KAAKy8D,uBAG7CzT,UACLhpD,KAAKi6B,SAAS7sB,SAAShD,IACrBpK,KAAKiqK,iBAAiB7/J,MAIhB6/J,iBAAiB7/J,GACzBA,EAAQ+/J,UAAUnhH,WCnFP,MAAMohH,WAAsB,IAYzCxqK,cACEC,OAAM,GAqDD,KAAAwqK,aAAe,CAACC,GAAiB,KACtC,GAAGA,EAKD,YAJItqK,KAAKuqK,sBACPvqK,KAAKuqK,oBAAsBzkK,OAAOM,WAAWpG,KAAKqqK,aAAc,OAMpEl8J,aAAanO,KAAKuqK,qBAClBvqK,KAAKuqK,oBAAsB,EAE3B,MAAMC,EAAUxqK,KAAKoK,QAAQhL,UAAUiG,SAAS,iBAChD,IAA2B,IAAxBrF,KAAKyqK,gBACN,GAAIzqK,KAAK0qK,kBAAmB1qK,KAAK0qK,oBAA+BF,GAAWxqK,KAAKyqK,eAC9E,YAEG,IAAID,EACT,OAGFxqK,KAAKgQ,cAAc,kBAAkB,GACrChQ,KAAKoK,QAAQhL,UAAUkB,OAAO,kBAGzB,KAAAqqK,aAAe,CAACL,GAAiB,KACnCtqK,KAAKuqK,qBACNp8J,aAAanO,KAAKuqK,qBAClBvqK,KAAKuqK,oBAAsB,GAClBvqK,KAAKoK,QAAQhL,UAAUiG,SAAS,mBAA4C,IAAxBrF,KAAKyqK,iBAClEzqK,KAAKgQ,cAAc,kBAAkB,GACrChQ,KAAKoK,QAAQhL,UAAUC,IAAI,kBAGzBirK,IAAkBtqK,KAAKyqK,iBAI3BzqK,KAAKuqK,oBAAsBzkK,OAAOM,WAAWpG,KAAKqqK,aAAc,OAG3D,KAAAO,eAAkB17H,IACvB,MAAMs7H,EAAUxqK,KAAKoK,QAAQhL,UAAUiG,SAAS,iBAEhD,QAAY2E,IAATklC,EACEs7H,EAASxqK,KAAKqqK,eACZrqK,KAAK2qK,mBACL,IAAGz7H,IAASs7H,EAAS,QACX,IAATt7H,EAAgBlvC,KAAKqqK,eACxBrqK,KAAK2qK,iBArGV3qK,KAAKuqK,oBAAsB,EAGtBxnB,MAAMnkJ,IAOX,EAAAoS,EAAA,GAAWhR,KAAMpB,GAEjB,MAAM,eAACqK,EAAc,QAAEmB,GAAWpK,KAE/B,KACDiJ,EAAe5J,IAAI+K,EAAnBnB,CAA4B,SAAU5I,IACjCL,KAAK6qK,uBAAwB,EAAAlxI,GAAA,GAAgBt5B,EAAE8G,OAAQnH,KAAK6qK,uBAI/D7qK,KAAK4qK,qBAaP3hK,EAAe5J,IAAI+K,EAAnBnB,CAA4B,aAAa,KACvCjJ,KAAK2qK,kBAGP1hK,EAAe5J,IAAI+K,EAAnBnB,CAA4B,cAAc,KACxCjJ,KAAK2qK,cAAa,MAGpB1hK,EAAe5J,IAAI+K,EAAnBnB,CAA4B,cAAe5I,IACtCA,EAAEyqK,eAAiB9qK,KAAK+qK,yBAA0B,EAAApxI,GAAA,GAAgBt5B,EAAEyqK,cAAe9qK,KAAK+qK,wBACzF/qK,KAAK2qK,cAAa,GAIpB3qK,KAAKqqK,mBAyDJW,aAAa9tJ,GAClBld,KAAKyqK,eAAiBvtJ,EAEtBld,KAAKoK,QAAQhL,UAAUoE,OAAO,iBAA6B,IAAZ0Z,GAC/Cld,KAAK4qK,eAAe1tJ,IC9HT,SAAS+tJ,GAAoBv6I,GAC1C,MAAM1tB,EAASlE,SAASC,cAAc,UACtCiE,EAAO5D,UAAUC,IAAI,mBAErB2D,EAAOzB,MADM,GAEbyB,EAAOxB,OAFM,GAIb,MAAMiqB,EAAMzoB,EAAO6P,WAAW,MAC9B4Y,EAAIE,OAAS,YACb,MAAMu/I,EAAc,KAClBz/I,EAAIG,UAAU8E,EAAO,EAAG,EAAGA,EAAMmR,WAAYnR,EAAM4nG,YAAa,EAAG,EAAGt1H,EAAOzB,MAAOyB,EAAOxB,SAU7F,OAPA,UAAQ,KACN0pK,IACOloK,EAAOqH,eAGhB6gK,IAEOloK,ECVT,MAAM,GAAY,+BAGH,MAAMmoK,GAWnBvrK,YAAoB+S,EAA+BipJ,EAAoC5gC,GAAnE,KAAAroH,SAAAA,EAA+B,KAAAipJ,SAAAA,EAAoC,KAAA5gC,OAAAA,EACrFh7H,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,GAAY,cAEzCW,KAAK63C,KAAO/4C,SAASC,cAAc,OACnCiB,KAAK63C,KAAKz4C,UAAUC,IAAI,GAAY,SAEpCW,KAAK2G,KAAO7H,SAASC,cAAc,OACnCiB,KAAK2G,KAAKvH,UAAUC,IAAI,GAAY,cAEpCW,KAAKslC,MAAQxmC,SAASC,cAAc,OACpCiB,KAAKslC,MAAMlmC,UAAUC,IAAI,GAAY,eAErCW,KAAK63C,KAAKn4C,OAAOM,KAAK2G,KAAM3G,KAAKslC,OAEjCtlC,KAAKkB,UAAUxB,OAAOM,KAAK63C,MAGtBuzH,UAAU5qK,GACf,IAAIA,EAMF,YALGR,KAAK4O,SACN5O,KAAK4O,OAAOtO,SACZN,KAAK4O,YAAS5E,IAIX,GAAGhK,KAAK4O,OACb,OAIA5O,KAAK4O,OAAS9P,SAASC,cAAc,OACrCiB,KAAK4O,OAAOxP,UAAUC,IAAI,GAAY,WAEtC,MAAMJ,EAAOH,SAASC,cAAc,KACpCE,EAAKG,UAAUC,IAAI,sBAAuB,aAC1CW,KAAK4O,OAAOlP,OAAOT,GAEnBe,KAAKkB,UAAUxB,OAAOM,KAAK4O,QAMxBy8J,eAAej2H,EAAmCn1C,EAAqCywB,GAC5F,IAAI6oB,EACDnE,EAAY58B,OAAOgvC,MACpBjO,GAAmB,QAAK,wBACxBA,EAAiBn6C,UAAUC,IAAI,gBAE/BW,KAAKo4B,UAAY,IAAIE,GAAU,CAC7B/rB,QAAQ,EAAAusC,GAAA,GAAU1D,EAAYb,QAGhCgF,EAAmBv5C,KAAKo4B,UAAUhuB,SAGpCpK,KAAKsrK,8BAAgC,IAAIrC,IAA8B,GACvEjpK,KAAKurK,2BAA6B,IAAI5B,GAAkC,CAAC1pK,IAEzED,KAAK2G,KAAKjH,OAAO65C,EAAkBv5C,KAAKurK,2BAA2BrqK,WAEnElB,KAAKslC,MAAM5lC,OAAOM,KAAKsrK,8BAA8BpqK,WAErDwvB,EAAMtxB,UAAUC,IAAI,GAAW,cAE5BqxB,EAAMmG,QACPnG,EAAMruB,OAGR,MAAMW,EAASioK,GAAoBv6I,GACnC1tB,EAAO5D,UAAUC,IAAI,GAAY,SAEjCW,KAAKkB,UAAU2C,QAAQb,EAAQ0tB,GAE/B1wB,KAAKwrK,kBAAkBp2H,GAGlBo2H,kBAAkBp2H,GACvB,MAAMhK,EAAQ8+H,GAAkC90H,GAEhDp1C,KAAKsrK,8BAA8B9+H,SAASpB,GAC5CprC,KAAKurK,2BAA2B/+H,SAASpB,EAAOgK,GAG3C4T,UACLhpD,KAAKsrK,8BAA8BtiH,WCnGxB,MAAMyiH,WAA0CrB,GAS7DxqK,YAAYhB,GAQViB,SACA,EAAAmR,EAAA,GAAWhR,KAAMpB,GAEjB,MACMsC,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DiB,KAAKkB,UAAU9B,UAAUC,IAAIV,2CAE7BC,EAAQy0C,SAAS3zC,OAAOwB,GAExBlB,KAAK0rK,qBAAuB,IAAIz6J,IAChCjR,KAAK8tE,WAAa,IAAI78D,IAEtB,MAAM,eAAChI,GAAkBjJ,KAEzBiJ,EAAe5J,IAAI,IAAnB4J,CAA8B,0BAA0B,EAAE2mJ,YAAAA,EAAax6G,YAAAA,MAClEp1C,KAAK47J,SAASprJ,KAAOo/I,GACtB5vJ,KAAKwrK,kBAAkBp2H,MAI3BnsC,EAAe5J,IAAIW,KAAK47J,SAAxB3yJ,CAAkC,UAAW+xH,IAC3Ch7H,KAAK0rK,qBAAqBt+J,SAASuN,IACjCA,EAAIvN,SAAShD,IACXpK,KAAK2rK,kBAAkBvhK,EAAS4wH,aAKtC,QAAiBh7H,KAAKkB,WAAYb,IAChC,MAAMa,GAAY,EAAAy4B,GAAA,GAAgBt5B,EAAE8G,OAAQ,0CAC5C,IAAIjG,EACF,OAGF,MAAMkJ,EAAUpK,KAAK8tE,WAAWt8D,IAAItQ,GACjClB,KAAK47J,SAASxI,eAAiBhpJ,EAAQ4wH,OAK1Ch7H,KAAK47J,SAASnI,UAAUrpJ,EAAQ4wH,QAJ9Bh7H,KAAK47J,SAASjI,aAKf,CAAC1qJ,eAAAA,IAEJjJ,KAAK4rK,YAAY5rK,KAAK47J,UAEtB57J,KAAK+iJ,MAAM,CACT34I,QAASlJ,EACT+H,eAAgBA,EAChB8hK,uBAAwB,uBAIpBc,qBAAqBzhK,EAA2CgpJ,GACtE,OAAOpzJ,KAAK8rK,eAAiB1Y,GAAgBhpJ,EAAQ4wH,SAAWo4B,EAAeA,GAAgBhpJ,EAAQ4wH,SAAWo4B,EAG5GuY,kBAAkBvhK,EAA2CgpJ,GACnE,MAAM2Y,EAAgB/rK,KAAK6rK,qBAAqBzhK,EAASgpJ,GACzDhpJ,EAAQlJ,UAAU9B,UAAUoE,OAAO,gBAAiBuoK,GAEpD,MAAMC,EAAW5hK,EAAQ4wH,SAAWo4B,EACpChpJ,EAAQghK,UAAUY,GAGZR,kBAAkBp2H,GACxB,MAAM7oC,GAAS,EAAAusC,GAAA,GAAU1D,EAAYb,MAC/Bk6B,EAAyC,CAAC,QAAS,gBACnDw9F,EAAcx9F,EAAM2zB,MAAMniG,KAAWm1C,EAAYn1C,KACvD,IAAIisK,EAAsBlsK,KAAK0rK,qBAAqBl6J,IAAIjF,IACpD0/J,GAAgBC,KAIhBA,GACFlsK,KAAK0rK,qBAAqBzuJ,IAAI1Q,EAAQ2/J,EAAsB,IAAIj7J,KAGlEw9D,EAAMrhE,SAASnN,IACb,IAAImK,EAAU8hK,EAAoB16J,IAAIvR,GACtC,MAAMksK,EAAmB/2H,EAAYn1C,GACrC,KAAKksK,KAAuB/hK,EAA5B,CAQA,GAAG+hK,EAAkB,CACnB,MAAM78J,EAAStP,KAAK47J,SAAS5H,qCAAqC5+G,EAAan1C,GAC/E,IAAIqP,EACF,OAGF,MAAM,MAACohB,EAAK,OAAEsqG,GAAU1rH,EAExBlF,EAAU,IAAI+gK,GAAiCnrK,KAAK2S,SAAU3S,KAAK47J,SAAU5gC,GAE7Eh7H,KAAK8tE,WAAW7wD,IAAI7S,EAAQlJ,UAAWkJ,GAEvCpK,KAAK2rK,kBAAkBvhK,EAASpK,KAAK47J,SAASxI,cAC9C8Y,EAAoBjvJ,IAAIhd,EAAMmK,GAC9BA,EAAQihK,eAAej2H,EAAan1C,EAAMywB,GAE1C1wB,KAAKkB,UAAU2C,QAAQuG,EAAQlJ,gBAE/BgrK,EAAoBx8J,OAAOzP,GAC3BmK,EAAQlJ,UAAUZ,SAEd4rK,EAAoBlrK,OACtBhB,KAAK0rK,qBAAqBh8J,OAAOnD,GACjCvM,KAAK8tE,WAAWp+D,OAAOtF,EAAQlJ,WAC/BkJ,EAAQ4+C,WAIZhpD,KAAKosK,uBAnCAhiK,GACDA,EAAQohK,kBAAkBp2H,OAsC1Bg3H,kBACN,MAAMzrK,EAASX,KAAKkB,UAAU+J,kBAC9BjL,KAAKkB,UAAU0G,QAAQjH,OAAS,GAAKA,EACrCX,KAAKkB,UAAU0G,QAAQ+Z,OAAShhB,GAAU,EAAI,IAAkB,IAAXA,EAAe,IAAM,IAE1EX,KAAKkyF,gBAAkBlyF,KAAKkyF,eAAevxF,GAGhCirK,YAAYhQ,G,4CAChBA,EAAS9qH,cAAc1jC,SAASgoC,IACrCp1C,KAAKwrK,kBAAkBp2H,O,+RAIpB4T,UACLhpD,KAAK8tE,WAAW1gE,SAAShD,IACvBA,EAAQ4+C,c,2SCzIP,MAAMqjH,GAUXzsK,YAAYhB,GA6GJ,KAAA0tK,mBAAqB,KAC3B,MAAMvmD,EAAQ,cAAuBwmD,IAAgB,GAClDxmD,GACDA,EAAMzvE,OAGR,gBAA0B,CAAC/pC,OAAQvM,KAAKwsK,gBAGlC,KAAAC,uBAA0B7rI,IAChC5gC,KAAK47J,SAAS7H,gBAAgB/zJ,KAAKo1C,YAAa,CAC9CxU,MAAAA,KAlHF5gC,KAAKmtC,QAAU,CAAC,CACdluC,KAAM,mBACNQ,KAAM,qBACN0e,OAAQ,IAAMne,KAAK0sK,eAAiB1sK,KAAKo1C,YAAY58B,OAAO66I,gBAC5DrrI,QAAS,IAAMhoB,KAAKysK,wBAAuB,IAC1C,CACDxtK,KAAM,gBACNQ,KAAM,uBACN0e,OAAQ,IAAMne,KAAK0sK,gBAAkB1sK,KAAKo1C,YAAY58B,OAAO66I,gBAC7DrrI,QAAS,IAAMhoB,KAAKysK,wBAAuB,IAC1C,CACDxtK,KAAM,mBACNQ,KAAM,sBACN0e,OAAQ,KAAOne,KAAK0sK,gBAAkB1sK,KAAKo1C,YAAY58B,OAAOm0J,aAC9D3kJ,QAAS,IAAMhoB,KAAKysK,wBAAuB,IAC1C,CACDxtK,KAAM,gBACNQ,KAAM,wBACN0e,OAAQ,KAAOne,KAAK0sK,eAAiB1sK,KAAKo1C,YAAY58B,OAAOm0J,aAC7D3kJ,QAAS,IAAMhoB,KAAKysK,wBAAuB,IAC1C,CACDxtK,KAAM,aACNQ,KAAM,wBACN0e,OAAQ,KAAM,EACd6J,QAAShoB,KAAKssK,oBACb,CACDrtK,KAAM,oBACNQ,KAAM,uBACN0e,OAAQ,IAAMne,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,aACnE2N,QAAS,IAAW,mCAClB+mE,GAAkB,CAChBxiF,OAAQvM,KAAKwsK,aACb19J,MAAO,IAAIwpB,GAAU,CAAC/rB,OAAQvM,KAAKwsK,eAAepiK,QAClDsjC,0BAA0B1tC,KAAK2S,SAASoH,gBAAgBq0B,YAAYpuC,KAAKqa,SAAU,uCAAyC,+BAC5HwzB,oBAAqB,CAAC,IAAIvV,GAAU,CAAC/rB,OAAQvM,KAAKwsK,eAAepiK,SACjEvL,OAAQ,CACN0sC,QAAS,kCACTwO,UAAU,KAEXr4C,MAAK,KACN1B,KAAK2S,SAASoH,gBAAgB6yJ,aAAa5sK,KAAKqa,OAAQra,KAAKwsK,gBAC5D7uI,GAAA,QAIP,MAAM,eAAC10B,GAAkBrK,EACzBoB,KAAK2S,SAAW/T,EAAQ+T,SACxB3S,KAAK47J,SAAWh9J,EAAQg9J,SACxB57J,KAAKqa,OAASra,KAAK47J,SAASvhJ,OAE5Bra,KAAKoK,QAAU,GAAWpK,KAAKmtC,QAASlkC,GACxCjJ,KAAKoK,QAAQhL,UAAUC,IAAI,8BAA+B,SAE1D29D,GAA0Bp+D,EAAQi3H,kBAAwBx1H,GAAW,mCACnE,MAAMwyC,GAAK,EAAAlZ,GAAA,GAAgBt5B,EAAE8G,OAAQ,0BACrC,IAAI0rC,EACF,OAGC7yC,KAAKoK,QAAQxG,gBAAkByvC,GAChCA,EAAS3zC,OAAOM,KAAKoK,UAGvB,EAAA6d,EAAA,GAAY5nB,GAEZ,MAAMkM,EAASvM,KAAKwsK,aAAe35H,EAAGjrC,QAAQ2E,OAAOsO,WACrD7a,KAAKo1C,kBAAoBp1C,KAAK47J,SAAShI,uBAAuBrnJ,GAC3DvM,KAAKo1C,YAAY58B,OAAOgvC,OAI3BxnD,KAAK0sK,oBAAsB1sK,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAKqa,OAAQ,qBAE1Ek2B,GAAYvwC,KAAKmtC,SAAetuC,GAAW,mCAC/C,MAAM89D,QAAa99D,EAAOsf,OAAO5R,GAEjC,OADA1N,EAAOuL,QAAQhL,UAAUoE,OAAO,QAASm5D,GAClCA,OAGTgJ,GAActlE,EAAiBkH,QAAWlH,EAAiBkH,QAAQ,GAAKlH,EAAiBL,KAAKoK,QAAS,SACvG,eAAkCpK,KAAKoK,cACtCnB,GAEHA,EAAe5J,IAAI,IAAnB4J,CAA8B,0BAA0B,EAAE2mJ,YAAAA,EAAax6G,YAAAA,MACrE,GAAGp1C,KAAK47J,SAASprJ,KAAOo/I,EAAa,CACnC,MAAMrjJ,GAAS,EAAAusC,GAAA,GAAU1D,EAAYb,MAClCv0C,KAAKwsK,eAAiBjgK,GACvB,sBAKN,IAAI8mC,EAAwBv0C,SAAS8rC,MACrC,SAAsB9rC,SAAS8rC,MAAM,KACnC,MAAMyqF,GAAS,WACfhiF,EAAWgiF,EAAS,cAAuBk3C,IAAgB,GAAGM,eAAgB/tK,SAAS8rC,KAEnFyqF,GACF,oBAEDpsH,IAmBQ,MAAM6jK,GASnBltK,YAAYhB,IAMV,EAAAoS,EAAA,GAAWhR,KAAMpB,GAEjB,MAAMD,EAAY,0BAEZmN,EAAa,IAAI,UAAW9B,GAClC8B,EAAW5K,UAAU9B,UAAUC,IAAIV,EAAY,eAE/C,MAAMuC,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DmC,EAAU9B,UAAUC,IAAIV,GAIxB,MAAMs1F,EAAaj0F,KAAKi0F,WAAa,IAAI+1E,GAA0BhqK,KAAK47J,WAElE,SAACA,EAAQ,eAAE3yJ,GAAkBjJ,KACnCA,KAAK+4G,YAAc,IAAIszD,GAAgC,OAAD,wBACjDztK,GAAO,CACVi3H,iBAAkB5hC,EAAWppF,KAC7B5B,eAAAA,EACA2yJ,SAAAA,KAGF57J,KAAK+sK,2BAA6B,IAAItB,GAAkC,OAAD,wBAClE7sK,GAAO,CACVy0C,SAAUvnC,EAAW5K,UACrB4qK,eAAe,KAGjBhgK,EAAWpM,OAAqBu0F,EAAWppF,MAC3C3J,EAAUxB,OAAOoM,EAAW5K,WAE5BtC,EAAQy0C,SAAS3zC,OAAOwB,GAExB+H,EAAe5J,IAAI,IAAnB4J,CAA8B,0BAA0B,EAAE2mJ,YAAAA,EAAax6G,YAAAA,MAClEp1C,KAAK47J,SAASprJ,KAAOo/I,GACtB5vJ,KAAKwrK,kBAAkBp2H,MAIF,IAAItF,GAAiB,CAC5ChkC,WAAAA,EACAmkC,WAAY,IACHjwC,KAAK2S,SAAS29I,qBAAqB2G,yBAAyBj3J,KAAK47J,SAASprJ,IAAI9O,MAAK,EAAEovC,aAAAA,EAAcsD,MAAAA,MACxGtD,EAAa1jC,SAASgoC,IACpBp1C,KAAKwrK,kBAAkBp2H,MAGlBhB,OAKbp0C,KAAK4rK,YAAYhQ,GAGX4P,kBAAkBp2H,GACxB,MAAM7oC,GAAS,EAAAusC,GAAA,GAAU1D,EAAYb,MAC/BpC,EAAMnyC,KAAKi0F,WAAW9hD,IAAI5lC,GAC7B6oC,EAAY58B,OAAO7R,KACjBwrC,GACDnyC,KAAKi0F,WAAWvkF,OAAOnD,GAMvB4lC,EAKJnyC,KAAKi0F,WAAW57D,OAAO9rB,GAJrBvM,KAAKi0F,WAAW50F,IAAIkN,GAOXq/J,YAAYhQ,G,iDAiBIA,EAAS9qH,cACvB1jC,SAASgoC,IACpBp1C,KAAKwrK,kBAAkBp2H,SAIpB4T,UACLhpD,KAAKi0F,WAAWjrC,UAChBhpD,KAAK+sK,2BAA2B/jH,WCjRrB,MAAMgkH,GAGnBptK,YAAoByzC,GAAA,KAAAA,SAAAA,EAClBrzC,KAAKitK,gBAAkB,IAAI,iBAAiB,CAC1Cp9J,IAAK,gCAGP7P,KAAKitK,gBAAgB7iK,QAAQhL,UAAUC,IAAI,0BAGtCkqB,SACLvpB,KAAKitK,gBAAgB7iK,QAAQ9J,SAGxB+3B,OAAOujI,GACZ,MAAM,MAACxwH,GAASwwH,EAEhB,IAAI/rJ,EAAkBT,EACnBg8B,IAAU,cACXv7B,EAAM,+BAENA,EAAM,2BACNT,EAAO,CAAEwsJ,EAASjM,UAAkC9+G,qBAGtD,MAAM,gBAACo8H,GAAmBjtK,KAC1BitK,EAAgBl9E,iBAAiB,CAC/BlgF,IAAAA,EACAT,KAAAA,IAGEpP,KAAKitK,gBAAgB7iK,QAAQxG,eAC/B5D,KAAKqzC,SAAS3zC,OAAOM,KAAKitK,gBAAgB7iK,UChCjC,MAAM8iK,GAGnBttK,YAAoByzC,GAAA,KAAAA,SAAAA,EAClBrzC,KAAKo4B,UAAY,IAAIE,GAAU,CAAC/rB,OAAQ,IAGnC8rB,OAAOujI,GACZ,MAAM,UAACxjI,EAAS,SAAEib,GAAYrzC,KACxB2vJ,EAAYiM,EAASjM,UACrBpjJ,EAASqvJ,EAASvhJ,OAAOQ,UAAS,GACrC80I,EAAU7gJ,OACX,EAAA6pB,EAAA,GAAa0a,GAAU,EAAAza,GAAA,GAAc+2H,EAAU7gJ,SAE5CspB,EAAU7rB,SAAWA,IACtB6rB,EAAU7rB,OAASA,EACnB6rB,EAAUC,UAGTD,EAAUhuB,QAAQxG,gBAAkByvC,GACrCA,EAAS3zC,OAAO04B,EAAUhuB,W,eCrBnB,SAAS+iK,GAAWxuK,EAAmBsK,EAAgCrK,GAQpF,MAAMwuK,EAAazuK,EAAY,UACzB0uK,EAAYvuK,SAASC,cAAc,OACzCsuK,EAAUjuK,UAAUC,IAAI+tK,EAAY,cAAe,eAEhDxuK,EAAQK,MACTouK,EAAUjuK,UAAUC,IAAI,SAAWT,EAAQK,MAGzCL,EAAQM,WACV,EAAA2F,GAAA,GAAOwoK,GAGNzuK,EAAQm7C,UACTszH,EAAUjuK,UAAUC,IAAI+tK,EAAa,QAGpCxuK,EAAQ0uK,WACTD,EAAUjuK,UAAUC,IAAI+tK,EAAa,UAGpCxuK,EAAQkG,WACT,QAAiBuoK,EAAWzuK,EAAQkG,SAAU,CAACmE,eAAAA,IAGjD,IAAIk2C,EAAMkuH,EACV,GAAGzuK,EAAQa,KAAM,CACf,MAAM4E,EAAMvF,SAASC,cAAc,OACnCsF,EAAIjF,UAAUC,IAAI+tK,EAAa,aAAc,yBAE7C,MAAMp6G,EAAkC,iBAAlBp0D,EAAY,MAAiB,QAAKA,EAAQa,MAAQb,EAAQa,KAChFuzD,EAAO5zD,UAAUC,IAAI+tK,EAAa,QAAS,oBAE3C/oK,EAAI3E,OAAO2tK,EAAWr6G,GAEtB7T,EAAM96C,EAGR,OAAO86C,EClCT,MAAM,GAAY,kBACZouH,GAAyB,iCAShB,MAAMC,WAAuB,IAgB1C5tK,YAAYhB,GACViB,OAAM,GAYA,KAAAu4J,SAAW,KACjBp4J,KAAKytK,gBACLztK,KAAK0tK,cACL1tK,KAAKqlC,gBAdL,EAAAr0B,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAK6G,IAAM7G,KAAK2G,KAAO3G,KAAKuB,MAAQvB,KAAKwB,OAAS,EAClDxB,KAAKoK,QAAQhL,UAAUC,IAAI,IAE3BW,KAAK2tK,oBACL3tK,KAAK4tK,kBAELv+I,EAAA,mBAA4B,SAAUrvB,KAAKo4J,UAStCyV,kBACL7tK,KAAKoK,QAAQhL,UAAUkB,OAAO,IAE3BN,KAAK8tK,UACN9tK,KAAK8tK,SAAS1gK,SAASjI,IACrBA,EAAQ7E,YAKP0oD,UACL35B,EAAA,sBAA+B,SAAUrvB,KAAKo4J,UAC9Cp4J,KAAKwlD,aAAajvB,kBAGZo3I,oBAEN3tK,KAAK8tK,SADuB,CAAC,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,MAC7CnzJ,KAAK2pB,IACzB,MAAMjgC,EAAMvF,SAASC,cAAc,OAInC,OAHAsF,EAAIuD,QAAQ08B,KAAOA,EACnBjgC,EAAIjF,UAAUC,IAAIkuK,GAAwBA,GAAyB,SAAWjpI,GAC9EtkC,KAAKoK,QAAQ1K,OAAO2E,GACbA,KAIHupK,kBACN,IAAIG,EAAkBC,EAAmBC,EAAoBC,EAAqBC,EAClF,MAAM3oH,EAAexlD,KAAKwlD,aAAe,IAAIpD,GAAa,CACxDh4C,QAASpK,KAAKoK,QACdm5C,QAAS,CAACL,EAAOC,EAAO9iD,KAKtB,GAJA6iD,IAAU,EACVC,IAAU,EAGPgrH,EAAc,CACf,GAAGA,EAAa/mK,SAAS,MAAQ+mK,EAAa/mK,SAAS,KAAM,CAC3D,MAAMgnK,EAAcD,EAAa/mK,SAAS,MAAQ87C,EAAQ,GAAKirH,EAAa/mK,SAAS,MAAQ87C,EAAQ,EAC/FmrH,EAAa1rK,KAAKoE,IAAIm8C,IAAUkrH,EAAc,GAAK,GAEnDE,EAAcH,EAAa/mK,SAAS,KAAO,SAAmB4mK,EAAYC,EAAaD,EAC7FhuK,KAAKuB,MAAQoB,KAAKC,IAAI0rK,EAAaL,EAAaI,GAGlD,GAAGF,EAAa/mK,SAAS,MAAQ+mK,EAAa/mK,SAAS,KAAM,CAC3D,MAAMgnK,EAAcD,EAAa/mK,SAAS,MAAQ+7C,EAAQ,GAAKgrH,EAAa/mK,SAAS,MAAQ+7C,EAAQ,EAC/FkrH,EAAa1rK,KAAKoE,IAAIo8C,IAAUirH,EAAc,GAAK,GAEnDE,EAAcH,EAAa/mK,SAAS,KAAO,UAAoB2mK,EAAWG,EAAcH,EAC9F/tK,KAAKwB,OAASmB,KAAKC,IAAI0rK,EAAaJ,EAAcG,GAGpDruK,KAAKytK,gBAEFU,EAAa/mK,SAAS,OACvBpH,KAAK2G,KAAOhE,KAAKC,IAAIorK,EAAYC,EAAajuK,KAAKkhB,SAAU8sJ,EAAY9qH,IAGxEirH,EAAa/mK,SAAS,OACvBpH,KAAK6G,IAAMlE,KAAKC,IAAImrK,EAAWG,EAAcluK,KAAKmuD,UAAW4/G,EAAW5qH,SAG1EnjD,KAAK6G,IAAMknK,EAAW5qH,EACtBnjD,KAAK2G,KAAOqnK,EAAY9qH,EAG1BljD,KAAK0tK,cACL1tK,KAAKqlC,eAEP0d,kBAAoB1iD,IAClB,MAAM8G,EAAS9G,EAAE8G,OACjB,GAAGnH,KAAK+iD,oBAAsB/iD,KAAK+iD,kBAAkB1iD,GACnD,OAAO,EAGT,MAAM6kK,GAAgB,EAAAvrI,GAAA,GAAgBxyB,EAAQomK,IAS9C,OARGrI,GACDiJ,EAAejJ,EAAct9J,QAAQ08B,KACrCkhB,EAAahC,UAAU,MAEvB2qH,OAAenkK,EACfw7C,EAAahC,UAAU,cAGlB,GAETH,aAAc,KACZ0qH,EAAW/tK,KAAK6G,IAChBmnK,EAAYhuK,KAAK2G,KACjBsnK,EAAajuK,KAAKuB,MAClB2sK,EAAcluK,KAAKwB,UAKlB+sK,sBACLvuK,KAAK6G,IAAO,UAAoB,EAAM7G,KAAKwB,OAAS,EACpDxB,KAAK2G,KAAQ,SAAmB,EAAM3G,KAAKuB,MAAQ,EACnDvB,KAAKqlC,cAGCooI,gBACNztK,KAAKuB,OAAQ,EAAAsiB,GAAA,GAAM7jB,KAAKuB,MAAOvB,KAAKkhB,SAAU,UAC9ClhB,KAAKwB,QAAS,EAAAqiB,GAAA,GAAM7jB,KAAKwB,OAAQxB,KAAKmuD,UAAW,WAG3Cu/G,cACN1tK,KAAK6G,KAAM,EAAAgd,GAAA,GAAM7jB,KAAK6G,IAAK,EAAG,UAAoB7G,KAAKwB,QACvDxB,KAAK2G,MAAO,EAAAkd,GAAA,GAAM7jB,KAAK2G,KAAM,EAAG,SAAmB3G,KAAKuB,OAGlD8jC,cACNrlC,KAAKoK,QAAQnH,MAAM4D,IAAM7G,KAAK6G,IAAM,KACpC7G,KAAKoK,QAAQnH,MAAM0D,KAAO3G,KAAK2G,KAAO,KACtC3G,KAAKoK,QAAQnH,MAAMqiC,MAAQ,OAC3BtlC,KAAKoK,QAAQnH,MAAMqzB,OAAS,OAC5Bt2B,KAAKoK,QAAQnH,MAAM1B,MAAQvB,KAAKuB,MAAQ,KACxCvB,KAAKoK,QAAQnH,MAAMzB,OAASxB,KAAKwB,OAAS,KAE1CxB,KAAKgQ,cAAc,UAGVzO,YACT,OAAOvB,KAAK04E,OAGHl3E,aACT,OAAOxB,KAAK24E,QAGFp3E,UAAMf,GAChBR,KAAK04E,OAASl4E,EAGJgB,WAAOhB,GACjBR,KAAK24E,QAAUn4E,EAGN4qC,YACT,MAAM,IAACvkC,EAAG,KAAEF,EAAI,MAAEpF,EAAK,OAAEC,GAAUxB,KACnC,MAAO,CACL6G,IAAAA,EACAF,KAAAA,EACApF,MAAAA,EACAC,OAAAA,GAIO4pC,UAAMA,GACf,MAAM,IAACvkC,EAAG,KAAEF,EAAI,MAAEpF,EAAK,OAAEC,GAAU4pC,EACnCprC,KAAK6G,IAAMA,EACX7G,KAAK2G,KAAOA,EACZ3G,KAAKuB,MAAQA,EACbvB,KAAKwB,OAASA,EACdxB,KAAKo4J,Y,kXCjNM,MAAMoW,GAOnB5uK,YAAYhB,GANZ,qBAYE,EAAAoS,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAKyuK,eAAe,MAEpBzuK,KAAKiJ,eAAe5J,IAAIgwB,EAAA,EAAxBrvB,CAAoC,gBAAgB,CAACqR,EAAMixB,KACtDA,IAAO,YAAqBjxB,IAAS,YACtCrR,KAAKyuK,eAAe,SAKnBzlH,UACL,MAAM0lH,EAAU1uK,KAAK0uK,QAClBA,GACDA,EAAQ1lH,UAID0lH,cACT,O,uSAAO,CAAA1uK,KAAI,QAGForC,YACT,OAAOprC,KAAK0uK,QAAU1uK,KAAK0uK,QAAQtjI,MAAQprC,KAAK4lK,cAGvCx6H,UAAMA,GACfprC,KAAK4lK,cAAgBx6H,EAGfqjI,cAActwH,GACpB,IAAI,QAACuwH,GAAW1uK,KAChB,GAAGm+C,EAAS,CACV,GAAGuwH,EACD,OAGFA,EAAU,GAAA1uK,KAAI,GAAY,IAAIwtK,GAAextK,KAAK2uK,gBAAe,KAEjED,EAAQtjI,MAAQprC,KAAK4lK,mBACS57J,IAA3BhK,KAAK4lK,cAAc/+J,KACpB6nK,EAAQH,sBAGPvuK,KAAKo4J,UACNp4J,KAAKiJ,eAAe5J,IAAIqvK,EAAxB1uK,CAAiC,SAAUA,KAAKo4J,cAE7C,CACL,IAAIsW,EACF,OAGF1uK,KAAK4lK,cAAgB8I,EAAQtjI,MAC7BsjI,EAAQb,kBACRa,EAAQ1lH,UACR,GAAAhpD,KAAI,QAAYgK,EAAS,OC1EhB,SAAS4kK,GAAgBjwK,EAAmBs7B,EAAyB83C,GAKlF,OAJA93C,EAAS7sB,SAAShD,IAChBA,EAAQhL,UAAUoE,OAAO7E,EAAWozE,MAG/B,IAAM68F,GAAgBjwK,EAAWs7B,GAAW83C,G,mBb8BzCo3F,GAyDAP,GA/CL,SAASsB,GAAkC90H,GAChD,MAAMoxH,EAAS2C,GACf,OAAG/zH,EAAY58B,OAAOm0J,aACbnG,EAAO6C,kBAC4Br/J,IAAlCorC,EAAYugH,kBACb6Q,EAAOsC,KACN1zH,EAAY58B,OAAOooB,MACpBwU,EAAY58B,OAAO66I,gBAAkBmT,EAAOuC,MAAQvC,EAAO8C,eAE3D9C,EAAOwC,SAnBlB,SAAYG,GACV,yBACA,qBACA,mCACA,uCACA,mBALF,CAAYA,KAAAA,GAAkC,KAyD9C,SAAYP,GACV,mBACA,qBACA,yBAHF,CAAYA,KAAAA,GAAkC,KAiB9C,IAAIhD,GAA8B,CAChCrkK,MAAO,IACPC,OAAQ,KAGV,MAAM,GAAY,aAEH,MAAM+qK,WAAuB,IAmB1C3sK,cACEC,MAAM,wBAAoBmK,EAAW,CACnC4gC,MAAM,EACNikI,gBAAgB,EAChBz4H,UAAU,IA2LN,KAAA04H,kBAAoB,MAC1B,SAAkB9uK,KAAKkB,YAGjB,KAAA6tK,iBAAoB7/H,IAC1BlvC,KAAKkB,UAAU9B,UAAUoE,OAAO,gBAAiB0rC,GACjDlvC,KAAKgvK,iBAAiB5vK,UAAUoE,OAAO,gBAAiB0rC,IAGlD,KAAAH,iBAAmB6/H,GAAgB1lK,KAAK,KAAM,gBAE9C,KAAA+lK,aAAe,KACrB,MAAMzrK,EAASxD,KAAK+uC,iBAAiB,CAAC/uC,KAAKkvK,WAAW,GACtDlvK,KAAK47J,SAASvG,qBAAqBnqI,SAAQ,KACzC1nB,QAII,KAAA2rK,cAAgB,KACtB,MAAM3rK,EAASxD,KAAK+uC,iBAAiB,CAAC/uC,KAAKovK,YAAY,GACvDpvK,KAAK47J,SAAS9G,sBAAsB5pI,SAAQ,KAC1C1nB,QAII,KAAA0zI,YAAc,KACpB,MAAM9hG,EAAcp1C,KAAK47J,SAASxmH,YAC9BA,EAAY58B,OAAO66I,gBAKrBrzJ,KAAK47J,SAAS/H,mBAJuB7pJ,IAAlCorC,EAAYugH,mBACb31J,KAAK47J,SAASxH,iBAAgB,IAO5B,KAAAib,aAAe,KAAW,O,EAAA,K,OAAA,E,EAAA,YAChC,MAAM/Z,EAAUC,IACdv1J,KAAK47J,SAAStG,OAAOC,WAGdv1J,KAAK2S,SAASoH,gBAAgB06B,UAAUz0C,KAAK47J,SAASvhJ,OAAQ,gBACrE,IAAI6yB,GAAU,uBAAwB,CACpClD,aAAc,sBACd0D,mBAAoB,qBACpBI,WAAY,CAAC,CACXruC,KAAM,wBAER0tC,QAAS,CAAC,CACR5B,QAAS,mBACTzmC,SAAWgpC,IACTwnH,IAASxnH,EAAW9sC,OAEtB+4C,UAAU,MAEX7K,OAEHomH,GAAO,I,YArBuB,K,+QA6B1B,KAAAga,mBAAqB,KAC3BtvK,KAAKuvK,kBACL,MAAMl6C,GAAS,YAET,cAACm6C,EAAa,kBAAEC,GAAqBzvK,KAErC0vK,EAAgB1vK,KAAKkB,UAAU9B,UAAUiG,SAAS,kBACxDrF,KAAKkB,UAAU9B,UAAUoE,OAAO,iBAAkB6xH,GAClDm6C,GAAiBA,EAAcpwK,UAAUoE,OAAO,OAAQ6xH,GACxDo6C,GAAqBA,EAAkBrwK,UAAUoE,OAAO,QAAS6xH,GACjEr1H,KAAKkvH,SAAS9vH,UAAUoE,OAAO,OAAQ6xH,GAEpCA,IAAWq6C,IACZ9tI,EAAA,kBAAqCyzF,GAErC/0C,GAAA,gBAA8B+0C,EAAS,eAAYrrH,KAI/C,KAAAulK,gBAAkB,K,MACxB,MAAMl6C,GAAS,WACTq5C,EAA2B,QAAjB,EAAA1uK,KAAK2vK,oBAAY,eAAEjB,QAC7B7tH,GAASw0E,MAAaq5C,GAAWA,EAAQntK,OAAS,SAAWvB,KAAK4vK,YAOlEC,EAAS7vK,KAAKkB,UAAU9B,UAAUiG,SAAS,iBACjD,IAAI8nC,EACD0T,IAAUgvH,IACX1iI,EAAU/7B,MAAMC,KAAKrR,KAAKgvK,iBAAiBlpJ,UAC3CqnB,EAAQ//B,SAAShD,IACfA,EAAQnH,MAAM0gE,QAAU,OAGrB3jE,KAAKgvK,iBAAiB7pH,YAG7BnlD,KAAKkB,UAAU9B,UAAUoE,OAAO,gBAAiBq9C,GACjD7gD,KAAK8vK,UAAU1wK,UAAUoE,OAAO,OAAQq9C,GACxC7gD,KAAK+vK,cAAc3wK,UAAUoE,OAAO,QAASq9C,GAE1C1T,GAECA,EAAQ//B,SAAShD,IACfA,EAAQnH,MAAM0gE,QAAU,OAMxB,KAAAqsG,kBAAoB,KAC1BhwK,KAAKkB,UAAU9B,UAAUoE,OAAO,0BA/ShCxD,KAAK4vK,YAAc,EACnB5vK,KAAKkB,UAAU9B,UAAUC,IAAI,GAAW,SAExC,MAAMu8J,EAAW57J,KAAK47J,SAAW,GAAAjM,WAC3B,eAAC1mJ,GAAkBjJ,KAEzB,IAAI,GAAAwwG,gBAAiB,CACnB,MAAMg/D,EAAgBxvK,KAAKwvK,cAAgB,EAAW,cAChDS,EAAiBjwK,KAAKiwK,eAAiB,EAAW,6BAClDR,EAAoBzvK,KAAKyvK,kBAAoB,EAAW,gBAE9D,QAAiBD,EAAexvK,KAAK8uK,kBAAmB,CAAC7lK,eAAAA,KACzD,QAAiBgnK,EAAgBjwK,KAAK8uK,kBAAmB,CAAC7lK,eAAAA,KAE1D,QAAiBwmK,GAAmB,MAClC,aACC,CAACxmK,eAAAA,KAEJ,SAAsBjJ,KAAKkB,UAAWlB,KAAKsvK,mBAAoBrmK,GAG/CjJ,KAAK8vK,UAAY,EAAW,WAA9C,MACMC,EAAgB/vK,KAAK+vK,cAAgB,EAAW,mCAEtD,QAAiBA,EAAe/vK,KAAKgwK,kBAAmB,CAAC/mK,eAAAA,IAEzD,MAAMinK,EAAapxK,SAASC,cAAc,OAC1CmxK,EAAW9wK,UAAUC,IAAI,0BAEzBW,KAAK8O,MAAM1P,UAAUC,IAAI,2BAEzB,MAAMoqC,EAAW3qC,SAASC,cAAc,OACxC0qC,EAASrqC,UAAUC,IAAI,8BAEvB6wK,EAAWxwK,OAAOM,KAAK8O,MAAO26B,GAE9BzpC,KAAK4O,OAAOxP,UAAUC,IAAI,qBAC1BW,KAAK4O,OAAOlP,UAAU,CAACM,KAAKyvK,kBAAmBS,EAA6BlwK,KAAKwvK,cAAeO,GAAepkJ,OAAO6kB,UAEtH,MAAM2/H,EAAYnwK,KAAK4O,OAAO7K,WAAU,GAClCqsK,EAAgBF,EAAWnsK,WAAU,GACrCssK,EAAiBrwK,KAAK8O,MAAM/K,WAAU,GAE5CqsK,EAAc1wK,OAAO2wK,GAErB,MAAMC,EAAgB,EAAW,cACjCH,EAAUzwK,UAAU,CAAC4wK,EAAeF,EAAepwK,KAAKiwK,gBAAgBtkJ,OAAO6kB,WAE/E,QAAiB8/H,EAAetwK,KAAKgwK,kBAAmB,CAAC/mK,eAAAA,IAEzDjJ,KAAK4qC,KAAK/mC,QAAQssK,GAElB,MAAMI,EAAmB,IAAI,UAAWvmK,GACxCumK,EAAiBrvK,UAAU9B,UAAUC,IAAI,kCACzCW,KAAKkB,UAAUxB,OAAO6wK,EAAiBrvK,WAEvClB,KAAKwwK,eAAiB,IAAItD,GAAsBltK,KAAK8O,OACrD9O,KAAKywK,qBAAuB,IAAIzD,GAA4BvjI,GAC5DzpC,KAAK0wK,+BAAiC,IAAI1D,GAA4BqD,GACtErwK,KAAK2wK,mBAEL3wK,KAAK+sK,2BAA6B,IAAItB,GAAkC,CACtEp4H,SAAUk9H,EAAiBrvK,UAC3B06J,SAAAA,EACA3yJ,eAAAA,EACA6iK,eAAe,EACf55E,eAAiBvxF,IACfX,KAAK4vK,YAAcjvK,EACnBX,KAAKuvK,mBAEP58J,SAAU3S,KAAK2S,WAEjB3S,KAAK4wK,sBAAwB,IAAI9D,GAA6B,CAC5Dz5H,SAAUrzC,KAAK4qC,KACfgxH,SAAAA,EACA3yJ,eAAAA,EACA0J,SAAU3S,KAAK2S,WAGjB3S,KAAK2vK,aAAe,IAAInB,GAAa,CACnCvlK,eAAAA,EACA0lK,eAAgB,CACdztJ,SAAU,IACVitC,UAAW,IACX/jD,QAASpK,KAAKoK,QACd24C,kBAAoB1iD,IAClB,MAAM8G,EAAS9G,EAAE8G,OACjB,SAAG,EAAAwyB,GAAA,GAAgBxyB,EAAQ,cACzB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,uBACxB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,cACxB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,6CACxB,cAONixJ,SAAU,IAAMp4J,KAAKuvK,kBACrB3J,cAAAA,KAGF38J,EAAe5J,IAAIu8J,EAAnB3yJ,CAA6B,SAAS,KACpCjJ,KAAK6wK,oBAGP5nK,EAAe5J,IAAI,IAAnB4J,CAA8B,qBAAsB0mJ,I,OAClC,QAAb,EAAA3vJ,KAAK47J,gBAAQ,eAAEprJ,MAAOm/I,EAAUn/I,IACjCxQ,KAAK6wK,oBAIT5nK,EAAe5J,IAAIu8J,EAAnB3yJ,CAA6B,UAAU,KACrCjJ,KAAK8wK,kBAGP7nK,EAAe5J,IAAIW,KAAK+sK,2BAAxB9jK,CAAoD,iBAAkBjJ,KAAK+uK,kBAE3E/uK,KAAKI,iBAAiB,SAAS,KAC7B,MAAM,aAACuvK,GAAgB3vK,KACvB4lK,GAAgB+J,EAAavkI,MAE7BprC,KAAK+sK,2BAA2B/jH,UAChChpD,KAAK4wK,sBAAsB5nH,UAC3BhpD,KAAK+wK,wBAAwB/nH,UAE7B2mH,EAAa3mH,aAGfhpD,KAAKgwK,oBACLhwK,KAAKsvK,qBAELtvK,KAAK6wK,iBAGCF,mBACN,MAAMxjI,EAAUntC,KAAKgvK,iBAAmBlwK,SAASC,cAAc,OAC/DouC,EAAQ/tC,UAAUC,IAAI,sBAEtB,MAAM2xK,EAAc7D,GAAWjkK,KAAK,KAAM,GAAWlJ,KAAKiJ,gBAEpDimK,EAAWlvK,KAAKkvK,SAAW8B,EAAY,CAE3ClsK,SAAU9E,KAAKivK,aACfhwK,KAAM,uBAGFmwK,EAAYpvK,KAAKovK,UAAY4B,EAAY,CAE7ClsK,SAAU9E,KAAKmvK,cACflwK,KAAM,uBAGRmwK,EAAUhwK,UAAUoE,OAAO,QAAS,MAEpC,MAAM21J,EAAU6X,EAAY,CAC1B9xK,UAAU,EACV4F,UAAU,EAAAwiC,GAAA,GAAStnC,KAAKk3I,YAAa,KAAK,KAE5CiiB,EAAQ/5J,UAAUC,IAAI,gCAEtB,MAAM4xK,EAAiBjxK,KAAK+wK,wBAA0B,IAAIpI,GAC1DxP,EAAQz5J,OAAOuxK,EAAe/vK,WAE9B,MAAMs2J,EAAUwZ,EAAY,CAE1B/xK,KAAM,oBAGRu4J,EAAQp4J,UAAUC,IAAI,gBACtBm4J,EAAQp4J,UAAUoE,OAAO,QAAS,MAElC,MAAM0tK,EAAWF,EAAY,CAE3Bj3H,UAAU,EACVj1C,SAAU9E,KAAKqvK,aACfpwK,KAAM,UAGRkuC,EAAQztC,OAAOwvK,EAAUE,EAAWjW,EAAS3B,EAAS0Z,GAEtDlxK,KAAKkB,UAAUxB,OAAOytC,GAgEjB0/H,eACL,OAAO7sK,KAAKkB,UA4DN4vK,eACN9wK,KAAKkB,UAAU9B,UAAUoE,OAAO,eAAgBxD,KAAK47J,SAASxI,cAGxDyd,iBACN,GAAG7wK,KAAK47J,SAASxwH,QAAU,UAMzB,OALGprC,KAAKkB,UAAU9B,UAAUiG,SAAS,oBACnC,gBAGFrF,KAAKs2C,OAIP,MAAM,YAAClB,EAAW,UAAEu6G,GAAa3vJ,KAAK47J,SACtC,IAAIxmH,EACF,OAGFp1C,KAAK4P,WACL5P,KAAKmxK,iBACLnxK,KAAK8wK,eAEL,MAAMM,EArXH,SAA2CzhB,EAAgCv6G,GAChF,MAAMoxH,EAASoC,GACf,OAAIxzH,EAAY58B,OAAO66I,gBAEbj+G,EAAY58B,OAAOooB,MACpB4lI,EAAOuC,MAEPvC,EAAOwC,QAJPxC,EAAOsC,KAkXgBuI,CAAkC1hB,EAAkBv6G,GAClFp1C,KAAKkB,UAAU0G,QAAQ0pK,SAAWF,IAA0BxI,GAAmCE,KAAO,OAAUsI,IAA0BxI,GAAmCG,MAAQ,QAAU,UAC/L/oK,KAAK+wK,wBAAwBvkI,SAAS4kI,GAGhCxhK,WACN5P,KAAKwwK,eAAen4I,OAAOr4B,KAAK47J,UAG1BuV,iBACNnxK,KAAKywK,qBAAqBp4I,OAAOr4B,KAAK47J,UACtC57J,KAAK0wK,+BAA+Br4I,OAAOr4B,KAAK47J,WclepD,IAAK2V,IAAL,SAAKA,GACH,6BACA,+BACA,yCACA,yBACA,+BACA,yBACA,uBAPF,CAAKA,KAAAA,GAAU,KAUf,YCLe,MAAMC,GAKnB5xK,YAAoByzC,GAAA,KAAAA,SAAAA,EAClBrzC,KAAKkB,UAAYpC,SAASC,cAAc,OACxCiB,KAAKkB,UAAU9B,UAAUC,IAAI,oBAGxBkqB,cACgBvf,IAAlBhK,KAAKwlJ,WACNv8F,cAAcjpD,KAAKwlJ,UACnBxlJ,KAAKwlJ,cAAWx7I,GAGlBhK,KAAKkB,UAAUZ,SACfN,KAAKorC,WAAQphC,EAGRquB,OAAOujI,GACZ,MAAM,gBAACvQ,GAAmBuQ,EAE1B,GAAG57J,KAAKorC,QAAUigH,EAChB,OAKF,IAAIjhJ,EACJ,GAHApK,KAAKorC,MAAQigH,EAGVA,IAAoB,aAAsB,CAC3CjhJ,EAAUtL,SAASC,cAAc,QACjCqL,EAAQhL,UAAUC,IAAI,6BAEtB,MAAM+X,EAAU,KACdhN,EAAQ60B,UAAY9N,GAASyqI,EAAS/1J,UAAU,IAGlD7F,KAAKwlJ,SAAW1/I,OAAO8hD,YAAYxwC,EAAS,KAC5CA,QACK,CACL,IAAIy0B,EACJ,OAAOw/G,GACL,KAAK,WACHx/G,EAAc+vH,EAAShhI,WAAa,qBAAuB,qBAC3D,MACF,KAAK,cACHiR,EAAc,wBACd,MACF,KAAK,mBACHA,EAAc,qBACd,MACF,KAAK,UACHA,OAAuC7hC,IAAzB4xJ,EAAS6V,YAA4B,mBAAqB,oBACxE,MACF,QACE5lI,EAAc,wBAIlBzhC,GAAU,QAAKyhC,QACM7hC,IAAlBhK,KAAKwlJ,WACNv8F,cAAcjpD,KAAKwlJ,UACnBxlJ,KAAKwlJ,cAAWx7I,GAIpBhK,KAAKkB,UAAU9B,UAAUoE,OAAO,eAAgB6nJ,IAAoB,eACpE,EAAAz9I,EAAA,GAAe5N,KAAKkB,UAAWkJ,GAE3BpK,KAAKkB,UAAU0C,eACjB5D,KAAKqzC,SAAS3zC,OAAOM,KAAKkB,YC1EjB,MAAMwwK,WAAoC3J,GAOvDnoK,YAAYspK,EAAmBxqC,GAC7B7+H,MAAM,CACJ0B,MAAO,GACPC,OAAQ,GACRkmK,QAAUt8H,GACDprC,KAAKwf,UAAUkoJ,QAAQt8H,EAAQ,SAAW,QAEnD88H,SAAUgB,EAAW99H,GACZA,EAAQ,CAAC,IAAK,IAAK,KAAO,CAAC,IAAK,IAAK,UAC1CphC,EACJ00H,cAAAA,IAGF1+H,KAAKX,IAAI,CACPoE,KAAM,aACNs6B,MAAO,CAAC,CACN6pI,WAAY,EACZC,SAAU,GACVpkK,KAAM,iBACL,CACDmkK,WAAY,GACZC,SAAU,GACVpkK,KAAM,UACL,CACDmkK,WAAY,GACZC,SAAU,GACVpkK,KAAM,QACL,CACDmkK,WAAY,GACZC,SAAU,IACVpkK,KAAM,iBACL,CACDmkK,WAAY,IACZC,SAAU,IACVpkK,KAAM,uBCjBd,MAAM,GAAY,OAKZkuK,GAA2B,CAC/BpwK,MAJgB,IAKhBC,OAJiB,KAOnB,IAAI,GAAa,iBAAqBmwK,IAEvB,MAAMC,WAAkB,IAkCrChyK,YAAoBg8J,GAClB/7J,MAAM,kBAAcmK,EAAW,CAC7B6kK,gBAAgB,EAChBz4H,UAAU,IAHM,KAAAwlH,SAAAA,EAoNZ,KAAAkT,kBAAoB,MAC1B,SAAkB9uK,KAAKkB,YAGjB,KAAAouK,mBAAqB,KAC3B,MAAMj6C,GAAS,YAET,cAACm6C,EAAa,kBAAEC,GAAqBzvK,KAErC0vK,EAAgB1vK,KAAKkB,UAAU9B,UAAUiG,SAAS,kBACxDrF,KAAKkB,UAAU9B,UAAUoE,OAAO,iBAAkB6xH,GAClDm6C,GAAiBA,EAAcpwK,UAAUoE,OAAO,OAAQ6xH,GACxDo6C,GAAqBA,EAAkBrwK,UAAUoE,OAAO,QAAS6xH,GACjEr1H,KAAKkvH,SAAS9vH,UAAUoE,OAAO,OAAQ6xH,GAEpCA,IAAWq6C,IACZ9tI,EAAA,kBAAqCyzF,GAErC/0C,GAAA,gBAA8B+0C,EAAS,eAAYrrH,GAEnDhK,KAAK6xK,0BAlOP7xK,KAAK8xK,gBAAkB,GAEvB,MAAM,UAAC5wK,EAAS,eAAE+H,GAAkBjJ,KACpCkB,EAAU9B,UAAUC,IAAI,GAAW,SAEnC,MAAM0vD,EAAkBjwD,SAASC,cAAc,OAC/CgwD,EAAgB3vD,UAAUC,IAAI,eAE9B,MAAMkN,EAASvM,KAAKuM,OAASvM,KAAK47J,SAASmW,mBAAmBl3J,WACxD8oC,EAAS,IAAIrW,GACnBqW,EAAOvkD,UAAUC,IAAI,eACrBskD,EAAO9a,kBAAkB,CACvBgY,OAAO,EACPt0C,OAAQA,IAEVwiD,EAAgBrvD,OAAOikD,GAEvB,MAAM70C,EAAQ,IAAIwpB,GAAU,CAC1B/rB,OAAAA,IACCnC,QAEH0E,EAAM1P,UAAUC,IAAI,cAEpB,MAAMoqC,EAAW3qC,SAASC,cAAc,OACxC0qC,EAASrqC,UAAUC,IAAI,iBAEHW,KAAK2tC,YAAc,IAAI6jI,GAAuB/nI,GAAlE,MAEMuoI,EAAiBhyK,KAAKgyK,eAAiBlzK,SAASC,cAAc,OACpEizK,EAAe5yK,UAAUC,IAAI,eAE7B6B,EAAUxB,OAAOqvD,EAAiBjgD,EAAO26B,GAErC,GAAAspD,UAWF/yF,KAAK4O,OAAOlP,OAAOsyK,IAVnBhyK,KAAKwvK,cAAgB,EAAW,cAChCxvK,KAAKyvK,kBAAoB,EAAW,qBACpC,QAAiBzvK,KAAKwvK,cAAexvK,KAAK8uK,kBAAmB,CAAC7lK,eAAAA,KAC9D,QAAiBjJ,KAAKyvK,mBAAmB,KAAM,YAAoB,CAACxmK,eAAAA,KACpE,SAAsBjJ,KAAKkB,UAAWlB,KAAKsvK,mBAAoBrmK,GAC/DjJ,KAAK4O,OAAO/K,QAAQ7D,KAAKyvK,mBACzBzvK,KAAK4O,OAAOlP,OAAOM,KAAKwvK,eAExBtuK,EAAUxB,OAAOsyK,IAKnBhyK,KAAKiyK,YAAcnzK,SAASC,cAAc,OAC1CiB,KAAKiyK,YAAY7yK,UAAUC,IAAI,qBAE/BW,KAAKkyK,gBAAkBpzK,SAASC,cAAc,OAC9CiB,KAAKkyK,gBAAgB9yK,UAAUC,IAAI,oBACnC,MAAM8yK,GAAY,QAAK,0BAA2B,CAAC,IAAI75I,GAAU,CAAC/rB,OAAAA,EAAQgsB,eAAe,EAAMG,aAAc,KAAKtuB,UAClH+nK,EAAU/yK,UAAUC,IAAI,yBACxB,MAAM8qK,EAAY,IAAIuH,IAA4B,GAAO,GACzDvH,EAAU39H,UAAS,GAAO,GAC1BxsC,KAAKkyK,gBAAgBxyK,OACnByqK,EAAUjpK,UACVixK,GAGFnyK,KAAKiyK,YAAYvyK,OAAOM,KAAKkyK,iBAC7BlyK,KAAKkB,UAAUxB,OAAOM,KAAKiyK,aAE3BjyK,KAAKmtK,WAAaA,GAAWjkK,KAAK,KAAM,GAAWlJ,KAAKiJ,gBACxDjJ,KAAKoyK,wBACLpyK,KAAKqyK,yBAELppK,EAAe5J,IAAIu8J,EAAnB3yJ,CAA6B,SAAS,KACpCjJ,KAAK6wK,oBAGP5nK,EAAe5J,IAAIu8J,EAAnB3yJ,CAA6B,cAAc,KACzCjJ,KAAK6wK,oBAGP7wK,KAAK2vK,aAAe,IAAInB,GAAa,CACnCvlK,eAAAA,EACA0lK,eAAgB,CACdztJ,SAjIU,IAkIVitC,UAjIW,IAkIX/jD,QAASpK,KAAKoK,QACd24C,kBAAoB1iD,IAClB,MAAM8G,EAAS9G,EAAE8G,OACjB,SAAG,EAAAwyB,GAAA,GAAgBxyB,EAAQ,iBACzB,EAAAwyB,GAAA,GAAgBxyB,EAAQ,cACxB,cAQNy+J,cAAgB5lK,KAAK47J,SAAS0W,iBAAoBtyK,KAAK47J,SAAShhI,WAA+B,GAAlB,OAAD,UAAK+2I,MAGnF,MAAMY,EAAiBvyK,KAAK2vK,aAAajB,QACtC6D,GACDvyK,KAAKiJ,eAAe5J,IAAIkzK,EAAxBvyK,CAAwC,UAAU,KAChDA,KAAK6xK,2BAIT,MAAMW,EAAgBxyK,KAAKwyK,cAAgB,IAAIpI,GAC/CoI,EAAczvB,MAAM,CAClB34I,QAASpK,KAAKkB,UACd+H,eAAgBjJ,KAAKiJ,eACrB8hK,uBAAwB,iBAE1ByH,EAAc7H,cAAa,GAE3B3qK,KAAKI,iBAAiB,SAAS,KAC7B,MAAM,aAACuvK,GAAgB3vK,KACvB,GAAgB2vK,EAAavkI,MAE7BprC,KAAKixK,eAAejoH,UAEpB2mH,EAAa3mH,aAGfhpD,KAAK6wK,iBAGA4B,kBACL,OAAOzyK,KAAK47J,SAGNwW,wBACN,MAAMjlI,EAAUntC,KAAK0yK,gBAAkB5zK,SAASC,cAAc,OAC9DouC,EAAQ/tC,UAAUC,IAAI,eAAwB,YAE9C,MAAM0vC,EAAmB6/H,GAAgB1lK,KAAK,KAAM,gBAE9CgmK,EAAWlvK,KAAKkvK,SAAWlvK,KAAKmtK,WAAW,CAC/C1tK,KAAM,cACNR,KAAM,qBACN6F,SAAU,KACR,MAAMtB,EAASurC,EAAiB,CAACmgI,EAAUE,IAAY,GACvDpvK,KAAK47J,SAASvG,qBAAqBnqI,QAAQ1nB,MAIzC4rK,EAAYpvK,KAAKovK,UAAYpvK,KAAKmtK,WAAW,CACjD1tK,KAAM,cACNR,KAAM,qBACN6F,SAAU,KACR,MAAMtB,EAASurC,EAAiB,CAACmgI,EAAUE,IAAY,GACvDpvK,KAAK47J,SAAS9G,sBAAsB5pI,QAAQ1nB,MAI5C,OACF4rK,EAAUhwK,UAAUC,IAAI,QACxBW,KAAKkB,UAAU9B,UAAUC,IAAI,cAG/BW,KAAK2yK,gBAAkB,IAAI,iBAAiB,CAC1C9iK,IAAK,cAEP,MAAMspJ,EAAUn5J,KAAKm5J,QAAUn5J,KAAKmtK,WAAW,CAC7C1tK,KAAMO,KAAK2yK,gBAAgBvoK,QAC3BtF,SAAU,KACR9E,KAAK47J,SAAS/H,iBAIZod,EAAiBjxK,KAAKixK,eAAiB,IAAIS,IAA4B,GAAM,GACnFvY,EAAQpwI,kBAAkBrpB,OAAOuxK,EAAe/vK,WAKhDisC,EAAQztC,OAAOwvK,EAAUE,EAAWjW,GACpCn5J,KAAKkB,UAAUxB,OAAOytC,GAGhBklI,yBACN,MAAMllI,EAAUntC,KAAK4yK,iBAAmB9zK,SAASC,cAAc,OAC/DouC,EAAQ/tC,UAAUC,IAAI,eAAwB,aAE9CW,KAAK6yK,mBAAqB,IAAI,iBAAiB,CAC7ChjK,IAAK,iBAEP,MAAMijK,EAAa9yK,KAAK8yK,WAAa9yK,KAAKmtK,WAAW,CACnD1tK,KAAMO,KAAK6yK,mBAAmBzoK,QAC9BnL,KAAM,iBACN6F,SAAU,KACR9E,KAAK47J,SAAStG,OAAO,iCAEvBv7G,UAAU,IAGNg5H,EAAY/yK,KAAK+yK,UAAY/yK,KAAKmtK,WAAW,CACjD1tK,KAAM,cACNR,KAAM,eACN6F,SAAU,KACR9E,KAAK47J,SAASoX,cAEhB1F,WAAW,IAGbngI,EAAQztC,OAAOozK,EAAYC,GAC3B/yK,KAAKkB,UAAUxB,OAAOytC,GA2BhB8lI,qBAAqBviJ,GAC3B,MACMxvB,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAI+tK,wBAExB18I,EAAMtxB,UAAUC,IAJG,cAKhBqxB,EAAMmG,QACPnG,EAAMruB,QAGR,QAAiBnB,GAAW,KAC1B,IAAIA,EAAU9B,UAAUiG,SAAS,SAC/B,OAGF,MAAM6tK,EAAM/mF,OAAOl2C,OAAOj2C,KAAK8xK,iBAAiB1/J,MAAMlR,IAAeA,EAAU9B,UAAUiG,SAAS,WAClG6tK,EAAI9zK,UAAUC,IAAI,SAClB6zK,EAAIjwK,MAAM42I,QAAU34I,EAAU+B,MAAM42I,QACpC34I,EAAU9B,UAAUkB,OAAO,SAC3BY,EAAU+B,MAAM42I,QAAU,GAE1B75I,KAAK6xK,2BAGP,MAAM7uK,EAASioK,GAAoBv6I,GAKnC,OAJA1tB,EAAO5D,UAAUC,IAAI+tK,mBAErBlsK,EAAUxB,OAAOsD,EAAQ0tB,GAElBxvB,EAGD2vK,iBACN,MAAM,SAACjV,GAAY57J,MACb,gBAACqrJ,GAAmBuQ,EAC1B,GAAGvQ,IAAoB,UAQrB,OAPGrrJ,KAAKkB,UAAU9B,UAAUiG,SAAS,oBACnC,WAGFrF,KAAKkvK,SAAS9vK,UAAUC,IAAI,iBAE5BW,KAAKs2C,OAIP,MAAM68H,GAAqBvX,EAAShhI,YAAcywH,IAAoB,WACtErrJ,KAAK6yK,mBAAmB9iF,iBAAiB,CACvClgF,IAAKw7I,IAAoB,WAAqB,eAAiB,aAEjErrJ,KAAK+yK,UAAU3zK,UAAUoE,OAAO,WAAY2vK,GAC5CnzK,KAAK+yK,UAAU3zK,UAAUoE,OAAO,WAAY2vK,GAC5CnzK,KAAKkB,UAAU9B,UAAUoE,OAAO,kBAAmB2vK,GAEnD,MAAM90H,EAAUu9G,EAASv9G,QACnBjd,EAAU,KACdphC,KAAKm5J,QAAQpwI,kBAAkB3pB,UAAUoE,OAAO,SAAU66C,IAGtD+sC,EAASprF,KAAKixK,eAAezxJ,UAAU4rE,OAC7CprF,KAAKixK,eAAezkI,UAAU6R,GAAUA,EAASjd,GAC7CgqD,GACFhqD,IAGFphC,KAAK2yK,gBAAgB5iF,iBAAiB,CACpClgF,IAAKwuC,EAAU,aAAe,cAGhC,MAAM8pG,EAAiByT,EAASzT,eAChCnoJ,KAAKkvK,SAASnmJ,kBAAkB3pB,UAAUoE,OAAO,SAAU2kJ,GAE3D,MAAMoL,EAAkBqI,EAASrI,gBACjCvzJ,KAAKovK,UAAUrmJ,kBAAkB3pB,UAAUoE,OAAO,SAAU+vJ,GAE5D,MAAM6f,EAAcxX,EAASyX,cAAc,WAE3C,QAAcrzK,KAAKkyK,gBAAiB,gBAAgBkB,MAAAA,OAAW,EAAXA,EAAaxyI,OAAO,KAExE,MAAMktC,EAAa9tE,KAAK8xK,gBAClBwB,EAAgB,OAAH,UAAOxlG,GAC1B,CAAC,QAAkB,UAAmB1gE,SAASnN,IAC7C,MAAMszK,EAAa3X,EAASyX,cAAcpzK,GACpCywB,EAAQkrI,EAAS4X,gBAAgBvzK,GAEjCwzK,KAAc/iJ,GAASA,EAAMmR,YAAcnR,EAAM4nG,cACpD5nG,GAAU+iJ,GAAa/iJ,EAAM9oB,QAAQ8rK,aACtChjJ,EAAM9oB,QAAQ8rK,WAAa,KAE3B,EAAA/xI,GAAA,GAAYjR,GAAOhvB,MAAK,YACfgvB,EAAM9oB,QAAQ8rK,WACrB1zK,KAAK6wK,qBAMT,MAAM5hE,IAAav+E,GAAS+iJ,MAAeF,GAAyC,WAA1BA,EAAWI,YAA0D,WAA/BJ,EAAWK,iBAC3G,IAAIC,EAAiB/lG,EAAW7tE,GAE7BgvG,GAAYv+E,IAAUmjJ,IACvBA,EAAiB/lG,EAAW7tE,GAAQD,KAAKizK,qBAAqBviJ,GAC9D1wB,KAAKkB,UAAUxB,OAAOm0K,KAGpB5kE,GAAY4kE,IACdA,EAAevzK,gBACRwtE,EAAW7tE,OAItB,CACE,MAAMF,EAAQ+tE,EAAW/tE,MACnB+zK,EAAShmG,EAAWgmG,OACvB3nF,OAAOzuE,KAAK41J,GAAe3yK,SAAWwrF,OAAOzuE,KAAKowD,GAAYntE,QAAUZ,GACzEA,EAAMX,UAAUoE,OAAO,UAAWswK,GAGjCA,IAAW/zK,GACZ+zK,EAAO10K,UAAUkB,OAAO,SAI5BN,KAAK6xK,wBAEL7xK,KAAKkB,UAAU9B,UAAUoE,OAAO,YAAa2oF,OAAOzuE,KAAKowD,GAAYntE,SAEjEX,KAAKgyK,eAAer/I,aAAe04H,EAAkB,oBACvDloJ,QAAQ4B,QAAQ62J,EAASmY,wBAAwBryK,MAAMyoG,IACrDnqG,KAAKgyK,eAAetyK,QAAO,EAAAk5B,GAAA,GAAcuxE,EAAOxmF,KAAK,SAIzD3jB,KAAKmxK,iBAGCU,wBACN1lF,OAAOl2C,OAAOj2C,KAAK8xK,iBAAiB1kK,SAASlM,IAE3C,GADgBA,EAAU9B,UAAUiG,SAAS,SACjC,CACV,MAAMqrB,EAAQxvB,EAAUgE,cAAc,SAChC8uK,EAAah0K,KAAK2vK,aAAavkI,MAC/B6oI,EAAe,IACfC,EAAgB,IAEhBC,EAAazjJ,EAAM4nG,YAAc5nG,EAAMmR,WACvCuyI,EAAWD,EAAaD,EAAgBD,EAExCI,EAAkB,EAAI,IAAK,WAAiB,MAAUF,EAAaH,EAAWxyK,OAASwyK,EAAWzyK,OAClG+yK,EAAaH,EAAazjJ,EAAMmR,WAAanR,EAAM4nG,YAAc,EACjEi8C,EAAcJ,EAAa,EAAIzjJ,EAAM4nG,YAAc5nG,EAAMmR,WAC/D3gC,EAAU+B,MAAM1B,MAAQ8yK,EAAkBC,EAAa,KACvDpzK,EAAU+B,MAAMzB,OAAS6yK,EAAkBE,EAAc,KACzDrzK,EAAU+B,MAAMge,SAAWmzJ,EAAWE,EAAa,KACnDpzK,EAAU+B,MAAMme,UAAYgzJ,EAAWG,EAAc,UAErDrzK,EAAU+B,MAAM42I,QAAU,MAKxBs3B,iBACNnxK,KAAK2tC,YAAYtV,OAAOr4B,KAAK47J,WCldlB,SAAS4Y,GAAmBhmB,GACzC,MAAM32G,EAAO02G,GAAsBC,EAAKA,EAAIxgI,MAAM,IAE5C2Y,EAAuC,CAC3C,QAAS,eACTm8G,aAAc,CAACjrG,EAAKgrG,aACpBF,MAAO9qG,EAAK8qG,MACZC,IAAK/qG,EAAK+qG,IACVzlH,WAAOnzB,EACP0mB,WAAO1mB,EACPyqK,gBAAYzqK,GAGR0qK,EAAiBx2E,GAAmB,GAAKA,EAE/C,IAAI,MAAM/kF,KAAWq1I,EAAIxgI,MAAO,CAC9B,MAAMszH,EAAYnoI,EAAQmoI,UAC1B,GAAiB,gBAAdA,IAAgCnoI,EAAQwxI,UACzC,SAGF,MAAM7G,EAAuBn9G,EAAmB,UAAd26G,GAAyB36G,EAAY,MAAI,aAAe26G,GAAa,GACjGzpG,EAAO02G,GAAsBC,EAAKr1I,GACxC2qI,EAAMR,KAAOoxB,EAAc78H,EAAKmjF,QAE7BnjF,EAAKurG,eACNU,EAAM6wB,WAAa98H,EAAKurG,aAAazoI,KAAKi6J,IAAgB,CAAElxB,UAAWkxB,EAAYlxB,UAAW2N,MAAOujB,EAAYnxB,QAAQ9oI,IAAI+5J,QAG/H,MAAMG,EAAgD/wB,EAAM+wB,cAAgB,GAC5E17J,EAAQiiB,WAAW5pB,IAAI,UAAUpE,SAASiuB,IACxCw5I,EAAchjK,KAAK,CACjBrB,IAAK6qB,EAAUxrB,IACfoM,IAAKof,EAAU76B,WAInB,MAAMs0K,EAAiE,IAAI7jK,IAErE8jK,EAAkBvkK,IACtB,IAAIwkK,EAAcF,EAAgBtjK,IAAIhB,GAOtC,OANIwkK,GACFF,EAAgB73J,IAAIzM,EAAIwkK,EAAc,CACpCxkK,GAAAA,IAIGwkK,GAGT77J,EAAQiiB,WAAW5pB,IAAI,UAAUpE,SAASiuB,IACxC,MAAM7qB,GAAM6qB,EAAUxrB,IAChBmlK,EAAcD,EAAevkK,GAC7B8vC,EAAWjlB,EAAU76B,MAAMkiC,MAAM,MAChCj/B,EAAM2gJ,EAAW/3D,GAAY/rC,EACpC00H,EAAYvxK,KAAOA,EACnBuxK,EAAY5wB,WAAaA,EACzB4wB,EAAY3oF,SAAWA,GAAYA,EAAW,KAGhDlzE,EAAQiiB,WAAW5pB,IAAI,WAAWpE,SAASiuB,IACzC,MAAM7qB,GAAM6qB,EAAUxrB,IACFklK,EAAevkK,GACvBykK,cAAgB55I,EAAUyjE,MAAMnkF,KAAKuK,IAC/C,MAAMo7B,EAAWp7B,EAAKwd,MAAM,MACrBziC,EAAMukJ,GAAWlkG,EACxB,MAAO,CACLrgD,KAAAA,EACAukJ,QAASA,GAAW,UAK1BrrI,EAAQiiB,WAAW5pB,IAAI,QAAQpE,SAASiuB,IACtC,MAAM7qB,GAAM6qB,EAAUxrB,IAEhBw0I,EADc0wB,EAAevkK,GAC4C6zI,WAAa,GACtF/jG,EAAWjlB,EAAU76B,MAAMkiC,MAAM,KACvC,IAAI,MAAMtR,KAAOkvB,EAAU,CACzB,MAAOzwC,EAAKrP,GAAS4wB,EAAIsR,MAAM,KAC/B2hH,EAAWx0I,GAAOrP,MAItBsjJ,EAAMG,aAAe7yI,MAAMC,KAAKyjK,EAAgB7+H,UAOlD,OAAOtP,EC1FM,MAAMuuI,WAA+BjqB,GAGlDrrJ,YAAYhB,GAGViB,MAAMjB,GAGQstJ,oB,qCACd,MAAM,WAACxE,EAAU,KAAE1xF,GAAQh2D,KAE3B,IAAI0nJ,EAAWytB,mBAAqBztB,EAAW0tB,oBAAsBp/G,EAAKp7B,WACxE,OAGF,IAAIy6I,EACJ,GAAGr/G,EAAKs/G,cAAe,CACrBt/G,EAAKs/G,eAAgB,EAErB,MAAMxnH,EAASunH,QAAwB3tB,EAAW6tB,eAElDv1K,KAAK8zB,IAAI,cAAeg6B,EAAO7tD,KAAM6tD,EAAO0gG,WACtC9G,EAAWsK,oBAAoBlkG,GAErC9tD,KAAK8zB,IAAI,6BACJ,CACL,MAAMk9H,EAAQqkB,QAAwB3tB,EAAWoJ,cAEjD9wJ,KAAK8zB,IAAI,cAAek9H,EAAMxC,WACxB9G,EAAWsK,oBAAoBhB,GAErCh7F,EAAKw/G,WAAY,EAEjBx1K,KAAK8zB,IAAI,yBAGX,MAAM2hJ,EAAejB,GAAmBvmB,GAASonB,EAAgB7mB,MACjEx4F,EAAK0/G,sBAAsBD,I,gSCvC/B,IAAI,G,sTCeJ,MAAME,GAAuB,KAEtB,MAAMC,WAAwB,IAY5BntJ,UAAU9V,GACf3S,KAAK2S,SAAWA,EAChB3S,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,MAEd,OAIJ7nE,KAAKm/I,WDnCA,eAAe,IAAIV,GAAiB,CACzC,gBACA,mBACA,eACA,oBACA,oBACA,oBC8BAz+I,KAAKynB,OAAS,EACdznB,KAAK61K,UAAY,IAAI5kK,IACrBjR,KAAK81K,gBAAkB,GAEvB,qBAA2B,eAAqB9/G,GAAS,mC,MACvD,IAAI4lG,EAAW57J,KAAK61K,UAAUrkK,IAAIwkD,EAAKxlD,IAMvC,OAJGorJ,GACDA,EAASma,aAAa//G,GAGjBA,EAAKppD,GACV,IAAK,qBACAgvJ,GACDA,EAAStG,OAAkB,QAAX,EAAAt/F,EAAKf,cAAM,eAAEroD,GAAG,GAGlC,MAGF,IAAK,oBACAgvJ,GAODA,EAASoa,cAGX,MAGF,IAAK,qBACCpa,IAMFA,EAAW57J,KAAKi2K,mBAAmB,CACjCr7I,YAAY,EACZm3I,mBAAoB/7G,EAAKkgH,WAG3Bta,EAASua,wBAAwB,YACjCva,EAASma,aAAa//G,GACtB4lG,EAASwa,iBAAiBT,GAAsB,iCAGlD,MAGF,IAAK,YAAa,CAChB,IAAI/Z,GAAYA,EAASya,cACvB,MAGF,MAAMC,EAAM1a,EAAS2a,GAAGD,IAAMtgH,EAAKwgH,SAC7BD,EAAK3a,EAAS2a,GACdE,QAAiB,kBAA6B,SAAUH,GAC9D,KAAI,EAAAI,GAAA,GAASH,EAAGE,SAAUA,GAAW,CACnCz2K,KAAK8zB,IAAInmB,MAAM,qBAAsB4oK,EAAGE,SAAUA,GAClD,MAGF,MAAM,IAAC5mK,EAAG,gBAAE8mK,SAAyB32K,KAAK2S,SAASikK,gBAAgBC,WAAWP,EAAKC,EAAGxrH,EAAGwrH,EAAG3oI,GAC5F,GAAGooB,EAAK2gH,kBAAoBA,EAAiB,CAC3C32K,KAAK8zB,IAAInmB,MAAM,4BAA6BqoD,EAAK2gH,gBAAiBA,GAClE,MAGF/a,EAASya,cAAgBxmK,EACzB+rJ,EAASkb,WAET,aAKN,qBAA2B,kBAAkB,EAAEC,OAAAA,EAAQpwI,KAAAA,MACrD,MAAMi1H,EAAW57J,KAAK61K,UAAUrkK,IAAIulK,IACjCnb,MAAAA,OAAQ,EAARA,EAAUprJ,MAAOumK,GAIpBnb,EAASob,+BAA+BrwI,OAIjCswI,kBACT,OAAOj3K,KAAK81K,gBAAgB,GAGvBoB,gBAAgBh8J,GACrB,IAAI,MAAO67J,EAAQnb,KAAa57J,KAAK61K,UACnC,GAAGja,EAASmW,qBAAuB72J,EACjC,OAAO0gJ,EAKLqa,mBAAmBr3K,GAKzB,MAAMo3D,EAAO,IAAImhH,GAAa,OAAD,QAC3BxkK,SAAU3S,KAAK2S,UACZ/T,IA2DL,OAxDAo3D,EAAK51D,iBAAiB,SAAUgrC,IAC9B,MAAM6rI,EAAcj3K,KAAKi3K,YACtB7rI,IAAU,WACXprC,KAAK61K,UAAUnmK,OAAOsmD,EAAKxlD,KAC3B,EAAAuB,EAAA,GAAiB/R,KAAK81K,gBAAiB9/G,KAEvC,EAAAoG,GAAA,GAA2Bp8D,KAAK81K,gBAAiB9/G,EAAM,aAGtD5qB,IAAU,qBACX4qB,EAAKs8G,iBAAkB,GAGzB,MAAM8E,OAAoCptK,IAArBgsD,EAAKy7G,YACvBrmI,IAAU,oBAA+BA,IAAU,eAAyBgsI,EAC7EphH,EAAKogH,iBAAiBT,GAAsB,oCAE5C3/G,EAAKqhH,qBAGJJ,IAAgBjhH,GAASihH,IACvB7rI,IAAU,UACP4qB,EAAKp7B,YAAeo7B,EAAKs8G,gBAEnBt8G,EAAKs8G,kBAAoB8E,EACjCp3K,KAAKm/I,WAAWR,UAAU,mBAE1B3+I,KAAKm/I,WAAWR,UAAiC,+BAAvB3oF,EAAKshH,cAAiD,gBAAkB,gBAJlGt3K,KAAKm/I,WAAWH,YAMV5zG,IAAU,WAClBprC,KAAKm/I,WAAWR,UAAU3oF,EAAKp7B,WAAa,oBAAsB,qBAAqB,GAC/EwQ,IAAU,mBAClBprC,KAAKm/I,WAAWL,qBAAqB,oBAC7B1zG,IAAU,cACf4qB,EAAKnwD,UACN7F,KAAKm/I,WAAWR,UAAU,uBAAuB,GAGnD3+I,KAAKm/I,WAAWH,gBAKtBhpF,EAAK51D,iBAAiB,MAAM,CAACoQ,EAAIk4D,UACjB1+D,IAAX0+D,GACD1oE,KAAK61K,UAAUnmK,OAAOg5D,GAGxB,MAAM6uG,IAAev3K,KAAKi3K,YAC1Bj3K,KAAK61K,UAAU54J,IAAIzM,EAAIwlD,QAEThsD,IAAX0+D,GACD1oE,KAAKgQ,cAAc,WAAY,CAAC4rJ,SAAU5lG,EAAMuhH,WAAYA,OAIzDvhH,EAGIwhH,kBAAkBt8J,EAAgB8tI,G,0CAC7ChpJ,KAAK8zB,IAAI,uBAAwB5Y,EAAQ8tI,GAEzC,MAAMyuB,QAAiBz3K,KAAK2S,SAASq8B,kBAAkB+4C,WAAW7sE,GAClE,IAAIu8J,EAAU,OAEd,MAAM,sBAACvf,GAAyBuf,EAASj/J,OAEnCw9C,EAAOh2D,KAAKi2K,mBAAmB,CACnCr7I,YAAY,EACZm3I,mBAAoB72J,IAGtB86C,EAAKqyF,oBAAmB,KAASW,IAAWkP,IAAwB,GAEpEliG,EAAKmgH,wBAAwB,eAC7BngH,EAAK+/G,aAAa,CAChBnpK,EAAG,mBACHqpD,YAAa,GACbigH,SAAU,MACV/iK,MAAM,EAAAq8H,GAAA,IAAM,GACZh/H,KAAMxQ,KAAKynB,OACXiwJ,eAAgBx8J,EAChB8mI,SAAUhsF,EAAKgsF,SACfxpI,OAAQ,CACNkY,MAAOs4H,QAAWh/I,KAKtBhK,KAAK2S,SAASikK,gBAAgBe,aAAaj2K,MAAW60K,GAAO,mCAG3D,OAFAvgH,EAAKugH,GAAKA,EAEHv2K,KAAK2S,SAASikK,gBAAgBgB,YAAY18J,EAAQ86C,EAAKgsF,SAAUhsF,EAAKugH,GAAGE,SAAUztB,GAAWkP,QACpGx2J,MAAMm2K,IACP7hH,EAAKmgH,wBAAwB,YAC7BngH,EAAK+/G,aAAa8B,GAClB7hH,EAAKogH,iBAAiBT,GAAsB,uCAKlD,MAAMmC,GAAkB,IAAIlC,GAC5B,OAAmB,qBAAiCkC,IACpD,Y,eCxQA,MAEA,GAFkC,oBAAb,QAA4B,WAAYhyK,OAASA,OAAOiyK,OAAOC,OAASxwH,KAAKuwH,OAAOC,O,sTCiB1F,MAAMC,GAKnBr4K,YAAoBg7B,EAA6Bs9I,GAA7B,KAAAt9I,WAAAA,EAA6B,KAAAs9I,OAAAA,EAC/Cl4K,KAAKC,KAAO,YACZD,KAAKytE,QAAU,EACfztE,KAAKm4K,OAAS,IAAIlnK,IAGZmnK,aAAar6I,GACnB,OCzB2BxR,GDyBb,EAAA8rJ,GAAA,MAAiBt6I,GCxB1B,UAAc,WAAW,EAAAu6I,GAAA,GAAoB/rJ,IAAQ7qB,MAAMqpD,GAEzD,IAAIr+B,WAAWq+B,KAHX,IAAgBx+B,ED4BfgsJ,gBAAgB98I,G,0CAC5B,MAAMnsB,EAAS,CACbm+D,QAAS,EACTlhD,MAAO,IAAIG,WAAW,GAAK+O,EAAO96B,SAG9BqG,GAAKhH,KAAK46B,WAAa,EAAI,IAAoB,cAAd56B,KAAKC,KAAuB,IAAM,GACnE4P,EAAM7P,KAAKk4K,OAEXM,QAAoBx4K,KAAKo4K,aAAa,CAACvoK,EAAI4oK,SAASzxK,EAAI,GAAIA,EAAI,GAAK,IAAKy0B,IAC1Ei9I,EAASppK,EAAOid,MACtB,IAAI,IAAIxgB,EAAI,EAAGA,EAAI,KAAMA,EACvB2sK,EAAO3sK,GAAKysK,EAAYzsK,EAAI,GAG9B,MAAM4sK,QAAiB34K,KAAK44K,gBAAgB/oK,EAAK6oK,EAAQ1xK,GAEnDulB,QAAcvsB,KAAK64K,cAAcp9I,EAAQA,EAAO96B,OAAQg4K,GAAU,GAIxE,OAFArpK,EAAOid,MAAQ,IAAIG,WAAW,IAAIpd,EAAOid,MAAMksJ,SAAS,EAAG,OAAQlsJ,IAE5Djd,KAGFwpK,iBAAiBr9I,GACtB,MAAMs9I,IAAQ/4K,KAAKytE,QACb7sD,EAAM,IAAIo4J,YAAY,GACf,IAAIx9I,SAAS5a,GACrBq4J,UAAU,EAAGF,IAAQ,GAAG,GAE7B,MAAMzpK,EAAS,IAAIod,WAAW,IAAI,IAAIA,WAAW9L,MAAS6a,IAE1D,OAAOz7B,KAAKu4K,gBAAgBjpK,GAGhBspK,gBAAgB/oK,EAAiB6oK,EAAoB1xK,G,0CACjE,MAAOkyK,EAASC,SAAiBh2K,QAAQC,IAAI,CAC3CpD,KAAKo4K,aAAa,CAChBM,EAAOD,SAAS,EAAG,IACnB5oK,EAAI4oK,SAASzxK,EAAGA,EAAI,MAGtBhH,KAAKo4K,aAAa,CAChBvoK,EAAI4oK,SAAS,GAAKzxK,EAAG,GAAKA,EAAI,IAC9B0xK,EAAOD,SAAS,EAAG,QAIvB,MAAO,CACL5oK,IAAK,IAAI6c,WAAW,IACfwsJ,EAAQT,SAAS,EAAG,MACpBU,EAAQV,SAAS,EAAG,OACpBS,EAAQT,SAAS,GAAI,MAE1BW,GAAI,IAAI1sJ,WAAW,IACdysJ,EAAQV,SAAS,EAAG,MACpBS,EAAQT,SAAS,EAAG,OACpBU,EAAQV,SAAS,GAAI,UAKhBI,cAAcQ,EAA2BC,EAAkBX,EAA6CY,GAAU,G,0CAC9H,MAAMC,QAAkB,aACtB,MACAb,EAAS9oK,IACT,CAACpM,KAAM,YACP,EACA,CAAC81K,EAAU,UAAY,YAGnB99I,QAA4B,GAAO89I,EAAU,UAAY,WAAW,CACtE91K,KAAM,UACNgqE,QAASkrG,EAASS,GAClBz4K,OAA6B,EAArBg4K,EAASS,GAAGz4K,QAEtB64K,EACAH,GAGF,OAAO,IAAI3sJ,WAAW+O,MAGhBg+I,qBAAqB7yI,EAAemkB,EAAeh+C,GACzD,IAAI2sK,GAAe,EACnB,IAAI,IAAI3tK,EAAI,EAAGA,EAAIgB,IAAShB,EACvB66B,EAAE76B,KAAOg/C,EAAEh/C,KACZ2tK,GAAe,GAInB,OAAQA,EAGGC,iBAAiBl+I,G,0CAC5B,GAAGA,EAAO96B,OAAS,IAAM86B,EAAO96B,OAhHL,UAiHzB,OAGF,MAAM,WAACi6B,EAAU,KAAE36B,GAAQD,KAErBgH,GAAK4zB,EAAa,EAAI,IAAe,cAAT36B,EAAuB,IAAM,GACzD4P,EAAM7P,KAAKk4K,OAEXQ,EAASj9I,EAAOg9I,SAAS,EAAG,IAC5BY,EAAgB59I,EAAOg9I,SAAS,IAChCmB,EAAoBn+I,EAAO96B,OAAS,GAEpCg4K,QAAiB34K,KAAK44K,gBAAgB/oK,EAAK6oK,EAAQ1xK,GAEnD6yK,QAAyB75K,KAAK64K,cAAcQ,EAAeO,EAAmBjB,GAAU,GAExFH,QAAoBx4K,KAAKo4K,aAAa,CAC1CvoK,EAAI4oK,SAAS,GAAKzxK,EAAG,GAAKA,EAAI,IAC9B6yK,IAGF,GAAG75K,KAAKy5K,qBAAqBjB,EAAYC,SAAS,GAAIC,EAAQ,IAC5D,OAGF,MACMK,EADW,IAAIv9I,SAASq+I,EAAiBp+I,QAC1Bq+I,UAAU,GAC/B,OAAG95K,KAAKm4K,OAAOhmI,IAAI4mI,QAAnB,GAGA/4K,KAAKm4K,OAAOl7J,IAAI87J,EAAKA,GAEdc,EAAiBn5K,MAAM,QElJnB,MAAMq5K,GACnBt2J,qBAAqBo0B,GACnB,MAAM,aAACirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAASmnB,EACjD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEhBspJ,EAAgB,IAAIn5B,GAC1Bm5B,EAAc36K,IACZ,MACA,2BACA,MACA,SAGCyjJ,GACDA,EAAa11I,SAASpG,IACpB,MAAM,KAAC8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAS/7I,EACnCgzK,EAAc36K,IACZ,iBAAiByrE,KAAQ+3E,IACzB,WAAWE,QAIdJ,GAASC,GACVo3B,EAAc36K,IACZ,eAAesjJ,IACf,aAAaC,KAIjBo3B,EAAc36K,IACZ,uBACA,uBACA,0BAEF,MAAM8jJ,EAAa,SAAWn1H,EAAMrT,KAAK3T,GAAMA,EAAEs8I,OAAM3/H,KAAK,KAC5D,IAAI,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACpC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAC9L,EAAI,KAAEqjJ,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,cAAE4wB,GAAiBhpJ,EAC9D,OAAO5rB,GACL,IAAK,QACH+5K,EAAc36K,IACZ,mCAAmC4kJ,EAAatpI,KAAK3T,GAAWA,EAAEwJ,KAAImT,KAAK,OAC3E,mBACA,0BACA,wBACA,SAAS5X,IACT,aACAkuK,GAAUpF,IAETvxB,GACD02B,EAAc36K,IAAI,UAAU8jJ,UAAmBG,KAEjD02B,EAAc36K,IACZ,aACA66K,GAAgBj2B,GAChBf,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IAGlC,MAGF,IAAK,QACH62B,EAAc36K,IACZ,mCAAmC4kJ,EAAatpI,KAAK3T,GAAWA,EAAEwJ,KAAImT,KAAK,OAC3E,mBACA,0BACA,wBACA,SAAS5X,IACT,aACAkuK,GAAUpF,IAETvxB,GACD02B,EAAc36K,IAAI,UAAU8jJ,UAAmBG,KAEjD02B,EAAc36K,IACZ,aACA,eACA66K,GAAgBj2B,GAChBf,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,KAOxC,OADA62B,EAAc36K,IC4NT,mJD3NE26K,EAAc94B,WAGvBz9H,sBAAsBo0B,GACpB,MAAM,aAACirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAASmnB,EACjD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEhBspJ,EAAgB,IAAIn5B,GAC1Bm5B,EAAc36K,IACZ,MACA,2BACA,MACA,SAGCyjJ,GACDA,EAAa11I,SAASpG,IACpB,MAAM,KAAC8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAS/7I,EACnCgzK,EAAc36K,IACZ,iBAAiByrE,KAAQ+3E,IACzB,WAAWE,QAIdJ,GAASC,GACVo3B,EAAc36K,IACZ,eAAesjJ,IACf,aAAaC,KAIjBo3B,EAAc36K,IACZ,uBACA,uBACA,0BAEF,MAAM8jJ,EAAa,SAAWn1H,EAAMrT,KAAK3T,GAAMA,EAAEs8I,OAAM3/H,KAAK,KAC5D,IAAI,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACpC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAC9L,EAAI,KAAEqjJ,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,cAAE4wB,GAAiBhpJ,EAC9D,OAAO5rB,GACL,IAAK,QACH+5K,EAAc36K,IACZ,mCAAmC4kJ,EAAatpI,KAAK3T,GAAWA,EAAEwJ,KAAImT,KAAK,OAC3E,mBACA,0BACA,wBACA,SAAS5X,IACT,aACAkuK,GAAUpF,IAETvxB,GACD02B,EAAc36K,IAAI,UAAU8jJ,UAAmBG,KAEjD02B,EAAc36K,IACZ,aACA66K,GAAgBj2B,GAChBf,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IAElC,MAGF,IAAK,QACH62B,EAAc36K,IACZ,mCAAmC4kJ,EAAatpI,KAAK3T,GAAWA,EAAEwJ,KAAImT,KAAK,OAC3E,mBACA,0BACA,wBACA,SAAS5X,IACT,aACAkuK,GAAUpF,IAETvxB,GACD02B,EAAc36K,IAAI,UAAU8jJ,UAAmBG,KAGjD02B,EAAc36K,IACZ,aACA,eACA66K,GAAgBj2B,GAChBf,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,KAOxC,OADA62B,EAAc36K,ICmIT,mJDlIE26K,EAAc94B,YErLlB,MAAMi5B,GACT12J,qBAAqBo0B,GACjB,MAAM,aAAEirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAAUmnB,EACnD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEtB,IAAI89H,EAAM,0CAIN1L,GACAA,EAAa11I,SAAQpG,IACjB,MAAM,KAAE8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAU/7I,EACrCwnJ,GAAO,mBACP1jF,KAAQ+3E,cACdE,OAGEJ,GAASC,IACT4L,GAAO,iBACL7L,gBACFC,KAGJ4L,GAAO,uEAIP,MAAMrL,EAAa,SAAWn1H,EAAMrT,KAAI3T,GAAKA,EAAEs8I,OAAM3/H,KAAK,KAC1D,IAAK,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACnC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAE9L,EAAI,KAAEqjJ,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,cAAE4wB,GAAkBhpJ,EAChE,OAAQ5rB,GACJ,IAAK,QACDuuJ,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iCAEvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACjBrmB,GAAO,eAEPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,GAEvC,MAEJ,IAAK,QACDqL,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iCAEvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACjBrmB,GAAO,6BAGPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IAUnD,OAJAqL,GDsPC,kJCrPDA,GAAO,KAGAA,EAGX/qI,sBAAsBo0B,GAClB,MAAM,aAAEirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAAUmnB,EACnD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEtB,IAAI89H,EAAM,0CAIN1L,GACAA,EAAa11I,SAAQpG,IACjB,MAAM,KAAE8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAU/7I,EACrCwnJ,GAAO,mBACP1jF,KAAQ+3E,cACdE,OAGEJ,GAASC,IACT4L,GAAO,iBACL7L,gBACFC,KAGJ4L,GAAO,uEAIP,MAAMrL,EAAa,SAAWn1H,EAAMrT,KAAI3T,GAAKA,EAAEs8I,OAAM3/H,KAAK,KAC1D,IAAK,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACnC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAE9L,EAAI,IAAEgN,EAAG,KAAEq2I,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,IAAEjtF,EAAG,cAAE69G,GAAkBhpJ,EAC1E,OAAQ5rB,GACJ,IAAK,QACDuuJ,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iCAEvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACjBrmB,GAAO,eAEPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,GAEvC,MAEJ,IAAK,QACDqL,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iCAEvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACjBrmB,GAAO,6BAGPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IASnD,OAJAqL,GDgLC,kJC/KDA,GAAO,KAGAA,GC3IR,MAAM4rB,GACT32J,qBAAqBo0B,GACjB,MAAM,aAAEirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAAUmnB,EACnD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEtB,IAAK1C,EAAMrtB,OACP,MAAO,oEAQX,IAAI6tJ,EAAM,4CAIN1L,GACAA,EAAa11I,SAAQpG,IACjB,MAAM,KAAE8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAU/7I,EACrCwnJ,GAAO,mBACP1jF,KAAQ+3E,cACdE,OAGEJ,GAASC,IACT4L,GAAO,iBACL7L,gBACFC,KAGJ4L,GAAO,uEAIP,MAAMrL,EAAa,SAAWn1H,EAAMrT,KAAI3T,GAAKA,EAAEs8I,OAAM3/H,KAAK,KAC1D,IAAK,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACnC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAE9L,EAAI,KAAEqjJ,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,cAAE4wB,GAAkBhpJ,EAChE,OAAQ5rB,GACJ,IAAK,QACDuuJ,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iFAIvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACbvxB,IACAkL,GAAO,YACtBrL,UAAmBG,KAERkL,GAAO,eAEPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,GAEvC,MAEJ,IAAK,QACDqL,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iFAIvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACbvxB,IACAkL,GAAO,YACtBrL,UAAmBG,KAERkL,GAAO,6BAGPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IASnD,OAJAqL,GFkOC,kJEjODA,GAAO,KAGAA,EAGX/qI,sBAAsBo0B,GAClB,MAAM,aAAEirG,EAAY,MAAEH,EAAK,IAAEC,EAAG,MAAEzlH,EAAK,MAAEzM,GAAUmnB,EACnD1a,EAAMl9B,KAAO,QACbywB,EAAMzwB,KAAO,QACb,MAAM+tB,EAAQ,CAACmP,EAAOzM,GAEtB,IAAK1C,EAAMrtB,OACP,MAAO,oEAQX,IAAI6tJ,EAAM,4CAIN1L,GACAA,EAAa11I,SAAQpG,IACjB,MAAM,KAAE8jE,EAAI,YAAE+3E,EAAW,MAAEE,GAAU/7I,EACrCwnJ,GAAO,mBACP1jF,KAAQ+3E,cACdE,OAGEJ,GAASC,IACT4L,GAAO,iBACL7L,gBACFC,KAGJ4L,GAAO,uEAIP,MAAMrL,EAAa,SAAWn1H,EAAMrT,KAAI3T,GAAKA,EAAEs8I,OAAM3/H,KAAK,KAC1D,IAAK,IAAI5X,EAAI,EAAGA,EAAIiiB,EAAMrtB,OAAQoL,IAAK,CACnC,MAAM8f,EAAImC,EAAMjiB,IACV,KAAE9L,EAAI,KAAEqjJ,EAAI,WAAEqxB,EAAU,aAAE1wB,EAAY,cAAE4wB,GAAkBhpJ,EAChE,OAAQ5rB,GACJ,IAAK,QACDuuJ,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iFAIvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACbvxB,IACAkL,GAAO,YACtBrL,UAAmBG,KAERkL,GAAO,eAEPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,GAEvC,MAEJ,IAAK,QACDqL,GAAO,iCACGvK,EAAatpI,KAAI3T,GAAKA,EAAEwJ,KAAImT,KAAK,iFAIvD5X,gBAEYyiJ,GAAOyrB,GAAUpF,GACbvxB,IACAkL,GAAO,YACtBrL,UAAmBG,KAERkL,GAAO,6BAGPA,GAAO0rB,GAAgBj2B,GACvBuK,GAAOtL,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,IASnD,OAJAqL,GFuIC,kJEtIDA,GAAO,KAGAA,GFqDR,SAAS6rB,KACd,OAAO7+J,UAAU8+J,UAAUzxK,cAAc2N,QAAQ,YAAc,EAGjE,SAAS+jK,KACP,OAAO/+J,UAAU8+J,UAAUzxK,cAAc2N,QAAQ,WAAa,IAA8D,IAAzDgF,UAAU8+J,UAAUzxK,cAAc2N,QAAQ,UAGxG,SAASyjK,GAAUxpB,GACxB,IAAIjC,EAAM,GAEV,IAAK,IAAIgsB,EAAI,EAAGA,EAAI/pB,EAAO9vJ,OAAQ65K,IAAK,CACtC,MAAM73I,EAAM8tH,EAAO+pB,IACb,GAAEhqK,EAAE,IAAEyL,GAAQ0mB,EAEpBj1B,QAAQomB,IAAI,eAAgBtjB,EAAIyL,GAChCuyI,EAAI38I,KAAK,YAAYrB,KAAMyL,KAG7B,OAAOuyI,EAAI7qI,KAAK,MAGX,SAASu2J,GAAgBzrG,GAC9B,IAAI+/E,EAAM,GACV9gJ,QAAQomB,IAAI,wBAAyB26C,GACrC,IAAK,IAAI1iE,EAAI,EAAGA,EAAI0iE,EAAM9tE,OAAQoL,IAAK,CACrC,MAAM9L,EAAOwuE,EAAM1iE,IACb,GAAEyE,EAAE,KAAE/M,EAAI,UAAE2gJ,EAAS,SAAE/3D,EAAQ,cAAE4oF,EAAa,WAAE5wB,GAAepkJ,EAQrE,GAPAuuJ,EAAI38I,KAAK,YAAYrB,KAAM/M,KAAQ2gJ,IAAY/3D,EAAW,IAAMA,EAAW,MACvE4oF,GACFA,EAAc7nK,SAAQpG,IACpB,MAAM,KAAE/G,EAAI,QAAEukJ,GAAYx9I,EAC1BwnJ,EAAI38I,KAAK,aAAarB,KAAM,CAACvQ,EAAMukJ,GAAS7gI,KAAK,WAGjD0gI,EAAY,CACd,MAAMo2B,EAAO,GACbtuF,OAAOuuF,oBAAoBr2B,GAAYj3I,SAAQutK,IAC7CF,EAAK5oK,KAAK,GAAG8oK,KAASt2B,EAAWs2B,SAGnCnsB,EAAI38I,KAAK,UAAUrB,KAAMiqK,EAAK92J,KAAK,SAIvC,OAAO6qI,EAAI7qI,KAAK,MAGX,SAASu/H,GAAQjjJ,EAAMqjJ,EAAMqxB,EAAYxxB,GAC9C,IAAIqL,EAAM,GAyBV,OAvBImmB,GAAcA,EAAWh0K,OAAS,EACpCg0K,EAAWvnK,SAAQo2I,IACbA,GAAaA,EAAU6N,MAAM1wJ,OAAS,IACxC6tJ,EAAI38I,KAAK,gBAAgB2xI,EAAUE,aAAaF,EAAU6N,MAAM1tI,KAAK,QACrE6/H,EAAU6N,MAAMjkJ,SAAQk2I,IACtBkL,EAAI38I,KACF,UAAUyxI,iBAAoBA,IAC9B,UAAUA,UAAaH,KAAcljJ,IAAOqjJ,IAC5C,UAAUA,aAAgBrjJ,IAAOqjJ,IACjC,UAAUA,WAAcrjJ,IAAOqjJ,YAK9BA,GACTkL,EAAI38I,KACF,UAAUyxI,iBAAoBA,IAC9B,UAAUA,UAAaH,KAAcljJ,IAAOqjJ,IAC5C,UAAUA,aAAgBrjJ,IAAOqjJ,IACjC,UAAUA,WAAcrjJ,IAAOqjJ,KAI5BkL,EAAI7qI,KAAK,MAYX,MAAMi3J,GACXn3J,yBAAyBo0B,GACvB,IAAKA,EAAM,OAAO,KAElB,MAAM,UAAEgjI,EAAS,cAAEC,EAAa,OAAEC,EAAM,WAAEj5B,EAAU,UAAEC,EAAS,SAAEC,EAAQ,SAAEC,EAAQ,QAAE9nI,EAAO,KAAEla,EAAI,WAAE+6K,EAAU,WAAE94B,EAAU,QAAE+4B,EAAO,UAAEC,EAAS,YAAEC,EAAW,SAAEnvI,GAAa6L,EAExK,GAAIgjI,EACF,MAAO,CACL53B,UAAW43B,EACXC,cAAAA,EACAC,OAAAA,GAIN,KAAM,eAiCRt3J,qBAAqBo0B,GACnB,OAAIwiI,KACKF,GAAqBiB,cAAcvjI,GACjC0iI,KACFH,GAAoBgB,cAAcvjI,GAGpCkiI,GAAoBqB,cAAcvjI,GAG3Cp0B,sBAAsBo0B,GACpB,OAAIwiI,KACKF,GAAqBkB,eAAexjI,GAClC0iI,KACFH,GAAoBiB,eAAexjI,GAGrCkiI,GAAoBsB,eAAexjI,I,2SGvW/B,MAAMs/H,WAAqBpvB,GAoDxCnoJ,YAAYhB,GAMViB,QAEAG,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,QAEd7nE,KAAKgiJ,WACPhiJ,KAAKgiJ,SClFF,CACLp1I,EAAG,oBACH4L,OAAQ,CACN8iK,SAAS,EACTC,eAAe,GAEjBC,UAAW,GACXC,UAAW,GACXC,iBAAkB,CAAC,YD6EnB,EAAA1qK,EAAA,GAAWhR,KAAMpB,GAEjBoB,KAAK27K,UAAYj2K,KAAKC,MACtB3F,KAAKs1K,eAAgB,EACrBt1K,KAAKw1K,WAAY,EACjBx1K,KAAK47K,aAAe,GACpB57K,KAAKgjJ,WAAa,GAElBhjJ,KAAKI,iBAAiB,SAAUgrC,IAC9BprC,KAAK8zB,IAAI,QAAS,GAAWsX,IAE1BA,IAAU,WACXprC,KAAKiQ,aAIT,MAAMi4I,EAAgBloJ,KAAKkoJ,cAAgB,IAAI3C,G3ElHK,K2EmHpD2C,EAAcpmJ,UAAY,WAC1BomJ,EAAcz5E,MAAM58D,KAAK,cACrB7R,KAAK46B,aACPstH,EAAcxrI,QAAS,EACvBwrI,EAAc9B,0BAA2B,GAG3C,IAAImtB,EAA6B,CAC/B,QAAS,aACTtzK,KAAM,QACN47K,YAAY,EACZj7I,OAAO,EACPgzI,gBAAiB,WACjBkI,cAAe,EACfnI,WAAY,YAGd,MAAMnsH,EAAOxnD,KACbuzK,EAAa,IAAIwI,MAAMxI,EAAY,CACjCt2J,IAAK,SAAS9V,EAAQ0I,EAAKrP,GAKzB,OAHA2G,EAAO0I,GAAOrP,EACdgnD,EAAKw0H,cAAczI,GACnB/rH,EAAKy0H,kBACE,KAIXj8K,KAAKk8K,YAAc,CACjBn8K,MAAOwzK,GAGTvzK,KAAKi8K,gBAAiB,EAAA7vI,GAAA,GAASpsC,KAAKm8K,gBAAgBjzK,KAAKlJ,MAAO,GAAG,GAAO,GAGxEqrJ,sBACF,MAAM,iBAAC+wB,EAAgB,mBAAE5nB,GAAsBx0J,KAC/C,QAAwBgK,IAArBoyK,EACD,OAAOA,EACF,GAAI5nB,EAEJ,CACL,MAAM,mBAAClJ,GAAsBkJ,EAAmB9M,WAChD,MAA0B,WAAvB4D,EACM,UACwB,cAAvBA,GAAwC,GAAA3+H,WAAoC,cAAvB2+H,EAGtD,aAFA,cANT,OAAO,cAaP+wB,gBACF,MAAMhxB,EAAkBrrJ,KAAKqrJ,gBAE7B,IAAI/lI,EAAgB,MADN,UAAoB+lI,EAAkB,GAGpD,OADA/lI,GAAS,cAAiB+lI,IAAoB,YAAsBrrJ,KAAK46B,WAAa,EAAI56B,KAAK27K,WACxFr2J,EAGFkuJ,gBAAgBvzK,GACrB,GAAY,UAATA,EAAkB,OAAOD,KAAKi6B,SAASzoB,IAAI,QACzC,CACH,MAAM+hK,EAAavzK,KAAKqzK,cAAc,UACtC,IAAIE,EACF,OAGF,MAAMtzK,EAAiD,WAA1BszK,EAAWI,WAA0B,QAA0C,WAA/BJ,EAAWK,gBAA+B,kBAAe5pK,EACtI,IAAI/J,EACF,OAGF,MAAM8c,EAAQ/c,KAAK2tC,YAAY25G,WAAWvqI,GAAUA,EAAM9c,OAASA,IACnE,IAAI8c,EACF,OAGF,OAAO/c,KAAKi6B,SAASzoB,IAAI,GAAKuL,EAAM8nI,UAAU7pB,SAIrCu5B,6B,0CACX,IACEv0J,KAAKs8K,mBAAoB,EACzBt8K,KAAKu8K,kBAAmB,EACxBv8K,KAAKkoJ,cAAcz5E,MAAQ,CAAC,QAAS,oBAC/BzuE,KAAKyoJ,gBACX,MAAMh7I,GACNzN,KAAK8zB,IAAInmB,MAAM,2BAA4BF,OAIlCqnJ,sB,0CAKX,OAJG90J,KAAKmoJ,uBACAnoJ,KAAKo1J,oBAGVp1J,KAAKuzJ,gBACCvzJ,KAAKo1J,mBAELp1J,KAAKu0J,gCAIHQ,4B,0CACX,IACE/0J,KAAKs8K,mBAAoB,EACzBt8K,KAAKu8K,kBAAmB,EACxBv8K,KAAKkoJ,cAAcz5E,MAAQ,CAAC,QAAS,eAC/BzuE,KAAKqoJ,oBAAmB,GAAO,GAAM,GAC3C,MAAM56I,GACNzN,KAAK8zB,IAAInmB,MAAM,0BAA2BF,OAIjC2nJ,mB,0CACX,MAAMme,EAAavzK,KAAKqzK,cAAc,SACtCE,EAAWI,WAAaJ,EAAWK,gBAAkB,WAErD,MAAM,cAAC1rB,EAAa,YAAEv6G,GAAe3tC,KAC/B4gJ,EAAQsH,EAAc/B,YAAYlG,iBAAiB,GACtDW,IACDD,GAAUC,GACVsH,EAAchB,mBAAmBv5G,OAIxB0nH,qB,0CAKX,OAJGr1J,KAAKuzJ,wBACAvzJ,KAAKo1J,oBAGVp1J,KAAKmoJ,eACCnoJ,KAAKo1J,mBAELp1J,KAAK+0J,+BAITse,cAAcpzK,GACnB,OAAOD,KAAKk8K,YAAYj8K,GAGnB+7K,cAAczI,GACnBvzK,KAAKk8K,YAAY3I,EAAWtzK,MAAQszK,EACpCvzK,KAAKgQ,cAAc,aAAcujK,GAG5BiJ,mBAAmBv8K,GACxB,IAEE,OADsBJ,MAAMsoJ,mBACAnoJ,KAAKs8K,mBAA8B,eAATr8K,GAA2BD,KAAKu8K,kBAA6B,UAATt8K,GAI1G,MAAMwN,GACN,OAAO,GAIA06I,qBACT,OAAOnoJ,KAAKw8K,mBAAmB,SAGtBjpB,sBACT,OAAOvzJ,KAAKw8K,mBAAmB,cAGtBn+H,cACT,MAAMo+H,EAAaz8K,KAAKkoJ,cAAc/B,YAAYqD,iBAAiB,GACnE,QAAQizB,MAAAA,OAAU,EAAVA,EAAYt+H,SAGXsrG,gBACT,MAAM,gBAAC4B,GAAmBrrJ,KAC1B,OAAOqrJ,IAAoB,YAAsBA,IAAoB,UAG5D19G,kB,MACT,OAA8B,QAAvB,EAAA3tC,KAAKw0J,0BAAkB,eAAE7mH,YAG3ByoI,iBAAiBnoK,EAAiBgnD,GACvCj1D,KAAKq3K,qBACLr3K,KAAK08K,cAAgBjxJ,GAAA,cAAe,KAClCzrB,KAAK08K,mBAAgB1yK,EACrBhK,KAAKs1J,OAAOrgG,KACXhnD,GAGEopK,0BACqBrtK,IAAvBhK,KAAK08K,gBACNvuK,aAAanO,KAAK08K,eAClB18K,KAAK08K,mBAAgB1yK,GAIlB+rK,aAAa8B,GAClB73K,KAAKg2D,KAAO6hH,EAEZ,MAAM,GAACrnK,GAAMqnK,EACb,GAAG73K,KAAKwQ,KAAOA,EAAI,CACjB,MAAMk4D,EAAS1oE,KAAKwQ,GACpBxQ,KAAKwQ,GAAKA,EACVxQ,KAAKgQ,cAAc,KAAMQ,EAAIk4D,IAIpBsqG,a,gDACX,MAAM2J,EAAsF,QAAzE,SAAMx5K,QAAQC,IAAIpD,KAAKovG,wBAAwB,wBAAwB,UAAE,SAC5F,GAAGpvG,KAAKypJ,YAAckzB,EACpB,OAIF38K,KAAKm2K,wBAAwB,oBAE7B,MAAMngH,EAAOh2D,KAAKg2D,KAClBh2D,KAAKqoJ,oBAAmB,IAAQryF,EAAKx9C,OAAOkY,OAAO,GAEnD,MAAM+lJ,EAAWzgH,EAAKygH,SACtBz2K,KAAK2S,SAASikK,gBAAgBe,aAAaj2K,MAAW60K,GAAO,mCAS3D,OARAv2K,KAAKu2K,GAAK,CACRE,SAAAA,EACA1rH,EAAGwrH,EAAG3vI,EACNg2I,IAAKrG,EAAGD,IACRuG,SAAUtG,EAAGE,SACb7oI,EAAG2oI,EAAG3oI,GAGD5tC,KAAK2S,SAAS2iE,WAAWC,UAAU,mBAAoB,CAC5DhhC,WAAYv0C,KAAK2S,SAASikK,gBAAgBkG,aAAa98K,KAAKwQ,IAC5DwxI,SAAUhiJ,KAAKgiJ,SACf46B,IAAK58K,KAAKu2K,GAAGqG,WAEdl7K,MAAWq7K,GAAmB,yCACzB/8K,KAAK2S,SAASikK,gBAAgBoG,mBAAmBD,QACtDlvK,OAAOJ,IACRzN,KAAK8zB,IAAInmB,MAAM,oBAAqBF,GAKpCzN,KAAKs1J,OAAO,sCAITwhB,WACL92K,KAAK8zB,IAAI,YAET9zB,KAAK+zK,uBAEL/zK,KAAKm2K,0BAEL,MAAM,WAACv7I,EAAU,cAAEy7I,EAAa,cAAEnuB,GAAiBloJ,KAE7Ci9K,EEzWK,SAA6BjnH,GAC1C,MAAMi5F,EAA6B,GAqCnC,OApCAj5F,EAAKw6F,YAAYpjJ,SAASs6I,IACxB,OAAOA,EAAW96I,GAIhB,IAAK,wBAAyB,CAC5B,MAAM,GAACgoE,EAAE,KAAEsoG,EAAI,KAAEz7B,EAAI,SAAEz1G,EAAQ,SAAEmxI,GAAYz1B,EACvC01B,EAAiB,GACpB11B,EAAWlvI,OAAO6kK,MAChBzoG,GACDwoG,EAAKvrK,KAAK,QAAQ+iE,KAAM6sE,KAEvBy7B,GACDE,EAAKvrK,KAAK,SAASqrK,MAASz7B,MAEtBiG,EAAWlvI,OAAO8kK,OACvB1oG,GACDwoG,EAAKvrK,KAAK,QAAQ+iE,KAAM6sE,KAEvBy7B,GACDE,EAAKvrK,KAAK,SAASqrK,MAASz7B,MAI7B27B,EAAKz8K,OAAS,GACfsuJ,EAAWp9I,KAAK,CACdurK,KAAAA,EACApxI,SAAAA,EACAuxI,WAAYJ,IAGhB,WAKC,CACLluB,WAAAA,EACAC,mBAAoBl5F,EAAKx9C,OAAOglK,YAAc,MAAQ,SFiUhCC,CAAoBz9K,KAAKg2D,MAE/C,GADAh2D,KAAK8zB,IAAI,yBAA0BmpJ,IAC/BA,EAAe,OAEnB,MAAMzoB,EAAqBx0J,KAAKw0J,mBAAqB,IAAI0gB,GAAuB,CAC9El/G,KAAMh2D,KACNkoJ,cAAAA,EACAp0H,IAAK9zB,KAAK8zB,IAAI6rF,WAAW,gBAGrB+nC,EAAa8M,EAAmBtJ,qBAAqB+xB,GAC3Dv1B,EAAWtnJ,iBAAiB,4BAA4B,KACtD,MAAMgrC,EAAQprC,KAAKqrJ,qBACKrhJ,IAArBhK,KAAKyxK,aAA6BrmI,IAAU,eAC7CprC,KAAKyxK,YAAc/rK,KAAKC,OAG1B3F,KAAKgQ,cAAc,QAASo7B,MAE9Bs8G,EAAWtnJ,iBAAiB,qBAAqB,KAC/Co0J,EAAmBxI,eAErBtE,EAAWtnJ,iBAAiB,gBAAiBk0B,IAC3C,MAAM,UAAC2uH,GAAa3uH,EACpBozH,EAAW5zH,IAAI,iBAAkBmvH,IAC9BA,MAAAA,OAAS,EAATA,EAAWA,YACZjjJ,KAAK09K,iBAAiBz6B,MAG1ByE,EAAWtnJ,iBAAiB,SAAUk0B,IACpC,MAAM,MAACssH,GAAStsH,EAChBozH,EAAW5zH,IAAI,UAAW8sH,GAC1B5gJ,KAAK4oJ,QAAQt0H,MAGKkgI,EAAmB7I,oBAEvC3rJ,KAAK29K,UAAY,IAAI1F,GAAar9I,EAAYy7I,GAC9Cr2K,KAAK49K,UAAY,IAAI3F,IAAcr9I,EAAYy7I,GAE/Cr2K,KAAK8zB,IAAI,cAAe9zB,MAErB46B,GACD45H,EAAmB5I,2BAGrB5rJ,KAAKurJ,oBAELvrJ,KAAK69K,sBAGCC,yBACN,MAAMC,EAAmB/9K,KAAK2tC,YAAY45G,YAAY,eACtDw2B,EAAiB57K,aAAa,YAC9B47K,EAAiBj5B,UAAYi5B,EAAiBl5B,UAAYk5B,EAGpDxyB,oBACN,GAAGvrJ,KAAKw0J,mBAAmB/I,YACzB,OAGF,MAAMC,EAAU1rJ,KAAKw0J,mBAAmBjJ,kBAAkB,CACxD/6I,GAAI,EACJwtK,YAAY,IAEdtyB,EAAQtrJ,iBAAiB,WAAYC,IACnCL,KAAKi+K,qBAAqBp2I,KAAKwoH,MAAMhwJ,EAAEsmC,UAEzC+kH,EAAQtrJ,iBAAiB,QAAQ,KAC/BJ,KAAKi8K,oBAIDgC,qBAAqBt3I,GAEpB,eADAA,EAAK,UAERA,EAAK1mC,KAAO,SACZD,KAAK8zB,IAAI,yBAA0B6S,GACnC3mC,KAAKg8K,cAAcr1I,IAKnB3mC,KAAK8zB,IAAInmB,MAAM,6BAA8Bg5B,GAK3Cw1I,kBACN,MAAM,mBAAC3nB,GAAsBx0J,KAC7B,IAAIw0J,EAAoB,OAExB,MAAM+e,EAAa,OAAH,UAAOvzK,KAAKqzK,cAAc,iBAEnCE,EAAWtzK,KAClBD,KAAK8zB,IAAI,iBAAkBy/I,GAE3B/e,EAAmBrI,oBAAoBonB,GAG5BmC,sBAAsB/uI,G,0CAKjC,MAAMvqB,EAAOyrB,KAAKC,UAAUnB,GACtB/lB,GAAM,IAAIs9J,aAAcC,OAAO/hK,IAC/B,MAACmQ,SAAevsB,KAAK29K,UAAU7E,iBAAiBl4J,GAEtD5gB,KAAK8zB,IAAI,wBAAyB9zB,KAAKwQ,GAAI4L,SACrCpc,KAAK2S,SAAS2iE,WAAWC,UAAU,0BAA2B,CAClEhhC,WAAYv0C,KAAK2S,SAASikK,gBAAgBkG,aAAa98K,KAAKwQ,IAC5Dm2B,KAAMpa,OAIHmxJ,iBAAiBU,GACtBp+K,KAAK8zB,IAAI,mBAAoBsqJ,GAC7B,MAAM,UAACn7B,EAAS,cAAE63B,GAAiBsD,EACnC,GAAqB,IAAlBtD,EACD,OAGF,MAAMxuB,EHteH,SAA2BrJ,GAChC,IAAIA,IAAcA,EAAUloB,WAAW,cACrC,OAGF,MAAM8/C,EAAY53B,EAClBA,EAAYA,EAAU7vH,OAAO,aAAazyB,QAE1C,MAAOmhJ,EAAYC,EAAWC,EAAUC,EAAUrtE,EAAI6sE,KAAS/4D,GAASu6D,EAAUvgH,MAAM,KAClF5rB,EAAI,CACR+jK,UAAAA,EACA/4B,WAAAA,EACAC,UAAAA,EACAC,SAAAA,EACAC,SAAAA,EACA9nI,QAAS,CAAEy6D,GAAAA,EAAI6sE,KAAAA,IAGjB,IAAI,IAAI11I,EAAI,EAAGA,EAAI28E,EAAM/nF,OAAQoL,GAAK,EACpC,OAAO28E,EAAM38E,IACX,IAAK,MACH+K,EAAE7W,KAAOyoF,EAAM38E,EAAI,GACnB,MAEF,IAAK,QACC+K,EAAEkkK,aACJlkK,EAAEkkK,WAAa,IAGjBlkK,EAAEkkK,WAAWpmG,GAAK8T,EAAM38E,EAAI,GAC5B,MAEF,IAAK,QACC+K,EAAEkkK,aACJlkK,EAAEkkK,WAAa,IAGjBlkK,EAAEkkK,WAAWv5B,KAAO/4D,EAAM38E,EAAI,GAC9B,MAEF,IAAK,aACH+K,EAAEorI,WAAax5D,EAAM38E,EAAI,GACzB,MAEF,IAAK,UACH+K,EAAEmkK,QAAUvyF,EAAM38E,EAAI,GACtB,MAEF,IAAK,aACH+K,EAAEokK,UAAYxyF,EAAM38E,EAAI,GACxB,MAEF,IAAK,eACH+K,EAAEqkK,YAAczyF,EAAM38E,EAAI,GAC1B,MAEF,IAAK,QACH+K,EAAEk1B,SAAW08C,EAAM38E,EAAI,GAM7B,OAAO+K,EGuaUunK,CAAkBp7B,GAMjCjjJ,KAAK01K,sBAAsB,CACzB,QAAS,aACT1yB,WAAY,CAACsJ,KAIJ0pB,c,0CACX,MAAM,SAACh0B,EAAQ,GAAExxI,EAAE,KAAEwlD,GAAQh2D,KACvBu2K,EAAKv2K,KAAKu2K,GAGhBv2K,KAAKm2K,wBAAwB,oBAC7B,MAAM,IAACtmK,EAAG,gBAAE8mK,SAAyB32K,KAAK2S,SAASikK,gBAAgBC,WAAY7gH,EAAqC4mH,IAAKrG,EAAG3vI,EAAG2vI,EAAG3oI,GAE5HmvI,QAAuB/8K,KAAK2S,SAAS2iE,WAAWC,UAAU,oBAAqB,CACnFhhC,WAAYv0C,KAAK2S,SAASikK,gBAAgBkG,aAAatsK,GACvDwxI,SAAUA,EACVs0B,IAAKC,EAAGD,IACRK,gBAAiBA,IAGnB32K,KAAKq2K,cAAgBxmK,QACf7P,KAAK2S,SAASikK,gBAAgBoG,mBAAmBD,GACvD/8K,KAAK82K,cAGA/C,uBACL,OAAG/zK,KAAKs+K,kBAA0Bt+K,KAAKs+K,kBACpCt+K,KAAKu+K,4BAAoCv+K,KAAKu+K,4BAC1Cv+K,KAAKu+K,4BAA8B,kBAA6B,yBAA0Bv+K,KAAKq2K,cAAer2K,KAAKu2K,GAAGD,KAAK50K,MAAM88K,IACtIx+K,KAAKu+K,iCAA8Bv0K,EAC5BhK,KAAKs+K,kBAAoBE,EAAW7jK,KAAK6jK,IAAe,SAAoBA,QAI/EC,sBACNz+K,KAAKw0J,mBAAmBtM,cAAcxrI,QAAS,EAC/C1c,KAAKw0J,mBAAmB5I,2BAGZ8yB,a,0CACZ1+K,KAAKw0J,mBAAmB5I,2BAExB,MAAMlE,EAAa1nJ,KAAKw0J,mBAAmB9M,WAE3C,IAAI55F,QAAe45F,EAAW6tB,eAE9Bv1K,KAAK8zB,IAAI,cAAeg6B,EAAO7tD,KAAM6tD,EAAO0gG,WACtC9G,EAAWsK,oBAAoBlkG,GAErC45F,EAAW4K,kBAAkB3mI,QAAQ67H,GAA0C,aAA1BA,EAAY1lJ,YAA0BsL,SAASo6I,IAClG,MAAMzqI,EAAQ/c,KAAKw0J,mBAAmB7mH,YAAYi9G,cAAcpD,EAAYv6I,KAC5E8P,EAAMyqI,YAAczqI,EAAM8nI,UAAU2C,YAAcA,EAClDA,EAAY1lJ,UAAY,cAG1B,MAEM6rC,EAAc3tC,KAAK2tC,YACzB,IAAI40G,EAAS50G,EAAY9wB,QAAQlC,KAAKoC,GAAUA,EAAM9P,MACtD,MAAM0xK,EAA4C,CAChD1+K,KAA4B,QAC5BuuJ,IAAK7gH,EAAYo9G,YAAY,CAC3BxI,OAAAA,EACA1lI,QAAS8wB,EAAY9wB,QAAQ8O,QAAQ5O,GAAUwlI,EAAOn7I,SAAS2V,EAAM9P,OAErE22I,UAAU,WAIR8D,EAAW0K,qBAAqBusB,GAEtC7wH,QAAe45F,EAAW6tB,qBAEpB7tB,EAAWsK,oBAAoBlkG,GAErC,MAAM2nH,EAAejB,GAAmBvmB,GAASngG,EAAO0gG,MACxDxuJ,KAAK8zB,IAAI,yBACT9zB,KAAK01K,sBAAsBD,GAE3Bz1K,KAAKy+K,yBAGAtI,wBAAwB/qI,GAC7BprC,KAAKo8K,iBAAmBhxI,EACxBprC,KAAKgQ,cAAc,QAAShQ,KAAKqrJ,iBAGxBxlJ,eACT,YAA4BmE,IAArBhK,KAAKyxK,aAA6B/rK,KAAKC,MAAQ3F,KAAKyxK,aAAe,IAAO,EAAI,EAG7EjpB,cAAcpI,GACtBvgJ,MAAM2oJ,cAAcpI,GAEpB,MAAMw+B,EAAax+B,EAAOH,iBAAiB,GAC3C,GAAG2+B,EAAY,CACb,MAAMxzI,EAAQprC,KAAKqzK,cAAc,SAG7BrzK,KAAKs8K,mBAAsBt8K,KAAKu8K,mBAClCv8K,KAAKu8K,kBAAmB,GAGvBv8K,KAAKmoJ,eACN/8G,EAAMuoI,WAAa,SACX3zK,KAAKuzJ,kBACbnoH,EAAMwoI,gBAAkB,UAG1BgL,EAAWx+K,iBAAiB,SAAS,KACnCJ,KAAKo1J,qBACJ,CAAC5tJ,MAAM,IAGT44I,EAAOoJ,iBAAiB7oJ,QACzBX,KAAK6+K,gBAIDA,gBACN,MAAMxgI,EAAUr+C,KAAKq+C,QACrBr+C,KAAKgQ,cAAc,QAASquC,GAEdr+C,KAAKqzK,cAAc,SAC3BzyI,MAAQyd,EAGTw1G,cACL,OAAO7zJ,KAAKooJ,oBAAmB,GAAM1mJ,MAAK,KACxC1B,KAAKupJ,WACLvpJ,KAAK6+K,mBAIIvpB,OAAOgiB,EAA6CwH,G,0CAC/D,IAAG9+K,KAAKypJ,YAIRzpJ,KAAKs3K,cAAgBA,EACrBt3K,KAAK8zB,IAAI,SAAUwjJ,GACnBt3K,KAAKm2K,wBAAwB,WAE1Bn2K,KAAKw0J,oBACNx0J,KAAKw0J,mBAAmB1I,0BAAyB,GAGhDwrB,IAAkBwH,GAAuB,CAC1C,IAAIC,GAAW,EACf,IAAI,MAAM9+K,KAAQD,KAAKk8K,YAAa,CAClC,MAAM3I,EAAavzK,KAAKk8K,YAAYj8K,GACpC8+K,EAAqC,WAA1BxL,EAAWI,YAA0D,WAA/BJ,EAAWK,iBAAgCmL,QAGxF/+K,KAAK2S,SAASikK,gBAAgBoI,YAAYh/K,KAAKwQ,GAAIxQ,KAAK6F,SAAUyxK,EAAeyH,OAInFE,aAAaC,GACnB,MAAMj7B,EAA4Ci7B,EAAOj7B,aAAatpI,KAAKq6J,GAClE,OAAP,wBACKA,GAAW,CACd,WAAYA,EAAYC,kBAS5B,MAL0B,CACxB,cAAeiK,EAAOrK,cACtB,gBAAiB5wB,GAMbk7B,qBAAqBx4I,GAC3B3mC,KAAK2tC,YAAY28G,QAAQ,CACvB7H,UAAW,CACTG,IAAKj8G,EAAKi8G,IACVD,MAAOh8G,EAAKg8G,MACZG,aAAcn8G,EAAKm8G,aACnB,YAAY,GAEd3lH,MAAOn9B,KAAKi/K,aAAat4I,EAAKxJ,OAC9BzM,MAAOiW,EAAKjW,MAAQ1wB,KAAKi/K,aAAat4I,EAAKjW,YAAuB1mB,EAClEyqK,WAAY9tI,EAAK8tI,WAAaz0K,KAAKi/K,aAAat4I,EAAK8tI,iBAA4BzqK,IAI7Eo1K,aAAa3J,GACfz1K,KAAK46B,YACP,CAAC66I,EAAa/kJ,MAAO+kJ,EAAahB,YAAY9oJ,OAAO6kB,SAASpjC,SAAS02I,IACrE,MAAMG,EAAeH,EAAMG,aACrB5lI,EAAM4lI,EAAa3lI,WAAW02J,GAAqC,QAArBA,EAAYvxK,OAC1D47K,EAAiBp7B,EAAa5lI,GAC9BihK,EAASr7B,EAAa3lI,WAAW02J,IAAe,MAAC,QAAuB,QAAtB,EAAAA,EAAY3wB,kBAAU,eAAEk7B,OAAQF,EAAe7uK,MACvGszI,EAAMG,aAAe,CAACA,EAAa5lI,GAAM4lI,EAAaq7B,OAK/CE,uBAAuB74I,G,0CAClC3mC,KAAK8zB,IAAI,yBAA0B9zB,KAAM2mC,GAEzC,MAAM,WAAC+gH,EAAU,YAAE/5G,GAAe3tC,KAAKw0J,mBAEvC,OAAO7tH,EAAK,UACV,IAAK,eAAgB,CACnB3mC,KAAK8zB,IAAI,qBAAsB6S,GAE/B3mC,KAAKo/K,aAAaz4I,GAClB3mC,KAAKm/K,qBAAqBx4I,GAE1B,MAAM84I,EAAqB9K,GAClBA,EAAWh6J,KAAK6oI,IACd,CACL52I,EAAG,uCACH82I,UAAWF,EAAUE,UACrBD,QAASD,EAAU6N,MAAM12I,KAAKqgH,IAAYA,QAKlC,CACZgvB,GAAa,SAAUrjH,EAAKxJ,MAAMmmH,MAClC38G,EAAKjW,MAAQs5H,GAAa,QAASy1B,EAAkB94I,EAAKjW,MAAMikJ,kBAAe3qK,EAC/E28B,EAAK8tI,WAAazqB,GAAa,aAAcy1B,EAAkB94I,EAAK8tI,WAAWE,kBAAe3qK,GAC9F2hB,OAAO6kB,SAEHpjC,SAASk2I,IACb,IAAIvmI,EAAQ4wB,EAAYk9G,iBAAiBvH,EAAKtoB,QAC9C,GAAGj+G,EACD,OAGF,MAAM2iK,EAAgB/xI,EAAY+8G,sBAAsBpH,EAAKrjJ,MAAM,GACnE8c,EAAQ,IAAI2sI,GAAgBg2B,EAAczyK,IAAKq2I,EAAKrjJ,MACpD8c,EAAM5a,aAAa,YACnBu9K,EAAc76B,UAAY9nI,EAE1B4wB,EAAY68G,eAAeztI,EAAOumI,EAAKF,cAAgBE,EAAKtoB,WAG9Dh7H,KAAK89K,yBAEL,MAAMl6B,EAAW5jJ,KAAKw1K,UACtBx1K,KAAKw1K,WAAY,EAEjB,IAAIjzB,EAAS50G,EAAY9wB,QAAQlC,KAAKoC,GAAUA,EAAM9P,MACtD,MAAM0xK,EAA4C,CAChD1+K,KAAM2jJ,EAAW,SAAW,QAC5B4K,IAAK7gH,EAAYo9G,YAAY,CAC3BxI,OAAAA,EACA1lI,QAAS8wB,EAAY9wB,QAAQ8O,QAAQ5O,GAAUwlI,EAAOn7I,SAAS2V,EAAM9P,OAErE22I,UAAWA,KAIf5jJ,KAAK8zB,IAAI,eAAgB6qJ,EAAenwB,WAElC9G,EAAW0K,qBAAqBusB,SAEhC3+K,KAAK2/K,yBAEP/7B,UACI5jJ,KAAK0+K,cAGb,MAGF,IAAK,aACH,IAAI,MAAMz7B,KAAat8G,EAAKq8G,WAAY,CACtC,MAAM3zI,EAA4BurK,GAAcgF,kBAAkB38B,GAClE5zI,EAAKyrK,cAAgB,EACrB,MAAMsD,EAAe,IAAIyB,gBAAgBxwK,GACzCrP,KAAKgjJ,WAAWnxI,KAAKusK,SAGjBp+K,KAAK2/K,yBACX,MAGF,QACE3/K,KAAK8zB,IAAInmB,MAAM,8BAA+Bg5B,OAKvCg5I,yB,0CACX,MAAM,mBAACnrB,GAAsBx0J,KAC7B,IAAIw0J,EACF,OAGF,MAAM,WAAC9M,GAAc8M,EACrB,GAAG9M,EAAW0tB,kBAAmB,CAC/B,MAAM3rK,EAA4BzJ,KAAKgjJ,WAAWroI,KAAKsoI,GAAcjjJ,KAAK8/K,gBAAgBp4B,EAAYzE,KACtGjjJ,KAAKgjJ,WAAWriJ,OAAS,QAEnBwC,QAAQC,IAAIqG,QAElBzJ,KAAK8zB,IAAI,4BAICgsJ,gBAAgBp4B,EAA+BzE,G,0CAC3DjjJ,KAAK8zB,IAAI,oBAAqBmvH,GAC9B,UAEQyE,EAAWo4B,gBAAgB78B,GACjCjjJ,KAAK8zB,IAAI,kBAAmBmvH,GAC5B,MAAM5iJ,GACNL,KAAK8zB,IAAInmB,MAAM,oBAAqBs1I,EAAW5iJ,OAIrCw9K,sB,0CACZ,MAAM,UAACF,GAAa39K,KACpB,IAAI29K,EAEF,YADA39K,KAAK8zB,IAAI21C,KAAK,0DAKhB,IADezpE,KAAK47K,aAAaj7K,OAE/B,OAGF,MAAM+d,EAAQ1e,KAAK47K,aAAal7K,QAChCV,KAAK47K,aAAaj7K,OAAS,EAE3B,IAAI,MAAMgmC,KAAQjoB,EAAO,CACvB,MAAMqhK,QAAsBpC,EAAUhE,iBAAiBhzI,GACvD,IAAIo5I,EACF,SAKF,MAAM3uJ,GAAM,IAAI4uJ,aAAcC,OAAOF,GACrC,IACE,MAAMG,EAAmCr4I,KAAKwoH,MAAMj/H,GACpDpxB,KAAK8zB,IAAI,sCAAuCosJ,GAChDlgL,KAAKw/K,uBAAuBU,GAC5B,MAAMzyK,GACNzN,KAAK8zB,IAAInmB,MAAM,uBAAwByjB,GACvCpxB,KAAKs1J,OAAO,oCACZ,iBAA8B,eAAgBt1J,KAAK+xK,yBAKlDiF,+BAA+BrwI,GACpC3mC,KAAK47K,aAAa/pK,KAAK80B,GACvB3mC,KAAK69K,uBG9yBM,MAAMsC,GAenBvgL,YACU+S,GAAA,KAAAA,SAAAA,EAyCF,KAAAytK,QAAU,KAChBpgL,KAAK6wK,eAAe7wK,KAAK47J,WAxCzB,MAAM3yJ,EAAiBjJ,KAAKiJ,eAAiB,IAAI,IAEjDA,EAAe5J,IAAI,GAAnB4J,CAAoC,YAAY,EAAE2yJ,SAAAA,MAC5C57J,KAAK47J,UACP57J,KAAK6wK,eAAejV,MAIxB3yJ,EAAe5J,IAAI,GAAnB4J,CAAoC,aAAc2yJ,IAC7C57J,KAAK47J,WAAaA,GACnB57J,KAAK6wK,eAAejV,MAIxB3yJ,EAAe5J,IAAI,GAAnB4J,CAAyC,YAAa2yJ,IACpD57J,KAAK6wK,eAAejV,MAGtB3yJ,EAAe5J,IAAI,IAAnB4J,CAA8B,qBAAsB0mJ,IAClD,MAAMiM,EAAW,GAAAjM,WACdiM,MAAAA,OAAQ,EAARA,EAAUprJ,MAAOm/I,EAAUn/I,IAC5BxQ,KAAK6wK,eAAejV,MAIxB3yJ,EAAe5J,IAAIkmJ,GAAcO,kBAAjC78I,CAAoD,aAAa,EAAE48I,WAAAA,EAAY5lJ,KAAAA,MAC7E,MAAM,MAACogL,GAASrgL,KAChB,IAAI6lJ,EAAWllJ,SAAW0/K,EAAiC,OAE3D,IAAI79K,EAAM,EACV,IAAI,IAAIuJ,EAAI,EAAGA,EAAI85I,EAAWllJ,SAAUoL,EAAG,CACzC,MAAM,KAAC9L,EAAI,MAAEO,GAASqlJ,EAAW95I,GACjCvJ,EAAMhC,EAAQgC,EAAMhC,EAAQgC,EAG9B69K,EAAM1Z,aAAankK,MAQf89K,uBACFtgL,KAAK47J,WACT57J,KAAK0kE,OAAO/xC,YAAc,GAEvB3yB,KAAKugL,qBACNvgL,KAAKugL,mBAAmBh3J,SACxBvpB,KAAKugL,wBAAqBv2K,GAG5BhK,KAAK47J,cAAW5xJ,EAChBhK,KAAKwgL,uBAAuB7wK,aAGtBkhK,eAAejV,GAClB57J,KAAKyoB,YACNzoB,KAAKyoB,YACLzoB,KAAKyoB,eAAYze,GAGnB,MAAMy2K,EAAqBzgL,KAAK47J,WAAaA,EAC1C6kB,IACDzgL,KAAKsgL,uBAELtgL,KAAK47J,SAAWA,EAChB57J,KAAKwgL,uBAAyB,IAAI,IAElCxgL,KAAKwgL,uBAAuBnhL,IAAIu8J,EAAhC57J,CAA+D,QAASA,KAAKogL,SAE1ExkB,aAAoB9I,GACrB9yJ,KAAKugL,mBAAqBvgL,KAAKywK,sBAE/BzwK,KAAKugL,mBAAqBvgL,KAAK0gL,gBAC/B1gL,KAAKwgL,uBAAuBnhL,IAAIu8J,EAAhC57J,CAA0C,QAASA,KAAKogL,UAG1DpgL,KAAKkB,UAAU9B,UAAUoE,OAAO,YAAao4J,aAAoB9I,MAGnE,MAAMz0G,EAAUr+C,KAAK47J,SAASv9G,QAC9B,IAAIjT,EAAQwwH,aAAoB9I,GAAoB8I,EAASxwH,MAlHjE,SAAsCA,EAAmBiT,GACvD,OAAOjT,GACL,KAAK,WACL,KAAK,UACH,OAAO,UACT,KAAK,aACH,OAAOiT,EAAU,SAAyB,WAC5C,QACE,OAAO,eA0G4DsiI,CAA6B/kB,EAASvQ,gBAAiBhtG,GAE5H,MAAM,MAACgiI,GAASrgL,KAEhBqgL,EAAM5Z,oBAEN,MAAMh3G,EAAWrkB,IAAU,YACtBtsC,SAAS8rC,KAAKxrC,UAAUiG,SAAS,eAAiBo7K,GAAuBhxH,KACzEA,GACD4wH,EAAM1Z,aAAa,IAGrB,QAAc7nK,SAAS8rC,KAAM,cAAe6kB,EAAU,IAAKA,EAAW,KACpE4wH,EAAMzZ,uBAEN5mK,KAAKsgL,6BACJt2K,IAGFylD,IAIH4wH,EAAM9Z,gBAAgBn7H,GAAO,GAe7BprC,KAAK4P,SAASgsJ,GACd57J,KAAKmxK,eAAevV,GACpB57J,KAAK4gL,4BAA4Bp0I,UAAU6R,IAGrC8yH,eAAevV,GACrB,OAAO57J,KAAKugL,mBAAmBloJ,OAAOujI,GAGhChsJ,SAASgsJ,GACf,GAAGA,aAAoB9I,GACrB,OAAO9yJ,KAAKwwK,eAAen4I,OAAOujI,IAElC,EAAAhuJ,EAAA,GAAe5N,KAAK0kE,OAAQ,IAAIpsC,GAAU,CAAC/rB,OAAQqvJ,EAASmW,mBAAmBl3J,aAAazQ,SAIxFqe,YACN,MAAM,eAACxf,GAAkBjJ,KACnBkB,EAAYlB,KAAKkB,UAAYpC,SAASC,cAAc,OAC1DmC,EAAU9B,UAAUC,IAAI,iBAAkB,yBAE1C,MAAMsH,EAAO7H,SAASC,cAAc,OACpC4H,EAAKvH,UAAUC,IAAI,oBAEnB,MAAMuhL,EAA8B5gL,KAAK4gL,4BAA8B,IAAIlP,GAErE5jF,EAAO,IACbA,EAAKpuF,OAAOkhL,EAA4B1/K,WACxCyF,EAAKjH,OAAOouF,GAEZ,MAAM+yF,GAAqB,EAAAv5I,GAAA,IAAS,KAClCtnC,KAAK47J,SAAS/H,gBACb,KAAK,IAER,QAAiB/lE,GAAOztF,KACtB,EAAA4nB,EAAA,GAAY5nB,GACZwgL,MACC,CAAC53K,eAAAA,IAEJ,MAAMy7D,EAAS1kE,KAAK0kE,OAAS5lE,SAASC,cAAc,OACpD2lE,EAAOtlE,UAAUC,IAAI,sBAErBW,KAAKwwK,eAAiB,IAAItD,GAAsBxoG,GAChD1kE,KAAKywK,qBAAuB,IAAIzD,GAA4BrmK,GAE5D3G,KAAK0gL,gBAAkB,IAAIlP,GAAuB7qK,GAElD,MAAM2+B,EAAQxmC,SAASC,cAAc,OACrCumC,EAAMlmC,UAAUC,IAAI,qBAEpB,MAAMw4B,EAAM,EAAW,kBACvByN,EAAM5lC,OAAOm4B,IAEb,QAAiBA,GAAMx3B,KACrB,EAAA4nB,EAAA,GAAY5nB,GAEZ,MAAM,SAACu7J,GAAY57J,KACf47J,IAIDA,aAAoB9I,GACrB8I,EAAStG,SAETsG,EAAStG,OAAO,mCAEjB,CAACrsJ,eAAAA,KAEJ,QAAiB/H,GAAW,KAC1B,GAAGlB,KAAK47J,oBAAoB9I,GAAmB,CAC7C,GAAG,cAAuByZ,IAAgB5rK,OACxC,QAGF,IAAI4rK,IAAiBr9H,YAChB,GAAGlvC,KAAK47J,oBAAoBub,GAAc,CAE/C,GADe,cAAuBvF,IAC5Bx/J,MAAM2zG,GAAUA,EAAM0sD,oBAAsBzyK,KAAK47J,WACzD,OAGF,IAAIgW,GAAU5xK,KAAK47J,UAAU1sH,UAE9B,CAACjmC,eAAAA,IAEJ/H,EAAUxB,OAAOiH,EAAM+9D,EAAQp/B,GAE/B,MAAM+6I,EAAQrgL,KAAKqgL,MAAQ,IAAIxb,GACzBic,EAAiBT,EAAM7vJ,OAAO,qBACpCtvB,EAAU2C,QAAQi9K,GAElBhiL,SAASstD,eAAe,iBAAiBvoD,QAAQ3C,GACjDm/K,EAAM5Z,qB,4UC6ZV,MAAMsa,GAAyB,IA3nBxB,MAAP,cAEU,KAAAC,mBAA6D,GAC7D,KAAAC,kBAAoB,EACpB,KAAAC,mBAAqB,EACrB,KAAAC,aAAwC,GACxC,KAAAC,eAAiB,KAIjB,KAAAC,UAA6BviL,SAAS8tC,KAAK1nC,cAAc,oBAEzD,KAAAo8K,YAAcxiL,SAASgQ,MACvB,KAAAyyK,cAAe,EAMf,KAAAC,SAAU,EAIV,KAAAlqG,SAAiC,GAGjC,KAAAmqG,YAAa,EAyad,KAAAC,oBAAsB,KAC3B,MACMj4K,EADO,CAAC,mBAAoB,gBAAiB,mBAAoB,mBAAoB,iBACrEkR,KAAI,SAE1BxX,QAAQC,IAAIqG,GACX/H,MAAMigL,IAOL,GANA3hL,KAAKs3E,SAASsqG,UAAYD,EAAY,GACtC3hL,KAAKs3E,SAAS8/D,YAA4BptI,IAAnB23K,EAAY,GAAmB,GAAMA,EAAY,GACxE3hL,KAAKs3E,SAASuqG,UAAYF,EAAY,GACtC3hL,KAAKs3E,SAASwqG,UAAYH,EAAY,GACtC3hL,KAAKs3E,SAASyqG,OAASJ,EAAY,GAEhC3hL,KAAKyhL,WAAY,CAClB,MAAMO,GAAYhiL,KAAKs3E,SAASyqG,SAAW/hL,KAAKs3E,SAASsqG,WAAaK,GAAA,sBAAiC,EAEpGD,MADuC,IAA1BhiL,KAAKkiL,oBAEhBF,EACDC,GAAA,oBAEAA,GAAA,uBAKNA,GAAA,oBAA8BjiL,KAAKs3E,aAGrC,gBAA2B51E,MAAM0pC,IAC/BprC,KAAKs3E,SAAS6qG,SAAW/2I,EAAMksC,SAASjwB,cAAcgnC,UAwBlD,KAAA+zF,kBAAoB,KAC1BC,aAAaD,oBACbt8K,OAAOO,oBAAoB,QAASrG,KAAKoiL,oBA1d3C35J,UAAU9V,GACR3S,KAAK2S,SAAWA,EAEhB6I,UAAUupB,QAAUvpB,UAAUupB,SAAYvpB,UAAkB8mK,YAAe9mK,UAAkB+mK,cAC7FviL,KAAKwiL,YAAehnK,UAAkBgnK,aAAgBhnK,UAAkBgnK,YAAYt5K,KAAKsS,WACzFxb,KAAKwiL,aAAexiL,KAAKwiL,YAAY,GAErCxiL,KAAKyiL,uBAA0B,iBAAkB38K,QAAY,oBAAqB0V,UAElFxb,KAAK0iL,cAAgB5jL,SAASC,cAAc,OAC5CiB,KAAK0iL,cAAclyK,GAAK,eACxB1R,SAAS8rC,KAAKlrC,OAAOM,KAAK0iL,eAE1B1iL,KAAK2iL,qBAAsB,UAE3BC,GAAA,mBAAgC,eAAe,KAC7C5iL,KAAK+C,UAGP6/K,GAAA,mBAAgC,aAAa,KACxC5iL,KAAKwhL,SACNxhL,KAAK0qB,WAIT2wF,GAAA,mBAAgC,UAAWwnE,IACtC7iL,KAAKwhL,UAIJqB,GACF7iL,KAAK+K,QAGP/K,KAAK8iL,oBAGP,qBAA2B,sBAAuBC,IAChD/iL,KAAKgjL,WAAWD,MAGlB,qBAA2B,uBAAwB3xJ,IACjDpxB,KAAKooB,OAAOgJ,MAGXpxB,KAAKwiL,aACN,qBAA2B,iBAAkBp2F,IAC1B,IAAdA,EAAO57E,IACRxQ,KAAKwiL,YAAYp2F,EAAO62F,qBAAqBjiL,SAKnDihL,GAAA,yBAAmC,aAAciB,IAC/CljL,KAAKyhL,YAAa,EACdzhL,KAAKs3E,SAASsqG,WAAc5hL,KAAKs3E,SAASyqG,OAO5C/hL,KAAKmjL,iBAAiBD,GANnBA,EACDljL,KAAKojL,eAAeF,GAEpBjB,GAAA,uBAMNA,GAAA,yBAAmC,kBAAmBiB,IACpDljL,KAAKojL,eAAeF,MAEtBjB,GAAA,yBAAmC,oBAAqBiB,IACtDljL,KAAKmjL,iBAAiBD,MAGxB,qBAA2B,uBAAuB,KAEhDljL,KAAK2iL,oBAAoB59K,YACxB,CAACyC,MAAM,IAEVy6K,GAAA,yBAAmC,2BAA4BoB,IAC7D,GAA+B,kBAA5BA,EAAiBr/H,OASlB,OAGF,GAA+B,WAA5Bq/H,EAAiBr/H,OAelB,YAdAhkD,KAAK2S,SAAS2iE,WAAWC,UAAU,6BAA8B,CAC/D3jB,OAAQ,QACPlwD,MAAK,SAeV,MAAM6K,EAAS82K,EAAiBC,QAAUD,EAAiBC,OAAO/2K,OAAOsO,WACzEnN,QAAQomB,IAAI,QAASuvJ,EAAkB92K,GACpCA,GACDvM,KAAK2iL,oBAAoBjhL,MAAK,IAAW,mCACpC2hL,EAAiBC,OAAOl1J,oBACfpuB,KAAK2S,SAASoH,gBAAgBwpK,QAAQF,EAAiBC,OAAOl1J,cAIvE7hB,EAAO46B,kBAAoBnnC,KAAK2S,SAAS2I,gBAAgBkoK,QAAQj3K,KAIpE,gBAA0B,CACxBA,OAAAA,EACA+2D,WAAW,EAAAonD,GAAA,IAAmB24D,EAAiBC,OAAO77I,kBAOnDg8I,mBAAkB,QAACp2K,EAAO,SAAEq2K,EAAQ,aAAEC,EAAY,uBAAEC,I,0CAM/D,MAAMr3K,EAASc,EAAQd,OACjBkpC,EAAYlpC,EAAOkpC,YACnBouI,EAA8B,GAC9Bd,QAAmB/iL,KAAK2S,SAAS2/B,gBAAgBwxI,cAAcv3K,GACrE,IAAIw3K,EAEJ,GAAGH,EAAuB/1F,eACxB,GAAiB,YAAdxgF,EAAQT,GAAmBS,EAAQ2qB,UAAY0rJ,EAAW,EAC3DK,EAAsB,YAAY,2BAA2B,EAAM,CAACL,SAIpE,GAFAK,QAA4B9sH,GAAoB5pD,OAASrD,OAAWA,GAAW,GAE5E25K,EAAc,CACf,MAAM93I,EAA4E,+BAC5Ez8B,EAA2B,EAC/B,EAAAs6F,GAAA,GAASi6E,EAAa5oI,UACtBgpI,GAOFA,EAAsB,YAAYl4I,GAAa,EAAMz8B,SAIzD20K,EAAsB,YAAY,qBAAqB,GAGtDJ,IACDE,EAAaG,aAAc,EAC3BH,EAAaj2D,QAAS,GAGxB,MAAMq2D,EAAyBN,GAAe,EAAA7qI,GAAA,GAAU6qI,EAAa5iF,SAAW1zF,EAAQC,OACxFu2K,EAAa/0K,YAAc,EAAA+pB,GAAA,GAAatsB,GAAQ,OAAMvC,OAAWA,EAAWhK,KAAK2S,UAC9E8iC,GAAawuI,IAA2B52K,EAAQd,SACjDs3K,EAAa/0K,aAAc,EAAA+pB,GAAA,GAAaorJ,GAAwB,OAAMj6K,OAAWA,EAAWhK,KAAK2S,WAC/F,MACAkxK,EAAa/0K,OAGjB+0K,EAAa/0K,OAAQ,EAAAo0B,GAAA,GAAc2gJ,EAAa/0K,OAEhD+0K,EAAa/tH,QAAU,KACrB,gBAA0B,CAACvpD,OAAAA,EAAQ+2D,UAAWj2D,EAAQJ,OAGxD42K,EAAax2K,QAAU02K,EACvBF,EAAah0K,IAAM,MAAQxC,EAAQJ,IACnC42K,EAAapxC,IAAMswC,EACnBc,EAAaj2D,QAAS,EAEtB,MAAMs2D,QAAkBlkL,KAAK2S,SAAS2/B,gBAAgByO,aAAax0C,GAChE23K,EACDlkL,KAAK2S,SAASuuC,kBAAkBijI,WAAW53K,EAAQ23K,EAAW,eAAexiL,MAAM4kB,KAE9EjZ,EAAQmL,OAAOksG,QAAUi/D,KAC1BE,EAAaz8J,MAAQd,EACrBtmB,KAAKqpB,OAAOw6J,OAIhB7jL,KAAKqpB,OAAOw6J,MAIRf,cAAc/1H,EAASsuD,GAAA,UAC7B,GAAG,GAAAtoB,UAAW,OAEd,MAAMqxF,EAAcC,IAClBrkL,KAAKuhL,cAAe,EACpBziL,SAASgQ,MAAQ9O,KAAKshL,YACtBthL,KAAKskL,cAGPx+K,OAAOmjD,cAAcjpD,KAAKukL,eAC1BvkL,KAAKukL,cAAgB,EAEjBx3H,EAGF/sD,KAAKukL,cAAgBz+K,OAAO8hD,aAAY,KACtC,MAAM76C,EAAQ/M,KAAKkhL,mBACnB,GAAIn0K,EAEG,GAAG/M,KAAKuhL,aACb6C,QACK,CACLpkL,KAAKuhL,cAAe,EACpBziL,SAASgQ,MAAQ,YAAY,uBAAuB,EAAM,CAAC/B,IASzD,MAAM/J,EAASlE,SAASC,cAAc,UACtCiE,EAAOzB,MAAQ,GAAKuE,OAAOoa,iBAC3Bld,EAAOxB,OAASwB,EAAOzB,MAEvB,MAAMkqB,EAAMzoB,EAAO6P,WAAW,MAC9B4Y,EAAI83I,YACJ93I,EAAI+4J,IAAIxhL,EAAOzB,MAAQ,EAAGyB,EAAOxB,OAAS,EAAGwB,EAAOzB,MAAQ,EAAG,EAAG,EAAIoB,KAAKq+B,IAAI,GAC/EvV,EAAI4wD,UAAY,UAChB5wD,EAAI+oC,OAEJ,IAAIiwH,EAAW,GACXrzJ,EAAM,GAAKrkB,EACZA,EAAQ,GACT03K,EAAW,GACH13K,EAAQ,IAChB03K,EAAW,IAEXrzJ,EAAM,MACNqzJ,EAAW,IAGbA,GAAY3+K,OAAOoa,iBAEnBuL,EAAImG,KAAO,OAAO6yJ,OAAc1yJ,KAChCtG,EAAIi5J,aAAe,SACnBj5J,EAAIk5J,UAAY,SAChBl5J,EAAI4wD,UAAY,QAChB5wD,EAAIm5J,SAASxzJ,EAAKpuB,EAAOzB,MAAQ,EAAmB,MAAhByB,EAAOxB,QAK3CxB,KAAKskL,WAAWthL,EAAOgtB,kBA9CzBhwB,KAAK8iL,eAAc,KAiDpB,KAtDHsB,IA0DIE,WAAWpuH,EAAe,0BAChC,GAAGl2D,KAAK6kL,cAAgB3uH,EACtB,OAGF,MAAMrnB,EAAO7uC,KAAKqhL,UAAUt9K,YAC5B8qC,EAAKqnB,KAAOA,EACZl2D,KAAKqhL,UAAUnyH,WAAW41H,aAAaj2I,EAAM7uC,KAAKqhL,WAClDrhL,KAAKqhL,UAAYxyI,EAEjB7uC,KAAK6kL,YAAc3uH,EAGd7sC,OAAOsd,GAGZ,GAAG3mC,KAAKwhL,QACN,OAkBU76I,EAAKvf,QACfuf,EAAKvf,MAAQ,sCAIXuf,EAAKq9I,eACLhkL,KAAKkhL,mBAGLlhL,KAAKukL,eACPvkL,KAAK8iL,gBAGP,MAAMzkK,IAAQre,KAAKihL,kBACbpxK,EAAM82B,EAAK92B,KAAO,IAAMwO,EAC9Bre,KAAKghL,mBAAmBnxK,IAAO,EAE/B,MAAMlK,GAAM,EAAA6pI,GAAA,KAYZ,GAXGxvI,KAAKs3E,SAAS8/D,OAAS,IAAMp3I,KAAKs3E,SAAS6qG,UAO5CniL,KAAK+kL,UAAU/kL,KAAKs3E,SAAS8/D,QAC7Bp3I,KAAKmhL,aAAax6I,EAAK8rG,KAAO9sI,IAG5B3F,KAAKyiL,wBACP,iBAAkB38K,QAAsC,YAA5Bu8K,aAAa2C,WACzC,OAAO,EAGT,GAAGhlL,KAAKs3E,SAASsqG,UACf,OAAG5hL,KAAKohL,iBAAmBphL,KAAKs3E,SAASuqG,eACvCrmK,UAAUupB,QAAQ,CAAC,IAAK,IAAK,WAI/B,EAGF,IAAI8+I,EAEJ,GAAG,iBAAkB/9K,OAArB,CACE,IACE,GAAG6gC,EAAK8rG,IACN,IAAI,IAAI1mI,KAAK/L,KAAKghL,mBAAoB,CACpC,MAAM6C,EAAe7jL,KAAKghL,mBAAmBj1K,GACjB,kBAAnB,GAAgC83K,EAAapxC,MAAQ9rG,EAAK8rG,MACjEoxC,EAAapnD,QAAS,GAK5BonD,EAAe,IAAIxB,aAAa17I,EAAK73B,MAAO,CAC1C7P,KAAM0nC,EAAKvf,OAAS,GACpBwjB,KAAMjE,EAAKt5B,SAAW,GACtBolI,IAAK9rG,EAAK8rG,KAAO,GACjB7kB,OAAQjnF,EAAKinF,SAAU,IAIzB,MAAMvtH,GAGN,OAFAL,KAAKyiL,wBAAyB,OAC9BR,GAAA,wCAgBJ4B,EAAa/tH,QAAU,KACrB+tH,EAAa50K,QACbg2K,GAAA,UACAjlL,KAAK+K,QACF47B,EAAKmvB,SACNnvB,EAAKmvB,WAIT+tH,EAAaqB,QAAU,KACjBrB,EAAapnD,gBACRz8H,KAAKghL,mBAAmBnxK,GAC/B7P,KAAK+K,UAIN84K,EAAa30I,MACd20I,EAAa30I,OAEflvC,KAAKghL,mBAAmBnxK,GAAOg0K,EAE3B,GAAA9wF,WACF3sF,YAAW,KACTpG,KAAKs2C,KAAKzmC,KACT,MAoCAs1K,mBACL,OAAOnlL,KAAKs3E,SAGNhhC,KAAKzmC,GACX,MAAMg0K,EAAe7jL,KAAKghL,mBAAmBnxK,GAC7C,GAAGg0K,GAAyC,kBAAnB,EACvB,IACKA,EAAa50K,QACd40K,EAAapnD,QAAS,EACtBonD,EAAa50K,SAEf,MAAM5O,KAIL2iL,WAAWvwC,UACTzyI,KAAKmhL,aAAa1uC,GAQpBsyC,UAAU3tC,GACf,MAAMzxI,GAAM,EAAA6pI,GAAA,KACZ,GAAGxvI,KAAKolL,aAAez/K,EAAM3F,KAAKolL,aAAeplL,KAAKqlL,kBAAoBjuC,EACxE,OAGFp3I,KAAKolL,YAAcz/K,EAAM,IACzB3F,KAAKqlL,gBAAkBjuC,EACvB,MAAMkuC,EAAW,gCACXnoJ,EAAQr+B,SAASC,cAAc,SACrCo+B,EAAM77B,UAAW,EACjB67B,EAAM39B,aAAa,kBAAmB,gBACtC29B,EAAMi6G,OAASA,EACfj6G,EAAM74B,UAAY,wBACDghL,6FACuD,IAATluC,WAAsBkuC,cAErFtlL,KAAK0iL,cAAchjL,OAAOy9B,GAE1BA,EAAM/8B,iBAAiB,SAAS,KAC9B+8B,EAAM78B,WACL,CAACkH,MAAM,IAGL4gB,OAAOvY,GACZ,MAAMg0K,EAAe7jL,KAAKghL,mBAAmBnxK,GAC7C,GAAGg0K,EAAc,CACZ7jL,KAAKkhL,mBAAqB,KACzBlhL,KAAKkhL,mBAGT,IAC8B,kBAAnB,GAAgC2C,EAAa50K,QACpD40K,EAAapnD,QAAS,EACtBonD,EAAa50K,SAKf,MAAM5O,WAEDL,KAAKghL,mBAAmBnxK,IAI5B9E,QAIH,IAAI,MAAMgB,KAAK/L,KAAKghL,mBAAoB,CACtC,MAAM6C,EAAe7jL,KAAKghL,mBAAmBj1K,GAC7C,IAC8B,kBAAnB,GAAgC83K,EAAa50K,OACpD40K,EAAa50K,QAEf,MAAM5O,KAGZL,KAAKghL,mBAAqB,GAC1BhhL,KAAKkhL,mBAAqB,EAE1Be,GAAA,gCAGKv3J,QAKL,GAJA1qB,KAAK0hL,sBACL,qBAA2B,mBAAoB1hL,KAAK0hL,qBACpDO,GAAA,iBAEIjiL,KAAKyiL,uBACP,OAAO,EAGN,iBAAkB38K,QAAsC,YAA5Bu8K,aAAa2C,YAAwD,WAA5B3C,aAAa2C,YACnFl/K,OAAO1F,iBAAiB,QAASJ,KAAKoiL,mBAGxC,IACK,mBAAoBt8K,QACrBA,OAAO1F,iBAAiB,eAAgBJ,KAAK+K,OAE/C,MAAM1K,KAGF0C,OACN/C,KAAK+K,QACLjF,OAAOmjD,cAAcjpD,KAAKukL,eAC1BvkL,KAAKukL,cAAgB,EACrBvkL,KAAKskL,aACLtkL,KAAKwhL,SAAU,EAGT4B,eAAeF,GACrB,GAAGljL,KAAKkiL,mBAAoB,EAAArrI,GAAA,GAAU72C,KAAKkiL,iBAAkBgB,GAC3D,OAAO,EAGTljL,KAAK2S,SAAS2iE,WAAWC,UAAU,yBAA0B,CAC3DgwG,WAAYrC,EAAUsC,UACtBC,MAAOvC,EAAUwC,WACjBC,WAAY,GACZC,aAAa,EACbC,OAAQ,IAAIn5J,aACXhrB,MAAK,KACN1B,KAAKkiL,iBAAmBgB,KACtBv1K,IACFA,EAAMm5I,SAAU,KAIZq8B,iBAAiBD,GACvB,IAAIljL,KAAKkiL,iBACP,OAAO,EAGTliL,KAAK2S,SAAS2iE,WAAWC,UAAU,2BAA4B,CAC7DgwG,WAAYrC,EAAUsC,UACtBC,MAAOvC,EAAUwC,WACjBC,WAAY,KACXjkL,MAAK,KACN1B,KAAKkiL,kBAAmB,KACtBv0K,IACFA,EAAMm5I,SAAU,OAMtB,OAAmB,4BAAwCi6B,IAC3D,Y,sTCprBe,SAAe+E,GAAkBzlL,EAA+B0lL,GAAY,G,0CACzF,MAAMzkG,EAAe,GAEf0kG,EAAY,CAAMjpK,EAAYgC,IAA2B,mCAC7D,GAAGhC,EAAMkpK,YAAa,CACpB,MAAMC,EAAkBnpK,EAAMopK,qBACxB,IAAIhjL,SAAc,CAAC4B,EAASylB,KAChC07J,EAAgBE,aAAkBvpK,GAAiB,mCACjD,IAAI,MAAME,KAASF,QACXmpK,EAAUjpK,EAAOgC,GAGzBha,iBAGC,GAAGgY,EACR,GAAGgpK,EACDzkG,EAAMzvE,KAAKkL,EAAM9c,UACZ,CACL,MAAMomL,EAAWtnK,EAAKunK,YAChBjlG,EAAOtkE,aAAiB2kE,KAC5B3kE,EAEEA,aAAiBwpK,iBACfxpK,EAAMupK,kBACA,IAAInjL,SAAQ,CAAC4B,EAASylB,IAAWzN,EAAMskE,KAAKt8E,GAAU0I,GAAa1I,EAAQshL,OAOvF,IAAIhlG,EAAM,OACVC,EAAMzvE,KAAKwvE,OAKjB,GAAGhhF,aAAammL,WAAanmL,EAAEomL,aAAanlG,QAAUjhF,EAAEomL,aAAahqK,MACnE,IAAI,IAAI1Q,EAAI,EAAGA,EAAI1L,EAAEomL,aAAanlG,MAAM3gF,OAAQoL,IAAK,CACnD,MAAMs1E,EAAOhhF,EAAEomL,aAAanlG,MAAMv1E,GAClCu1E,EAAMzvE,KAAKk0K,EAAY1kG,EAAKphF,KAAOohF,OAEhC,CAEL,MAAM5kE,GAASpc,EAAEomL,cAAgBpmL,EAAEqmL,eAAiBrmL,EAAEsmL,cAAcD,eAAejqK,MAE7EhT,EAA2B,GACjC,IAAI,IAAIsC,EAAI,EAAGA,EAAI0Q,EAAM9b,SAAUoL,EAAG,CACpC,MAAMgT,EAAyBtC,EAAM1Q,GACrC,GAAiB,SAAdgT,EAAKlV,KAAiB,CACvB,MAAMkT,GAASgpK,EAAYhnK,EAAOA,EAAK6nK,qBAAuB7nK,EAAKunK,YACnE78K,EAASoI,KAAKm0K,EAAUjpK,EAAOgC,WAI7B5b,QAAQC,IAAIqG,GAOpB,OAAO63E,K,2SC6BF,MAAM9nB,GAAuB,OAoB7B,MAAMqtH,WAAqB,IAAlC,c,oBAKS,KAAAC,SAAWhoL,SAASstD,eAAe,iBAGnC,KAAA26H,SAAU,EACV,KAAAC,qBAAuB,EAIvB,KAAAnwE,eAAgC,KAEhC,KAAArH,OAAS,EAET,KAAA7gC,MAAgB,GAchB,KAAAs4G,aAAe,IAAI,KAAuB,eA4uBzC,KAAAC,aAAgBC,IACtB,MAAMr8G,EAAOnvD,SAASmvD,KAClBq8G,GACF72K,EAAA,iBAGF,MAAMgwC,EAAWwqB,EAAKpoC,MAAM,KACtBy2F,EAASn5H,KAAKonL,eAAet8G,EAAMxqB,GAEzC,GADAtgD,KAAK8zB,IAAI,aAAcg3C,EAAMxqB,EAAS,GAAI64E,GACtCruD,EAIJ,GAAGquD,EAAOkuD,OAAV,CACE,MAAM,QAACvxH,IAAW,EAAAC,GAAA,GAAQojE,EAAOkuD,QACjC,GAAGvxH,EAAS,CACV,MAAMlvB,EAAI9nC,SAASC,cAAc,KACjC6nC,EAAEsvB,KAAOijE,EAAOkuD,OACfvhL,OAAegwD,GAASlvB,QAL7B,CAeO,SALA0Z,EAAS,KAEZ64E,EAAOvrF,EAAI0S,EAAS,GAAG5/C,MAAM,IAGlB,CACX,MAAMktC,EAAYurF,EAAOvrF,EACzB,IAAI05I,OAAyBt9K,IAAhBmvH,EAAO3iE,MAAqB,EAAAk0D,GAAA,IAAmByO,EAAO3iE,WAAQxsD,EAGpE,MADA4jC,EAAE,GAEL5tC,KAAKunL,aAAa,CAChBC,SAAU55I,EACV01B,UAAWgkH,IAMbtnL,KAAKq0G,aAAa,CAChB9nG,OAAQ+6K,EAAS15I,EAAE/yB,UAAS,GAAQ+yB,EAAE/yB,WACtCyoD,UAAWgkH,OA0Rf,KAAAG,YAAc,KACpB3oL,SAASguD,gBAAgB7pD,MAAMmgD,YAAY,uBAAwB,8BAAsC,MAEzGtkD,SAAS8rC,KAAKxrC,UAAUoE,OAAO,qBAAsB,gCACrD1E,SAAS8rC,KAAKxrC,UAAUoE,OAAO,qBAAqB,GACpD1E,SAAS8rC,KAAKxrC,UAAUoE,OAAO,oBAAqB,gCAEpDxD,KAAK0nL,yBAA0B,EAAAt7I,GAAA,IAAS,KACtC,MAAMmqE,EAASv2G,KAAKoiC,KAAKm0E,OACtBA,EAAO1/C,eACR0/C,EAAO1/C,cAAc8qD,gBAAgB,GAGvC3hH,KAAK2S,SAASovB,eAAe4+E,WAAW3gH,KAAKoiC,KAAKqJ,QAAQhd,cAAc0B,WACvE,+BAAuC,IAAM,GAAG,GAAO,GAE1D0V,GAAA,UAAqB,4BACrBjE,EAAA,mBAAqC,GAErC,IAAI,MAAMQ,KAAQpiC,KAAK2uE,MACrBvsC,EAAK+7H,uBAGP,mBAAmB,yBAEnBn+J,KAAK2nL,4BAA4B3nL,KAAKoiC,OA6LhC,KAAAwlJ,gBAAkB,CAAMvnL,EAA+BwnL,IAAsC,mCACnG,MAAMC,EAAgBpvD,KAKtB,GAAGr4H,aAAammL,UAAW,CACzB,MAAMuB,EAAS1nL,EAAEomL,aAAah4G,OAEds5G,EAAO1iL,SAAW0iL,EAAO1iL,SAAS,SAAW0iL,EAAOvxK,QAAQ,UAAY,KAEtF,EAAAyR,EAAA,GAAY5nB,GAIhB,MAAMihF,QAAcwkG,GAAkBzlL,GACtC,WAAWL,KAAKgoL,YAAeF,IAC5BxmG,EAAM3gF,OAAQ,CACf,GAAGmnL,EAED,YADAA,EAAcztD,SAAS/4C,GAIzB,MAAMg/C,EAAYtgI,KAAKoiC,KAAKriC,MAC5BugI,EAAU1H,eAAiBivD,IAAe,QAA+BvmG,EAAM,GAAGrhF,MAAQ,QAAU,YACpG,gBAAyB04H,GAAe34H,KAAKoiC,KAAMk/C,EAAOg/C,EAAU1H,oBA/xCpE93E,WACF,OAAO,SAGL1e,WACF,OAAOpiC,KAAK2uE,MAAM3uE,KAAK2uE,MAAMhuE,OAAS,GAGjC8nB,UAAU9V,GACf3S,KAAK2S,SAAWA,EAEhB,MAAM,kBACJs1K,GACEt1K,EACJs1K,EAAkBz+J,OAAO,4BAEzBgO,GAAA,YAAqC7kB,GACrC,aAAiCA,GAGjC3S,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,KAAM,MAAAm1F,IAAe,WAAgB,YAAiB,aAExEh9J,KAAKkoL,mBAAqB,GAC1B,8BAAoCnoG,IAClC,GAAGA,EAAMD,WAAWG,KAAM,CACxB,MAAM35D,EAAM,cAAgBy5D,EAAMD,WAAWG,KAAO,QAAU,GAAA2kE,WAAa,KAAO,IAClF5kJ,KAAKkoL,mBAAmBnoG,EAAMD,WAAWG,MAAQ98E,QAAQ4B,QAAQuhB,OAIrEtmB,KAAKuP,UAAU,GAEf8rG,GAAA,mBAAgC,UAAWwnE,IACzC7iL,KAAK+mL,QAAUlE,EACf7iL,KAAKmoL,eACFtF,EACD55H,cAAcjpD,KAAKgnL,sBAEnBhnL,KAAKgnL,qBAAuBlhL,OAAO8hD,aAAY,IAAM5nD,KAAKmoL,gBAAgB,QAI9EnoL,KAAKixC,eAAiBnyC,SAASC,cAAc,OAC7CiB,KAAKixC,eAAe7xC,UAAUC,IAAI,kBAAmB,kBACrDW,KAAKixC,eAAerpC,QAAQhG,UAAY,aAExC5B,KAAKooL,wBAA0BtpL,SAASC,cAAc,OACtDiB,KAAKooL,wBAAwBhpL,UAAUC,IAAI,6BAC3CW,KAAKqoL,8BAA8Bh5J,EAAA,gBAEnCrvB,KAAK8mL,SAASpnL,OAAOM,KAAKixC,gBAE1BjxC,KAAKsoL,gBACLtoL,KAAKuoL,eAAevoL,KAAKoiC,KAAKlhC,WAE9BoP,EAAA,eAAuCtQ,KAAKknL,aAG5ClnL,KAAKynL,cACL,qBAA2B,mBAAoBznL,KAAKynL,cAEpD,EAAAz9G,GAAA,KAAuB,KACrBpoC,EAAA,0BAA6C,QAC7CA,EAAA,mBAAqC,MACpC,KACDA,EAAA,0BAA6C,IAC7CA,EAAA,mBAAqC,MAGpC,GAAAgjH,YAAc,kBAAuF,KAAzD,EAAA4jC,GAAA,GAAe,gBAA4B,SACxFxoL,KAAKyoL,sBAAsBtsK,GACuB,kBAAzCA,EAASusK,QAAQl3K,IAAI,kBAC3B9P,MAAK,KACN1B,KAAK2oL,uBAGP3oL,KAAK2oL,oBAIPt5J,EAAA,mBAA4B,gBAAgB,CAAChe,EAAMixB,KAC9CxjC,SAAS8rC,KAAKxrC,UAAUiG,SAAS2vF,KAC/Bl2F,SAAS8rC,KAAKxrC,UAAUiG,SAAS6mD,KACpC,kBAA8B,GAGhClsD,KAAKqoL,8BAA8B/lJ,MAGrCjT,EAAA,mBAA4B,UAAU,KAEpC,MAAM7oB,EAAOxG,KAAKixC,eAAexqC,wBACjCi1J,GAA8BktB,gBAAgBpiL,EAAKjF,MAAOiF,EAAKhF,QAAQE,MAAK,YAU9E1B,KAAKI,iBAAiB,iBAAkBgiC,IACtCpiC,KAAK6oL,iBAAiBzmJ,MAGxB,qBAA2B,gBAAgB,KACzCpiC,KAAK2oL,uBAGP,qBAA2B,oBAAqBG,IAC9C9oL,KAAK+oL,0BAA0BD,MAGjC,qBAA2B,gBAAgB,EAAEv8K,OAAAA,EAAQy8K,QAAAA,M,MACnD,MAAM5mJ,EAAOpiC,KAAKoiC,KAClB,IACGA,GACDA,EAAK71B,SAAWA,GAChB0uG,GAAA,mBACE5rF,EAAA,iBAA4B,YACb,IAAfrvB,KAAKwvG,MAGP,OAGF,MAAMy5E,EAASD,EAAQ52K,MAAM62K,GAA+B,gCAApBA,EAAOjlI,OAAOp3C,IACtD,GAAyB,iCAAR,QAAd,EAAAq8K,MAAAA,OAAM,EAANA,EAAQjlI,cAAM,eAAEp3C,GAAqC,CACtD,MAAMo3C,EAASilI,EAAOjlI,OAChB3c,EAASjF,EAAKqJ,QAAQA,SAAQ,EAAAi/E,GAAA,GAAkBu+D,EAAOjlI,OAAOvc,SACpE,GAAGJ,GAAUA,EAAOjoC,UAAUiG,SAAS,cAAgBgiC,EAAOjoC,UAAUiG,SAAS,YAAcghG,GAAeh/D,EAAQjF,EAAKqJ,QAAQ3/B,WAAW5K,WAAY,CACxJ,MAAM2yG,EAA8BxsE,EAAOniC,cAAc,qFAEX2iC,KAAKwoH,MAAMrsG,EAAOpc,YAAYjB,MACvEC,EAAEx5B,SAASw5B,IACdxgC,YAAW,MACT,QAAmBytG,KACZ,IAANjtE,EAAEv0B,MAGPrS,KAAK2S,SAAS40B,mBAAmBC,UAAUj7B,EAAQ,CACjDK,EAAG,kCACH+6B,SAAUqc,EAAOrc,gBAMzB,MAAMuhJ,EAAyBj0H,IAC7B,MAAMk0H,EAAuB,YAAXl0H,EACZ8wD,EAAQ,IAAI,IAAa,kCAA8B/7G,EAAW,CAACojC,iBAAiB,IACpFt2B,EAAIhY,SAASC,cAAc,OACjC+X,EAAE1X,UAAUC,IAAI,kCACf0mH,EAAc7kH,UAAUu9B,YAAY3nB,GAErC,MAAMlI,EAAS9P,SAASC,cAAc,OACtC6P,EAAOxP,UAAUC,IAAI,UACrBuP,EAAOlP,QAAO,QAAKypL,EAAY,4BAA8B,sBAE7D,MAAM1/I,EAAW3qC,SAASC,cAAc,OACxC0qC,EAASrqC,UAAUC,IAAI,YACvBoqC,EAAS/pC,QAAO,QAAKypL,EAAY,+BAAiC,yBAElEryK,EAAEpX,OAAOkP,EAAQ66B,GAEjB3qC,SAAS8rC,KAAKxrC,UAAUC,IAAI,eAE5B,MAAMkT,EAAU42K,EAAY,KAC1BlE,GAAA,YACE,KACFnmL,SAAS8rC,KAAKxrC,UAAUC,IAAI,yBAE5BujL,GAAA,qBAEAx8K,YAAW,KACTtH,SAAS8rC,KAAKxrC,UAAUkB,OAAO,cAAe,2BAC7C,MAGLylH,EAAM3lH,iBAAiB,QAASmS,GAChCwzG,EAAM72E,QAGR0zI,GAAA,mBAAgC,cAAesG,GAC5CtG,GAAA,qBACDsG,EAAsBtG,GAAA,qBAIxB5iL,KAAKI,iBAAiB,iBAAiB,EAAEkiC,GAAAA,MACvCtiC,KAAK2nL,4BAA4BrlJ,MAGnC,qBAA2B,wBAAyBjK,IAClD02D,GAAkB,CAChBlwF,OAAQ,CAAC0sC,QAAS,KAAMunC,UAAU,GAClCnlC,aAAa,EAAA8a,GAAA,GAAapwB,EAAOhrB,cAIrC,sBAAiC,qBAAsBzO,KAClDoB,KAAKoiC,KAAK71B,SAAW3N,EAAQyO,QAAQd,QAAW8uG,GAAA,WAInD,qBAAyCz8G,MAG3CoB,KAAKI,iBAAiB,gBAAsBmM,GAAW,mCAGrD,IAAI6kB,EACJ,GAHAtyB,SAAS8rC,KAAKxrC,UAAUoE,OAAO,aAAc+I,GAG1CA,EAAQ,CACT,MAAMy/B,QAAiBhsC,KAAK2S,SAAS2/B,gBAAgB2V,gBAAgB17C,GACrE6kB,EAAM4a,EAAW,IAAMA,EAAW,GAAKz/B,EAGzC+D,EAAA,eAAqC8gB,GAErC,oBAA+B,cAAepxB,KAAK2uE,MAAMh0D,KAAKynB,GAASA,EAAK71B,SAAQof,OAAO6kB,eAI3F44I,GAAA,aAAwB,gBAA4B,KAGnD,MAAqB,QACtBppL,KAAKqpL,WAAa,IAAIlJ,GAAWxtK,IAGhC,OACD,oBAAiC,YAAY,EAAEipJ,SAAAA,MAK7C,MAAM71C,EAAQ,IAAI6rD,GAAUhW,GAE5BA,EAASx7J,iBAAiB,sBAAsB,IACvCJ,KAAKspL,mBAAmB1tB,EAASmW,mBAAmBl3J,gBAAY7Q,EAAW4xJ,GACjFl6J,MAAK,KACJ,iBAA8B,YAAak6J,IACpC,KAER/tJ,OAAM,KAAM,MAGfk4G,EAAM3lH,iBAAiB,SAAS,KAC9B,MAAM62K,EAAc,eACjBA,GAAeA,IAAgBrb,IAAaA,EAAS0W,iBACtD1W,EAAStG,OAAO,gCAEjB,CAAC9tJ,MAAM,IAEVu+G,EAAM72E,UAGR,oBAAiC,gBAAiBh0B,IAChD0wB,GAAS,CACPC,YAAa,uBACbC,kBAAmB,CACjB,IAAIxT,GAAU,CAAC/rB,OAAQ2O,EAAOL,aAAazQ,eAQnDw4K,GAAA,qBAEA,MAAM2G,EAAgB,KACpBC,GAAA,uBAAmC,IAGrC5hI,YAAY2hI,EAAet2K,GAC3Bs2K,IAEAvpL,KAAKypL,kBAAsB,CACzBhmL,KAAM,kBACNqB,SAAU,CAACq0H,EAAQ/uH,KACjB,MAAM8rD,EAAO9rD,EAAQ8rD,KAEftvB,EAAIx8B,EAAQrG,WAAU,GAC5B6iC,EAAEjoC,UAAY,aACdioC,EAAE3H,UAAYi3B,EACdtvB,EAAEjiC,gBAAgB,WAElB,IAAIuoC,GAAU,mBAAoB,CAChClD,aAAc,eACd0D,mBAAoB,gBACpBG,oBAAqB,CAACjH,GACtBuG,QAAS,CAAC,CACR5B,QAAS,OACTzmC,SAAU,KACR8hC,EAAEkM,aAGL5D,UAIPlvC,KAAKypL,kBAA+D,CAClEhmL,KAAM,iBACNqB,SAAU,EAAE4kL,UAAAA,MACV,MAAM,QAACroD,EAAO,IAAE5oH,GAAOixK,EAOvB1pL,KAAK2S,SAAS40B,mBAAmBozF,SAAS36H,KAAKoiC,KAAK71B,OAAQ,IAAM80H,GAAW5oH,EAAM,IAAMA,EAAM,QAMnGzY,KAAKypL,kBAAkD,CACrDhmL,KAAM,kBACNqB,SAAU,EAAE4kL,UAAAA,MACV,MAAM,QAACC,GAAWD,EACdC,GAIJ3pL,KAAKoiC,KAAK+zD,WAAW,IAAMwzF,EAAU,QAIzC3pL,KAAKypL,kBAA6D,CAChEhmL,KAAM,cACNqB,SAAU,EAAE8kL,eAAAA,MACV,MAAM/6I,EAAqB,CACzBjiC,EAAGo6F,GAAmB6iF,YACtB5sK,IAAK2sK,EAAe,IAGtB5pL,KAAKgrH,oBAAoBn8E,MAK7B7uC,KAAKypL,kBAA0D,CAC7DhmL,KAAM,WACNqB,SAAU,EAAE8kL,eAAAA,MACV,MAAM/6I,EAAqB,CACzBjiC,EAAGo6F,GAAmB8jB,UACtBC,OAAQ6+D,EAAe,IAAM1+G,mBAAmB0+G,EAAe,IAAIlpL,MAAM,IAG3EV,KAAKgrH,oBAAoBn8E,MAI1B,MACD7uC,KAAKypL,kBAEF,CACDhmL,KAAM,YACNu+I,SAAU,KACVl9I,SAAU,EAAE4kL,UAAAA,MACV,MAAM76I,EAAO7uC,KAAK8pL,SAAS9iF,GAAmB+iF,WAAYL,GAC1D1pL,KAAKgrH,oBAAoBn8E,MAK/B7uC,KAAKypL,kBAQF,CACDhmL,KAAM,KACNqB,SAAU,EAAO8kL,eAAAA,EAAgBF,UAAAA,KAAe,mCAC9C,IAAI76I,EAEFA,EADC,WAA0B+6I,EAAe,IACnC,CACLh9K,EAAGo6F,GAAmBgjF,kBACtB1sI,MAAOssI,EAAe,GAAGlpL,MAAM,IAEH,MAAtBkpL,EAAe,GAChB,CACLh9K,EAAGo6F,GAAmBijF,aACtBv+B,QAASk+B,EAAe,GACxBpzH,KAAMozH,EAAe,GACrBM,OAAQ,WAAYR,GAAaA,EAAUQ,OAC3CC,QAAST,EAAUS,SAGd,CACLv9K,EAAGo6F,GAAmBojF,QACtB3yH,OAAQmyH,EAAe,GACvBpzH,KAAMozH,EAAe,GACrBO,QAAST,EAAUS,QACnBz/J,MAAO,UAAWg/J,EAAYA,EAAUh/J,WAAQ1gB,GAIpDhK,KAAKgrH,oBAAoBn8E,QAI7B7uC,KAAKypL,kBAsBF,CACDhmL,KAAM,UACNu+I,SAAU,KACVl9I,SAAU,EAAE4kL,UAAAA,MACV,IAAI76I,EACD66I,EAAUpsI,MACXzO,EAAO7uC,KAAK8pL,SAAS9iF,GAAmBgjF,kBAAmBN,GAC9B,qBAArBA,EAAUjyH,SAGlB5oB,EAAO7uC,KAAK8pL,SAAS9iF,GAAmBojF,QAASV,IAGnD1pL,KAAKgrH,oBAAoBn8E,MAI7B7uC,KAAKypL,kBAOF,CACDhmL,KAAM,cACNu+I,SAAU,KACVl9I,SAAU,EAAE4kL,UAAAA,MACV,MAAM76I,EAAO7uC,KAAK8pL,SAAS9iF,GAAmBijF,aAAcP,GAC5D1pL,KAAKgrH,oBAAoBn8E,MAI7B7uC,KAAKypL,kBAIF,CACDhmL,KAAM,cACNu+I,SAAU,KACVl9I,SAAU,EAAE4kL,UAAAA,MACV,MAAM76I,EAAO7uC,KAAK8pL,SAAS9iF,GAAmB6iF,YAAaH,GAC3D1pL,KAAKgrH,oBAAoBn8E,MAI7B,CAAC,WAAqB,QAAiBzhC,SAAS3J,IAC9CzD,KAAKypL,kBAIF,CACDhmL,KAAAA,EACAu+I,SAAU,KACVl9I,SAAU,EAAE4kL,UAAAA,MACV,MAAM76I,EAAO7uC,KAAK8pL,SAAS9iF,GAAmB8jB,UAAW4+D,GACzD1pL,KAAKgrH,oBAAoBn8E,SAK/B7uC,KAAKknL,cAAa,GAClBlnL,KAAKqqL,wBAGC5B,qBAAqB3jL,GAC3B,OAAO9E,KAAKinL,aAAaqD,kBAAkBv+J,IACzC,MAAM2zF,EAAO/0F,YAAYhlB,MACzB,OAAOomB,EAAMrO,OAAOhc,MAAM6oL,IACxB,MAAM9gL,EAAW8gL,EAAS5vK,KAAK6vK,GACtBz+J,EAAM6sC,MAAM4xH,GAAS9oL,MAAMya,GACzBrX,EAASqX,OAIpB,OAAOhZ,QAAQC,IAAIqG,GAAU/H,MAAMu0C,IACjCA,EAAOt7B,KAAI,CAAC8vK,EAAOpsK,KACjB,IAAIosK,EACF,OAGF,MAAMD,EAAUD,EAASlsK,GACzB,OAAO0N,EAAMrc,OAAO86K,MAGfrnL,QAAQC,IAAI6yC,EAAOtqB,OAAO6kB,gBAElC9uC,MAAK,KACN1B,KAAK8zB,IAAI,gBAAiBnJ,YAAYhlB,MAAQ+5G,SAK5CioE,4BAA4B+C,GAClC1qL,KAAK2uE,MAAMvhE,SAASg1B,IACfA,EAAK26C,kBACN36C,EAAK26C,iBAAiBH,cAAc,gCAAwCx6C,IAASsoJ,MAKnFrC,8BAA8B5nC,GACpC,MAAMptG,EAAWotG,IAAW,WAAoBzgJ,KAAK8mL,SAAWhoL,SAAS8rC,KACtE5qC,KAAKooL,wBAAwBxkL,gBAAkByvC,GAChDA,EAAS3zC,OAAOM,KAAKooL,yBAIjBiC,wBACN,MAAMM,EAAc,IAAI/rK,IAAI,CAAC,SAAU,WAAY,OAAQ,YAwD3D9f,SAAS8rC,KAAKxqC,iBAAiB,WAvDZC,I,MACjB,MAAMwP,EAAMxP,EAAEwP,IACd,GAAGorG,GAAA,mBAAkC0vE,EAAYx4I,IAAItiC,GAAM,OAE3D,MAAM1I,EAAS9G,EAAE8G,OAMXi7B,EAAOpiC,KAAKoiC,KAElB,GAAc,SAAX/hC,EAAEohC,OAAoBphC,EAAEqxI,UAAWrxI,EAAEsxI,SAA+B,UAAnBxqI,EAAOE,QAA3D,CAEO,IAAGhH,EAAEuqL,QAAmB,YAAR/6K,GAA6B,cAARA,GAOrC,GAAW,YAARA,GAAwC,cAAnB7P,KAAKoiC,KAAKniC,KAAsB,CAC7D,GAAImiC,EAAKriC,MAAM4oI,YAAavmG,EAAKriC,MAAMq2H,eAQrC,OAPAp2H,KAAK2S,SAAS40B,mBAAmBsjJ,sBAAsBzoJ,EAAK71B,OAAQ61B,EAAKv2B,UAAUnK,MAAM2L,IACpFA,IACD+0B,EAAKriC,MAAMizH,mBAAmB3lH,EAAQJ,MACtC,EAAAgb,EAAA,GAAY5nB,YAMb,GAAW,cAARwP,EACR,YAlBA,EAAAoY,EAAA,GAAY5nB,GACZL,KAAK2S,SAASs2E,eAAe6hG,cAAc9qL,KAAKoiC,KAAK71B,OAAgB,cAARsD,EAAqB,aAA4BnO,MAAM82B,IAC/GA,GACDx4B,KAAK8lD,QAAQ,CAACv5C,OAAQisB,EAAOjsB,YAkBnC,IACa,QAAX,EAAA61B,MAAAA,OAAI,EAAJA,EAAMriC,aAAK,eAAEq+G,eACb/9G,EAAE8G,SAAWi7B,EAAKriC,MAAMq+G,cACL,UAAnBj3G,EAAOE,UACNF,EAAO2sH,aAAa,qBACpB,QACCzkG,EAAA,YAAsC,IAAfrvB,KAAKwvG,SAC7BptE,EAAKkpB,UAAUC,cACfnpB,EAAKriC,MAAM8jE,UACZ,CACAzhC,EAAKriC,MAAMq+G,aAAa3xG,SACxB,EAAAssH,GAAA,GAAgB32F,EAAKriC,MAAMq+G,cAG3B,MAAM2sE,EAAW,IAAIC,cAAc3qL,EAAEJ,KAAMI,GAC3C+hC,EAAKriC,MAAMq+G,aAAapuG,cAAc+6K,QAOpCjB,SAAuC7pL,EAASypL,GACtD,OAAO,eACL98K,EAAG3M,GACAypL,GAIM1+D,oBAAoBn8E,G,0CAC/B,OAAOA,MAAAA,OAAI,EAAJA,EAAMjiC,GACX,KAAKo6F,GAAmBojF,QAAS,CAC/B,MAAM9C,EAASz4I,EAAK2nB,MAAO,EAAAk0D,GAAA,IAAmB77E,EAAK2nB,WAAQxsD,EACrDihL,EAAYp8I,EAAKs7I,SAAU,EAAAz/D,GAAA,IAAmB77E,EAAKs7I,cAAWngL,EAEpEhK,KAAKunL,aAAa,CAChBC,SAAU34I,EAAK4oB,OACf6L,UAAWgkH,EACX2D,UAAAA,EACAxrE,WAAY5wE,EAAKnkB,QAEnB,MAGF,KAAKs8E,GAAmBijF,aAAc,CACpC,MAAM5vK,EAASw0B,EAAK68G,QAAQr9H,WACtB9hB,EAAS8N,EAAOQ,UAAS,GAG/B,UADmB7a,KAAK2S,SAASoH,gBAAgB00B,QAAQp0B,IACjDm4B,QACN,UACQxyC,KAAK2S,SAASoH,gBAAgBmxK,eAAe7wK,GACnD,MAAM5M,GAEN,MADAm+B,GAAS,CAACC,YAAa,iBACjBp+B,EAIV,MAAM65K,GAAS,EAAA58D,GAAA,IAAmB77E,EAAK2nB,MACjC3qD,EAAWgjC,EAAKq7I,QAAS,EAAAx/D,GAAA,IAAmB77E,EAAKq7I,aAAUlgL,EAE9D6B,EAAU7L,KAAKi1G,WAAW1oG,EAAQ+6K,EAAQz7K,GACxC7L,KAAKq0G,aAAa,CACrB9nG,OAAAA,EACA+2D,UAAWgkH,EACXz7K,SAAAA,IAEF,MAGF,KAAKm7F,GAAmB6iF,YACtB,IAAI3lG,GAAc,CAAC1zE,GAAIq+B,EAAK5xB,MAAMiyB,OAClC,MAGF,KAAK83D,GAAmB8jB,UACtB9qH,KAAK2S,SAASoH,gBAAgBoxK,gBAAgBt8I,EAAKk8E,QAAQrpH,MAAMwlG,IAC3DA,EAAyC9kE,MAC3CpiC,KAAK2S,SAASoH,gBAAgBqxK,YAAalkF,EAAyC9kE,MAAM,GAKxE,sBAAjB8kE,EAAWt6F,GACK,mBAAjBs6F,EAAWt6F,EAOb,IAAIq6F,GAAoBp4D,EAAKk8E,OAAQ7jB,GANnClnG,KAAKq0G,aAAa,CAChB9nG,OAAQ26F,EAAW9kE,KAAK5xB,GAAGqK,UAAS,QAMtCpN,IACc,wBAAbA,EAAIxN,MACL0rC,IAAM,QAAK,qBAGf,MAGF,KAAKq7D,GAAmB+iF,WACnB,MACD/pL,KAAKuwJ,cAAc1hH,EAAK81E,QAAQ9pG,UAAS,GAAOg0B,EAAKr+B,IAGvD,MAGF,KAAKw2F,GAAmBgjF,kBACtBhqL,KAAK2S,SAAS2I,gBAAgB+vK,aAAax8I,EAAKyO,OAAO57C,MAAM6W,IAC3DvY,KAAKq0G,aAAa,CAChB9nG,OAAQgM,EAAK/H,GAAGqK,UAAS,QAE1BhN,OAAOJ,IACQ,uBAAbA,EAAIxN,MACL2rC,GAAS,CAACC,YAAa,8BAI3B,MAGF,QACE7rC,KAAK8zB,IAAI21C,KAAK,+BAAgC56B,OAM7Cy8I,QAAQhlK,GACb,MAAOA,IAAKilK,EAAU,QAAEz1H,IAAW,EAAAC,GAAA,GAAQzvC,GACrCsgB,EAAI9nC,SAASC,cAAc,KACjC6nC,EAAEsvB,KAAOq1H,EAERzlL,OAAegwD,GAASlvB,GAGnB6iJ,kBAA0E7qL,GAQ/EkH,QAAgBlH,EAAQojJ,SAAWpjJ,EAAQojJ,SAAW,IAAM,IAAMpjJ,EAAQ6E,MAAS2G,KAClF,EAAA6d,EAAA,GAAY,MAEZ,MAAMiuC,EAAO9rD,EAAQ8rD,KACrB,IAAI0zH,EACAF,EAEA9qL,EAAQ4sL,mBAAkB5B,EAAiB,IAAIrvH,IAAInwD,EAAQ8rD,MAAMu1H,SAAS/oJ,MAAM,KAAKhiC,MAAM,IAC3F9B,EAAQ8sL,cAAahC,EAAY1pL,KAAKonL,eAAelxH,IAEzD,MAAMppD,EAAMlO,EAAQkG,SAAS,CAAC8kL,eAAAA,EAAgBF,UAAAA,GAAsBt/K,GACpE,YAAeJ,IAAR8C,GAAoBA,GAIvBs6K,eAAenrK,EAAaqkC,EAAWrkC,EAAIymB,MAAM,MACvD,MAAMy2F,EAAc,GACpB,OAAI74E,EAAS,IACbA,EAAS,GAAG5d,MAAM,KAAKt1B,SAAS2R,IAC9Bo6G,EAAOp6G,EAAK2jB,MAAM,KAAK,IAAMwoC,mBAAmBnsD,EAAK2jB,MAAM,KAAK,OAG3Dy2F,GALiBA,EAgEnBouD,aAAa3oL,GAOlB,MAAM,SAAC4oL,EAAQ,UAAElkH,EAAS,SAAEz3D,EAAQ,UAAEo/K,EAAS,WAAExrE,GAAc7gH,EAC/D,OAAOoB,KAAK2S,SAAS2I,gBAAgBwyF,gBAAgB05E,GAAU9lL,MAAM6yC,IACnE,MAAMpN,EAAoB,SAAXoN,EAAK3nC,EACdL,EAASgoC,EAAK/jC,GAAGqK,UAAUssB,GAEjC,OAAGt7B,EACM7L,KAAKi1G,WAAW1oG,EAAQ+2D,EAAWz3D,GAClCo/K,EACDjrL,KAAK2rL,YAAYp/K,EAAQ+2D,EAAW2nH,GAGtCjrL,KAAKq0G,aAAa,CACvB9nG,OAAAA,EACA+2D,UAAAA,EACAm8C,WAAYA,OAEZhyG,IACc,0BAAbA,EAAIxN,KACL2rC,GAAS,CAACC,YAAa,oBACF,qBAAbp+B,EAAIxN,MACZ2rC,GAAS,CAACC,YAAa,8BAQtBopE,WAAW1oG,EAAgB+2D,EAAmBz3D,GACnD,OAAO7L,KAAK2S,SAAS40B,mBAAmB0uG,kBAAkB1pI,EAAQV,GAAUnK,MAAM2L,IAE5EA,EAGFrN,KAAK2S,SAAS40B,mBAAmBqkJ,kCAAkCv+K,GAFnEi2D,OAAYt5D,EAKPhK,KAAKq0G,aAAa,CACvB9nG,OAAAA,EACA+2D,UAAAA,EACAz3D,SAAAA,EACA5L,KAAM,kBAQL0rL,YAAYp/K,EAAgB0wG,EAAeguE,GAChD,OAAOjrL,KAAK2S,SAAS40B,mBAAmB6tE,qBAAqB7oG,EAAQ0wG,GAAOv7G,MAAM2L,GACzErN,KAAKi1G,WAAW5nG,EAAQd,OAAQ0+K,EAAW59K,EAAQJ,OAIjDynG,SAASx5F,EAAgBjb,G,0CACvB,mBAAgCib,YAKtBlb,KAAK2S,SAASq8B,kBAAkB+4C,WAAW7sE,IACtD1C,OAAOqzK,oBACjB98F,GAAkB,CAChBrhD,mBAAoB,2BACpBG,oBAAqB,CAAC,IAAIvV,GAAU,CAAC/rB,OAAQ2O,EAAOL,aAAazQ,SACjEvL,OAAQ,CACN0sC,QAAS,KACTunC,UAAU,YAOV9yE,KAAKspL,mBAAmBpuK,EAAOL,YAErC,qBAAkCK,EAAiB,UAATjb,QAGpCqpL,mBAAmBzuK,EAAkBixK,EAAqCC,GAChF,OAAG,GAAAp8B,WAAkC,GAAAA,YAAmCm8B,EAAwB9rL,KAAKgsL,6BAA6BnxK,GAC1H,gBAA+B,iBAAgCkxK,EAAmB/rL,KAAKisL,wBAAwBpxK,GAC3G1X,QAAQ4B,UAGRknL,wBAAwBpxK,G,0CACpC,MAAMo8J,EAAc,eACjBA,UACKloF,GAAkB,CACtB/kD,aAAc,mCACd0D,mBAAoB7yB,EAASssB,SAAW,wCAA0C,yCAClF0G,oBAAqB,CACnB,IAAIvV,GAAU,CAAC/rB,OAAQ0qK,EAAYlF,mBAAmBl3J,UAAS,KAASzQ,QACxE,IAAIkuB,GAAU,CAAC/rB,OAAQsO,IAAWzQ,SAEpCvL,OAAQ,CACN0sC,QAAS,QAIT0rI,EAAYxtB,kBACRwtB,EAAY3hB,OAAO,yCAKjB02B,6BAA6BnxK,G,0CACzC,MAAM47I,EAAmB,GAAA9G,UACtB8G,UACK1nE,GAAkB,CACtB/kD,aAAc,oCACd0D,mBAAoB7yB,EAASssB,SAAW,yCAA2C,0CACnF0G,oBAAqB,CACnB,IAAIvV,GAAU,CAAC/rB,OAAQkqJ,EAAiBp8I,OAAOQ,UAAS,KAAQzQ,QAChE,IAAIkuB,GAAU,CAAC/rB,OAAQsO,IAAWzQ,SAEpCvL,OAAQ,CACN0sC,QAAS,QAIV,GAAAokH,YAAmC8G,UAC9BA,EAAiBnB,cAKhB/E,cAAchkJ,EAAgBqjJ,G,0CACzC,MAAMv1I,EAAS9N,EAAO8hB,WAChBomB,EAAYz0C,KAAK2S,SAASoH,gBAAgB06B,UAAUp6B,EAAQ,eAiBlE,GAAGu1I,GAEkB,8BADK5vJ,KAAK2S,SAAS29I,qBAAqB0G,iBAAiBpH,IAC/DhjJ,EAA4B,CACvC,IAAI6nC,EAKF,YAJA7I,GAAS,CACPC,YAAa,+BAMXkjD,GAAkB,CACtBrhD,mBAAoB,0BACpB7uC,OAAQ,CACN0sC,QAAS,gCA9BJ,MAAW,mCACtB,MAAMoD,QAAiB3uC,KAAK2S,SAASq8B,kBAAkBqL,YAAYhgC,GACnE,IAAI27C,EACJ,GAAIrnB,EAASqnB,KAOXA,EAAOrnB,EAASqnB,SAPC,CACjB,IAAIvhB,EACF,OAGFuhB,QAAah2D,KAAK2S,SAAS29I,qBAAqB47B,gBAAgB7xK,GAKlE,iBAAmCA,EAAQ27C,EAAKxlD,IAAI,GAAM,OAyB5DipB,MAGK0yJ,qBAAqBC,GAAiB,GAC3C,MAAMrsG,EAAQO,GAAA,aAEd,GAAGP,EAAMD,WAAWG,KAAM,CACxB,MAAMmC,EAAe,2BAAiC/vE,GAAMA,EAAE5O,OAASs8E,EAAMt8E,OAK3E,OAAOzD,KAAKqsL,cAActsG,EAAMD,WAAWG,MAAMv+E,MAAM4kB,GAC9CtmB,KAAKm9J,cAAc72I,EAAK8lK,KAC9B,KACDrsG,EAAMD,YAAa,EAAAroC,GAAA,GAAK2qC,EAAatC,YAC9B9/E,KAAKmsL,sBAAqB,MAKvC,OAAOnsL,KAAKm9J,cAAc,GAAIivB,GAGxBC,cAAcpsG,GACpB,OAAGjgF,KAAKkoL,mBAAmBjoG,GAAcjgF,KAAKkoL,mBAAmBjoG,GAC1DjgF,KAAKkoL,mBAAmBjoG,GAAQjgF,KAAKinL,aAAaqF,QAAQ,eAAiBrsG,GAAMv+E,MAAM0iC,GACrFm2B,IAAIC,gBAAgBp2B,KAIxB+4H,cAAc72I,EAAa8lK,GAAiB,GACjDpsL,KAAKusL,kBAAoBjmK,EACzB,MAAM7c,EAAWzJ,KAAK2uE,MAAMh0D,KAAKynB,GAASA,EAAK+6H,cAAc72I,KAC7D,OAAO7c,EAASA,EAAS9I,OAAS,GAAGe,MAAK,KACrC0qL,GACD,kBAAwB,wBAKvBvD,iBAAiBzmJ,GACtB,IAAK,CAAC,OAAQ,cAA6Bh7B,SAASg7B,EAAKniC,QAAUmiC,EAAK71B,OACtE,OAMA,MAAMigL,EAAcpqJ,EAAKqJ,QACnB57B,EAAMuyB,EAAK71B,QAAU61B,EAAKv2B,SAAW,IAAMu2B,EAAKv2B,SAAW,IAC3D4gL,EAAgBrD,GAAA,eAA0B,iBAChD,GAAKoD,EAAY1gL,WAAW8qG,oBAAsB,IAAM41E,EAAY1gL,WAAW0hG,UAAUl3E,SAAWk2J,EAAYtxE,2BAavGuxE,EAAc58K,GAErB7P,KAAK8zB,IAAI,6BAf0H,CACnI04J,EAAY5zE,eAAc,GAC1B,MAAM/xG,EAAM2lL,EAAY1gL,WAAW24C,UAE7B9Z,EAAW,CACfxR,MAAM,EAAA80C,GAAA,GAAqBu+G,EAAY/gJ,QAAS,QAAQ9f,QAAQ1e,IAASu/K,EAAYvnH,YAAY9yB,IAAIllC,KACrGpG,IAAAA,GAGF4lL,EAAc58K,GAAO86B,EAErB3qC,KAAK8zB,IAAI,uBAAwB6W,GAOnCy+I,GAAA,MAAiB,CAACqD,cAAAA,IAAgB,GAI/BtsE,qBAAqB/9E,GAC1B,IAAK,CAAC,OAAQ,cAA6Bh7B,SAASg7B,EAAKniC,QAAUmiC,EAAK71B,OACtE,OAGF,MAAMsD,EAAMuyB,EAAK71B,QAAU61B,EAAKv2B,SAAW,IAAMu2B,EAAKv2B,SAAW,IAC3DkgB,EAAQq9J,GAAA,eAA0B,iBACxC,OAAOr9J,GAASA,EAAMlc,GAGjB84K,kBAAkB1oG,EAAeysG,EAAwBN,GAO9D,OANGM,IACD1sL,KAAKkoL,mBAAmBjoG,GAAQ98E,QAAQ4B,QAAQ2nL,IAGlDpsG,GAAA,aAEOtgF,KAAKmsL,0BAAwCniL,IAAnBoiL,IAAiCnsG,EAAOmsG,GAiCnE7D,eAAez3K,EAAkBL,GACvC,GAAGzQ,KAAK2sL,UAAY77K,EAApB,CAQA,IAJe,IAAZL,GAAqBzQ,KAAK2sL,SAC3BpqB,GAAkB,CAACzxJ,EAAK9Q,KAAK2sL,SAAShhK,OAAO6kB,UAG5CxwC,KAAK2sL,QAAS,CACf3sL,KAAK2sL,QAAQvtL,UAAUkB,OAAO,UAC9BN,KAAK0nL,0BAGF,iCAAoD,IAAZj3K,IACzC,UAA4B,QAAM,KAAY,KAGhD,MAAMm8K,GAAU,EAAA3xH,GAAA,GAAWj7D,KAAK2sL,UACpB,EAAA1xH,GAAA,GAAWnqD,GACd87K,GACPt8K,EAAA,WAAiC,CAC/BrQ,KAAM,OACN0R,MAAQC,IACN5R,KAAK8lD,QAAQ,GAAIl0C,IACjB,EAAAywD,GAAA,QAMRvxD,EAAI1R,UAAUC,IAAI,UAClBW,KAAK2sL,QAAU77K,GAGTzB,OACNvQ,SAASsB,iBAAiB,QAASJ,KAAK4nL,iBAAiB,GAErD,MACF5nL,KAAK6sL,6BAIL7sL,KAAKsnI,cAAgB,IAAI23B,GAAcj/J,MACvCA,KAAKsnI,cAAc45B,kBAIf2rB,6BACN,MAAMC,EAA2B,GAC3BC,EAAgC,GACtC,IAAI1oH,GAAU,EACd,MAAM7gE,EAAS,CAAMnD,EAAc24F,IAAmB,mCACpD,GAAGA,IAAU30B,EAAS,OAEtB,MAAM0jH,EAAS1nL,EAAEomL,aAAah4G,MAExBu+G,EAAUjF,EAAO1iL,SAAW0iL,EAAO1iL,SAAS,SAAW0iL,EAAOvxK,QAAQ,UAAY,EAElFsxK,EAAgBpvD,KAChBjqD,QAAwBq3G,GAAkBzlL,GAAG,GACnD,IAAI2sL,WAAoBhtL,KAAKgoL,aAAeF,EAE1C,YADAr6G,EAAU,GAIZ,MAAMw/G,EAAkBnF,EAAgBoF,EAAsBC,EACxDC,EAAStF,EAAgBiF,EAAaD,EAE5C,GAAG9zF,IAAUo0F,EAAOzsL,OAAQ,CAC1B,MAAMi3H,EAAQo1D,IAAYv+G,EAAM9tE,OAE1B0sL,EAAa5+G,EAAM9iD,QAAQtZ,GAAM,QAA+BA,KAAI1R,OAG1EX,KAAK8zB,IAAI,aAAc26C,GAEpBq5G,GACDA,EAAc9tD,YAAYizD,IAEvBx+G,EAAM9tE,QAAUi3H,IACjBw1D,EAAOv7K,KAAK,IAAIgwJ,GAAgBorB,EAAiB,CAC/Cr+K,OAAQ,4BACRyzJ,WAAY,CAAC5zF,EAAM9tE,QACnBshK,OAAS5hK,IACPmD,EAAOnD,GAAG,GACVL,KAAK8zB,IAAI,OAAQzzB,GACjBL,KAAK4nL,gBAAgBvnL,EAAG,mBAK3BouE,EAAM9tE,QAAUi3H,IACjBw1D,EAAOv7K,KAAK,IAAIgwJ,GAAgBorB,EAAiB,CAC/ChuL,KAAM,YACN2P,OAAQ,iBACR66B,SAAU,uBACVw4H,OAAS5hK,IACPmD,EAAOnD,GAAG,GACVL,KAAK8zB,IAAI,OAAQzzB,GACjBL,KAAK4nL,gBAAgBvnL,EAAG,iBAM3BgtL,GAAcz1D,IACfw1D,EAAOv7K,KAAK,IAAIgwJ,GAAgBorB,EAAiB,CAC/ChuL,KAAM,YACN2P,OAAQ,iBACR66B,SAAU,qBACVw4H,OAAS5hK,IACPmD,EAAOnD,GAAG,GACVL,KAAK8zB,IAAI,OAAQzzB,GACjBL,KAAK4nL,gBAAgBvnL,EAAG,aAK9BL,KAAKoiC,KAAKlhC,UAAUxB,OAAOutL,KAM/B,QAAcA,EAAiB,aAAcj0F,EAAO,KAAK,KACnDA,IACFo0F,EAAOhgL,SAASkgL,IACdA,EAAKtkI,aAGPokI,EAAOzsL,OAAS,MAIjBq4F,EACDo0F,EAAOhgL,SAASkgL,IACdA,EAAKhrB,aAGP70F,EAAU,EAGZ3uE,SAAS8rC,KAAKxrC,UAAUoE,OAAO,cAAew1F,GAC9C30B,EAAU20B,KAOZ,IAAIvrB,EAAU,EACd3uE,SAAS8rC,KAAKxqC,iBAAiB,aAAcC,IAC3CotE,OAGF3uE,SAAS8rC,KAAKxqC,iBAAiB,YAAaC,IAE1CmD,EAAOnD,GAAG,IACV,EAAA4nB,EAAA,GAAY5nB,MAGdvB,SAAS8rC,KAAKxqC,iBAAiB,aAAcC,IAG3CotE,IACe,IAAZA,GAEDjqE,EAAOnD,GAAG,MAId,MAAM8sL,EAAiBruL,SAASC,cAAc,OAC9CouL,EAAe/tL,UAAUC,IAAI,mBAE7B,MAAM6tL,EAAsBC,EAAeppL,WAAU,GAGzCikL,U,0CACZ,MAAM5lJ,EAAOpiC,KAAKoiC,KAElB,UADeA,MAAAA,OAAI,EAAJA,EAAM71B,SACD0uG,GAAA,2BAA0C74E,EAAK+2E,QAAQ,mBAgCtE5pG,UAAUiB,EAAYC,IACZ,IAAZA,GACD8xJ,GAAkB,CAAC,aAA0BviK,KAAK8mL,SAAU,eAG9DhoL,SAAS8rC,KAAKxrC,UAAUoE,OAAOwxF,GAAqC,IAAPxkF,GAE7D,MAAMg3D,EAAYxnE,KAAKwvG,MAEvBxvG,KAAK8zB,IAAI,YAAatjB,EAAIg3D,GAE1B,IAAIta,EAAiC,gCAAuC,WAAc/pD,QAAQ4B,UAClG,IAAkB,IAAfyiE,GAAoBA,IAAch3D,GAAM,iCAAoD,IAAZC,GAAqB4e,EAAA,iBAA4B,UAAkB,CACpJ,MAAMk+J,EAAqD,KAAnCl+J,EAAA,WAAsB,IAAM,KACpD69B,GAAmB,QAAMqgI,IACzB,SAA4BrgI,EAAkBqgI,GAShDvtL,KAAKwvG,MAAQh/F,GACb,EAAA6xD,GAAA,KACGhzC,EAAA,YAAqC,IAAdm4C,GAAmBh3D,EAAK,GAChD1R,SAAS8rC,KAAKxrC,UAAUkB,OAAO4rD,KAGf,IAAfsb,GAAoBh3D,EAAKg3D,IACvBh3D,EAAK,IAAMF,EAAA,iBAAuC,QACnDA,EAAA,WAAiC,CAC/BrQ,KAAM,KACN0R,MAAQC,IAEN5R,KAAK8lD,QAAQ,GAAIl0C,MAMzB,MAAM47K,EAAiB1nL,OAAe0nL,cAMtC,OALAA,GAAiBA,EAAch9K,GAKxB08C,EAGFi7H,eACL,OAAOnoL,KAAK2S,SAAS2I,gBAAgBmyK,qBAAqBztL,KAAK+mL,SAGzDuB,gBACN,MAAMlmJ,EAAO,IAAI06H,GACf98J,KACAA,KAAK2S,UASP,OANG3S,KAAK2uE,MAAMhuE,QACZyhC,EAAK+6H,cAAcn9J,KAAKusL,mBAAmB,GAG7CvsL,KAAK2uE,MAAM98D,KAAKuwB,GAETA,EAGDsrJ,YAAYC,EAAmBC,GAAa,EAAMn9K,EAAmBy6F,GAC3E,GAAGyiF,GAAa3tL,KAAK2uE,MAAMhuE,OAAQ,OAEnC,MAAMktL,EAAW7tL,KAAKoiC,KACnBpiC,KAAK2uE,MAAMhuE,OAAS,GAAKitL,GAC1B5tL,KAAKgQ,cAAc,gBAAiBhQ,KAAKoiC,MAGvC8oE,IACFA,EAAUlrG,KAAK2uE,MAAMpwD,OAAOovK,EAAW3tL,KAAK2uE,MAAMhuE,OAASgtL,IAG7D,MAAMG,EAAS9tL,KAAKoiC,KACpBpiC,KAAKgQ,cAAc,gBAAiB,CAACqB,KAAMw8K,EAAUvrJ,GAAIwrJ,IAGzD,IAAI,IAAI/hL,EAAI,EAAGA,EAAIm/F,EAAQvqG,OAAS,IAAKoL,EACvCuE,EAAA,eAAqC,QAAQ,GAY/C,GARG46F,EAAQvqG,OAAS,GAClBuqG,EAAQxqG,MAAM,GAAI,GAAG0M,SAASg1B,IAC5BA,EAAKlhC,UAAUZ,YAInBN,KAAKuoL,eAAeuF,EAAO5sL,UAAWuP,GAEnCm9K,EAAY,CACb5tL,KAAKgQ,cAAc,eAAgB89K,EAAOvhL,QAE1C,MAAM0xJ,EAAY,UAAuBvD,IACtCuD,GACDA,EAAUhvJ,QAGZ,yBAAsC6+K,EAAOnhI,gBAG/Cu+C,EAAQ99F,SAASg1B,IACfA,EAAK27H,mBAGP33J,YAAW,KAET8kG,EAAQ99F,SAASg1B,IACfA,EAAK4mB,eAEN,KAGQlD,QAAQlnD,EAA8B,GAAI6R,G,gDAClDzQ,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGA,QAAd,EAAAzQ,EAAQ2N,cAAM,QAAd3N,EAAQ2N,OAAW,OAEnB,MAAM,OAACA,EAAM,UAAE+2D,GAAa1kE,EAEtBwjC,EAAOpiC,KAAKoiC,KACZ2rJ,EAAY/tL,KAAK2uE,MAAMn4D,QAAQ4rB,GAErC,GAAI71B,GAQG,GAAGwhL,EAAY,GAAK3rJ,EAAK71B,QAAU61B,EAAK71B,SAAWA,EAAQ,CAO9D,MAAM2+F,EAAUlrG,KAAK2uE,MAAMpwD,OAAO,EAAGve,KAAK2uE,MAAMhuE,OAAS,GACzD,GAAGX,KAAKoiC,KAAK71B,SAAWA,EAEtB,YADAvM,KAAK0tL,YAAY,GAAG,GAAM,EAAMxiF,GAE3B,CACL,MAAM/rD,EAAMn/C,KAAK8lD,QAAQlnD,GAEzB,OADAoB,KAAK0tL,YAAY,GAAG,GAAO,EAAOxiF,GAC3B/rD,QAtBD,CACV,GAAG4uI,EAAY,EAEb,YADA/tL,KAAK0tL,YAAYK,OAAW/jL,EAAWyG,GAElC,GAAG4e,EAAA,iBAA4B,WAEpC,YADArvB,KAAKuP,YAAYvP,KAAKwvG,MAAO/+F,GA2BjC,GAAGlE,IAAW61B,EAAK71B,QAAU8iB,EAAA,gBAA2B,YAAqBvwB,SAAS8rC,KAAKxrC,UAAUiG,SAAS2vF,IAE5G,OADAh1F,KAAKuP,UAAU,EAAGkB,IACX,EAGT,GAAGlE,GAAU8iB,EAAA,iBAA4B,WAAmB,CAC1D,MAAM/f,QAAe8yB,EAAK0jB,QAAQv5C,EAAQ+2D,EAAW1kE,EAAQ6gH,YAGvD31G,GAAUwF,MAAAA,OAAM,EAANA,EAAQ2c,QAAS3c,EAAOxF,QAAU3G,QAAQ4B,UACvDwH,GACDpJ,QAAQC,IAAI,CACV0G,EACAs4B,EAAKy7H,uBACJn8J,MAAK,KAEN0E,YAAW,KACTA,YAAW,KACTpG,KAAKuoL,eAAevoL,KAAKoiC,KAAKlhC,aAC7B,GACHlB,KAAKuP,UAAU,EAAGkB,KACjB,MAKT,OAAIlE,OAAJ,GACEvM,KAAKuP,UAAU,EAAGkB,IACX,MAIJ4jG,aAAaz1G,G,MAClB,MAAM,OAAC2N,GAAU3N,EACjB,GAAG2N,IAAW,QAAiBA,EAC7B,OAGC3N,EAAQiN,WACTjN,EAAQqB,KAAO,cAGjB,MAAMA,EAAmB,QAAf,EAAGrB,EAAQqB,YAAI,QAAZrB,EAAQqB,KAAS,OAGxB+tL,EAAgBhuL,KAAK2uE,MAAMrwD,WAAW8jB,GAASA,EAAK71B,SAAWA,GAAU61B,EAAKniC,OAASA,IAC7F,IAAsB,IAAnB+tL,EAED,OADAhuL,KAAK0tL,YAAYM,EAAgB,GAC1BhuL,KAAK8lD,QAAQlnD,GAGtB,MAAMqvL,EAAUjuL,KAAKoiC,KACrB,IAAIA,EAAO6rJ,EAiBX,OAhBGA,EAAQn/E,SACT1sE,EAAOpiC,KAAKsoL,iBAGXroL,IACDmiC,EAAK07H,QAAQ79J,GAEVrB,EAAQiN,WACTu2B,EAAKv2B,SAAWjN,EAAQiN,WAI5B7L,KAAKgQ,cAAc,gBAAiB,CAACqB,KAAM48K,EAAS3rJ,GAAIF,IAIjDpiC,KAAK8lD,QAAQlnD,GAGfkoI,cAAcv6H,GACnBvM,KAAKq0G,aAAa,CAChB9nG,OAAAA,EACAtM,KAAM,cAIFiuL,iBAAiBlqI,GACvB,MAAMzyC,EAAKzS,SAASC,cAAc,QAClC,IAAI+X,EAAI,cAGR,OAFAvF,EAAGnS,UAAUC,IAAIyX,GACjBvF,EAAG3J,QAAQo8C,OAASA,EAAOp3C,EACpBo3C,EAAOp3C,GACZ,IAAK,0BAEHkK,GAAK,QACL,IAAI,IAAI/K,EAAI,EAAGA,EAAI,IAAKA,EAAG,CACzB,MAAMoiL,EAAMrvL,SAASC,cAAc,QACnCovL,EAAIxvL,UAAYmY,EAAI,OACpBvF,EAAG7R,OAAOyuL,GAEZ,MAGF,IAAK,+BACL,IAAK,kCACL,IAAK,+BACL,IAAK,+BACL,IAAK,+BACHr3K,GAAK,UAIL,MAGF,IAAK,+BACL,IAAK,+BACL,IAAK,+BACHA,GAAK,UACL,MAGF,IAAK,kCACL,IAAK,iCACHA,GAAK,oBACL,IAAI,IAAI/K,EAAI,EAAGA,EAAI,IAAKA,EAAG,CACzB,MAAMqiL,EAAMtvL,SAASC,cAAc,OACnCqvL,EAAIzvL,UAAYmY,EAAI,OACpBvF,EAAG7R,OAAO0uL,IAQhB,OAFA78K,EAAGnS,UAAUC,IAAIyX,GAEVvF,EAGI88K,cAAc9hL,EAAgBrL,G,0CAIzC,MAAMimC,EAAS56B,EAAO46B,SACtB,GAAGA,UAAgBnnC,KAAK2S,SAAS2I,gBAAgBulG,MAAMt0G,IAErD,OAGF,MAAMy8K,QAAgBhpL,KAAK2S,SAASq8B,kBAAkBs/I,eAAe/hL,GACrE,KAAIy8K,MAAAA,OAAO,EAAPA,EAASroL,QAEX,OAGF,MAAMsoL,EAASD,EAAQ,GAEjBuF,EAEF,CACFr+F,QAAS,CACP,wBAA2B,gCAC3B,6BAAgC,iCAChC,gCAAmC,iCACnC,6BAAgC,kCAChC,6BAAgC,kCAChC,6BAAgC,kCAChC,6BAAgC,oCAChC,6BAAgC,oCAChC,6BAAgC,oCAChC,0BAA6B,iCAC7B,+BAAkC,qCAClC,gCAAmC,yCAErC9tD,KAAM,CACJ,wBAA2B,gCAC3B,6BAAgC,iCAChC,gCAAmC,iCACnC,6BAAgC,kCAChC,6BAAgC,kCAChC,6BAAgC,kCAChC,6BAAgC,oCAChC,6BAAgC,oCAChC,6BAAgC,oCAChC,0BAA6B,iCAC7B,+BAAkC,qCAClC,gCAAmC,yCAErCosJ,MAAO,CACL,wBAA2B,uCAC3B,6BAAgC,wCAChC,gCAAmC,wCACnC,6BAAgC,yCAChC,6BAAgC,yCAChC,6BAAgC,yCAChC,6BAAgC,2CAChC,6BAAgC,2CAChC,6BAAgC,2CAChC,0BAA6B,wCAC7B,+BAAkC,8CAIhCC,EAAOtnJ,EAASonJ,EAAar+F,QAAW84F,EAAQroL,OAAS,EAAI4tL,EAAaC,MAAQD,EAAansJ,KACrG,IAAI4hB,EAASilI,EAAOjlI,OAEpB,GAAGglI,EAAQroL,OAAS,EAAG,CACrB,MAAMo5B,EAAS,GACfivJ,EAAQ57K,SAAS67K,IACf,MAAMhpL,EAAOgpL,EAAOjlI,OAAOp3C,OACZ5C,IAAZ+vB,EAAE95B,KAAqB85B,EAAE95B,GAAQ,KAClC85B,EAAE95B,MAGHksF,OAAOzuE,KAAKqc,GAAGp5B,OAAS,IACzBqjD,EAAS,CACPp3C,EAAG,4BAKT,MAAMi/B,EAAc4iJ,EAAKzqI,EAAOp3C,GAChC,IAAIi/B,EAEF,OAGF,IAAI6iJ,EACAt/K,EACJ,GAAG7C,EAAOkpC,YAAa,CACrB,MAAMrd,EAAY,IAAIE,GACtBo2J,EAAmBt2J,EAAUC,OAAO,CAAC9rB,OAAQ08K,EAAO/tK,OAAOL,UAAS,GAAQ0d,eAAe,IAC3FnpB,EAAO,CACLgpB,EAAUhuB,QACV4+K,EAAQroL,OAAS,SAGb+tL,EAGJxtL,IACFA,EAAYpC,SAASC,cAAc,SACzBK,UAAUC,IAAI,SAAU,yBAGpC6B,EAAU9B,UAAUoE,OAAO,mBAAiC,mCAAbwgD,EAAOp3C,GAAuD,oCAAbo3C,EAAOp3C,GAEvG,IAAI+hL,EAAgBztL,EAAU6nB,kBAU9B,GATI4lK,EAICA,EAAc/mL,QAAQo8C,SAAWA,EAAOp3C,GACzC+hL,EAAclwJ,YAAYz+B,KAAKkuL,iBAAiBlqI,KAJlD2qI,EAAgB3uL,KAAKkuL,iBAAiBlqI,GACtC9iD,EAAU2C,QAAQ8qL,IAOJ,oCAAb3qI,EAAOp3C,EAAyC,CAC9CwC,EACDA,EAAKwB,MAELxB,EAAO,GAGT,MAAM7F,GAAO,EAAAD,GAAA,IAAW,EAAAsvB,GAAA,GAAcorB,EAAOrc,WAC7Cv4B,EAAKyC,KAAKtI,GAGZ,MAAMqlL,GAAqB,QAAK/iJ,EAAaz8B,GAO7C,OANAw/K,EAAmBxvL,UAAUC,IAAI,2BAE9B6B,EAAU+J,kBAAoB,EAAG/J,EAAUuD,iBAAiBg6B,YAAYmwJ,GACtE1tL,EAAUxB,OAAOkvL,GAGf1tL,KAGK2tL,cAAcx0K,G,0CAC1B,MAAMy0K,QAAiB9uL,KAAKquL,cAAch0K,EAAOQ,UAAS,IAC1D,GAAGi0K,EACD,MAAO,CAAC7iK,QAAQ,EAAM3c,OAAQnM,QAAQ4B,QAAQ+pL,IAGhD,MAAMx/K,QAAetP,KAAK2S,SAASm2C,aAAa9Z,kBAAkBqL,YAAYhgC,GA0BxEvQ,EAAU3G,QAAQ4B,QAAQuK,EAAOA,QAAQ5N,MAzB5Bk3J,GAAuB,mC,QAGxC,MAAM/nH,EAAsB+nH,EAAkC/nH,qBACqC,QAAhG,EAAkF,QAAnF,EAAE+nH,EAA+B9nH,oBAAkD,eAAEA,oBAAY,eAAEnwC,SACnG,EAEA,IAAI8oC,QAAiBkH,GAAqBt2B,GAE1C,GAAGw2B,EAAqB,EACtB,OAAOpH,EAGT,MAAMslJ,QAAgB/uL,KAAK2S,SAASq8B,kBAAkBggJ,WAAW30K,GACjE,GAAG00K,EAAU,EAAG,CACd,MAAMxlL,EAAOzK,SAASC,cAAc,QAEpCwK,EAAK7J,WAAU,QAAK,CAAC+pC,GAAU,QAAK,cAAe,CAACgH,GAAuBs+I,OAAa,IACxFtlJ,EAAWlgC,EAGb,OAAOkgC,OAKX,MAAO,CACLxd,OAAQ3c,EAAO2c,OACf3c,OAAQxF,MAIEmlL,cAAc/zK,EAAgBg0K,G,gDAC1C,MAAM5/K,EAAmC,CACvC2c,QAAQ,EACR3c,OAAQnM,QAAQ4B,aAAQiF,IAGpBuO,QAAavY,KAAK2S,SAAS2I,gBAAgBC,QAAQL,GACzD,IAAI3C,GAASA,EAAKC,OAAOgvC,OAAS0nI,EAChC,OAAO5/K,EAGT,MAAMm6B,EAAWnxB,GAAoBC,GAErC,IAAIA,EAAKC,OAAOC,IAAK,CACnB,IAAIq2K,QAAiB9uL,KAAKquL,cAAcnzK,EAAOL,YAO/C,GANIi0K,GAA+B,sBAAR,QAAX,EAAAv2K,EAAKI,cAAM,eAAE/L,KAC3BkiL,EAAWhwL,SAASC,cAAc,QAClC+vL,EAAS1vL,UAAUC,IAAI,UACvByvL,EAASpvL,OAAO+pC,IAGfqlJ,EAED,OADAx/K,EAAOA,OAASnM,QAAQ4B,QAAQ+pL,GACzBx/K,EAKX,OADAA,EAAOA,OAASnM,QAAQ4B,QAAQ0kC,GACzBn6B,KAGK6/K,cAAc5iL,EAAgB2iL,G,0CAC1C,IAAI3iL,EAAQ,OACZ,IAAIzC,EAOJ,OALEA,EADCyC,EAAOkpC,YACEz1C,KAAK6uL,cAActiL,EAAO8hB,YAE1BruB,KAAKivL,cAAc1iL,EAAOqO,WAAYs0K,GAG3CplL,KAGIm9C,cACX16C,EACAnC,EACA88C,EACAkoI,EACA1gK,EACAwgK,G,0CAKA,IAAIhoI,EAAW,CAEb,MAAMmoI,EAAkBjlL,EAAQlF,cAAc,0BAC9C,GAAGmqL,UAAyBrvL,KAAKquL,cAAc9hL,EAAQ8iL,IAErD,OAIJ,MAAM//K,QAAetP,KAAKmvL,cAAc5iL,EAAQ2iL,GAEhD,IAAIxgK,IAEF,OAGF,MAAMzR,EAAM,IAAW,mCACrB,MAAMwsB,EAAWn6B,UAAgBA,EAAOA,QACxC,GAAIof,IAIJ,MAAO,KAAM,EAAA9gB,EAAA,GAAexD,EAASq/B,GAAY17B,MAG7CA,EAAcqhL,EAAgB,IAAM,GAC1C,OAAI9/K,GAAUA,EAAO2c,aACNhP,IACLiqC,EACD,KACL98C,EAAQuoB,YAAc5kB,EACfkP,IAAMvb,MAAMoD,GAAaA,GAAYA,YAHzC,KAQFikL,yBAAyB3gK,GAC9BpoB,KAAK2S,SAAS40B,mBAAmBC,UAAUxnC,KAAKoiC,KAAK71B,OAAQ,CAACK,EAAGwb,EAAS,0BAA4B,oCAI1G,MAAMgsF,GAAe,IAAIyyE,GACzB,OAAmB,kBAA8BzyE,IACjD,YC39De,MAAMk7E,WAAoBllB,GAoBvCxqK,aAAY,MAAC8wB,EAAK,KAAEruB,GAAO,EAAK,WAAEwlB,GAAa,EAAK,SAAEhiB,EAAQ,yBAAE0pL,EAAwB,MAAEC,EAAK,WAAEC,IAuC/F,GA9BA5vL,QAEAG,KAAK0wB,MAAQA,EACb1wB,KAAKwnH,QAAU1oH,SAASC,cAAc,OACtCiB,KAAKwnH,QAAQpoH,UAAUC,IAAI,gBAE3BW,KAAKuvL,yBAA2BA,EAChCvvL,KAAKwvL,MAAQA,EACbxvL,KAAKyvL,WAAaA,EAElBzvL,KAAKiJ,eAAiB,IAAI,IAE1BjJ,KAAK+iJ,MAAM,CACT34I,QAASpK,KAAKwnH,QACdv+G,eAAgBjJ,KAAKiJ,eACrByhK,gBAAiB,MACP1qK,KAAK0wB,MAAMmG,QAAY72B,KAAK0vL,oBAAuB1vL,KAAK0vL,mBAAmBtwL,UAAUiG,SAAS,cAExG0lK,uBAAwB,uBACxBF,qBAAsB,mBAGxBn6I,EAAMw+B,WAAWprD,aAAa9D,KAAKwnH,QAAS92F,GAC5C1wB,KAAKwnH,QAAQjjH,YAAYmsB,GAEzB1wB,KAAK2vL,KAAO,UAEZ3vL,KAAK4vL,YAAY/pL,GACjB7F,KAAK6vL,mBAEY,YAAd7vL,KAAK2vL,KAAoB,CAC1B,MAAMz0D,EAAWl7H,KAAKwnH,QAAQtiH,cAAc,qCAC5ClF,KAAKk9B,SAAW,IAAI1G,GAAkB9F,EAAO7I,GAC7CqzG,EAASr3H,QAAQ7D,KAAKk9B,SAASh8B,WAG9BmB,GACequB,EAAMruB,OACdwL,OAAOJ,IACG,oBAAbA,EAAIhK,OACLitB,EAAMkQ,OAAQ,EACdlQ,EAAMpvB,UAAW,EACjBovB,EAAMruB,WAEP6oB,SAAQ,KACTlrB,KAAKwnH,QAAQpoH,UAAUoE,OAAO,cAAexD,KAAK0wB,MAAMmG,WAMtD+4J,YAAYE,GAClB,MAAM,QAACtoE,EAAO,MAAE92F,EAAK,KAAEi/J,EAAI,eAAE1mL,GAAkBjJ,KAE/CwnH,EAAQpoH,UAAUC,IAAIswL,GAEtB,MAAMvrL,EAAOpE,KAAK+vL,gBAElB,IAAIC,EAEJ,GAHAxoE,EAAQhjH,mBAAmB,YAAaJ,GAG5B,YAATurL,EAAoB,CACrB3vL,KAAK0vL,mBAAqB1vL,KAAKwnH,QAAQtiH,cAAc,kBACrDlF,KAAKiwL,UAAYjwL,KAAKwnH,QAAQtiH,cAAc,QAE5C,MAAM1B,EAASgkH,EAAQl2G,iBAAiB,WAClC4+K,EAAmB1oE,EAAQtiH,cAAc,eACzCirL,EAAc3oE,EAAQtiH,cAAc,iBAC1C8qL,EAAexoE,EAAQtiH,cAAc,kBACrC8qL,EAAa1rL,UAAY6sB,GAA0B,EAAjBT,EAAM7qB,UAExC,MAAMqyI,EAAiB,IAAIjB,GAAehuI,GAEpCmnL,EAAe5oE,EAAQtiH,cAAc,kBAU3C,GATAgzI,EAAezzD,IAAIrlF,UAAUkB,OAAO,YACpC8vL,EAAatsL,aAAao0I,EAAezzD,IAAK0rG,EAAYvsL,eAE1DwN,MAAMC,KAAK7N,GAAQ4J,SAASvO,IAC1BoK,EAAe5J,IAAIR,EAAnBoK,CAA2B,SAAS,KAClCjJ,KAAKk/B,mBAINl/B,KAAKiwL,UAAW,CACjBhnL,EAAe5J,IAAIW,KAAKiwL,UAAxBhnL,CAAmC,SAAS,KAC1CjJ,KAAK0wB,MAAM2/J,6BAGb,MAAMb,EAAS7+J,IACb3wB,KAAKwnH,QAAQvkH,MAAMgyH,WAAatkG,EAAM,SAAU,GAC7C3wB,KAAKwvL,OACNxvL,KAAKwvL,MAAM7+J,IAIT2/J,EAAe,GACfC,GAAe,EAAAnkJ,GAAA,GAASojJ,EAAOc,GAAc,GAAO,GAE1DrnL,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,yBAAyB,KACjDsnL,GAAa,GAEbtnL,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,yBAAyB,KACjD,MAMMunL,EAAWvnL,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,SAN3B,KACdkF,aAAaF,GACVjO,KAAKyvL,YACNzvL,KAAKyvL,eAGoD,CAACjoL,MAAM,IAC9DyG,EAAU7H,YAAW,KACzB6C,EAAe3I,OAAOkwL,KACrBF,KACF,CAAC9oL,MAAM,OAGZyB,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,yBAAyB,KACjDsnL,GAAa,MAIb,OACFtnL,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,SAAS,KACjCjJ,KAAKk/B,gBAGPj2B,EAAe5J,IAAIP,SAAnBmK,CAA6B,WAAY5I,IACvC,GAAG46G,GAAA,iBAAgC,GAAKn8G,SAAS2xL,0BAA4B//J,EAC3E,OAGF,MAAM,IAAC7gB,EAAG,KAAE4xB,GAAQphC,EAEpB,IAAIs8D,GAAO,EACX,GAAY,SAATl7B,EACDzhC,KAAK0wL,wBACA,GAAY,SAATjvJ,EACRjK,GAAA,SAAoCA,GAAA,aAC/B,GAAY,UAATiK,EACRzhC,KAAKk/B,kBACA,IAAG7+B,EAAEuqL,QAAoB,UAATnpJ,GAA6B,UAATA,GAQjC+lF,EAAQpoH,UAAUiG,SAAS,qBAAgC,cAARwK,GAA+B,eAARA,EAIlF8sD,GAAO,EAHI,cAAR9sD,EAAqB2nB,GAAA,eAAwC,CAACwsB,OAAQ,iBACpExsB,GAAA,cAAuC,CAACwsB,OAAQ,oBAVO,CAC5D,MAAM3kD,EAAe,UAAToiC,EAAmB,GAAK,EAC9Bk2G,EAAengH,GAAA,eAEfm5J,EADMrB,GAAYsB,eAAep6K,QAAQmhI,GACzBt4I,EACnBsxL,GAAW,GAAKA,EAAUrB,GAAYsB,eAAejwL,SACtD62B,GAAA,eAA0C83J,GAAYsB,eAAeD,IASzE,OAAGh0H,IACD,EAAA10C,EAAA,GAAY5nB,IACL,QAFT,MAOJ4I,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,YAAY,KAChC,MACFjJ,KAAK0wL,sBAITznL,EAAe5J,IAAI6wL,EAAnBjnL,CAAqC,SAAS,KAC5CjJ,KAAK0wL,uBAGP,SAAsBlpE,EAASxnH,KAAK6wL,aAAa3nL,KAAKlJ,KAAMkwL,GAAmBjnL,GAE/EA,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,cAAc,KACtCknL,EAAY7rL,UAAY6sB,GAA6B,EAApBT,EAAM0G,gBAGzCnuB,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,QAAQ,KAChCu+G,EAAQpoH,UAAUC,IAAI,UAElB,MACF4J,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,QAAQ,KAChCjJ,KAAKqqK,cAAa,QAGrB,CAAC7iK,MAAM,IAEVyB,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,SAAS,KACjCjJ,KAAK2qK,cAAa,MAGpB1hK,EAAe5J,IAAIm4B,GAAA,EAAnBvuB,CAA+C,kBAAkB,KAC/DjJ,KAAK8wL,yBAIT7nL,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,QAAQ,KAChCu+G,EAAQpoH,UAAUC,IAAI,iBAGxB4J,EAAe5J,IAAIqxB,EAAnBznB,CAA0B,SAAS,KACjCu+G,EAAQpoH,UAAUkB,OAAO,iBAGxBowB,EAAM7qB,UAAYiqL,EACnBE,EAAa1rL,UAAY6sB,GAASxuB,KAAKE,MAAM6tB,EAAM7qB,UAAYiqL,KAE/D,EAAAnuJ,GAAA,GAAYjR,GAAOhvB,MAAK,KACtBsuL,EAAa1rL,UAAY6sB,GAASxuB,KAAKE,MAAM6tB,EAAM7qB,cAK/Cq5B,aACRl/B,KAAK0wB,MAAM1wB,KAAK0wB,MAAMmG,OAAS,OAAS,WAGlCk5J,gBACN,MAAMJ,EAAO3vL,KAAK2vL,KAClB,GAAY,YAATA,EACD,MAAO,0BACUA,iFACHA,gEACAA,mJAGkBA,oVAQAA,gGACvB,GAAA58F,WAAaj0F,SAASiyL,wBAA0B,2BAA2BpB,gEAAqE,2CACzHA,uHAO1BE,mBACR,MAAM1iJ,EAA4CmiJ,GAAYsB,eAAej2K,KAAI,CAACq2K,EAAM3yK,KAC/E,CAELs/C,YAAaqzH,EAAO,IACpBhpK,QAAS,KACPwP,GAAA,eAA0Cw5J,OAI1C1iH,EAAU,GAAWnhC,GAC3BmhC,EAAQlvE,UAAUC,IAAI,YACtBgvE,GACEruE,KAAK0vL,mBACL1vL,KAAKuvL,yBAA2B,KAC9BvvL,KAAKuvL,0BAAyB,SAC5BvlL,OACJA,EACAhK,KAAKuvL,yBAA2B,KAC9BvvL,KAAKuvL,0BAAyB,SAC5BvlL,GAENhK,KAAK0vL,mBAAmBhwL,OAAO4uE,GAE/BtuE,KAAK8wL,sBAGGA,sBACR,MAAMpB,EAAqB1vL,KAAK0vL,mBAChCJ,GAAY2B,qBAAqB7jL,SAASzO,IACxCA,EAAY,SAAWA,EACvB+wL,EAAmBtwL,UAAUkB,OAAO3B,MAGtC,IAAI0f,EAAMixK,GAAYsB,eAAep6K,QAAQghB,GAAA,iBACjC,IAATnZ,IAAYA,EAAMixK,GAAYsB,eAAep6K,QAAQ,IAExDk5K,EAAmBtwL,UAAUC,IAAI,SAAWiwL,GAAY2B,qBAAqB5yK,IAGrEqyK,mBACR,MAAMtlG,EAASprF,KAAKwnH,QAGpB,GAAG,GAAAhX,gBAAiB,CAClB,MAAM9/E,EAAQ1wB,KAAK0wB,MAGnB,OAFAA,EAAMwgK,6BACNxgK,EAAMygK,mBAIJ,YAyBF,YAdA,SAAkB/lG,GAkBZylG,aAAaX,GACrB,MAAM76D,GAAS,WACfr1H,KAAKwnH,QAAQpoH,UAAUoE,OAAO,mBAAoB6xH,GAC9CA,GAKF66D,EAAiB9wL,UAAUkB,OAAO,oBAClC4vL,EAAiB9wL,UAAUC,IAAI,qBAC/B6wL,EAAiB1wL,aAAa,QAAS,sBANvC0wL,EAAiB9wL,UAAUkB,OAAO,qBAClC4vL,EAAiB9wL,UAAUC,IAAI,oBAC/B6wL,EAAiB1wL,aAAa,QAAS,gBAQpCyQ,UACLpQ,MAAMoQ,UACNjQ,KAAKiJ,eAAe0G,YACpB3P,KAAKk9B,SAAS3G,kBACdv2B,KAAKuvL,yBAA2BvvL,KAAKwvL,WAAQxlL,GAhXhC,GAAA4mL,eAAiB,CAAC,GAAK,EAAG,IAAK,GAC/B,GAAAK,qBAAuB,CAAC,cAAe,cAAe,cAAe,e,2SCyCvE,MAAMG,WAIV,IAmETxxL,YACYglD,EACVysI,GAEAxxL,OAAM,GAHI,KAAA+kD,WAAAA,EA9DF,KAAA6gB,OAA6E,GAC7E,KAAA12D,QAAgG,GAChG,KAAAo+B,QAAwH,GAIxH,KAAA1lB,OAAS,EACT,KAAAS,UAAkC,KAClC,KAAAopK,oBAA4C,KAO5C,KAAAC,aAAc,EAId,KAAAC,OAAS1yL,SAASstD,eAAe,cAejC,KAAAqlI,aAKN,GAGM,KAAAC,gBAAkB,EAClB,KAAAC,gBAAkB,EAClB,KAAAC,WAAa,EACb,KAAAC,WAAa,EA2Rb,KAAAC,aAAe,CAACtxL,EAAQR,KAAKyxL,aAAaM,cAAcvxL,SA5VzC,IA8VpBA,IACDR,KAAK4xL,WAAa,EAClB5xL,KAAK6xL,WAAa,GAGpB7xL,KAAKgyL,gBAAgB/uL,MAAMkzB,UAAY,UAAU31B,YAAgBA,MAAUR,KAAK4xL,eAAe5xL,KAAK6xL,cAEpG7xL,KAAKyxL,aAAaQ,OAAO7yL,UAAUoE,OAAO,WApWvB,KAoWmChD,GACtDR,KAAKyxL,aAAaS,MAAM9yL,UAAUoE,OAAO,WApWtB,IAoWkChD,GAErDR,KAAKmyL,WAxWkB,IAwWP3xL,IAmFlB,KAAAwnB,QAAW3nB,IACT,GAAGL,KAAKoyL,yBAA0B,OAElC,MAAMjrL,EAAS9G,EAAE8G,OACjB,GAAsB,MAAnBA,EAAOE,QAAiB,OAG3B,IAFA,EAAA4gB,EAAA,GAAY5nB,GAET,KAYD,OAXGL,KAAKqyL,0BACNlkL,aAAanO,KAAKqyL,2BAElBryL,KAAKsyL,SAASlzL,UAAUC,IAAI,4BAG9BW,KAAKqyL,0BAA4BvsL,OAAOM,YAAW,KACjDpG,KAAKsyL,SAASlzL,UAAUkB,OAAO,uBAC/BN,KAAKqyL,0BAA4B,IAChC,MAKL,MAAME,EAAYvyL,KAAKuyL,YACvB,IAAIC,EAAqB,KACzB,MAAMC,EAAa,CAAC,eAAgB,uBAAwB,sBAAuB,uBAAwB,kBACxGF,GACDE,EAAW5gL,KAAK,uBAGlB4gL,EAAWrgL,MAAM2nB,IACf,IAEE,GADAy4J,GAAQ,EAAA74J,GAAA,GAAgBxyB,EAAQ4yB,GAC7By4J,EAAO,OAAO,EACjB,MAAM/kL,GAAM,OAAO,MAGiB+kL,IAAWD,GAAiC,QAAnBprL,EAAOE,SAAwC,UAAnBF,EAAOE,UAClGrH,KAAKiP,SAID,KAAA6pH,UAAaz4H,IAEnB,GAAG46G,GAAA,iBAAgC,EACjC,OAGF,MAAMprG,EAAMxP,EAAEwP,IAEd,IAAI8sD,GAAO,EACA,eAAR9sD,EACD7P,KAAKmtC,QAAQ1T,KAAKqZ,QACF,cAARjjC,EACR7P,KAAKmtC,QAAQ3T,KAAKsZ,QACF,MAARjjC,GAAuB,MAARA,EACpB7P,KAAK0yL,aACN1yL,KAAK2yL,WAAmB,MAAR9iL,GAGlB8sD,GAAO,GAGNt8D,EAAEqxI,SAAWrxI,EAAEsxI,WAChB3xI,KAAK0yL,aAAc,GAGlB/1H,IACD,EAAA10C,EAAA,GAAY5nB,IAIR,KAAAuyL,QAAWvyL,IACd46G,GAAA,iBAAgC,GAI9B56G,EAAEqxI,SAAWrxI,EAAEsxI,UAClB3xI,KAAK0yL,aAAc,EAEhB1yL,KAAKuyL,aACNvyL,KAAK8xL,iBAKH,KAAA74G,QAAW54E,IACjB,KAAG46G,GAAA,iBAAgC,IAAM,EAAAthF,GAAA,GAAgBt5B,EAAE8G,OAAQ,0BAA4BnH,KAAK0yL,gBAIpG,EAAAzqK,EAAA,GAAY5nB,GAETL,KAAK0yL,aAAa,CACnB,MAAMG,EAAcxyL,EAAE+4E,OAAS,EAE/Bp5E,KAAK2yL,aAAaE,KAncpB7yL,KAAK2S,SAAW,aAEhB3S,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,OAClB7nE,KAAKkoB,UAAY,IAAIV,GACrBxnB,KAAKsxL,oBAAsB,IAAI9pK,GAAqB,CAClDI,YAAY,EACZC,YAAY,IAEd7nB,KAAKkoB,UAAUO,YACfzoB,KAAKsxL,oBAAoB7oK,YACzBzoB,KAAKyuB,cAAgB,IAAI,KAEzBzuB,KAAKsyL,SAAWxzL,SAASC,cAAc,OACvCiB,KAAKsyL,SAASlzL,UAAUC,IAAIyzL,sBAE5B9yL,KAAK+yL,YAAcj0L,SAASC,cAAc,OAC1CiB,KAAK+yL,YAAY3zL,UAAUC,IAAI,YAE/B,MAAM2zL,EAAUl0L,SAASC,cAAc,OACvCi0L,EAAQ5zL,UAAUC,IAlGgB,gBAoGlC,MAAMk3G,EAASv2G,KAAKu2G,OAASz3G,SAASC,cAAc,OACpDw3G,EAAOn3G,UAAUC,IAAIyzL,sBAAoCA,uBAEzD,MAAMG,EAAan0L,SAASC,cAAc,OAC1Ck0L,EAAW7zL,UAAUC,IAAIyzL,4BAEzB9yL,KAAKmtC,QAAQ,gBAAkB,EAAW,QAAS,CAAC7tC,YAAY,IAGhEU,KAAKylE,OAAOvkE,UAAYpC,SAASC,cAAc,OAC/CiB,KAAKylE,OAAOvkE,UAAU9B,UAAUC,IAAIyzL,sBAAoC,aACxE,MAAMI,EAAcp0L,SAASC,cAAc,OAE3CiB,KAAKylE,OAAOp4B,SAAW,IAAIC,GAC3BttC,KAAKylE,OAAOp4B,SAASjuC,UAAUC,IAAIyzL,uBAAqC,aAExE9yL,KAAKylE,OAAO36D,OAAShM,SAASC,cAAc,OAC5CiB,KAAKylE,OAAO36D,OAAO1L,UAAUC,IAAIyzL,qBAEjC9yL,KAAKylE,OAAOtyD,KAAOrU,SAASC,cAAc,OAC1CiB,KAAKylE,OAAOtyD,KAAK/T,UAAUC,IAAIyzL,qBAE/BI,EAAYxzL,OAAOM,KAAKylE,OAAO36D,OAAQ9K,KAAKylE,OAAOtyD,MAEnDnT,KAAKylE,OAAOvkE,UAAUxB,OAAOM,KAAKylE,OAAOp4B,SAAU6lJ,GAGnD,MAAM1hG,EAAa1yF,SAASC,cAAc,OAC1CyyF,EAAWpyF,UAAUC,IAAIyzL,wBAEzBzB,EAAW/wK,OAAO,CAAC,WAAY,OAAQ,UAAUlT,SAAS3J,IACxD,MAAM5E,EAAS,EAAW4E,EAAM,CAACvE,UAAU,IAC3Cc,KAAKmtC,QAAQ1pC,GAAQ5E,EACrB2yF,EAAW9xF,OAAOb,MAGpBmB,KAAKmtC,QAAQgmJ,KAAK/zL,UAAUC,IAAI,WAGhCW,KAAKyxL,aAAavwL,UAAYpC,SAASC,cAAc,OACrDiB,KAAKyxL,aAAavwL,UAAU9B,UAAUC,IAAI,kBAE1CW,KAAKyxL,aAAaQ,OAAS,EAAW,UAAW,CAAC/yL,UAAU,KAC5D,QAAiBc,KAAKyxL,aAAaQ,QAAQ,IAAMjyL,KAAK2yL,YAAW,KACjE3yL,KAAKyxL,aAAaS,MAAQ,EAAW,SAAU,CAAChzL,UAAU,KAC1D,QAAiBc,KAAKyxL,aAAaS,OAAO,IAAMlyL,KAAK2yL,YAAW,KAEhE3yL,KAAKyxL,aAAaM,cAAgB,IAAI78J,GAAc,CAClDW,KA7JY,GA8JZjzB,IA5JiB,GA6JjBJ,IA5JiB,EA6JjB6yB,gBAAgB,GA/JK,GAiKvBr1B,KAAKyxL,aAAaM,cAAc/7J,eAChCh2B,KAAKyxL,aAAaM,cAAch8J,YAAY,CAC1CJ,QAAS31B,KAAK8xL,aACdr9J,UAAW,IAAMz0B,KAAK8xL,iBAGxB9xL,KAAKyxL,aAAavwL,UAAUxB,OAAOM,KAAKyxL,aAAaQ,OAAQjyL,KAAKyxL,aAAaM,cAAc7wL,UAAWlB,KAAKyxL,aAAaS,OAE1HlyL,KAAKsyL,SAAS5yL,OAAOM,KAAKyxL,aAAavwL,WAGvClB,KAAK+O,QAAQu8B,KAAOxsC,SAASC,cAAc,OAC3CiB,KAAK+O,QAAQu8B,KAAKlsC,UAAUC,IAAIyzL,wBAEhC9yL,KAAK+O,QAAQ7N,UAAYpC,SAASC,cAAc,OAChDiB,KAAK+O,QAAQ7N,UAAU9B,UAAUC,IAAIyzL,0BAErC9yL,KAAK+O,QAAQif,MAAQlvB,SAASC,cAAc,OAC5CiB,KAAK+O,QAAQif,MAAM5uB,UAAUC,IAAIyzL,sBAEjC9yL,KAAK+O,QAAQ7N,UAAUxB,OAAOM,KAAK+O,QAAQif,OAE3ChuB,KAAK+O,QAAQu8B,KAAK5rC,OAAOM,KAAK+O,QAAQ7N,WACtC8xL,EAAQtzL,OAAOM,KAAK+O,QAAQu8B,MAC5BtrC,KAAK+yL,YAAYrzL,OAAOszL,GAGxBC,EAAWvzL,OAAOM,KAAKmtC,QAAQ,gBAAiBntC,KAAKylE,OAAOvkE,WAC5Dq1G,EAAO72G,OAAOuzL,EAAYzhG,GAE1BxxF,KAAKmtC,QAAQ3T,KAAO16B,SAASC,cAAc,OAC3CiB,KAAKmtC,QAAQ3T,KAAK76B,UAAY,mDAC9BqB,KAAKmtC,QAAQ3T,KAAKl1B,UAAY,4DAE9BtE,KAAKmtC,QAAQ1T,KAAO36B,SAASC,cAAc,OAC3CiB,KAAKmtC,QAAQ1T,KAAK96B,UAAY,oDAC9BqB,KAAKmtC,QAAQ1T,KAAKn1B,UAAY,4DAE9BtE,KAAKgyL,gBAAkBlzL,SAASC,cAAc,OAC9CiB,KAAKgyL,gBAAgB5yL,UAAUC,IAAIyzL,uBAEnC9yL,KAAKsyL,SAAS5yL,OAAOM,KAAK+yL,YAAa/yL,KAAKmtC,QAAQ3T,KAAMx5B,KAAKmtC,QAAQ1T,KAAMz5B,KAAKu2G,OAAQv2G,KAAKgyL,iBAI/FhyL,KAAK4kD,WAAWwuI,aAAe,KAC7BpzL,KAAKmtC,QAAQ3T,KAAKp6B,UAAUoE,OAAO,QAASxD,KAAK4kD,WAAWC,SAASlkD,QACrEX,KAAKmtC,QAAQ1T,KAAKr6B,UAAUoE,OAAO,QAASxD,KAAK4kD,WAAWnrB,KAAK94B,SAGnEX,KAAKqzL,cA1IHlsL,aACF,OAAOnH,KAAK4kD,WAAWE,QAGrB39C,WAAO3G,GACTR,KAAK4kD,WAAWE,QAAUtkD,EAwIlBw1B,gBACR,QAAiBh2B,KAAKmtC,QAAQ5c,SAAUvwB,KAAKszL,iBAC7C,CAACtzL,KAAKmtC,QAAQl+B,MAAOjP,KAAKmtC,QAAQ,gBAAiBntC,KAAKsxL,oBAAoBppK,WAAW9a,SAASmE,KAC9F,QAAiBA,EAAIvR,KAAKiP,MAAM/F,KAAKlJ,UAGtC,CAAC,EAAE,EAAGA,KAAKmtC,QAAQ3T,MAAO,CAAC,EAAGx5B,KAAKmtC,QAAQ1T,OAAmCrsB,SAAQ,EAAEmmL,EAAY10L,MAEnGA,EAAOuB,iBAAiB,SAAUC,KAChC,EAAA4nB,EAAA,GAAY5nB,GACTL,KAAKwzL,iBAERxzL,KAAK4kD,WAAWQ,GAAGmuI,UAIvB,QAAiBvzL,KAAKmtC,QAAQgmJ,MAAM,KAC/BnzL,KAAKuyL,YAAavyL,KAAKmyL,YAAW,GAEnCnyL,KAAK2yL,YAAW,MAMpB3yL,KAAKsyL,SAASlyL,iBAAiB,QAASJ,KAAKgoB,SAE7ChoB,KAAK4kD,WAAW+B,OAAS,CAAC5nC,EAAMknC,KAC3BA,EAAOjmD,KAAKq9F,YAAYt+E,GACtB/e,KAAKi9F,YAAYl+E,IAGrB,MACoB,IAAIqjC,GAAa,CACpCh4C,QAASpK,KAAKsyL,SACd/uI,QAAS,CAACL,EAAOC,KACf,KAAG,WAMH,OADiBxgD,KAAKoE,IAAIm8C,GAAS,SACrB,IAAMA,EAAQ,KAGvBA,EAAQ,EACTljD,KAAKmtC,QAAQ3T,KAAKsZ,QAElB9yC,KAAKmtC,QAAQ1T,KAAKqZ,SAGb,IAGSnwC,KAAKoE,IAAIo8C,GAAS,UACrB,IAAMA,EAAQ,OAC3BnjD,KAAKiP,SACE,IAKX8zC,kBAAoB0wI,GAEyB,UAAvCA,EAAItsL,OAAuBE,WAAuB,EAAAsyB,GAAA,GAAgB85J,EAAItsL,OAAQ,0BAUhFgrL,WAAWplI,GACnB,MAAMzvC,EAAYtd,KAAKuyL,YAKvB,IAJGvyL,KAAKyxL,aAAaM,cAAc58J,WAAan1B,KAAK0yL,eACnD3lI,GAAS,GAGRzvC,IAAcyvC,EAAQ,YAEX/iD,IAAX+iD,IACDA,GAAUzvC,GAGZtd,KAAKmtC,QAAQgmJ,KAAK/zL,UAAUoE,OAAO,WAAYupD,GAC/C/sD,KAAKyxL,aAAavwL,UAAU9B,UAAUoE,OAAO,aAAcupD,GAC3D,MAAM2mI,EAAY3mI,EAAS/sD,KAAKyxL,aAAaM,cAAcvxL,MAAQ,EAQnE,GAPAR,KAAK8xL,aAAa4B,GAClB1zL,KAAKyxL,aAAaM,cAAc5oK,YAAYuqK,GAEzC1zL,KAAK2zL,aACN3zL,KAAK2zL,YAAY3oB,cAAaj+G,QAAiB/iD,GAG9C+iD,EAAQ,CACT,GAAI/sD,KAAK4zL,iBAuBP5zL,KAAK4zL,iBAAiB59J,mBAvBG,CACzB,IAAIsvB,EAAmBuuI,EACvB,MAAMrhK,GAAc,EACpBxyB,KAAK4zL,iBAAmB,IAAIxxI,GAAa,CACvCh4C,QAASpK,KAAKgyL,gBACd3uI,aAAc,KACZiC,EAAYuuI,EAAY,EACxB7zL,KAAKgyL,gBAAgB5yL,UAAUC,IAAI,kBAErCkkD,QAAS,CAACL,EAAOC,MACdD,EAAOC,GAAS,CAACD,EAAQ1wB,EAAY2wB,EAAQ3wB,GAC9CxyB,KAAK4xL,YAAc1uI,EAAQoC,EAC3BtlD,KAAK6xL,YAAc1uI,EAAQ0wI,GAC1BvuI,EAAWuuI,GAAa,CAAC3wI,EAAOC,GAEjCnjD,KAAK8xL,gBAEPlvI,QAAS,KACP5iD,KAAKgyL,gBAAgB5yL,UAAUkB,OAAO,kBAExC+hD,OAAQ,SAMZriD,KAAKyxL,aAAaM,cAAc5oK,YAAYuqK,QACnC3mI,GACT/sD,KAAK4zL,iBAAiBr9J,kBAIhBo8J,WAAWtzL,GACnBW,KAAKyxL,aAAaM,cAAc77J,YAzVlB,IAyV2C72B,EAAM,GAAK,IACpEW,KAAK8xL,eAkBGS,YACR,OAAOvyL,KAAKyxL,aAAavwL,UAAU9B,UAAUiG,SAAS,cAG9CwqL,iBAAiB1iJ,GACzB,MAAM2mJ,EAAgB,GAAiB,CAACx0L,YAAY,GAAO,cAAe6tC,GAC1EntC,KAAKu2G,OAAO72G,OAAOo0L,GAGd7kL,MAAM5O,G,MAKX,GAJGA,IACD,EAAA4nB,EAAA,GAAY5nB,GAGXL,KAAKoyL,yBAA0B,OAAOjvL,QAAQqnB,SAE9CxqB,KAAKs2F,gBACNhmF,EAAA,aAAmCtQ,KAAKs2F,gBAG1Ct2F,KAAKyuB,cAAc1jB,QAEnB,MAAMjB,EAAU9J,KAAK+zL,iBAA4B,QAAX,EAAA/zL,KAAKmH,cAAM,eAAEiD,SAAS,GAAM1I,MAAK,EAAEo0C,eAAAA,KAAoBA,IAyB7F,OAvBA91C,KAAK4kD,WAAWz4C,QACfnM,KAAK4kD,WAAqC30C,SAAYjQ,KAAK4kD,WAAqC30C,UACjGjQ,KAAKwzL,gBAAkB,KACvBxzL,KAAKynB,QAAU,EACX3hB,OAAekuL,iBAAmBh0L,OACnC8F,OAAekuL,oBAAiBhqL,GASnChK,KAAKi0L,wBAELj0L,KAAK4zL,sBAAmB5pL,EAExBF,EAAQohB,SAAQ,KACdlrB,KAAKsyL,SAAShyL,SACdN,KAAKk0L,eAAc,MAGdpqL,EAGCoqL,cAAclnI,GACtBiuD,GAAA,kBAAiCjuD,EACjCprB,EAAA,kBAAqCorB,GAG7BmnI,sBAAsBnnI,GAC3BA,EAAQhtD,KAAKo0L,qBACXp0L,KAAKi0L,wBAGFA,wBACLj0L,KAAK4zL,kBACN5zL,KAAK4zL,iBAAiBr9J,kBAGxBzwB,OAAOO,oBAAoB,UAAWrG,KAAK84H,WAC3ChzH,OAAOO,oBAAoB,QAASrG,KAAK4yL,SACzC9sL,OAAOO,oBAAoB,QAASrG,KAAKi5E,QAAS,CAAC3lD,SAAS,IAGpD8gK,qBACLp0L,KAAKuyL,aACNvyL,KAAK4zL,iBAAiB59J,eAGxBlwB,OAAO1F,iBAAiB,UAAWJ,KAAK84H,WACxChzH,OAAO1F,iBAAiB,QAASJ,KAAK4yL,SAClC,MAAoB9sL,OAAO1F,iBAAiB,QAASJ,KAAKi5E,QAAS,CAACtxE,SAAS,EAAO2rB,SAAS,IAsGnFygK,iBAAiB5sL,EAAqBktL,GAAU,EAAOC,EAAY,G,0CACjFt0L,KAAKgQ,cAAc,kBAEnB,MAAMwiL,EAAQxyL,KAAK+O,QAAQyjL,MAEvB6B,IACF7B,EAAMluL,UAAY,IAIpB,MAAMovL,EAAY1zL,KAAKuyL,aAAe8B,EAAyBr0L,KAAKyxL,aAAaM,cAAcvxL,MAxiBxE,EAyiBeR,KAAKu0L,sBAAsB/B,GAEjE,MAAMgC,EAA0B,IAAdF,EAEZnuL,EAAQ,+BAAwCquL,EAAY,IAAM,IAAO,EAY/E,IAAIC,EAEAjuL,EACDW,IACEA,aAAkBmmC,IAAiBnmC,EAAO/H,UAAUiG,SAAS,cAC9DovL,EAAattL,EACbX,EAAOW,EAAOV,yBACNU,aAAkBuf,iBAAmBvf,EAAOvD,yBAAyB8wL,yBAC7ED,GAAa,EAAA96J,GAAA,GAAgBxyB,EAAQ,cACrCX,EAAOiuL,EAAWhuL,yBACVU,EAAO/H,UAAUiG,SAAS,4BAClCovL,GAAa,EAAA96J,GAAA,GAAgBxyB,EAAQ,6BACrCX,EAAOiuL,EAAWhuL,wBAGf4tL,GAAWltL,EAAOV,wBAAwBE,OAASH,EAAKG,OACzDQ,EAASstL,EAAajuL,OAAOwD,KAK/B7C,IACFA,EAASnH,KAAK+O,QAAQif,OAGpBxnB,IACFiuL,EAAattL,EAAOvD,cACpB4C,EAAOW,EAAOV,yBAGhB,IAAIkuL,GAAc,EAClB,GAAGxtL,IAAWnH,KAAK+O,QAAQif,QAAU7mB,EAAO/H,UAAUiG,SAAS,0BAA2B,CACxF,MACM2mH,EAAc3lB,GAAeouF,GADX,EAAA96J,GAAA,GAAgB86J,EAAY,eACY,IAE7DJ,GAAaroE,GAAiD,IAAlCA,EAAYllB,SAASvxE,UAAsD,IAApCy2F,EAAYllB,SAASC,YAIjFilB,GAAkD,IAAlCA,EAAYllB,SAASvxE,UAAsD,IAApCy2F,EAAYllB,SAASC,aACpF4tF,GAAc,IAHdF,GADAttL,EAASnH,KAAK+O,QAAQif,OACFpqB,cACpB4C,EAAOW,EAAOV,yBAMlB,MAAMkhG,EAAgB3nG,KAAK+O,QAAQif,MAAMvnB,wBAEzC,IACIE,EACAE,EA6BAygB,EA/BA6O,EAAY,GAgChB,GA5BGq+J,GACD7tL,EAAqB,IAAd2tL,EAAkB,UAAoB3sF,EAAcpmG,MAC3DsF,EAAM8gG,EAAc9gG,MAEpBF,EAAOH,EAAKG,KACZE,EAAML,EAAKK,KAWbsvB,GAAa,eAAexvB,OAAUE,UAYnCM,aAAkBof,kBAAoBpf,aAAkBqf,kBAAuC,QAAnBrf,EAAOE,QAAmB,CACvG,GAAGmrL,EAAMzpK,mBAAqBypK,EAAMzpK,kBAAkB3pB,UAAUiG,SAAS,yBAA0B,CACjGiiB,EAAWkrK,EAAMzpK,kBAEjB,MAAMqiE,EAAS9jE,EAASpiB,cAAc,iBACtC,GAAGkmF,EAAQ,CACT,MAAM16D,EAAQ06D,EAAOriE,kBACrBzB,EAAS5nB,OAAOgxB,GAChB06D,EAAO9qF,SAGLgnB,EAASrkB,MAAM42I,UACjB24C,EAAMpzL,UAAUkB,OAAO,UACvBN,KAAK40L,cAActtK,EAAUqgF,EAAenhG,GACvCgsL,EAAMrtI,WACXqtI,EAAMpzL,UAAUC,IAAI,gBAGtBioB,EAAWxoB,SAASC,cAAc,OAClCuoB,EAASloB,UAAUC,IAAI,yBACvBmzL,EAAM3uL,QAAQyjB,GAGhBA,EAASrkB,MAAM42I,QAAU,UAAUrzI,EAAKjF,oBAAoBiF,EAAKhF,gCAAgCmmG,EAAcpmG,MAAQiF,EAAKjF,UAAUomG,EAAcnmG,OAASgF,EAAKhF,cAGpKgxL,EAAMvvL,MAAM1B,MAAQomG,EAAcpmG,MAAQ,KAC1CixL,EAAMvvL,MAAMzB,OAASmmG,EAAcnmG,OAAS,KAI5C,MAAMqzL,EAASruL,EAAKjF,MAAQomG,EAAcpmG,MACpCuzL,EAAStuL,EAAKhF,OAASmmG,EAAcnmG,OACvCgzL,IACFr+J,GAAa,WAAW0+J,KAAUC,SAGpC,IAAI/lD,EAAejpI,OAAOC,iBAAiB0uL,GAAYzuL,iBAAiB,iBACxE,MAAM+uL,EC/tBK,SAA2B3jK,GACxC,IAAIkvB,EAAWlvB,EAAIsR,MAAM,KACzB,GAAuB,IAApB4d,EAAS3/C,OAAc,CACpB2/C,EAAS,KAAIA,EAAS,GAAK,OAC/B,IAAI,IAAIv0C,EAAIu0C,EAAS3/C,OAAQoL,EAAI,IAAKA,EACpCu0C,EAASv0C,GAAKu0C,EAASv0C,EAAI,IAAMu0C,EAAS,IAAM,MAIpD,OAAOA,EDstBc00I,CAAkBjmD,GAOrC,GANAA,EAAegmD,EAAWp6K,KAAKvV,GAAO2S,SAAS3S,GAAKyvL,EAAU,OAAMlxK,KAAK,KACrE6wK,IACFhC,EAAMvvL,MAAM8rI,aAAeA,GAI1BslD,GAAyB,IAAdX,EAAiB,CAG7B,MAAMuB,EAAa,SAAmB,EAAIzuL,EAAKjF,MAAQ,EACjD2zL,EAAY,UAAoB,EAAI1uL,EAAKhF,OAAS,EAClDmF,EAAOH,EAAKG,KAAOsuL,EACnBpuL,EAAML,EAAKK,IAAMquL,EACvBl1L,KAAKgyL,gBAAgB/uL,MAAMkzB,UAAY,UAAU0+J,YAAiBC,MAAWnuL,MAASE,UAEtF2rL,EAAMvvL,MAAMkzB,UAAYA,EAS1B,IAAIiQ,EANJuuJ,IAAgBnC,EAAMvvL,MAAM0gE,QAAU,KAOtC,MAAMn1C,EAAQrnB,EAAO/H,UAAUiG,SAAS,UAElCw6B,EAAW7/B,KAAKoyL,0BAA2B,UAC3CjzI,EAAM,CAACrJ,eAAgBjW,GAEvB5xB,EAAU7H,YAAW,KACrBy5B,EAAS6B,aAAgB7B,EAASs1J,YACpCt1J,EAAS96B,YAEV,KAYH,GAVA86B,EAAS3U,SAAQ,KACflrB,KAAKgQ,cAAc,iBAEhBhQ,KAAKoyL,2BAA6BvyJ,IACnC7/B,KAAKoyL,yBAA2B,MAGlCjkL,aAAaF,MAGXomL,EA4JF,OAlCGltL,aAAkBiuL,gBACnBhvJ,EAAOosJ,EAAMttL,cAAc,QAExBkhC,GACDpmC,KAAKq1L,aAAajvJ,EAAMuhE,EAAektF,EAAQ1uL,GAAO,EAAOqoB,EAAOugH,IAIrE5nI,EAAO/H,UAAUiG,SAAS,uBAC3BmtL,EAAMpzL,UAAUC,IAAI,UAGtBW,KAAKs1L,mBAAkB,GAIvBlvL,YAAW,KACTosL,EAAMvvL,MAAM8rI,aAAeA,EAExByjD,EAAMzpK,oBACNypK,EAAMzpK,kBAAkC9lB,MAAM8rI,aAAeA,KAE/D5oI,EAAQ,GAEXC,YAAW,KACTosL,EAAMluL,UAAY,GAClBkuL,EAAMpzL,UAAUkB,OAAO,SAAU,SAAU,UAC3CkyL,EAAMvvL,MAAM42I,QAAU,iBAEtBh6G,EAAS96B,YACRoB,GAEHqsL,EAAMpzL,UAAUkB,OAAO,WAEhB6+C,EA5JI,CACX,IAAIo2I,EACA9uK,EAEJ,GAAGtf,aAAkBqf,iBAAkB,CACrC,MAAMyT,EAAW7oB,MAAMC,KAAKlK,EAAOvD,cAAc0N,iBAAiB,QAC/D2oB,EAASt5B,SACVwG,EAAS8yB,EAASrpB,OAItB,GAAsB,QAAnBzJ,EAAOE,SAAwC,mBAAnBF,EAAOE,QAA8B,CAClE,MACM+f,EADShW,MAAMC,KAAKlK,EAAOmK,iBAAiB,QAC7BV,MAClBwW,IACDmuK,EAAe,IAAItuK,MACnBR,EAAMW,EAAMX,IACZ+rK,EAAM9yL,OAAO61L,SAKV,GAAGpuL,aAAkBof,iBAC1BgvK,EAAe,IAAItuK,MACnBR,EAAMtf,EAAOsf,SACR,GAAGtf,aAAkBqf,iBAC1B+uK,EAAe9kK,KACf8kK,EAAa9uK,IAAMtf,EAAOsf,SACrB,GAAGtf,aAAkBiuL,cAAe,CACzC,MAAMI,EAASruL,EAAOS,QAAQ4tL,OACxBC,EAAYD,EAAS,OAErB,MAACj0L,EAAK,OAAEC,GAAUmmG,EAElB+tF,EAAS52L,SAASs9B,gBAAgB,6BAA8B,OACtEs5J,EAAO/uK,eAAe,KAAM,QAAS,GAAKplB,GAC1Cm0L,EAAO/uK,eAAe,KAAM,SAAU,GAAKnlB,GAG3Ck0L,EAAO/uK,eAAe,KAAM,UAAW,OAAOplB,KAASC,KACvDk0L,EAAO/uK,eAAe,KAAM,sBAAuB,iBAEnD+uK,EAAOlxL,mBAAmB,YAAa2C,EAAO4hB,kBAAkB4sK,UAAUl1L,QAAQ+0L,EAAQC,IAC1FC,EAAOlxL,mBAAmB,YAAa2C,EAAO1C,iBAAiBkxL,UAAUl1L,QAAQ+0L,EAAQC,IAGzF,MAAMx7C,EAAOy7C,EAAO3sK,kBACd22B,EAAMu6F,EAAKlxH,kBAAkBA,kBACnC,GAAG22B,aAAek2I,cAAe,CAC/B,IAmBIxiL,EAnBA+iB,EAAYupB,EAAIpe,eAAe,KAAM,aACzCnL,EAAYA,EAAU11B,QAAQ,mDAAmD,CAACm4D,EAAO5xD,EAAGC,EAAG4uL,EAAIC,IAU1F,aAPL9uL,EADO,IADTA,GAAKA,GAECzF,EAAS,EAAIszL,EAEb,EAAIA,MAGNrzL,aAEmCq0L,EAAKhB,OAAYiB,EAAKhB,OAE/Dp1I,EAAI/4B,eAAe,KAAM,YAAawP,GAGtCiQ,EAAO6zG,EAAKlxH,kBAAkBtkB,iBAI9B,MAAM2qI,EAAuCL,EAAarsG,MAAM,KAAK/nB,KAAKksB,GAAM9uB,SAAS8uB,KAC/EzzB,EAAPob,EAAWizI,GAAiB,EAAG,EAAGlgK,EAAQ,EAAIszL,EAAQrzL,KAAW4tI,GAC3DqyB,GAAiB,EAAIozB,EAAQ,EAAGtzL,EAAQ,EAAIszL,EAAQrzL,KAAW4tI,GACxEhpG,EAAKzf,eAAe,KAAM,IAAKvT,GAGjC,MAAMiuB,EAAgBq0J,EAAOjxL,iBAC7B48B,EAAc1a,eAAe,KAAM,QAAS,GAAKghF,EAAcpmG,OAC/D8/B,EAAc1a,eAAe,KAAM,SAAU,GAAKghF,EAAcnmG,QAEhEgxL,EAAM3uL,QAAQ6xL,GAGbpuK,IACDA,EAASrkB,MAAM8rI,aAAeA,EAE3BwmD,GACDjuK,EAAS5nB,OAAO61L,IAIpBA,EAAe/C,EAAMttL,cAAc,cAChCqwL,aAAwBhvK,mBACzBgvK,EAAan2L,UAAUC,IAAI,aACvBioB,IACFiuK,EAAatyL,MAAM1B,MAAQomG,EAAcpmG,MAAQ,KACjDg0L,EAAatyL,MAAMzB,OAASmmG,EAAcnmG,OAAS,MAGlDilB,UACKS,GAA0BquK,EAAc9uK,KAYlD+rK,EAAMvvL,MAAMC,QAAU,IAEtB,UAAQ,KACNsvL,EAAMpzL,UAAUC,IAAIm1L,EAAY,SAAW,aAyG/C,OA5DAhC,EAAMpzL,UAAUC,IAAI,iBAKd,WAONmzL,EAAMvvL,MAAMkzB,UAAY,eAAewxE,EAAchhG,UAAUghG,EAAc9gG,0BAE7E8tL,IAAgBnC,EAAMvvL,MAAM0gE,QAAU,IAEnCr8C,GACDtnB,KAAK40L,cAActtK,EAAUqgF,EAAenhG,GAK9CJ,YAAW,KACTosL,EAAMvvL,MAAM8rI,aAAe,GAExByjD,EAAMzpK,oBACNypK,EAAMzpK,kBAAkC9lB,MAAM8rI,aAAe,MAE/D,GAEHyjD,EAAM5qL,QAAQqG,QAAU,GAAK7H,YAAW,KACtCosL,EAAMpzL,UAAUkB,OAAO,SAAU,WAE9BgnB,IACEkrK,EAAMttL,cAAc,SACrBstL,EAAMpzL,UAAUkB,OAAO,UACvBgnB,EAASrkB,MAAM42I,QAAU,GACpB24C,EAAMrtI,YAOfqtI,EAAMpzL,UAAUC,IAAI,SAAU,iBAM9BmzL,EAAMpzL,UAAUC,IAAI,iBACbmzL,EAAM5qL,QAAQqG,QAErB4xB,EAAS96B,YACRoB,GAEAigC,GACDpmC,KAAKq1L,aAAajvJ,EAAMuhE,EAAektF,EAAQ1uL,GAAO,EAAMqoB,EAAOugH,GAG9D5vF,KAGCm2I,kBAAkBtoI,GACvBA,EACDhtD,KAAKsyL,SAASlzL,UAAUC,IAAI,WAE5BW,KAAKsyL,SAASlzL,UAAUC,IAAI,aAC5B+G,YAAW,KACTpG,KAAKsyL,SAASlzL,UAAUkB,OAAO,YAC9B,IAIGs0L,cAActtK,EAA0BqgF,EAAwBnhG,GAQxE,MAAMomD,EAAa+6C,EAAcpmG,MAAQomG,EAAcnmG,OAEvD,IAAI,MAACD,EAAK,OAAEC,GAAUgF,EAIjBomD,EAAa,EACdrrD,EAAQC,EAASorD,EAEjBprD,EAASD,EAAQqrD,EAKnBtlC,EAASrkB,MAAM42I,QAAU,UAAUt4I,gBAAoBC,2BAAgCmmG,EAAcpmG,MAAQA,MAAUomG,EAAcnmG,OAASA,SAIxI6zL,aAAajvJ,EAAsB5/B,EAAequL,EAAgB1uL,EAAe4vL,EAAkBvnK,EAAgBugH,GAC3H,MAAMrkH,EAAQhlB,KAAKC,OACb,MAACpE,EAAK,OAAEC,GAAUgF,EACxBL,GAAgB,EAEhB,MAAMipI,EAAKL,EAAarsG,MAAM,KAAK/nB,KAAKksB,GAAM9uB,SAAS8uB,KAEjDhR,EAAO,KACX,MAAMhd,EAAOnT,KAAKC,MAAQ+kB,EAE1B,IAAIwS,EAAW/2B,EAAQ0S,EAAO1S,EAAQ,EACnC+2B,EAAW,IAAGA,EAAW,GACzB64J,IAAS74J,EAAW,EAAIA,GAE3B,MAAM84J,EAAwC5mD,EAAGz0H,KAAKksB,GAAMA,EAAI3J,IAEhE,IAAI9pB,EACMA,EAAPob,EAAWizI,GAAiB,EAAG,EAAGlgK,EAAS,EAAIszL,EAAS33J,EAAW17B,KAAWw0L,GACxEv0B,GAAiB,EAAIozB,EAAS33J,EAAU,EAAG37B,EAA4CC,KAAWw0L,GAC3G5vJ,EAAKzf,eAAe,KAAM,IAAKvT,GAE5ByF,EAAO1S,IAAO,SAAQ0vB,IAI3BA,IAGQ0+J,sBAAsB/B,GAC9B,GAAGA,EAAMpzL,UAAUiG,SAAS,UAAW,CAErC,MAAMmB,EAAOxG,KAAK+O,QAAQif,MAAMvnB,wBAChC+rL,EAAMvvL,MAAMkzB,UAAY,eAAe3vB,EAAKG,UAAUH,EAAKK,WAC3D2rL,EAAMpzL,UAAUkB,OAAO,UAClBkyL,EAAMrtI,WACXqtI,EAAMpzL,UAAUkB,OAAO,kBAIjB21L,aAAazD,EAAoB0D,GAAS,GAClD,MAAMC,EAAU,SAEhBn2L,KAAKu0L,sBAAsB/B,GAG3BA,EAAMpzL,UAAUC,IAAI,UAEjBmzL,EAAM5qL,QAAQqG,SACfE,cAAcqkL,EAAM5qL,QAAQqG,SAG9B,MAAMzH,EAAOgsL,EAAM/rL,wBAEb2vL,EAAe5D,EAAMvvL,MAAMkzB,UAAU11B,QAAQ,uBAAuB,CAACm4D,EAAOy9H,KAChF,MAAMrvL,EAAIkvL,GAAU1vL,EAAKjF,MAAQ40L,EAGjC,OAAOv9H,EAAMn4D,QAAQ41L,EAAIrvL,EAAI,SAI/BwrL,EAAMvvL,MAAMkzB,UAAYigK,EAExBhwL,YAAW,KACTosL,EAAMlyL,WACL,KAGK+yL,cACR,MAAMiD,EAAWx3L,SAASC,cAAc,OAWxC,OAVAu3L,EAASl3L,UAAUC,IAAI,sBACvBi3L,EAASrzL,MAAMC,QAAU,OAEtBlD,KAAK+O,QAAQyjL,MACGxyL,KAAK+O,QAAQyjL,MACrB5uL,cAAclE,OAAO42L,GAE9Bt2L,KAAKgyL,gBAAgBtyL,OAAO42L,GAGvBt2L,KAAK+O,QAAQyjL,MAAQ8D,EAGpBC,kBAAkBpvL,EAAqBmf,EAAajf,GAE1D,MAAMkK,EAAKpK,EAAOE,QAAQwB,gBAAkBxB,EAAUF,EAASA,EAAOjC,cAAcmC,GACpF,GAAGkK,KAAO,EAAAooB,GAAA,GAAgBxyB,EAAQ,YAAa,CAC7C,IAAG,EAAAwyB,GAAA,GAAgBxyB,EAAQ,cAAe,CAExC,MAAM+gB,EAAY/gB,EAAOvD,cAAcA,cAAcsB,cAAc,wBACnE,GAAGgjB,EAAW,CACZ,GAAe,UAAZ7gB,EAMD,YALG6gB,EAAU9oB,UAAUiG,SAAS,WAC9B6iB,EAAU4qB,SAOd5qB,EAAU5nB,UAIdumB,GAAmBtV,EAAI+U,GAGpB/U,EAAGnS,UAAUiG,SAAS,cAAgBkM,EAAG3N,cAAcxE,UAAUiG,SAAS,6BAC3EkM,EAAGnS,UAAUkB,OAAO,cAQlBk2L,cAAclpL,EAAyB8G,GAC/C,MAAMi+B,EAAW/kC,EAAO+kC,WACxB,IAAIokJ,EACJ,GAAGpkJ,EACDokJ,EAAmB3vI,GAAc,CAC/Bv6C,OAAQe,EACRkrB,QAAQ,EACRD,eAAe,EACfz4B,WAAW,QAER,CACL,MAAMgP,EAAQ2nL,EAAmB33L,SAASC,cAAc,QACxD+P,EAAMpP,QAAO,EAAAk5B,GAAA,GAActrB,IAC3BwB,EAAM1P,UAAUC,IAAI,cAGtB,IAAIq3L,EAAY12L,KAAKylE,OAAOp4B,SAC5B,MAAM+sH,EAAYp6J,KAAKylE,OAAOp4B,SAAYqpJ,EAAU3yL,YAEpD,OAAOZ,QAAQC,IAAI,CAChBpD,KAAKylE,OAAOp4B,SAA2BxE,kBAAkB,CACxDt8B,OAAQe,GAAoB,MAC5B8qB,UAAWia,OAAWroC,EAAY,GAAKsD,IAGzCmpL,IACC/0L,MAAK,EAAEkL,EAAGkC,MACR9O,KAAKylE,OAAOp4B,WAAa+sH,KAI5B,EAAAxsJ,EAAA,GAAe5N,KAAKylE,OAAOtyD,KAAM8B,EAAmBb,KACpD,EAAAxG,EAAA,GAAe5N,KAAKylE,OAAO36D,OAAQgE,GACnC4nL,EAAUj4J,YAAYz+B,KAAKylE,OAAOp4B,cAItBspJ,WACd3oK,EACA5Z,EACA9G,EACAgnL,EACAntL,EACAgzB,GAAU,EACV4qB,EAA4B,GAC5BC,EAA4B,GAC5B33C,G,0CAGA,GAAGrN,KAAKwzL,gBAAiB,OAAOxzL,KAAKwzL,gBAMrC,MAAMoD,EAAmB52L,KAAKw2L,cAAclpL,EAAQ8G,GAE9CsZ,EAAyB,aAAZM,EAAMphB,EACnBo8I,EAAUt7H,GAAcM,EAAMwB,YAAe,CAAC,QAAS,OAAgCpoB,SAAS4mB,EAAM/tB,OAA+C,IAAtC+tB,EAAMwB,UAAUhZ,QAAQ,WAE1IxW,KAAKuxL,cAGNvxL,KAAKuxL,aAAc,EACnBvxL,KAAK4kD,WAAWiyI,WAAW9xI,EAAaC,EAAa7qB,GACpDr0B,OAAekuL,eAAiBh0L,MAShCA,KAAK4kD,WAAWnrB,KAAK94B,OAAS,IAC/ByF,YAAW,KACTpG,KAAK4kD,WAAWzjD,MAAK,KACpB,GAMLnB,KAAKmtC,QAAQ3T,KAAKp6B,UAAUoE,OAAO,QAASxD,KAAK4kD,WAAWC,SAASlkD,QACrEX,KAAKmtC,QAAQ1T,KAAKr6B,UAAUoE,OAAO,QAASxD,KAAK4kD,WAAWnrB,KAAK94B,QAEjE,MAAMO,EAAYlB,KAAK+O,QAAQif,MACzB8oK,GAAwB3vL,GAAUA,IAAWjG,EAChD41L,IAAsB3vL,EAASjG,GAElClB,KAAKmH,OAAS,CAACiD,QAASjD,GACxB,MAAMsgB,IAAWznB,KAAKynB,OAEnBvmB,EAAU6nB,oBACX7nB,EAAUoD,UAAY,IAKQ,IAAdgwL,GAEhBt0L,KAAKi2L,aAAaj2L,KAAK+O,QAAQyjL,MAAqB,IAAd8B,GACtCt0L,KAAKqzL,gBAELrzL,KAAKk0L,eAAc,GACnBl0L,KAAKo0L,2BACCwC,EAEF52L,KAAKsyL,SAAS1uL,gBAChB5D,KAAKwxL,OAAO1tL,aAAa9D,KAAKsyL,SAAUxzL,SAASstD,eAAe,iBAC3DpsD,KAAKsyL,SAASntI,YAGrBnlD,KAAKs1L,mBAAkB,GAEnB,GAAAzzI,mBACF7hD,KAAKs2F,eAAiB,CACpBr2F,KAAM,QACN0R,MAAQC,IACN,GAAG5R,KAAKoyL,yBACN,OAAO,EAGTpyL,KAAKiP,UAITqB,EAAA,WAAiCtQ,KAAKs2F,kBAM1C,MAAMk8F,EAAQxyL,KAAK+O,QAAQyjL,MAErBvxK,EAAW,SAGjB,IAAI81K,EAAU,EACd,MAAMC,EAAU,UACbA,EAAU,MAAY3nK,EAAA,aACvB0nK,EAAU,KAEZ,MAAM31K,EAAY41K,EAAU,IAAMD,EAClC,IAAI10J,EAA6Bl/B,QAAQ4B,UACzC,MAAM/D,EAAOwsB,GAAkBQ,EAAO9sB,EAAW+f,EAAUG,GAAWiO,EAAA,gBAAoCrlB,KAAc0jB,GAAcM,EAAMzN,GAAKyN,EAAMxN,IAAIC,UAC3J,GAAGq2K,EAAsB,CACvB,MAAMzpK,QAAqBrtB,KAAK2S,SAAS8c,cAAcC,gBAAgB1B,EAAOhtB,EAAKf,MACnF,IAAIqrB,EACJ,GAAG+B,EAAaE,WACdjC,EAAM,IAAIrE,MACVqE,EAAI7E,IAAM4G,EAAa/G,QAClB,CACL,MAAMqJ,EAAWvC,GAAyBY,EAAOX,GAAc,GAC5DsC,IACD0S,EAAe1S,EAASvuB,YACxBkqB,EAAMqE,EAASvI,OAIhBkE,IACDA,EAAIlsB,UAAUC,IAAI,aAClB6B,EAAUxB,OAAO4rB,IASrB,MAAMiT,KAAgC7Q,IAAcM,EAAMuQ,mBACpDrW,EAAYqW,EAAoBv+B,KAAKsxL,oBAAsBtxL,KAAKkoB,UAEhEwH,EAAkB,IACf1vB,KAAK2S,SAAS8c,cAAcC,gBAAgB1B,EAAOhtB,MAAAA,OAAI,EAAJA,EAAMf,MAGlE,IAAIuzL,EACJ,GAAGxqC,EAAS,CAKV,MAAMiuC,EAAgB5pL,GAA0B,QAAf2gB,EAAM/tB,KACjCywB,EAEDD,GAAY,CAACE,IAAKsmK,IAEjBh6K,EAAM,IAAMjd,KAAK+zL,iBAAiB5sL,GAAQ,EAAOmtL,GAAW5yL,MAAK,EAAEo0C,eAAAA,MAKvE,MAAMzxC,EAAMmuL,EAAMzpK,mBAAqBypK,EAAMzpK,kBAAkB3pB,UAAUiG,SAAS,yBAA2BmtL,EAAMzpK,kBAAoBypK,EAGjI0E,EAAa1E,EAAMttL,cAAc,SACpCgyL,GACDA,EAAW52L,SAKbowB,EAAMlxB,aAAa,cAAe,QAGlCkxB,EAAMtwB,iBAAiB,cAAc,KAChCJ,KAAKynB,SAAWA,GACjBiJ,EAAM1uB,WAIVhC,KAAKI,iBAAiB,iBAAiB,KACrCswB,EAAMjK,IAAM,GACZiK,EAAMvvB,SACL,CAACqG,MAAM,IAEP,GAAAmlB,YAGD+D,EAAMpvB,UAAW,GAGD,QAAf0sB,EAAM/tB,MACPywB,EAAMkQ,OAAQ,EACdlQ,EAAMpvB,UAAW,EACjBovB,EAAMrvB,MAAO,GACL2sB,EAAMnoB,SAAW,KACzB6qB,EAAMrvB,MAAO,GAIbgD,EAAI3E,OAAOgxB,GAGb,MAAMymK,EAAiB,IAAIh0L,SAAS4B,IAClC2rB,EAAMtwB,iBAAiB,UAAW2E,EAAS,CAACyC,MAAM,OAG9C4vL,EAAe,KACD,QAAfppK,EAAM/tB,OACPywB,EAAM9oB,QAAQyvL,KAAO,UACrB3mK,EAAM9oB,QAAQ0vL,QAAU,IAExBn0L,QAAQC,IAAI,CAAC+zL,EAAgBrhJ,IAAiBp0C,MAAK,KAC9C1B,KAAKynB,SAAWA,KAMJznB,KAAK2zL,YAAc,IAAIrE,GAAY,CAChD5+J,MAAAA,EACAruB,MAHW,EAIXwlB,WAAY0W,EACZgxJ,yBAA2BpgL,IACzBnP,KAAKsyL,SAASlzL,UAAUoE,OAAO,iBAAkB2L,IAEnDqgL,MAAQ7+J,IACN,MAAM4mK,EAAoBzxL,OAAekuL,eACzC,IAAIrjK,GAAO4mK,GAAoBA,IAAqBv3L,KAGlD,OAFAA,KAAKw3L,wBAAqBxtL,OAC1BhK,KAAKiP,QAIOjP,KAAKgyL,gBAAgBvtL,iBAC7BrF,UAAUoE,OAAO,SAAUmtB,GACjC3wB,KAAKs1L,mBAAmB3kK,GACxB3wB,KAAKk0L,eAAevjK,GACpB3wB,KAAKm0L,uBAAuBxjK,GAEzB3wB,KAAKs2F,iBACH3lE,EAAKrgB,EAAA,aAAmCtQ,KAAKs2F,gBAC3ChmF,EAAA,WAAiCtQ,KAAKs2F,iBAG1C2gG,IACEtmK,GAGD3wB,KAAKw3L,oBAAmB,GACxBx3L,KAAKw3L,wBAAqBxtL,EAE1BwtB,GAAA,sBAA+C9G,IAE/C1wB,KAAKw3L,mBAAqBhgK,GAAA,iBAA0C9G,EAAOrjB,KAIjFoiL,WAAY,KAIVzvL,KAAKiP,YAGF7O,iBAAiB,kBAAmB8uC,IACzClvC,KAAKsyL,SAASlzL,UAAUoE,OAAO,qBAAsB0rC,MAGvDlvC,KAAKI,iBAAiB,kBAAkB,KACtCJ,KAAKsyL,SAASlzL,UAAUkB,OAAO,sBAC/BN,KAAK2zL,YAAY1jL,UACjBjQ,KAAK2zL,iBAAc3pL,IAClB,CAACxC,MAAM,IAEPxH,KAAKuyL,aACNvyL,KAAK2zL,YAAY3oB,cAAa,SAQtC,GAAGzsI,EAAmB,CACpBuX,EAAep0C,MAAK,KACfgvB,EAAMmO,WAAanO,EAAM+mK,mBAC1B/pL,QAAQomB,IAAI,SACZ5L,EAAUsB,OAAOgpK,GAAO,OAQ5B,MAAMkF,EAAgB,KACpBhnK,EAAMtwB,iBAAiB,WAAW,KAChCsN,QAAQomB,IAAI,SACZ5L,EAAUqB,SACVmH,EAAM9sB,cAAcxE,UAAUkB,OAAO,kBACpC,CAACkH,MAAM,KAGZkpB,EAAMtwB,iBAAiB,WAAW,KAChC,MAAM2vC,EAAUrf,EAAMinK,eAAiBjnK,EAAMknK,gBACvCC,EAAiBnnK,EAAMmO,WAAanO,EAAM+mK,iBAG7C1nJ,GAAW8nJ,IACZH,IAEAhqL,QAAQomB,IAAI,SACZ5L,EAAUsB,OAAOgpK,GAAO,GAGxB9hK,EAAM9sB,cAAcxE,UAAUC,IAAI,oBAInCW,KAAKsyL,SAASlzL,UAAUiG,SAAS,gBAClCqrB,EAAMtwB,iBAAiB,eAAgBC,KACrC,EAAA4nB,EAAA,GAAY5nB,MAIhBq3L,IAmEA13L,KAAKyuB,cAAcpP,QAAQ,CAACle,KA/Df,IAAW,mCAKtB,MAAM2I,EAAwBy0B,EAAoBp7B,QAAQ4B,UAAY8qB,EAAA,mBAAoC,CAAC7B,MAAAA,IAuD3G,OArDIuQ,GACFuX,EAAep0C,MAAK,IAAW,0CAClBguB,KAAmBpJ,MAC5B5Y,QAAQomB,IAAI,SACZ5L,EAAUsB,OAAOgpK,GAAO,EAAM1oL,SAKpC3G,QAAQC,IAAI,CAAC0G,EAASgsC,IAAiBp0C,MAAK,IAAW,mCACrD,GAAG1B,KAAKynB,SAAWA,EAEjB,YADAznB,KAAK8zB,IAAI21C,KAAK,8BAIhB,MAAMnjD,SAAaoJ,KAAmBpJ,IAEtCoK,EAAMtwB,iBAAiB,SAAS,KACN,IAArBswB,EAAM/iB,MAAM8zB,MACbzhC,KAAK8zB,IAAInmB,MAAM,SAAW+iB,EAAM/iB,MAAM8zB,KAAO,cAAgB/Q,EAAM/iB,MAAMN,SAGxE6a,GACDA,EAAUqB,WAEX,CAAC/hB,MAAM,IAEPL,aAAkBiuL,cAEjB/wL,EAAI0kB,kBAAkBtkB,iBAAiB/E,OAAOgxB,GAGhD7J,GAAmB6J,EAAOpK,GAKzB2wK,IACDj3L,KAAKw3L,mBAAqBhgK,GAAA,iBAA0C9G,EAAOrjB,GAE3ErN,KAAKI,iBAAiB,kBAAkB,KACnCJ,KAAKw3L,qBACNx3L,KAAKw3L,qBACLx3L,KAAKw3L,wBAAqBxtL,KAE3B,CAACxC,MAAM,KAGZxH,KAAKu2L,kBAAkBpvL,EAAQmf,EAAK,SAEpC8wK,SAGKttL,UAOb0pL,EAAkBnxJ,EAAa3gC,KAAKub,OAC/B,CACL,MAAMA,EAAM,IAAMjd,KAAK+zL,iBAAiB5sL,GAAQ,EAAOmtL,GAAW5yL,MAAK,EAAEo0C,eAAAA,MAqEvE91C,KAAKyuB,cAAcpP,QAAQ,CAACle,KAhEf,IAAW,mCACtB,MAAM22L,EAAqBpqK,EAAamC,EAAA,mBAAoC,CAAC7B,MAAAA,IAAU6B,EAAA,mBAAoC,CAAC7B,MAAAA,EAAOf,MAAOjsB,IA4D1I,OA1DA80C,EAAep0C,MAAK,IAAW,0CAClBguB,KAAmBpJ,KAC5BtmB,KAAKkoB,UAAUkB,cAAc0uK,QAKjC30L,QAAQC,IAAI,CAAC0yC,EAAgBgiJ,IAAqBp2L,MAAK,IAAW,mC,MAChE,GAAG1B,KAAKynB,SAAWA,EAEjB,YADAznB,KAAK8zB,IAAI21C,KAAK,8BAMhB,MAAMnjD,SAAaoJ,KAAmBpJ,IACtC,GAAGnf,aAAkBiuL,eAInB,GAHAp1L,KAAKu2L,kBAAkBpvL,EAAQmf,EAAK,OACpCtmB,KAAKu2L,kBAAkB/D,EAAOlsK,EAAK,OAEhC+I,EAAA,WAAqB,CACtB,MAAMiQ,EAAOkzJ,EAAMlhL,iBAAiB,OACjCguB,GAAQA,EAAK3+B,QACd2+B,EAAKlyB,SAASke,IACZA,EAAIlsB,UAAUkB,OAAO,qBAItB,CACL,MAAM+D,EAAMmuL,EAAMzpK,mBAAqBypK,EAAMzpK,kBAAkB3pB,UAAUiG,SAAS,yBAA2BmtL,EAAMzpK,kBAAoBypK,EACjIuF,EAA+C,SAAd,QAArB,EAAA1zL,EAAI0kB,yBAAiB,eAAE1hB,SAAoBhD,EAAI0kB,kBAAwC,KACzG,IAAIgvK,GAAaA,EAAUtxK,MAAQH,EAAM,CACvC,IAAIc,EAAQ,IAAIH,MAChBG,EAAMhoB,UAAUC,IAAI,aAIpBwnB,GAAmBO,EAAOd,GAAK,KAC7BtmB,KAAKu2L,kBAAkBpvL,EAAQmf,EAAK,OAEjCyxK,IACD,UAAQ,KACNA,EAAUz3L,YAId+D,EAAI3E,OAAO0nB,aAMhBvZ,OAAOJ,IACRzN,KAAK8zB,IAAInmB,MAAMF,GACfzN,KAAKkoB,UAAUsB,OAAOgpK,GACtBxyL,KAAKkoB,UAAUgB,eAGV4uK,UAMXtE,EAAkBnxJ,EAAa3gC,KAAKub,GAGtC,OAAOjd,KAAKwzL,gBAAkBA,EAAgB3lL,OAAM,KAClD7N,KAAKoyL,yBAA2B,QAC/BlnK,SAAQ,KACTlrB,KAAKwzL,gBAAkB,Y,2SEvmDd,MAAM9pH,WAAuB0nH,GAU1CxxL,cA4BE,IAAIo4L,EA3BJn4L,MAAM,IAAI,IAAiB,CACzB6f,YAAcX,IACZ,MAAMk5K,EAAqD,gCAArCj4L,KAAKo/B,cAAczyB,YAAYC,GAC/C,IAACK,EAAG,OAAEV,GAAUwS,EAChBiP,GAA8B,EAAAyM,GAAA,GAAoB1b,GAExD,GAAIiP,KAEDiqK,GAAkBvuH,GAAemsC,mCAAmC7nF,IAIvE,MAAO,CAAC5jB,QAAS,KAAqB6C,IAAAA,EAAKV,OAAAA,MAE3C,CAAC,SAAU,YA4GjB,KAAA0wF,YAAoB91F,GAAqC,mCACvDnH,KAAK6pE,gBAAgB7pE,KAAK82D,iBAAiB3vD,EAAOoF,OAAQpF,EAAO8F,KAAM9F,EAAOiD,SAAU,MAG1F,KAAAizF,YAAoBl2F,GAAqC,mCACvDnH,KAAK6pE,gBAAgB7pE,KAAK82D,iBAAiB3vD,EAAOoF,OAAQpF,EAAO8F,KAAM9F,EAAOiD,QAAS,MAGzF,KAAAg9D,cAAgB,KACd,MAAMjgE,EAASnH,KAAKmH,OACpB,IAAI82D,GAAoB92D,EAAOoF,OAAQ,CAACpF,EAAO8F,KAAM,QAAQ,KAC3DjN,KAAKmH,OAAS,CAACiD,QAASpK,KAAK+O,QAAQif,OACrChuB,KAAKiP,YAIT,KAAAg4D,eAAiB,KACf,MAAM9/D,EAASnH,KAAKmH,OACjBA,EAAO8F,KAER,IAAI6wD,GAAa,CACf,CAAC32D,EAAOoF,QAAS,CAACpF,EAAO8F,OACxB,IACMjN,KAAKiP,WAKlB,KAAAipL,cAAsB73L,GAAkB,mCACtC,MAAM,IAAC4M,EAAG,OAAEV,GAAUvM,KAAKmH,OAC3B,GAAG8F,GAAOA,IAAQo5C,OAAOC,iBAAkB,CACzC,MAAMz6C,EAAW7L,KAAKo/B,cAAcvzB,SAC9BwB,QAAgBrN,KAAK82D,iBAAiBvqD,EAAQU,GACpDjN,KAAKiP,MAAM5O,GAEVqB,MAAK,IAAW,mCACf,GAAG2tB,EAAA,WAAqB,CACtB,MAAMve,EAAM,UAAuBq4C,IAChCr4C,GACDA,EAAI7B,QAIR,gBAA0B,CACxB1C,OAAQc,EAAQd,OAChB+2D,UAAWr2D,EACXhN,KAAM4L,EAAW,kBAAe7B,EAChC6B,SAAAA,aAMR,KAAAynL,gBAAkB,IAAW,mCAC3B,MAAM,OAAC/mL,EAAM,IAAEU,GAAOjN,KAAKmH,OACrBkG,QAAgBrN,KAAK82D,iBAAiBvqD,EAAQU,GAC9C+gB,GAAQ,EAAAyM,GAAA,GAAoBptB,GAC9B2gB,GACJ6B,EAAA,iBAAkC,CAAC7B,MAAAA,EAAOmC,QAAS,2CApKnDnwB,KAAK4kD,WAAWuzI,UAAY,KAC1Bn4L,KAAKiP,SAOPjP,KAAK+O,QAAQogC,QAAUrwC,SAASC,cAAc,OAC9CiB,KAAK+O,QAAQogC,QAAQ/vC,UAAUC,IAAIyzL,wBAGnC,MAAMsF,EAAoB,KACrBJ,GACD7pL,aAAa6pL,GAGfA,EAAiBlyL,OAAOM,YAAW,KACjC4xL,OAAiBhuL,EACjBhK,KAAK+O,QAAQogC,QAAQ/vC,UAAUkB,OAAO,gBACrC,MAELN,KAAK+O,QAAQogC,QAAQ/uC,iBAAiB,cAAc,KAC9CivB,EAAA,aAEJrvB,KAAK+O,QAAQogC,QAAQ/vC,UAAUC,IAAI,cAEhC24L,IACD7pL,aAAa6pL,GACbA,OAAiBhuL,GAGnBlL,SAASsB,iBAAiB,WAAYg4L,EAAmB,CAAC5wL,MAAM,QAGxC,IAAI,KAAWxH,KAAK+O,QAAQogC,SACpCya,mBAAqBwuI,EAGvCp4L,KAAKsyL,SAAS5yL,OAAOM,KAAK+O,QAAQogC,UAElC,QAAiBnvC,KAAKmtC,QAAQz9B,OAAQ1P,KAAKonE,eAE3C,MAAMj6B,EAAmC,CAACntC,KAAKq4L,eAAiB,CAC9Dp5L,KAAM,UACNQ,KAAM,UACNuoB,QAAShoB,KAAKinE,gBACbjnE,KAAKs4L,gBAAkB,CACxBr5L,KAAM,WACNQ,KAAM,+BACNuoB,QAAShoB,KAAKszL,iBACbtzL,KAAKu4L,cAAgB,CACtBt5L,KAAM,gBACNQ,KAAM,SACNuoB,QAAShoB,KAAKonE,gBAGhBpnE,KAAK6vL,iBAAiB1iJ,GAItBntC,KAAKg2B,eAlFHoJ,oBACF,OAAOp/B,KAAK4kD,WAAWxlB,cAoFfpJ,eACRn2B,MAAMm2B,gBACN,QAAiBh2B,KAAKmtC,QAAQm4E,QAAStlH,KAAKinE,iBAC5C,QAAiBjnE,KAAKylE,OAAOvkE,UAAWlB,KAAKk4L,eAE7C,MAAMM,EAAkBn4L,IACtB,GAAGA,EAAE8G,kBAAkB8jE,kBAAmB,CACxC,MAAMnV,EAAWz1D,EAAE8G,OAAuBg1E,aAAa,WACvD,IAAIrmB,GAAWA,EAAQ1uD,SAAS,mBAC9B,OAUF,OAPA,EAAA6gB,EAAA,GAAY5nB,GAEZL,KAAKiP,QAAQvN,MAAK,MAChB,QAAiB1B,KAAK+O,QAAQogC,QAASqpJ,EAAgB,CAACllK,SAAS,IAChEjzB,EAAE8G,OAA6B2rC,YAG3B,KAIX,QAAiB9yC,KAAK+O,QAAQogC,QAASqpJ,EAAgB,CAACllK,SAAS,IAezDwjC,iBAAiBvqD,EAAgBU,GACzC,OAAOjN,KAAKo/B,cAAc4iC,YAAchiE,KAAK2S,SAAS40B,mBAAmBkxJ,0BAA0BlsL,EAAQU,GAAOjN,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBvqD,EAAQU,GAgEtKyrL,WAAWrrL,GACjB,MAAM8hC,EAAW9hC,EAA4BA,QAC7C,IAAIjJ,EAA2C,GAC5C+qC,IACD/qC,GAAO,EAAAqkD,GAAA,GAAatZ,EAAS,CAC3B8jB,SAAW5lD,EAA4B8qD,kBAK3C,EAAAx/B,EAAA,GAAa34B,KAAK+O,QAAQogC,QAAQpmB,kBAAmB3kB,GACrDpE,KAAK+O,QAAQogC,QAAQ/vC,UAAUoE,OAAO,QAAS2rC,GAI1Cw6B,iBAAiB5+C,GAGtB,OAFA/qB,KAAK4kD,WAAW+kB,iBAAiB5+C,GAE1B/qB,KAGI6pE,UAAUx8D,EAAoBlG,EAAsBmtL,EAAY,EAAGn6J,GAAU,EACxF4qB,EAA0C,GAAIC,EAA0C,I,8GACxF,GAAGhlD,KAAKwzL,gBAAiB,OAAOxzL,KAAKwzL,gBAErC,MAAMvmL,EAAMI,EAAQJ,IACdK,EAAUD,EAA4B2qB,WAAa3qB,EAAQC,OAAUD,EAA4B2qB,SAASC,UAAY5qB,EAAQC,OAC9H0gB,GAAQ,EAAAyM,GAAA,GAAoBptB,GAE5BsrL,EAAmC,mBAAdtrL,EAAQT,IAA2B5M,KAAK2S,SAAS40B,mBAAmB+/B,WAAWj6D,GAC1G,CAACrN,KAAKmtC,QAAQm4E,QAAStlH,KAAKq4L,eAAejuL,SAASgD,SAASvO,IAC3DA,EAAOO,UAAUoE,OAAO,OAAQm1L,MAGlC34L,KAAKsyL,SAASlzL,UAAUoE,OAAO,cAAem1L,GAE9C,MAAMC,EAAsBD,EAC5B,CAAC34L,KAAKmtC,QAAQ5c,SAAUvwB,KAAKs4L,gBAAgBluL,SAASgD,SAASvO,IAC7DA,EAAOO,UAAUoE,OAAO,OAAQo1L,MAGlC,MAAMrxH,EAAmBvnE,KAAK2S,SAAS40B,mBAAmBggC,iBAAiBl6D,GAC3E,CAACrN,KAAKmtC,QAAQz9B,OAAQ1P,KAAKu4L,cAAcnuL,SAASgD,SAASvO,IACzDA,EAAOO,UAAUoE,OAAO,QAAS+jE,MAGnCvnE,KAAK04L,WAAWrrL,GAChB,MAAMvD,EAAU,EAAM6sL,WAAU,UAAC3oK,EAAO3gB,EAAQ8F,KAAM7F,EAAQgnL,EAAWntL,EAAQgzB,EAAS4qB,EAAaC,EAAa33C,GAIpH,OAHArN,KAAKmH,OAAO8F,IAAMA,EAClBjN,KAAKmH,OAAOoF,OAASc,EAAQd,OAEtBzC,KAGF2Z,0CAA0CuK,GAC/C,MAAmB,UAAZA,EAAMphB,GAAiB,QAA+BohB,EAAMwB,YCjRxD,MAAMqpK,WAAoE,KAIvFj5L,YAAYhB,GACViB,MAAM,OAAD,wBACAjB,GAAO,CACVonD,SAAU,CAAC1sB,EAAQ2sB,EAAOF,KACxB,GAAG/lD,KAAKuM,OAAOkpC,cAAgBwQ,EAAO,OAAO9iD,QAAQ4B,QAAQ,CAACgI,MAAO,EAAG0P,MAAO,KAE/E,MAAM/P,EAAQ4sB,MAAAA,OAAM,EAANA,EAAQoqB,QACtB,OAAO1jD,KAAK2S,SAASmxC,iBAAiBoC,cAAclmD,KAAKuM,OAAQG,EAAOq5C,GAAWrkD,MAAMlB,IACvF,MAAMic,EAAQjc,EAAM2lD,OAAOxrC,KAAK+oC,IACvB,CAACt5C,QAAS,KAAqBs5C,QAAAA,MAGxC,MAAO,CAAC32C,MAAOvM,EAAMuM,MAAO0P,MAAAA,UAKlCzc,KAAK84L,aAAc,EACnB94L,KAAKuM,OAAS3N,EAAQ2N,Q,2SClBX,MAAMwsL,WAA6B3H,GAGhDxxL,YAAY2M,GACV1M,MAAM,IAAIg5L,GAAiB,CAACtsL,OAAAA,EAAQoG,SAAU,eAAsB,IAmBtE,KAAAsqF,YAAe91F,IACbnH,KAAK6pE,UAAU1iE,EAAOu8C,QAASv8C,EAAOiD,SAAU,IAGlD,KAAAizF,YAAel2F,IACbnH,KAAK6pE,UAAU1iE,EAAOu8C,QAASv8C,EAAOiD,QAAS,IAGjD,KAAAkpL,gBAAkB,IAAW,mCAC3BzjK,EAAA,iBAAkC,CAChC7B,YAAahuB,KAAK2S,SAASmxC,iBAAiBC,SAAS/jD,KAAKmH,OAAOu8C,SACjEvzB,QAAS,2CA5BXnwB,KAAKuM,OAASA,EAEdvM,KAAK6vL,iBAAiB,CAAC,CACrB5wL,KAAM,WACNQ,KAAM,+BACNuoB,QAAShoB,KAAKszL,mBAShBtzL,KAAKg2B,eAkBM6zC,UAAUnmB,EAA4Bv8C,EAAsBmtL,EAAY,EAAGvvI,EAAgDC,G,8GACtI,GAAGhlD,KAAKwzL,gBAAiB,OAAOxzL,KAAKwzL,gBAErC,MAAM3zK,QAAc7f,KAAK2S,SAASmxC,iBAAiBC,SAASL,GACtDvE,EAAM,EAAMw3I,WAAU,UAAC92K,EAAOA,EAAM1M,KAAMnT,KAAKuM,OAAQ+nL,EAAWntL,GAAQ,EAAO49C,EAAaC,GAGpG,OAFAhlD,KAAKmH,OAAOu8C,QAAU7jC,EAAMrP,GAErB2uC,M,sTCzCX,MAAM65I,GAAkBzsL,IACrB6E,MAAMC,KAAKvS,SAASwS,iBAAiB,gCAAkC/E,EAAS,OAA2Ba,SAASlJ,IAEnHA,EAAKm0B,aAWF,SAAe4sB,GACpB99C,EACAoF,EACAmiB,EACArhB,EACA03C,EACAC,G,0CAEA,IAAInlC,QAAc,4CAAkDtT,GACpE,IAAImiB,MAAiB7O,EACnB,OAGF,MAAMo5K,EAAY,IACH7nL,MAAMC,KAAKlK,EAAOmK,iBAAiB,QAAQc,MAAMkZ,IAASA,EAAIlsB,UAAUiG,SAAS,WAChF8B,EAAS,KAGzB,GAAGoF,EAAOkpC,YAAa,CACrB,MAAMyjJ,IAAe7rL,EACfV,EAAc,gCACpB,IAAIU,IACFA,QAAgB,0CAAgD,CAC9Dd,OAAAA,EACAI,YAAa,CAACC,EAAGD,GACjBD,MAAO,EACPG,MAAO,IACNnL,MAAMlB,GAGAA,EAAMwM,QAAQ,MAGnB0hB,KACF,OAIJ,GAAGrhB,EAAS,CAEWA,EAAQ22C,OAAOnkC,MACpBrP,KAAOqP,EAAMrP,KACvB0oL,IACF7rL,EAAU,0DAAgEd,EAAQsT,KAMtF,MAAM4K,EAAK7J,GAA4BA,EAAIjG,KAAKpJ,IAAO,CACrDnH,QAASmH,EAAGnH,QACZ6C,IAAMsE,EAAGwN,KAAgC9R,IACzCV,OAASgF,EAAGwN,KAAgCxS,WAU9C,YAPA,IAAIm9D,IACHC,iBAAiB,CAChBp9D,OAAAA,EACAI,YAAa,CAACC,EAAGD,KAElBk9D,UAAUx8D,EAAS4rL,SAAajvL,OAAWA,EAAW+6C,EAAct6B,EAAEs6B,QAAe/6C,EAAWg7C,EAAcv6B,EAAEu6B,QAAeh7C,IAMpI,GAAG6V,EAAO,GACJ,EAAAs5K,GAAA,GAAS9rL,IAAYA,IACvBwS,QAAc,uCAA6CxS,IAG7D,MAAMod,EAAK7J,GAA4BA,EAAIjG,KAAKpJ,IAAO,CACrDnH,QAASmH,EAAGnH,QACZs5C,QAASnyC,EAAGwN,SAGd,IAAIg6K,GAAqBxsL,GAAQs9D,UAC/BhqD,EAAMrP,GACNyoL,SACAjvL,EACA+6C,EAAct6B,EAAEs6B,QAAe/6C,EAC/Bg7C,EAAcv6B,EAAEu6B,QAAeh7C,OAxFrC,qBAA2B,gBAAiBgvL,IAC5C,qBAA2B,mBAAyBzsL,GAAW,4CAClD,8CAAoDA,KAC7DysL,GAAezsL,QA0FnB,MAAM6sL,GAA6C,IAAInoL,IACjDouD,GAAoB,IAAIzgD,IAEf,MAAM0uB,WAAsB9Z,YAA3C,c,oBAOU,KAAA6lK,cAAe,EAEvB3lK,uBAGE,MAAMzW,EAAMm8K,GAAU5nL,IAAIxR,KAAKuM,QAC5B0Q,GAAOA,EAAIk1B,IAAInyC,QAChBid,EAAIvN,OAAO1P,MACPid,EAAIjc,MACNo4L,GAAU1pL,OAAO1P,KAAKuM,SAIvBvM,KAAKyuB,eACNzuB,KAAKyuB,cAAc5Q,UAAU7d,MAI1BgJ,mBACL,IAAI+mC,GAAU,GACd,QAAiB/vC,MAAYK,GAAM,mCAEjC,IADA,EAAA4nB,EAAA,GAAY5nB,GACT0vC,EAAS,OAEZ,MAAMxjC,EAASvM,KAAKuM,OACpBwjC,GAAU,QACJkV,GAAiBjlD,KAAMA,KAAKuM,QAAQ,IAAMvM,KAAKuM,SAAWA,IAChEwjC,GAAU,OAIPkf,cAAcrwD,GACnB,IAAI,IAAImN,KAAKnN,EAEXoB,KAAK+L,GAAKnN,EAAQmN,GAIf88B,kBAAkBjqC,GAQvB,MAAM06L,EAAYt5L,KAAKuM,OACvBvM,KAAKivD,cAAcrwD,GACnB,MAAM26L,EAAYv5L,KAAKuM,OAEvB,GAAG+sL,IAAcC,EAAjB,CAOA,GAHAv5L,KAAKuM,OAAkFgtL,EACvFv5L,KAAK4H,QAAQ2E,OAAS,GAAKgtL,EAExBD,EAAW,CACZ,MAAMr8K,EAAMm8K,GAAU5nL,IAAI8nL,GACvBr8K,IACDA,EAAIvN,OAAO1P,MACPid,EAAIjc,MACNo4L,GAAU1pL,OAAO4pL,IAKvB,OAAOt5L,KAAKq4B,UAGNjzB,EAAEmgC,GAAY,GACpB,MAAMz7B,EAAU82C,GAAS5gD,KAAMA,KAAKuM,OAAQvM,KAAKutC,SAAUvtC,KAAKo4B,UAAWmN,EAAWvlC,KAAK6gD,OAW3F,OARG7gD,KAAK4uB,eACN5uB,KAAK4uB,aAAa/c,KAAK/H,GAEvBA,EAAQohB,SAAQ,KACdlrB,KAAK4uB,kBAAe5kB,MAIjBF,EAGFuuB,SACL,GAAGr4B,KAAKyuB,cAAe,CACrB,IAAI4wC,GAAKltB,IAAInyC,KAAKuM,QAAS,CACzB,GAAGvM,KAAKq5L,aAAc,OACtBr5L,KAAKq5L,cAAe,EAEpB,IAAIp8K,EAAMm8K,GAAU5nL,IAAIxR,KAAKuM,QAgB7B,OAfI0Q,IACFA,EAAM,IAAI2B,IACVw6K,GAAUn8K,IAAIjd,KAAKuM,OAAQ0Q,IAG7BA,EAAI5d,IAAIW,MAERA,KAAKyuB,cAAc5c,KAAK,CACtBxN,IAAKrE,KACLmB,KAAM,KACJk+D,GAAKhgE,IAAIW,KAAKuM,QACPvM,KAAKq4B,YAITr4B,KAAKoF,GAAE,GACNpF,KAAKq5L,cACbr5L,KAAKyuB,cAAc5Q,UAAU7d,MAIjCq/D,GAAKhgE,IAAIW,KAAKuM,QAEd,MAAMzC,EAAU9J,KAAKoF,IAElBpF,KAAKq5L,cACNvvL,EAAQohB,SAAQ,KACdlrB,KAAKq5L,cAAe,KAIxB,MAAMp8K,EAAMm8K,GAAU5nL,IAAIxR,KAAKuM,QAC/B,GAAG0Q,EAAK,CACNA,EAAIvN,OAAO1P,MACX,MAAM4gB,EAAMxP,MAAMC,KAAK4L,GACvBm8K,GAAU1pL,OAAO1P,KAAKuM,QAGtB,IAAI,IAAIR,EAAI,EAAGpL,EAASigB,EAAIjgB,OAAQoL,EAAIpL,IAAUoL,EAChD6U,EAAI7U,GAAGssB,SAIX,OAAOvuB,GAIXkrB,eAAeC,OAAO,iBAAkBqY,I,2SCrPzB,MAAMksJ,GAQnB55L,YAAoB+S,GAAA,KAAAA,SAAAA,EAwEZ,KAAA8mL,eAAiB,IAAW,mCAClC,MAAMjhK,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAct3D,KAAK05L,YACtElhK,GACDx4B,KAAK2S,SAAS40B,mBAAmBoyJ,gBAAgB,CAACnhK,EAAOjsB,UAAWisB,EAAOohK,cAIvE,KAAAvmE,WAAa,KACnBrzH,KAAK2S,SAAS40B,mBAAmBsyJ,gBAAgB75L,KAAK05L,WAAY15L,KAAKusF,UAAU1+E,OAAYJ,GAAQ,mCACnG,GAAgB,4BAAbA,EAAIxN,KACL,GAAGD,KAAKusF,UAAY,EAClB3gD,GAAS,CAACC,YAAa,8BAClB,CACL,MAAM2tF,QAAex5H,KAAK2S,SAAS2iE,WAAWmkD,YAC9C,IAAIvsF,GAAU,0BAA2B,CACvCC,QAAS,CAAC,CACR5B,QAAS,KACTunC,UAAU,GACT,CACDvnC,QAAS,uBACTzmC,SAAU,KACR,aAAyBinF,OAG7Br+C,mBAAoB,wBACpBG,oBAAqB,EAAC,QAAK,QAAS,CAAC2rF,EAAOsgE,8BAC3C5qJ,cAMH,KAAA6qJ,cAAgB,KACtB/5L,KAAK2S,SAAS40B,mBAAmB2W,eAAel+C,KAAK05L,YAAY,IAG3D,KAAAxiD,YAAc,KACpB,IAAImH,GAAUr+I,KAAK05L,aAGb,KAAAM,cAAgB,IAAW,mCACjC,MAAMN,EAAa15L,KAAK05L,WAClBlhK,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAcoiI,GAChElhK,IAEDA,EAAO6nF,cACRrgH,KAAK2S,SAAS40B,mBAAmBm0E,YAAYg+E,EAAYlhK,EAAOyhK,aAChEj6L,KAAK2S,SAAS40B,mBAAmB46E,iBAAiBu3E,GAAY,IAE9D15L,KAAK2S,SAAS40B,mBAAmB46E,iBAAiBu3E,OAI9C,KAAAtyH,cAAgB,KACtB,IAAI9tB,GAAkBt5C,KAAK05L,aAG7B,KAAAjoE,cAAiBpxH,IACZL,KAAKqP,OACNrP,KAAKqP,OACLrP,KAAKqP,KAAO,MAGd,IAAIwjC,EAAkB,KAEtB,IACEA,GAAK,EAAA4F,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IACzB,MAAMr4C,IAER,GAAIwyC,EAAJ,CAGA,GADGxyC,aAAao9B,YAAYp9B,EAAEu0B,iBAC3B50B,KAAKoK,QAAQhL,UAAUiG,SAAS,UACjC,OAAO,EAENhF,aAAao9B,aAAYp9B,EAAEoH,cAAe,GAEnC,MAAW,mCACnBzH,KAAKusF,SAAW,YAChBvsF,KAAK05L,WAAa7mJ,EAAGjrC,QAAQ2E,OAAOsO,WACpC7a,KAAKw4B,aAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAct3D,KAAK05L,kBAElEv2L,QAAQC,IAAIpD,KAAKmtC,QAAQxyB,KAAU9b,GAAW,mCAClD,MAAM89D,QAAa99D,EAAOsf,SAE1Btf,EAAOuL,QAAQhL,UAAUoE,OAAO,QAASm5D,SAI3C38D,KAAKmtC,QAAQntC,KAAKmtC,QAAQxsC,OAAS,GAAGyJ,QAAQo0B,UAAUC,aAAY,cAAWz+B,KAAK2S,SAAS2/B,gBAAgBolH,oBAAoB13J,KAAK05L,cAEtI7mJ,EAAGzzC,UAAUC,IAAI,aACjBsmE,GAAatlE,EAAGL,KAAKoK,SACrB,eAAkCpK,KAAKoK,SAAS,KAC9CyoC,EAAGzzC,UAAUkB,OAAO,aACpBN,KAAK05L,WAAa15L,KAAKw4B,OAASx4B,KAAKusF,cAAWviF,SAIpD5E,KAvKMiK,OACNrP,KAAKmtC,QAAU,CAAC,CACdluC,KAAM,SACNQ,KAAM,eACNuoB,QAAShoB,KAAKg6L,cACd77K,OAAQ,IAAW,iDAAQne,KAAK2S,SAAS40B,mBAAmB2yJ,eAAel6L,KAAKw4B,aAC/E,CACDv5B,KAAM,YACNQ,KAAM,aACNuoB,QAAShoB,KAAKg6L,cACd77K,OAAQ,IAAMne,KAAK2S,SAAS40B,mBAAmB2yJ,eAAel6L,KAAKw4B,SAClE,CACDv5B,KAAM,MACNQ,KAAM,uBACNuoB,QAAShoB,KAAKqzH,WACdl1G,OAAQ,IAAW,mC,MAIjB,QAHiBne,KAAKusF,SAAW,SACxBvsF,KAAK2S,SAAS40B,mBAAmBilD,UAAUxsF,KAAKusF,WAAW/D,cAAcphF,SAASpH,KAAKw4B,OAAOjsB,QACjF,QAAlB,EAAAvM,KAAKw4B,OAAOhgB,cAAM,eAAEosF,YAGzB,CACD3lG,KAAM,QACNQ,KAAM,yBACNuoB,QAAShoB,KAAKqzH,WACdl1G,OAAQ,IAAW,mC,MAIjB,OAHiBne,KAAKusF,SAAW,SACxBvsF,KAAK2S,SAAS40B,mBAAmBilD,UAAUxsF,KAAKusF,WAAW/D,cAAcphF,SAASpH,KAAKw4B,OAAOjsB,WACjF,QAAlB,EAAAvM,KAAKw4B,OAAOhgB,cAAM,eAAEosF,YAGzB,CACD3lG,KAAM,OACNQ,KAAM,wBACNuoB,QAAShoB,KAAKk3I,YACd/4H,OAAQ,IAAW,mCACjB,OAAOne,KAAK05L,aAAe,kBAA0B15L,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKw4B,OAAOjsB,aAEzH,CACDtN,KAAM,SACNQ,KAAM,0BACNuoB,QAAShoB,KAAK+5L,cACd57K,OAAQ,IAAW,mCACjB,OAAOne,KAAK05L,aAAe,iBAAyB15L,KAAK2S,SAASyrC,wBAAwBO,iBAAiB3+C,KAAKw4B,OAAOjsB,aAExH,CACDtN,KAAM,UACNQ,KAAM,UACNuoB,QAAShoB,KAAKy5L,eACdt7K,OAAQ,IAAwB,IAAlBne,KAAKusF,UAAkBvsF,KAAK05L,aAAe,UACxD,CACDz6L,KAAM,YACNQ,KAAM,YACNuoB,QAAShoB,KAAKy5L,eACdt7K,OAAQ,IAAwB,IAAlBne,KAAKusF,UAAkBvsF,KAAK05L,aAAe,UACxD,CACDz6L,KAAM,gBACNQ,KAAM,SACNuoB,QAAShoB,KAAKonE,cACdjpD,OAAQ,KAAM,IAGhBne,KAAKoK,QAAU,GAAWpK,KAAKmtC,SAC/BntC,KAAKoK,QAAQoG,GAAK,sBAClBxQ,KAAKoK,QAAQhL,UAAUC,IAAI,eAC3BP,SAASstD,eAAe,cAAc1sD,OAAOM,KAAKoK,U,ICxF1C+vL,G,WCWG,MAAMC,GAoBnBx6L,YAAoB+S,EAAuBs+B,GAAvB,KAAAt+B,SAAAA,EAXZ,KAAA0nL,YAAa,EAEb,KAAAC,YAAa,EACb,KAAAC,UAAW,EACX,KAAAC,UAAW,EA4DX,KAAAC,oBAAsB,KAC5Bt3L,QAAQC,IAAI,CACVuyF,GAAA,MAAmB,MACnB,aAAA+kG,UAAA,wBACCh5L,MAAK,EAAEi5L,EAAUC,MACdD,IACFA,EAAW,eAGV36L,KAAK66L,4BACN1sL,aAAanO,KAAK66L,2BAClB76L,KAAK66L,0BAA4B,GAGnC,MAAMliL,EAASiiL,EAAiB,OAASD,GACnCG,EAASniL,GAAUA,EAAOA,SAAW,eAExC3Y,KAAKs6L,YAAcQ,GACpB96L,KAAK2S,SAASs1K,kBAAkB8S,qBAG/BD,IAAW96L,KAAKq6L,aACjBr6L,KAAKq6L,YAAa,GAGpBr6L,KAAKu6L,SAAW5hL,GAAUA,EAAOA,SAAW,cAC5C3Y,KAAKs6L,YAAcQ,EACnB96L,KAAKg7L,QAAUriL,GAAUA,EAAOqiL,QAChC,MAASh7L,KAAK8zB,IAAI,aAAc9zB,KAAKs6L,YACrCt6L,KAAKwsC,eAID,KAAAyuJ,cAAgB,CAACpvJ,EAA0Bz8B,KAC9CpP,KAAKk7L,qBAAuBrvJ,IAC/B7rC,KAAKk7L,mBAAqBrvJ,GAC1B,EAAAj+B,EAAA,GAAe5N,KAAKm7L,UAAU,QAAKtvJ,EAAaz8B,IAChDpP,KAAKo7L,gBAAgB5xK,OAAOxpB,KAAKm7L,YAe3B,KAAA3uJ,SAAW,KACjB,GAAGo2I,GAAA,oBACD,OAGF,MAAM30K,EAAUmsL,GAA0BiB,mBAC1C,GAAGr7L,KAAKs6L,WACN,GAAGt6L,KAAKu6L,SAAU,CAChB,MAAM3zJ,EAAI5mC,KAAKs7L,KAAK,mCAAmC,IAAMt7L,KAAK2S,SAAS4oL,iBAAiBC,mBAC5Fx7L,KAAKi7L,cAAc,4BAA6B,CAACr0J,SAC5C,GAAG5mC,KAAKq6L,WACb,QAAoBrwL,IAAjBhK,KAAKg7L,QAAuB,CAC7B,MAAMS,EAAY38L,SAASC,cAAc,QACnCi8L,EAAUh7L,KAAKg7L,QACf5jL,EAAU,KACd,MAAMzR,EAAMD,KAAKC,MACjB81L,EAAUx8J,UAAY,GAAKt8B,KAAKE,OAAOm4L,EAAUr1L,GAAO,KACrDA,EAAMq1L,GACP/xI,cAAcu8F,IAGZA,EAAW59F,YAAYxwC,EAAS,KACtCA,IAEA,MAAMwvB,EAAI5mC,KAAKs7L,KAAK,8BAA8B,IAAMt7L,KAAK2S,SAAS4oL,iBAAiBG,0BACvF17L,KAAKi7L,cAAc,+BAAgC,CAACQ,EAAW70J,SAE/D5mC,KAAKi7L,cAAc,sCAGrBj7L,KAAKi7L,cAAc,iCAEbj7L,KAAKw6L,UACbx6L,KAAKi7L,cAAc,YAGrB,MAASj7L,KAAK8zB,IAAI,WAAY9zB,KAAKs6L,YAAct6L,KAAKw6L,UACtD10L,OAAOS,uBAAsB,KACxBvG,KAAK27L,iBAAiBxtL,aAAanO,KAAK27L,iBAQ3C37L,KAAK27L,gBAAkB71L,OAAOM,YANnB,MACT,QAAcpG,KAAK47L,gBAAiB,WAAY57L,KAAKs6L,YAAct6L,KAAKw6L,SAAU,KAClFx6L,KAAK27L,gBAAkB,EACvB,MAAS37L,KAAK8zB,IAAI,qBAAsB9zB,KAAKs6L,YAAct6L,KAAKw6L,YAGrBvsL,OAtJ/CjO,KAAK8zB,KAAM,EAAA+zC,GAAA,IAAO,UAAM79D,OAAWA,GAEnChK,KAAK47L,gBAAkB98L,SAASC,cAAc,OAC9CiB,KAAK47L,gBAAgBx8L,UAAUC,IAAI,qBAEnCW,KAAKm7L,UAAW,OAAO,kDAAmD,CAACj8L,UAAU,IACrFc,KAAKo7L,gBAAkB,IAAI5zK,GAAqB,CAACI,YAAY,IAC7D5nB,KAAKo7L,gBAAgB/yK,mBAAmB,CAACC,MAAO,cAAeC,MAAM,IACrEvoB,KAAK47L,gBAAgBl8L,OAAOM,KAAKm7L,UAEjClqJ,EAAeptC,QAAQ7D,KAAK47L,iBAE5B,qBAA2B,4BAA6BjjL,IACtDjL,QAAQomB,IAAInb,GAEZ3Y,KAAKy6L,yBAGP,qBAA2B,uBAAwBjrJ,IAC7CA,IACFxvC,KAAKw6L,UAAW,EAChB,MAASx6L,KAAK8zB,IAAI,WAAY9zB,KAAKw6L,UACnCx6L,KAAKwsC,eAIT,qBAA2B,sBAAuBgD,IAChD,MAASxvC,KAAK8zB,IAAI,qBAAsB0b,GACpCA,IACFxvC,KAAKw6L,UAAW,EAChB,MAASx6L,KAAK8zB,IAAI,WAAY9zB,KAAKw6L,UACnCx6L,KAAKwsC,eAITxsC,KAAK66L,0BAA4B/0L,OAAOM,WAAWpG,KAAKy6L,oBAAqBL,GAA0BiB,mBAAqB,KAyDtHC,KAAKzvJ,EAA0B/mC,GACrC,MAAM8hC,EAAI9nC,SAASC,cAAc,KAQjC,OAPA6nC,EAAExnC,UAAUC,IAAI,mBAChBunC,EAAElnC,QAAO,QAAKmsC,KACd,QAAiBjF,GAAIvmC,KACnB,EAAA4nB,EAAA,GAAY5nB,GACZyE,OAGK8hC,GC/II,SAASi1J,GAAcxpL,EAAW04C,EAAWj0C,EAAW1D,GACrE,OAAOf,GAAKe,EAAI23C,EAAIj0C,GAAKA,EAAI,GAAKnU,KAAK64E,IAAI74E,KAAKq+B,GAAK3uB,EAAIe,GAAK,GAAK23C,ECFtD,SAAS+wI,GACtBrwK,EACAzkB,EACAC,EACA1F,EACAC,EACA+pB,EACAipC,EACAxC,GAEA,MAAMqqG,EAAM5wI,EAAIzoB,OAAOq5J,IAQvB,GAPGA,IACDr1J,GAAKq1J,EACLp1J,GAAKo1J,EACL96J,GAAS86J,EACT76J,GAAU66J,GAGU,iBAAb,EACJA,IAAK9wI,GAAU8wI,GAClB9wI,EAAS,CAACm2I,GAAIn2I,EAAQo2I,GAAIp2I,EAAQ6jH,GAAI7jH,EAAQq2I,GAAIr2I,OAC7C,CACL,MAAMwwK,EAAgB,CAACr6B,GAAI,EAAGC,GAAI,EAAGvyB,GAAI,EAAGwyB,GAAI,GAChD,IAAI,MAAMt9H,KAAQy3J,EAEhBxwK,EAAO+Y,GAAQ/Y,EAAO+Y,GAAS+3H,EAAM9wI,EAAO+Y,GAAQ+3H,EAAM9wI,EAAO+Y,GAASy3J,EAAcz3J,GAI5F7Y,EAAI83I,YACJ93I,EAAI+3I,OAAOx8J,EAAIukB,EAAOm2I,GAAIz6J,GAC1BwkB,EAAIg4I,OAAOz8J,EAAIzF,EAAQgqB,EAAOo2I,GAAI16J,GAClCwkB,EAAIuwK,iBAAiBh1L,EAAIzF,EAAO0F,EAAGD,EAAIzF,EAAO0F,EAAIskB,EAAOo2I,IACzDl2I,EAAIg4I,OAAOz8J,EAAIzF,EAAO0F,EAAIzF,EAAS+pB,EAAO6jH,IAC1C3jH,EAAIuwK,iBAAiBh1L,EAAIzF,EAAO0F,EAAIzF,EAAQwF,EAAIzF,EAAQgqB,EAAO6jH,GAAInoI,EAAIzF,GACvEiqB,EAAIg4I,OAAOz8J,EAAIukB,EAAOq2I,GAAI36J,EAAIzF,GAC9BiqB,EAAIuwK,iBAAiBh1L,EAAGC,EAAIzF,EAAQwF,EAAGC,EAAIzF,EAAS+pB,EAAOq2I,IAC3Dn2I,EAAIg4I,OAAOz8J,EAAGC,EAAIskB,EAAOm2I,IACzBj2I,EAAIuwK,iBAAiBh1L,EAAGC,EAAGD,EAAIukB,EAAOm2I,GAAIz6J,GAC1CwkB,EAAIy4I,YAED1vG,GACD/oC,EAAI+oC,OAGHxC,GACDvmC,EAAIumC,SFvBQ,GAAAqpI,mBAAqB,IDZrC,SAAYlB,GACV,sBACA,yBACA,mBACA,mBAJF,CAAYA,KAAAA,GAAc,KIC1B,MAAM8B,GAAMn2L,OAAOoa,iBACbg8K,GAAO,GAAKD,GACZE,GAAS,IAAMF,GACf,GAAQ,EAAIA,GACZ,GAAS,EAAIA,G,0BCbJ,MAAMG,GAArB,cAGU,KAAAxqK,KAAO,iBACP,KAAAyqK,SAAW32L,KAAKC,MAChB,KAAA22L,SAAW,EACX,KAAAC,OAAS,EACT,KAAA1lK,QAAS,EACT,KAAA2lK,WAAa,EACb,KAAAC,cAAgB,IAChB,KAAAC,YAAc,EACd,KAAAhgH,IAAM,KACN,KAAAigH,YAAc,IACd,KAAAC,WAAa,CAAC,QAAQ,QAAQ,QAAQ,SACtC,KAAAC,sBAAwB,EAIxBC,WACN98L,KAAKs8L,SAAW52L,KAAKC,MAAQ3F,KAAKq8L,SAClCr8L,KAAKq8L,SAAW32L,KAAKC,MAGfo3L,mBACJ/8L,KAAK68L,sBACJ78L,KAAK68L,uBAAyB78L,KAAK48L,WAAWj8L,SAC/CX,KAAK68L,sBAAwB,GAIzBpsL,UACN,MAAMusL,EAAmBh9L,KAAK48L,WAAW58L,KAAK68L,uBAC9C,MAAwB,SAArBG,EACMh9L,KAAKi9L,cACiB,UAArBD,EACDh9L,KAAKk9L,oBAEZxvL,QAAQomB,IAAI,2BAA6BjH,OAAOmwK,IAI5CC,cACN,IAEE73L,EADW,GAOb,MAAO,KACL,IAAI+3L,EAAwBn9L,KAAKs8L,UAAY,IAAO,IAJxC,GAkBZ,OAbGt8L,KAAK62B,OACFnxB,KAAKC,MAAQ3F,KAAKw8L,WALb,MAMPp3L,EAXO,GAYPpF,KAAK+8L,iBACL/8L,KAAK62B,QAAS,IAGhBzxB,EAAI2S,SAAS,IAAM3S,EAAI+3L,MAjBb,MAmBRn9L,KAAK62B,QAAS,EACd72B,KAAKw8L,WAAa92L,KAAKC,OAGpB,OAAQP,EAAI,IAAMA,EAAI,IAAMA,EAAI,KAInC83L,eACN,IAEEE,EACAC,EACAC,EAJEj5I,EAAWrkD,KAAKyrB,IAAIi5I,qBAAqB,EAAG,EAAG1kK,KAAKgD,OAAOzB,MAAO,GACpE47L,EAAWn9L,KAAK08E,KAAO18E,KAAKs8L,UAAY,IAAO,KAIjD,GAAGt8L,KAAK62B,QACN,GAAInxB,KAAKC,MAAQ3F,KAAKw8L,WAAcx8L,KAAKy8L,cAIvC,OAHAz8L,KAAK08L,aAAe,GACpB18L,KAAK+8L,iBACL/8L,KAAK62B,QAAS,EACP72B,KAAKk9L,oBAGdl9L,KAAK08L,aAAeS,EACjBn9L,KAAK08L,YAAe,EAAI18L,KAAK28L,cAC9B38L,KAAK62B,QAAS,EACd72B,KAAKw8L,WAAa92L,KAAKC,OAI3B23L,GAAc,EAAAz5K,GAAA,GAAM7jB,KAAK08L,YAAa,EAAG,GACzCU,GAAY,EAAAv5K,GAAA,GAAM7jB,KAAK08L,YAAc18L,KAAK28L,YAAa,EAAG,GAC1DU,GAAa,EAAAx5K,GAAA,GAAM7jB,KAAK08L,YAAc18L,KAAK28L,YAAa,EAAG,GAE3D,MAAMl8G,EAAkB,eAA6B,yBAC/C88G,EAAe,eAA6B,iBAKlD,OAJAl5I,EAASsgH,aAAay4B,EAAW38G,GACjCp8B,EAASsgH,aAAa24B,EAAaC,GACnCl5I,EAASsgH,aAAa04B,EAAY58G,GAE3Bp8B,EAGFizB,SAASk0E,EAQX,I,gBACHxrJ,KAAKgD,OAAoB,QAAX,EAAAwoJ,EAAKxoJ,cAAM,QAAIlE,SAASC,cAAc,UACpDiB,KAAKyrB,IAAMzrB,KAAKgD,OAAO6P,WAAW,MAClC7S,KAAK4xB,KAAgB,QAAT,EAAA45H,EAAK55H,YAAI,QAAI5xB,KAAK4xB,KAC9B5xB,KAAK28L,YAA8B,QAAhB,EAAAnxC,EAAKmxC,mBAAW,QAAI38L,KAAK28L,YAC5C38L,KAAK08E,IAAc,QAAR,EAAA8uE,EAAK9uE,WAAG,QAAI18E,KAAK08E,IAC5B18E,KAAK48L,WAA4B,QAAf,EAAApxC,EAAKoxC,kBAAU,QAAI58L,KAAK48L,WAC1C58L,KAAKP,KAAgB,QAAT,EAAA+rJ,EAAK/rJ,YAAI,QAAIO,KAAKP,KAC9BO,KAAKq8E,UAAYmvE,EAAKnvE,UAEtBr8E,KAAKgD,OAAO5D,UAAUC,IAAI,kBAGrBm+L,KACL,MAAM,MAACj8L,EAAK,OAAEC,GAAUxB,KAAKgD,OAE7BhD,KAAK88L,WAEL98L,KAAKyrB,IAAI3Y,UAAU,EAAG,EAAGvR,EAAOC,GAE7BxB,KAAK4xB,OACN5xB,KAAKyrB,IAAImG,KAAO5xB,KAAK4xB,MAGvB5xB,KAAKyrB,IAAI4wD,UAAYr8E,KAAKyQ,UAC1BzQ,KAAKyrB,IAAI6wD,SAAS,EAAG,EAAG/6E,EAAOC,GAE5BxB,KAAKq8E,YACNr8E,KAAKyrB,IAAI4wD,UAAYr8E,KAAKq8E,UAC1Br8E,KAAKyrB,IAAI6wD,SAAS,EAAG,EAAG/6E,EAAOC,IAG9BxB,KAAKP,MACNO,KAAKyrB,IAAIm5J,SAAS5kL,KAAKP,KAAM,GAAI,KCnIxB,MAAMg+L,GA2BnB79L,cAgMQ,KAAA89L,cAAgB,KACtB19L,KAAK29L,gBACL39L,KAAK49L,kBAGC,KAAAxlC,SAAW,KACjB,MAAM,OAACp1J,GAAUhD,MACX,MAACuB,EAAK,OAAEC,EAAM,IAAE66J,GAAOr5J,EAC7BhD,KAAK69L,mBACF76L,EAAOzB,QAAUA,GAASyB,EAAOxB,SAAWA,GAAUwB,EAAOq5J,MAAQA,IAIxEr8J,KAAK29L,gBACL39L,KAAK49L,mBA7ML59L,KAAK89L,QAAU,IAAI1B,GACnBp8L,KAAKynB,OAAS,EACdznB,KAAKgD,OAASlE,SAASC,cAAc,UACrCiB,KAAKgD,OAAO5D,UAAUC,IAAI,8BAC1BW,KAAKyrB,IAAMzrB,KAAKgD,OAAO6P,WAAW,MAElC7S,KAAK+9L,gBAAkB,GACvB/9L,KAAKuN,WAAa,GAClBvN,KAAKg+L,eAAiB,EACtBh+L,KAAKylB,WAAa,GAClBzlB,KAAKi+L,iBAAmB,EACxBj+L,KAAKk+L,mBAAqB,EAC1Bl+L,KAAKm+L,YAAc,GAGd30K,QAAO,UAACtoB,EAAS,KAAEsF,EAAI,YAAE43L,EAAW,SAAEC,EAAQ,gBAAEC,IAOrD,MAAM,OAACt7L,GAAUhD,KAEjBA,KAAKq+L,SAAWA,EAChBr+L,KAAKo+L,YAAcA,GAAel9L,GAC/BlB,KAAKs+L,gBAAkBA,KACxBA,EAAgBp9L,UAAU+B,MAAMs7L,UAAY,UAG9Cv+L,KAAK69L,iBAAiBr3L,GACtBxG,KAAK49L,iBACL18L,EAAUxB,OAAOsD,GAGZumB,OAAOi1K,GACTx+L,KAAKy+L,aAIRz+L,KAAKw+L,gBAAkBA,EACvBx+L,KAAKy+L,WAAa/4L,KAAKC,MAEnB,gCACF3F,KAAKM,UAIFA,SACLN,KAAK29L,gBAEF39L,KAAKgD,OAAOY,gBACb5D,KAAKgD,OAAO1C,SAETN,KAAKq+L,WACNr+L,KAAKq+L,WACLr+L,KAAKq+L,cAAWr0L,GAGfhK,KAAKs+L,kBACNt+L,KAAKs+L,gBAAgBp9L,UAAU+B,MAAMs7L,UAAY,GACjDv+L,KAAKs+L,qBAAkBt0L,IAKrB6zL,iBAAiBr3L,EAAwCxG,KAAKo+L,YAAY33L,yBAChF,MAAM,OAACzD,GAAUhD,KACXq8J,EAAMr5J,EAAOq5J,IAAMv2J,OAAOoa,iBAChCld,EAAOzB,MAAQiF,EAAKjF,MAAQ86J,EAC5Br5J,EAAOxB,OAASgF,EAAKhF,OAAS66J,EAC9Br5J,EAAOC,MAAM1B,MAAQiF,EAAKjF,MAAQ,KAClCyB,EAAOC,MAAMzB,OAASgF,EAAKhF,OAAS,KAG9Bk9L,6BACN,MAAM,OACJ17L,EAAM,IACNyoB,EAAG,WACHgzK,EAAU,OACV99L,EAAM,gBACN69L,GACEx+L,KAEJ,IAAIy+L,EACF,OACK,IAAI,+BAET,YADAz+L,KAAKM,SAIP,MAAM,MAACiB,GAASyB,EAEhByoB,EAAI+wI,yBAA2B,kBAO/B,MAEMv2J,EAAcP,KAAKC,MAAQ84L,EACjC,IAAIE,GAAY,EAChB,IAAI,IAAI5yL,EAAI,EAAGA,EAAIpL,IAAUoL,EAAG,CAC9B,MACM6yL,EAAiB34L,GADTu4L,EAAkB79L,GAAUoL,GAAKyyL,EAJnC,IAI8DA,EAAkB,GAJhF,GAI6FzyL,GAEzG,GAAG6yL,GAAkB,EAAG,CACtBD,GAAY,EACZ,SAGF,MAAMzhK,EAAW2+J,GAAc+C,EAAgB,EAAG,EAZnC,KAcfnzK,EAAI83I,YACJ93I,EAAIjlB,KAAK,EAAGxG,KAAK6+L,aAAe9yL,EAAGxK,EAAOvB,KAAK6+L,cAC/CpzK,EAAI4wD,UAAY,iBAAiBn/C,KACjCzR,EAAI+oC,OAEDt3B,EAAW,IACZyhK,GAAY,GAoBhBlzK,EAAI+wI,yBAA2B,cAE5BmiC,GACD3+L,KAAKM,SAID4qK,cACNlrK,KAAK89L,QAAQN,KACbx9L,KAAK0+L,6BAGCd,iBACN,MAAM,OAAC56L,EAAM,QAAE86L,GAAW99L,KACpBynB,IAAWznB,KAAKynB,OAChB47D,EAAUrjF,KAAK8+L,gBAErBhB,EAAQxmH,SAAS,CACft0E,OAAAA,EACAq5E,UAAWgH,IAGb,MAAM30D,EAAa,IACV1uB,KAAKynB,SAAWA,EAGzBznB,KAAKkrK,eACL,UAAQ,MACFx8I,MAKD,gCACD1uB,KAAKkrK,cAIAx8I,OAGT,qBAA2B,eAAgB1uB,KAAK09L,eAChDruK,EAAA,mBAA4B,SAAUrvB,KAAKo4J,UAGrCulC,kBACJ39L,KAAKynB,OACP,wBAA8B,eAAgBznB,KAAK09L,eACnDruK,EAAA,sBAA+B,SAAUrvB,KAAKo4J,UAoBxC0mC,gBACN,MAAM,OAAC97L,EAAM,IAAEyoB,GAAOzrB,KAEhBy9J,EAAgB3+J,SAASC,cAAc,UACvCggM,EAAiBthC,EAAc5qJ,WAAW,MAC1CwpJ,EAAMr5J,EAAOq5J,IACnBoB,EAAcpB,IAAMA,EACpBoB,EAAcl8J,MAAQyB,EAAOzB,MAC7Bk8J,EAAcj8J,OAASwB,EAAOxB,OAE9Bu9L,EAAe1iH,UAAY,eAA6B,iBACxD0iH,EAAeziH,SAAS,EAAG,EAAGmhF,EAAcl8J,MAAOk8J,EAAcj8J,QAEjEu9L,EAAe1iH,UAAY,OAC3B0iH,EAAeviC,yBAA2B,kBAE1C,MAAMqiC,EAAe7+L,KAAK6+L,cAAgB7+L,KAAKuN,WAAmC,EAAtBvN,KAAKg+L,gBAAsB3hC,EACjF17J,EAASX,KAAKW,OAASgC,KAAKoR,KAAK/Q,EAAOxB,OAASq9L,GACvD,IAAI,IAAI9yL,EAAI,EAAGA,EAAIpL,IAAUoL,EAC3B/L,KAAKg/L,SAASD,EAAgBhzL,EAAGA,EAAI8yL,GAGvC,OAAOpzK,EAAIqzK,cAAcrhC,EAAe,aAGlCuhC,SAASvzK,EAA+B1f,EAAW9E,GACzD,IAAI82L,EAAkB/9L,KAAK+9L,gBAAgBhyL,GACvCgyL,IACFA,EAAkB/9L,KAAK+9L,gBAAgBhyL,GAAK,CAC1CkzL,eAAgB,GAAqB,IAAhBt8L,KAAKsiC,SAC1Bi6J,gBAAiB,IAAsB,IAAhBv8L,KAAKsiC,SAC5Bk5J,YAAa,GAAqB,GAAhBx7L,KAAKsiC,WAI3B,MAAM,eACJg6J,EAAc,gBACdC,EAAe,YACff,GACEJ,GAEE,OAAC/6L,GAAUyoB,GACX,IAAC4wI,GAAOr5J,EACdiE,GAAKo1J,EAEL,MAAM,WACJ9uJ,EAAU,eACVywL,EAAc,WACdv4K,EAAU,iBACVw4K,EAAgB,mBAChBC,GACEl+L,KAEJ,IAAIm/L,EAAa,IC5Rd,SAA6B1zK,EAA+BzkB,EAAWC,EAAWskB,EAAgBipC,EAAgBxC,IArB1G,SAAoBvmC,EAA+BzkB,EAAWC,EAAWskB,EAAgBipC,EAAgBxC,GACtH,MAAMqqG,EAAM5wI,EAAIzoB,OAAOq5J,IACpBA,IACDr1J,GAAKq1J,EACLp1J,GAAKo1J,EACL9wI,GAAU8wI,GAGZ5wI,EAAI83I,YACJ93I,EAAI+4J,IAAIx9K,EAAGC,EAAGskB,EAAQ,EAAG,EAAI5oB,KAAKq+B,IAAI,GACtCvV,EAAIy4I,YAED1vG,GACD/oC,EAAI+oC,OAGHxC,GACDvmC,EAAIumC,UAKCotI,CAAW3zK,EAAKzkB,EAAIukB,EAAQtkB,EAAIskB,EAAQA,EAAQipC,EAAMxC,ID4R3DqtI,CAAoB5zK,EAAK0zK,EAAYl4L,EAAI+2L,EAAgBzwL,EAAa,GAAG,GAEzE4xL,GAAc5xL,EAAa,GAC3BuuL,GAAUrwK,EAAK0zK,EAAYl4L,EAAI+2L,EAAiBE,EAAoBe,EAAgBx5K,EAAYw4K,GAAkB,GAClHnC,GAAUrwK,EAAK0zK,EAAYl4L,EAAI+2L,EAAiBzwL,EAAakY,EAAay4K,EAAoBgB,EAAiBz5K,EAAYw4K,GAAkB,GAE7InC,GAAUrwK,EAAKzoB,EAAOzB,MAAQ86J,EAAM,GAAK8hC,EAAal3L,EAAI+2L,EAAiBE,EAAoBC,EAAa14K,EAAYw4K,GAAkB,I,2SErOvI,MAAMvlJ,GAA0B,IA0BvC,SAAS4mJ,GAAiG/7H,EAAQ1zD,GAChH,MAAM0vL,EAAah8H,EAAI1zD,GACpB0vL,GACDA,EAAW/0K,SAIb,MAAMqV,EAAW0jC,EAAI1zD,IAAO,UAC5BgwB,EAAShyB,OAAM,SAAUqd,SAAQ,KAC5Bq4C,EAAI1zD,KAASgwB,UACP0jC,EAAI1zD,MAIf,MAAM6e,EAAau6E,IAAkB,IAAM1lC,EAAI1zD,KAASgwB,IACxD,MAAO,CAACA,SAAAA,EAAUnR,WAAAA,GAGpB,MAAM8wK,WAAyBtkI,GAC7Bt7D,YACS+S,EACA9H,EACA40L,EACAljI,GAEP18D,MAAM,CACJq8D,SAAW9xD,GAAYuI,EAASs2E,eAAeh1C,eAAe7pC,EAAQoG,GAAIxQ,KAAKy/L,UAC/ExjI,SAAW7xD,IACTA,EAAQ+Q,IAAI49B,OAAOz4C,SACnBN,KAAKu8D,oBAAsBv8D,KAAKu8D,sBAElCf,OAAQ,CAACpxD,EAASiU,KAChB,MAAMm+C,EAAmBpyD,EAAQ+Q,IAAI49B,OAAOn1C,gBAAkB5D,KAAK6K,KACnEiwD,GAAuB1wD,EAAQ+Q,IAAI49B,OAAQ/4C,KAAK6K,KAAMwT,GAEnDm+C,GACDx8D,KAAKu8D,oBAAsBv8D,KAAKu8D,sBAGpCR,gBAAiB,CAACD,EAAMF,KACtB,MAAMhtC,EAA+BgtC,EAAQ,QAAK5xD,GAE5C,IAACmR,GAAOukL,GAAkBC,cAAc,CAACpzL,OAAQuvD,EAAKtrD,GAAIoe,aAAAA,EAAcgxK,QAAShkI,IAUvF,OATCE,EAAsB3gD,IAAMA,GAE1ByT,MAAAA,OAAY,EAAZA,EAAcjuB,UACdm7D,EAAsBltC,aAAeA,EACtCzrB,QAAQC,IAAIwrB,GAAc1D,SAAQ,YACxB4wC,EAAsBltC,iBAI3BktC,GAETX,kBAAmB,QAlCd,KAAAxoD,SAAAA,EACA,KAAA9H,KAAAA,EACA,KAAA40L,SAAAA,EACA,KAAAljI,mBAAAA,EAmCFxxD,QACL/K,KAAK6K,KAAKvG,UAAY,GACtBzE,MAAMkL,SAOH,MAAM80L,GAwDXjgM,cAvDQ,KAAAqxC,eAAiBnyC,SAASstD,eAAe,sBAKzC,KAAA1W,OAAqB,KAErB,KAAA5hB,KAAM,EAAA+zC,GAAA,IAAO,UAAW,MAAAm1F,IAAe,YAAiB,WAAgB,aAKzE,KAAA8iC,aAAyD,GACzD,KAAAC,YAAsD,GACtD,KAAAC,YAAgD,GAE/C,KAAAC,QAA8E,CACpFpiI,KAAM/+D,SAASstD,eAAe,gBAC9B8zI,oBAAqB,KACrBh/L,UAAWpC,SAASstD,eAAe,sBAE7B,KAAA4/B,gBAOJ,GAKI,KAAAm0G,mBAAuC,IAAIvhL,IAE3C,KAAAwhL,QAAyC,CAACv5L,IAAK,EAAGyvB,OAAQ,GAO1D,KAAA+pK,iBAAkB,EAGlB,KAAAC,0BAA2B,EAyf5B,KAAAC,YAAc,KACnBvgM,KAAK01C,OAAS11C,KAAKggM,YAAYhgM,KAAKusF,UACpCvsF,KAAK01C,OAAO83D,UAAU3mG,KAAM,EAC5B7G,KAAK01C,OAAO83D,UAAUl3E,QAAS,EAC/Bt2B,KAAKogM,QAAQv5L,IAAM7G,KAAKogM,QAAQ9pK,OAAS,EACzCt2B,KAAKwgM,8BAA2Bx2L,EAChChK,KAAKygM,wBAAqBz2L,EAC1BhK,KAAKi0F,WAAaj0F,KAAK+/L,YAAY//L,KAAKusF,UACjCvsF,KAAK0gM,iBAkfN,KAAAC,oBAAsB,KAC5B,IAAI3gM,KAAKsgM,yBACP,OAKF,GAFAtgM,KAAK4gM,2BAEF5gM,KAAKusF,SAAW,EAAG,OAEtB,MAAM4G,EAAWnzF,KAAKmzF,SAChBpmF,EAAQomF,EAASloF,kBAEjB8yB,EAAQo1D,EAASvvF,cAAcA,cAC/B0yB,EAAS68D,EAASvvF,cAAcsqC,mBAChC2yJ,IAAgBvqK,EAAOrrB,kBAC7B,GAAG8B,GAAS,GAKV,YAJG8zL,GACD7gM,KAAK8gM,6BAIF,GAAGD,EAAa,OAEvB9iK,EAAM3+B,UAAUC,IAAI,iBAEpB,MAAM8Z,EAAU,IAAIC,GAAe,CACjC3V,KAAM,WACN2rC,aAAa,EACb6lD,uBAAuB,IAGzB97E,EAAQjY,UAAU9B,UAAUC,IAAI,QAEhCW,KAAK2S,SAAS2I,gBAAgBq5B,wBAAmB3qC,OAAWA,EAAW,UAAUtI,MAAM2yC,IACrF,IAAI2qF,GAAQ,EACZ,MAAMziE,EAAqB,KACtByiE,GACD7lH,EAAQjY,UAAU9B,UAAUoE,OAAO,QAASqvF,EAAehoF,KAAKI,mBAGlEjL,KAAK+gM,sBAAqB,IAGtBluG,EAAiB,IAAIx2B,GAAe,CACxC9uD,WAAY,GACZkvD,sBAAuB,CACrBizD,WAAY,GACZ10G,KAAK,GAEPrQ,YAAY,EACZ4xD,mBAAAA,EACA5pD,SAAU3S,KAAK2S,WAGjB3S,KAAKghM,aAAe,KAClB,MAAMltJ,EAAY,UAAoB,GAAK,EAC/BO,EAAS91B,OAAO,EAAGu1B,GAAWnoB,OAAO3rB,KAAKihM,yBAElD7zL,SAASb,IACXsmF,EAAexzF,IAAIkN,MAGjB8nC,EAAS1zC,SACXX,KAAKghM,kBAAeh3L,IAIxBhK,KAAKghM,eAELhhM,KAAKkhM,eAAkB30L,IACrB,GAAGA,EAAOkpC,YACR,OAGF,MAAMknB,EAAO38D,KAAKihM,wBAAwB10L,GACpC40L,EAAQtuG,EAAe1gD,IAAI5lC,IAC7B40L,GAASxkI,EAAMk2B,EAAexzF,IAAIkN,GAC9B40L,IAAUxkI,GAAMk2B,EAAenjF,OAAOnD,IAGhD,MAAM1B,EAAOgoF,EAAehoF,KAC5BA,EAAKzL,UAAUC,IAAI,gBACnBW,KAAKohM,qBAAqBv2L,GAC1BsO,EAAQpK,QAAQrP,OAAOmL,GAEvBm0H,GAAQ,EACRziE,OAGFjmC,EAAO52B,OAAOyZ,EAAQjY,YAGhB,KAAA+/L,wBAAgC10L,GAAmB,mCACzD,aAAavM,KAAK2S,SAAS2/B,gBAAgBqL,UAAUpxC,aAAmBvM,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,OAGlH,KAAA80L,qBAAuB,KAGzBrhM,KAAKshM,cAAcnzL,aAAanO,KAAKshM,cACxCthM,KAAKshM,aAAex7L,OAAOM,YAAW,KACpCpG,KAAKshM,kBAAet3L,EAEhBhK,KAAKmzF,SAASloF,oBAAqBjL,KAAKkhM,iBAY5C,UAAoB,KAEpB,MAAMxhF,EAAO/0F,YAAYhlB,MAEnB47L,EAAevhM,KAAK01C,OAAO+O,UAE3B17B,EAAoB/oB,KAAKmzF,SAASpqE,kBAClCy4K,EAAgBxhM,KAAK01C,OAAOx0C,UAAUuF,wBACtCg7L,EAAa14K,EAAkBtiB,wBAC/Bqf,EAAW1U,MAAMC,KAAKrR,KAAK01C,OAAOzD,QAAQnsB,UAIhD,IAAIujD,EAAYrpE,KAAK01C,OAAOzD,QAAQo3B,UACjCA,GAAak4H,EAAel4H,IAAWA,GAAak4H,GAEvD,MAAMG,EAASF,EAAcv6L,EAAIoiE,EAC3Bu0E,EAAQ4jD,EAAcv6L,EAEtB06L,GAAe,EAAAlpJ,GAAA,GAAU35C,SAASonG,iBAAiBvjG,KAAKoR,KAAK0tL,EAAWz6L,GAAIrE,KAAKoR,KAAK2tL,EAAS,IAAK34K,EAAkB1hB,SACtHu6L,GAAc,EAAAnpJ,GAAA,GAAU35C,SAASonG,iBAAiBvjG,KAAKoR,KAAK0tL,EAAWz6L,GAAIrE,KAAK6uB,MAAMosH,EAAQ4jD,EAAchgM,OAAS,IAAKunB,EAAkB1hB,SAIlJ,IAAIs6L,IAAiBC,EACnB,OAKF,MACMC,EADmBF,EAAal7L,wBACGQ,EAAIy6L,EAEvCh3H,EAAwB,GACxB7J,EAAa/6C,EAAStP,QAAQmrL,GAC9B7gI,EAAYh7C,EAAStP,QAAQorL,GAI7BE,EAAiB,GAAAn1K,UAAY,GAAK7G,EAASplB,MAAM,EAAGiC,KAAKH,IAAI,EAAGq+D,EAFnD,KAGbkhI,EAAej8K,EAASplB,MAAMogE,EAHjB,IAiBhBghI,EAAenhM,SAChBX,KAAK01C,OAAO83D,UAAU3mG,KAAM,GAG3Bk7L,EAAaphM,SACdX,KAAK01C,OAAO83D,UAAUl3E,QAAS,GAGjCo0C,EAAO74D,QAAQiwL,GACfp3H,EAAO74D,QAAQkwL,GAEfr3H,EAAOt9D,SAASmE,IACd,MAAMhF,EAASgF,EAAG3J,QAAQ2E,OAAOsO,WACjC7a,KAAKgiM,aAAaz1L,MAGpBvM,KAAKiiM,aAQLjiM,KAAK01C,OAAO+O,UAAYk9I,EAAat4H,UAAYw4H,EAEjD7hM,KAAK8zB,IAAI,aAAcnJ,YAAYhlB,MAAQ+5G,QAM1C,MAiBE,KAAAwiF,iBAAmB,IACjBliM,KAAK0gM,cAAc,OAGrB,KAAAA,cAAgB,CAACp8J,EAAmB,YACtCtkC,KAAK01C,OAAO83D,UAAUlpE,IACpBtkC,KAAKghM,cACNhhM,KAAKghM,eAIThhM,KAAK8zB,IAAI,gBAAiBwQ,GACnBtkC,KAAKmiM,YAAY79J,IA9sCxB,MAAM3xB,EAAW3S,KAAK2S,UAAW,EAAAyvL,GAAA,KAEjCpiM,KAAK+4G,YAAc,IAAIygF,GAAmB7mL,GAE1C3S,KAAKigM,QAAQC,oBAAsBlgM,KAAKigM,QAAQpiI,KAAKj6D,cAErD5D,KAAKu8D,oBAAqB,EAAAnwB,GAAA,GAASpsC,KAAK2gM,oBAAqB,KAAK,GAAO,GAEzE,MAAM0B,EAAavjM,SAASC,cAAc,OAC1CsjM,EAAWjjM,UAAUC,IAAI,4BACzBgjM,EAAW3iM,OAAOM,KAAKigM,QAAQ/+L,WAwB5B,MACDq8D,GAAe,CACbnzD,QAASpK,KAAKigM,QAAQ/+L,UACtBqiD,QAAUL,IACR,MAAMwlB,EAASn5D,EAAUm5D,SACzBn5D,EAAU2zC,EAAQ,EAAIwlB,EAAS,EAAIA,EAAS,MAKlD1oE,KAAKsiM,oBAAsB,IAAI,iBAAiB,CAC9CzyL,IAAK,wBAmBP,qBAA2B,iBAAiB,KAE1C,gBAA2BnO,MAAW0pC,GAAU,mCAC9CprC,KAAKsgM,0BAA2B,EAUhCtgM,KAAKi0F,WAAWlpF,QAChB/K,KAAKugM,cACLvgM,KAAKuiM,cAAcn3J,WAIvBprC,KAAKwiM,YAAY,EAAG,GACpBxiM,KAAKyiM,UAAU,CACbjyL,GAAIxQ,KAAKusF,SACTz9E,MAAO,GACP29E,WAAY,IAGd,MAAMi2G,EAAoB,IAAI,KAAY1iM,KAAKigM,QAAQC,qBACvDmC,EAAWx+L,QAAQ7D,KAAKigM,QAAQC,qBAChC,MAAM3wL,GAAY,EAAAw5D,GAAA,GAAe/oE,KAAKigM,QAAQpiI,KAAM79D,KAAKigM,QAAQ/+L,WAAW,CAACsP,EAAIw4D,KA0B/E,GArBAx4D,GAAMw4D,EAAWphE,QAAQ2kF,UAAY,EAEjC,GAAA1qC,mBACCrxC,EACGxQ,KAAK2iM,wBACP3iM,KAAK2iM,sBAAwB,CAC3B1iM,KAAM,UACN0R,MAAO,KACLpC,EAAU,GACVvP,KAAK2iM,2BAAwB34L,IAIjCsG,EAAA,cAAoC,EAAG,EAAGtQ,KAAK2iM,wBAEzC3iM,KAAK2iM,wBACbryL,EAAA,aAAmCtQ,KAAK2iM,uBACxC3iM,KAAK2iM,2BAAwB34L,IAI9BhK,KAAKusF,WAAa/7E,EAGrB,OADAxQ,KAAK+/L,YAAYvvL,GAAIzF,QACd/K,KAAK4iM,wBAAwBpyL,GAAI9O,MAAK,EAAEuqB,OAAAA,EAAQqE,cAAAA,MACrD,GAAGrE,EACD,OAAOqE,QAGV,KACD,IAAI,MAAM6gB,KAAYnxC,KAAK+/L,YACzB,IAAI5uJ,IAAanxC,KAAKusF,SAAU,CAC9BvsF,KAAK+/L,YAAY5uJ,GAAUpmC,QAC3B,MAAMgD,EAAc/N,KAAK8/L,aAAa3uJ,GACnCpjC,GACDA,EAAYzN,iBAIjB0J,EAAW04L,GAEd,gBAA2BhhM,MAAM0pC,IAE/B5T,GAAA,oBAA6C4T,EAAMqsG,gBACnDjgH,GAAA,mBAA4C,kBAAmB2hG,IAC7Dn5H,KAAK2S,SAASutE,gBAAgBC,YAAY,iBAAkBg5C,MAGvDn5H,KAAKuiM,cAAcn3J,MAkB5B/b,EAAA,mBAA4B,UAAU,KACpCrvB,KAAK6iM,8BAGP,IAAIzI,GAA0Bp6L,KAAK2S,SAAU3S,KAAKixC,gBAClDjxC,KAAKixC,eAAevxC,OAAO2iM,GAE3Bj8L,YAAW,KACTy/B,GAAA,wBACC,KAEH,aAAwB,aAAqBlzB,EAC7Ckd,EAAA,YAA6Bld,GAC7B,aAAyBA,GACzB,aAA0BA,GAC1B,aAA+BA,GAC/B,aAA0BA,GAC1B,aAAuBA,GAIvB3S,KAAKi0F,WAAaj0F,KAAK+/L,YAAY//L,KAAKusF,UACxCvsF,KAAK01C,OAAS11C,KAAKggM,YAAYhgM,KAAKusF,UAGnCvsF,KAAKigM,QAAQpiI,KAAK90C,kBAAkC+pB,QAG5CqgD,eACT,OAAOnzF,KAAKi0F,WAAWppF,KAGlB23L,YAAYj2G,EAAkBE,GACnCzsF,KAAKy/L,UAAW,EAAAqD,GAAA,GAAkBr2G,GAClCzsF,KAAKusF,SAAWA,EAGLq2G,wBAAwBr2G,G,0CAGnC,OAFAvsF,KAAKy/L,eAAiBz/L,KAAK2S,SAASs2E,eAAe85G,4BAA4Bx2G,GAC/EvsF,KAAKusF,SAAWA,EACTvsF,KAAKugM,iBAGNyC,gBAAgB54L,EAAsB0wL,GAC5C,MAAMn8L,EAAY,YACZskM,EAAe74L,EAAQhL,UAAUiG,SAAS1G,IAC/CskM,GAAgBnI,GAAU1wL,EAAQhL,UAAUC,IAAIV,IACjD,QAAcyL,EAAS,aAAc0wL,EAAQ,IAAKA,OAAS9wL,EAAY,KACrEI,EAAQhL,UAAUkB,OAAO3B,IACxBm8L,IAAWmI,EAAe,EAAI,GAG3BC,gBACN,qBAA2B,eAAqBhoL,GAAW,mC,MAGzD,MAAM3O,EAAS2O,EAAOL,WAChBM,EAAMnb,KAAKmjM,aAAa52L,GAC9B,GAAG4O,GAAO5O,IAAW,kBAA0BvM,KAAK2S,SAAS2I,gBAAgBulG,MAAM3lG,IAAU,CAC3F,MACM4/K,EAA4B,sBAAR,QAAX,SADI96L,KAAK2S,SAAS2I,gBAAgBC,QAAQL,IACrCvC,cAAM,eAAE/L,GAC5B5M,KAAKgjM,gBAAgB7nL,EAAIkyB,SAAUytJ,SAIvC,qBAA2B,eAAqBzgL,GAAW,mCACzD,MAAM9N,EAAS8N,EAAOQ,UAAS,GACzB2d,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,GACjEisB,GACDx4B,KAAKojM,2BAA2B5qK,QAIpC,qBAA2B,iBAAkB4zD,IAC3CpsF,KAAKqjM,qBAAqBj3G,EAAO57E,OAGnC,qBAA2B,mBAAoB0K,IAC7Clb,KAAKkhM,gBAAkBlhM,KAAKkhM,eAAehmL,EAAOL,eAGpD,qBAA2B,gBAAgB,EAAE2d,OAAAA,MACvCA,IAIJx4B,KAAKsjM,gBAAgB,CACnB9qK,OAAAA,EACA+qK,WAAW,IAEbvjM,KAAKwjM,wBAAwBhrK,GAC7Bx4B,KAAKyjM,4BAGP,qBAA2B,uBAAwB7vJ,IACjD,IAAI,MAAMrnC,KAAUqnC,EAAS,CAC3B,MAAMpb,EAASob,EAAQrnC,GACvBvM,KAAK0jM,aAAalrK,GAEfx4B,KAAKkhM,gBACNlhM,KAAKkhM,eAAe30L,EAAOsO,YAG7B7a,KAAKwjM,wBAAwBhrK,OAIjC,qBAA2B,eAAe,EAAEjsB,OAAAA,MAC1CvM,KAAKgiM,aAAaz1L,GAEfvM,KAAKkhM,gBACNlhM,KAAKkhM,eAAe30L,MAIxB,qBAA2B,iBAAiB,EAAEisB,OAAAA,MACxCA,IAIJx4B,KAAK2jM,mBAAmB,CAACnrK,OAAAA,IACzBx4B,KAAKwjM,wBAAwBhrK,OAG/B,qBAA2B,0BAA2BA,IACpDx4B,KAAKwjM,wBAAwBhrK,GAC7Bx4B,KAAK2jM,mBAAmB,CAACnrK,OAAAA,OAG3B,qBAA2B,gBAAgB,EAAEA,OAAAA,EAAQ80J,KAAAA,EAAM/gL,OAAAA,MACtD+gL,EACDttL,KAAKi0F,WAAWvkF,OAAOnD,GAEvBvM,KAAK0jM,aAAalrK,GAGjBx4B,KAAKkhM,gBACNlhM,KAAKkhM,eAAe30L,MAIxB,oBAA8B,gBAAiBA,IAE7C,IAAI,MAAMnC,KAAWpK,KAAKmgM,mBACrB/1L,EAAQxC,QAAQ2E,OAAOsO,aAAetO,GACvCvM,KAAK4jM,gBAAgBx5L,GAAS,GAIjBgH,MAAMC,KAAKvS,SAASwS,iBAAiB,sDAAsD/E,QACnGa,SAAShD,IAChBpK,KAAK4jM,gBAAgBx5L,GAAS,SAKlC,qBAA2B,iBAAuBuhB,GAAW,mCAC3D,IAAI3rB,KAAKgsF,gBAAgBrgE,EAAOnb,IAE9B,YADAxQ,KAAKyiM,UAAU92K,GAEV,GAAGA,EAAOnb,KAAOxQ,KAAKusF,SAAU,CACrC,MAAM34C,QAAgB5zC,KAAK2S,SAASs2E,eAAe46G,kBAAiB,SAC9D7jM,KAAK8jM,wBACX,IAAI,IAAI/3L,EAAI,EAAGpL,EAASizC,EAAQjzC,OAAQoL,EAAIpL,IAAUoL,EAAG,CACvD,MAAMysB,EAASob,EAAQ7nC,GACvB/L,KAAK0jM,aAAalrK,IAItB,MAAMyB,EAAWj6B,KAAKgsF,gBAAgBrgE,EAAOnb,KAC7C,EAAAmoB,EAAA,GAAasB,EAASnrB,OAAO,EAAA8pB,GAAA,GAAcjN,EAAO7c,aAGpD,qBAA2B,iBAAkB6c,IAC3C,MAAMsO,EAAWj6B,KAAKgsF,gBAAgBrgE,EAAOnb,IACzCypB,IAIHj6B,KAAKigM,QAAQpiI,KAAK90C,kBAAkC+pB,QAErD7Y,EAAS/4B,UAAUZ,SACnB25B,EAAS4jC,KAAKv9D,gBAEPN,KAAK+/L,YAAYp0K,EAAOnb,WACxBxQ,KAAKggM,YAAYr0K,EAAOnb,WACxBxQ,KAAKgsF,gBAAgBrgE,EAAOnb,IAEnCxQ,KAAK+jM,4BAGP,qBAA2B,gBAAsB92G,GAAU,mCACzD,MAAM+2G,EAAoBhkM,KAAKigM,QAAQpiI,KACjCz4D,QAAUjC,QAAQC,IAAI6pF,EAAMtyE,KAAU4xE,GAAa,mCACvD,MAAO,CACLkzG,eAAgBz/L,KAAK2S,SAASs2E,eAAe85G,4BAA4Bx2G,GACzE5gE,aAAc3rB,KAAK2S,SAASo2E,eAAeyD,UAAUD,UAIzDU,EAAM7/E,SAAQ,CAACm/E,EAAUluE,KACvB,MAAM,SAACohL,EAAQ,OAAE9zK,GAAUvmB,EAAEiZ,GACvB4lL,EAAiBjkM,KAAKgsF,gBAAgBO,GAEzBvsF,KAAK+/L,YAAYxzG,GACzBkzG,SAAWA,EAEtB3kI,GAAuBmpI,EAAepmI,KAAMmmI,EAAmBr4K,EAAO8gE,YACtE3xB,GAAuBmpI,EAAe/iM,UAAWlB,KAAKigM,QAAQ/+L,UAAWyqB,EAAO8gE,eAGlFzsF,KAAKy/L,eAAiBz/L,KAAK2S,SAASs2E,eAAe85G,4BAA4B/iM,KAAKusF,eAQtF,qBAA2B,gBAAgB,EAAOhgF,OAAAA,EAAQy8K,QAAAA,KAAa,mCACrE,MAAMxwJ,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAc/qD,GAChEisB,IAEDwwJ,EAAQroL,OACTX,KAAKwnC,UAAUhP,GAEfx4B,KAAKkkM,YAAY1rK,SAKforK,gBAAgB7qJ,EAAqBiU,GAE3C,MAAM7xC,EAAM49B,EAAOorJ,UACnBprJ,EAAO35C,UAAUoE,OAAO,SAAUwpD,GAC/BA,EACDhtD,KAAKmgM,mBAAmB9gM,IAAI05C,GAE5B/4C,KAAKmgM,mBAAmBzwL,OAAOqpC,IAG9B59B,MAAAA,OAAG,EAAHA,EAAKipL,WACNjpL,EAAIipL,SAASp5L,UAAUgiD,GAIbu1I,cAAcn3J,G,0CAC1B,MAAMq1J,EAAqBzgM,KAAK0gM,gBAE5B1gM,KAAKqgM,kBACPrgM,KAAKkjM,gBACLljM,KAAKqgM,iBAAkB,GAGzB,MAAMgE,KAAiBj5J,EAAMiiC,UAAW8e,OAAOzuE,KAAK0tB,EAAMiiC,SAAS1sE,QAE7D2jM,GAD2BD,EAAclhM,QAAQ4B,QAAQonF,OAAOl2C,OAAO7K,EAAMiiC,SAAS/xB,MAAK,CAAC1U,EAAGmkB,IAAMnkB,EAAE6lD,WAAa1hC,EAAE0hC,cAAezsF,KAAK2S,SAASo2E,eAAeC,oBAClHtnF,MAAM2rE,IAC1D,IAAI,MAAM1hD,KAAU0hD,EAClBrtE,KAAKyiM,UAAU92K,MAIhB04K,UACKC,EACHtkM,KAAKukM,2BACAvkM,KAAKukM,qBAIfvkM,KAAK2S,SAASyrC,wBAAwBomJ,wCAEzB/D,GAAoBnwK,cACjCtwB,KAAK2S,SAAS40B,mBAAmBk9J,uBAe3BC,eAAepgK,GACrB,MAAO,CAAChf,MAAOtlB,KAAK01C,OAAO83D,UAAUlpE,GAAQ,EAAItkC,KAAKogM,QAAQ97J,IAGxDqgK,yBAAyBnsK,GAC/B,QAAyBxuB,IAAtBwuB,EAAOosK,aAA6B5kM,KAAK6kM,oBAAoBrsK,GAAS,OAAO,EAEhF,MAAMssK,EAAY9kM,KAAK0kM,eAAe,OAChCK,EAAe/kM,KAAK0kM,eAAe,UAEzC,IAAII,EAAUx/K,QAAUy/K,EAAaz/K,MACnC,OAAO,EAGT,MAAMA,GAAQ,EAAA2uB,GAAA,GAAezb,EAAQx4B,KAAKy/L,UAC1C,QAASqF,EAAUx/K,OAASA,GAASw/K,EAAUx/K,UAAYy/K,EAAaz/K,OAASA,GAASy/K,EAAaz/K,OAGjG08K,aAAaz1L,GACnBvM,KAAKi0F,WAAWvkF,OAAOnD,GAGjBm3L,aAAalrK,GACnB,IAAGx4B,KAAK2kM,yBAAyBnsK,GAO/B,YADAx4B,KAAKgiM,aAAaxpK,EAAOjsB,QALzB,IAAIvM,KAAKi0F,WAAW9hD,IAAI3Z,EAAOjsB,QAE7B,YADAvM,KAAKi0F,WAAW50F,IAAIm5B,EAAOjsB,QAQ/B,MAAM4O,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,QAClC4O,IACDnb,KAAKsjM,gBAAgB,CACnB9qK,OAAAA,EACArd,IAAAA,EACAooL,WAAW,IAEbvjM,KAAKi0F,WAAW57D,OAAOG,EAAOjsB,SAepB82L,qBAAqB92G,G,gDACjC,GAAgB,IAAbA,EACD,OAGF,MAAMy4G,EAA2C,QAA9B,EAAAhlM,KAAKgsF,gBAAgBO,UAAS,eAAEm4B,OACnD,IAAIsgF,EACF,OAGF,MAAM,mBAACC,EAAkB,YAAEC,SAAqBllM,KAAK2S,SAASs2E,eAAek8G,qBAAqB54G,GAClGy4G,EAAW5lM,UAAUoE,OAAO,cAAeyhM,GAC3CD,EAAW/lK,UAAYimK,EAAc,GAAKA,EAAc,MAGlDzB,wBACN,IAAI,MAAMl3G,KAAYvsF,KAAKgsF,gBACzBhsF,KAAKqjM,sBAAsB92G,GAOjBu3G,wB,0CACZ9jM,KAAKi0F,WAAWt4B,SAASvuD,SAAchD,GAAY,mCACjD,MAAMouB,QAAex4B,KAAK2S,SAAS40B,mBAAmB+vB,cAAcltD,EAAQoG,IACxExQ,KAAK6kM,oBAAoBrsK,IAC3Bx4B,KAAKgiM,aAAa53L,EAAQoG,YAQxBgzL,wBAAwBhrK,GAC1Bx4B,KAAKmjM,aAAa3qK,EAAOjsB,UAIzBvM,KAAK6kM,oBAAoBrsK,IAC3Bx4B,KAAKgiM,aAAaxpK,EAAOjsB,SAItBs4L,oBAAoBrsK,GACzB,SACGA,IACAx4B,KAAKusF,SAAW,OAA8CviF,KAA1C,EAAAiqC,GAAA,GAAezb,EAAQx4B,KAAKy/L,UAA0Bz/L,KAAKusF,WAAa/zD,EAAOohK,YASjGwL,mBAAmBv6L,EAAwB8gB,GAChD,MAAM4gE,EAAW5gE,EAAOnb,GAClB1E,EAAa,IAAI,KAAW,KAAM,KAAM,KAC9CA,EAAW5K,UAAUd,iBAAiB,SAAUJ,KAAKqhM,sBACrDv1L,EAAW5K,UAAU0G,QAAQ2kF,SAAW,GAAKA,EAC7CzgF,EAAW+wG,cAAgB78G,KAAKkiM,iBAChCp2L,EAAWO,iBAAmBrM,KAAK0gM,cACnC50L,EAAWG,oBAAoBpB,GAE/B,MAAMw6L,EAAmB,IAAI7F,GAC3Bx/L,KAAK2S,SACL9H,GACA,EAAAi4L,GAAA,GAAkBn3K,EAAO8gE,YACzBzsF,KAAKu8D,oBASP,OANAv8D,KAAKggM,YAAYzzG,GAAYzgF,EAC7B9L,KAAK+/L,YAAYxzG,GAAY84G,EAKtBv5L,EAGD22L,UAAU92K,GAChB,GAAiB,IAAdA,EAAOnb,GACR,OAGF,MAAMwzL,EAAoBhkM,KAAKigM,QAAQpiI,KACjComI,EAAiBjkM,KAAKgsF,gBAAgBrgE,EAAOnb,IACnD,GAAGyzL,EAGD,OAFAnpI,GAAuBmpI,EAAepmI,KAAMmmI,EAAmBr4K,EAAO8gE,iBACtE3xB,GAAuBmpI,EAAe/iM,UAAWlB,KAAKigM,QAAQ/+L,UAAWyqB,EAAO8gE,YAIlF,MAAMjkB,EAAU1pE,SAASC,cAAc,OACvCypE,EAAQppE,UAAUC,IAAI,4BACtB,MAAMkK,EAAOzK,SAASC,cAAc,QAC9B+sE,EAAYhtE,SAASC,cAAc,QACzC+sE,EAAU1sE,UAAUC,IAAI,cACP,IAAdssB,EAAOnb,GAAUs7D,EAAUpsE,OAAOM,KAAKsiM,oBAAoBl4L,UACzD,EAAAuuB,EAAA,GAAamzC,GAAW,EAAAlzC,GAAA,GAAcjN,EAAO7c,QAClD,MAAMk2L,EAAalmM,SAASC,cAAc,OAC1CimM,EAAW5lM,UAAUC,IAAI,QAAS,WAAY,iBAC9C,MAAM0M,EAAIjN,SAASC,cAAc,KACjCwK,EAAK7J,OAAOosE,EAAWk5H,EAAYj5L,IACnC,EAAAlH,GAAA,GAAO2jE,GACPA,EAAQ9oE,OAAO6J,GAEfuxD,GAAuB0N,EAASw7H,EAAmBr4K,EAAO8gE,YAG1D,MAAMhB,EAAKzrF,KAAKslM,iBACVx5L,EAAa9L,KAAKolM,mBAAmB35G,EAAI9/D,GAE/C7f,EAAW5K,UAAU9B,UAAUC,IAAI,WAAY,kBAK/C,MAAMwH,EAAM/H,SAASC,cAAc,OACnC8H,EAAIzH,UAAUC,IAAI,gBAElB,MAAMi3B,EAASx3B,SAASC,cAAc,OACtCu3B,EAAOl3B,UAAUC,IAAI,mBAErBwH,EAAInH,OAAO+rF,GACX3/E,EAAW5K,UAAUxB,OAAOmH,EAAKyvB,GAIjC,MAAMjyB,EAAMyH,EAAW5K,UAEvB45D,GAAuBhvD,EAAW5K,UAAWlB,KAAKigM,QAAQ/+L,UAAWyqB,EAAO8gE,YAE5EzsF,KAAKohM,qBAAqB31G,EAAI,MAAM,GAEpCzrF,KAAKgsF,gBAAgBrgE,EAAOnb,IAAM,CAChCqtD,KAAM2K,EACNtnE,UAAWmD,EACXqgH,OAAQsgF,EACRl2L,MAAOg9D,GAGT9rE,KAAK+jM,wBAGClB,2BACN,MAAM/2L,EAAa9L,KAAKigM,QAAQC,oBAAoBn3K,kBAC9ClZ,EAAmB/D,EAAW+gD,YAAc/gD,EAAWy5L,YAAc,sBAAwB,iBACnGvlM,KAAKsiM,oBAAoBvyG,iBAAiB,CAAClgF,IAAAA,IAGrCk0L,wBAyBN,OAxBI/jM,KAAKukM,qBACPvkM,KAAKukM,mBAAqB,IAAIphM,SAAe4B,IAC3Ce,OAAOM,YAAW,KAChB,MACM8oC,EADSi9C,OAAOzuE,KAAK1d,KAAKgsF,iBAAiBrrF,OAC3B,EAChB6kM,GAAcxlM,KAAKigM,QAAQC,oBAAoB9gM,UAAUiG,SAAS,QAErE6pC,IAASs2J,IACVxlM,KAAKigM,QAAQC,oBAAoB9gM,UAAUoE,OAAO,QAAS0rC,GACxDA,IAASs2J,GACVxlM,KAAKyjM,wBAGPzjM,KAAKixC,eAAe7xC,UAAUoE,OAAO,cAAe0rC,IAGtDlvC,KAAK6iM,2BAEL7iM,KAAKukM,wBAAqBv6L,EAC1BjF,MACC,OAIA/E,KAAKukM,mBAGNpC,YAAY79J,GAKlB,GAAGtkC,KAAKygM,oBAAsBzgM,KAAKwgM,yBAA2C,OAAOxgM,KAAKygM,mBACrF,GAAGzgM,KAAK01C,OAAO83D,UAAUlpE,GAC5B,OAAOnhC,QAAQ4B,QAAQ,CACrBknB,QAAQ,EACRqE,cAAentB,QAAQ4B,YAI3B,MAAM0gM,GAAoB,UACpBn1K,EAAgB,IAAIntB,SAAc,CAAM4B,EAASylB,IAAW,mCAChE,MAAM,SAAC2oE,EAAQ,SAAE5G,EAAQ,SAAEkzG,GAAYz/L,KAKvC,IAAI+lD,EAAY,UAAoB,GAAK,KAAO,EAC5C3U,EAAc,EAElB,MAAO9rB,MAAOogL,GAAsB1lM,KAAK0kM,eAAepgK,GACxD,GAAGohK,EACD,GAAY,QAATphK,EAAgB,CACjB,MAAMqnF,QAAgB3rH,KAAK2S,SAASs2E,eAAeC,iBAAiBqD,GAAU,GACxEjnE,EAAQqmG,EAAQrtG,WAAWka,IAAW,EAAAyb,GAAA,GAAezb,EAAQinK,IAAaiG,IAC1EC,EAAYhjM,KAAKH,IAAI,EAAG8iB,EAAQygC,GACtCA,EAAYzgC,EAAQqgL,EACpBv0J,GAAc,EAAA6C,GAAA,GAAe03E,EAAQg6E,GAAYlG,GAAY,OAE7DruJ,EAAcs0J,EAMlB,IAAI33L,EAAc/N,KAAK8/L,aAAavzG,GACpC,IACE,MAAMq5G,EAAyB5lM,KAAK2S,SAASm2C,aAAavhB,mBAAmBwM,iBAAiB,GAAI3C,EAAa2U,EAAWwmC,GAAU,GACpI,KACG4G,EAASloF,mBACT8C,GAEE/N,KAAKsgM,iCACEsF,GAAwB35K,QAElC,CACAle,EAAc/N,KAAK8/L,aAAavzG,GAAY,IAAIkxG,GAChD,MAAMW,EAA2B,IAAb7xG,EAAiBvsF,KAAKixC,eAAiBjxC,KAAKigM,QAAQ/+L,UACxE6M,EAAYyb,OAAO,CACjBtoB,UAAWiyF,EAASvvF,cACpBw6L,YAAAA,EACAC,SAAU,YACDr+L,KAAK8/L,aAAavzG,IAE3B+xG,gBAAiBt+L,KAAK01C,SAGxB+vJ,EAAkB1gM,SAAQ,GAG5B,MAAM6hC,QAAUg/J,EACVt2L,QAAes3B,EAAEt3B,OACvB,GAAGtP,KAAKwgM,2BAA6BlwK,EAGnC,OAFA9F,SACAi7K,EAAkBj7K,SAsBpB,GAlBAi7K,EAAkB1gM,QAAQ6hC,EAAE3a,QAQhB,WAATqY,EACEh1B,EAAO8kC,QACRp0C,KAAK01C,OAAO83D,UAAUlpE,IAAQ,GAExBh1B,EAAOu2L,WACf7lM,KAAK01C,OAAO83D,UAAUlpE,IAAQ,GAGhCtkC,KAAKsgM,0BAA2B,EAE7BhxL,EAAOskC,QAAQjzC,OAAQ,CACxB,MAAMizC,EAAmB,QAATtP,EAAiBh1B,EAAOskC,QAAQlzC,QAAQy5B,UAAY7qB,EAAOskC,QAErEhlB,EAA+B,GAE/Bi6E,EAA4B,GAC5Bi9F,EAAQhhM,IACZ+jG,EAAUh3F,KAAK/M,IAkBjB,GAfA8uC,EAAQxmC,SAASorB,IAOf,MAAMpuB,EAAUpK,KAAKi0F,WAAW50F,IAAIm5B,EAAOjsB,QAAQ,EAA8Bu5L,GAAM,GACpF17L,EAAQwkB,cACTA,EAAa/c,QAAQzH,EAAQwkB,iBAIjCA,EAAa/c,MAAK,kBACZ1O,QAAQC,IAAIwrB,GAAc1D,UAC7BlrB,KAAKwgM,2BAA6BlwK,EAGnC,OAFA9F,SACAi7K,EAAkBj7K,SAIpBq+E,EAAUz7F,SAAStI,GAAaA,WAEhC9E,KAAKu8D,qBAGP,MAAMwpI,EAAez2L,EAAOskC,QAAiB,QAATtP,EAAiB,EAAIh1B,EAAOskC,QAAQjzC,OAAS,GAC9EolM,IACD/lM,KAAKogM,QAAQ97J,IAAQ,EAAA2P,GAAA,GAAe8xJ,EAActG,IAGpDz/L,KAAK8zB,IAAIwoH,MAAM,cAAgBv2F,EAAY,sBAAuB3U,EAAa9hC,EAAQ6jF,EAASloF,mBAEhG7E,YAAW,KACTpG,KAAK01C,OAAO5Q,aACX,GACH,MAAMr3B,GACNzN,KAAK8zB,IAAInmB,MAAMF,GAGdM,GAEDA,EAAYwb,OAAO4pE,EAASloF,mBAG9BlG,SACCmmB,SAAQ,KACNlrB,KAAKwgM,2BAA6BlwK,IACnCtwB,KAAKwgM,8BAA2Bx2L,EAChChK,KAAKygM,wBAAqBz2L,MAK9B,OADAhK,KAAKwgM,yBAA2BlwK,EACzBtwB,KAAKygM,mBAAqBgF,EAAkB/jM,MAAMuqB,IAAW,CAClEA,OAAAA,EACAqE,cAAAA,MAII01K,yBAAyBpnM,GAM/B,MAAMglD,EAAa,oBACb1iD,EAAYpC,SAASC,cAAc,OACzCmC,EAAU9B,UAAUC,IAAIukD,EAAYA,EAAa,IAAMhlD,EAAQqnM,eAE/D,MAAMr3L,EAAS9P,SAASC,cAAc,OACtC6P,EAAOxP,UAAUC,IAAIukD,EAAa,YAClC,QAAMh1C,EAAQhQ,EAAQkQ,OAEtB,MAAM26B,EAAW3qC,SAASC,cAAc,OAQxC,OAPA0qC,EAASrqC,UAAUC,IAAIukD,EAAa,aACjChlD,EAAQ6qC,WACT,QAAMA,EAAU7qC,EAAQ6qC,SAAU7qC,EAAQsnM,cAG5ChlM,EAAUxB,OAAOkP,EAAQ66B,GAElB,CAACvoC,UAAAA,EAAW0N,OAAAA,EAAQ66B,SAAAA,GAGrBm3J,2BACN,GAAqB,IAAlB5gM,KAAKusF,SACN,OAGF,MAAM4G,EAAWnzF,KAAKmzF,SAChBj7B,EAAOi7B,EAASvvF,cACtB,IAAIuiM,EAAwB/0L,MAAMC,KAAK6mD,EAAKpyC,UAA4B1T,MAAMb,GAAOA,EAAG8F,QAAQ,wBAChG,MAAM88H,EAAkBn0I,KAAK01C,OAAO83D,UAAUl3E,SAAW68D,EAASloF,kBAGlE,GAAGkpI,GAAmBgyD,EACpB,OACK,IAAIhyD,EAMT,YALGgyD,IACDjuI,EAAK94D,UAAUkB,OAAO,oBACtB6lM,EAAqB7lM,WAMzB,IAAIyN,EAAwE9N,EAC5E,GAAID,KAAKusF,SAyBF,CACLx+E,EAAc/N,KAAKgmM,yBAAyB,CAC1Cl3L,MAAO,yBACP26B,SAAU,6BACVw8J,cAAehmM,EAAO,WAGxBkmM,EAAuBp4L,EAAY7M,UAEnC,MAAMmD,EAAMvF,SAASC,cAAc,OAE7BiC,EAAO,IACb8vE,GAAiB,CACfzsE,IAAAA,EACAmhC,MAJY,KAKZjkC,MAAOP,EACPQ,OAAQR,IAGVmlM,EAAqBtiM,QAAQQ,GAE7B,MAAMxF,GAAS,OAAO,kDAAmD,CACvEY,KAAM,mBACNR,KAAM,cAGR,QAAiBJ,GAAQ,IAAW,mCAClC,aAAyBqrF,IAAkB/6E,WAAWnP,KAAK2S,SAASo2E,eAAeyD,UAAUxsF,KAAKusF,gBAGpG45G,EAAqBzmM,OAAOb,OAvDX,CACjBkP,EAAc/N,KAAKgmM,yBAAyB,CAC1Cl3L,MAAO,uCACPm3L,cAAehmM,EAAO,YAGxBkmM,EAAuBp4L,EAAY7M,UAEnC,MAAMoqB,EAAMxsB,SAASC,cAAc,OACnCusB,EAAIlsB,UAAUC,IAAI,kCAElBW,KAAKomM,gCAAkC,IAAI,iBAAiB,CAC1Dh8L,QAAS2D,EAAY07B,WAGvBtmC,QAAQC,IAAI,CACVpD,KAAK+gM,sBAAqB,GAC1B75K,GAA0BoE,EAAK,8BAC/B,aACC5pB,MAAK,EAAE2kM,MACRF,EAAqB/mM,UAAUC,IAAI,WACnC64D,EAAK94D,UAAUoE,OAAO,iBAAkB6iM,MAG1CF,EAAqBtiM,QAAQynB,GAkC/B4sC,EAAKx4D,OAAOymM,GACZjuI,EAAK94D,UAAUC,IAAI,oBACnB64D,EAAKtwD,QAAQ0+L,gBAAkBrmM,EAGzB8gM,qBAAqBwF,GAC3B,OAAGvmM,KAAKwmM,4BAAoCxmM,KAAKwmM,4BAC1CxmM,KAAKwmM,4BAA8BxmM,KAAK2S,SAAS2I,gBAAgB2sE,cAAcvmF,MAAM+0D,IAC1F,MAAMhtB,EAAWzpC,KAAKomM,gCACtB,GAAG38J,EAAU,CACX,IAAI55B,EAAkBT,EAEnBqnD,EAAM91D,QACPkP,EAAM,0CACNT,EAAO,EAAC,QAAK,iBAAkB,CAACqnD,EAAM91D,YAEtCkP,EAAM,oDACNT,EAAO,IAGTq6B,EAASsmD,iBAAiB,CACxBlgF,IAAAA,EACAT,KAAAA,IAYJ,OARGm3L,GACgBvmM,KAAKmzF,SACAvvF,cACjBxE,UAAUoE,OAAO,iBAAkBizD,EAAM91D,QAGhDX,KAAKwmM,iCAA8Bx8L,EAE5BysD,EAAM91D,UAITmgM,4BACN,MAAM3tG,EAAWnzF,KAAKmzF,SAChBp1D,EAAQo1D,EAASvvF,cAAcA,cAC/B0yB,EAAS68D,EAASvvF,cAAcsqC,mBACtCnQ,EAAM3+B,UAAUkB,OAAO,iBACvBg2B,EAAOhyB,UAAY,GACnBtE,KAAKghM,kBAAeh3L,EACpBhK,KAAKkhM,oBAAiBl3L,EA+MVi4L,a,0CACZ,MAAM9uG,EAAWnzF,KAAKmzF,SAChBszG,QAAoBzmM,KAAK0mM,qBAAqBvzG,EAASpqE,mBACvD49K,QAAmB3mM,KAAK0mM,qBAAqBvzG,EAAS1uF,kBAEtDg7L,EAAWz/L,KAAKy/L,SACtBz/L,KAAKogM,QAAQv5L,KAAM,EAAAotC,GAAA,GAAewyJ,EAAahH,GAC/Cz/L,KAAKogM,QAAQ9pK,QAAS,EAAA2d,GAAA,GAAe0yJ,EAAYlH,MAG3CiH,qBAAqBt8L,GAC3B,OAAOpK,KAAK2S,SAAS40B,mBAAmB+vB,cAAcltD,EAAQxC,QAAQ2E,OAAOsO,YAkBxEumL,qBAAqBv2L,EAAwBD,EAAsBg8L,GAAc,EAAOj8L,GAAa,EAAOk8L,GAAY,GAC7H,IAAIC,EAEJ,MAAMC,GAAeF,EAAY,gBAA4B,YAAsB39L,KAAK,IAExF2B,EAAKjD,QAAQ+C,WAAa,KAAMA,EAChCE,EAAKzK,iBAAiB,aAAcC,IAClC,GAAgB,IAAbA,EAAExB,OAAc,OAEnBmB,KAAK8zB,IAAI,sBACT,MAAM3sB,EAAS9G,EAAE8G,OACXjD,GAAO,EAAAu0C,GAAA,GAAUtxC,EAAQuxC,IAE/B,IAAIx0C,EACF,OAGF,MAAMqI,EAASrI,EAAK0D,QAAQ2E,OAAOsO,WAEnC,GAAGxa,EAAEqxI,SAAWrxI,EAAEsxI,QAGhB,OAFA7rI,OAAOqJ,KAAMjL,EAA2BgyD,MAAS,IAAM3pD,EAAS,eAChE,EAAA0b,EAAA,GAAY5nB,GAId,GAAGsK,EAAY,CACb,MAAMq8L,EAAcF,IAA0B5iM,EAC3C4iM,IAA0BE,GAC3BF,EAAsB1nM,UAAUkB,OAAO,UAGtC4D,IACDA,EAAK9E,UAAUC,IAAI,UACnBynM,EAAwB5iM,EACxBlE,KAAKmgM,mBAAmB9gM,IAAI6E,IAIhC,GAAGA,EAAM,CACJ0G,GAASA,IAEZ,MAAM04D,GAAap/D,EAAK0D,QAAQqF,UAAOjD,EAEvC+8L,EAAY,CACVx6L,OAAAA,EAAQ+2D,UAAAA,SAGVyjI,MAED,CAACzzK,SAAS,IAGbzoB,EAAKzK,iBAAiB,SAAUC,IACd,IAAbA,EAAExB,SACH,EAAAopB,EAAA,GAAY5nB,KAEb,CAACizB,SAAS,IAEV,MACDzoB,EAAKzK,iBAAiB,YAAaC,IACjC,MAAMwyC,GAAK,EAAA4F,GAAA,GAAUp4C,EAAE8G,OAAQuxC,IAC/B,GAAG7F,EAAI,CACL,MAAMtmC,EAASsmC,EAAGjrC,QAAQ2E,OAAOsO,WACjC7a,KAAK8zB,IAAI,gBAAiB9zB,KAAK2S,SAAS40B,mBAAmB0/J,kBAAkB16L,QAKhFq6L,GACD5pI,GAA0BnyD,EAAM7K,KAAK+4G,YAAY0Y,eAI9C6zE,eAAe1mM,EAOlB,IACF,MAAMiM,EAAO/L,SAASC,cAAc,MAoBpC,OAnBA8L,EAAKzL,UAAUC,IAAI,YAGhBT,EAAQoc,KACTnQ,EAAKzL,UAAUC,IAAI,gBAGlBT,EAAQ8wH,YACT7kH,EAAKzL,UAAUC,IAAI,YAAcT,EAAQ8wH,YAWpC7kH,EAGFy4L,gBAAgB1kM,GASrB,OADgBoB,KAAKknM,eAAetoM,EAAQ45B,OAAQ55B,EAAQwrE,YAAaxrE,EAAQuc,IAAKvc,EAAQk5D,cAAel5D,EAAQghM,QAAShhM,EAAQ2kM,WACvH11L,MAAM8vB,GAAA,GAGTupK,eACZ1uK,EACA4xC,EACAjvD,EACA28C,EACA8nI,GAAU,EACV2D,GAAY,G,gDAEZ,IAAIpoL,KACFA,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,SAG7B,OAIJ,MAAOszB,SAAU/1B,EAAO,WAAE4kB,GAAc4wK,GAAqBnkL,EAAK,yBAElE,IAAIgsL,EACJ,IAAI/8H,IACqB,kBAAR,QAAZ,EAAA5xC,EAAO+0G,aAAK,eAAE3gI,KACfu6L,EAAe3uK,EAAO+0G,SAGxBnjE,EAAc5xC,EAAOqnF,aACFz1C,EAAYn9D,MAAQurB,EAAOyhK,aAAa,CACzD,MAAMnwL,EAAU9J,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBt+B,EAAOjsB,OAAQisB,EAAOyhK,aACxF7vH,QAAoB17C,EAAW5kB,GAQnC,GAJGy5L,GACDvjM,KAAK2jM,mBAAmB,CAACnrK,OAAAA,EAAQrd,IAAAA,EAAKykL,QAAAA,EAASz1H,sBAAuBrgE,KAGpEsgE,EAMF,OALAjvD,EAAIE,gBAAgBsX,YAAc,GAClCxX,EAAIisL,aAAaz0K,YAAc,UACxBxX,EAAI49B,OAAOnxC,QAAQqF,SAE1BnD,EAAQ/E,UAIV,MAAMwH,EAASisB,EAAOjsB,OAChBs8C,EAAeuhB,GAAehV,GAAoBgV,GAES,CAC/D,IAAIwvD,EACJ,MAAMytE,EAA8C,GACpD,GAAGj9H,IAAgB+8H,IAAiBt+I,EAAc,CAChD,MAAM76B,GAA8B,EAAAyM,GAAA,GAAoB2vC,GAClDk9H,EAAsC,IAAI1oL,IAAI,CAAC,QAAS,MAAO,UACrE,GAAGoP,IAAsB,UAAZA,EAAMphB,GAAiB06L,EAAWn1J,IAAInkB,EAAM/tB,OAAQ,CAC/D,MAAMe,EAAO4e,GAAgBoO,EAAO,GAAI,IAExC,GAAc,mBAAXhtB,EAAK4L,IACNgtH,EAAiB96H,SAASC,cAAc,OACxC66H,EAAex6H,UAAUC,IAAI,yBAEK,UAA9B2uB,EAAqB/tB,MACvB25H,EAAex6H,UAAUC,IAAI,YAG/BgoM,EAAYx1L,KAAKyc,GAAU,CACzBzO,MAAOmO,EACP3gB,QAAS+8D,EACTlpE,UAAW04H,EACXjrG,kBAAkB,EAClB3tB,KAAAA,IACCU,MAAK,IAAMk4H,KAEX0tE,EAAWn1J,IAAKnkB,EAAqB/tB,OAAO,CAC7C,MAAMsnM,EAAWzoM,SAASC,cAAc,QACxCwoM,EAASnoM,UAAUC,IAAI,cAEvBu6H,EAAel6H,OAAO6nM,KAO9B,GAAGJ,EAAc,CACf,MAAM5+K,EAAOzpB,SAASC,cAAc,KACpCwpB,EAAKnpB,UAAUC,IAAI,UACnBkpB,EAAK7oB,QAAO,QAAK,SAAU,MAC3B2nM,EAAYhoL,QAAQkJ,QACf,GAAGhc,EAAOkpC,aAAelpC,IAAW69D,EAAY98D,SAAY88D,EAAuCpmB,OAAQ,CAChH,MAAMwjJ,EAAa1oM,SAASC,cAAc,KAE1C,GAAGqrE,EAAY98D,SAAW,SACxBk6L,EAAW9nM,QAAO,QAAK,YACvB2nM,EAAYhoL,QAAQmoL,OACf,CAEL,MAAM55J,EAAIlf,EAAWo4B,GAAc,CACjCv6C,OAAQ69D,EAAY98D,OACpBirB,eAAe,KACb72B,MAAM0I,IACRo9L,EAAW3jM,QAAQuG,GACZo9L,IACN7pK,GAAA,GAEH0pK,EAAYhoL,QAAQuuB,GAGtB45J,EAAW9nM,OAAO,MAIpB,MAAMq4D,IAAqB6hE,MAAqBxvD,MAAAA,OAAW,EAAXA,EAAiC/8D,SAEjF,IAAI6H,EAWJ,GATEA,EADC4iD,GAAkBsS,EAAgC/8D,cAClCqhB,EAAWuoC,GAAoBmT,OAAapgE,OAAWA,GAAW,EAAO8tD,EAAeC,IACjGovI,QACSz4K,EAAWuoC,GAAoBkwI,IACxC/8H,QACS17C,EAAWuoC,GAAoBmT,OAAapgE,OAAWA,GAAW,OAAOA,EAAW+tD,IAE1Fj5D,SAASqW,yBAGnBkyL,EAAY1mM,OAAQ,CACrB,MAAMs5B,QAAiBvL,EAAWvrB,QAAQC,IAAIikM,IAC9CnyL,EAASrR,WAAWo2B,IAGtB,EAAArsB,EAAA,GAAeuN,EAAIE,gBAAiBnG,GAGtC,GAAGk1D,GAAe+8H,EAAwD,CACxE,MAAMh0L,EAAOg0L,EAAexkM,KAAKH,IAAI2kM,EAAah0L,KAAMi3D,EAAYj3D,MAAQ,GAAKi3D,EAAYj3D,MAC7F,EAAAvF,EAAA,GAAeuN,EAAIisL,aAAcnzL,EAA8B,IAAIvO,KAAY,IAAPyN,UACnEgI,EAAIisL,aAAaz0K,YAAc,GAErB,OAAd4wK,GAAuBA,IACxBpoL,EAAI49B,OAAOnxC,QAAQqF,IAAM,GAAKm9D,EAAYn9D,KAG5CnD,EAAQ/E,aAGF4+L,mBAAmB/kM,GAMzB,OAAOoB,KAAKynM,kBAAkB7oM,EAAQ45B,OAAQ55B,EAAQuc,IAAKvc,EAAQghM,QAAShhM,EAAQurE,uBAAuBt8D,OAAM,SAGrG45L,kBACZjvK,EACArd,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,QAC/BqzL,GAAU,EACVz1H,G,gDAEA,IAAIhvD,EAEF,OAGF,MAAM,SAAC0kB,EAAQ,WAAEnR,GAAc4wK,GAAqBnkL,EAAK,2BAEnDkjC,QAAgB3vB,EAAW1uB,KAAK2S,SAASyrC,wBAAwBO,iBAAiBnmB,EAAOjsB,QAAQ,IACjGm7L,EAAWvsL,EAAI49B,OAAO35C,UAAUiG,SAAS,YAE/C,IAAIsiM,EACJ,GAAuB,kBAAR,QAAZ,EAAAnvK,EAAO+0G,aAAK,eAAE3gI,GAAsB,CACrC,MAAMw9D,QAA+B17C,EAAW1uB,KAAK2S,SAAS40B,mBAAmBuvB,iBAAiBt+B,EAAOjsB,OAAQisB,EAAOyhK,cACrH7vH,GAAeA,EAAY5xD,OAAO4F,KAAOgsD,EAAY79D,SAAW,WACjEo7L,EAAmBv9H,GAIvB,MAAMz+C,QAAe+C,EAAW1uB,KAAK2S,SAASo2E,eAAeyD,UAAUxsF,KAAKusF,WAC5E,IAAIy/E,EAEFA,EADCrgJ,GAC2D,IAAjDA,EAAO68D,cAAchyE,QAAQgiB,EAAOjsB,UAElCisB,EAAOhgB,OAAOosF,OAG7B,MAAMs1F,QAAuBxrK,EAAW1uB,KAAK2S,SAAS40B,mBAAmB2yJ,eAAe1hK,IAClFovK,EAAiB57B,GAAYkuB,EAKnC,GAAG/vH,EACD,UACQz7C,EAAWy7C,GACjB,MAAM18D,IAKV,MAAMo6L,EAAqBjI,EAAU,EAAI,IAEtCvhJ,IAAYqpJ,IACb,QAAcvsL,EAAI49B,OAAQ,WAAYsF,EAASwpJ,GR7tD9C,SACL3mM,EACAmM,EACAy6L,GAEA,IAAInpM,EAWJ,IAVG0O,MAAAA,OAAO,EAAPA,EAASmL,OAAO4F,OAEfzf,EADC0O,EAAQmL,OAAOqiB,YACJ,UACJxtB,EAAQmL,OAAOksG,OACX,QAEA,WAIZ/lH,EAEF,YADAuC,EAAUyxB,YAAc,IAI1B,MAAMk3I,EAAgB,SAAWlrK,EAC3BijM,EAAc1gM,EAAUuD,iBAC9B,GAAGm9L,GAAeA,EAAYxiM,UAAUiG,SAASwkK,GAC/C,OAGF,MAAMz/J,EAAUtL,SAASC,cAAc,KACvCqL,EAAQhL,UAAUC,IAAI,sBAAgDwqK,GACtE3oK,EAAUxB,OAAO0K,GAEdw3L,GACDA,EAAYthM,SQgsDZynM,CAAiB5sL,EAAI6sL,WAAYL,GAEjC,MAAMM,GAAuB,EAAAl+K,GAAA,GAAQ5O,EAAI+sL,aACtCN,IAAmBK,GACpB9sL,EAAIq6B,WAAW91C,OAAOyb,EAAI+sL,aAG5B,MAAMC,EAAmB3vK,EAAO+2G,wBAA0B/2G,EAAO+2G,sBAAwB,GAAK/2G,EAAO6nF,aAAe,GAC9G+nF,EAAwBjtL,EAAIktL,gBAAiB,EAAAt+K,GAAA,GAAQ5O,EAAIktL,eAqB/D,GApBGF,IACGhtL,EAAIktL,gBACNltL,EAAIktL,cAAgBvpM,SAASC,cAAc,OAC3Coc,EAAIktL,cAAc1pM,UAAY,6DAC9Bwc,EAAIktL,cAAcppK,UAAY,IAC9B9jB,EAAIq6B,WAAW1xC,aAAaqX,EAAIktL,cAAeltL,EAAIE,gBAAgBrX,gBAIvE,QAAcmX,EAAI+sL,YAAa,aAAcN,EAAgBC,EAAoBD,OAAiB59L,EAAY,KAC5GmR,EAAI+sL,YAAY5nM,UACd2nM,EAA2B,EAAJ,GAExB9sL,EAAIktL,gBACL,QAAcltL,EAAIktL,cAAe,aAAcF,EAAkBN,EAAoBM,OAAmBn+L,EAAY,KAClHmR,EAAIktL,cAAc/nM,gBACX6a,EAAIktL,eACTD,EAA4B,EAAJ,IAG1BR,EAEF,YADA/nK,EAAS96B,UAIRinK,EACD7wJ,EAAI+sL,YAAY9oM,UAAUC,IAAI,oBAAqB,SAEnD8b,EAAI+sL,YAAY9oM,UAAUkB,OAAO,oBAAqB,SAGxD,IAAI2iG,GAAW,EAAMqlG,GAAY,EAC9B9vK,EAAO+2G,uBAAiD,IAAxB/2G,EAAO6nF,cACxCllG,EAAI+sL,YAAYjpK,UAAY,IAC5BqpK,GAAY,GAEJpO,EAER/+K,EAAI+sL,YAAYjpK,UAAY,IAAMzG,EAAO6nF,cAAgB,MAEzDllG,EAAI+sL,YAAYjpK,UAAY,GAC5BgkE,GAAW,GAGb9nF,EAAI+sL,YAAY9oM,UAAUoE,OAAO,SAAUy/F,GAC3C9nF,EAAI+sL,YAAY9oM,UAAUoE,OAAO,UAAW8kM,GAC5CzoK,EAAS96B,aAGHo+L,aAAa52L,GAEnB,MAAMnC,EAAUpK,KAAKi0F,WAAWziF,IAAIjF,GACpC,OAAOnC,MAAAA,OAAO,EAAPA,EAAS+Q,IAGJotL,UAAU/vK,G,0CACtB,GAAsB,iBAAb,EAAuB,CAC9B,MAAMgwK,QAAuBxoM,KAAK2S,SAAS40B,mBAAmB+vB,cAAc9+B,GAC5E,IAAIgwK,EAAgB,CAClB,MAAMj8L,EAASisB,GAAU,MACzB,MAAO,CACLjsB,OAAAA,EACAgoC,WAAYv0C,KAAK2S,SAAS2/B,gBAAgBm5E,cAAcl/G,GACxDiM,OAAQ,IAIZ,OAAOgwL,EAGT,OAAOhwK,KAGDiwK,cAActtL,EAAgB+B,GACpC,IAAI,SAACknL,EAAQ,OAAErrJ,GAAU59B,EACzB,IAAIipL,GAAYlnL,EAAS,CACvB,MAAM,OAACla,EAAM,eAAE46L,GAAkBziL,EAAIipL,SAAWA,EJzzDvC,SAA6Bn1F,GAAW,GACrD,MAAMjsG,EAASlE,SAASC,cAAc,UACtCiE,EAAOzB,MAAQyB,EAAOxB,OAAS06L,GAC/B,MAAMnxK,EAAU/nB,EAAO6P,WAAW,MAG5B61L,GAAWxM,IAZJ,EAWgB,GAAQ,EAAeC,KACb,EAEjC12L,EAAYC,KAAKC,MACvB,IAAIgjM,GAAa,EAEjB,MAAMz9B,EAAc,KAClB,GAAIloK,EAAOqH,YAIAs+L,IACTA,EAAa3lM,EAAOqH,kBAJpB,GAAGs+L,EACD,OAAO,EAMX,MAKMzrK,EAAW2+J,IALJn2L,KAAKC,MAKqBF,GA3B1B,IA2BiD,EAAG,EA3BpD,KA6BbslB,EAAQjY,UAAU,EAAG,EAAGopL,GAAMA,IAC9BnxK,EAAQsxD,UAAY4yB,IAAa5/E,EAAA,WAAsB,eAA6B,iBAAmB,OAEvG,IAAI,IAAItjB,EAAI,EAAGA,EApCJ,IAoCkBA,EAAG,CAG9B,IAAI68L,EAEFA,EADC1rK,GAAY,GACEnxB,EAAI,EAAI,EAAe,EAAXmxB,EAAiC,GAAjBA,EAAW,IAEvCnxB,EAAI,EAAe,EAAXmxB,EAAe,EAAe,EAAXA,EAG5C,IAAI17B,EA5CS,EA4C6B,EAAfonM,EAK3BpnM,GAAUy6L,GAGVH,GAAU/wK,EAjBA29K,EAAW38L,EAAI,GAAUA,EAAIowL,IAe5BD,GAAO16L,GAAU,EAEH,GAAOA,EAAQ,IAAQ,GAGlD,OAAO,GAGT,MAAO,CACLwB,OAAAA,EACA46L,eAAgB,MACd,SAAQ1yB,GACRA,KAEFlgK,UAAYgiD,IACViiD,EAAWjiD,EACXk+G,MI2vD2D29B,CAAoB9vJ,EAAO35C,UAAUiG,SAAS,WACzGrC,EAAO5D,UAAUC,IAAI,0BACrB05C,EAAOr5C,OAAOsD,GACd46L,IAGEwG,IAIJ,QAAcjpL,EAAIipL,SAASphM,OAAQ,aAAcka,EAAS,IAAKA,OAAUlT,EAAY,KACnFmR,EAAIipL,SAASphM,OAAO1C,SACpB6a,EAAIipL,cAAWp6L,GACdkT,EAAU,EAAI,GAGZyiL,cAAc/gM,GACnBA,EAAQ+L,YAAa,EAErB,MAAMw0C,EAAMn/C,KAAK8oM,aAAalqM,GAE9B,GAAGugD,EAAK,CACN,MAAMr1C,EAAU9J,KAAKuoM,UAAU3pM,EAAQ2N,QAAQ7K,MAAM82B,IACnD,MAAM,OAACjsB,GAAUisB,EACX/uB,EAA2B,GAoBjC,OAnBI8C,EAAO46B,UACT19B,EAASoI,KAAK7R,KAAKojM,2BAA2B5qK,EAAQ2mB,EAAIhkC,MAGzD5O,IAAW,UAAkBA,EAAO46B,UACrC19B,EAASoI,KAAK7R,KAAK2S,SAAS2I,gBAAgBC,QAAQhP,GAAQ7K,MAAM6W,I,MAC1C,sBAAR,QAAX,EAAAA,EAAKI,cAAM,eAAE/L,IACd5M,KAAKgjM,gBAAgB7jJ,EAAIhkC,IAAIkyB,UAAU,OAK7C5jC,EAASoI,KAAK7R,KAAKsjM,gBAAgB,CACjC9qK,OAAAA,EACArd,IAAKgkC,EAAIhkC,IACTykL,QAAShhM,EAAQghM,QACjB2D,WAAW,KAGNpgM,QAAQC,IAAIqG,MAGlB7K,EAAQgwB,cACThwB,EAAQgwB,aAAa/c,KAAK/H,GAI9B,OAAOq1C,EAGKikJ,2BAA2B5qK,EAAgBrd,G,0CACvD,IAAI,KACF,OAIF,GADIA,IAAKA,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,UACpC4O,EAAK,OAET,MAAMinB,QAAuCpiC,KAAK2S,SAASoH,gBAAgB00B,QAAQjW,EAAOjsB,OAAO8hB,YACjGruB,KAAKyoM,cAActtL,KAAQinB,EAAK5pB,OAAOs/I,cAAe11H,EAAK5pB,OAAOuwL,oBAM7DC,2BAA2BpqM,GAKhC,MAAM,OAAC2N,EAAM,QAAEc,EAAO,MAAE1B,GAAS/M,EAC3BugD,EAAMn/C,KAAK8oM,aAAa,OAAD,sCACxBlqM,GACAk5B,GAA6BzqB,IAAQ,CACxCd,OAAAA,KASF,OANAvM,KAAKknM,eAAe,CAACt6L,EAAG,SAAUL,OAAAA,GAAgBc,EAAS8xC,EAAIhkC,IAAKxP,GAEjE0B,EAAQd,SAAWA,IACpB4yC,EAAIhkC,IAAI49B,OAAOnxC,QAAQ2E,OAAS,GAAKc,EAAQd,QAGxC4yC,EAGF2pJ,aAAalqM,GAalB,OAAOoB,KAAKipM,UAAUrqM,EAAQ2N,OAAQ3N,EAAQsC,UAAWtC,EAAQwc,cAAexc,EAAQ25B,cAAe35B,EAAQ4O,UAAW5O,EAAQc,OAAQd,EAAQ2O,WAAY3O,EAAQ+L,WAAY/L,EAAQ6vB,cAAe7vB,EAAQgwB,aAAchwB,EAAQm5B,UAGlOkxK,UACL18L,EACArL,EACAka,GAAgB,EAChBmd,GAAgB,EAChB/qB,GAAY,EACZ9N,GAAS,EACT6N,EAAa,GACb5C,IAAezJ,EACfutB,EACAG,EACAmJ,G,MAGA,MAAMsV,EAAW,IAAIC,GACrBD,EAASjuC,UAAUC,IAAI,gBAAiB,UAAYkO,GACpD8/B,EAASxE,kBAAkB,CACzBja,aAAAA,EACAH,cAAAA,EACA8e,WAAY//B,EACZjB,OAAAA,EACA6rB,UAAWL,IAGb,MAAMmxK,EAAapqM,SAASC,cAAc,OAC1CmqM,EAAW9pM,UAAUC,IAAI,gBAEzB,MAAM8pM,EAAqBrqM,SAASC,cAAc,QAClDoqM,EAAmB/pM,UAAUC,IAAI,cAEjC,MAAM+4B,EAAY,IAAIE,GAChBo2J,EAAmBt2J,EAAUC,OAAO,CACxC9rB,OAAAA,EACAwrB,SAAAA,EACAS,OAAQhrB,EACR+qB,cAAAA,EACAz4B,WAAW,IAGV8uB,GACDA,EAAa/c,KAAK68K,GAGpBya,EAAmBzpM,OAAO04B,EAAUhuB,SAOlC++L,EAAmB/pM,UAAUC,IAAI,SAEjC,MAAM+pM,EAAoB5pJ,GAAmBjzC,GAAQ7K,MAAMu4B,IACzDkvK,EAAmBzpM,UAAUu6B,MAG5BrL,GACDA,EAAa/c,KAAKu3L,GAItB,MAAM7/L,EAAOzK,SAASC,cAAc,QACpCwK,EAAKnK,UAAUC,IAAI,qBACnBkK,EAAK/J,aAAa,MAAO,QAKzB,MAAMqzC,EAAK/zC,SAASC,cAAc25C,IAClC7F,EAAGzzC,UAAUC,IAAI,iBACbsL,IAAakoC,EAAyBqjB,KAAO,IAAM3pD,GACpD6O,IACD,EAAAvW,GAAA,GAAOguC,GAGTA,EAAGnzC,OAAO2tC,EAAU67J,GACpBr2J,EAAGjrC,QAAQ2E,OAAS,GAAKA,EAEzB,MAAMy7L,EAAalpM,SAASC,cAAc,QAC1CipM,EAAW5oM,UAAUC,IAAI,iBAAkB,kBAE3C,MAAM+nM,EAAetoM,SAASC,cAAc,QAC5CqoM,EAAahoM,UAAUC,IAAI,gBAE3B,MAAM6oM,EAAcppM,SAASC,cAAc,OAC3CmpM,EAAYvpM,UAAY,uCAExB,MAAM0qM,EAASvqM,SAASC,cAAc,KACtCsqM,EAAOjqM,UAAUC,IAAI,gBAErB,MAAMiqM,EAAYxqM,SAASC,cAAc,QACzCuqM,EAAUlqM,UAAUC,IAAI,wBACxBiqM,EAAU5pM,OAAOsoM,EAAYZ,GAC7BiC,EAAO3pM,OAAOypM,EAAoBG,GAElC,MAAM9zJ,EAAa12C,SAASC,cAAc,KAC1Cy2C,EAAWp2C,UAAUC,IAAI,mBACzBm2C,EAAW91C,OAAO6J,GAElB2/L,EAAWxpM,OAAO2pM,EAAQ7zJ,GAE1B,MAAMr6B,EAAiB,CACrBkyB,SAAAA,EACA67J,WAAAA,EACAp9H,UAAW1zC,EAAUhuB,QACrB++L,mBAAAA,EACAnB,WAAAA,EACAZ,aAAAA,EACAc,YAAAA,EACA7sL,gBAAiB9R,EACjBgsC,YAAa1C,EACbkG,OAAQlG,EACR2C,WAAAA,GAuBF,OAdGt0C,GAEDA,EADexB,EAAS,SAAW,WACjBmzC,GAGhBloC,IAEFkoC,EAAGsxJ,UAAYhpL,GAEK,QAAjB,iBAAiB,eAAE5O,UAAWA,GAC/BvM,KAAK4jM,gBAAgB/wJ,GAAI,IAItB,CAAC13B,IAAAA,GAGGqsB,UAAUhP,G,0CACrB,MAAMrd,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,QACrC,IAAI4O,EACF,OAGF,MAAMouL,EAAmBpuL,EAAIE,gBAAgBnW,cAAc,0BACrDskM,QAAyB,iBAA2BhxK,EAAOjsB,OAAQg9L,IACrEA,GAAoBC,KACtB,EAAA57L,EAAA,GAAeuN,EAAIE,gBAAiBmuL,GACpCruL,EAAIE,gBAAgBjc,UAAUC,IAAI,mBAI/B6kM,YAAY1rK,GACjB,MAAMrd,EAAMnb,KAAKmjM,aAAa3qK,EAAOjsB,QACjC4O,IAIJA,EAAIE,gBAAgBjc,UAAUkB,OAAO,eACrCN,KAAKsjM,gBAAgB,CACnB9qK,OAAAA,EACA4xC,YAAa,KACbjvD,IAAAA,EACAooL,UAAW,SAKjB,MAAM7D,GAAoB,IAAIG,GAC9B,uBAAmCH,GACnC,a,iBCrmEqM,oBAAoBl4I,MAAKA,KAA7JiiJ,EAAOC,QAAmL,SAASrpM,GAAG,IAAIgS,EAAE,GAAG,SAAS07B,EAAEhiC,GAAG,GAAGsG,EAAEtG,GAAG,OAAOsG,EAAEtG,GAAG29L,QAAQ,IAAI1tE,EAAE3pH,EAAEtG,GAAG,CAACA,EAAEA,EAAEysE,GAAE,EAAGkxH,QAAQ,IAAI,OAAOrpM,EAAE0L,GAAGiqD,KAAKgmE,EAAE0tE,QAAQ1tE,EAAEA,EAAE0tE,QAAQ37J,GAAGiuF,EAAExjD,GAAE,EAAGwjD,EAAE0tE,QAAQ,OAAO37J,EAAEliB,EAAExrB,EAAE0tC,EAAEj3B,EAAEzE,EAAE07B,EAAE36B,EAAE,SAAS/S,EAAEgS,EAAEtG,GAAGgiC,EAAEA,EAAE1tC,EAAEgS,IAAI85E,OAAOw9G,eAAetpM,EAAEgS,EAAE,CAACu3L,YAAW,EAAGp4L,IAAIzF,KAAKgiC,EAAE3oC,EAAE,SAAS/E,GAAG,oBAAoBwpM,QAAQA,OAAOC,aAAa39G,OAAOw9G,eAAetpM,EAAEwpM,OAAOC,YAAY,CAACtpM,MAAM,WAAW2rF,OAAOw9G,eAAetpM,EAAE,aAAa,CAACG,OAAM,KAAMutC,EAAE17B,EAAE,SAAShS,EAAEgS,GAAG,GAAG,EAAEA,IAAIhS,EAAE0tC,EAAE1tC,IAAI,EAAEgS,EAAE,OAAOhS,EAAE,GAAG,EAAEgS,GAAG,iBAAiBhS,GAAGA,GAAGA,EAAE0pM,WAAW,OAAO1pM,EAAE,IAAI0L,EAAEogF,OAAOpJ,OAAO,MAAM,GAAGh1C,EAAE3oC,EAAE2G,GAAGogF,OAAOw9G,eAAe59L,EAAE,UAAU,CAAC69L,YAAW,EAAGppM,MAAMH,IAAI,EAAEgS,GAAG,iBAAiBhS,EAAE,IAAI,IAAI27H,KAAK37H,EAAE0tC,EAAE36B,EAAErH,EAAEiwH,EAAE,SAAS3pH,GAAG,OAAOhS,EAAEgS,IAAInJ,KAAK,KAAK8yH,IAAI,OAAOjwH,GAAGgiC,EAAEiuF,EAAE,SAAS37H,GAAG,IAAIgS,EAAEhS,GAAGA,EAAE0pM,WAAW,WAAW,OAAO1pM,EAAEyrB,SAAS,WAAW,OAAOzrB,GAAG,OAAO0tC,EAAE36B,EAAEf,EAAE,IAAIA,GAAGA,GAAG07B,EAAEA,EAAE,SAAS1tC,EAAEgS,GAAG,OAAO85E,OAAO69G,UAAUrqL,eAAeq2C,KAAK31D,EAAEgS,IAAI07B,EAAEH,EAAE,GAAGG,EAAEA,EAAEhU,EAAE,GAAj5B,CAAq5B,CAAC,SAAS15B,EAAEgS,EAAE07B,GAAG,cAAa,SAAU17B,GAAG,IAAI07B,EAAE17B,EAAE0zI,cAAc1zI,EAAE2zI,mBAAmBj6I,EAAE,SAAS1L,GAAG,IAAI0L,EAAEk+L,uBAAuB,MAAM,IAAInqK,MAAM,8CAA8Cz/B,IAAIA,EAAE,IAAIL,KAAKorC,MAAM,WAAWprC,KAAKw5H,OAAOrtC,OAAO0uC,OAAO,CAACqvE,aAAa,KAAKC,mBAAmB,KAAKC,iBAAiB,GAAGC,YAAY,uBAAuB58D,kBAAkB,KAAK68D,iBAAiB,GAAGC,uBAAsB,EAAG78D,YAAY,EAAEC,iBAAiB,EAAEC,cAAc,EAAE48D,gBAAgB,EAAEC,aAAY,EAAG58D,aAAY,EAAG68D,YAAY,IAAIrqM,GAAGL,KAAK2qM,sBAAsB,GAAG5+L,EAAEk+L,qBAAqB,WAAW,OAAOl8J,GAAG17B,EAAEmJ,WAAWnJ,EAAEmJ,UAAUgkI,cAAcntI,EAAEmJ,UAAUgkI,aAAaa,cAAchuI,EAAEu4L,aAAa7+L,EAAEi+L,UAAUa,YAAY,WAAW7qM,KAAKogJ,SAASpgJ,KAAKogJ,OAAOE,UAAUtgJ,KAAKogJ,OAAOE,YAAYlzI,SAAQ,SAAU/M,GAAGA,EAAE0C,UAAU/C,KAAKogJ,OAAOr9I,cAAc/C,KAAKogJ,QAAQpgJ,KAAK8qM,cAAc9qM,KAAK+qM,oBAAoB/qM,KAAK8qM,aAAa77L,eAAejP,KAAK8qM,eAAe/+L,EAAEi+L,UAAUgB,cAAc,SAAS3qM,GAAG,GAAG,cAAcL,KAAKorC,MAAM,CAAC,IAAI,IAAI/4B,EAAE,GAAG07B,EAAE,EAAEA,EAAE1tC,EAAEstI,iBAAiB5/F,IAAI17B,EAAE07B,GAAG1tC,EAAE4qM,eAAel9J,GAAG/tC,KAAKkrM,QAAQC,YAAY,CAAC9pE,QAAQ,SAAS+pE,QAAQ/4L,MAAMtG,EAAEi+L,UAAUqB,iBAAiB,SAAShrM,GAAG,OAAOA,GAAGA,EAAE0qB,SAAS/qB,KAAK8qM,aAAazqM,EAAE0qB,QAAQ/qB,KAAK+qM,mBAAkB,IAAK/qM,KAAK8qM,aAAa,IAAI/8J,EAAE/tC,KAAK+qM,mBAAkB,GAAI/qM,KAAK8qM,cAAc/+L,EAAEi+L,UAAUsB,eAAe,WAAWtrM,KAAKgrM,cAAc,kBAAkBhrM,KAAKgrM,eAAehrM,KAAKurM,oBAAoBvrM,KAAK8qM,aAAaU,sBAAsBxrM,KAAKw5H,OAAO0wE,aAAalqM,KAAKw5H,OAAOmU,iBAAiB3tI,KAAKw5H,OAAOmU,kBAAkB3tI,KAAKurM,oBAAoB7hE,QAAQ1pI,KAAK8qM,aAAaW,aAAazrM,KAAKurM,oBAAoBG,eAAerrM,IAAIL,KAAKgrM,cAAc3qM,EAAEsrM,cAAc3rM,KAAK4rM,gBAAgB5rM,KAAK8qM,aAAa3lD,aAAanlJ,KAAK6rM,eAAe7rM,KAAKw5H,OAAOkU,aAAa1tI,KAAK4rM,gBAAgBliE,QAAQ1pI,KAAK8qM,aAAaW,aAAazrM,KAAK8rM,kBAAkB9rM,KAAK8qM,aAAa3lD,aAAanlJ,KAAK+rM,iBAAiB/rM,KAAKw5H,OAAOoU,eAAe5tI,KAAK8rM,kBAAkBpiE,QAAQ1pI,KAAKurM,sBAAsBx/L,EAAEi+L,UAAUgC,eAAe,SAAS3rM,GAAG,OAAOA,GAAGA,EAAE0qB,QAAQ1Y,EAAElP,QAAQ4B,QAAQ1E,GAAGgS,EAAEmJ,UAAUgkI,aAAaa,aAAa,CAACljH,MAAMn9B,KAAKw5H,OAAO+wE,wBAAwB7oM,MAAKrB,IAAIL,KAAKogJ,OAAO//I,EAAEL,KAAK8qM,aAAa7lD,wBAAwB5kJ,OAAM0L,EAAEi+L,UAAUiC,WAAW,WAAWjsM,KAAKkrM,UAAUlrM,KAAKkrM,QAAQ,IAAI74L,EAAE65L,OAAOlsM,KAAKw5H,OAAO6wE,eAAet+L,EAAEi+L,UAAUmC,WAAW,WAAW,IAAI9rM,GAAGL,KAAKw5H,OAAOixE,YAAYzqM,KAAKosM,WAAWpsM,KAAKqsM,WAAWnjM,KAAKlJ,MAAM,OAAOA,KAAKssM,cAAc,GAAGtsM,KAAK0oB,YAAY,EAAE1oB,KAAKisM,aAAa,IAAI9oM,SAAQ,CAACkP,EAAE07B,KAAK,IAAIhiC,EAAEgiC,IAAI,OAAOA,EAAEpH,KAAKt5B,SAAS,IAAI,QAAQgF,IAAI,MAAM,IAAI,OAAOrS,KAAK2qM,sBAAsB58J,EAAEpH,KAAK4lK,eAAelsM,EAAE0tC,EAAEpH,KAAK6lK,MAAM,MAAM,IAAI,OAAOxsM,KAAKkrM,QAAQ7kM,oBAAoB,UAAU0F,GAAG/L,KAAK27H,WAAW37H,KAAKkrM,QAAQ9qM,iBAAiB,UAAU2L,GAAG/L,KAAKkrM,QAAQC,YAAYh/G,OAAO0uC,OAAO,CAACwG,QAAQ,OAAOorE,mBAAmBzsM,KAAK8qM,aAAa4B,WAAWC,cAAc3sM,KAAK8qM,aAAa4B,YAAY1sM,KAAKw5H,aAAYztH,EAAEi+L,UAAUhoM,MAAM,SAAS3B,GAAG,GAAG,cAAcL,KAAKorC,MAAM,CAAC,GAAGprC,KAAKorC,MAAM,SAAS/qC,GAAGL,KAAKw5H,OAAOixE,YAAY,CAAC,IAAIp4L,EAAErS,KAAKkrM,QAAQ,OAAO,IAAI/nM,SAAQ,CAAC9C,EAAE0tC,KAAK,IAAIhiC,EAAEgiC,IAAI,YAAYA,EAAEpH,KAAKt5B,UAAUgF,EAAEhM,oBAAoB,UAAU0F,GAAG/L,KAAK4sM,UAAUvsM,MAAMgS,EAAEjS,iBAAiB,UAAU2L,GAAGsG,EAAE84L,YAAY,CAAC9pE,QAAQ,aAAY,OAAOrhI,KAAK4sM,UAAUzpM,QAAQ4B,YAAYgH,EAAEi+L,UAAU6C,OAAO,WAAW,WAAW7sM,KAAKorC,QAAQprC,KAAKorC,MAAM,YAAYprC,KAAK8sM,aAAa/gM,EAAEi+L,UAAU+B,iBAAiB,SAAS1rM,GAAGL,KAAKw5H,OAAOoU,cAAcvtI,EAAEL,KAAK8rM,mBAAmB9rM,KAAK8qM,cAAc9qM,KAAK8rM,kBAAkB5mD,KAAK6nD,gBAAgB1sM,EAAEL,KAAK8qM,aAAa1zK,YAAY,MAAMrrB,EAAEi+L,UAAU6B,eAAe,SAASxrM,GAAGL,KAAKw5H,OAAOkU,YAAYrtI,EAAEL,KAAK4rM,iBAAiB5rM,KAAK8qM,cAAc9qM,KAAK4rM,gBAAgB1mD,KAAK6nD,gBAAgB1sM,EAAEL,KAAK8qM,aAAa1zK,YAAY,MAAMrrB,EAAEi+L,UAAUt/K,MAAM,SAASrqB,GAAG,GAAG,aAAaL,KAAKorC,MAAM,OAAOprC,KAAKqrM,iBAAiBhrM,GAAGL,KAAKsrM,iBAAiBtrM,KAAK2qM,sBAAsB,EAAE3qM,KAAKmsM,aAAazqM,MAAK,IAAI1B,KAAKgsM,eAAe3rM,KAAIqB,MAAKrB,IAAIL,KAAKupI,WAAWlpI,EAAEL,KAAKorC,MAAM,YAAYprC,KAAKgtM,UAAUhtM,KAAKkrM,QAAQC,YAAY,CAAC9pE,QAAQ,mBAAmBrhI,KAAKupI,WAAWG,QAAQ1pI,KAAK4rM,iBAAiB5rM,KAAKupI,WAAWG,QAAQ1pI,KAAK8rM,uBAAsB//L,EAAEi+L,UAAUjnM,KAAK,WAAW,GAAG,aAAa/C,KAAKorC,MAAM,CAACprC,KAAKorC,MAAM,WAAWprC,KAAK4rM,gBAAgBruL,aAAavd,KAAKurM,oBAAoBhuL,aAAavd,KAAK8rM,kBAAkBvuL,aAAavd,KAAKupI,WAAWhsH,aAAavd,KAAK6qM,cAAc,IAAIxqM,EAAEL,KAAKkrM,QAAQ,OAAO,IAAI/nM,SAAQkP,IAAI,IAAI07B,EAAEhiC,IAAI,SAASA,EAAE46B,KAAKt5B,UAAUhN,EAAEgG,oBAAoB,UAAU0nC,GAAG17B,MAAMhS,EAAED,iBAAiB,UAAU2tC,GAAG1tC,EAAE8qM,YAAY,CAAC9pE,QAAQ,SAASrhI,KAAKw5H,OAAOqU,aAAaxtI,EAAE8qM,YAAY,CAAC9pE,QAAQ,aAAY,OAAOl+H,QAAQ4B,WAAWgH,EAAEi+L,UAAUiD,cAAc,WAAW,aAAajtM,KAAKorC,OAAOprC,KAAKkrM,UAAUlrM,KAAKkrM,QAAQC,YAAY,CAAC9pE,QAAQ,iBAAiBrhI,KAAKkrM,UAAUn/L,EAAEi+L,UAAUqC,UAAU,SAAShsM,GAAGL,KAAKssM,cAAcz6L,KAAKxR,GAAGL,KAAK0oB,aAAaroB,EAAEM,QAAQoL,EAAEi+L,UAAUoC,WAAW,SAAS/rM,GAAGL,KAAK+tI,gBAAgB1tI,IAAI0L,EAAEi+L,UAAUruE,OAAO,WAAW,IAAI37H,KAAKw5H,OAAOixE,YAAY,CAAC,IAAIpqM,EAAE,IAAIqsB,WAAW1sB,KAAK0oB,aAAa1oB,KAAKssM,cAAcxrL,QAAO,SAAUzO,EAAE07B,GAAG,OAAO1tC,EAAE4c,IAAI8wB,EAAE17B,GAAGA,EAAE07B,EAAEptC,SAAS,GAAGX,KAAK+tI,gBAAgB1tI,GAAGL,KAAK8tI,SAAS9tI,KAAKw5H,OAAOqU,oBAAoB7tI,KAAKkrM,SAASn/L,EAAEi+L,UAAUj8D,gBAAgB,aAAahiI,EAAEi+L,UAAU4C,QAAQ,aAAa7gM,EAAEi+L,UAAU8C,SAAS,aAAa/gM,EAAEi+L,UAAUgD,QAAQ,aAAajhM,EAAEi+L,UAAUl8D,OAAO,aAAaztI,EAAEqpM,QAAQ39L,IAAIiqD,KAAKh2D,KAAK+tC,EAAE,KAAK,SAAS1tC,EAAEgS,GAAG,IAAI07B,EAAEA,EAAE,WAAW,OAAO/tC,KAAlB,GAA0B,IAAI+tC,EAAEA,GAAG,IAAIm/J,SAAS,cAAb,GAA8B,MAAM7sM,GAAG,iBAAiByF,SAASioC,EAAEjoC,QAAQzF,EAAEqpM,QAAQ37J","sources":["webpack://tweb/./src/components/button.ts","webpack://tweb/./src/components/codeInputField.ts","webpack://tweb/./src/components/monkeys/password.ts","webpack://tweb/./src/components/monkeys/tracking.ts","webpack://tweb/./src/components/passwordInputField.ts","webpack://tweb/./src/components/putPreloader.ts","webpack://tweb/./src/components/ripple.ts","webpack://tweb/./src/helpers/cleanSearchText.ts","webpack://tweb/./src/helpers/dom/clickEvent.ts","webpack://tweb/./src/helpers/dom/htmlToSpan.ts","webpack://tweb/./src/helpers/sequentialDom.ts","webpack://tweb/./src/components/appSearch.ts","webpack://tweb/./src/components/inputSearch.ts","webpack://tweb/./src/components/buttonIcon.ts","webpack://tweb/./src/components/sliderTab.ts","webpack://tweb/./src/components/slider.ts","webpack://tweb/./src/components/avatarEdit.ts","webpack://tweb/./src/components/buttonCorner.ts","webpack://tweb/./src/helpers/date.ts","webpack://tweb/./src/components/wrappers/getUserStatusString.ts","webpack://tweb/./src/components/sidebarLeft/tabs/newGroup.ts","webpack://tweb/./src/components/visibilityIntersector.ts","webpack://tweb/./src/helpers/array/findAndSpliceAll.ts","webpack://tweb/./src/components/lazyLoadQueueIntersector.ts","webpack://tweb/./src/components/lazyLoadQueue.ts","webpack://tweb/./src/lib/appManagers/utils/photos/choosePhotoSize.ts","webpack://tweb/./src/helpers/array/accumulate.ts","webpack://tweb/./src/components/groupedLayout.ts","webpack://tweb/./src/components/prepareAlbum.ts","webpack://tweb/./src/helpers/dom/renderImageFromUrl.ts","webpack://tweb/./src/helpers/dom/renderImageWithFadeIn.ts","webpack://tweb/./src/components/preloader.ts","webpack://tweb/./src/helpers/heavyQueue.ts","webpack://tweb/./src/helpers/blur.ts","webpack://tweb/./src/helpers/bytes/getPreviewURLFromBytes.ts","webpack://tweb/./src/helpers/bytes/bytesToDataURL.ts","webpack://tweb/./src/helpers/getPreviewURLFromThumb.ts","webpack://tweb/./src/helpers/getImageFromStrippedThumb.ts","webpack://tweb/./src/helpers/getStrippedThumbIfNeeded.ts","webpack://tweb/./src/helpers/setAttachmentSize.ts","webpack://tweb/./src/components/wrappers/photo.ts","webpack://tweb/./src/helpers/dom/createVideo.ts","webpack://tweb/./src/helpers/schedulers/throttleWithRaf.ts","webpack://tweb/./src/helpers/schedulers/throttleWith.ts","webpack://tweb/./src/helpers/string/toHHMMSS.ts","webpack://tweb/./src/helpers/canvas/getTextWidth.ts","webpack://tweb/./src/components/middleEllipsis.ts","webpack://tweb/./src/helpers/formatBytes.ts","webpack://tweb/./src/helpers/dom/attachGrabListeners.ts","webpack://tweb/./src/components/rangeSelector.ts","webpack://tweb/./src/components/mediaProgressLine.ts","webpack://tweb/./src/lib/appManagers/utils/messages/getMessageSenderPeerIdOrName.ts","webpack://tweb/./src/components/peerTitle.ts","webpack://tweb/./src/components/wrappers/senderToPeer.ts","webpack://tweb/./src/components/wrappers/sentTime.ts","webpack://tweb/./src/components/audio.ts","webpack://tweb/./src/components/wrappers/video.ts","webpack://tweb/./src/components/wrappers/album.ts","webpack://tweb/./src/components/wrappers/document.ts","webpack://tweb/./src/helpers/saveLottiePreview.ts","webpack://tweb/./src/components/wrappers/stickerAnimation.ts","webpack://tweb/./src/components/wrappers/sticker.ts","webpack://tweb/./src/helpers/bytes/getPathFromBytes.ts","webpack://tweb/./src/components/editPeer.ts","webpack://tweb/./src/components/radioForm.ts","webpack://tweb/./src/components/row.ts","webpack://tweb/./src/helpers/clipboard.ts","webpack://tweb/./src/components/radioField.ts","webpack://tweb/./src/components/toast.ts","webpack://tweb/./src/lib/richTextProcessor/isUsernameValid.ts","webpack://tweb/./src/components/usernameInputField.ts","webpack://tweb/./src/components/popups/peer.ts","webpack://tweb/./src/components/sidebarRight/tabs/chatType.ts","webpack://tweb/./src/helpers/scrollableLoader.ts","webpack://tweb/./src/helpers/windowSize.ts","webpack://tweb/./src/helpers/array/filterAsync.ts","webpack://tweb/./src/helpers/number/numberThousandSplitter.ts","webpack://tweb/./src/components/wrappers/getChatMembersString.ts","webpack://tweb/./src/components/appSelectPeers.ts","webpack://tweb/./src/components/popups/pickUser.ts","webpack://tweb/./src/components/sidebarRight/tabs/userPermissions.ts","webpack://tweb/./src/components/sidebarRight/tabs/groupPermissions.ts","webpack://tweb/./src/lib/appManagers/utils/chats/combineParticipantBannedRights.ts","webpack://tweb/./src/components/popups/deleteDialog.ts","webpack://tweb/./src/components/sidebarRight/tabs/chatReactions.ts","webpack://tweb/./src/components/sidebarRight/tabs/editChat.ts","webpack://tweb/./src/components/wrappers/formatUserPhone.ts","webpack://tweb/./src/components/sidebarRight/tabs/editContact.ts","webpack://tweb/./src/components/sidebarLeft/tabs/addMembers.ts","webpack://tweb/./src/components/generateFakeIcon.ts","webpack://tweb/./src/components/generateTitleIcons.ts","webpack://tweb/./src/components/generateVerifiedIcon.ts","webpack://tweb/./src/lib/appManagers/utils/peers/getPeerColorById.ts","webpack://tweb/./src/lib/richTextProcessor/getAbbreviation.ts","webpack://tweb/./src/components/putPhoto.ts","webpack://tweb/./src/components/wrappers/getPeerInitials.ts","webpack://tweb/./src/helpers/contextMenuController.ts","webpack://tweb/./src/components/swipeHandler.ts","webpack://tweb/./src/components/peerProfileAvatars.ts","webpack://tweb/./src/components/wrappers/peerTitle.ts","webpack://tweb/./src/components/peerProfile.ts","webpack://tweb/./src/components/sidebarRight/tabs/sharedMedia.ts","webpack://tweb/./src/components/sidebarRight/index.ts","webpack://tweb/./src/components/sidebarRight/tabs/pollResults.ts","webpack://tweb/./src/components/stackedAvatars.ts","webpack://tweb/./src/components/poll.ts","webpack://tweb/./src/components/divAndCaption.ts","webpack://tweb/./src/helpers/dom/htmlToDocumentFragment.ts","webpack://tweb/./src/helpers/restrictions.ts","webpack://tweb/./src/helpers/string/escapeRegExp.ts","webpack://tweb/./src/lib/appManagers/utils/messages/isMessageRestricted.ts","webpack://tweb/./src/helpers/formatCallDuration.ts","webpack://tweb/./src/helpers/formatDuration.ts","webpack://tweb/./src/components/wrappers/joinVoiceChatAnchor.ts","webpack://tweb/./src/components/wrappers/messageActionTextNew.ts","webpack://tweb/./src/components/wrappers/messageActionTextNewUnsafe.ts","webpack://tweb/./src/components/wrappers/messageForReply.ts","webpack://tweb/./src/components/chat/replyContainer.ts","webpack://tweb/./src/components/wrappers/reply.ts","webpack://tweb/./src/components/wrappers/stickerSetThumb.ts","webpack://tweb/./src/components/wrappers/stickerToRow.ts","webpack://tweb/./src/helpers/dom/positionElementByIndex.ts","webpack://tweb/./src/helpers/sortedList.ts","webpack://tweb/./src/components/sortedUserList.ts","webpack://tweb/./src/helpers/dom/attachContextMenuListener.ts","webpack://tweb/./src/helpers/dom/handleHorizontalSwipe.ts","webpack://tweb/./src/helpers/dom/handleTabSwipe.ts","webpack://tweb/./src/components/buttonMenu.ts","webpack://tweb/./src/components/popups/forward.ts","webpack://tweb/./src/components/popups/deleteMessages.ts","webpack://tweb/./src/components/popups/sendNow.ts","webpack://tweb/./src/helpers/dom/cancelSelection.ts","webpack://tweb/./src/components/chat/selection.ts","webpack://tweb/./src/helpers/dom/getSelectedText.ts","webpack://tweb/./src/components/wrappers/webPageDescription.ts","webpack://tweb/./src/components/wrappers/webPageTitle.ts","webpack://tweb/./src/helpers/positionMenu.ts","webpack://tweb/./src/components/appSearchSuper..ts","webpack://tweb/./src/helpers/dom/lockTouchScroll.ts","webpack://tweb/./src/components/buttonMenuToggle.ts","webpack://tweb/./src/lib/appManagers/utils/privacy/getPrivacyRulesDetails.ts","webpack://tweb/./src/lib/appManagers/utils/privacy/privacyType.ts","webpack://tweb/./src/components/privacySection.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/phoneNumber.ts","webpack://tweb/./src/helpers/dom/anchorCopy.ts","webpack://tweb/./src/components/wrappers/stickerEmoji.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/passwordSet.ts","webpack://tweb/./src/helpers/dom/canFocus.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/emailConfirmation.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/email.ts","webpack://tweb/./src/lib/richTextProcessor/matchEmail.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/hint.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/reEnterPassword.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/enterPassword.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/index.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/lastSeen.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/profilePhoto.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/forwardMessages.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/addToGroups.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/calls.ts","webpack://tweb/./src/components/sidebarLeft/tabs/activeSessions.ts","webpack://tweb/./src/components/sidebarLeft/tabs/blockedUsers.ts","webpack://tweb/./src/helpers/string/convertKeyToInputKey.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacyAndSecurity.ts","webpack://tweb/./src/helpers/averageColor.ts","webpack://tweb/./src/helpers/highlightningColor.ts","webpack://tweb/./src/components/chat/gradientRenderer.ts","webpack://tweb/./src/components/colorPicker.ts","webpack://tweb/./src/components/sidebarLeft/tabs/backgroundColor.ts","webpack://tweb/./src/helpers/canvas/scaleMediaElement.ts","webpack://tweb/./src/components/sidebarLeft/tabs/background.ts","webpack://tweb/./src/helpers/files/requestFile.ts","webpack://tweb/./src/components/popups/stickers.ts","webpack://tweb/./src/components/sidebarLeft/tabs/quickReaction.ts","webpack://tweb/./src/components/sidebarLeft/tabs/generalSettings.ts","webpack://tweb/./src/helpers/eachMinute.ts","webpack://tweb/./src/helpers/eachTimeout.ts","webpack://tweb/./src/components/sidebarLeft/tabs/editProfile.ts","webpack://tweb/./src/components/sidebarLeft/tabs/includedChats.ts","webpack://tweb/./src/components/sidebarLeft/tabs/editFolder.ts","webpack://tweb/./src/components/sidebarLeft/tabs/chatFolders.ts","webpack://tweb/./src/components/sidebarLeft/tabs/notifications.ts","webpack://tweb/./src/components/sidebarLeft/tabs/language.ts","webpack://tweb/./src/components/confirmationPopup.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/photo.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/file.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/video.ts","webpack://tweb/./src/components/sidebarLeft/tabs/dataAndStorage.ts","webpack://tweb/./src/components/sidebarLeft/tabs/settings.ts","webpack://tweb/./src/components/sidebarLeft/tabs/newChannel.ts","webpack://tweb/./src/components/popups/createContact.ts","webpack://tweb/./src/components/sidebarLeft/tabs/contacts.ts","webpack://tweb/./src/components/sidebarLeft/tabs/archivedTab.ts","webpack://tweb/./src/components/sidebarLeft/tabs/peopleNearby.ts","webpack://tweb/./src/helpers/number/formatNumber.ts","webpack://tweb/./src/components/sidebarLeft/index.ts","webpack://tweb/./src/components/chat/bubbleGroups.ts","webpack://tweb/./src/helpers/array/partition.ts","webpack://tweb/./src/components/popups/datePicker.ts","webpack://tweb/./src/components/stickyIntersector.ts","webpack://tweb/./src/components/chat/reaction.ts","webpack://tweb/./src/components/chat/reactions.ts","webpack://tweb/./src/components/chat/replies.ts","webpack://tweb/./src/components/chat/messageRender.ts","webpack://tweb/./src/helpers/dom/getElementByPoint.ts","webpack://tweb/./src/helpers/dom/reflowScrollableElement.ts","webpack://tweb/./src/lib/mtproto/constants.ts","webpack://tweb/./src/helpers/dom/getVisibleRect.ts","webpack://tweb/./src/lib/appManagers/internalLink.ts","webpack://tweb/./src/components/popups/joinChatInvite.ts","webpack://tweb/./src/helpers/scrollSaver.ts","webpack://tweb/./src/helpers/dom/superIntersectionObserver.ts","webpack://tweb/./src/lib/appManagers/utils/messages/isMentionUnread.ts","webpack://tweb/./src/helpers/middlewarePromise.ts","webpack://tweb/./src/lib/richTextProcessor/getEmojiEntityFromEmoji.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/emoji.ts","webpack://tweb/./src/lib/richTextProcessor/wrapSingleEmoji.ts","webpack://tweb/./src/components/lazyLoadQueueRepeat2.ts","webpack://tweb/./src/components/gifsMasonry.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/gifs.ts","webpack://tweb/./src/components/lazyLoadQueueRepeat.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/stickers.ts","webpack://tweb/./src/components/sidebarRight/tabs/gifs.ts","webpack://tweb/./src/components/sidebarRight/tabs/stickers.ts","webpack://tweb/./src/helpers/dropdownHover.ts","webpack://tweb/./src/components/emoticonsDropdown/index.ts","webpack://tweb/./src/components/chat/bubbles.ts","webpack://tweb/./src/helpers/dom/copyFromElement.ts","webpack://tweb/./src/components/wrappers/groupedDocuments.ts","webpack://tweb/./src/components/wrappers/poll.ts","webpack://tweb/./src/helpers/dom/getViewportSlice.ts","webpack://tweb/./src/components/popups/unpinMessage.ts","webpack://tweb/./src/helpers/dom/isSelectionEmpty.ts","webpack://tweb/./src/helpers/preloadAnimatedEmojiSticker.ts","webpack://tweb/./src/components/popups/reportMessagesConfirm.ts","webpack://tweb/./src/components/popups/reportMessages.ts","webpack://tweb/./src/components/popups/sponsored.ts","webpack://tweb/./src/components/popups/reactedList.ts","webpack://tweb/./src/components/chat/reactionsMenu.ts","webpack://tweb/./src/components/chat/contextMenu.ts","webpack://tweb/./src/components/chat/sendContextMenu.ts","webpack://tweb/./src/components/popups/createPoll.ts","webpack://tweb/./src/helpers/createPoster.ts","webpack://tweb/./src/helpers/getGifDuration.ts","webpack://tweb/./src/components/popups/newMedia.ts","webpack://tweb/./src/helpers/dom/attachListNavigation.ts","webpack://tweb/./src/components/chat/autocompleteHelper.ts","webpack://tweb/./src/components/chat/stickersHelper.ts","webpack://tweb/./src/components/popups/schedule.ts","webpack://tweb/./src/helpers/dom/getRichValueWithCaret.ts","webpack://tweb/./src/components/chat/emojiHelper.ts","webpack://tweb/./src/components/chat/autocompletePeerHelper.ts","webpack://tweb/./src/components/chat/commandsHelper.ts","webpack://tweb/./src/components/chat/autocompleteHelperController.ts","webpack://tweb/./src/components/chat/mentionsHelper.ts","webpack://tweb/./src/components/chat/replyKeyboard.ts","webpack://tweb/./src/components/chat/inlineHelper.ts","webpack://tweb/./src/components/chat/botCommands.ts","webpack://tweb/./src/helpers/modifyAckedResult.ts","webpack://tweb/./src/components/chat/sendAs.ts","webpack://tweb/./src/components/chat/input.ts","webpack://tweb/./src/components/wrappers/draft.ts","webpack://tweb/./src/helpers/dom/setCaretAt.ts","webpack://tweb/./src/components/chat/pinnedContainer.ts","webpack://tweb/./src/components/volumeSelector.ts","webpack://tweb/./src/components/chat/audio.ts","webpack://tweb/./src/components/chat/pinnedMessageBorder.ts","webpack://tweb/./src/components/chat/pinnedMessage.ts","webpack://tweb/./src/helpers/dom/handleScrollSideEvent.ts","webpack://tweb/./src/components/popups/mute.ts","webpack://tweb/./src/helpers/audioAssetPlayer.ts","webpack://tweb/./src/components/groupCall/getAudioAsset.ts","webpack://tweb/./src/lib/calls/helpers/getAudioConstraints.ts","webpack://tweb/./src/environment/constraintSupport.ts","webpack://tweb/./src/lib/calls/helpers/getScreenConstraints.ts","webpack://tweb/./src/lib/calls/helpers/getScreenStream.ts","webpack://tweb/./src/lib/calls/helpers/getStream.ts","webpack://tweb/./src/lib/calls/helpers/getStreamCached.ts","webpack://tweb/./src/lib/calls/helpers/stopTrack.ts","webpack://tweb/./src/lib/calls/stringFromLineBuilder.ts","webpack://tweb/./src/lib/calls/utils.ts","webpack://tweb/./src/lib/calls/sdpBuilder.ts","webpack://tweb/./src/lib/calls/streamManager.ts","webpack://tweb/./src/lib/calls/constants.ts","webpack://tweb/./src/lib/calls/callInstanceBase.ts","webpack://tweb/./src/lib/calls/helpers/getVideoConstraints.ts","webpack://tweb/./src/lib/calls/localConferenceDescription.ts","webpack://tweb/./src/lib/calls/callConnectionInstanceBase.ts","webpack://tweb/./src/lib/calls/helpers/createPeerConnection.ts","webpack://tweb/./src/lib/calls/helpers/createDataChannel.ts","webpack://tweb/./src/lib/calls/sdp/index.ts","webpack://tweb/./src/helpers/string/splitStringByLimitWithRest.ts","webpack://tweb/./src/helpers/uniqueNumberGenerator.ts","webpack://tweb/./src/lib/calls/sdp/attributeSplitted.ts","webpack://tweb/./src/lib/calls/sdp/mediaLineParts.ts","webpack://tweb/./src/lib/calls/sdp/line.ts","webpack://tweb/./src/lib/calls/sdp/attributeInner.ts","webpack://tweb/./src/lib/calls/sdp/attributes.ts","webpack://tweb/./src/lib/calls/sdp/mediaSection.ts","webpack://tweb/./src/lib/calls/sdp/sessionSection.ts","webpack://tweb/./src/lib/calls/sdp/utils.ts","webpack://tweb/./src/lib/calls/helpers/parseMediaSectionInfo.ts","webpack://tweb/./src/lib/calls/helpers/parseSourceGroups.ts","webpack://tweb/./src/lib/calls/groupCallState.ts","webpack://tweb/./src/lib/calls/groupCallConnectionInstance.ts","webpack://tweb/./src/lib/calls/helpers/processMediaSection.ts","webpack://tweb/./src/lib/calls/helpers/filterServerCodecs.ts","webpack://tweb/./src/lib/calls/helpers/fixLocalOffer.ts","webpack://tweb/./src/lib/calls/groupCallInstance.ts","webpack://tweb/./src/lib/calls/groupCallsController.ts","webpack://tweb/./src/lib/calls/helpers/createMainStreamManager.ts","webpack://tweb/./src/components/chat/topbar.ts","webpack://tweb/./src/components/sidebarRight/tabs/search.ts","webpack://tweb/./src/components/chat/search.ts","webpack://tweb/./src/components/chat/patternRenderer.ts","webpack://tweb/./src/components/chat/chat.ts","webpack://tweb/./src/helpers/autoDownload.ts","webpack://tweb/./src/components/chat/markupTooltip.ts","webpack://tweb/./src/helpers/dom/getSelectedNodes.ts","webpack://tweb/./src/helpers/generatePathData.ts","webpack://tweb/./src/components/chat/dragAndDrop.ts","webpack://tweb/./src/helpers/dom/disableTransition.ts","webpack://tweb/./src/components/lineBlobDrawable.ts","webpack://tweb/./src/components/topbarWeave.ts","webpack://tweb/./src/helpers/dom/customProperties.ts","webpack://tweb/./src/lib/rlottie/rlottieIcon.ts","webpack://tweb/./src/components/superIcon.ts","webpack://tweb/./src/components/groupCall/microphoneIcon.ts","webpack://tweb/./src/components/groupCall/participantMutedIcon.ts","webpack://tweb/./src/components/groupCall/index.ts","webpack://tweb/./src/components/groupCall/participantStatus.ts","webpack://tweb/./src/components/groupCall/participantsList.ts","webpack://tweb/./src/helpers/dom/controlsHover.ts","webpack://tweb/./src/components/call/videoCanvasBlur.ts","webpack://tweb/./src/components/groupCall/participantVideo.ts","webpack://tweb/./src/components/groupCall/participantVideos.ts","webpack://tweb/./src/components/groupCall/participants.ts","webpack://tweb/./src/components/groupCall/description.ts","webpack://tweb/./src/components/groupCall/title.ts","webpack://tweb/./src/components/call/button.ts","webpack://tweb/./src/components/movableElement.ts","webpack://tweb/./src/helpers/movablePanel.ts","webpack://tweb/./src/helpers/toggleClassName.ts","webpack://tweb/./src/lib/calls/callState.ts","webpack://tweb/./src/components/call/description.ts","webpack://tweb/./src/components/groupCall/microphoneIconMini.ts","webpack://tweb/./src/components/call/index.ts","webpack://tweb/./src/lib/calls/helpers/parseSignalingData.ts","webpack://tweb/./src/lib/calls/callConnectionInstance.ts","webpack://tweb/./src/components/call/getAudioAsset.ts","webpack://tweb/./src/lib/calls/callsController.ts","webpack://tweb/./src/lib/crypto/subtle.ts","webpack://tweb/./src/lib/calls/p2P/p2PEncryptor.ts","webpack://tweb/./src/lib/crypto/utils/sha256.ts","webpack://tweb/./src/lib/calls/p2P/chromeP2PSdpBuilder.ts","webpack://tweb/./src/lib/calls/p2P/p2PSdpBuilder.js","webpack://tweb/./src/lib/calls/p2P/firefoxP2PSdpBuilder.js","webpack://tweb/./src/lib/calls/p2P/safariP2PSdpBuilder.js","webpack://tweb/./src/lib/calls/callInstance.ts","webpack://tweb/./src/lib/calls/p2P/getCallProtocol.ts","webpack://tweb/./src/lib/calls/p2P/getRtcConfiguration.ts","webpack://tweb/./src/components/topbarCall.ts","webpack://tweb/./src/lib/appManagers/uiNotificationsManager.ts","webpack://tweb/./src/helpers/files/getFilesFromEvent.ts","webpack://tweb/./src/lib/appManagers/appImManager.ts","webpack://tweb/./src/lib/mediaPlayer.ts","webpack://tweb/./src/components/appMediaViewerBase.ts","webpack://tweb/./src/helpers/fillPropertyValue.ts","webpack://tweb/./src/components/appMediaViewer.ts","webpack://tweb/./src/helpers/avatarListLoader.ts","webpack://tweb/./src/components/appMediaViewerAvatar.ts","webpack://tweb/./src/components/avatar.ts","webpack://tweb/./src/components/dialogsContextMenu.ts","webpack://tweb/./src/components/sendingStatus.ts","webpack://tweb/./src/components/connectionStatus.ts","webpack://tweb/./src/helpers/easing/easeInOutSine.ts","webpack://tweb/./src/helpers/canvas/roundRect.ts","webpack://tweb/./src/components/groupCallActiveIcon.ts","webpack://tweb/./src/helpers/canvas/shimmer.ts","webpack://tweb/./src/helpers/dialogsPlaceholder.ts","webpack://tweb/./src/helpers/canvas/drawCircle.ts","webpack://tweb/./src/lib/appManagers/appDialogsManager.ts","webpack://tweb/./public/recorder.min.js"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport ripple from \"./ripple\";\r\n\r\nexport type ButtonOptions = Partial<{\r\n  noRipple: true, \r\n  onlyMobile: true, \r\n  icon: string, \r\n  rippleSquare: true, \r\n  text: LangPackKey, \r\n  disabled: boolean,\r\n  asDiv: boolean\r\n}>;\r\n\r\nconst Button = (className: string, options: ButtonOptions = {}) => {\r\n  const button: HTMLButtonElement = document.createElement(options.asDiv ? 'div' : 'button') as any;\r\n  button.className = className + (options.icon ? ' tgico-' + options.icon : '');\r\n\r\n  if(!options.noRipple) {\r\n    if(options.rippleSquare) {\r\n      button.classList.add('rp-square');\r\n    }\r\n\r\n    ripple(button);\r\n  }\r\n\r\n  if(options.onlyMobile) {\r\n    button.classList.add('only-handhelds');\r\n  }\r\n\r\n  if(options.disabled) {\r\n    button.setAttribute('disabled', 'true');\r\n  }\r\n\r\n  if(options.text) {\r\n    button.append(i18n(options.text));\r\n  }\r\n\r\n  return button;\r\n};\r\n\r\nexport default Button;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField, { InputFieldOptions } from \"./inputField\";\r\n\r\nexport default class CodeInputField extends InputField {\r\n  constructor(options: InputFieldOptions & {\r\n    length: number,\r\n    onFill: (code: string) => void\r\n  }) {\r\n    super({\r\n      plainText: true,\r\n      ...options\r\n    });\r\n\r\n    const input = this.input as HTMLInputElement;\r\n    input.type = 'tel';\r\n    input.setAttribute('required', '');\r\n    input.autocomplete = 'off';\r\n\r\n    let lastLength = 0;\r\n    this.input.addEventListener('input', (e) => {\r\n      this.input.classList.remove('error');\r\n      this.setLabel();\r\n  \r\n      const value = this.value.replace(/\\D/g, '').slice(0, options.length);\r\n      this.setValueSilently(value);\r\n  \r\n      const length = this.value.length;\r\n      if(length === options.length) { // submit code\r\n        options.onFill(this.value);\r\n      } else if(length === lastLength) {\r\n        return;\r\n      }\r\n  \r\n      lastLength = length;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport lottieLoader, { LottieLoader } from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport PasswordInputField from \"../passwordInputField\";\r\n\r\nexport default class PasswordMonkey {\r\n  public container: HTMLElement;\r\n  public animation: RLottiePlayer;\r\n  public needFrame = 0;\r\n  protected loadPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  constructor(protected passwordInputField: PasswordInputField, protected size: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('media-sticker-wrapper');\r\n  }\r\n\r\n  public load() {\r\n    if(this.loadPromise) return this.loadPromise;\r\n    return this.loadPromise = lottieLoader.loadAnimationAsAsset({\r\n      container: this.container,\r\n      loop: false,\r\n      autoplay: false,\r\n      width: this.size,\r\n      height: this.size,\r\n      noCache: true\r\n    //}, 'assets/img/TwoFactorSetupMonkeyClose.tgs').then((_animation) => {\r\n    }, 'TwoFactorSetupMonkeyPeek').then((_animation) => {\r\n      //return;\r\n      this.animation = _animation;\r\n      this.animation.addEventListener('enterFrame', currentFrame => {\r\n        //console.log('enterFrame', currentFrame, this.needFrame);\r\n\r\n        if((this.animation.direction === 1 && currentFrame >= this.needFrame) ||\r\n          (this.animation.direction === -1 && currentFrame <= this.needFrame)) {\r\n            this.animation.setSpeed(1);\r\n            this.animation.pause();\r\n        } \r\n      });\r\n\r\n      this.passwordInputField.onVisibilityClickAdditional = () => {\r\n        if(this.passwordInputField.passwordVisible) {\r\n          this.animation.setDirection(1);\r\n          this.animation.curFrame = 0;\r\n          this.needFrame = 16;\r\n          this.animation.play();\r\n        } else {\r\n          this.animation.setDirection(-1);\r\n          this.animation.curFrame = 16;\r\n          this.needFrame = 0;\r\n          this.animation.play();\r\n        }\r\n      };\r\n\r\n      return lottieLoader.waitForFirstFrame(_animation);\r\n    });\r\n  }\r\n\r\n  public remove() {\r\n    if(this.animation) {\r\n      this.animation.remove();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../inputField\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\n\r\nexport default class TrackingMonkey {\r\n  public container: HTMLElement;\r\n\r\n  protected max = 45;\r\n  protected needFrame = 0;\r\n\r\n  protected animation: RLottiePlayer;\r\n  protected idleAnimation: RLottiePlayer;\r\n\r\n  protected loadPromise: Promise<any>;\r\n\r\n  constructor(protected inputField: InputField, protected size: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('media-sticker-wrapper');\r\n\r\n    const input = inputField.input;\r\n\r\n    input.addEventListener('blur', () => {\r\n      this.playAnimation(0);\r\n    });\r\n\r\n    input.addEventListener('input', (e) => {\r\n      this.playAnimation(inputField.value.length);\r\n    });\r\n\r\n    /* codeInput.addEventListener('focus', () => {\r\n      playAnimation(Math.max(codeInput.value.length, 1));\r\n    }); */\r\n  }\r\n\r\n  // 1st symbol = frame 15\r\n  // end symbol = frame 165\r\n  public playAnimation(length: number) {\r\n    if(!this.animation) return;\r\n\r\n    length = Math.min(length, 30);\r\n    let frame: number;\r\n    if(length) {\r\n      frame = Math.round(Math.min(this.max, length) * (165 / this.max) + 11.33);\r\n\r\n      if(this.idleAnimation) {\r\n        this.idleAnimation.stop(true);\r\n        this.idleAnimation.canvas.style.display = 'none';\r\n      }\r\n      \r\n      this.animation.canvas.style.display = '';\r\n    } else {\r\n      /* const cb = (frameNo: number) => {\r\n        if(frameNo <= 1) { */\r\n          /* idleAnimation.play();\r\n          idleAnimation.canvas.style.display = '';\r\n          animation.canvas.style.display = 'none'; */\r\n      /*     animation.removeListener('enterFrame', cb);\r\n        }\r\n      };\r\n      animation.addListener('enterFrame', cb); */\r\n      \r\n      frame = 0;\r\n    }\r\n    //animation.playSegments([1, 2]);\r\n\r\n    const direction = this.needFrame > frame ? -1 : 1;\r\n    //console.log('keydown', length, frame, direction);\r\n\r\n    this.animation.setDirection(direction);\r\n    if(this.needFrame !== 0 && frame === 0) {\r\n      this.animation.setSpeed(7);\r\n    }\r\n    /* let diff = Math.abs(needFrame - frame * direction);\r\n    if((diff / 20) > 1) animation.setSpeed(diff / 20 | 0); */\r\n    this.needFrame = frame;\r\n    \r\n    this.animation.play();\r\n\r\n    /* animation.goToAndStop(15, true); */\r\n    //animation.goToAndStop(length / max * );\r\n  }\r\n\r\n  public load() {\r\n    if(this.loadPromise) return this.loadPromise;\r\n    return this.loadPromise = Promise.all([\r\n      lottieLoader.loadAnimationAsAsset({\r\n        container: this.container,\r\n        loop: true,\r\n        autoplay: true,\r\n        width: this.size,\r\n        height: this.size\r\n      }, 'TwoFactorSetupMonkeyIdle').then((animation) => {\r\n        this.idleAnimation = animation;\r\n\r\n        // ! animationIntersector will stop animation instantly\r\n        if(!this.inputField.value.length) {\r\n          animation.play();\r\n        }\r\n\r\n        return lottieLoader.waitForFirstFrame(animation);\r\n      }),\r\n\r\n      lottieLoader.loadAnimationAsAsset({\r\n        container: this.container,\r\n        loop: false,\r\n        autoplay: false,\r\n        width: this.size,\r\n        height: this.size\r\n      }, 'TwoFactorSetupMonkeyTracking').then((_animation) => {\r\n        this.animation = _animation;\r\n\r\n        if(!this.inputField.value.length) {\r\n          this.animation.canvas.style.display = 'none';\r\n        }\r\n\r\n        this.animation.addEventListener('enterFrame', currentFrame => {\r\n          //console.log('enterFrame', currentFrame, needFrame);\r\n          //let currentFrame = Math.round(e.currentTime);\r\n          \r\n          if((this.animation.direction === 1 && currentFrame >= this.needFrame) ||\r\n            (this.animation.direction === -1 && currentFrame <= this.needFrame)) {\r\n            this.animation.setSpeed(1);\r\n            this.animation.pause();\r\n          }\r\n\r\n          if(currentFrame === 0 && this.needFrame === 0) {\r\n            //animation.curFrame = 0;\r\n            \r\n            if(this.idleAnimation) {\r\n              this.idleAnimation.canvas.style.display = '';\r\n              this.idleAnimation.play();\r\n              this.animation.canvas.style.display = 'none';\r\n            }\r\n          }\r\n        });\r\n        //console.log(animation.getDuration(), animation.getDuration(true));\r\n\r\n        return lottieLoader.waitForFirstFrame(_animation);\r\n      })\r\n    ]);\r\n  }\r\n\r\n  public remove() {\r\n    if(this.animation) this.animation.remove();\r\n    if(this.idleAnimation) this.idleAnimation.remove();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { IS_MOBILE_SAFARI, IS_SAFARI } from \"../environment/userAgent\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport InputField, { InputFieldOptions } from \"./inputField\";\r\n\r\nexport default class PasswordInputField extends InputField {\r\n  public passwordVisible = false;\r\n  public toggleVisible: HTMLElement;\r\n  public onVisibilityClickAdditional: () => void;\r\n\r\n  constructor(options: InputFieldOptions = {}) {\r\n    super({\r\n      plainText: true,\r\n      ...options\r\n    });\r\n\r\n    const input = this.input as HTMLInputElement;\r\n    input.type = 'password';\r\n    input.setAttribute('required', '');\r\n    input.name = 'notsearch_password';\r\n    input.autocomplete = 'off';\r\n\r\n    /* if(IS_SAFARI && !IS_MOBILE_SAFARI) {\r\n      input.setAttribute('readonly', '');\r\n      input.addEventListener('focus', () => {\r\n        input.removeAttribute('readonly');\r\n      }, {once: true});\r\n    } */\r\n\r\n    // * https://stackoverflow.com/a/35949954/6758968\r\n    const stealthy = document.createElement('input');\r\n    stealthy.classList.add('stealthy');\r\n    stealthy.tabIndex = -1;\r\n    stealthy.type = 'password';\r\n    input.parentElement.prepend(stealthy);\r\n    input.parentElement.insertBefore(stealthy.cloneNode(), input.nextSibling);\r\n\r\n    const toggleVisible = this.toggleVisible = document.createElement('span');\r\n    toggleVisible.classList.add('toggle-visible', 'tgico');\r\n\r\n    this.container.classList.add('input-field-password');\r\n    this.container.append(toggleVisible);\r\n\r\n    toggleVisible.addEventListener('click', this.onVisibilityClick);\r\n    toggleVisible.addEventListener('touchend', this.onVisibilityClick);\r\n  }\r\n\r\n  public onVisibilityClick = (e: Event) => {\r\n    cancelEvent(e);\r\n    this.passwordVisible = !this.passwordVisible;\r\n\r\n    this.toggleVisible.classList.toggle('eye-hidden', this.passwordVisible);\r\n    (this.input as HTMLInputElement).type = this.passwordVisible ? 'text' : 'password';\r\n    this.onVisibilityClickAdditional && this.onVisibilityClickAdditional();\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\nexport function putPreloader(elem: Element, returnDiv = false): HTMLElement {\r\n  const html = `\r\n  <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"25 25 50 50\">\r\n  <circle class=\"preloader-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n  </svg>`;\r\n\r\n  if(returnDiv) {\r\n    const div = document.createElement('div');\r\n    div.classList.add('preloader');\r\n    div.innerHTML = html;\r\n\r\n    if(elem) {\r\n      elem.appendChild(div);\r\n    }\r\n\r\n    return div;\r\n  }\r\n  \r\n  elem.insertAdjacentHTML('beforeend', html);\r\n  return elem.lastElementChild as HTMLElement;\r\n}\r\n\r\nMOUNT_CLASS_TO.putPreloader = putPreloader;\r\n\r\nexport function setButtonLoader(elem: HTMLButtonElement, icon = 'check') {\r\n  elem.classList.remove('tgico-' + icon);\r\n  elem.disabled = true;\r\n  putPreloader(elem);\r\n\r\n  return () => {\r\n    elem.innerHTML = '';\r\n    elem.classList.add('tgico-' + icon);\r\n    elem.removeAttribute('disabled');\r\n  };\r\n}\r\n\r\n/* export function parseMenuButtonsTo(to: {[name: string]: HTMLElement}, elements: HTMLCollection | NodeListOf<HTMLElement>) {\r\n  Array.from(elements).forEach((el) => {\r\n    const match = el.className.match(/(?:^|\\s)menu-(.+?)(?:$|\\s)/);\r\n    if(!match) return;\r\n    to[match[1]] = el as HTMLElement;\r\n  });\r\n} */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport sequentialDom from \"../helpers/sequentialDom\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport findUpAsChild from \"../helpers/dom/findUpAsChild\";\r\n\r\nlet rippleClickId = 0;\r\nexport default function ripple(\r\n  elem: HTMLElement, \r\n  callback: (id: number) => Promise<boolean | void> = () => Promise.resolve(), \r\n  onEnd: (id: number) => void = null, \r\n  prepend = false,\r\n  attachListenerTo = elem\r\n) {\r\n  //return;\r\n  if(elem.querySelector('.c-ripple')) return;\r\n  elem.classList.add('rp');\r\n  \r\n  let r = document.createElement('div');\r\n  r.classList.add('c-ripple');\r\n\r\n  const isSquare = elem.classList.contains('rp-square');\r\n  if(isSquare) {\r\n    r.classList.add('is-square');\r\n  }\r\n\r\n  elem[prepend ? 'prepend' : 'append'](r);\r\n\r\n  let handler: () => void;\r\n  //let animationEndPromise: Promise<number>;\r\n  const drawRipple = (clientX: number, clientY: number) => {\r\n    const startTime = Date.now();\r\n    const elem = document.createElement('div');\r\n\r\n    const clickId = rippleClickId++;\r\n    \r\n    //console.log('ripple drawRipple');\r\n    \r\n    const duration = +window.getComputedStyle(r).getPropertyValue('--ripple-duration').replace('s', '') * 1000;\r\n    //console.log('ripple duration', duration);\r\n\r\n    handler = () => {\r\n    //handler = () => animationEndPromise.then((duration) => {\r\n      //console.log('ripple animation was:', duration);\r\n\r\n      //const duration = isSquare || mediaSizes.isMobile ? 200 : 700;\r\n      //return;\r\n      let elapsedTime = Date.now() - startTime;\r\n      const cb = () => {\r\n        //console.log('ripple elapsedTime total pre-remove:', Date.now() - startTime);\r\n        sequentialDom.mutate(() => {\r\n          elem.remove();\r\n        });\r\n        \r\n        if(onEnd) onEnd(clickId);\r\n      };\r\n      if(elapsedTime < duration) {\r\n        let delay = Math.max(duration - elapsedTime, duration / 2);\r\n        setTimeout(() => elem.classList.add('hiding'), Math.max(delay - duration / 2, 0));\r\n\r\n        setTimeout(cb, delay);\r\n      } else {\r\n        elem.classList.add('hiding');\r\n        setTimeout(cb, duration / 2);\r\n      }\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        window.removeEventListener('contextmenu', handler);\r\n      }\r\n\r\n      handler = null;\r\n      touchStartFired = false;\r\n    };\r\n    //});\r\n\r\n    callback && callback(clickId);\r\n\r\n    /* callback().then((bad) => {\r\n      if(bad) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n      \r\n      //console.log('ripple after promise', Date.now() - startTime);\r\n      //console.log('ripple tooSlow:', tooSlow);\r\n      /* if(tooSlow) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n\r\n      window.requestAnimationFrame(() => {\r\n        const rect = r.getBoundingClientRect();\r\n        elem.classList.add('c-ripple__circle');\r\n\r\n        const clickX = clientX - rect.left;\r\n        const clickY = clientY - rect.top;\r\n\r\n        const radius = Math.sqrt((Math.abs(clickY - rect.height / 2) + rect.height / 2) ** 2 + (Math.abs(clickX - rect.width / 2) + rect.width / 2) ** 2);\r\n        const size = radius;\r\n\r\n        // center of circle\r\n        const x = clickX - size / 2;\r\n        const y = clickY - size / 2;\r\n\r\n        //console.log('ripple click', offsetFromCenter, size, clickX, clickY);\r\n\r\n        elem.style.width = elem.style.height = size + 'px';\r\n        elem.style.left = x + 'px';\r\n        elem.style.top = y + 'px';\r\n\r\n        // нижний код выполняется с задержкой\r\n        /* animationEndPromise = new Promise((resolve) => {\r\n          span.addEventListener('animationend', () => {\r\n            // 713 -> 700\r\n            resolve(((Date.now() - startTime) / 100 | 0) * 100);\r\n          }, {once: true});\r\n        }); */\r\n        \r\n        // нижний код не всегда включает анимацию ПРИ КЛИКЕ НА ТАЧПАД БЕЗ ТАПТИК ЭНЖИНА\r\n        /* span.style.display = 'none';\r\n        r.append(span);\r\n        duration = +window.getComputedStyle(span).getPropertyValue('animation-duration').replace('s', '') * 1000;\r\n        span.style.display = ''; */\r\n\r\n        r.append(elem);\r\n\r\n        //r.classList.add('active');\r\n        //handler();\r\n      });\r\n    //});\r\n  };\r\n\r\n  const isRippleUnneeded = (e: Event) => e.target !== elem && (\r\n      ['BUTTON', 'A'].includes((e.target as HTMLElement).tagName) \r\n      || findUpClassName(e.target as HTMLElement, 'c-ripple') !== r\r\n    ) && (\r\n      attachListenerTo === elem \r\n      || !findUpAsChild(e.target, attachListenerTo)\r\n    );\r\n\r\n  // TODO: rename this variable\r\n  let touchStartFired = false;\r\n  if(IS_TOUCH_SUPPORTED) {\r\n    let touchEnd = () => {\r\n      handler && handler();\r\n    };\r\n  \r\n    attachListenerTo.addEventListener('touchstart', (e) => {\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n\r\n      //console.log('ripple touchstart', e);\r\n      if(e.touches.length > 1 || touchStartFired || isRippleUnneeded(e)) {\r\n        return;\r\n      }\r\n      \r\n      //console.log('touchstart', e);\r\n      touchStartFired = true;\r\n  \r\n      let {clientX, clientY} = e.touches[0];\r\n      drawRipple(clientX, clientY);\r\n      attachListenerTo.addEventListener('touchend', touchEnd, {once: true});\r\n  \r\n      window.addEventListener('touchmove', (e) => {\r\n        e.cancelBubble = true;\r\n        e.stopPropagation();\r\n        touchEnd();\r\n        attachListenerTo.removeEventListener('touchend', touchEnd);\r\n      }, {once: true});\r\n    }, {passive: true});\r\n  } else {\r\n    attachListenerTo.addEventListener('mousedown', (e) => {\r\n      if(![0, 2].includes(e.button)) { // only left and right buttons\r\n        return;\r\n      }\r\n\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n      //console.log('ripple mousedown', e, e.target, findUpClassName(e.target as HTMLElement, 'c-ripple') === r);\r\n\r\n      if(attachListenerTo.dataset.ripple === '0' || isRippleUnneeded(e)) {\r\n        return;\r\n      } else if(touchStartFired) {\r\n        touchStartFired = false;\r\n        return;\r\n      }\r\n  \r\n      let {clientX, clientY} = e;\r\n      drawRipple(clientX, clientY);\r\n      window.addEventListener('mouseup', handler, {once: true, passive: true});\r\n      window.addEventListener('contextmenu', handler, {once: true, passive: true});\r\n    }, {passive: true});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport LatinizeMap from \"../config/latinizeMap\";\r\n\r\nexport const badCharsRe = /[`~!@#$%^&*()\\-_=+\\[\\]\\\\|{}'\";:\\/?.>,<]+/g;\r\nconst trimRe = /^\\s+|\\s$/g;\r\n\r\nconst C2L: {[k: string]: string} = {\r\n  й: 'q',\r\n  ц: 'w',\r\n  у: 'e',\r\n  к: 'r',\r\n  е: 't',\r\n  н: 'y',\r\n  г: 'u',\r\n  ш: 'i',\r\n  щ: 'o',\r\n  з: 'p',\r\n  х: '[',\r\n  ъ: ']',\r\n  ф: 'a',\r\n  ы: 's',\r\n  в: 'd',\r\n  а: 'f',\r\n  п: 'g',\r\n  р: 'h',\r\n  о: 'j',\r\n  л: 'k',\r\n  д: 'l',\r\n  ж: ';',\r\n  э: '\\'',\r\n  я: 'z',\r\n  ч: 'x',\r\n  с: 'c',\r\n  м: 'v',\r\n  и: 'b',\r\n  т: 'n',\r\n  ь: 'm',\r\n  б: ',',\r\n  ю: '.',\r\n  '.': '/'\r\n};\r\n\r\nexport function clearBadCharsAndTrim(text: string) {\r\n  return text.replace(badCharsRe, '').replace(trimRe, '');\r\n}\r\n\r\nexport function fixCyrillic(text: string) {\r\n  return text.toLowerCase().replace(/[\\wа-я]/g, (ch) => {\r\n    const latinizeCh = C2L[ch];\r\n    return latinizeCh ?? ch;\r\n  });\r\n}\r\n\r\nexport function latinizeString(text: string) {\r\n  return text.replace(/[^A-Za-z0-9]/g, (ch) => {\r\n    const latinizeCh = LatinizeMap[ch];\r\n    return latinizeCh ?? ch;\r\n  });\r\n}\r\n\r\nexport default function cleanSearchText(text: string, latinize = true) {\r\n  return processSearchText(text, {\r\n    clearBadChars: true,\r\n    latinize,\r\n    ignoreCase: true\r\n  });\r\n}\r\n\r\nexport type ProcessSearchTextOptions = Partial<{\r\n  clearBadChars: boolean,\r\n  latinize: boolean,\r\n  ignoreCase: boolean,\r\n  includeTag: boolean\r\n}>;\r\n\r\nexport function processSearchText(text: string, options: ProcessSearchTextOptions = {}) {\r\n  const hasTag = options.includeTag && text.charAt(0) === '%';\r\n  const originalText = text;\r\n  if(options.clearBadChars) text = clearBadCharsAndTrim(text);\r\n  if(options.latinize) text = latinizeString(text);\r\n  if(options.ignoreCase) text = text.toLowerCase();\r\n  if(hasTag) text = '%' + text;\r\n  if(options.latinize) text += '\\x01' + fixCyrillic(originalText);\r\n  return text;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ListenerSetter from \"../listenerSetter\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport simulateEvent from \"./dispatchEvent\";\r\n\r\nexport const CLICK_EVENT_NAME: 'mousedown' /* | 'touchend' */ | 'click' = (IS_TOUCH_SUPPORTED ? 'mousedown' : 'click') as any;\r\nexport type AttachClickOptions = AddEventListenerOptions & Partial<{listenerSetter: ListenerSetter, touchMouseDown: true}>;\r\nexport function attachClickEvent(elem: HTMLElement | Window, callback: (e: /* TouchEvent |  */MouseEvent) => void, options: AttachClickOptions = {}) {\r\n  const add = options.listenerSetter ? options.listenerSetter.add(elem) : elem.addEventListener.bind(elem);\r\n  // const remove = options.listenerSetter ? options.listenerSetter.removeManual.bind(options.listenerSetter, elem) : elem.removeEventListener.bind(elem);\r\n\r\n  options.touchMouseDown = true;\r\n  /* if(options.touchMouseDown && CLICK_EVENT_NAME === 'touchend') {\r\n    add('mousedown', callback, options);\r\n  } else if(CLICK_EVENT_NAME === 'touchend') {\r\n    const o = {...options, once: true};\r\n\r\n    const onTouchStart = (e: TouchEvent) => {\r\n      const onTouchMove = (e: TouchEvent) => {\r\n        remove('touchmove', onTouchMove, o);\r\n        remove('touchend', onTouchEnd, o);\r\n      };\r\n  \r\n      const onTouchEnd = (e: TouchEvent) => {\r\n        remove('touchmove', onTouchMove, o);\r\n        callback(e);\r\n        if(options.once) {\r\n          remove('touchstart', onTouchStart);\r\n        }\r\n      };\r\n  \r\n      add('touchend', onTouchEnd, o);\r\n      add('touchmove', onTouchMove, o);\r\n    };\r\n\r\n    add('touchstart', onTouchStart);\r\n  } else {\r\n    add(CLICK_EVENT_NAME, callback, options);\r\n  } */\r\n  add(CLICK_EVENT_NAME, callback, options);\r\n}\r\n\r\nexport function detachClickEvent(elem: HTMLElement, callback: (e: /* TouchEvent |  */MouseEvent) => void, options?: AddEventListenerOptions) {\r\n  // if(CLICK_EVENT_NAME === 'touchend') {\r\n  //   elem.removeEventListener('touchstart', callback, options);\r\n  // } else {\r\n    elem.removeEventListener(CLICK_EVENT_NAME, callback, options);\r\n  // }\r\n}\r\n\r\nexport function simulateClickEvent(elem: HTMLElement) {\r\n  simulateEvent(elem, CLICK_EVENT_NAME);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function htmlToSpan(html: string | DocumentFragment) {\r\n  const span = document.createElement('span');\r\n  if(typeof(html) === 'string') span.innerHTML = html;\r\n  else span.append(html);\r\n  return span;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { fastRaf } from \"./schedulers\";\r\nimport deferredPromise, { CancellablePromise } from \"./cancellablePromise\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport isInDOM from \"./dom/isInDOM\";\r\n\r\nclass SequentialDom {\r\n  private promises: Partial<{\r\n    read: CancellablePromise<void>,\r\n    write: CancellablePromise<void>\r\n  }> = {};\r\n  private raf = fastRaf.bind(null);\r\n  private scheduled = false;\r\n\r\n  private do(kind: keyof SequentialDom['promises'], callback?: VoidFunction) {\r\n    let promise = this.promises[kind];\r\n    if(!promise) {\r\n      this.scheduleFlush();\r\n      promise = this.promises[kind] = deferredPromise<void>();\r\n    }\r\n\r\n    if(callback !== undefined) {\r\n      promise.then(() => callback());\r\n    }\r\n    \r\n    return promise;\r\n  }\r\n\r\n  public measure(callback?: VoidFunction) {\r\n    return this.do('read', callback);\r\n  }\r\n\r\n  public mutate(callback?: VoidFunction) {\r\n    return this.do('write', callback);\r\n  }\r\n\r\n  /**\r\n   * Will fire instantly if element is not connected\r\n   * @param element \r\n   * @param callback \r\n   */\r\n  public mutateElement(element: HTMLElement, callback?: VoidFunction) {\r\n    const isConnected = isInDOM(element);\r\n    const promise = isConnected ? this.mutate() : Promise.resolve();\r\n\r\n    if(callback !== undefined) {\r\n      if(isConnected) {\r\n        callback();\r\n      } else {\r\n        promise.then(() => callback());\r\n      }\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private scheduleFlush() {\r\n    if(!this.scheduled) {\r\n      this.scheduled = true;\r\n\r\n      this.raf(() => {\r\n        this.promises.read && this.promises.read.resolve();\r\n        this.promises.write && this.promises.write.resolve();\r\n\r\n        this.scheduled = false;\r\n        this.promises = {};\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nconst sequentialDom = new SequentialDom();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.sequentialDom = sequentialDom);\r\nexport default sequentialDom;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../lib/appManagers/appDialogsManager\";\r\nimport Scrollable from \"./scrollable\";\r\nimport InputSearch from \"./inputSearch\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport class SearchGroup {\r\n  container: HTMLDivElement;\r\n  nameEl: HTMLDivElement;\r\n  list: HTMLUListElement;\r\n\r\n  constructor(\r\n    public name: LangPackKey | boolean, \r\n    public type: string, \r\n    private clearable = true, \r\n    className?: string, \r\n    clickable = true, \r\n    public autonomous = true, \r\n    public onFound?: () => void\r\n  ) {\r\n    this.list = appDialogsManager.createChatList();\r\n    this.container = document.createElement('div');\r\n    if(className) this.container.className = className;\r\n    \r\n    if(name) {\r\n      this.nameEl = document.createElement('div');\r\n      this.nameEl.classList.add('search-group__name');\r\n      if(typeof(name) === 'string') {\r\n        this.nameEl.append(i18n(name));\r\n      }\r\n      this.container.append(this.nameEl);\r\n    }\r\n    \r\n    this.container.classList.add('search-group', 'search-group-' + type);\r\n    this.container.append(this.list);\r\n    this.container.style.display = 'none';\r\n\r\n    if(clickable) {\r\n      appDialogsManager.setListClickListener(this.list, onFound, undefined, autonomous);\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    this.container.style.display = 'none';\r\n\r\n    if(this.clearable) {\r\n      this.list.innerHTML = '';\r\n    }\r\n  }\r\n\r\n  setActive() {\r\n    this.container.style.display = '';\r\n  }\r\n\r\n  toggle() {\r\n    if(this.list.childElementCount) {\r\n      this.setActive();\r\n    } else {\r\n      this.clear();\r\n    }\r\n  }\r\n}\r\n\r\nexport type SearchGroupType = 'contacts' | 'globalContacts' | 'messages' | string;\r\n\r\nexport default class AppSearch {\r\n  private minMsgId = 0;\r\n  private loadedCount = -1;\r\n  private foundCount = -1;\r\n\r\n  private searchPromise: Promise<void> = null;\r\n  private searchTimeout: number = 0;\r\n\r\n  private query = '';\r\n\r\n  private listsContainer: HTMLDivElement = null;\r\n\r\n  private peerId: PeerId; // 0 - means global\r\n  private threadId = 0;\r\n\r\n  private scrollable: Scrollable;\r\n\r\n  constructor(public container: HTMLElement, public searchInput: InputSearch, public searchGroups: {[group in SearchGroupType]: SearchGroup}, public onSearch?: (count: number) => void) {\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.listsContainer = this.scrollable.container as HTMLDivElement;\r\n    for(let i in this.searchGroups) {\r\n      this.listsContainer.append(this.searchGroups[i as SearchGroupType].container);\r\n    }\r\n\r\n    if(this.searchGroups.messages) {\r\n      this.scrollable.setVirtualContainer(this.searchGroups.messages.list);\r\n    }\r\n\r\n    this.searchInput.onChange = (value) => {\r\n      /* if(!value.trim()) {\r\n        //this.peerId = 0;\r\n        return;\r\n      } */\r\n      \r\n      this.query = value;\r\n      this.reset(false);\r\n      this.searchMore();\r\n    };\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(!this.query.trim()) return;\r\n    \r\n      if(!this.searchTimeout) {\r\n        this.searchTimeout = window.setTimeout(() => {\r\n          this.searchMore();\r\n          this.searchTimeout = 0;\r\n        }, 0);\r\n      }\r\n    };\r\n  }\r\n\r\n  public reset(all = true) {\r\n    if(all) {\r\n      this.searchInput.value = '';\r\n      this.query = '';\r\n      this.peerId = undefined;\r\n      this.threadId = 0;\r\n    }\r\n\r\n    this.minMsgId = 0;\r\n    this.loadedCount = -1;\r\n    this.foundCount = -1;\r\n\r\n    for(let i in this.searchGroups) {\r\n      this.searchGroups[i as SearchGroupType].clear();\r\n    }\r\n    \r\n    this.searchPromise = null;\r\n  }\r\n\r\n  public beginSearch(peerId?: PeerId, threadId = 0, query = '') {\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n\r\n    if(this.query !== query) {\r\n      this.searchInput.inputField.value = query;\r\n    }\r\n\r\n    this.searchInput.input.focus();\r\n  }\r\n\r\n  public searchMore() {\r\n    if(this.searchPromise) return this.searchPromise;\r\n    \r\n    const query = this.query;\r\n    \r\n    if(!query.trim()) {\r\n      this.onSearch && this.onSearch(0);\r\n      return;\r\n    }\r\n    \r\n    if(this.foundCount !== -1 && this.loadedCount >= this.foundCount) {\r\n      return Promise.resolve();\r\n    }\r\n    \r\n    const maxId = this.minMsgId || 0;\r\n\r\n    return this.searchPromise = rootScope.managers.appMessagesManager.getSearch({\r\n      peerId: this.peerId, \r\n      query, \r\n      inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n      maxId, \r\n      limit: 20,\r\n      threadId: this.threadId\r\n    }).then((res) => {\r\n      this.searchPromise = null;\r\n      \r\n      if(this.searchInput.value !== query) {\r\n        return;\r\n      }\r\n      \r\n      //console.log('input search result:', this.peerId, query, null, maxId, 20, res);\r\n      \r\n      const {count, history} = res;\r\n      \r\n      if(history.length && history[0].mid === this.minMsgId) {\r\n        history.shift();\r\n      }\r\n      \r\n      const searchGroup = this.searchGroups.messages;\r\n\r\n      history.forEach((message) => {\r\n        try {\r\n          const peerId = this.peerId ? message.fromId : message.peerId;\r\n          appDialogsManager.addDialogAndSetLastMessage({\r\n            peerId, \r\n            container: this.scrollable/* searchGroup.list */, \r\n            avatarSize: 54,\r\n            meAsSaved: false,\r\n            message,\r\n            query\r\n          });\r\n        } catch(err) {\r\n          console.error('[appSearch] render search result', err);\r\n        }\r\n      });\r\n\r\n      searchGroup.toggle();\r\n      \r\n      this.minMsgId = history.length && history[history.length - 1].mid;\r\n      \r\n      if(this.loadedCount === -1) {\r\n        this.loadedCount = 0;\r\n      }\r\n      this.loadedCount += history.length;\r\n      \r\n      if(this.foundCount === -1) {\r\n        this.foundCount = count;\r\n\r\n        if(searchGroup.nameEl) {\r\n          replaceContent(searchGroup.nameEl, i18n(count ? 'Chat.Search.MessagesFound' : 'Chat.Search.NoMessagesFound', [count]));\r\n        }\r\n        \r\n        this.onSearch && this.onSearch(this.foundCount);\r\n      }\r\n    }).catch((err) => {\r\n      console.error('search error', err);\r\n      this.searchPromise = null;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n//import { getRichValue } from \"../helpers/dom\";\r\nimport { LangPackKey } from \"../lib/langPack\";\r\nimport InputField from \"./inputField\";\r\n\r\nexport default class InputSearch {\r\n  public container: HTMLElement;\r\n  public input: HTMLElement;\r\n  public inputField: InputField;\r\n  public clearBtn: HTMLElement;\r\n\r\n  public prevValue = '';\r\n  public timeout = 0;\r\n  public onChange: (value: string) => void;\r\n  public onClear: () => void;\r\n\r\n  constructor(placeholder: LangPackKey, onChange?: (value: string) => void) {\r\n    this.inputField = new InputField({\r\n      placeholder,\r\n      plainText: true\r\n    });\r\n\r\n    this.container = this.inputField.container;\r\n    this.container.classList.remove('input-field');\r\n    this.container.classList.add('input-search');\r\n\r\n    this.onChange = onChange;\r\n\r\n    this.input = this.inputField.input;\r\n    this.input.classList.add('input-search-input');\r\n\r\n    const searchIcon = document.createElement('i');\r\n    searchIcon.classList.add('tgico', 'tgico-search');\r\n\r\n    this.clearBtn = document.createElement('i');\r\n    this.clearBtn.classList.add('tgico', 'btn-icon', 'tgico-close');\r\n\r\n    this.input.addEventListener('input', this.onInput);\r\n    this.clearBtn.addEventListener('click', this.onClearClick);\r\n\r\n    this.container.append(searchIcon, this.clearBtn);\r\n  }\r\n  \r\n  onInput = () => {\r\n    if(!this.onChange) return;\r\n\r\n    let value = this.value;\r\n\r\n    //this.input.classList.toggle('is-empty', !value.trim());\r\n\r\n    if(value !== this.prevValue) {\r\n      this.prevValue = value;\r\n      clearTimeout(this.timeout);\r\n      this.timeout = window.setTimeout(() => {\r\n        this.onChange(value);\r\n      }, 200);\r\n    }\r\n  };\r\n\r\n  onClearClick = () => {\r\n    this.value = '';\r\n    this.onChange && this.onChange('');\r\n    this.onClear && this.onClear();\r\n  };\r\n\r\n  get value() {\r\n    return this.inputField.value;\r\n  }\r\n\r\n  set value(value: string) {\r\n    this.prevValue = value;\r\n    clearTimeout(this.timeout);\r\n    this.inputField.value = value;\r\n  }\r\n\r\n  public remove() {\r\n    clearTimeout(this.timeout);\r\n    this.input.removeEventListener('input', this.onInput);\r\n    this.clearBtn.removeEventListener('click', this.onClearClick);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Button from \"./button\";\r\n\r\nconst ButtonIcon = (className?: string, options: Partial<{noRipple: true, onlyMobile: true, asDiv: boolean}> = {}) => {\r\n  const button = Button('btn-icon', {\r\n    icon: className || undefined, \r\n    ...options\r\n  });\r\n\r\n  return button;\r\n};\r\n\r\nexport default ButtonIcon;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport Scrollable from \"./scrollable\";\r\nimport SidebarSlider from \"./slider\";\r\n\r\nexport interface SliderTab {\r\n  onOpen?: () => void,\r\n  onOpenAfterTimeout?: () => void,\r\n  onClose?: () => void,\r\n  onCloseAfterTimeout?: () => void\r\n}\r\n\r\nexport interface SliderSuperTabConstructable<T extends SliderSuperTab = any> {\r\n  new(slider: SidebarSlider, destroyable: boolean): T;\r\n}\r\n\r\nexport interface SliderSuperTabEventableConstructable {\r\n  new(slider: SidebarSlider, destroyable: boolean): SliderSuperTabEventable;\r\n}\r\n\r\nexport default class SliderSuperTab implements SliderTab {\r\n  public container: HTMLElement;\r\n\r\n  public header: HTMLElement;\r\n  public closeBtn: HTMLElement;\r\n  public title: HTMLElement;\r\n\r\n  public content: HTMLElement;\r\n  public scrollable: Scrollable;\r\n\r\n  public slider: SidebarSlider;\r\n  public destroyable: boolean;\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  public managers: AppManagers;\r\n\r\n  constructor(slider: SidebarSlider, destroyable?: boolean) {\r\n    this._constructor(slider, destroyable);\r\n  }\r\n\r\n  public _constructor(slider: SidebarSlider, destroyable = true): any {\r\n    this.slider = slider;\r\n    this.destroyable = destroyable;\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('tabs-tab', 'sidebar-slider-item');\r\n\r\n    // * Header\r\n    this.header = document.createElement('div');\r\n    this.header.classList.add('sidebar-header');\r\n\r\n    this.closeBtn = ButtonIcon('left sidebar-close-button', {noRipple: true});\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add('sidebar-header__title');\r\n    this.header.append(this.closeBtn, this.title);\r\n\r\n    // * Content\r\n    this.content = document.createElement('div');\r\n    this.content.classList.add('sidebar-content');\r\n\r\n    this.scrollable = new Scrollable(this.content, undefined, undefined, true);\r\n\r\n    this.container.append(this.header, this.content);\r\n\r\n    if(this.slider) {\r\n      this.slider.addTab(this);\r\n    }\r\n    \r\n    this.listenerSetter = new ListenerSetter();\r\n  }\r\n\r\n  public close() {\r\n    return this.slider.closeTab(this);\r\n  }\r\n\r\n  public async open(...args: any[]) {\r\n    if(this.init) {\r\n      try {\r\n        const result = this.init();\r\n        this.init = null;\r\n\r\n        if(result instanceof Promise) {\r\n          await result;\r\n        }\r\n      } catch(err) {\r\n        console.error('open tab error', err);\r\n      }\r\n    }\r\n\r\n    this.slider.selectTab(this);\r\n  }\r\n\r\n  protected init(): Promise<any> | any {\r\n\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    if(this.destroyable) { // ! WARNING, пока что это будет работать только с самой последней внутренней вкладкой !\r\n      this.slider.tabs.delete(this);\r\n      this.container.remove();\r\n    }\r\n\r\n    if(this.listenerSetter) {\r\n      this.listenerSetter.removeAll();\r\n    }\r\n  }\r\n\r\n  protected setTitle(key: LangPackKey) {\r\n    this.title.innerHTML = '';\r\n    this.title.append(i18n(key));\r\n  }\r\n}\r\n\r\nexport class SliderSuperTabEventable extends SliderSuperTab {\r\n  public eventListener: EventListenerBase<{\r\n    destroy: () => void\r\n  }>;\r\n\r\n  constructor(slider: SidebarSlider) {\r\n    super(slider);\r\n    this.eventListener = new EventListenerBase();\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    this.eventListener.dispatchEvent('destroy');\r\n    this.eventListener.cleanup();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n\r\n/* // @ts-ignore\r\ninterface SliderSuperEventsTab extends SliderSuperTab, EventListenerBase<{}> {\r\n  superConstructor: (...args: any[]) => any;\r\n}\r\nclass SliderSuperEventsTab implements SliderSuperEventsTab {\r\n  constructor(slider: SidebarSlider) {\r\n    this.superConstructor([slider, true]);\r\n  }\r\n}\r\napplyMixins(SliderSuperEventsTab, [SliderSuperTab, EventListenerBase]);\r\n\r\n(window as any).lol = SliderSuperEventsTab\r\n\r\nexport {SliderSuperEventsTab}; */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { horizontalMenu } from \"./horizontalMenu\";\r\nimport { TransitionSlider } from \"./transition\";\r\nimport appNavigationController, { NavigationItem } from \"./appNavigationController\";\r\nimport SliderSuperTab, { SliderSuperTabConstructable, SliderTab } from \"./sliderTab\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport indexOfAndSplice from \"../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\n\r\nconst TRANSITION_TIME = 250;\r\n\r\nexport type {SliderTab};\r\nexport {SliderSuperTab};\r\n\r\nexport default class SidebarSlider {\r\n  protected _selectTab: ReturnType<typeof horizontalMenu>;\r\n  public historyTabIds: (number | SliderSuperTab)[] = []; // * key is any, since right sidebar is ugly nowz\r\n  public tabsContainer: HTMLElement;\r\n  public sidebarEl: HTMLElement;\r\n  public tabs: Map<any, SliderTab>; // * key is any, since right sidebar is ugly now\r\n  private canHideFirst = false;\r\n  private navigationType: NavigationItem['type'];\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    sidebarEl: SidebarSlider['sidebarEl'],\r\n    tabs?: SidebarSlider['tabs'],\r\n    canHideFirst?: SidebarSlider['canHideFirst'],\r\n    navigationType: SidebarSlider['navigationType']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.tabs) {\r\n      this.tabs = new Map();\r\n    }\r\n\r\n    this.tabsContainer = this.sidebarEl.querySelector('.sidebar-slider');\r\n    this._selectTab = TransitionSlider(this.tabsContainer, 'navigation', TRANSITION_TIME);\r\n    if(!this.canHideFirst) {\r\n      this._selectTab(0);\r\n    }\r\n\r\n    Array.from(this.sidebarEl.querySelectorAll('.sidebar-close-button') as any as HTMLElement[]).forEach((el) => {\r\n      attachClickEvent(el, this.onCloseBtnClick);\r\n    });\r\n  }\r\n\r\n  public onCloseBtnClick = () => {\r\n    const item = appNavigationController.findItemByType(this.navigationType);\r\n    if(item) {\r\n      appNavigationController.back(this.navigationType);\r\n    } else if(this.historyTabIds.length) {\r\n      this.closeTab(this.historyTabIds[this.historyTabIds.length - 1]);\r\n    }\r\n    // this.closeTab();\r\n  };\r\n\r\n  public closeTab = (id?: number | SliderSuperTab, animate?: boolean, isNavigation?: boolean) => {\r\n    if(id !== undefined && this.historyTabIds[this.historyTabIds.length - 1] !== id) {\r\n      return false;\r\n    }\r\n\r\n    //console.log('sidebar-close-button click:', this.historyTabIDs);\r\n    const closingId = this.historyTabIds.pop(); // pop current\r\n    this.onCloseTab(closingId, animate, isNavigation);\r\n\r\n    const tab = this.historyTabIds[this.historyTabIds.length - 1];\r\n    this._selectTab(tab !== undefined ? (tab instanceof SliderSuperTab ? tab.container : tab) : (this.canHideFirst ? -1 : 0), animate);\r\n    return true;\r\n  };\r\n\r\n  public selectTab(id: number | SliderSuperTab): boolean {\r\n    /* if(id instanceof SliderSuperTab) {\r\n      id = id.id;\r\n    } */\r\n\r\n    if(this.historyTabIds[this.historyTabIds.length - 1] === id) {\r\n      return false;\r\n    }\r\n\r\n    const tab: SliderTab = id instanceof SliderSuperTab ? id : this.tabs.get(id);\r\n    if(tab) {\r\n      if(tab.onOpen) {\r\n        tab.onOpen();\r\n      }\r\n  \r\n      if(tab.onOpenAfterTimeout) {\r\n        setTimeout(() => {\r\n          tab.onOpenAfterTimeout();\r\n        }, TRANSITION_TIME);\r\n      }\r\n    }\r\n\r\n    //if(!this.canHideFirst || this.historyTabIds.length) {\r\n      appNavigationController.pushItem({\r\n        type: this.navigationType, \r\n        onPop: (canAnimate) => {\r\n          this.closeTab(undefined, canAnimate, true);\r\n          return true;\r\n        }\r\n      });\r\n    //}\r\n    \r\n    this.historyTabIds.push(id);\r\n    this._selectTab(id instanceof SliderSuperTab ? id.container : id);\r\n    return true;\r\n  }\r\n\r\n  public removeTabFromHistory(id: number | SliderSuperTab) {\r\n    indexOfAndSplice(this.historyTabIds, id);\r\n    this.onCloseTab(id, undefined);\r\n  }\r\n\r\n  public sliceTabsUntilTab(tabConstructor: SliderSuperTabConstructable, preserveTab: SliderSuperTab) {\r\n    for(let i = this.historyTabIds.length - 1; i >= 0; --i) {\r\n      const tab = this.historyTabIds[i];\r\n      if(tab === preserveTab) continue;\r\n      else if(tab instanceof tabConstructor) {\r\n        break;\r\n      }\r\n\r\n      this.removeTabFromHistory(tab);\r\n      //appNavigationController.removeByType(this.navigationType, true);\r\n    }\r\n  }\r\n\r\n  public getTab<T extends SliderSuperTab>(tabConstructor: SliderSuperTabConstructable<T>) {\r\n    return this.historyTabIds.find((t) => t instanceof tabConstructor) as T;\r\n  }\r\n\r\n  public isTabExists(tabConstructor: SliderSuperTabConstructable) {\r\n    return !!this.getTab(tabConstructor);\r\n  }\r\n\r\n  protected onCloseTab(id: number | SliderSuperTab, animate: boolean, isNavigation?: boolean) {\r\n    if(!isNavigation) {\r\n      appNavigationController.removeByType(this.navigationType, true);\r\n    }\r\n\r\n    const tab: SliderTab = id instanceof SliderSuperTab ? id : this.tabs.get(id);\r\n    if(tab) {\r\n      if(tab.onClose) {\r\n        tab.onClose();\r\n      }\r\n\r\n      if(tab.onCloseAfterTimeout) {\r\n        setTimeout(() => {\r\n          tab.onCloseAfterTimeout();\r\n        }, TRANSITION_TIME);\r\n      }\r\n    }\r\n  }\r\n\r\n  public addTab(tab: SliderSuperTab) {\r\n    if(!tab.container.parentElement) {\r\n      this.tabsContainer.append(tab.container);\r\n\r\n      if(tab.closeBtn) {\r\n        tab.closeBtn.addEventListener('click', this.onCloseBtnClick);\r\n      }\r\n    }\r\n  }\r\n\r\n  public createTab<T extends SliderSuperTab>(ctor: SliderSuperTabConstructable<T>, doNotAppend?: boolean) {\r\n    const tab = new ctor(doNotAppend ? undefined : this, true);\r\n    tab.managers = this.managers;\r\n    return tab;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport type { InputFile } from \"../layer\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport PopupElement from \"./popups\";\r\nimport PopupAvatar from \"./popups/avatar\";\r\n\r\nexport default class AvatarEdit {\r\n  public container: HTMLElement;\r\n  private canvas: HTMLCanvasElement;\r\n  private icon: HTMLSpanElement;\r\n\r\n  constructor(onChange: (uploadAvatar: () => CancellablePromise<InputFile>) => void) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('avatar-edit');\r\n\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.classList.add('avatar-edit-canvas');\r\n\r\n    this.icon = document.createElement('span');\r\n    this.icon.classList.add('tgico', 'tgico-cameraadd');\r\n\r\n    this.container.append(this.canvas, this.icon);\r\n\r\n    attachClickEvent(this.container, () => {\r\n      PopupElement.createPopup(PopupAvatar).open(this.canvas, onChange);\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    const ctx = this.canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Button from \"./button\";\r\n\r\nconst ButtonCorner = (options: Partial<{className: string, icon: string, noRipple: true, onlyMobile: true, asDiv: boolean}> = {}) => {\r\n  const button = Button('btn-circle btn-corner z-depth-1' + (options.className ? ' ' + options.className : ''), options);\r\n  return button;\r\n};\r\n\r\nexport default ButtonCorner;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport I18n, { i18n } from \"../lib/langPack\";\r\n\r\nexport const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\r\nexport const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n\r\nexport const ONE_DAY = 86400;\r\n\r\n// https://stackoverflow.com/a/6117889\r\nexport const getWeekNumber = (date: Date) => {\r\n  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\r\n  const dayNum = d.getUTCDay() || 7;\r\n  d.setUTCDate(d.getUTCDate() + 4 - dayNum);\r\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\r\n  return Math.ceil((((d.getTime() - yearStart.getTime()) / ONE_DAY) + 1) / 7);\r\n};\r\n\r\nexport function formatDateAccordingToTodayNew(time: Date) {\r\n  const today = new Date();\r\n  const now = today.getTime() / 1000 | 0;\r\n  const timestamp = time.getTime() / 1000 | 0;\r\n\r\n  const options: Intl.DateTimeFormatOptions = {};\r\n  if((now - timestamp) < ONE_DAY && today.getDate() === time.getDate()) { // if the same day\r\n    options.hour = options.minute = '2-digit';\r\n  } else if(today.getFullYear() !== time.getFullYear()) { // different year\r\n    options.year = options.day = 'numeric';\r\n    options.month = '2-digit';\r\n  } else if((now - timestamp) < (ONE_DAY * 7) && getWeekNumber(today) === getWeekNumber(time)) { // current week\r\n    options.weekday = 'short';\r\n  } else { // same year\r\n    options.month = 'short';\r\n    options.day = 'numeric';\r\n  }\r\n\r\n  return new I18n.IntlDateElement({\r\n    date: time,\r\n    options\r\n  }).element;\r\n}\r\n\r\nexport function formatFullSentTimeRaw(timestamp: number, options: {\r\n  capitalize?: boolean\r\n} = {}) {\r\n  const date = new Date();\r\n  const time = new Date(timestamp * 1000);\r\n  const now = date.getTime() / 1000;\r\n\r\n  const timeEl = formatTime(time);\r\n\r\n  let dateEl: Node | string;\r\n  if((now - timestamp) < ONE_DAY && date.getDate() === time.getDate()) { // if the same day\r\n    dateEl = i18n(options.capitalize ? 'Date.Today' : 'Peer.Status.Today');\r\n  } else if((now - timestamp) < (ONE_DAY * 2) && (date.getDate() - 1) === time.getDate()) { // yesterday\r\n    dateEl = i18n(options.capitalize ? 'Yesterday' : 'Peer.Status.Yesterday');\r\n\r\n    if(options.capitalize) {\r\n      (dateEl as HTMLElement).style.textTransform = 'capitalize';\r\n    }\r\n  } else if(date.getFullYear() !== time.getFullYear()) { // different year\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric',\r\n        year: 'numeric'\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate() + ', ' + time.getFullYear();\r\n  } else {\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric'\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate();\r\n  }\r\n\r\n  return {dateEl, timeEl};\r\n}\r\n\r\nexport function formatFullSentTime(timestamp: number) {\r\n  const {dateEl, timeEl} = formatFullSentTimeRaw(timestamp, {\r\n    capitalize: true\r\n  });\r\n\r\n  const fragment = document.createDocumentFragment();\r\n  fragment.append(dateEl, ' ', i18n('ScheduleController.at'), ' ', timeEl);\r\n  return fragment;\r\n}\r\n\r\nexport function formatTime(date: Date) {\r\n  return new I18n.IntlDateElement({\r\n    date,\r\n    options: {\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    }\r\n  }).element;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.formatDateAccordingToTodayNew = formatDateAccordingToTodayNew);\r\n\r\nexport const getFullDate = (date: Date, options: Partial<{\r\n  noTime: true, \r\n  noSeconds: true,\r\n  monthAsNumber: true,\r\n  leadingZero: true\r\n}> = {}) => {\r\n  const joiner = options.monthAsNumber ? '.' : ' ';\r\n  const time = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + (options.noSeconds ? '' : ':' + ('0' + date.getSeconds()).slice(-2));\r\n\r\n  return (options.leadingZero ? ('0' + date.getDate()).slice(-2) : date.getDate()) + \r\n    joiner + (options.monthAsNumber ? ('0' + (date.getMonth() + 1)).slice(-2) : months[date.getMonth()]) + \r\n    joiner + date.getFullYear() + \r\n    (options.noTime ? '' : ', ' + time);\r\n};\r\n\r\n// https://github.com/DrKLO/Telegram/blob/d52b2c921abd3c1e8d6368858313ad0cb0468c07/TMessagesProj/src/main/java/org/telegram/ui/Adapters/FiltersView.java\r\nconst minYear = 2013;\r\nconst yearPattern = new RegExp(\"20[0-9]{1,2}\");\r\nconst monthYearOrDayPattern = new RegExp(\"(\\\\w{3,}) ([0-9]{0,4})\", 'i');\r\nconst yearOrDayAndMonthPattern = new RegExp(\"([0-9]{0,4}) (\\\\w{2,})\", 'i');\r\nconst shortDate = new RegExp(\"^([0-9]{1,4})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst longDate = new RegExp(\"^([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst numberOfDaysEachMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\r\nexport type DateData = {\r\n  title: string,\r\n  minDate: number,\r\n  maxDate: number,\r\n};\r\nexport function fillTipDates(query: string, dates: DateData[]) {\r\n  const q = query.trim().toLowerCase();\r\n\r\n  if(q.length < 3) {\r\n    return;\r\n  }\r\n\r\n  if(\"today\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: 'Today',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  if(\"yesterday\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime() - 86400000;\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 86400001;\r\n    dates.push({\r\n      title: 'Yesterday',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  const dayOfWeek = getDayOfWeek(q);\r\n  if(dayOfWeek >= 0) {\r\n    const date = new Date();\r\n    const now = date.getTime();\r\n    const currentDay = date.getDay();\r\n    const distance = dayOfWeek - currentDay;\r\n    date.setDate(date.getDate() + distance);\r\n    if(date.getTime() > now) {\r\n      date.setTime(date.getTime() - 604800000);\r\n    }\r\n    const year = date.getFullYear()\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: formatWeekLong(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  let matches: any[];\r\n  if((matches = shortDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const k = parseInt(g1);\r\n    const k1 = parseInt(g2);\r\n    if(k > 0 && k <= 31) {\r\n      if(k1 >= minYear && k <= 12) {\r\n        const selectedYear = k1;\r\n        const month = k - 1;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      } else if (k1 <= 12) {\r\n        const day = k - 1;\r\n        const month = k1 - 1;\r\n        createForDayMonth(dates, day, month);\r\n      }\r\n    } else if (k >= minYear && k1 <= 12) {\r\n      const selectedYear = k;\r\n      const month = k1 - 1;\r\n      createForMonthYear(dates, month, selectedYear);\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = longDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const g3 = matches[5];\r\n    if(!matches[2] === matches[4]) {\r\n      return;\r\n    }\r\n\r\n    const day = parseInt(g1);\r\n    const month = parseInt(g2) - 1;\r\n    let year = parseInt(g3);\r\n    if(year >= 10 && year <= 99) {\r\n      year += 2000;\r\n    }\r\n\r\n    const currentYear = new Date().getFullYear();\r\n    if(validDateForMonth(day - 1, month) && year >= minYear && year <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(year, month, day);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      date.setFullYear(year, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: formatterYearMax(minDate),\r\n        minDate,\r\n        maxDate\r\n      });\r\n      return;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = yearPattern.exec(q)) !== null) {\r\n    let selectedYear = +q;\r\n    const currentYear = new Date().getFullYear();\r\n    if(selectedYear < minYear) {\r\n      selectedYear = minYear;\r\n      for(let i = currentYear; i >= selectedYear; i--) {\r\n        const date = new Date();\r\n        date.setFullYear(i, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const minDate = date.getTime();\r\n        date.setFullYear(i + 1, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const maxDate = date.getTime() - 1;\r\n        dates.push({\r\n          title: '' + i,\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    } else if(selectedYear <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(selectedYear, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      date.setFullYear(selectedYear + 1, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: '' + selectedYear,\r\n        minDate,\r\n        maxDate\r\n      });\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = monthYearOrDayPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g1);\r\n    if(month >= 0) {\r\n      const k = +g2;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if(k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = yearOrDayAndMonthPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g2);\r\n    if(month >= 0) {\r\n      const k = +g1;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if (k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction createForMonthYear(dates: DateData[], month: number, selectedYear: number) {\r\n  const currentYear = new Date().getFullYear();\r\n  const today = Date.now();\r\n  if(selectedYear >= minYear && selectedYear <= currentYear) {\r\n    const date = new Date();\r\n    date.setFullYear(selectedYear, month, 1);\r\n    date.setHours(0, 0, 0);\r\n    const minDate = date.getTime();\r\n    if(minDate > today) {\r\n      return;\r\n    }\r\n    date.setMonth(date.getMonth() + 1);\r\n    const maxDate = date.getTime() - 1;\r\n\r\n    dates.push({\r\n      title: formatterMonthYear(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n  }\r\n}\r\n\r\nfunction createForDayMonth(dates: DateData[], day: number, month: number) {\r\n  if(validDateForMonth(day, month)) {\r\n    const currentYear = new Date().getFullYear();\r\n    const today = Date.now();\r\n    \r\n    for(let i = currentYear; i >= minYear; i--) {\r\n      if(month === 1 && day === 28 && !isLeapYear(i)) {\r\n        continue;\r\n      }\r\n\r\n      const date = new Date();\r\n      date.setFullYear(i, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      if(minDate > today) {\r\n        continue;\r\n      }\r\n\r\n      date.setFullYear(i, month, day + 2);\r\n      date.setHours(0, 0, 0);\r\n      const maxDate = date.getTime() - 1;\r\n      if(i === currentYear) {\r\n        dates.push({\r\n          title: formatterDayMonth(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      } else {\r\n        dates.push({\r\n          title: formatterYearMax(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction formatterMonthYear(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getFullYear();\r\n}\r\n\r\nfunction formatterDayMonth(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getDate();\r\n}\r\n\r\nfunction formatterYearMax(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear();\r\n}\r\n\r\nfunction formatWeekLong(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return days[date.getDay()];\r\n}\r\n\r\nfunction validDateForMonth(day: number, month: number) {\r\n  if(month >= 0 && month < 12) {\r\n    if(day >= 0 && day < numberOfDaysEachMonth[month]) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isLeapYear(year: number) {\r\n  return ((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0);\r\n}\r\n\r\nfunction getMonth(q: string) {\r\n  /* String[] months = new String[]{\r\n          LocaleController.getString(\"January\", R.string.January).toLowerCase(),\r\n          LocaleController.getString(\"February\", R.string.February).toLowerCase(),\r\n          LocaleController.getString(\"March\", R.string.March).toLowerCase(),\r\n          LocaleController.getString(\"April\", R.string.April).toLowerCase(),\r\n          LocaleController.getString(\"May\", R.string.May).toLowerCase(),\r\n          LocaleController.getString(\"June\", R.string.June).toLowerCase(),\r\n          LocaleController.getString(\"July\", R.string.July).toLowerCase(),\r\n          LocaleController.getString(\"August\", R.string.August).toLowerCase(),\r\n          LocaleController.getString(\"September\", R.string.September).toLowerCase(),\r\n          LocaleController.getString(\"October\", R.string.October).toLowerCase(),\r\n          LocaleController.getString(\"November\", R.string.November).toLowerCase(),\r\n          LocaleController.getString(\"December\", R.string.December).toLowerCase()\r\n  }; */\r\n\r\n  /* String[] monthsEng = new String[12];\r\n  Calendar c = Calendar.getInstance();\r\n  for (int i = 1; i <= 12; i++) {\r\n      c.set(0, 0, 0, 0, 0, 0);\r\n      c.set(Calendar.MONTH, i);\r\n      monthsEng[i - 1] = c.getDisplayName(Calendar.MONTH, Calendar.LONG, Locale.ENGLISH).toLowerCase();\r\n  } */\r\n\r\n  q = q.toLowerCase();\r\n  for(let i = 0; i < 12; i++) {\r\n    const month = months[i].toLowerCase();\r\n    if(month.indexOf(q) === 0) {\r\n      return i;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nfunction getDayOfWeek(q: string) {\r\n  const c = new Date();\r\n  if(q.length <= 3) {\r\n    return -1;\r\n  }\r\n  \r\n  for(let i = 0; i < 7; i++) {\r\n    c.setDate(c.getDate() + 1);\r\n    \r\n    if(formatWeekLong(c.getTime()).toLowerCase().indexOf(q) === 0) {\r\n      return c.getDay();\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nMOUNT_CLASS_TO.fillTipDates = fillTipDates;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatFullSentTimeRaw } from \"../../helpers/date\";\r\nimport { User } from \"../../layer\";\r\nimport { LangPackKey, i18n } from \"../../lib/langPack\";\r\nimport { REPLIES_PEER_ID, SERVICE_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\n\r\nexport default function getUserStatusString(user: User.user): HTMLElement {\r\n  if(!user) {\r\n    return document.createElement('span');\r\n  }\r\n\r\n  let key: LangPackKey;\r\n  let args: any[];\r\n\r\n  switch(user.id) {\r\n    case REPLIES_PEER_ID.toUserId():\r\n      key = 'Peer.RepliesNotifications';\r\n      break;\r\n    case SERVICE_PEER_ID.toUserId():\r\n      key = 'Peer.ServiceNotifications';\r\n      break;\r\n    default: {\r\n      if(user.pFlags.bot) {\r\n        key = 'Bot';\r\n        break;\r\n      }\r\n\r\n      if(user.pFlags.support) {\r\n        key = 'SupportStatus';\r\n        break;\r\n      }\r\n\r\n      switch(user.status?._) {\r\n        case 'userStatusRecently': {\r\n          key = 'Lately';\r\n          break;\r\n        }\r\n  \r\n        case 'userStatusLastWeek': {\r\n          key = 'WithinAWeek';\r\n          break;\r\n        }\r\n  \r\n        case 'userStatusLastMonth': {\r\n          key = 'WithinAMonth';\r\n          break;\r\n        }\r\n        \r\n        case 'userStatusOffline': {\r\n          const date = user.status.was_online;\r\n          const today = new Date();\r\n          const now = today.getTime() / 1000 | 0;\r\n          \r\n          const diff = now - date;\r\n          if(diff < 60) {\r\n            key = 'Peer.Status.justNow';\r\n          } else if(diff < 3600) {\r\n            key = 'Peer.Status.minAgo';\r\n            const c = diff / 60 | 0;\r\n            args = [c];\r\n          } else if(diff < 86400 && today.getDate() === new Date(date * 1000).getDate()) {\r\n            key = 'LastSeen.HoursAgo';\r\n            const c = diff / 3600 | 0;\r\n            args = [c];\r\n          } else {\r\n            key = 'Peer.Status.LastSeenAt';\r\n            const {dateEl, timeEl} = formatFullSentTimeRaw(date);\r\n            args = [dateEl, timeEl];\r\n          }\r\n          \r\n          break;\r\n        }\r\n  \r\n        case 'userStatusOnline': {\r\n          key = 'Online';\r\n          break;\r\n        }\r\n  \r\n        default: {\r\n          key = 'ALongTimeAgo';\r\n          break;\r\n        }\r\n      }\r\n\r\n      break;\r\n    }\r\n  }\r\n  \r\n  return i18n(key, args);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarLeft, { SettingSection } from \"..\";\r\nimport { InputFile } from \"../../../layer\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AvatarEdit from \"../../avatarEdit\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\n\r\ninterface OpenStreetMapInterface {\r\n  place_id?: number;\r\n  license?: string;\r\n  osm_type?: string;\r\n  osm_id?: number;\r\n  lat?: string;\r\n  lon?: string;\r\n  display_name: string;\r\n  address?: object;\r\n  boundingbox?: object;\r\n}\r\n\r\nexport default class AppNewGroupTab extends SliderSuperTab {\r\n  private avatarEdit: AvatarEdit;\r\n  private uploadAvatar: () => Promise<InputFile> = null;\r\n  private peerIds: PeerId[];\r\n  private isGeoChat: boolean = false;\r\n  private nextBtn: HTMLButtonElement;\r\n  private groupNameInputField: InputField;\r\n  private list: HTMLUListElement;\r\n  private groupLocationInputField: InputField;\r\n  private userLocationCoords: {lat: number, long: number};\r\n  private userLocationAddress: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('new-group-container');\r\n    this.setTitle('NewGroup');\r\n\r\n    this.avatarEdit = new AvatarEdit((_upload) => {\r\n      this.uploadAvatar = _upload;\r\n    });\r\n\r\n    const section = new SettingSection({});\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    this.groupNameInputField = new InputField({\r\n      label: 'CreateGroup.NameHolder',\r\n      maxLength: 128\r\n    });\r\n\r\n    this.groupLocationInputField = new InputField({\r\n      label: 'ChatLocation',\r\n      name: 'location',\r\n      canBeEdited: false\r\n    });\r\n\r\n    inputWrapper.append(\r\n      this.groupNameInputField.container,\r\n      this.groupLocationInputField.container\r\n    );\r\n\r\n    this.groupNameInputField.input.addEventListener('input', () => {\r\n      const value = this.groupNameInputField.value;\r\n      let valueCheck = !!value.length && !this.groupNameInputField.input.classList.contains('error');\r\n      if(this.isGeoChat) valueCheck = valueCheck && !!this.userLocationCoords && !!this.userLocationAddress;\r\n      this.nextBtn.classList.toggle('is-visible', !!valueCheck);\r\n    });\r\n\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n\r\n    this.nextBtn.addEventListener('click', () => {\r\n      const title = this.groupNameInputField.value;\r\n\r\n      let promise: Promise<ChatId>;\r\n      if(this.isGeoChat) {\r\n        if(!this.userLocationAddress || !this.userLocationCoords) return;\r\n        promise = this.managers.appChatsManager.createChannel({\r\n          title, \r\n          about: '', \r\n          geo_point: {\r\n            _: 'inputGeoPoint',\r\n            ...this.userLocationCoords, \r\n          },\r\n          address: this.userLocationAddress,\r\n          megagroup: true\r\n        }).then((chatId) => {\r\n          if(this.uploadAvatar) {\r\n            this.uploadAvatar().then((inputFile) => {\r\n              this.managers.appChatsManager.editPhoto(chatId, inputFile);\r\n            });\r\n          }\r\n\r\n          if(this.peerIds.length) {\r\n            this.managers.appChatsManager.inviteToChannel(chatId, this.peerIds);\r\n          }\r\n\r\n          return chatId;\r\n        });\r\n      } else {\r\n        this.nextBtn.disabled = true;\r\n        promise = this.managers.appChatsManager.createChat(title, this.peerIds.map((peerId) => peerId.toUserId())).then((chatId) => {\r\n          if(this.uploadAvatar) {\r\n            this.uploadAvatar().then((inputFile) => {\r\n              this.managers.appChatsManager.editPhoto(chatId, inputFile);\r\n            });\r\n          }\r\n          \r\n          return chatId;\r\n        });\r\n      }\r\n\r\n      if(!promise) {\r\n        return;\r\n      }\r\n\r\n      promise.then((chatId) => {\r\n        appSidebarLeft.removeTabFromHistory(this);\r\n        appSidebarLeft.selectTab(0);\r\n\r\n        appImManager.setInnerPeer({peerId: chatId.toPeerId(true)});\r\n      });\r\n    });\r\n\r\n    const chatsSection = new SettingSection({\r\n      name: 'Members',\r\n      nameArgs: [this.peerIds.length]\r\n    });\r\n\r\n    const list = this.list = appDialogsManager.createChatList({\r\n      new: true\r\n    });\r\n\r\n    chatsSection.content.append(list);\r\n\r\n    section.content.append(this.avatarEdit.container, inputWrapper);\r\n\r\n    this.content.append(this.nextBtn);\r\n    this.scrollable.append(section.container, chatsSection.container);\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.avatarEdit.clear();\r\n    this.uploadAvatar = null;\r\n    this.groupNameInputField.value = '';\r\n    this.groupLocationInputField.container.classList.add('hide');\r\n    this.nextBtn.disabled = false;\r\n  }\r\n\r\n  public open(peerIds: PeerId[], isGeoChat: boolean = false) {\r\n    this.isGeoChat = isGeoChat;\r\n    this.peerIds = peerIds;\r\n    const result = super.open();\r\n    result.then(() => {\r\n      if(isGeoChat) {\r\n        this.setTitle('NearbyCreateGroup');\r\n        this.groupLocationInputField.container.classList.remove('hide');\r\n        this.groupLocationInputField.setValueSilently(I18n.format('Loading', true));\r\n        this.startLocating();\r\n      } else {\r\n        this.groupLocationInputField.container.classList.add('hide');\r\n      }\r\n\r\n      return Promise.all(this.peerIds.map(async(userId) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: userId,\r\n          container: this.list,\r\n          rippleEnabled: false,\r\n          avatarSize: 48\r\n        });\r\n\r\n        dom.lastMessageSpan.append(getUserStatusString(await this.managers.appUsersManager.getUser(userId)));\r\n      }));\r\n    });\r\n    \r\n    return result;\r\n  }\r\n\r\n  private startLocating() {\r\n    navigator.geolocation.getCurrentPosition((location) => {\r\n      this.userLocationCoords = {\r\n        lat: location.coords.latitude,\r\n        long: location.coords.longitude\r\n      };\r\n\r\n      let uri = \"https://nominatim.openstreetmap.org/reverse\";\r\n      uri += \"?lat=\"+location.coords.latitude;\r\n      uri += \"&lon=\"+location.coords.longitude;\r\n      uri += \"&format=json\";\r\n      uri += \"&addressdetails=1\";\r\n      uri += \"&accept-language=en\";\r\n      fetch(uri)\r\n      .then((response) => response.json())\r\n      .then((response: OpenStreetMapInterface) => {\r\n        this.userLocationAddress = response.display_name;\r\n        this.groupLocationInputField.setValueSilently(response.display_name);\r\n      });\r\n    }, (error) => {\r\n      if(error instanceof GeolocationPositionError) {\r\n        this.groupLocationInputField.setValueSilently('Location permission denied. Please retry later.');\r\n      } else {\r\n        this.groupLocationInputField.setValueSilently('An error has occurred. Please retry later.');\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\ntype TargetType = HTMLElement;\r\nexport type OnVisibilityChange = (target: TargetType, visible: boolean) => void;\r\n\r\nexport default class VisibilityIntersector {\r\n  private observer: IntersectionObserver;\r\n  private items: Map<TargetType, boolean> = new Map();\r\n  private locked = false;\r\n\r\n  constructor(onVisibilityChange: OnVisibilityChange) {\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      if(this.locked) {\r\n        return;\r\n      }\r\n\r\n      const changed: {target: TargetType, visible: boolean}[] = [];\r\n\r\n      entries.forEach((entry) => {\r\n        const target = entry.target as TargetType;\r\n\r\n        if(this.items.get(target) === entry.isIntersecting) {\r\n          return;\r\n        } else {\r\n          this.items.set(target, entry.isIntersecting);\r\n        }\r\n\r\n        /* if(entry.isIntersecting) {\r\n          console.log('ooo', entry);\r\n        } */\r\n\r\n        /* if(this.locked) {\r\n          return;\r\n        } */\r\n\r\n        changed[entry.isIntersecting ? 'unshift' : 'push']({target, visible: entry.isIntersecting});\r\n\r\n        //onVisibilityChange(target, entry.isIntersecting);\r\n      });\r\n\r\n      changed.forEach((smth) => {\r\n        onVisibilityChange(smth.target, smth.visible);\r\n      });\r\n    });\r\n  }\r\n\r\n  public getVisible() {\r\n    const items: TargetType[] = [];\r\n    this.items.forEach((value, key) => {\r\n      if(value) {\r\n        items.push(key);\r\n      }\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  public clearVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.items.set(target, false);\r\n    }\r\n  }\r\n\r\n  public isVisible(target: TargetType) {\r\n    return this.items.get(target);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.observer.disconnect();\r\n    this.items.clear();\r\n  }\r\n\r\n  public refresh() {\r\n    this.observer.disconnect();\r\n\r\n    //window.requestAnimationFrame(() => {\r\n      const targets = [...this.items.keys()];\r\n      for(const target of targets) {\r\n        //this.items.set(target, false);\r\n        this.observer.observe(target);\r\n      }\r\n    //});\r\n  }\r\n\r\n  public refreshVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.observer.unobserve(target);\r\n    }\r\n\r\n    for(const target of visible) {\r\n      this.observer.observe(target);\r\n    }\r\n  }\r\n\r\n  public observe(target: TargetType) {\r\n    this.items.set(target, false);\r\n    this.observer.observe(target);\r\n  }\r\n\r\n  public unobserve(target: TargetType) {\r\n    this.observer.unobserve(target);\r\n    this.items.delete(target);\r\n  }\r\n\r\n  public unlock() {\r\n    this.locked = false;\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    this.unlock();\r\n    this.refresh();\r\n  }\r\n\r\n  public lock() {\r\n    this.locked = true;\r\n  }\r\n}\r\n","export default function findAndSpliceAll<T>(array: Array<T>, verify: (value: T, index: number, arr: typeof array) => boolean) {\r\n  const out: typeof array = [];\r\n  let idx = -1;\r\n  while((idx = array.findIndex(verify)) !== -1) {\r\n    out.push(array.splice(idx, 1)[0]);\r\n  }\r\n\r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueBase, { LazyLoadElementBase } from \"./lazyLoadQueueBase\";\r\nimport VisibilityIntersector from \"./visibilityIntersector\";\r\n\r\nexport type LazyLoadElement = Omit<LazyLoadElementBase, 'load'> & {\r\n  load: (target?: HTMLElement) => Promise<any>,\r\n  div: HTMLElement\r\n  wasSeen?: boolean,\r\n};\r\n\r\nexport default class LazyLoadQueueIntersector extends LazyLoadQueueBase {\r\n  protected queue: Array<LazyLoadElement> = [];\r\n  protected inProcess: Set<LazyLoadElement> = new Set();\r\n\r\n  public intersector: VisibilityIntersector;\r\n  protected intersectorTimeout: number;\r\n\r\n  constructor(parallelLimit?: number) {\r\n    super(parallelLimit);\r\n  }\r\n\r\n  public lock() {\r\n    super.lock();\r\n    this.intersector.lock();\r\n  }\r\n\r\n  public unlock() {\r\n    super.unlock();\r\n    this.intersector.unlock();\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    super.unlock();\r\n    this.intersector.unlockAndRefresh();\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this.intersector.disconnect();\r\n  }\r\n\r\n  public refresh() {\r\n    this.intersector.refresh();\r\n  }\r\n\r\n  protected loadItem(item: LazyLoadElement) {\r\n    return item.load(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const item = this.queue.find((i) => i.div === el.div && i.load === el.load);\r\n    if(item) {\r\n      return false;\r\n    } else {\r\n      for(const item of this.inProcess) {\r\n        if(item.div === el.div && item.load === el.load) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    this.queue[method](el);\r\n    return true;\r\n  }\r\n\r\n  protected setProcessQueueTimeout() {\r\n    if(!this.intersectorTimeout) {\r\n      this.intersectorTimeout = window.setTimeout(() => {\r\n        this.intersectorTimeout = 0;\r\n        this.processQueue();\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  public push(el: LazyLoadElement) {\r\n    super.push(el);\r\n  }\r\n\r\n  public unshift(el: LazyLoadElement) {\r\n    super.unshift(el);\r\n  }\r\n\r\n  public unobserve(el: HTMLElement) {\r\n    findAndSpliceAll(this.queue, (i) => i.div === el);\r\n\r\n    this.intersector.unobserve(el);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport VisibilityIntersector from \"./visibilityIntersector\";\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport LazyLoadQueueIntersector, { LazyLoadElement } from \"./lazyLoadQueueIntersector\";\r\n\r\nexport default class LazyLoadQueue extends LazyLoadQueueIntersector {\r\n  constructor(parallelLimit?: number) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector(this.onVisibilityChange);\r\n  }\r\n\r\n  private onVisibilityChange = (target: HTMLElement, visible: boolean) => {\r\n    if(visible) {\r\n      /* if(DEBUG) {\r\n        this.log('isIntersecting', target);\r\n      } */\r\n\r\n      // need for set element first if scrolled\r\n      findAndSpliceAll(this.queue, (i) => i.div === target).forEach((item) => {\r\n        item.wasSeen = true;\r\n        this.queue.unshift(item);\r\n        //this.processQueue(item);\r\n      });\r\n\r\n      this.setProcessQueueTimeout();\r\n    }\r\n  };\r\n\r\n  protected getItem() {\r\n    return findAndSplice(this.queue, item => item.wasSeen);\r\n  }\r\n\r\n  public async processItem(item: LazyLoadElement) {\r\n    await super.processItem(item);\r\n    this.intersector.unobserve(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const inserted = super.addElement(method, el);\r\n\r\n    if(!inserted) return false;\r\n\r\n    this.intersector.observe(el.div);\r\n    /* if(el.wasSeen) {\r\n      this.processQueue(el);\r\n    } else  */if(!el.hasOwnProperty('wasSeen')) {\r\n      el.wasSeen = false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../appDocsManager\";\r\nimport type { MyPhoto } from \"../../appPhotosManager\";\r\nimport calcImageInBox from \"../../../../helpers/calcImageInBox\";\r\nimport { PhotoSize } from \"../../../../layer\";\r\n\r\nexport default function choosePhotoSize(\r\n  photo: MyPhoto | MyDocument, \r\n  boxWidth = 0, \r\n  boxHeight = 0, \r\n  useBytes = false, \r\n  pushDocumentSize = false\r\n) {\r\n  if(window.devicePixelRatio > 1) {\r\n    boxWidth *= 2;\r\n    boxHeight *= 2;\r\n  }\r\n  \r\n  /*\r\n  s\tbox\t100x100\r\n  m\tbox\t320x320\r\n  x\tbox\t800x800\r\n  y\tbox\t1280x1280\r\n  w\tbox\t2560x2560\r\n  a\tcrop\t160x160\r\n  b\tcrop\t320x320\r\n  c\tcrop\t640x640\r\n  d\tcrop\t1280x1280 */\r\n\r\n  let bestPhotoSize: PhotoSize = {_: 'photoSizeEmpty', type: ''};\r\n  let sizes = (photo as MyPhoto).sizes || (photo as MyDocument).thumbs as PhotoSize[];\r\n  if(pushDocumentSize && sizes && photo._ === 'document') {\r\n    sizes = sizes.concat({\r\n      _: 'photoSize', \r\n      w: (photo as MyDocument).w, \r\n      h: (photo as MyDocument).h, \r\n      size: (photo as MyDocument).size, \r\n      type: undefined\r\n    });\r\n  }\r\n\r\n  if(sizes?.length) {\r\n    for(let i = 0, length = sizes.length; i < length; ++i) {\r\n      const photoSize = sizes[i];\r\n      if(!('w' in photoSize) && !('h' in photoSize)) continue;\r\n\r\n      bestPhotoSize = photoSize;\r\n\r\n      const size = calcImageInBox(photoSize.w, photoSize.h, boxWidth, boxHeight);\r\n      if(size.width >= boxWidth || size.height >= boxHeight) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    if(useBytes && bestPhotoSize._ === 'photoSizeEmpty' && sizes[0]._ === 'photoStrippedSize') {\r\n      bestPhotoSize = sizes[0];\r\n    }\r\n  }\r\n  \r\n  return bestPhotoSize;\r\n}\r\n","export default function accumulate(arr: number[], initialValue: number) {\r\n  return arr.reduce((acc, value) => acc + value, initialValue);\r\n}\r\n","/*\r\nThis file is part of Telegram Desktop,\r\nthe official desktop application for the Telegram messaging service.\r\nFor license and copyright information please follow this link:\r\nhttps://github.com/telegramdesktop/tdesktop/blob/master/LEGAL\r\n*/\r\n\r\nimport accumulate from \"../helpers/array/accumulate\";\r\nimport clamp from \"../helpers/number/clamp\";\r\n\r\ntype Size = {w: number, h: number};\r\nexport type GroupMediaLayout = {\r\n  geometry: {\r\n    x: number,\r\n    y: number,\r\n    width: number,\r\n    height: number\r\n  },\r\n  sides: number\r\n};\r\ntype Attempt = {\r\n  lineCounts: number[],\r\n  heights: number[]\r\n};\r\nexport const RectPart = {\r\n  None: 0,\r\n  Top: 1,\r\n  Right: 2,\r\n  Bottom: 4,\r\n  Left: 8\r\n};\r\n\r\n// https://github.com/telegramdesktop/tdesktop/blob/4669c07dc5335cbf4795bbbe5b0ab7c007b9aee2/Telegram/SourceFiles/ui/grouped_layout.cpp\r\nexport class Layouter {\r\n  private count: number;\r\n  private ratios: number[];\r\n  private proportions: string;\r\n  private averageRatio: number;\r\n  private maxSizeRatio: number;\r\n\r\n  constructor(private sizes: Size[], private maxWidth: number, private minWidth: number, private spacing: number, private maxHeight = maxWidth) {\r\n    this.count = sizes.length;\r\n    this.ratios = Layouter.countRatios(sizes);\r\n    this.proportions = Layouter.countProportions(this.ratios);\r\n    this.averageRatio = accumulate(this.ratios, 1) / this.count; // warn\r\n    this.maxSizeRatio = maxWidth / this.maxHeight;\r\n  }\r\n\r\n  public layout(): GroupMediaLayout[] {\r\n    if(!this.count) return [];\r\n    //else if(this.count === 1) return this.layoutOne();\r\n\r\n    if(this.count >= 5 || this.ratios.find((r) => r > 2)) {\r\n      return new ComplexLayouter(this.ratios, this.averageRatio, this.maxWidth, this.minWidth, this.spacing).layout();\r\n    }\r\n\r\n    if(this.count === 2) return this.layoutTwo();\r\n    else if(this.count === 3) return this.layoutThree();\r\n    return this.layoutFour();\r\n  }\r\n\r\n  private layoutTwo(): ReturnType<Layouter['layout']> {\r\n    if((this.proportions === \"ww\")\r\n      && (this.averageRatio > 1.4 * this.maxSizeRatio)\r\n      && (this.ratios[1] - this.ratios[0] < 0.2)) {\r\n      return this.layoutTwoTopBottom();\r\n    } else if(this.proportions === \"ww\" || this.proportions === \"qq\") {\r\n      return this.layoutTwoLeftRightEqual();\r\n    }\r\n    return this.layoutTwoLeftRight();\r\n  }\r\n\r\n  private layoutThree(): ReturnType<Layouter['layout']> {\r\n    //console.log('layoutThree:', this);\r\n    if(this.proportions[0] === 'n') {\r\n      return this.layoutThreeLeftAndOther();\r\n    }\r\n    return this.layoutThreeTopAndOther();\r\n  }\r\n\r\n  private layoutFour(): ReturnType<Layouter['layout']> {\r\n    if(this.proportions[0] === 'w') {\r\n      return this.layoutFourTopAndOther();\r\n    }\r\n    return this.layoutFourLeftAndOther();\r\n  }\r\n\r\n  private layoutTwoTopBottom(): ReturnType<Layouter['layout']> {\r\n    const width = this.maxWidth;\r\n    const height = Math.round(Math.min(\r\n      width / this.ratios[0],\r\n      Math.min(\r\n        width / this.ratios[1],\r\n        (this.maxHeight - this.spacing) / 2)));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width, height},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: height + this.spacing, width, height},\r\n        sides: RectPart.Left | RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutTwoLeftRightEqual(): ReturnType<Layouter['layout']> {\r\n    const width = (this.maxWidth - this.spacing) / 2;\r\n    const height = Math.round(Math.min(\r\n      width / this.ratios[0],\r\n      Math.min(width / this.ratios[1], this.maxHeight * 1)));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width, height},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: width + this.spacing, y: 0, width, height},\r\n        sides: RectPart.Top | RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutTwoLeftRight(): ReturnType<Layouter['layout']> {\r\n    const minimalWidth = Math.round(this.minWidth * 1.5);\r\n    const secondWidth = Math.min(\r\n      Math.round(Math.max(\r\n        0.4 * (this.maxWidth - this.spacing),\r\n        (this.maxWidth - this.spacing) / this.ratios[0]\r\n          / (1 / this.ratios[0] + 1 / this.ratios[1]))),\r\n      this.maxWidth - this.spacing - minimalWidth);\r\n    const firstWidth = this.maxWidth\r\n      - secondWidth\r\n      - this.spacing;\r\n    const height = Math.min(\r\n      this.maxHeight,\r\n      Math.round(Math.min(\r\n        firstWidth / this.ratios[0],\r\n        secondWidth / this.ratios[1])));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: firstWidth, height},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: firstWidth + this.spacing, y: 0, width: secondWidth, height},\r\n        sides: RectPart.Top | RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutThreeLeftAndOther(): ReturnType<Layouter['layout']> {\r\n    const firstHeight = this.maxHeight;\r\n    const thirdHeight = Math.round(Math.min(\r\n      (this.maxHeight - this.spacing) / 2.,\r\n      (this.ratios[1] * (this.maxWidth - this.spacing)\r\n        / (this.ratios[2] + this.ratios[1]))));\r\n    const secondHeight = firstHeight\r\n      - thirdHeight\r\n      - this.spacing;\r\n    const rightWidth = Math.max(\r\n      this.minWidth,\r\n      Math.round(Math.min(\r\n        (this.maxWidth - this.spacing) / 2.,\r\n        Math.min(\r\n          thirdHeight * this.ratios[2],\r\n          secondHeight * this.ratios[1]))));\r\n    const leftWidth = Math.min(\r\n      Math.round(firstHeight * this.ratios[0]),\r\n      this.maxWidth - this.spacing - rightWidth);\r\n\r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: leftWidth, height: firstHeight},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: leftWidth + this.spacing, y: 0, width: rightWidth, height: secondHeight},\r\n        sides: RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: leftWidth + this.spacing, y: secondHeight + this.spacing, width: rightWidth, height: thirdHeight},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n  \r\n  private layoutThreeTopAndOther(): ReturnType<Layouter['layout']> {\r\n    const firstWidth = this.maxWidth;\r\n    const firstHeight = Math.round(Math.min(\r\n      firstWidth / this.ratios[0],\r\n      (this.maxHeight - this.spacing) * 0.66));\r\n    const secondWidth = (this.maxWidth - this.spacing) / 2;\r\n    const secondHeight = Math.min(\r\n      this.maxHeight - firstHeight - this.spacing,\r\n      Math.round(Math.min(\r\n        secondWidth / this.ratios[1],\r\n        secondWidth / this.ratios[2])));\r\n    const thirdWidth = firstWidth - secondWidth - this.spacing;\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: firstWidth, height: firstHeight},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: firstHeight + this.spacing, width: secondWidth, height: secondHeight},\r\n        sides: RectPart.Bottom | RectPart.Left\r\n      },\r\n      {\r\n        geometry: {x: secondWidth + this.spacing, y: firstHeight + this.spacing, width: thirdWidth, height: secondHeight},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutFourTopAndOther(): ReturnType<Layouter['layout']> {\r\n    const w = this.maxWidth;\r\n    const h0 = Math.round(Math.min(\r\n      w / this.ratios[0],\r\n      (this.maxHeight - this.spacing) * 0.66));\r\n    const h = Math.round(\r\n      (this.maxWidth - 2 * this.spacing)\r\n        / (this.ratios[1] + this.ratios[2] + this.ratios[3]));\r\n    const w0 = Math.max(\r\n      this.minWidth,\r\n      Math.round(Math.min(\r\n        (this.maxWidth - 2 * this.spacing) * 0.4,\r\n        h * this.ratios[1])));\r\n    const w2 = Math.round(Math.max(\r\n      Math.max(\r\n        this.minWidth * 1.,\r\n        (this.maxWidth - 2 * this.spacing) * 0.33),\r\n      h * this.ratios[3]));\r\n    const w1 = w - w0 - w2 - 2 * this.spacing;\r\n    const h1 = Math.min(\r\n      this.maxHeight - h0 - this.spacing,\r\n      h);\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: w, height: h0},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: h0 + this.spacing, width: w0, height: h1},\r\n        sides: RectPart.Bottom | RectPart.Left\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + this.spacing, width: w1, height: h1},\r\n        sides: RectPart.Bottom,\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing + w1 + this.spacing, y: h0 + this.spacing, width: w2, height: h1},\r\n        sides: RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutFourLeftAndOther(): ReturnType<Layouter['layout']> {\r\n    const h = this.maxHeight;\r\n    const w0 = Math.round(Math.min(\r\n      h * this.ratios[0],\r\n      (this.maxWidth - this.spacing) * 0.6));\r\n  \r\n    const w = Math.round(\r\n      (this.maxHeight - 2 * this.spacing)\r\n        / (1. / this.ratios[1] + 1. / this.ratios[2] + 1. / this.ratios[3])\r\n    );\r\n    const h0 = Math.round(w / this.ratios[1]);\r\n    const h1 = Math.round(w / this.ratios[2]);\r\n    const h2 = h - h0 - h1 - 2 * this.spacing;\r\n    const w1 = Math.max(\r\n      this.minWidth,\r\n      Math.min(this.maxWidth - w0 - this.spacing, w));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: w0, height: h},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: 0, width: w1, height: h0},\r\n        sides: RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + this.spacing, width: w1, height: h1},\r\n        sides: RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + h1 + 2 * this.spacing, width: w1, height: h2},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private static countRatios(sizes: Size[]) {\r\n    return sizes.map((size) => size.w / size.h);\r\n  }\r\n\r\n  private static countProportions(ratios: number[]) {\r\n    return ratios.map((ratio) => (ratio > 1.2) ? 'w' : (ratio < 0.8) ? 'n' : 'q').join('');\r\n  }\r\n}\r\n\r\nclass ComplexLayouter {\r\n  private ratios: number[];\r\n  private count: number;\r\n\r\n  constructor(ratios: number[], private averageRatio: number, private maxWidth: number, private minWidth: number, private spacing: number, private maxHeight = maxWidth * 4 / 3) {\r\n    this.ratios = ComplexLayouter.cropRatios(ratios, averageRatio);\r\n    this.count = ratios.length;\r\n  }\r\n\r\n  private static cropRatios(ratios: number[], averageRatio: number) {\r\n    const kMaxRatio = 2.75;\r\n    const kMinRatio = 0.6667;\r\n    return ratios.map((ratio) => {\r\n      return averageRatio > 1.1\r\n\t\t\t  ? clamp(ratio, 1., kMaxRatio)\r\n\t\t\t  : clamp(ratio, kMinRatio, 1.);\r\n    });\r\n  }\r\n\r\n  public layout(): GroupMediaLayout[] {\r\n    let result = new Array<GroupMediaLayout>(this.count);\r\n\r\n    let attempts: Attempt[] = [];\r\n    const multiHeight = (offset: number, count: number) => {\r\n      const ratios = this.ratios.slice(offset, offset + count); // warn\r\n      const sum = accumulate(ratios, 0);\r\n      return (this.maxWidth - (count - 1) * this.spacing) / sum;\r\n    };\r\n    const pushAttempt = (lineCounts: number[]) => {\r\n      let heights: number[] = [];\r\n      let offset = 0;\r\n      for(let count of lineCounts) {\r\n        heights.push(multiHeight(offset, count));\r\n        offset += count;\r\n      }\r\n      attempts.push({lineCounts, heights}); // warn\r\n    };\r\n\r\n    for(let first = 1; first !== this.count; ++first) {\r\n      const second = this.count - first;\r\n      if(first > 3 || second > 3) {\r\n        continue;\r\n      }\r\n      pushAttempt([first, second]);\r\n    }\r\n    for(let first = 1; first !== this.count - 1; ++first) {\r\n      for(let second = 1; second !== this.count - first; ++second) {\r\n        const third = this.count - first - second;\r\n        if((first > 3)\r\n          || (second > ((this.averageRatio < 0.85) ? 4 : 3))\r\n          || (third > 3)) {\r\n          continue;\r\n        }\r\n        pushAttempt([first, second, third]);\r\n      }\r\n    }\r\n    for(let first = 1; first !== this.count - 1; ++first) {\r\n      for(let second = 1; second !== this.count - first; ++second) {\r\n        for(let third = 1; third !== this.count - first - second; ++third) {\r\n          const fourth = this.count - first - second - third;\r\n          if(first > 3 || second > 3 || third > 3 || fourth > 3) {\r\n            continue;\r\n          }\r\n          pushAttempt([first, second, third, fourth]);\r\n        }\r\n      }\r\n    }\r\n\r\n    let optimalAttempt: Attempt = null;\r\n    let optimalDiff = 0;\r\n    for(const attempt of attempts) {\r\n      const {heights, lineCounts: counts} = attempt;\r\n      const lineCount = counts.length;\r\n      const totalHeight = accumulate(heights, 0) \r\n        + this.spacing * (lineCount - 1);\r\n      const minLineHeight = Math.min(...heights);\r\n      const maxLineHeight = Math.max(...heights);\r\n      const bad1 = (minLineHeight < this.minWidth) ? 1.5 : 1;\r\n      const bad2 = (() => {\r\n        for(let line = 1; line !== lineCount; ++line) {\r\n          if(counts[line - 1] > counts[line]) {\r\n            return 1.5;\r\n          }\r\n        }\r\n        return 1.;\r\n      })();\r\n      const diff = Math.abs(totalHeight - this.maxHeight) * bad1 * bad2;\r\n      if(!optimalAttempt || diff < optimalDiff) {\r\n        optimalAttempt = attempt;\r\n        optimalDiff = diff;\r\n      }\r\n    }\r\n\r\n    const optimalCounts = optimalAttempt.lineCounts;\r\n\t  const optimalHeights = optimalAttempt.heights;\r\n    const rowCount = optimalCounts.length;\r\n    \r\n    let index = 0;\r\n    let y = 0;\r\n    for(let row = 0; row !== rowCount; ++row) {\r\n      const colCount = optimalCounts[row];\r\n      const lineHeight = optimalHeights[row];\r\n      const height = Math.round(lineHeight);\r\n\r\n      let x = 0;\r\n      for(let col = 0; col !== colCount; ++col) {\r\n        const sides = RectPart.None\r\n          | (row === 0 ? RectPart.Top : RectPart.None)\r\n          | (row === rowCount - 1 ? RectPart.Bottom : RectPart.None)\r\n          | (col === 0 ? RectPart.Left : RectPart.None)\r\n          | (col === colCount - 1 ? RectPart.Right : RectPart.None);\r\n\r\n        const ratio = this.ratios[index];\r\n        const width = (col === colCount - 1)\r\n          ? (this.maxWidth - x)\r\n          : Math.round(ratio * lineHeight);\r\n        result[index] = {\r\n          geometry: {x, y, width, height},\r\n          sides\r\n        };\r\n\r\n        x += width + this.spacing;\r\n        ++index;\r\n      }\r\n      y += height + this.spacing;\r\n    }\r\n\r\n    return result;\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Layouter, RectPart } from \"./groupedLayout\";\r\n\r\nexport default function prepareAlbum(options: {\r\n  container: HTMLElement,\r\n  items: {w: number, h: number}[],\r\n  maxWidth: number,\r\n  minWidth: number,\r\n  spacing: number,\r\n  maxHeight?: number,\r\n  forMedia?: true\r\n}) {\r\n  const layouter = new Layouter(options.items, options.maxWidth, options.minWidth, options.spacing, options.maxHeight);\r\n  const layout = layouter.layout();\r\n\r\n  const widthItem = layout.find((item) => item.sides & RectPart.Right);\r\n  const width = widthItem.geometry.width + widthItem.geometry.x;\r\n\r\n  const heightItem = layout.find((item) => item.sides & RectPart.Bottom);\r\n  const height = heightItem.geometry.height + heightItem.geometry.y;\r\n\r\n  const container = options.container;\r\n  container.style.width = width + 'px';\r\n  container.style.height = height + 'px';\r\n  const children = container.children;\r\n\r\n  layout.forEach(({geometry, sides}, idx) => {\r\n    let div: HTMLElement;\r\n    div = children[idx] as HTMLElement;\r\n    if(!div) {\r\n      div = document.createElement('div');\r\n      container.append(div);\r\n    }\r\n\r\n    div.classList.add('album-item', 'grouped-item');\r\n\r\n    div.style.width = (geometry.width / width * 100) + '%';\r\n    div.style.height = (geometry.height / height * 100) + '%';\r\n    div.style.top = (geometry.y / height * 100) + '%';\r\n    div.style.left = (geometry.x / width * 100) + '%';\r\n\r\n    if(sides & RectPart.Left && sides & RectPart.Top) {\r\n      div.style.borderTopLeftRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Left && sides & RectPart.Bottom) {\r\n      div.style.borderBottomLeftRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Right && sides & RectPart.Top) {\r\n      div.style.borderTopRightRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Right && sides & RectPart.Bottom) {\r\n      div.style.borderBottomRightRadius = 'inherit';\r\n    }\r\n\r\n    if(options.forMedia) {\r\n      const mediaDiv = document.createElement('div');\r\n      mediaDiv.classList.add('album-item-media');\r\n  \r\n      div.append(mediaDiv);\r\n    }\r\n\r\n    // @ts-ignore\r\n    //div.style.backgroundColor = '#' + Math.floor(Math.random() * (2 ** 24 - 1)).toString(16).padStart(6, '0');\r\n  });\r\n\r\n  /* if(options.forMedia) {\r\n    layout.forEach((_, i) => {\r\n      const mediaDiv = document.createElement('div');\r\n      mediaDiv.classList.add('album-item-media');\r\n  \r\n      options.container.children[i].append(mediaDiv);\r\n    });\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\n\r\nexport const loadedURLs: {[url: string]: boolean} = {};\r\nconst set = (elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, url: string) => {\r\n  if(elem instanceof HTMLImageElement || elem instanceof HTMLVideoElement) elem.src = url;\r\n  else if(elem instanceof SVGImageElement) elem.setAttributeNS(null, 'href', url);\r\n  else elem.style.backgroundImage = 'url(' + url + ')';\r\n};\r\n\r\n// проблема функции в том, что она не подходит для ссылок, пригодна только для blob'ов, потому что обычным ссылкам нужен 'load' каждый раз.\r\nexport default function renderImageFromUrl(\r\n  elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, \r\n  url: string, \r\n  callback?: () => void, \r\n  useCache = true\r\n) {\r\n  if(!url) {\r\n    console.error('renderImageFromUrl: no url?', elem, url);\r\n    callback && callback();\r\n    return;\r\n  }\r\n\r\n  if(((loadedURLs[url]/*  && false */) && useCache) || elem instanceof HTMLVideoElement) {\r\n    if(elem) {\r\n      set(elem, url);\r\n    }\r\n    \r\n    callback && callback();\r\n    // callback && getHeavyAnimationPromise().then(() => callback());\r\n  } else {\r\n    const isImage = elem instanceof HTMLImageElement;\r\n    const loader = isImage ? elem as HTMLImageElement : new Image();\r\n    //const loader = new Image();\r\n    loader.src = url;\r\n    //let perf = performance.now();\r\n    loader.addEventListener('load', () => {\r\n      if(!isImage && elem) {\r\n        set(elem, url);\r\n      }\r\n\r\n      loadedURLs[url] = true;\r\n      //console.log('onload:', url, performance.now() - perf);\r\n      // TODO: переделать прогрузки аватаров до начала анимации, иначе с этим ожиданием они неприятно появляются\r\n      // callback && getHeavyAnimationPromise().then(() => callback());\r\n      callback && callback();\r\n    }, {once: true});\r\n\r\n    if(callback) {\r\n      loader.addEventListener('error', (err) => {\r\n        console.error('Render image from url failed:', err, url, loader);\r\n        callback();\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport function renderImageFromUrlPromise(elem: Parameters<typeof renderImageFromUrl>[0], url: string, useCache?: boolean) {\r\n  return new Promise<void>((resolve) => {\r\n    renderImageFromUrl(elem, url, resolve, useCache);\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport sequentialDom from \"../sequentialDom\";\r\nimport renderImageFromUrl from \"./renderImageFromUrl\";\r\n\r\nexport default function renderImageWithFadeIn(\r\n  container: HTMLElement, \r\n  image: HTMLImageElement, \r\n  url: string, \r\n  needFadeIn: boolean, \r\n  aspecter = container,\r\n  thumbImage?: HTMLElement\r\n) {\r\n  if(needFadeIn) {\r\n    image.classList.add('fade-in');\r\n  }\r\n\r\n  const promise = new Promise<void>((resolve) => {\r\n    /* if(photo._ === 'document') {\r\n      console.error('wrapPhoto: will render document', photo, size, cacheContext);\r\n      return resolve();\r\n    } */\r\n\r\n    renderImageFromUrl(image, url, () => {\r\n      sequentialDom.mutateElement(container, () => {\r\n        aspecter.append(image);\r\n\r\n        resolve();\r\n        /* fastRaf(() => {\r\n          resolve();\r\n        }); */\r\n\r\n        if(needFadeIn) {\r\n          image.addEventListener('animationend', () => {\r\n            sequentialDom.mutate(() => {\r\n              image.classList.remove('fade-in');\r\n  \r\n              if(thumbImage) {\r\n                thumbImage.remove();\r\n              }\r\n            });\r\n          }, {once: true});\r\n        }\r\n      });\r\n    });\r\n  });\r\n\r\n  // recordPromise(promise, 'renderImageWithFadeIn');\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nconst TRANSITION_TIME = 200;\r\n\r\nexport default class ProgressivePreloader {\r\n  public preloader: HTMLDivElement;\r\n  public circle: SVGCircleElement;\r\n  private cancelSvg: SVGSVGElement;\r\n  private downloadSvg: HTMLElement;\r\n  \r\n  private tempId = 0;\r\n  public detached = true;\r\n\r\n  public promise: CancellablePromise<any> = null;\r\n\r\n  public isUpload = false;\r\n  private cancelable = true;\r\n  private streamable = false;\r\n  private tryAgainOnFail = true;\r\n  private attachMethod: 'append' | 'prepend' = 'append';\r\n\r\n  public loadFunc: (e?: Event) => any;\r\n\r\n  public totalLength: number;\r\n\r\n  constructor(options?: Partial<{\r\n    isUpload: ProgressivePreloader['isUpload'],\r\n    cancelable: ProgressivePreloader['cancelable'], \r\n    streamable: ProgressivePreloader['streamable'], \r\n    tryAgainOnFail: ProgressivePreloader['tryAgainOnFail'],\r\n    attachMethod: ProgressivePreloader['attachMethod']\r\n  }>) {\r\n    if(options) {\r\n      safeAssign(this, options);\r\n    }\r\n\r\n    if(this.isUpload) {\r\n      this.tryAgainOnFail = false;\r\n    }\r\n  }\r\n\r\n  public constructContainer(options: Partial<{\r\n    color: 'transparent',\r\n    bold: boolean\r\n  }> = {}) {\r\n    if(!this.preloader) {\r\n      this.preloader = document.createElement('div');\r\n      this.preloader.classList.add('preloader-container');\r\n\r\n      if(options.color) {\r\n        this.preloader.classList.add('preloader-' + options.color);\r\n      }\r\n\r\n      if(options.bold) {\r\n        this.preloader.classList.add('preloader-bold');\r\n      }\r\n  \r\n      if(this.streamable) {\r\n        this.preloader.classList.add('preloader-streamable');\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructDownloadIcon() {\r\n    this.constructContainer();\r\n  }\r\n\r\n  public construct() {\r\n    this.construct = null;\r\n\r\n    this.constructContainer();\r\n    \r\n    this.preloader.innerHTML = `\r\n    <div class=\"you-spin-me-round\">\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"${this.streamable ? '25 25 50 50' : '27 27 54 54'}\">\r\n    <circle class=\"preloader-path-new\" cx=\"${this.streamable ? '50' : '54'}\" cy=\"${this.streamable ? '50' : '54'}\" r=\"${this.streamable ? 19 : 24}\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n    </svg>\r\n    </div>`;\r\n\r\n    if(this.streamable) {\r\n      this.totalLength = 118.61124420166016;\r\n    } else {\r\n      this.totalLength = 149.82473754882812;\r\n    }\r\n\r\n    if(this.cancelable) {\r\n      this.preloader.innerHTML += `\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-close\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z\"/>\r\n        </g>\r\n      </svg>\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-download\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z\"/>\r\n        </g>\r\n      </svg>`;\r\n\r\n      this.downloadSvg = this.preloader.lastElementChild as HTMLElement;\r\n      this.cancelSvg = this.downloadSvg.previousElementSibling as any;\r\n    } else {\r\n      this.preloader.classList.add('preloader-swing');\r\n    }\r\n    \r\n    this.circle = this.preloader.firstElementChild.firstElementChild.firstElementChild as SVGCircleElement;\r\n\r\n    if(this.cancelable) {\r\n      attachClickEvent(this.preloader, this.onClick);\r\n    }\r\n  }\r\n\r\n  public onClick = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.preloader.classList.contains('manual')) {\r\n      if(this.loadFunc) {\r\n        this.loadFunc(e);\r\n      }\r\n    } else {\r\n      if(this.promise && this.promise.cancel) {\r\n        this.promise.cancel();\r\n      }\r\n    }\r\n  };\r\n\r\n  public setDownloadFunction(func: ProgressivePreloader['loadFunc']) {\r\n    this.loadFunc = func;\r\n  }\r\n\r\n  public setManual() {\r\n    this.preloader.classList.add('manual');\r\n    this.setProgress(0);\r\n  }\r\n\r\n  public attachPromise(promise: CancellablePromise<any>) {\r\n    if(this.isUpload && this.promise) return;\r\n\r\n    this.promise = promise;\r\n\r\n    const tempId = --this.tempId;\r\n    const startTime = Date.now();\r\n\r\n    const onEnd = (err: Error) => {\r\n      promise.notify = promise.notifyAll = null;\r\n\r\n      if(tempId !== this.tempId) {\r\n        return;\r\n      }\r\n\r\n      const elapsedTime = Date.now() - startTime;\r\n\r\n      //console.log('[PP]: end', this.detached, performance.now());\r\n\r\n      if(!err && this.cancelable) {\r\n        this.setProgress(100);\r\n\r\n        const delay = TRANSITION_TIME * 0.75;\r\n\r\n        if(elapsedTime < delay) {\r\n          this.detach();\r\n        } else {\r\n          setTimeout(() => { // * wait for transition complete\r\n            if(tempId === this.tempId) {\r\n              this.detach();\r\n            }\r\n          }, delay);\r\n        }\r\n      } else {\r\n        if(this.tryAgainOnFail) {\r\n          this.attach(this.preloader.parentElement);\r\n          fastRaf(() => {\r\n            this.setManual();\r\n          });\r\n        } else {\r\n          this.detach();\r\n        }\r\n      }\r\n      \r\n      this.promise = promise = null;\r\n    };\r\n    \r\n    promise\r\n    .then(() => onEnd(null))\r\n    .catch((err) => onEnd(err));\r\n\r\n    if(promise.addNotifyListener) {\r\n      promise.addNotifyListener((details: {done: number, total: number}) => {\r\n        /* if(details.done >= details.total) {\r\n          onEnd();\r\n        } */\r\n\r\n        if(tempId !== this.tempId) return;\r\n\r\n        //console.log('preloader download', promise, details);\r\n        const percents = details.done / details.total * 100;\r\n        this.setProgress(percents);\r\n      });\r\n    }\r\n  }\r\n\r\n  public attach(elem: Element, reset = false, promise?: CancellablePromise<any>) {\r\n    if(this.construct) {\r\n      this.construct();\r\n    }\r\n\r\n    if(this.preloader.parentElement) {\r\n      this.preloader.classList.remove('manual');\r\n    }\r\n\r\n    this.detached = false;\r\n\r\n    if(promise/*  && false */) {\r\n      this.attachPromise(promise);\r\n    }\r\n\r\n    if(this.detached || this.preloader.parentElement !== elem) {\r\n      const useRafs = isInDOM(this.preloader) ? 1 : 2;\r\n      if(this.preloader.parentElement !== elem) {\r\n        elem[this.attachMethod](this.preloader);\r\n      }\r\n\r\n      SetTransition(this.preloader, 'is-visible', true, TRANSITION_TIME, undefined, useRafs);\r\n    }\r\n\r\n    if(this.cancelable && reset) {\r\n      this.setProgress(0);\r\n    }\r\n  }\r\n  \r\n  public detach() {\r\n    if(this.detached) {\r\n      return;\r\n    }\r\n    //return;\r\n\r\n    this.detached = true;\r\n\r\n    //return;\r\n    \r\n    if(this.preloader && this.preloader.parentElement) {\r\n      /* setTimeout(() =>  *///fastRaf(() => {\r\n        /* if(!this.detached) return;\r\n        this.detached = true; */\r\n\r\n        // fastRaf(() => {\r\n          //console.log('[PP]: detach after rAF', this.detached, performance.now());\r\n\r\n          // if(!this.detached || !this.preloader.parentElement) {\r\n          //   return;\r\n          // }\r\n\r\n          SetTransition(this.preloader, 'is-visible', false, TRANSITION_TIME, () => {\r\n            this.preloader.remove();\r\n          }, 1);\r\n        // });\r\n      //})/* , 5e3) */;\r\n    }\r\n  }\r\n  \r\n  public setProgress(percents: number) {\r\n    if(!this.totalLength && !isInDOM(this.circle)) {\r\n      return;\r\n    }\r\n    \r\n    if(percents === 0) {\r\n      this.circle.style.strokeDasharray = '';\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      if(!this.totalLength) {\r\n        this.totalLength = this.circle.getTotalLength();\r\n      }\r\n\r\n      //console.log('setProgress', (percents / 100 * totalLength));\r\n      this.circle.style.strokeDasharray = '' + Math.max(5, percents / 100 * this.totalLength) + ', ' + this.totalLength;\r\n    } catch(err) {}\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport deferredPromise, { CancellablePromise } from \"./cancellablePromise\";\r\nimport { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport { fastRaf } from \"./schedulers\";\r\nimport { ArgumentTypes } from \"../types\";\r\n\r\ntype HeavyQueue<T extends HeavyQueue<any>> = {\r\n  items: ArgumentTypes<T['process']>[], \r\n  process: (...args: any[]) => ReturnType<T['process']>,\r\n  context: any,\r\n  promise?: CancellablePromise<ReturnType<T['process']>[]>\r\n};\r\nconst heavyQueue: HeavyQueue<any>[] = [];\r\nlet processingQueue = false;\r\n\r\nexport default function addHeavyTask<T extends HeavyQueue<T>>(queue: T, method: 'push' | 'unshift' = 'push') {\r\n  if(!queue.items.length) {\r\n    return Promise.resolve([]) as typeof promise;\r\n  }\r\n  \r\n  const promise = queue.promise = deferredPromise();\r\n  heavyQueue[method](queue);\r\n  processHeavyQueue();\r\n\r\n  return promise;\r\n}\r\n\r\nfunction processHeavyQueue() {\r\n  if(!processingQueue) {\r\n    const queue = heavyQueue.shift();\r\n    timedChunk(queue).finally(() => {\r\n      processingQueue = false;\r\n      if(heavyQueue.length) {\r\n        processHeavyQueue();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction timedChunk<T extends HeavyQueue<T>>(queue: HeavyQueue<T>) {\r\n  if(!queue.items.length) {\r\n    queue.promise.resolve([] as any);\r\n    return Promise.resolve([]);\r\n  }\r\n\r\n  const todo = queue.items.slice();\r\n  const results: ReturnType<T['process']>[] = [];\r\n\r\n  return new Promise<typeof results>((resolve, reject) => {\r\n    const f = async() => {\r\n      const start = performance.now();\r\n\r\n      do {\r\n        await getHeavyAnimationPromise();\r\n        const possiblePromise = queue.process.apply(queue.context, todo.shift());\r\n        let realResult: typeof results[0];\r\n        // @ts-ignore\r\n        if(possiblePromise instanceof Promise) {\r\n          try {\r\n            realResult = await possiblePromise;\r\n          } catch(err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n        } else {\r\n          realResult = possiblePromise;\r\n        }\r\n\r\n        results.push(realResult);\r\n      } while(todo.length > 0 && (performance.now() - start) < 6);\r\n\r\n      if(todo.length > 0) {\r\n        fastRaf(f);\r\n        //setTimeout(f, 25);\r\n      } else {\r\n        resolve(results);\r\n      }\r\n    };\r\n\r\n    fastRaf(f);\r\n    //setTimeout(f, 25);\r\n  }).then(queue.promise.resolve, queue.promise.reject);\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type fastBlur from '../vendor/fastBlur';\r\nimport addHeavyTask from './heavyQueue';\r\nimport IS_CANVAS_FILTER_SUPPORTED from '../environment/canvasFilterSupport';\r\n\r\nconst RADIUS = 2;\r\nconst ITERATIONS = 2;\r\n\r\nlet requireBlurPromise: Promise<any>;\r\nlet fastBlurFunc: typeof fastBlur;\r\nif(!IS_CANVAS_FILTER_SUPPORTED) {\r\n  requireBlurPromise = import('../vendor/fastBlur').then((m) => {\r\n    fastBlurFunc = m.default;\r\n  });\r\n} else {\r\n  requireBlurPromise = Promise.resolve();\r\n}\r\n\r\nfunction processBlurNext(\r\n  img: HTMLImageElement, \r\n  radius: number, \r\n  iterations: number, \r\n  canvas: HTMLCanvasElement = document.createElement('canvas')\r\n) {\r\n  canvas.width = img.width;\r\n  canvas.height = img.height;\r\n\r\n  const ctx = canvas.getContext('2d', {alpha: false});\r\n  if(IS_CANVAS_FILTER_SUPPORTED) {\r\n    ctx.filter = `blur(${radius}px)`;\r\n    ctx.drawImage(img, -radius * 2, -radius * 2, canvas.width + radius * 4, canvas.height + radius * 4);\r\n  } else {\r\n    ctx.drawImage(img, 0, 0);\r\n    fastBlurFunc(ctx, 0, 0, canvas.width, canvas.height, radius, iterations);\r\n  }\r\n\r\n  return canvas;\r\n}\r\n\r\ntype CacheValue = {canvas: HTMLCanvasElement, promise: Promise<void>};\r\nconst cache: Map<string, CacheValue> = new Map();\r\nconst CACHE_SIZE = 150;\r\n\r\nexport default function blur(dataUri: string, radius: number = RADIUS, iterations: number = ITERATIONS) {\r\n  if(!dataUri) {\r\n    throw 'no dataUri for blur: ' + dataUri;\r\n  }\r\n\r\n  if(cache.size > CACHE_SIZE) {\r\n    cache.clear();\r\n  }\r\n\r\n  const canvas = document.createElement('canvas');\r\n  canvas.className = 'canvas-thumbnail';\r\n  \r\n  let cached = cache.get(dataUri);\r\n  if(!cached) {\r\n    const promise: CacheValue['promise'] = new Promise((resolve) => {\r\n      //return resolve(dataUri);\r\n      requireBlurPromise.then(() => {\r\n        const img = new Image();\r\n        img.onload = () => {\r\n          // if(IS_CANVAS_FILTER_SUPPORTED) {\r\n            // resolve(processBlurNext(img, radius, iterations));\r\n          // } else {\r\n            const promise = addHeavyTask({\r\n              items: [[img, radius, iterations, canvas]],\r\n              context: null,\r\n              process: processBlurNext\r\n            }, 'unshift');\r\n            \r\n            promise.then(() => {\r\n              resolve();\r\n            });\r\n          // }\r\n        };\r\n        img.src = dataUri;\r\n      });\r\n    });\r\n  \r\n    cache.set(dataUri, cached = {\r\n      canvas,\r\n      promise\r\n    });\r\n  } else {\r\n    canvas.width = cached.canvas.width;\r\n    canvas.height = cached.canvas.height;\r\n    cached.promise.then(() => {\r\n      canvas.getContext('2d').drawImage(cached.canvas, 0, 0, canvas.width, canvas.height);\r\n    });\r\n  }\r\n\r\n  return {\r\n    ...cached,\r\n    canvas\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport bytesFromHex from \"./bytesFromHex\";\r\nimport bytesToDataURL from \"./bytesToDataURL\";\r\n\r\nconst JPEG_HEADER = bytesFromHex('ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00');\r\nconst JPEG_TAIL = bytesFromHex('ffd9');\r\n\r\nexport default function getPreviewURLFromBytes(bytes: Uint8Array | number[], isSticker = false) {\r\n  let arr: Uint8Array;\r\n  if(!isSticker) {\r\n    arr = new Uint8Array(JPEG_HEADER.concat(Array.from(bytes.slice(3)), JPEG_TAIL));\r\n    arr[164] = bytes[1];\r\n    arr[166] = bytes[2];\r\n  } else {\r\n    arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);\r\n  }\r\n\r\n  let mimeType: string;\r\n  if(isSticker) {\r\n    mimeType = IS_SAFARI ? 'image/png' : 'image/webp';\r\n  } else {\r\n    mimeType = 'image/jpeg';\r\n  }\r\n\r\n  return bytesToDataURL(arr, mimeType);\r\n}\r\n","export default function bytesToDataURL(bytes: Uint8Array, mimeType: string = 'image/jpeg') {\r\n  return `data:${mimeType};base64,${btoa(String.fromCharCode(...bytes))}`;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { PhotoSize } from \"../layer\";\r\n// import appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport getPreviewURLFromBytes from \"./bytes/getPreviewURLFromBytes\";\r\n\r\nexport default function getPreviewURLFromThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, isSticker = false) {\r\n  // const cacheContext = appDownloadManager.getCacheContext(photo, thumb.type);\r\n  // return cacheContext.url || (cacheContext.url = getPreviewURLFromBytes(thumb.bytes, isSticker));\r\n  return getPreviewURLFromBytes(thumb.bytes, isSticker);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PhotoSize } from \"../layer\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { renderImageFromUrlPromise } from \"./dom/renderImageFromUrl\";\r\nimport getPreviewURLFromThumb from \"./getPreviewURLFromThumb\";\r\nimport blur from './blur';\r\n\r\nexport default function getImageFromStrippedThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, useBlur: boolean) {\r\n  const url = getPreviewURLFromThumb(photo, thumb, false);\r\n\r\n  let element: HTMLImageElement | HTMLCanvasElement, loadPromise: Promise<void>;\r\n  if(!useBlur) {\r\n    element = new Image();\r\n    loadPromise = renderImageFromUrlPromise(element, url);\r\n  } else {\r\n    const result = blur(url);\r\n    element = result.canvas;\r\n    loadPromise = result.promise;\r\n  }\r\n\r\n  element.classList.add('thumbnail');\r\n  \r\n  return {image: element, loadPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport type { ThumbCache } from \"../lib/storages/thumbs\";\r\nimport getImageFromStrippedThumb from \"./getImageFromStrippedThumb\";\r\n\r\nexport default function getStrippedThumbIfNeeded(photo: MyPhoto | MyDocument, cacheContext: ThumbCache, useBlur: boolean, ignoreCache = false) {\r\n  if(!cacheContext.downloaded || (['video', 'gif'] as MyDocument['type'][]).includes((photo as MyDocument).type) || ignoreCache) {\r\n    if(photo._ === 'document' && cacheContext.downloaded && !ignoreCache) {\r\n      return null;\r\n    }\r\n\r\n    const sizes = (photo as MyPhoto).sizes || (photo as MyDocument).thumbs;\r\n    const thumb = sizes?.length ? sizes.find((size) => size._ === 'photoStrippedSize') : null;\r\n    if(thumb && ('bytes' in thumb)) {\r\n      return getImageFromStrippedThumb(photo, thumb as any, useBlur);\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PhotoSize } from \"../layer\";\r\nimport { REPLIES_HIDDEN_CHANNEL_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { MediaSize, makeMediaSize } from \"./mediaSize\";\r\n\r\nexport default function setAttachmentSize(\r\n  photo: MyPhoto | MyDocument, \r\n  element: HTMLElement | SVGForeignObjectElement, \r\n  boxWidth: number, \r\n  boxHeight: number, \r\n  noZoom = true, \r\n  message?: any,\r\n  pushDocumentSize?: boolean,\r\n  photoSize?: ReturnType<typeof choosePhotoSize>\r\n) {\r\n  if(!photoSize) {\r\n    photoSize = choosePhotoSize(photo, boxWidth, boxHeight, undefined, pushDocumentSize);\r\n  }\r\n  //console.log('setAttachmentSize', photo, photo.sizes[0].bytes, div);\r\n  \r\n  let size: MediaSize;\r\n  const isDocument = photo._ === 'document';\r\n  if(isDocument) {\r\n    size = makeMediaSize((photo as MyDocument).w || (photoSize as PhotoSize.photoSize).w || 512, (photo as MyDocument).h || (photoSize as PhotoSize.photoSize).h || 512);\r\n  } else {\r\n    size = makeMediaSize((photoSize as PhotoSize.photoSize).w || 100, (photoSize as PhotoSize.photoSize).h || 100);\r\n  }\r\n\r\n  let boxSize = makeMediaSize(boxWidth, boxHeight);\r\n\r\n  boxSize = size = size.aspect(boxSize, noZoom);\r\n\r\n  let isFit = true;\r\n\r\n  if(!isDocument || ['video', 'gif'].includes((photo as MyDocument).type)) {\r\n    if(boxSize.width < 200 && boxSize.height < 200) { // make at least one side this big\r\n      boxSize = size = size.aspectCovered(makeMediaSize(200, 200));\r\n    }\r\n\r\n    if(message && \r\n      (message.message || \r\n        message.reply_to_mid || \r\n        message.media.webpage || \r\n        (message.replies && message.replies.pFlags.comments && message.replies.channel_id.toChatId() !== REPLIES_HIDDEN_CHANNEL_ID)\r\n      )\r\n    ) { // make sure that bubble block is human-readable\r\n      if(boxSize.width < 320) {\r\n        boxSize = makeMediaSize(320, boxSize.height);\r\n        isFit = false;\r\n      }\r\n    }\r\n\r\n    if(isFit && boxSize.width < 120 && message) { // if image is too narrow\r\n      boxSize = makeMediaSize(120, boxSize.height);\r\n      isFit = false;\r\n    }\r\n  }\r\n\r\n  // if(element instanceof SVGForeignObjectElement) {\r\n  //   element.setAttributeNS(null, 'width', '' + w);\r\n  //   element.setAttributeNS(null, 'height', '' + h);\r\n\r\n  //   //console.log('set dimensions to svg element:', element, w, h);\r\n  // } else {\r\n    element.style.width = boxSize.width + 'px';\r\n    element.style.height = boxSize.height + 'px';\r\n  // }\r\n  \r\n  return {photoSize, size, isFit};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport renderImageWithFadeIn from \"../../helpers/dom/renderImageWithFadeIn\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { Message, PhotoSize } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../../lib/appManagers/appPhotosManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport blur from '../../helpers/blur';\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getStrippedThumbIfNeeded from \"../../helpers/getStrippedThumbIfNeeded\";\r\nimport setAttachmentSize from \"../../helpers/setAttachmentSize\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\n\r\nexport default async function wrapPhoto({photo, message, container, boxWidth, boxHeight, withTail, isOut, lazyLoadQueue, middleware, size, withoutPreloader, loadPromises, autoDownloadSize, noBlur, noThumb, noFadeIn, blurAfter, managers = rootScope.managers}: {\r\n  photo: MyPhoto | MyDocument, \r\n  message?: Message.message | Message.messageService, \r\n  container: HTMLElement, \r\n  boxWidth?: number, \r\n  boxHeight?: number, \r\n  withTail?: boolean, \r\n  isOut?: boolean, \r\n  lazyLoadQueue?: LazyLoadQueue, \r\n  middleware?: () => boolean, \r\n  size?: PhotoSize,\r\n  withoutPreloader?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  noBlur?: boolean,\r\n  noThumb?: boolean,\r\n  noFadeIn?: boolean,\r\n  blurAfter?: boolean,\r\n  managers?: AppManagers,\r\n}) {\r\n  if(!((photo as MyPhoto).sizes || (photo as MyDocument).thumbs)) {\r\n    if(boxWidth && boxHeight && !size && photo._ === 'document') {\r\n      setAttachmentSize(photo, container, boxWidth, boxHeight, undefined, message);\r\n    }\r\n\r\n    return {\r\n      loadPromises: {\r\n        thumb: Promise.resolve(),\r\n        full: Promise.resolve()\r\n      },\r\n      images: {\r\n        thumb: null,\r\n        full: null\r\n      },\r\n      preloader: null,\r\n      aspecter: null\r\n    };\r\n  }\r\n\r\n  let noAutoDownload = autoDownloadSize === 0;\r\n\r\n  if(!size) {\r\n    if(boxWidth === undefined) boxWidth = mediaSizes.active.regular.width;\r\n    if(boxHeight === undefined) boxHeight = mediaSizes.active.regular.height;\r\n  }\r\n\r\n  container.classList.add('media-container');\r\n  let aspecter = container;\r\n\r\n  let isFit = true;\r\n  let loadThumbPromise: Promise<any> = Promise.resolve();\r\n  let thumbImage: HTMLImageElement | HTMLCanvasElement;\r\n  let image: HTMLImageElement;\r\n  let cacheContext: ThumbCache;\r\n  const isGif = photo._ === 'document' && photo.mime_type === 'image/gif' && !size;\r\n  // if(withTail) {\r\n  //   image = wrapMediaWithTail(photo, message, container, boxWidth, boxHeight, isOut);\r\n  // } else {\r\n    image = new Image();\r\n\r\n    if(boxWidth && boxHeight && !size) { // !album\r\n      const set = setAttachmentSize(photo, container, boxWidth, boxHeight, undefined, message, undefined, isGif ? {\r\n        _: 'photoSize',\r\n        w: photo.w,\r\n        h: photo.h,\r\n        size: photo.size,\r\n        type: 'full'\r\n      } : undefined);\r\n      size = set.photoSize;\r\n      isFit = set.isFit;\r\n      cacheContext = await managers.thumbsStorage.getCacheContext(photo, size.type);\r\n\r\n      if(!isFit) {\r\n        aspecter = document.createElement('div');\r\n        aspecter.classList.add('media-container-aspecter');\r\n        aspecter.style.width = set.size.width + 'px';\r\n        aspecter.style.height = set.size.height + 'px';\r\n\r\n        const gotThumb = getStrippedThumbIfNeeded(photo, cacheContext, !noBlur, true);\r\n        if(gotThumb) {\r\n          loadThumbPromise = gotThumb.loadPromise;\r\n          const thumbImage = gotThumb.image; // local scope\r\n          thumbImage.classList.add('media-photo');\r\n          container.append(thumbImage);\r\n        } else {\r\n          const res = await wrapPhoto({\r\n            container,\r\n            message,\r\n            photo,\r\n            boxWidth: 0,\r\n            boxHeight: 0,\r\n            size,\r\n            lazyLoadQueue,\r\n            isOut,\r\n            loadPromises,\r\n            middleware,\r\n            withoutPreloader,\r\n            withTail,\r\n            autoDownloadSize,\r\n            noBlur,\r\n            noThumb: true,\r\n            blurAfter: true,\r\n            managers\r\n            //noFadeIn: true\r\n          });\r\n          const thumbImage = res.images.full;\r\n          thumbImage.classList.add('media-photo', 'thumbnail');\r\n          //container.append(thumbImage);\r\n        }\r\n\r\n        container.classList.add('media-container-fitted');\r\n        container.append(aspecter);\r\n      }\r\n    } else {\r\n      if(!size) {\r\n        size = choosePhotoSize(photo, boxWidth, boxHeight, true);\r\n      }\r\n      \r\n      cacheContext = await managers.thumbsStorage.getCacheContext(photo, size?.type);\r\n    }\r\n\r\n    if(!noThumb) {\r\n      const gotThumb = getStrippedThumbIfNeeded(photo, cacheContext, !noBlur);\r\n      if(gotThumb) {\r\n        loadThumbPromise = Promise.all([loadThumbPromise, gotThumb.loadPromise]);\r\n        thumbImage = gotThumb.image;\r\n        thumbImage.classList.add('media-photo');\r\n        aspecter.append(thumbImage);\r\n      }\r\n    }\r\n  // }\r\n\r\n  image.classList.add('media-photo');\r\n  \r\n  //console.log('wrapPhoto downloaded:', photo, photo.downloaded, container);\r\n\r\n  const needFadeIn = (thumbImage || !cacheContext.downloaded) && rootScope.settings.animationsEnabled && !noFadeIn;\r\n\r\n  let preloader: ProgressivePreloader;\r\n  const uploadingFileName = (message as Message.message)?.uploadingFileName;\r\n  if(!withoutPreloader) {\r\n    if(!cacheContext.downloaded || uploadingFileName) {\r\n      preloader = new ProgressivePreloader({\r\n        attachMethod: 'prepend',\r\n        isUpload: !!uploadingFileName\r\n      });\r\n    }\r\n\r\n    if(uploadingFileName) { // means upload\r\n      preloader.attachPromise(appDownloadManager.getUpload(uploadingFileName));\r\n      preloader.attach(container);\r\n      noAutoDownload = undefined;\r\n    }\r\n  }\r\n  \r\n\r\n  const getDownloadPromise = () => {\r\n    // const promise = isGif && !size ? \r\n    //   managers.appDocsManager.downloadDoc(photo, /* undefined,  */lazyLoadQueue?.queueId) : \r\n    //   managers.appPhotosManager.preloadPhoto(photo, size, lazyLoadQueue?.queueId, noAutoDownload);\r\n    const haveToDownload = isGif && !size;\r\n    const promise = appDownloadManager.downloadMediaURL({\r\n      media: photo,\r\n      thumb: size,\r\n      queueId: lazyLoadQueue?.queueId,\r\n      onlyCache: haveToDownload ? undefined : noAutoDownload\r\n    });\r\n\r\n    return promise;\r\n  };\r\n\r\n  const renderOnLoad = (url: string) => {\r\n    return renderImageWithFadeIn(container, image, url, needFadeIn, aspecter, thumbImage);\r\n  };\r\n\r\n  const onLoad = async(url: string) => {\r\n    if(middleware && !middleware()) return;\r\n\r\n    if(blurAfter) {\r\n      const result = blur(url, 12);\r\n      return result.promise.then(() => {\r\n        // image = result.canvas;\r\n        return renderOnLoad(result.canvas.toDataURL());\r\n      });\r\n    }\r\n\r\n    return renderOnLoad(url);\r\n  };\r\n\r\n  let loadPromise: Promise<any>;\r\n  const canAttachPreloader = (\r\n    (size as PhotoSize.photoSize).w >= 150 && \r\n    (size as PhotoSize.photoSize).h >= 150\r\n    ) || noAutoDownload;\r\n  const load = async() => {\r\n    if(noAutoDownload && !withoutPreloader && preloader) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n    }\r\n\r\n    const promise = getDownloadPromise();\r\n    const cacheContext = await managers.thumbsStorage.getCacheContext(photo, size?.type);\r\n    if(\r\n      preloader && \r\n      !cacheContext.downloaded && \r\n      !withoutPreloader && \r\n      canAttachPreloader\r\n    ) {\r\n      preloader.attach(container, false, promise);\r\n    }\r\n\r\n    noAutoDownload = undefined;\r\n\r\n    const renderPromise = promise.then(onLoad);\r\n    renderPromise.catch(() => {});\r\n    return {download: promise, render: renderPromise};\r\n  };\r\n\r\n  if(preloader) {\r\n    preloader.setDownloadFunction(load);\r\n  }\r\n  \r\n  if(cacheContext.downloaded) {\r\n    loadThumbPromise = loadPromise = (await load()).render;\r\n  } else {\r\n    if(!lazyLoadQueue) loadPromise = (await load()).render;\r\n    /* else if(noAutoDownload) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n      preloader.attach(container);\r\n    } */ else lazyLoadQueue.push({div: container, load: () => load().then(({download}) => download)});\r\n  }\r\n\r\n  if(loadPromises && loadThumbPromise) {\r\n    loadPromises.push(loadThumbPromise);\r\n  }\r\n\r\n  // const perf = performance.now();\r\n  await loadThumbPromise;\r\n\r\n  // const elapsedTime = performance.now() - perf;\r\n  // if(elapsedTime > 4) {\r\n  //   console.log('wrapping photo thumb time', elapsedTime, photo, size);\r\n  // }\r\n\r\n  return {\r\n    loadPromises: {\r\n      thumb: loadThumbPromise,\r\n      full: loadPromise || Promise.resolve()\r\n    },\r\n    images: {\r\n      thumb: thumbImage,\r\n      full: image\r\n    },\r\n    preloader,\r\n    aspecter\r\n  };\r\n}\r\n","export default function createVideo(options: {\r\n  pip?: boolean\r\n} = {}) {\r\n  const video = document.createElement('video');\r\n  if(!options.pip) video.disablePictureInPicture = true;\r\n  video.setAttribute('playsinline', 'true');\r\n  return video;\r\n}\r\n","// * Jolly Cobra's schedulers\r\n\r\nimport { AnyToVoidFunction } from \"../../types\";\r\nimport { fastRaf } from \"../schedulers\";\r\nimport throttleWith from \"./throttleWith\";\r\n\r\nexport default function throttleWithRaf<F extends AnyToVoidFunction>(fn: F) {\r\n  return throttleWith(fastRaf, fn);\r\n}\r\n","// * Jolly Cobra's schedulers\r\n\r\nimport { AnyToVoidFunction } from \"../../types\";\r\n\r\nexport default function throttleWith<F extends AnyToVoidFunction>(schedulerFn: AnyToVoidFunction, fn: F) {\r\n  let waiting = false;\r\n  let args: Parameters<F>;\r\n\r\n  return (..._args: Parameters<F>) => {\r\n    args = _args;\r\n\r\n    if (!waiting) {\r\n      waiting = true;\r\n\r\n      schedulerFn(() => {\r\n        waiting = false;\r\n        // @ts-ignore\r\n        fn(...args);\r\n      });\r\n    }\r\n  };\r\n}\r\n","export default function toHHMMSS(str: string | number, leadZero = false) {\r\n  const sec_num = parseInt(str + '', 10);\r\n  const hours = Math.floor(sec_num / 3600);\r\n  let minutes: any = Math.floor((sec_num - (hours * 3600)) / 60);\r\n  let seconds: any = sec_num - (hours * 3600) - (minutes * 60);\r\n  \r\n  if(hours) leadZero = true;\r\n  if(minutes < 10) minutes = leadZero ? \"0\" + minutes : minutes;\r\n  if(seconds < 10) seconds = \"0\" + seconds;\r\n  return (hours ? /* ('0' + hours).slice(-2) */hours + ':' : '') + minutes + ':' + seconds;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { MOUNT_CLASS_TO } from \"../../config/debug\";\r\n\r\nlet context: CanvasRenderingContext2D;\r\n/**\r\n * Get the text width\r\n * @param {string} text\r\n * @param {string} font\r\n */\r\nexport default function getTextWidth(text: string, font: string) {\r\n  // const perf = performance.now();\r\n  if(!context) {\r\n    const canvas = document.createElement('canvas');\r\n    context = canvas.getContext('2d');\r\n    context.font = font;\r\n  }\r\n\r\n  //context.font = font;\r\n  const metrics = context.measureText(text);\r\n  // console.log('getTextWidth perf:', performance.now() - perf);\r\n  return metrics.width;\r\n  //return Math.round(metrics.width);\r\n}\r\n\r\n// MOUNT_CLASS_TO && (MOUNT_CLASS_TO.getTextWidth = getTextWidth);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getTextWidth from \"../helpers/canvas/getTextWidth\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\n\r\n// Thanks to https://stackoverflow.com/a/49349813\r\n\r\n/**\r\n * Attibute modifier to create middle ellipsis\r\n * When the attribute value is left blank the ellipsis will be in the middle\r\n * When positive the attribute value will be used as a percentage\r\n * When negative the attribute value will be used as character index counted from the end\r\n * @example\r\n *   <div data-middle-ellipsis>A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"20\">A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"-3\">A Javascript solution to middle ellipsis</div>\r\n */\r\nconst ellipsis = '…';\r\nconst map: Map<HTMLElement, {\r\n  text: string,\r\n  textLength: number,\r\n  from: number,\r\n  multiplier: number,\r\n  font: string,\r\n  textWidth: number,\r\n  elementWidth: number\r\n}> = new Map();\r\n\r\nconst testQueue: Set<HTMLElement> = new Set();\r\nexport const fontFamily = 'Roboto, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen-Sans, Ubuntu, Cantarell, \"Helvetica Neue\", sans-serif';\r\nconst fontSize = '16px';\r\nlet pendingTest = false;\r\n\r\nfunction setTestQueue() {\r\n  if(pendingTest) {\r\n    return;\r\n  }\r\n\r\n  pendingTest = true;\r\n  fastRaf(() => {\r\n    pendingTest = false;\r\n    testQueueElements();\r\n  });\r\n}\r\n\r\nfunction testQueueElements() {\r\n  testQueue.forEach(testElement);\r\n  testQueue.clear();\r\n}\r\n\r\nwindow.addEventListener('resize', () => {\r\n  for(const [key] of map) {\r\n    testQueue.add(key);\r\n  }\r\n  \r\n  setTestQueue();\r\n}, {capture: true, passive: true});\r\n\r\nfunction getElementWidth(element: HTMLElement) {\r\n  const type = element.dataset.sizeType;\r\n  if(type) {\r\n    const mediaSize = mediaSizes.active;\r\n    // @ts-ignore\r\n    const size: MediaSize = mediaSize[type];\r\n    return size.width;\r\n  } \r\n  \r\n  return element.getBoundingClientRect().width;\r\n}\r\n\r\nfunction testElement(element: HTMLElement) {\r\n  //const perf = performance.now();\r\n  // do not recalculate variables a second time\r\n  let mapped = map.get(element);\r\n  const firstTime = !mapped;\r\n\r\n  let {text, textLength, from, multiplier, font, textWidth, elementWidth} = mapped || {};\r\n  //console.log('[MEE] testElement got mapped', mapped);\r\n\r\n  if(firstTime) {\r\n    text = element.textContent;\r\n    textLength = text.length;\r\n    from = /* parseFloat(element.getAttribute(attributeName)) ||  */50;\r\n    multiplier = from > 0 && from / 100;\r\n\r\n    //const perf = performance.now();\r\n    font = `${element.dataset.fontWeight || 400} ${fontSize} ${fontFamily}`;\r\n    /* const computedStyle = window.getComputedStyle(elm, null);\r\n    font = `${computedStyle.getPropertyValue('font-weight')} ${computedStyle.getPropertyValue('font-size')} ${computedStyle.getPropertyValue('font-family')}`; */\r\n    //console.log('testMiddleEllipsis get computed style:', performance.now() - perf, font);\r\n\r\n    textWidth = getTextWidth(text, font);\r\n    //const perf = performance.now();\r\n    elementWidth = getElementWidth(element);\r\n    //console.log('testMiddleEllipsis get offsetWidth:', performance.now() - perf, font);\r\n    mapped = {text, textLength, from, multiplier, font, textWidth, elementWidth};\r\n    map.set(element, mapped);\r\n\r\n    //console.log('[MEE] testElement map set', element);\r\n  }\r\n  \r\n  const newElementWidth = getElementWidth(element);\r\n  const widthChanged = firstTime || elementWidth !== newElementWidth;\r\n  !firstTime && widthChanged && (mapped.elementWidth = elementWidth = newElementWidth);\r\n  \r\n  if(widthChanged) {\r\n    if(textWidth > elementWidth) {\r\n      element.setAttribute('title', text);\r\n      let smallerText = text;\r\n      let smallerWidth = elementWidth;\r\n      while(smallerText.length > 3) {\r\n        let smallerTextLength = smallerText.length;\r\n        const half = multiplier &&\r\n          clamp(multiplier * smallerTextLength << 0, 1, smallerTextLength - 2) ||\r\n          Math.max(smallerTextLength + from - 1, 1);\r\n        const half1 = smallerText.substr(0, half).replace(/\\s*$/,'');\r\n        const half2 = smallerText.substr(half + 1).replace(/^\\s*/,'');\r\n        smallerText = half1 + half2;\r\n        smallerWidth = getTextWidth(smallerText + ellipsis, font);\r\n        if(smallerWidth < elementWidth) {\r\n          element.textContent = half1 + ellipsis + half2;\r\n          break;\r\n        }\r\n      }\r\n\r\n      // * set new width after cutting text\r\n      mapped.elementWidth = getElementWidth(element);\r\n      //mapped.textWidth = smallerWidth;\r\n    } else {\r\n      element.removeAttribute('title');\r\n    }\r\n  }\r\n\r\n  //console.log('testMiddleEllipsis for element:', elm, performance.now() - perf);\r\n}\r\n\r\nexport class MiddleEllipsisElement extends HTMLElement {\r\n  connectedCallback() {\r\n    //console.log('[MEE]: connectedCallback before', map.has(this), testQueue.has(this), map.size, this.textContent, map);\r\n\r\n    map.set(this, null);\r\n    if(this.dataset.sizeType) {\r\n      testElement(this);\r\n    } else {\r\n      testQueue.add(this);\r\n      setTestQueue();\r\n    }\r\n    //testElement(this);\r\n\r\n    //console.log('[MEE]: connectedCallback after', map.has(this), map.size, testQueue.has(this), testQueue.size);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    const deleted = map.delete(this);\r\n    testQueue.delete(this);\r\n    //console.log('[MEE]: disconnectedCallback', deleted, map.has(this), map.size, this.textContent, map);\r\n  }\r\n}\r\n\r\ncustomElements.define(\"middle-ellipsis-element\", MiddleEllipsisElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\n\r\nexport default function formatBytes(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return i18n('FileSize.B', [0]);\r\n\r\n  const k = 1024;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes: LangPackKey[] = ['FileSize.B', 'FileSize.KB', 'FileSize.MB', 'FileSize.GB'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return i18n(sizes[i], [parseFloat((bytes / Math.pow(k, i)).toFixed(dm))]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type GrabEvent = {x: number, y: number, isTouch?: boolean, event: TouchEvent | MouseEvent};\r\n\r\nexport default function attachGrabListeners(element: HTMLElement, \r\n  onStart: (position: GrabEvent) => void, \r\n  onMove: (position: GrabEvent) => void, \r\n  onEnd?: (position: GrabEvent) => void) {\r\n  // * Mouse\r\n  const onMouseMove = (event: MouseEvent) => {\r\n    onMove({x: event.pageX, y: event.pageY, event});\r\n  };\r\n\r\n  const onMouseUp = (event: MouseEvent) => {\r\n    document.removeEventListener('mousemove', onMouseMove);\r\n    element.addEventListener('mousedown', onMouseDown, {once: true});\r\n    onEnd && onEnd({x: event.pageX, y: event.pageY, event});\r\n  };\r\n\r\n  const onMouseDown = (event: MouseEvent) => {\r\n    if(event.button !== 0) {\r\n      element.addEventListener('mousedown', onMouseDown, {once: true});\r\n      return;\r\n    }\r\n\r\n    onStart({x: event.pageX, y: event.pageY, event});\r\n    onMouseMove(event);\r\n\r\n    document.addEventListener('mousemove', onMouseMove);\r\n    document.addEventListener('mouseup', onMouseUp, {once: true});\r\n  };\r\n\r\n  element.addEventListener('mousedown', onMouseDown, {once: true});\r\n\r\n  // * Touch\r\n  const onTouchMove = (event: TouchEvent) => {\r\n    event.preventDefault();\r\n    onMove({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n  };\r\n\r\n  const onTouchEnd = (event: TouchEvent) => {\r\n    document.removeEventListener('touchmove', onTouchMove);\r\n    element.addEventListener('touchstart', onTouchStart, {passive: false, once: true});\r\n    onEnd && onEnd({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n  };\r\n\r\n  const onTouchStart = (event: TouchEvent) => {\r\n    onStart({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n    onTouchMove(event);\r\n\r\n    document.addEventListener('touchmove', onTouchMove, {passive: false});\r\n    document.addEventListener('touchend', onTouchEnd, {passive: false, once: true});\r\n  };\r\n\r\n  element.addEventListener('touchstart', onTouchStart, {passive: false, once: true});\r\n\r\n  return () => {\r\n    element.removeEventListener('mousedown', onMouseDown);\r\n    document.removeEventListener('mousemove', onMouseMove);\r\n    document.removeEventListener('mouseup', onMouseUp);\r\n\r\n    element.removeEventListener('touchstart', onTouchStart);\r\n    document.removeEventListener('touchmove', onTouchMove);\r\n    document.removeEventListener('touchend', onTouchEnd);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport attachGrabListeners, { GrabEvent } from \"../helpers/dom/attachGrabListeners\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nexport default class RangeSelector {\r\n  public container: HTMLDivElement;\r\n  protected filled: HTMLDivElement;\r\n  protected seek: HTMLInputElement;\r\n\r\n  public mousedown = false;\r\n  protected rect: DOMRect;\r\n  protected _removeListeners: () => void;\r\n\r\n  private events: Partial<{\r\n    //onMouseMove: ProgressLine['onMouseMove'],\r\n    onMouseDown: RangeSelector['onMouseDown'],\r\n    onMouseUp: RangeSelector['onMouseUp'],\r\n    onScrub: (value: number) => void\r\n  }> = {};\r\n\r\n  protected decimals: number;\r\n\r\n  protected step: number;\r\n  protected min: number;\r\n  protected max: number;\r\n  protected withTransition = false;\r\n  protected useTransform = false;\r\n  protected vertical = false;\r\n\r\n  constructor(\r\n    options: {\r\n      step: RangeSelector['step'],\r\n      min: RangeSelector['min'],\r\n      max: RangeSelector['max'],\r\n      withTransition?: RangeSelector['withTransition'],\r\n      useTransform?: RangeSelector['useTransform'],\r\n      vertical?: RangeSelector['vertical']\r\n    }, \r\n    value = 0\r\n  ) {\r\n    safeAssign(this, options);\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('progress-line');\r\n\r\n    // there is no sense in using transition with transform, because it is updating every frame\r\n    if(this.useTransform) {\r\n      this.container.classList.add('use-transform');\r\n    } else if(this.withTransition) {\r\n      this.container.classList.add('with-transition');\r\n    }\r\n\r\n    this.filled = document.createElement('div');\r\n    this.filled.classList.add('progress-line__filled');\r\n\r\n    const seek = this.seek = document.createElement('input');\r\n    seek.classList.add('progress-line__seek');\r\n    //seek.setAttribute('max', '0');\r\n    seek.type = 'range';\r\n    seek.step = '' + this.step;\r\n    seek.min = '' + this.min;\r\n    seek.max = '' + this.max;\r\n    seek.value = '' + value;\r\n\r\n    if(value) {\r\n      this.setProgress(value);\r\n    }\r\n\r\n    const stepStr = '' + this.step;\r\n    const index = stepStr.indexOf('.');\r\n    this.decimals = index === -1 ? 0 : stepStr.length - index - 1;\r\n\r\n    //this.setListeners();\r\n\r\n    this.container.append(this.filled, seek);\r\n  }\r\n\r\n  get value() {\r\n    return +this.seek.value;\r\n  }\r\n\r\n  public setHandlers(events: RangeSelector['events']) {\r\n    this.events = events;\r\n  }\r\n\r\n  protected onMouseMove = (event: GrabEvent) => {\r\n    this.scrub(event);\r\n  };\r\n\r\n  protected onMouseDown = (event: GrabEvent) => {\r\n    this.rect = this.container.getBoundingClientRect();\r\n    this.mousedown = true;\r\n    this.scrub(event);\r\n    this.container.classList.add('is-focused');\r\n    this.events?.onMouseDown && this.events.onMouseDown(event);\r\n  };\r\n\r\n  protected onMouseUp = (event: GrabEvent) => {\r\n    this.mousedown = false;\r\n    this.container.classList.remove('is-focused');\r\n    this.events?.onMouseUp && this.events.onMouseUp(event);\r\n  };\r\n\r\n  public setListeners() {\r\n    this.seek.addEventListener('input', this.onInput);\r\n    this._removeListeners = attachGrabListeners(this.container, this.onMouseDown, this.onMouseMove, this.onMouseUp);\r\n  }\r\n\r\n  public onInput = () => {\r\n    const value = +this.seek.value;\r\n    this.setFilled(value);\r\n    this.events?.onScrub && this.events.onScrub(value);\r\n  };\r\n\r\n  public setProgress(value: number) {\r\n    this.seek.value = '' + value;\r\n    this.setFilled(+this.seek.value); // clamp\r\n  }\r\n\r\n  public addProgress(value: number) {\r\n    this.seek.value = '' + (+this.seek.value + value);\r\n    this.setFilled(+this.seek.value); // clamp\r\n  }\r\n\r\n  public setFilled(value: number) {\r\n    let percents = (value - this.min) / (this.max - this.min);\r\n    percents = clamp(percents, 0, 1);\r\n    \r\n    // using scaleX and width even with vertical because it will be rotated\r\n    if(this.useTransform) {\r\n      this.filled.style.transform = `scaleX(${percents})`;\r\n    } else {\r\n      this.filled.style.width = (percents * 100) + '%';\r\n    }\r\n  }\r\n\r\n  protected scrub(event: GrabEvent) {\r\n    const rectMax = this.vertical ? this.rect.height : this.rect.width;\r\n    const offsetAxisValue = clamp(this.vertical ? -(event.y - this.rect.bottom) : event.x - this.rect.left, 0, rectMax);\r\n\r\n    let value = this.min + (offsetAxisValue / rectMax * (this.max - this.min));\r\n\r\n    if((value - this.min) < ((this.max - this.min) / 2)) {\r\n      value -= this.step / 10;\r\n    }\r\n    \r\n    value = +value.toFixed(this.decimals);\r\n    value = clamp(value, this.min, this.max);\r\n\r\n    //this.seek.value = '' + value;\r\n    //this.onInput();\r\n\r\n    this.setProgress(value);\r\n    this.events?.onScrub && this.events.onScrub(value);\r\n\r\n    return value;\r\n  }\r\n\r\n  public removeListeners() {\r\n    if(this._removeListeners) {\r\n      this._removeListeners();\r\n      this._removeListeners = null;\r\n    }\r\n\r\n    this.seek.removeEventListener('input', this.onInput);\r\n    \r\n    this.events = {};\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GrabEvent } from \"../helpers/dom/attachGrabListeners\";\r\nimport appMediaPlaybackController from \"./appMediaPlaybackController\";\r\nimport RangeSelector from \"./rangeSelector\";\r\n\r\nexport default class MediaProgressLine extends RangeSelector {\r\n  protected filledLoad: HTMLDivElement;\r\n\r\n  protected progressRAF = 0;\r\n\r\n  protected media: HTMLMediaElement;\r\n  protected streamable: boolean;\r\n\r\n  constructor(media?: HTMLAudioElement | HTMLVideoElement, streamable?: boolean, withTransition?: boolean, useTransform?: boolean) {\r\n    super({\r\n      step: 1000 / 60 / 1000, \r\n      min: 0, \r\n      max: 1, \r\n      withTransition, \r\n      useTransform\r\n    }, 0);\r\n\r\n    if(media) {\r\n      this.setMedia(media, streamable);\r\n    }\r\n  }\r\n\r\n  public setMedia(media: HTMLMediaElement, streamable = false) {\r\n    if(this.media) {\r\n      this.removeListeners();\r\n    }\r\n\r\n    if(streamable && !this.filledLoad) {\r\n      this.filledLoad = document.createElement('div');\r\n      this.filledLoad.classList.add('progress-line__filled', 'progress-line__loaded');\r\n      this.container.prepend(this.filledLoad);\r\n      //this.setLoadProgress();\r\n    } else if(this.filledLoad) {\r\n      this.filledLoad.classList.toggle('hide', !streamable);\r\n    }\r\n\r\n    this.media = media;\r\n    this.streamable = streamable;\r\n    if(!media.paused || media.currentTime > 0) {\r\n      this.onPlay();\r\n    }\r\n\r\n    let wasPlaying = false;\r\n    this.setSeekMax();\r\n    this.setListeners();\r\n    this.setHandlers({\r\n      onMouseDown: () => {\r\n        wasPlaying = !this.media.paused;\r\n        wasPlaying && this.media.pause();\r\n      },\r\n\r\n      onMouseUp: (e) => {\r\n        // cancelEvent(e.event);\r\n        wasPlaying && this.media.play();\r\n      }\r\n    });\r\n  }\r\n\r\n  protected onLoadedData = () => {\r\n    this.max = this.media.duration;\r\n    this.seek.setAttribute('max', '' + this.max);\r\n  };\r\n\r\n  protected onEnded = () => {\r\n    this.setProgress();\r\n  };\r\n\r\n  protected onPlay = () => {\r\n    let r = () => {\r\n      this.setProgress();\r\n\r\n      this.progressRAF = this.media.paused ? 0 : window.requestAnimationFrame(r);\r\n    };\r\n\r\n    if(this.progressRAF) {\r\n      window.cancelAnimationFrame(this.progressRAF);\r\n    }\r\n\r\n    if(this.streamable) {\r\n      this.setLoadProgress();\r\n    }\r\n\r\n    this.progressRAF = window.requestAnimationFrame(r);\r\n  };\r\n\r\n  protected onTimeUpdate = () => {\r\n    if(this.media.paused) {\r\n      this.setProgress();\r\n\r\n      if(this.streamable) {\r\n        this.setLoadProgress();\r\n      }\r\n    }\r\n  };\r\n\r\n  protected onProgress = (e: Event) => {\r\n    this.setLoadProgress();\r\n  };\r\n\r\n  protected scrub(e: GrabEvent) {\r\n    const scrubTime = super.scrub(e);\r\n    this.media.currentTime = scrubTime;\r\n    return scrubTime;\r\n  }\r\n\r\n  protected setLoadProgress() {\r\n    if(appMediaPlaybackController.isSafariBuffering(this.media)) return;\r\n    const buf = this.media.buffered;\r\n    const numRanges = buf.length;\r\n\r\n    const currentTime = this.media.currentTime;\r\n    let nearestStart = 0, end = 0;\r\n    for(let i = 0; i < numRanges; ++i) {\r\n      const start = buf.start(i);\r\n      if(currentTime >= start && start >= nearestStart) {\r\n        nearestStart = start;\r\n        end = buf.end(i);\r\n      }\r\n\r\n      //console.log('onProgress range:', i, buf.start(i), buf.end(i), this.media);\r\n    }\r\n\r\n    //console.log('onProgress correct range:', nearestStart, end, this.media);\r\n\r\n    const percents = this.media.duration ? end / this.media.duration : 0;\r\n    this.filledLoad.style.width = (percents * 100) + '%';\r\n    //this.filledLoad.style.transform = 'scaleX(' + percents + ')';\r\n  }\r\n\r\n  protected setSeekMax() {\r\n    this.max = this.media.duration || 0;\r\n    if(this.max > 0) {\r\n      this.onLoadedData();\r\n    } else {\r\n      this.media.addEventListener('loadeddata', this.onLoadedData);\r\n    }\r\n  }\r\n\r\n  public setProgress() {\r\n    if(appMediaPlaybackController.isSafariBuffering(this.media)) return;\r\n    const currentTime = this.media.currentTime;\r\n\r\n    super.setProgress(currentTime);\r\n  }\r\n\r\n  public setListeners() {\r\n    super.setListeners();\r\n    this.media.addEventListener('ended', this.onEnded);\r\n    this.media.addEventListener('play', this.onPlay);\r\n    this.media.addEventListener('timeupdate', this.onTimeUpdate);\r\n    this.streamable && this.media.addEventListener('progress', this.onProgress);\r\n  }\r\n\r\n  public removeListeners() {\r\n    super.removeListeners();\r\n\r\n    if(this.media) {\r\n      this.media.removeEventListener('loadeddata', this.onLoadedData);\r\n      this.media.removeEventListener('ended', this.onEnded);\r\n      this.media.removeEventListener('play', this.onPlay);\r\n      this.media.removeEventListener('timeupdate', this.onTimeUpdate);\r\n      this.streamable && this.media.removeEventListener('progress', this.onProgress);\r\n    }\r\n\r\n    if(this.progressRAF) {\r\n      window.cancelAnimationFrame(this.progressRAF);\r\n      this.progressRAF = 0;\r\n    }\r\n  }\r\n}\r\n","import { Message } from \"../../../../layer\";\r\nimport type { MyMessage } from \"../../appMessagesManager\";\r\n\r\nexport default function getMessageSenderPeerIdOrName(message: MyMessage) {\r\n  if(message.fromId) {\r\n    return {\r\n      peerId: message.fromId\r\n    };\r\n  } else {\r\n    return {\r\n      fromName: (message as Message.message).fwd_from?.from_name\r\n    };\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { i18n } from \"../lib/langPack\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport limitSymbols from \"../helpers/string/limitSymbols\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport getPeerTitle from \"./wrappers/getPeerTitle\";\r\n\r\nexport type PeerTitleOptions = {\r\n  peerId?: PeerId,\r\n  fromName?: string,\r\n  plainText?: boolean,\r\n  onlyFirstName?: boolean,\r\n  dialog?: boolean,\r\n  limitSymbols?: number,\r\n  managers?: AppManagers\r\n};\r\n\r\nconst weakMap: WeakMap<HTMLElement, PeerTitle> = new WeakMap();\r\n\r\nrootScope.addEventListener('peer_title_edit', (peerId) => {\r\n  const elements = Array.from(document.querySelectorAll(`.peer-title[data-peer-id=\"${peerId}\"]`)) as HTMLElement[];\r\n  elements.forEach((element) => {\r\n    const peerTitle = weakMap.get(element);\r\n    //console.log('in the summer silence i was doing nothing', peerTitle, peerId);\r\n\r\n    if(peerTitle) {\r\n      peerTitle.update();\r\n    }\r\n  });\r\n});\r\n\r\nexport default class PeerTitle {\r\n  public element: HTMLElement;\r\n  public peerId: PeerId;\r\n  private fromName: string;\r\n  private plainText = false;\r\n  private onlyFirstName = false;\r\n  private dialog = false;\r\n  private limitSymbols: number;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options?: PeerTitleOptions) {\r\n    this.element = document.createElement('span');\r\n    this.element.classList.add('peer-title');\r\n    this.element.setAttribute('dir', 'auto');\r\n\r\n    if(options) {\r\n      this.update(options);\r\n    }\r\n    \r\n    weakMap.set(this.element, this);\r\n  }\r\n\r\n  public setOptions(options?: PeerTitleOptions) {\r\n    if(!options) {\r\n      return;\r\n    }\r\n\r\n    for(const i in options) {\r\n      // @ts-ignore\r\n      const value = options[i];\r\n\r\n      if(typeof(value) !== 'object') {\r\n        // @ts-ignore\r\n        this.element.dataset[i] = value ? '' + (typeof(value) === 'boolean' ? +value : value) : '0';\r\n      }\r\n\r\n      // @ts-ignore\r\n      this[i] = value;\r\n    }\r\n  }\r\n\r\n  public async update(options?: PeerTitleOptions) {\r\n    this.setOptions(options);\r\n\r\n    let fromName = this.fromName;\r\n    if(fromName !== undefined) {\r\n      if(this.limitSymbols !== undefined) {\r\n        fromName = limitSymbols(fromName, this.limitSymbols, this.limitSymbols);\r\n      }\r\n\r\n      setInnerHTML(this.element, wrapEmojiText(fromName));\r\n      return;\r\n    }\r\n\r\n    if(this.peerId === undefined) {\r\n      this.peerId = NULL_PEER_ID;\r\n    }\r\n\r\n    if(this.peerId !== rootScope.myId || !this.dialog) {\r\n      const managers = this.managers ?? rootScope.managers;\r\n      setInnerHTML(this.element, await getPeerTitle(this.peerId, this.plainText, this.onlyFirstName, this.limitSymbols, managers));\r\n    } else {\r\n      replaceContent(this.element, i18n(this.onlyFirstName ? 'Saved' : 'SavedMessages'));\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport getMessageSenderPeerIdOrName from \"../../lib/appManagers/utils/messages/getMessageSenderPeerIdOrName\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default async function wrapSenderToPeer(message: MyMessage) {\r\n  const senderTitle: HTMLElement = document.createElement('span');\r\n  senderTitle.classList.add('sender-title');\r\n  \r\n  const fromMe = message.fromId === rootScope.myId && message.peerId !== rootScope.myId;\r\n  senderTitle.append(\r\n    fromMe ? \r\n      i18n('FromYou') : \r\n      new PeerTitle({\r\n        ...getMessageSenderPeerIdOrName(message),\r\n        dialog: message.peerId === rootScope.myId\r\n      }).element\r\n    );\r\n\r\n  if(await rootScope.managers.appPeersManager.isAnyGroup(message.peerId) || fromMe) {\r\n    const peerTitle = new PeerTitle({peerId: message.peerId}).element;\r\n    senderTitle.append(' ➝ ', peerTitle);\r\n  }\r\n\r\n  return senderTitle;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatDateAccordingToTodayNew } from \"../../helpers/date\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\n\r\nexport default function wrapSentTime(message: MyMessage) {\r\n  const el: HTMLElement = document.createElement('span');\r\n  el.classList.add('sent-time');\r\n  el.append(formatDateAccordingToTodayNew(new Date(message.date * 1000)));\r\n\r\n  return el;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { wrapPhoto } from \"./wrappers\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport appMediaPlaybackController, { MediaItem, MediaSearchContext } from \"./appMediaPlaybackController\";\r\nimport { DocumentAttribute, Message } from \"../layer\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport { IS_SAFARI } from \"../environment/userAgent\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport deferredPromise, { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport ListenerSetter, { Listener } from \"../helpers/listenerSetter\";\r\nimport noop from \"../helpers/noop\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport { joinElementsWith } from \"../lib/langPack\";\r\nimport { MiddleEllipsisElement } from \"./middleEllipsis\";\r\nimport { formatFullSentTime } from \"../helpers/date\";\r\nimport throttleWithRaf from \"../helpers/schedulers/throttleWithRaf\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport formatBytes from \"../helpers/formatBytes\";\r\nimport { animateSingle } from \"../helpers/animation\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport MediaProgressLine from \"./mediaProgressLine\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapSenderToPeer from \"./wrappers/senderToPeer\";\r\nimport wrapSentTime from \"./wrappers/sentTime\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\n\r\nrootScope.addEventListener('messages_media_read', ({mids, peerId}) => {\r\n  mids.forEach((mid) => {\r\n    const attr = `[data-mid=\"${mid}\"][data-peer-id=\"${peerId}\"]`;\r\n    (Array.from(document.querySelectorAll(`audio-element.is-unread${attr}, .media-round.is-unread${attr}`)) as AudioElement[]).forEach((elem) => {\r\n      elem.classList.remove('is-unread');\r\n    });\r\n  });\r\n});\r\n\r\n// https://github.com/LonamiWebs/Telethon/blob/4393ec0b83d511b6a20d8a20334138730f084375/telethon/utils.py#L1285\r\nexport function decodeWaveform(waveform: Uint8Array | number[]) {\r\n  if(!(waveform instanceof Uint8Array)) {\r\n    waveform = new Uint8Array(waveform);\r\n  }\r\n\r\n  const bitCount = waveform.length * 8;\r\n  const valueCount = bitCount / 5 | 0;\r\n  if(!valueCount) {\r\n    return new Uint8Array([]);\r\n  }\r\n\r\n  let result: Uint8Array;\r\n  try {\r\n    const dataView = new DataView(waveform.buffer);\r\n    result = new Uint8Array(valueCount);\r\n    for(let i = 0; i < valueCount; i++) {\r\n      const byteIndex = i * 5 / 8 | 0;\r\n      const bitShift = i * 5 % 8;\r\n      const value = dataView.getUint16(byteIndex, true);\r\n      result[i] = (value >> bitShift) & 0b00011111;\r\n    }\r\n  } catch(err) {\r\n    result = new Uint8Array([]);\r\n  }\r\n\r\n  /* var byteIndex = (valueCount - 1) / 8 | 0;\r\n  var bitShift = (valueCount - 1) % 8;\r\n  if(byteIndex === waveform.length - 1) {\r\n    var value = waveform[byteIndex];\r\n  } else {\r\n    var value = dataView.getUint16(byteIndex, true);\r\n  }\r\n  console.log('decoded waveform, setting last value:', value, byteIndex, bitShift);\r\n  result[valueCount - 1] = (value >> bitShift) & 0b00011111; */\r\n  return result;\r\n}\r\n\r\nfunction createWaveformBars(waveform: Uint8Array, duration: number) {\r\n  const barWidth = 2;\r\n  const barMargin = 2;      //mediaSizes.isMobile ? 2 : 1;\r\n  const barHeightMin = 4;   //mediaSizes.isMobile ? 3 : 2;\r\n  const barHeightMax = mediaSizes.isMobile ? 16 : 23;\r\n  // const availW = 150;       //mediaSizes.isMobile ? 152 : 190;\r\n\r\n  const minW = mediaSizes.isMobile ? 152 : 190;\r\n  const maxW = mediaSizes.isMobile ? 190 : 256;\r\n  const availW = clamp(duration / 60 * maxW, minW, maxW); // mediaSizes.isMobile ? 152 : 224;\r\n\r\n  const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n  svg.classList.add('audio-waveform-bars');\r\n  svg.setAttributeNS(null, 'width', '' + availW);\r\n  svg.setAttributeNS(null, 'height', '' + barHeightMax);\r\n  svg.setAttributeNS(null, 'viewBox', `0 0 ${availW} ${barHeightMax}`);\r\n\r\n  //console.log('decoded waveform:', waveform);\r\n\r\n  const normValue = Math.max(...waveform);\r\n  const wfSize = waveform.length ? waveform.length : 100;\r\n  const barCount = Math.min((availW / (barWidth + barMargin)) | 0, wfSize);\r\n\r\n  let maxValue = 0;\r\n  const maxDelta = barHeightMax - barHeightMin;\r\n\r\n  let html = '';\r\n  for(let i = 0, barX = 0, sumI = 0; i < wfSize; ++i) {\r\n    const value = waveform[i] || 0;\r\n    if((sumI + barCount) >= wfSize) { // draw bar\r\n      sumI = sumI + barCount - wfSize;\r\n\t\t\tif(sumI < (barCount + 1) / 2) {\r\n\t\t\t\tif(maxValue < value) maxValue = value;\r\n      }\r\n      \r\n      const bar_value = Math.max(((maxValue * maxDelta) + ((normValue + 1) / 2)) / (normValue + 1), barHeightMin);\r\n      \r\n      const h = `\r\n      <rect x=\"${barX}\" y=\"${barHeightMax - bar_value}\" width=\"${barWidth}\" height=\"${bar_value}\" rx=\"1\" ry=\"1\"></rect>\r\n      `;\r\n      html += h;\r\n\r\n      barX += barWidth + barMargin;\r\n\r\n      if(sumI < (barCount + 1) / 2) {\r\n        maxValue = 0;\r\n      } else {\r\n        maxValue = value;\r\n      }\r\n    } else {\r\n      if(maxValue < value) maxValue = value;\r\n\r\n      sumI += barCount;\r\n    }\r\n  }\r\n\r\n  const container = document.createElement('div');\r\n  container.classList.add('audio-waveform');\r\n  container.append(svg);\r\n\r\n  svg.insertAdjacentHTML('beforeend', html);\r\n  return {svg, container, availW};\r\n}\r\n\r\nasync function wrapVoiceMessage(audioEl: AudioElement) {\r\n  audioEl.classList.add('is-voice');\r\n\r\n  const message = audioEl.message;\r\n  const doc = getMediaFromMessage(message) as MyDocument;\r\n\r\n  if(message.pFlags.out) {\r\n    audioEl.classList.add('is-out');\r\n  }\r\n\r\n  let waveform = (doc.attributes.find((attribute) => attribute._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio).waveform || new Uint8Array([]);\r\n  waveform = decodeWaveform(waveform.slice(0, 63));\r\n  \r\n  const {svg, container: svgContainer, availW} = createWaveformBars(waveform, doc.duration);\r\n  \r\n  const fakeSvgContainer = svgContainer.cloneNode(true) as HTMLElement;\r\n  fakeSvgContainer.classList.add('audio-waveform-fake');\r\n  svgContainer.classList.add('audio-waveform-background');\r\n\r\n  const waveformContainer = document.createElement('div');\r\n  waveformContainer.classList.add('audio-waveform-container');\r\n  waveformContainer.append(svgContainer, fakeSvgContainer);\r\n\r\n  const timeDiv = document.createElement('div');\r\n  timeDiv.classList.add('audio-time');\r\n  audioEl.append(waveformContainer, timeDiv);\r\n\r\n  let progress = svg as any as HTMLElement;\r\n  \r\n  const onLoad = () => {\r\n    let audio = audioEl.audio;\r\n\r\n    const setAnimation = () => {\r\n      animateSingle(() => {\r\n        if(!audio) return false;\r\n        onTimeUpdate();\r\n        return !audio.paused;\r\n      }, audioEl);\r\n    };\r\n\r\n    const onTimeUpdate = () => {\r\n      fakeSvgContainer.style.width = (audio.currentTime / audio.duration * 100) + '%';\r\n    };\r\n\r\n    if(!audio.paused || (audio.currentTime > 0 && audio.currentTime !== audio.duration)) {\r\n      onTimeUpdate();\r\n    }\r\n\r\n    const throttledTimeUpdate = throttleWithRaf(onTimeUpdate);\r\n    audioEl.addAudioListener('timeupdate', throttledTimeUpdate);\r\n    audioEl.addAudioListener('ended', throttledTimeUpdate);\r\n    audioEl.addAudioListener('play', setAnimation);\r\n\r\n    audioEl.readyPromise.then(() => {\r\n      let mousedown = false, mousemove = false;\r\n      progress.addEventListener('mouseleave', (e) => {\r\n        if(mousedown) {\r\n          audio.play();\r\n          mousedown = false;\r\n        }\r\n        mousemove = false;\r\n      })\r\n      progress.addEventListener('mousemove', (e) => {\r\n        mousemove = true;\r\n        if(mousedown) scrub(e);\r\n      });\r\n      progress.addEventListener('mousedown', (e) => {\r\n        e.preventDefault();\r\n        if(e.button !== 0) return;\r\n        if(!audio.paused) {\r\n          audio.pause();\r\n        }\r\n        \r\n        scrub(e);\r\n        mousedown = true;\r\n      });\r\n      progress.addEventListener('mouseup', (e) => {\r\n        if(mousemove && mousedown) {\r\n          audio.play();\r\n          mousedown = false;\r\n        }\r\n      });\r\n      attachClickEvent(progress, (e) => {\r\n        cancelEvent(e);\r\n        if(!audio.paused) scrub(e);\r\n      });\r\n      \r\n      function scrub(e: MouseEvent | TouchEvent) {\r\n        let offsetX: number;\r\n        if(e instanceof MouseEvent) {\r\n          offsetX = e.offsetX;\r\n        } else { // touch\r\n          const rect = (e.target as HTMLElement).getBoundingClientRect();\r\n          offsetX = e.targetTouches[0].pageX - rect.left;\r\n        }\r\n        \r\n        const scrubTime = offsetX / availW /* width */ * audio.duration;\r\n        audio.currentTime = scrubTime;\r\n      }\r\n    }, noop);\r\n    \r\n    return () => {\r\n      progress.remove();\r\n      progress = null;\r\n      audio = null;\r\n    };\r\n  };\r\n\r\n  return onLoad;\r\n}\r\n\r\nasync function wrapAudio(audioEl: AudioElement) {\r\n  const withTime = audioEl.withTime;\r\n\r\n  const message = audioEl.message;\r\n  const doc = getMediaFromMessage(message) as MyDocument;\r\n\r\n  const isVoice = doc.type === 'voice' || doc.type === 'round';\r\n  const descriptionEl = document.createElement('div');\r\n  descriptionEl.classList.add('audio-description');\r\n\r\n  const audioAttribute = doc.attributes.find((attr) => attr._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio;\r\n  \r\n  if(!isVoice) {\r\n    const parts: (Node | string)[] = [];\r\n    if(audioAttribute?.performer) {\r\n      parts.push(wrapEmojiText(audioAttribute.performer));\r\n    }\r\n\r\n    if(withTime) {\r\n      parts.push(formatFullSentTime(message.date));\r\n    } else if(!parts.length) {\r\n      parts.push(formatBytes(doc.size));\r\n    }\r\n\r\n    if(audioEl.showSender) {\r\n      parts.push(await wrapSenderToPeer(message));\r\n    }\r\n\r\n    descriptionEl.append(...joinElementsWith(parts, ' • '));\r\n  }\r\n\r\n  const html = `\r\n  <div class=\"audio-details\">\r\n    <div class=\"audio-title\"></div>\r\n    <div class=\"audio-subtitle\"><div class=\"audio-time\"></div></div>\r\n  </div>`;\r\n  audioEl.insertAdjacentHTML('beforeend', html);\r\n\r\n  const titleEl = audioEl.querySelector('.audio-title') as HTMLElement;\r\n\r\n  const middleEllipsisEl = new MiddleEllipsisElement();\r\n  middleEllipsisEl.dataset.fontWeight = audioEl.dataset.fontWeight;\r\n  middleEllipsisEl.dataset.sizeType = audioEl.dataset.sizeType;\r\n  if(isVoice) {\r\n    middleEllipsisEl.append(await wrapSenderToPeer(message));\r\n  } else {\r\n    setInnerHTML(middleEllipsisEl, wrapEmojiText(audioAttribute?.title ?? doc.file_name));\r\n  }\r\n\r\n  titleEl.append(middleEllipsisEl);\r\n\r\n  if(audioEl.showSender) {\r\n    titleEl.append(wrapSentTime(message));\r\n  }\r\n  \r\n  const subtitleDiv = audioEl.querySelector('.audio-subtitle') as HTMLDivElement;\r\n  subtitleDiv.append(descriptionEl);\r\n\r\n  const onLoad = () => {\r\n    let launched = false;\r\n\r\n    let progressLine = new MediaProgressLine(audioEl.audio, doc.supportsStreaming);\r\n\r\n    audioEl.addAudioListener('ended', () => {\r\n      audioEl.classList.remove('audio-show-progress');\r\n      // Reset subtitle\r\n      subtitleDiv.lastChild.replaceWith(descriptionEl);\r\n      launched = false;\r\n    });\r\n\r\n    const onPlay = () => {\r\n      if(!launched) {\r\n        audioEl.classList.add('audio-show-progress');\r\n        launched = true;\r\n\r\n        if(progressLine) {\r\n          subtitleDiv.lastChild.replaceWith(progressLine.container);\r\n        }\r\n      }\r\n    };\r\n\r\n    audioEl.addAudioListener('play', onPlay);\r\n\r\n    if(!audioEl.audio.paused || audioEl.audio.currentTime > 0) {\r\n      onPlay();\r\n    }\r\n\r\n    return () => {\r\n      progressLine.removeListeners();\r\n      progressLine.container.remove();\r\n      progressLine = null;\r\n    };\r\n  };\r\n\r\n  return onLoad;\r\n}\r\n\r\nfunction constructDownloadPreloader(tryAgainOnFail = true) {\r\n  const preloader = new ProgressivePreloader({cancelable: true, tryAgainOnFail});\r\n  preloader.construct();\r\n\r\n  if(!tryAgainOnFail) {\r\n    preloader.circle.setAttributeNS(null, 'r', '23');\r\n    preloader.totalLength = 143.58203125;\r\n  }\r\n\r\n  return preloader;\r\n}\r\n\r\nexport const findMediaTargets = (anchor: HTMLElement, anchorMid: number/* , useSearch: boolean */) => {\r\n  let prev: MediaItem[], next: MediaItem[];\r\n  // if(anchor.classList.contains('search-super-item') || !useSearch) {\r\n    const isBubbles = !anchor.classList.contains('search-super-item');\r\n    const container = findUpClassName(anchor, !isBubbles ? 'tabs-tab' : 'bubbles-inner');\r\n    if(container) {\r\n      const attr = `:not([data-is-outgoing=\"1\"])`;\r\n      const justAudioSelector = `.audio:not(.is-voice)${attr}`;\r\n      let selectors: string[];\r\n      if(!anchor.matches(justAudioSelector)) {\r\n        selectors = [`.audio.is-voice${attr}`, `.media-round${attr}`];\r\n      } else {\r\n        selectors = [justAudioSelector];\r\n      }\r\n\r\n      if(isBubbles) {\r\n        const prefix = '.bubble:not(.webpage) ';\r\n        selectors = selectors.map((s) => prefix + s);\r\n      }\r\n\r\n      const selector = selectors.join(', ');\r\n\r\n      const elements = Array.from(container.querySelectorAll(selector)) as HTMLElement[];\r\n      const idx = elements.indexOf(anchor);\r\n\r\n      const mediaItems: MediaItem[] = elements.map((element) => ({peerId: element.dataset.peerId.toPeerId(), mid: +element.dataset.mid}));\r\n\r\n      prev = mediaItems.slice(0, idx);\r\n      next = mediaItems.slice(idx + 1);\r\n    }\r\n  // }\r\n\r\n  if((next.length && next[0].mid < anchorMid) || (prev.length && prev[prev.length - 1].mid > anchorMid)) {\r\n    [prev, next] = [next.reverse(), prev.reverse()];\r\n  }\r\n\r\n  // prev = next = undefined;\r\n\r\n  return [prev, next];\r\n};\r\n\r\nexport default class AudioElement extends HTMLElement {\r\n  public audio: HTMLAudioElement;\r\n  public preloader: ProgressivePreloader;\r\n  public message: Message.message;\r\n  public withTime = false;\r\n  public voiceAsMusic = false;\r\n  public searchContext: MediaSearchContext;\r\n  public showSender = false;\r\n  public noAutoDownload: boolean;\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public loadPromises: Promise<any>[];\r\n  public managers: AppManagers;\r\n\r\n  private listenerSetter = new ListenerSetter();\r\n  private onTypeDisconnect: () => void;\r\n  public onLoad: (autoload?: boolean) => void;\r\n  public readyPromise: CancellablePromise<void>;\r\n\r\n  public async render() {\r\n    this.classList.add('audio');\r\n    this.managers = rootScope.managers;\r\n\r\n    this.dataset.mid = '' + this.message.mid;\r\n    this.dataset.peerId = '' + this.message.peerId;\r\n\r\n    const doc = getMediaFromMessage(this.message) as MyDocument;\r\n    const isRealVoice = doc.type === 'voice';\r\n    const isVoice = !this.voiceAsMusic && isRealVoice;\r\n    const isOutgoing = this.message.pFlags.is_outgoing;\r\n    const uploadingFileName = this.message?.uploadingFileName;\r\n\r\n    const durationStr = toHHMMSS(doc.duration | 0);\r\n\r\n    this.innerHTML = `\r\n    <div class=\"audio-toggle audio-ico\">\r\n      <div class=\"audio-play-icon\">\r\n        <div class=\"part one\" x=\"0\" y=\"0\" fill=\"#fff\"></div>\r\n        <div class=\"part two\" x=\"0\" y=\"0\" fill=\"#fff\"></div>\r\n      </div>\r\n    </div>`;\r\n\r\n    const toggle = this.firstElementChild as HTMLElement;\r\n\r\n    const downloadDiv = document.createElement('div');\r\n    downloadDiv.classList.add('audio-download');\r\n\r\n    const isUnread = doc.type !== 'audio' && this.message && this.message.pFlags.media_unread;\r\n    if(isUnread) {\r\n      this.classList.add('is-unread');\r\n    }\r\n\r\n    if(uploadingFileName) {\r\n      this.classList.add('is-outgoing');\r\n      this.append(downloadDiv);\r\n    }\r\n\r\n    const onTypeLoad = await (isVoice ? wrapVoiceMessage(this) : wrapAudio(this));\r\n    \r\n    const audioTimeDiv = this.querySelector('.audio-time') as HTMLDivElement;\r\n    audioTimeDiv.innerHTML = durationStr;\r\n\r\n    const onLoad = this.onLoad = (autoload: boolean) => {\r\n      this.onLoad = undefined;\r\n\r\n      const audio = this.audio = appMediaPlaybackController.addMedia(this.message, autoload);\r\n\r\n      const readyPromise = this.readyPromise = deferredPromise<void>();\r\n      if(this.audio.readyState >= this.audio.HAVE_CURRENT_DATA) readyPromise.resolve();\r\n      else {\r\n        this.addAudioListener('canplay', () => readyPromise.resolve(), {once: true});\r\n      }\r\n\r\n      this.onTypeDisconnect = onTypeLoad();\r\n      \r\n      const getTimeStr = () => toHHMMSS(audio.currentTime | 0) + (isVoice ? (' / ' + durationStr) : '');\r\n\r\n      const onPlay = () => {\r\n        audioTimeDiv.innerText = getTimeStr();\r\n        toggle.classList.toggle('playing', !audio.paused);\r\n      };\r\n\r\n      if(!audio.paused || (audio.currentTime > 0 && audio.currentTime !== audio.duration)) {\r\n        onPlay();\r\n      }\r\n\r\n      const togglePlay = (e?: Event, paused = audio.paused) => {\r\n        e && cancelEvent(e);\r\n\r\n        if(paused) {\r\n          const hadSearchContext = !!this.searchContext;\r\n          if(appMediaPlaybackController.setSearchContext(this.searchContext || {\r\n            peerId: NULL_PEER_ID, \r\n            inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n            useSearch: false\r\n          })) {\r\n            const [prev, next] = !hadSearchContext ? [] : findMediaTargets(this, this.message.mid/* , this.searchContext.useSearch */);\r\n            appMediaPlaybackController.setTargets({peerId: this.message.peerId, mid: this.message.mid}, prev, next);\r\n          }\r\n\r\n          audio.play().catch(() => {});\r\n        } else {\r\n          audio.pause();\r\n        }\r\n      };\r\n\r\n      attachClickEvent(toggle, (e) => togglePlay(e), {listenerSetter: this.listenerSetter});\r\n\r\n      this.addAudioListener('ended', () => {\r\n        toggle.classList.remove('playing');\r\n        audioTimeDiv.innerText = durationStr;\r\n      });\r\n\r\n      this.addAudioListener('timeupdate', () => {\r\n        if((!audio.currentTime && audio.paused) || appMediaPlaybackController.isSafariBuffering(audio)) return;\r\n        audioTimeDiv.innerText = getTimeStr();\r\n      });\r\n\r\n      this.addAudioListener('pause', () => {\r\n        toggle.classList.remove('playing');\r\n      });\r\n\r\n      this.addAudioListener('play', onPlay);\r\n\r\n      return togglePlay;\r\n    };\r\n\r\n    if(doc.thumbs?.length) {\r\n      const imgs: HTMLElement[] = [];\r\n      const wrapped = await wrapPhoto({\r\n        photo: doc, \r\n        message: null, \r\n        container: toggle, \r\n        boxWidth: 48, \r\n        boxHeight: 48,\r\n        loadPromises: this.loadPromises,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue: this.lazyLoadQueue\r\n      });\r\n      toggle.style.width = toggle.style.height = '';\r\n      if(wrapped.images.thumb) imgs.push(wrapped.images.thumb);\r\n      if(wrapped.images.full) imgs.push(wrapped.images.full);\r\n\r\n      this.classList.add('audio-with-thumb');\r\n      imgs.forEach((img) => img.classList.add('audio-thumb'));\r\n    }\r\n\r\n    if(!isOutgoing) {\r\n      let preloader: ProgressivePreloader = this.preloader;\r\n\r\n      const autoDownload = doc.type !== 'audio'/*  || !this.noAutoDownload */;\r\n      onLoad(autoDownload);\r\n\r\n      const r = (shouldPlay: boolean) => {\r\n        if(this.audio.src) {\r\n          return;\r\n        }\r\n\r\n        appMediaPlaybackController.resolveWaitingForLoadMedia(this.message.peerId, this.message.mid, this.message.pFlags.is_scheduled);\r\n\r\n        const onDownloadInit = () => {\r\n          if(shouldPlay) {\r\n            appMediaPlaybackController.willBePlayed(this.audio); // prepare for loading audio\r\n  \r\n            if(IS_SAFARI && !this.audio.autoplay) {\r\n              this.audio.autoplay = true;\r\n            }\r\n          }\r\n        };\r\n\r\n        onDownloadInit();\r\n\r\n        if(!preloader) {\r\n          if(doc.supportsStreaming) {\r\n            this.classList.add('corner-download');\r\n\r\n            let pauseListener: Listener;\r\n            const onPlay = () => {\r\n              const preloader = constructDownloadPreloader(false);\r\n              const deferred = deferredPromise<void>();\r\n              deferred.notifyAll({done: 75, total: 100});\r\n              deferred.catch(() => {\r\n                this.audio.pause();\r\n                appMediaPlaybackController.willBePlayed(undefined);\r\n              });\r\n              deferred.cancel = () => {\r\n                deferred.cancel = noop;\r\n                const err = new Error();\r\n                (err as any).type = 'CANCELED';\r\n                deferred.reject(err);\r\n              };\r\n              preloader.attach(downloadDiv, false, deferred);\r\n\r\n              pauseListener = this.addAudioListener('pause', () => {\r\n                deferred.cancel();\r\n              }, {once: true}) as any;\r\n\r\n              onDownloadInit();\r\n            };\r\n\r\n            /* if(!this.audio.paused) {\r\n              onPlay();\r\n            } */\r\n\r\n            const playListener: any = this.addAudioListener('play', onPlay);\r\n            this.readyPromise.then(() => {\r\n              this.listenerSetter.remove(playListener);\r\n              this.listenerSetter.remove(pauseListener);\r\n            });\r\n          } else {\r\n            preloader = constructDownloadPreloader();\r\n\r\n            if(!shouldPlay) {\r\n              this.readyPromise = deferredPromise();\r\n            }\r\n\r\n            const load = () => {\r\n              onDownloadInit();\r\n\r\n              const download = appDownloadManager.downloadMediaURL({media: doc});\r\n              \r\n              if(!shouldPlay) {\r\n                download.then(() => {\r\n                  this.readyPromise.resolve();\r\n                });\r\n              }\r\n\r\n              preloader.attach(downloadDiv, false, download);\r\n              return {download};\r\n            };\r\n\r\n            preloader.setDownloadFunction(load);\r\n            load();\r\n          }\r\n        }\r\n\r\n        if(this.classList.contains('corner-download')) {\r\n          toggle.append(downloadDiv);\r\n        } else {\r\n          this.append(downloadDiv);\r\n        }\r\n\r\n        this.classList.add('downloading');\r\n\r\n        this.readyPromise.then(() => {\r\n          this.classList.remove('downloading');\r\n          downloadDiv.classList.add('downloaded');\r\n          setTimeout(() => {\r\n            downloadDiv.remove();\r\n          }, 200);\r\n  \r\n          //setTimeout(() => {\r\n            // release loaded audio\r\n            if(appMediaPlaybackController.willBePlayedMedia === this.audio) {\r\n              this.audio.play();\r\n              appMediaPlaybackController.willBePlayed(undefined);\r\n            }\r\n          //}, 10e3);\r\n        });\r\n      };\r\n\r\n      if(!this.audio?.src) {\r\n        if(autoDownload) {\r\n          r(false);\r\n        } else {\r\n          attachClickEvent(toggle, () => {\r\n            r(true);\r\n          }, {once: true, capture: true, passive: false, listenerSetter: this.listenerSetter});\r\n        }\r\n      }\r\n    } else if(uploadingFileName) {\r\n      this.preloader = constructDownloadPreloader(false);\r\n      this.preloader.attachPromise(appDownloadManager.getUpload(uploadingFileName));\r\n      this.dataset.isOutgoing = '1';\r\n      this.preloader.attach(downloadDiv, false);\r\n      //onLoad();\r\n    }\r\n  }\r\n\r\n  get addAudioListener() {\r\n    return this.listenerSetter.add(this.audio);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    setTimeout(() => {\r\n      if(this.isConnected) {\r\n        return;\r\n      }\r\n      \r\n      if(this.onTypeDisconnect) {\r\n        this.onTypeDisconnect();\r\n        this.onTypeDisconnect = null;\r\n      }\r\n  \r\n      if(this.readyPromise) {\r\n        this.readyPromise.reject();\r\n      }\r\n  \r\n      if(this.listenerSetter) {\r\n        this.listenerSetter.removeAll();\r\n        this.listenerSetter = null;\r\n      }\r\n  \r\n      if(this.preloader) {\r\n        this.preloader = null;\r\n      }\r\n    }, 100);\r\n  }\r\n}\r\n\r\ncustomElements.define(\"audio-element\", AudioElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport { animateSingle } from \"../../helpers/animation\";\r\nimport { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport throttleWithRaf from \"../../helpers/schedulers/throttleWithRaf\";\r\nimport sequentialDom from \"../../helpers/sequentialDom\";\r\nimport toHHMMSS from \"../../helpers/string/toHHMMSS\";\r\nimport { Message, PhotoSize } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { NULL_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport appMediaPlaybackController, { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport { findMediaTargets } from \"../audio\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport wrapPhoto from './photo';\r\n\r\nconst MAX_VIDEO_AUTOPLAY_SIZE = 50 * 1024 * 1024; // 50 MB\r\n\r\nlet roundVideoCircumference = 0;\r\nmediaSizes.addEventListener('changeScreen', (from, to) => {\r\n  if(to === ScreenSize.mobile || from === ScreenSize.mobile) {\r\n    const elements = Array.from(document.querySelectorAll('.media-round .progress-ring')) as SVGSVGElement[];\r\n    const width = mediaSizes.active.round.width;\r\n    const halfSize = width / 2;\r\n    const radius = halfSize - 7;\r\n    roundVideoCircumference = 2 * Math.PI * radius;\r\n    elements.forEach((element) => {\r\n      element.setAttributeNS(null, 'width', '' + width);\r\n      element.setAttributeNS(null, 'height', '' + width);\r\n\r\n      const circle = element.firstElementChild as SVGCircleElement;\r\n      circle.setAttributeNS(null, 'cx', '' + halfSize);\r\n      circle.setAttributeNS(null, 'cy', '' + halfSize);\r\n      circle.setAttributeNS(null, 'r', '' + radius);\r\n\r\n      circle.style.strokeDasharray = roundVideoCircumference + ' ' + roundVideoCircumference;\r\n      circle.style.strokeDashoffset = '' + roundVideoCircumference;\r\n    });\r\n  }\r\n});\r\n\r\nexport default async function wrapVideo({doc, container, message, boxWidth, boxHeight, withTail, isOut, middleware, lazyLoadQueue, noInfo, group, onlyPreview, withoutPreloader, loadPromises, noPlayButton, size, searchContext, autoDownload, managers = rootScope.managers}: {\r\n  doc: MyDocument, \r\n  container?: HTMLElement, \r\n  message?: Message.message, \r\n  boxWidth?: number, \r\n  boxHeight?: number, \r\n  withTail?: boolean, \r\n  isOut?: boolean,\r\n  middleware?: () => boolean,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  noInfo?: true,\r\n  noPlayButton?: boolean,\r\n  group?: string,\r\n  onlyPreview?: boolean,\r\n  withoutPreloader?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownload?: ChatAutoDownloadSettings,\r\n  size?: PhotoSize,\r\n  searchContext?: MediaSearchContext,\r\n  managers?: AppManagers\r\n}) {\r\n  const autoDownloadSize = autoDownload?.video;\r\n  let noAutoDownload = autoDownloadSize === 0;\r\n  const isAlbumItem = !(boxWidth && boxHeight);\r\n  const canAutoplay = /* doc.sticker ||  */(\r\n    (\r\n      doc.type !== 'video' || (\r\n        doc.size <= MAX_VIDEO_AUTOPLAY_SIZE && \r\n        !isAlbumItem\r\n      )\r\n    ) && (doc.type === 'gif' ? rootScope.settings.autoPlay.gifs : rootScope.settings.autoPlay.videos)\r\n  );\r\n  let spanTime: HTMLElement, spanPlay: HTMLElement;\r\n\r\n  if(!noInfo) {\r\n    spanTime = document.createElement('span');\r\n    spanTime.classList.add('video-time');\r\n    container.append(spanTime);\r\n  \r\n    let needPlayButton = false;\r\n    if(doc.type !== 'gif') {\r\n      spanTime.innerText = toHHMMSS(doc.duration, false);\r\n\r\n      if(!noPlayButton && doc.type !== 'round') {\r\n        if(canAutoplay && !noAutoDownload) {\r\n          spanTime.classList.add('tgico', 'can-autoplay');\r\n        } else {\r\n          needPlayButton = true;\r\n        }\r\n      }\r\n    } else {\r\n      spanTime.innerText = 'GIF';\r\n\r\n      if(!canAutoplay && !noPlayButton) {\r\n        needPlayButton = true;\r\n        noAutoDownload = undefined;\r\n      }\r\n    }\r\n\r\n    if(needPlayButton) {\r\n      spanPlay = document.createElement('span');\r\n      spanPlay.classList.add('video-play', 'tgico-largeplay', 'btn-circle', 'position-center');\r\n      container.append(spanPlay);\r\n    }\r\n  }\r\n\r\n  let res: {\r\n    thumb?: typeof photoRes,\r\n    loadPromise: Promise<any>\r\n  } = {} as any;\r\n\r\n  if(doc.mime_type === 'image/gif') {\r\n    const photoRes = await wrapPhoto({\r\n      photo: doc, \r\n      message, \r\n      container, \r\n      boxWidth, \r\n      boxHeight, \r\n      withTail, \r\n      isOut, \r\n      lazyLoadQueue, \r\n      middleware,\r\n      withoutPreloader,\r\n      loadPromises,\r\n      autoDownloadSize,\r\n      size,\r\n      managers\r\n    });\r\n\r\n    res.thumb = photoRes;\r\n    res.loadPromise = photoRes.loadPromises.full;\r\n    return res;\r\n  }\r\n\r\n  /* const video = doc.type === 'round' ? appMediaPlaybackController.addMedia(doc, message.mid) as HTMLVideoElement : document.createElement('video');\r\n  if(video.parentElement) {\r\n    video.remove();\r\n  } */\r\n\r\n  let preloader: ProgressivePreloader; // it must be here, otherwise will get error before initialization in round onPlay\r\n\r\n  const video = createVideo();\r\n  video.classList.add('media-video');\r\n  video.muted = true;\r\n  if(doc.type === 'round') {\r\n    const divRound = document.createElement('div');\r\n    divRound.classList.add('media-round', 'z-depth-1');\r\n    divRound.dataset.mid = '' + message.mid;\r\n    divRound.dataset.peerId = '' + message.peerId;\r\n    (divRound as any).message = message;\r\n\r\n    const size = mediaSizes.active.round;\r\n    const halfSize = size.width / 2;\r\n    const strokeWidth = 3.5;\r\n    const radius = halfSize - (strokeWidth * 2);\r\n    divRound.innerHTML = `<svg class=\"progress-ring\" width=\"${size.width}\" height=\"${size.width}\" style=\"transform: rotate(-90deg);\">\r\n      <circle class=\"progress-ring__circle\" stroke=\"white\" stroke-opacity=\"0.3\" stroke-width=\"${strokeWidth}\" cx=\"${halfSize}\" cy=\"${halfSize}\" r=\"${radius}\" fill=\"transparent\"/>\r\n    </svg>`;\r\n\r\n    const circle = divRound.firstElementChild.firstElementChild as SVGCircleElement;\r\n    if(!roundVideoCircumference) {\r\n      roundVideoCircumference = 2 * Math.PI * radius;\r\n    }\r\n    circle.style.strokeDasharray = roundVideoCircumference + ' ' + roundVideoCircumference;\r\n    circle.style.strokeDashoffset = '' + roundVideoCircumference;\r\n    \r\n    spanTime.classList.add('tgico');\r\n\r\n    const isUnread = message.pFlags.media_unread;\r\n    if(isUnread) {\r\n      divRound.classList.add('is-unread');\r\n    }\r\n\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = canvas.height = doc.w/*  * window.devicePixelRatio */;\r\n\r\n    divRound.prepend(canvas, spanTime);\r\n    divRound.append(video);\r\n    container.append(divRound);\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    /* ctx.beginPath();\r\n    ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, Math.PI * 2);\r\n    ctx.clip(); */\r\n\r\n    const onLoad = () => {\r\n      const message: Message.message = (divRound as any).message;\r\n      const globalVideo = appMediaPlaybackController.addMedia(message, !noAutoDownload) as HTMLVideoElement;\r\n      const clear = () => {\r\n        (appImManager.chat.setPeerPromise || Promise.resolve()).finally(() => {\r\n          if(isInDOM(globalVideo)) {\r\n            return;\r\n          }\r\n  \r\n          globalVideo.removeEventListener('play', onPlay);\r\n          globalVideo.removeEventListener('timeupdate', throttledTimeUpdate);\r\n          globalVideo.removeEventListener('pause', onPaused);\r\n          globalVideo.removeEventListener('ended', onEnded);\r\n        });\r\n      };\r\n  \r\n      const onFrame = () => {\r\n        ctx.drawImage(globalVideo, 0, 0);\r\n  \r\n        const offset = roundVideoCircumference - globalVideo.currentTime / globalVideo.duration * roundVideoCircumference;\r\n        circle.style.strokeDashoffset = '' + offset;\r\n  \r\n        return !globalVideo.paused;\r\n      };\r\n\r\n      const onTimeUpdate = () => {\r\n        if(!globalVideo.duration) {\r\n          return;\r\n        }\r\n  \r\n        if(!isInDOM(globalVideo)) {\r\n          clear();\r\n          return;\r\n        }\r\n\r\n        if(globalVideo.paused) {\r\n          onFrame();\r\n        }\r\n  \r\n        spanTime.innerText = toHHMMSS(globalVideo.duration - globalVideo.currentTime, false);\r\n      };\r\n\r\n      const throttledTimeUpdate = throttleWithRaf(onTimeUpdate);\r\n  \r\n      const onPlay = () => {\r\n        video.classList.add('hide');\r\n        divRound.classList.remove('is-paused');\r\n        animateSingle(onFrame, canvas);\r\n  \r\n        if(preloader && preloader.preloader && preloader.preloader.classList.contains('manual')) {\r\n          preloader.onClick();\r\n        }\r\n      };\r\n  \r\n      const onPaused = () => {\r\n        if(!isInDOM(globalVideo)) {\r\n          clear();\r\n          return;\r\n        }\r\n  \r\n        divRound.classList.add('is-paused');\r\n      };\r\n  \r\n      const onEnded = () => {\r\n        video.classList.remove('hide');\r\n        divRound.classList.add('is-paused');\r\n        \r\n        video.currentTime = 0;\r\n        spanTime.innerText = toHHMMSS(globalVideo.duration, false);\r\n  \r\n        if(globalVideo.currentTime) {\r\n          globalVideo.currentTime = 0;\r\n        }\r\n      };\r\n  \r\n      globalVideo.addEventListener('play', onPlay);\r\n      globalVideo.addEventListener('timeupdate', throttledTimeUpdate);\r\n      globalVideo.addEventListener('pause', onPaused);\r\n      globalVideo.addEventListener('ended', onEnded);\r\n  \r\n      attachClickEvent(canvas, (e) => {\r\n        cancelEvent(e);\r\n  \r\n        // ! костыль\r\n        if(preloader && !preloader.detached) {\r\n          preloader.onClick();\r\n        }\r\n        \r\n        // ! can't use it here. on Safari iOS video won't start.\r\n        /* if(globalVideo.readyState < 2) {\r\n          return;\r\n        } */\r\n  \r\n        if(globalVideo.paused) {\r\n          const hadSearchContext = !!searchContext;\r\n          if(appMediaPlaybackController.setSearchContext(searchContext || {\r\n            peerId: NULL_PEER_ID, \r\n            inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n            useSearch: false\r\n          })) {\r\n            const [prev, next] = !hadSearchContext ? [] : findMediaTargets(divRound, message.mid/* , searchContext.useSearch */);\r\n            appMediaPlaybackController.setTargets({peerId: message.peerId, mid: message.mid}, prev, next);\r\n          }\r\n          \r\n          globalVideo.play();\r\n        } else {\r\n          globalVideo.pause();\r\n        }\r\n      });\r\n  \r\n      if(globalVideo.paused) {\r\n        if(globalVideo.duration && globalVideo.currentTime !== globalVideo.duration && globalVideo.currentTime > 0) {\r\n          onFrame();\r\n          onTimeUpdate();\r\n          video.classList.add('hide');\r\n        } else {\r\n          onPaused();\r\n        }\r\n      } else {\r\n        onPlay();\r\n      }\r\n    };\r\n\r\n    if(message.pFlags.is_outgoing) {\r\n      (divRound as any).onLoad = onLoad;\r\n      divRound.dataset.isOutgoing = '1';\r\n    } else {\r\n      onLoad();\r\n    }\r\n  } else {\r\n    video.autoplay = true; // для safari\r\n  }\r\n\r\n  let photoRes: Awaited<ReturnType<typeof wrapPhoto>>;\r\n  if(message) {\r\n    photoRes = await wrapPhoto({\r\n      photo: doc, \r\n      message, \r\n      container, \r\n      boxWidth, \r\n      boxHeight, \r\n      withTail, \r\n      isOut, \r\n      lazyLoadQueue, \r\n      middleware,\r\n      withoutPreloader: true,\r\n      loadPromises,\r\n      autoDownloadSize: autoDownload?.photo,\r\n      size,\r\n      managers\r\n    });\r\n\r\n    res.thumb = photoRes;\r\n\r\n    if((!canAutoplay && doc.type !== 'gif') || onlyPreview) {\r\n      res.loadPromise = photoRes.loadPromises.full;\r\n      return res;\r\n    }\r\n\r\n    if(withTail) {\r\n      const foreignObject = (photoRes.images.thumb || photoRes.images.full).parentElement;\r\n      video.width = +foreignObject.getAttributeNS(null, 'width');\r\n      video.height = +foreignObject.getAttributeNS(null, 'height');\r\n      foreignObject.append(video);\r\n    }\r\n  } else { // * gifs masonry\r\n    // const gotThumb = managers.appDocsManager.getThumb(doc, false);\r\n    // if(gotThumb) {\r\n    //   gotThumb.promise.then(() => {\r\n    //     video.poster = gotThumb.cacheContext.url;\r\n    //   });\r\n    // }\r\n  }\r\n\r\n  if(!video.parentElement && container) {\r\n    (photoRes?.aspecter || container).append(video);\r\n  }\r\n\r\n  let cacheContext: ThumbCache;\r\n  const getCacheContext = async() => {\r\n    return cacheContext = await managers.thumbsStorage.getCacheContext(doc);\r\n  };\r\n\r\n  await getCacheContext();\r\n\r\n  const uploadFileName = message?.uploadingFileName;\r\n  if(uploadFileName) { // means upload\r\n    preloader = new ProgressivePreloader({\r\n      attachMethod: 'prepend',\r\n      isUpload: true\r\n    });\r\n    preloader.attachPromise(appDownloadManager.getUpload(uploadFileName));\r\n    preloader.attach(container, false);\r\n    noAutoDownload = undefined;\r\n  } else if(!cacheContext.downloaded && !doc.supportsStreaming && !withoutPreloader) {\r\n    preloader = new ProgressivePreloader({\r\n      attachMethod: 'prepend'\r\n    });\r\n  } else if(doc.supportsStreaming) {\r\n    preloader = new ProgressivePreloader({\r\n      cancelable: false,\r\n      attachMethod: 'prepend'\r\n    });\r\n  }\r\n\r\n  const renderDeferred = deferredPromise<void>();\r\n  video.addEventListener('error', (e) => {\r\n    if(video.error.code !== 4) {\r\n      console.error(\"Error \" + video.error.code + \"; details: \" + video.error.message);\r\n    }\r\n    \r\n    if(preloader && !uploadFileName) {\r\n      preloader.detach();\r\n    }\r\n\r\n    if(!renderDeferred.isFulfilled) {\r\n      renderDeferred.resolve();\r\n    }\r\n  }, {once: true});\r\n\r\n  onMediaLoad(video).then(() => {\r\n    if(group) {\r\n      animationIntersector.addAnimation(video, group);\r\n    }\r\n\r\n    if(preloader && !uploadFileName) {\r\n      preloader.detach();\r\n    }\r\n\r\n    renderDeferred.resolve();\r\n  });\r\n\r\n  if(doc.type === 'video') {\r\n    const onTimeUpdate = () => {\r\n      if(!video.videoWidth) {\r\n        return;\r\n      }\r\n      \r\n      spanTime.innerText = toHHMMSS(video.duration - video.currentTime, false);\r\n    };\r\n\r\n    const throttledTimeUpdate = throttleWithRaf(onTimeUpdate);\r\n\r\n    video.addEventListener('timeupdate', throttledTimeUpdate);\r\n\r\n    if(spanPlay) {\r\n      video.addEventListener('timeupdate', () => {\r\n        sequentialDom.mutateElement(spanPlay, () => {\r\n          spanPlay.remove();\r\n        });\r\n      }, {once: true});\r\n    }\r\n  }\r\n\r\n  video.muted = true;\r\n  video.loop = true;\r\n  //video.play();\r\n  video.autoplay = true;\r\n\r\n  let loadPhotoThumbFunc = noAutoDownload && photoRes?.preloader?.loadFunc;\r\n  const load = async() => {\r\n    if(preloader && noAutoDownload && !withoutPreloader) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n    }\r\n\r\n    await getCacheContext();\r\n    let loadPromise: Promise<any> = Promise.resolve();\r\n    if((preloader && !uploadFileName) || withoutPreloader) {\r\n      if(!cacheContext.downloaded && !doc.supportsStreaming) {\r\n        const promise = loadPromise = managers.apiFileManager.downloadMediaURL({media: doc, queueId: lazyLoadQueue?.queueId, onlyCache: noAutoDownload});\r\n        if(preloader) {\r\n          preloader.attach(container, false, promise);\r\n        }\r\n      } else if(doc.supportsStreaming) {\r\n        if(noAutoDownload) {\r\n          loadPromise = Promise.reject();\r\n        } else if(!cacheContext.downloaded && preloader) { // * check for uploading video\r\n          preloader.attach(container, false, null);\r\n          video.addEventListener(IS_SAFARI ? 'timeupdate' : 'canplay', () => {\r\n            preloader.detach();\r\n          }, {once: true});\r\n        }\r\n      }\r\n    }\r\n\r\n    if(!noAutoDownload && loadPhotoThumbFunc) {\r\n      loadPhotoThumbFunc();\r\n      loadPhotoThumbFunc = null;\r\n    }\r\n\r\n    noAutoDownload = undefined;\r\n\r\n    loadPromise.then(async() => {\r\n      if(middleware && !middleware()) {\r\n        renderDeferred.resolve();\r\n        return;\r\n      }\r\n\r\n      if(doc.type === 'round') {\r\n        appMediaPlaybackController.resolveWaitingForLoadMedia(message.peerId, message.mid, message.pFlags.is_scheduled);\r\n      }\r\n\r\n      await getCacheContext();\r\n      renderImageFromUrl(video, cacheContext.url);\r\n    }, () => {});\r\n\r\n    return {download: loadPromise, render: renderDeferred};\r\n  };\r\n\r\n  if(preloader && !uploadFileName) {\r\n    preloader.setDownloadFunction(load);\r\n  }\r\n\r\n  /* if(doc.size >= 20e6 && !doc.downloaded) {\r\n    let downloadDiv = document.createElement('div');\r\n    downloadDiv.classList.add('download');\r\n\r\n    let span = document.createElement('span');\r\n    span.classList.add('btn-circle', 'tgico-download');\r\n    downloadDiv.append(span);\r\n\r\n    downloadDiv.addEventListener('click', () => {\r\n      downloadDiv.remove();\r\n      loadVideo();\r\n    });\r\n\r\n    container.prepend(downloadDiv);\r\n\r\n    return;\r\n  } */\r\n\r\n  if(doc.type === 'gif' && !canAutoplay) {\r\n    attachClickEvent(container, (e) => {\r\n      cancelEvent(e);\r\n      spanPlay.remove();\r\n      load();\r\n    }, {capture: true, once: true});\r\n  } else {\r\n    res.loadPromise = !lazyLoadQueue ? \r\n      (await load()).render : \r\n      (lazyLoadQueue.push({div: container, load: () => load().then(({render}) => render)}), Promise.resolve());\r\n  }\r\n\r\n  return res;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { Message, PhotoSize } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getMediaFromMessage from \"../../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport Chat from \"../chat/chat\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport prepareAlbum from \"../prepareAlbum\";\r\nimport wrapPhoto from \"./photo\";\r\nimport wrapVideo from \"./video\";\r\n\r\nexport default function wrapAlbum({messages, attachmentDiv, middleware, uploading, lazyLoadQueue, isOut, chat, loadPromises, autoDownload, managers = rootScope.managers}: {\r\n  messages: Message.message[],\r\n  attachmentDiv: HTMLElement,\r\n  middleware?: () => boolean,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  uploading?: boolean,\r\n  isOut: boolean,\r\n  chat: Chat,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownload?: ChatAutoDownloadSettings,\r\n  managers?: AppManagers\r\n}) {\r\n  const items: {size: PhotoSize.photoSize, media: any, message: any}[] = [];\r\n\r\n  // !lowest msgID will be the FIRST in album\r\n  for(const message of messages) {\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const size: any = media._ === 'photo' ? choosePhotoSize(media, 480, 480) : {w: media.w, h: media.h};\r\n    items.push({size, media, message});\r\n  }\r\n\r\n  /* // * pending\r\n  if(storage[0] < 0) {\r\n    items.reverse();\r\n  } */\r\n\r\n  prepareAlbum({\r\n    container: attachmentDiv,\r\n    items: items.map((i) => ({w: i.size.w, h: i.size.h})),\r\n    maxWidth: mediaSizes.active.album.width,\r\n    minWidth: 100,\r\n    spacing: 2,\r\n    forMedia: true\r\n  });\r\n\r\n  items.forEach((item, idx) => {\r\n    const {size, media, message} = item;\r\n\r\n    const div = attachmentDiv.children[idx] as HTMLElement;\r\n    div.dataset.mid = '' + message.mid;\r\n    div.dataset.peerId = '' + message.peerId;\r\n    const mediaDiv = div.firstElementChild as HTMLElement;\r\n    const isPhoto = media._ === 'photo';\r\n    let thumbPromise: Promise<any>;\r\n    if(isPhoto) {\r\n      thumbPromise = wrapPhoto({\r\n        photo: media,\r\n        message,\r\n        container: mediaDiv,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        isOut,\r\n        lazyLoadQueue,\r\n        middleware,\r\n        size,\r\n        loadPromises,\r\n        autoDownloadSize: autoDownload.photo,\r\n        managers\r\n      });\r\n    } else {\r\n      thumbPromise = wrapVideo({\r\n        doc: message.media.document,\r\n        container: mediaDiv,\r\n        message,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        withTail: false,\r\n        isOut,\r\n        lazyLoadQueue,\r\n        middleware,\r\n        loadPromises,\r\n        autoDownload,\r\n        managers\r\n      });\r\n    }\r\n\r\n    if(thumbPromise && loadPromises) {\r\n      loadPromises.push(thumbPromise);\r\n    }\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MEDIA_MIME_TYPES_SUPPORTED from \"../../environment/mediaMimeTypesSupport\";\r\nimport { clearBadCharsAndTrim } from \"../../helpers/cleanSearchText\";\r\nimport { formatFullSentTime } from \"../../helpers/date\";\r\nimport { simulateClickEvent, attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport formatBytes from \"../../helpers/formatBytes\";\r\nimport { MediaSizeType } from \"../../helpers/mediaSizes\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { Message, MessageMedia, WebPage } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getDownloadMediaDetails from \"../../lib/appManagers/utils/download/getDownloadMediaDetails\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { joinElementsWith } from \"../../lib/langPack\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport AudioElement from \"../audio\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport { MiddleEllipsisElement } from \"../middleEllipsis\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport wrapPhoto from './photo';\r\nimport wrapSenderToPeer from \"./senderToPeer\";\r\nimport wrapSentTime from \"./sentTime\";\r\n\r\nrootScope.addEventListener('document_downloading', (docId) => {\r\n  const elements = Array.from(document.querySelectorAll(`.document[data-doc-id=\"${docId}\"]`)) as HTMLElement[];\r\n  elements.forEach((element) => {\r\n    if(element.querySelector('.preloader-container.manual')) {\r\n      simulateClickEvent(element);\r\n    }\r\n  });\r\n});\r\n\r\nexport default async function wrapDocument({message, withTime, fontWeight, voiceAsMusic, showSender, searchContext, loadPromises, autoDownloadSize, lazyLoadQueue, sizeType, managers = rootScope.managers, cacheContext}: {\r\n  message: Message.message, \r\n  withTime?: boolean,\r\n  fontWeight?: number,\r\n  voiceAsMusic?: boolean,\r\n  showSender?: boolean,\r\n  searchContext?: MediaSearchContext,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  sizeType?: MediaSizeType,\r\n  managers?: AppManagers,\r\n  cacheContext?: ThumbCache\r\n}): Promise<HTMLElement> {\r\n  if(!fontWeight) fontWeight = 500;\r\n  if(!sizeType) sizeType = '' as any;\r\n  const noAutoDownload = autoDownloadSize === 0;\r\n\r\n  const doc = ((message.media as MessageMedia.messageMediaDocument).document || ((message.media as MessageMedia.messageMediaWebPage).webpage as WebPage.webPage).document) as MyDocument;\r\n  const uploadFileName = message?.uploadingFileName;\r\n  if(doc.type === 'audio' || doc.type === 'voice' || doc.type === 'round') {\r\n    const audioElement = new AudioElement();\r\n    audioElement.withTime = withTime;\r\n    audioElement.message = message;\r\n    audioElement.noAutoDownload = noAutoDownload;\r\n    audioElement.lazyLoadQueue = lazyLoadQueue;\r\n    audioElement.loadPromises = loadPromises;\r\n    \r\n    if(voiceAsMusic) audioElement.voiceAsMusic = voiceAsMusic;\r\n    if(searchContext) audioElement.searchContext = searchContext;\r\n    if(showSender) audioElement.showSender = showSender;\r\n\r\n    audioElement.dataset.fontWeight = '' + fontWeight;\r\n    audioElement.dataset.sizeType = sizeType;\r\n    await audioElement.render();\r\n    return audioElement;\r\n  }\r\n\r\n  let extSplitted = doc.file_name ? doc.file_name.split('.') : '';\r\n  let ext = '';\r\n  ext = extSplitted.length > 1 && Array.isArray(extSplitted) ? \r\n    clearBadCharsAndTrim(extSplitted.pop().split(' ', 1)[0].toLowerCase()) : \r\n    'file';\r\n\r\n  let docDiv = document.createElement('div');\r\n  docDiv.classList.add('document', `ext-${ext}`);\r\n  docDiv.dataset.docId = '' + doc.id;\r\n\r\n  // return docDiv;\r\n\r\n  const icoDiv = document.createElement('div');\r\n  icoDiv.classList.add('document-ico');\r\n\r\n  const hadContext = !!cacheContext;\r\n  const getCacheContext = () => {\r\n    return hadContext ? cacheContext : managers.thumbsStorage.getCacheContext(doc);\r\n  };\r\n\r\n  cacheContext = await getCacheContext();\r\n  if((doc.thumbs?.length || (message.pFlags.is_outgoing && cacheContext.url && doc.type === 'photo'))/*  && doc.mime_type !== 'image/gif' */) {\r\n    docDiv.classList.add('document-with-thumb');\r\n\r\n    let imgs: (HTMLImageElement | HTMLCanvasElement)[] = [];\r\n    // ! WARNING, use thumbs for check when thumb will be generated for media\r\n    if(message.pFlags.is_outgoing && ['photo', 'video'].includes(doc.type)) {\r\n      icoDiv.innerHTML = `<img src=\"${cacheContext.url}\">`;\r\n      imgs.push(icoDiv.firstElementChild as HTMLImageElement);\r\n    } else {\r\n      const perf = performance.now();\r\n      const wrapped = await wrapPhoto({\r\n        photo: doc, \r\n        message: null, \r\n        container: icoDiv, \r\n        boxWidth: 54, \r\n        boxHeight: 54,\r\n        loadPromises,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue,\r\n        size: choosePhotoSize(doc, 54, 54, true),\r\n        managers\r\n      });\r\n      // console.log('was wrapping photo', performance.now() - perf);\r\n      icoDiv.style.width = icoDiv.style.height = '';\r\n      if(wrapped.images.thumb) imgs.push(wrapped.images.thumb);\r\n      if(wrapped.images.full) imgs.push(wrapped.images.full);\r\n    }\r\n\r\n    imgs.forEach((img) => img.classList.add('document-thumb'));\r\n  } else {\r\n    icoDiv.innerText = ext;\r\n  }\r\n\r\n  //let fileName = stringMiddleOverflow(doc.file_name || 'Unknown.file', 26);\r\n  let fileName = doc.file_name ? wrapPlainText(doc.file_name) : 'Unknown.file';\r\n  const descriptionEl = document.createElement('div');\r\n  descriptionEl.classList.add('document-description');\r\n  const descriptionParts: (HTMLElement | string | DocumentFragment)[] = [formatBytes(doc.size)];\r\n  \r\n  if(withTime) {\r\n    descriptionParts.push(formatFullSentTime(message.date));\r\n  }\r\n\r\n  if(showSender) {\r\n    descriptionParts.push(await wrapSenderToPeer(message));\r\n  }\r\n\r\n  docDiv.innerHTML = `\r\n  ${(cacheContext.downloaded && !uploadFileName) || !message.mid ? '' : `<div class=\"document-download\"></div>`}\r\n  <div class=\"document-name\"></div>\r\n  <div class=\"document-size\"></div>\r\n  `;\r\n\r\n  const nameDiv = docDiv.querySelector('.document-name') as HTMLElement;\r\n  const middleEllipsisEl = new MiddleEllipsisElement();\r\n  middleEllipsisEl.dataset.fontWeight = '' + fontWeight;\r\n  middleEllipsisEl.dataset.sizeType = sizeType;\r\n  middleEllipsisEl.textContent = fileName;\r\n  // setInnerHTML(middleEllipsisEl, fileName);\r\n\r\n  nameDiv.append(middleEllipsisEl);\r\n\r\n  if(showSender) {\r\n    nameDiv.append(wrapSentTime(message));\r\n  }\r\n\r\n  const sizeDiv = docDiv.querySelector('.document-size') as HTMLElement;\r\n  sizeDiv.append(...joinElementsWith(descriptionParts, ' · '));\r\n\r\n  docDiv.prepend(icoDiv);\r\n\r\n  if(!uploadFileName && message.pFlags.is_outgoing && !message.mid) {\r\n    return docDiv;\r\n  }\r\n\r\n  let downloadDiv: HTMLElement, preloader: ProgressivePreloader = null;\r\n  const onLoad = () => {\r\n    if(downloadDiv) {\r\n      downloadDiv.classList.add('downloaded');\r\n      const _downloadDiv = downloadDiv;\r\n      setTimeout(() => {\r\n        _downloadDiv.remove();\r\n      }, 200);\r\n      downloadDiv = null;\r\n    }\r\n\r\n    if(preloader) {\r\n      preloader = null;\r\n    }\r\n  };\r\n\r\n  const load = async(e?: Event) => {\r\n    const save = !e || e.isTrusted;\r\n    const doc = await managers.appDocsManager.getDoc(docDiv.dataset.docId);\r\n    let download: Promise<any>;\r\n    const queueId = appImManager.chat.bubbles ? appImManager.chat.bubbles.lazyLoadQueue.queueId : undefined;\r\n    if(!save) {\r\n      download = appDownloadManager.downloadMediaVoid({media: doc, queueId});\r\n    } else if(doc.type === 'pdf') {\r\n      const canOpenAfter = /* managers.appDocsManager.downloading.has(doc.id) ||  */!preloader || preloader.detached;\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId});\r\n      if(canOpenAfter) {\r\n        download.then(() => {\r\n          setTimeout(async() => { // wait for preloader animation end\r\n            const url = (await getCacheContext()).url;\r\n            window.open(url);\r\n          }, rootScope.settings.animationsEnabled ? 250 : 0);\r\n        });\r\n      }\r\n    } else if(MEDIA_MIME_TYPES_SUPPORTED.has(doc.mime_type) && doc.thumbs?.length) {\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId});\r\n    } else {\r\n      download = appDownloadManager.downloadToDisc({media: doc, queueId});\r\n    }\r\n\r\n    if(downloadDiv) {\r\n      download.then(onLoad, noop);\r\n      preloader.attach(downloadDiv, true, download);\r\n    }\r\n  };\r\n\r\n  const {fileName: downloadFileName} = getDownloadMediaDetails({media: doc});\r\n  if(await managers.apiFileManager.isDownloading(downloadFileName)) {\r\n    downloadDiv = docDiv.querySelector('.document-download');\r\n    const promise = appDownloadManager.downloadMediaVoid({media: doc});\r\n\r\n    preloader = new ProgressivePreloader();\r\n    preloader.attach(downloadDiv, false, promise);\r\n    preloader.setDownloadFunction(load);\r\n  } else if(!cacheContext.downloaded || uploadFileName) {\r\n    downloadDiv = docDiv.querySelector('.document-download');\r\n    preloader = new ProgressivePreloader({\r\n      isUpload: !!uploadFileName\r\n    });\r\n\r\n    if(!uploadFileName) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n      preloader.attach(downloadDiv);\r\n      preloader.setDownloadFunction(load);\r\n\r\n      if(autoDownloadSize !== undefined && autoDownloadSize >= doc.size) {\r\n        simulateClickEvent(preloader.preloader);\r\n      }\r\n    } else {\r\n      const uploadPromise = appDownloadManager.getUpload(uploadFileName);\r\n      preloader.attachPromise(uploadPromise);\r\n      preloader.attach(downloadDiv);\r\n      uploadPromise.then(onLoad, noop);\r\n    }\r\n  }\r\n\r\n  attachClickEvent(docDiv, (e) => {\r\n    if(preloader) {\r\n      preloader.onClick(e);\r\n    } else {\r\n      load(e);\r\n    }\r\n  });\r\n\r\n  return docDiv;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nconst savingLottiePreview: {[docId: DocId]: {width: number, height: number}} = {};\r\n\r\nexport function isSavingLottiePreview(doc: MyDocument, toneIndex: number) {\r\n  const key = doc.id + '-' + toneIndex;\r\n  return !!savingLottiePreview[key];\r\n}\r\n\r\nexport async function saveLottiePreview(doc: MyDocument, canvas: HTMLCanvasElement, toneIndex: number) {\r\n  const key = doc.id + '-' + toneIndex;\r\n  const {width, height} = canvas;\r\n  let saving = savingLottiePreview[key];\r\n  if(saving && saving.width >= width && saving.height >= height) {\r\n    return;\r\n  }\r\n\r\n  saving = savingLottiePreview[key] = {\r\n    width,\r\n    height\r\n  };\r\n\r\n  const thumb = await rootScope.managers.appDocsManager.getLottieCachedThumb(doc.id, toneIndex);\r\n  if(savingLottiePreview[key] !== saving) {\r\n    return;\r\n  }\r\n\r\n  if(thumb && thumb.w >= width && thumb.h >= height) {\r\n    return;\r\n  }\r\n\r\n  const promise = new Promise<Blob>((resolve) => {\r\n    canvas.toBlob((blob) => resolve(blob));\r\n  });\r\n  \r\n  const blob = await promise;\r\n  if(savingLottiePreview[key] !== saving) {\r\n    return;\r\n  }\r\n\r\n  //console.log('got lottie preview', doc, blob, URL.createObjectURL(blob));\r\n\r\n  rootScope.managers.appDocsManager.saveLottiePreview(doc.id, blob, width, height, toneIndex);\r\n\r\n  delete savingLottiePreview[key];\r\n\r\n  /* const reader = new FileReader();\r\n  reader.onloadend = (e) => {\r\n    const uint8 = new Uint8Array(e.target.result as ArrayBuffer);\r\n    const thumb: PhotoSize.photoStrippedSize = {\r\n      _: 'photoStrippedSize',\r\n      bytes: uint8,\r\n      type: 'i'\r\n    };\r\n\r\n    doc.stickerSavedThumbWidth = canvas.width;\r\n    doc.stickerSavedThumbHeight = canvas.width;\r\n\r\n    defineNotNumerableProperties(thumb, ['url']);\r\n    thumb.url = URL.createObjectURL(blob);\r\n    doc.thumbs.findAndSplice((t) => t._ === thumb._);\r\n    doc.thumbs.unshift(thumb);\r\n\r\n    if(!webpWorkerController.isWebpSupported()) {\r\n      doc.pFlags.stickerThumbConverted = true;\r\n    }\r\n\r\n    delete this.savingLottiePreview[doc.id];\r\n  };\r\n  reader.readAsArrayBuffer(blob); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_VIBRATE_SUPPORTED from \"../../environment/vibrateSupport\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport throttleWithRaf from \"../../helpers/schedulers/throttleWithRaf\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default function wrapStickerAnimation({\r\n  size,\r\n  doc,\r\n  middleware,\r\n  target,\r\n  side,\r\n  skipRatio,\r\n  play,\r\n  managers\r\n}: {\r\n  size: number,\r\n  doc: MyDocument,\r\n  middleware?: () => boolean,\r\n  target: HTMLElement,\r\n  side: 'left' | 'center' | 'right',\r\n  skipRatio?: number,\r\n  play: boolean,\r\n  managers?: AppManagers\r\n}) {\r\n  const animationDiv = document.createElement('div');\r\n  animationDiv.classList.add('emoji-animation');\r\n\r\n  // const size = 280;\r\n  animationDiv.style.width = size + 'px';\r\n  animationDiv.style.height = size + 'px';\r\n\r\n  const stickerPromise = wrapSticker({\r\n    div: animationDiv,\r\n    doc,\r\n    middleware,\r\n    withThumb: false,\r\n    needFadeIn: false,\r\n    loop: false,\r\n    width: size,\r\n    height: size,\r\n    play,\r\n    group: 'none',\r\n    skipRatio,\r\n    managers\r\n  }).then(({render}) => render).then((animation) => {\r\n    assumeType<RLottiePlayer>(animation);\r\n    animation.addEventListener('enterFrame', (frameNo) => {\r\n      if(frameNo === animation.maxFrame) {\r\n        animation.remove();\r\n        animationDiv.remove();\r\n        appImManager.chat.bubbles.scrollable.container.removeEventListener('scroll', onScroll);\r\n      }\r\n    });\r\n\r\n    if(IS_VIBRATE_SUPPORTED) {\r\n      animation.addEventListener('firstFrame', () => {\r\n        navigator.vibrate(100);\r\n      }, {once: true});\r\n    }\r\n\r\n    return animation;\r\n  });\r\n\r\n  const generateRandomSigned = (max: number) => {\r\n    const r = Math.random() * max * 2;\r\n    return r > max ? -r % max : r;\r\n  };\r\n\r\n  const randomOffsetX = generateRandomSigned(16);\r\n  const randomOffsetY = generateRandomSigned(4);\r\n  const stableOffsetX = size / 8 * (side === 'right' ? 1 : -1);\r\n  const setPosition = () => {\r\n    if(!isInDOM(target)) {\r\n      return;\r\n    }\r\n    \r\n    const rect = target.getBoundingClientRect();\r\n    /* const boxWidth = Math.max(rect.width, rect.height);\r\n    const boxHeight = Math.max(rect.width, rect.height);\r\n    const x = rect.left + ((boxWidth - size) / 2);\r\n    const y = rect.top + ((boxHeight - size) / 2); */\r\n\r\n    const rectX = side === 'right' ? rect.right : rect.left;\r\n\r\n    const addOffsetX = side === 'center' ? (rect.width - size) / 2 : (side === 'right' ? -size : 0) + stableOffsetX + randomOffsetX;\r\n    const x = rectX + addOffsetX;\r\n    // const y = rect.bottom - size + size / 4;\r\n    const y = rect.top + ((rect.height - size) / 2) + (side === 'center' ? 0 : randomOffsetY);\r\n    // animationDiv.style.transform = `translate(${x}px, ${y}px)`;\r\n    animationDiv.style.top = y + 'px';\r\n    animationDiv.style.left = x + 'px';\r\n  };\r\n\r\n  const onScroll = throttleWithRaf(setPosition);\r\n\r\n  appImManager.chat.bubbles.scrollable.container.addEventListener('scroll', onScroll);\r\n\r\n  setPosition();\r\n\r\n  appImManager.emojiAnimationContainer.append(animationDiv);\r\n\r\n  return {animationDiv, stickerPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_WEBP_SUPPORTED from \"../../environment/webpSupport\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport getPathFromBytes from \"../../helpers/bytes/getPathFromBytes\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport getImageFromStrippedThumb from \"../../helpers/getImageFromStrippedThumb\";\r\nimport getPreviewURLFromThumb from \"../../helpers/getPreviewURLFromThumb\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport { isSavingLottiePreview, saveLottiePreview } from \"../../helpers/saveLottiePreview\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport sequentialDom from \"../../helpers/sequentialDom\";\r\nimport { PhotoSize } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport webpWorkerController from \"../../lib/webp/webpWorkerController\";\r\nimport { SendMessageEmojiInteractionData } from \"../../types\";\r\nimport { getEmojiToneIndex } from \"../../vendor/emoji\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapStickerAnimation from \"./stickerAnimation\";\r\n\r\nexport default async function wrapSticker({doc, div, middleware, lazyLoadQueue, group, play, onlyThumb, emoji, width, height, withThumb, loop, loadPromises, needFadeIn, needUpscale, skipRatio, static: asStatic, managers = rootScope.managers}: {\r\n  doc: MyDocument, \r\n  div: HTMLElement, \r\n  middleware?: () => boolean, \r\n  lazyLoadQueue?: LazyLoadQueue, \r\n  group?: string, \r\n  play?: boolean, \r\n  onlyThumb?: boolean,\r\n  emoji?: string,\r\n  width?: number,\r\n  height?: number,\r\n  withThumb?: boolean,\r\n  loop?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  needFadeIn?: boolean,\r\n  needUpscale?: boolean,\r\n  skipRatio?: number,\r\n  static?: boolean,\r\n  managers?: AppManagers\r\n}) {\r\n  const stickerType = doc.sticker;\r\n  if(stickerType === 1) {\r\n    asStatic = true;\r\n  }\r\n\r\n  if(!width) {\r\n    width = !emoji ? 200 : undefined;\r\n  }\r\n\r\n  if(!height) {\r\n    height = !emoji ? 200 : undefined;\r\n  }\r\n\r\n  if(stickerType === 2) {\r\n    //LottieLoader.loadLottie();\r\n    lottieLoader.loadLottieWorkers();\r\n  }\r\n  \r\n  if(!stickerType) {\r\n    console.error('wrong doc for wrapSticker!', doc);\r\n    throw new Error('wrong doc for wrapSticker!');\r\n  }\r\n\r\n  div.dataset.docId = '' + doc.id;\r\n  div.classList.add('media-sticker-wrapper');\r\n\r\n  /* if(stickerType === 3) {\r\n    const videoRes = wrapVideo({\r\n      doc,\r\n      boxWidth: width,\r\n      boxHeight: height,\r\n      container: div,\r\n      group,\r\n      lazyLoadQueue,\r\n      middleware,\r\n      withoutPreloader: true,\r\n      loadPromises,\r\n      noPlayButton: true,\r\n      noInfo: true\r\n    });\r\n\r\n    if(videoRes.thumb) {\r\n      if(videoRes.thumb.images.thumb) {\r\n        videoRes.thumb.images.thumb.classList.add('media-sticker', 'thumbnail');\r\n      }\r\n\r\n      if(videoRes.thumb.images.full) {\r\n        videoRes.thumb.images.full.classList.add('media-sticker');\r\n      }\r\n    }\r\n\r\n    return videoRes.loadPromise;\r\n  } */\r\n  \r\n  //console.log('wrap sticker', doc, div, onlyThumb);\r\n\r\n  let cacheContext: ThumbCache;\r\n  let getCacheContext = async(type: string = cacheContext?.type) => {\r\n    return cacheContext = await managers.thumbsStorage.getCacheContext(doc, type);\r\n  };\r\n\r\n  if(asStatic && stickerType !== 1) {\r\n    const thumb = choosePhotoSize(doc, width, height, false) as PhotoSize.photoSize;\r\n    await getCacheContext(thumb.type);\r\n  } else {\r\n    await getCacheContext();\r\n  }\r\n\r\n  const toneIndex = emoji ? getEmojiToneIndex(emoji) : -1;\r\n  const downloaded = cacheContext.downloaded && !needFadeIn;\r\n\r\n  const isAnimated = !asStatic && (stickerType === 2 || stickerType === 3);\r\n  const isThumbNeededForType = isAnimated;\r\n  const lottieCachedThumb = stickerType === 2 || stickerType === 3 ? await managers.appDocsManager.getLottieCachedThumb(doc.id, toneIndex) : undefined;\r\n  \r\n  let loadThumbPromise = deferredPromise<void>();\r\n  let haveThumbCached = false;\r\n  if((\r\n      doc.thumbs?.length || \r\n      lottieCachedThumb\r\n    ) && \r\n    !div.firstElementChild && (\r\n      !downloaded || \r\n      isThumbNeededForType ||  \r\n      onlyThumb\r\n    ) && withThumb !== false/*  && doc.thumbs[0]._ !== 'photoSizeEmpty' */\r\n  ) {\r\n    let thumb = lottieCachedThumb || doc.thumbs[0];\r\n    \r\n    //console.log('wrap sticker', thumb, div);\r\n\r\n    let thumbImage: HTMLImageElement | HTMLCanvasElement;\r\n    const afterRender = () => {\r\n      if(!div.childElementCount) {\r\n        thumbImage.classList.add('media-sticker', 'thumbnail');\r\n        \r\n        sequentialDom.mutateElement(div, () => {\r\n          div.append(thumbImage);\r\n          loadThumbPromise.resolve();\r\n        });\r\n      }\r\n    };\r\n\r\n    if('url' in thumb) {\r\n      thumbImage = new Image();\r\n      renderImageFromUrl(thumbImage, thumb.url, afterRender);\r\n      haveThumbCached = true;\r\n    } else if('bytes' in thumb) {\r\n      if(thumb._ === 'photoPathSize') {\r\n        if(thumb.bytes.length) {\r\n          const d = getPathFromBytes(thumb.bytes);\r\n          const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n          svg.classList.add('rlottie-vector', 'media-sticker', 'thumbnail');\r\n          svg.setAttributeNS(null, 'viewBox', `0 0 ${doc.w || 512} ${doc.h || 512}`);\r\n          const path = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\");\r\n          path.setAttributeNS(null, 'd', d);\r\n          svg.append(path);\r\n          div.append(svg);\r\n        } else {\r\n          thumb = doc.thumbs.find((t) => (t as PhotoSize.photoStrippedSize).bytes?.length) || thumb;\r\n        }\r\n      } else if(toneIndex <= 0) {\r\n        thumbImage = new Image();\r\n\r\n        if((IS_WEBP_SUPPORTED || doc.pFlags.stickerThumbConverted || cacheContext.url)/*  && false */) {\r\n          renderImageFromUrl(thumbImage, getPreviewURLFromThumb(doc, thumb, true), afterRender);\r\n          haveThumbCached = true;\r\n        } else {\r\n          webpWorkerController.convert('main-' + doc.id, thumb.bytes).then((bytes) => {\r\n            managers.appDocsManager.saveWebPConvertedStrippedThumb(doc.id, bytes);\r\n            (thumb as PhotoSize.photoStrippedSize).bytes = bytes;\r\n            doc.pFlags.stickerThumbConverted = true;\r\n            \r\n            if(middleware && !middleware()) return;\r\n  \r\n            if(!div.childElementCount) {\r\n              renderImageFromUrl(thumbImage, getPreviewURLFromThumb(doc, thumb as PhotoSize.photoStrippedSize, true), afterRender);\r\n            }\r\n          }).catch(() => {});\r\n        }\r\n      }\r\n    } else if(((stickerType === 2 && toneIndex <= 0) || stickerType === 3) && (withThumb || onlyThumb)) {\r\n      const load = async() => {\r\n        if(div.childElementCount || (middleware && !middleware())) return;\r\n\r\n        const r = () => {\r\n          if(div.childElementCount || (middleware && !middleware())) return;\r\n          renderImageFromUrl(thumbImage, cacheContext.url, afterRender);\r\n        };\r\n  \r\n        await getCacheContext();\r\n        if(cacheContext.url) {\r\n          r();\r\n          return;\r\n        } else {\r\n          const res = getImageFromStrippedThumb(doc, thumb as PhotoSize.photoStrippedSize, true);\r\n          thumbImage = res.image;\r\n          res.loadPromise.then(r);\r\n          \r\n          // return managers.appDocsManager.getThumbURL(doc, thumb as PhotoSize.photoStrippedSize).promise.then(r);\r\n        }\r\n      };\r\n      \r\n      if(lazyLoadQueue && onlyThumb) {\r\n        lazyLoadQueue.push({div, load});\r\n        return;\r\n      } else {\r\n        load();\r\n\r\n        if((thumb as any).url) {\r\n          haveThumbCached = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if(loadPromises && haveThumbCached) {\r\n    loadPromises.push(loadThumbPromise);\r\n  }\r\n\r\n  if(onlyThumb) { // for sticker panel\r\n    return;\r\n  }\r\n  \r\n  const load = async() => {\r\n    if(middleware && !middleware()) return;\r\n\r\n    if(stickerType === 2 && !asStatic) {\r\n      /* if(doc.id === '1860749763008266301') {\r\n        console.log('loaded sticker:', doc, div);\r\n      } */\r\n\r\n      //await new Promise((resolve) => setTimeout(resolve, 500));\r\n      //return;\r\n\r\n      //console.time('download sticker' + doc.id);\r\n\r\n      //appDocsManager.downloadDocNew(doc.id).promise.then((res) => res.json()).then(async(json) => {\r\n      //fetch(doc.url).then((res) => res.json()).then(async(json) => {\r\n      return await appDownloadManager.downloadMedia({media: doc, queueId: lazyLoadQueue?.queueId})\r\n      .then(async(blob) => {\r\n        //console.timeEnd('download sticker' + doc.id);\r\n        //console.log('loaded sticker:', doc, div/* , blob */);\r\n        if(middleware && !middleware()) {\r\n          throw new Error('wrapSticker 2 middleware');\r\n        }\r\n\r\n        let animation = await lottieLoader.loadAnimationWorker({\r\n          container: div,\r\n          loop: loop && !emoji,\r\n          autoplay: play,\r\n          animationData: blob,\r\n          width,\r\n          height,\r\n          name: 'doc' + doc.id,\r\n          needUpscale,\r\n          skipRatio,\r\n          toneIndex\r\n        }, group, middleware);\r\n\r\n        //const deferred = deferredPromise<void>();\r\n  \r\n        animation.addEventListener('firstFrame', () => {\r\n          const element = div.firstElementChild;\r\n          if(needFadeIn !== false) {\r\n            needFadeIn = (needFadeIn || !element || element.tagName === 'svg') && rootScope.settings.animationsEnabled;\r\n          }\r\n\r\n          const cb = () => {\r\n            if(element && element !== animation.canvas) {\r\n              element.remove();\r\n            }\r\n          };\r\n\r\n          if(!needFadeIn) {\r\n            if(element) {\r\n              sequentialDom.mutate(cb);\r\n            }\r\n          } else {\r\n            sequentialDom.mutate(() => {\r\n              animation.canvas.classList.add('fade-in');\r\n              if(element) {\r\n                element.classList.add('fade-out');\r\n              }\r\n  \r\n              animation.canvas.addEventListener('animationend', () => {\r\n                sequentialDom.mutate(() => {\r\n                  animation.canvas.classList.remove('fade-in');\r\n                  cb();\r\n                });\r\n              }, {once: true});\r\n            });\r\n          }\r\n\r\n          if(withThumb !== false) {\r\n            saveLottiePreview(doc, animation.canvas, toneIndex);\r\n          }\r\n\r\n          //deferred.resolve();\r\n        }, {once: true});\r\n  \r\n        if(emoji) {\r\n          const data: SendMessageEmojiInteractionData = {\r\n            a: [],\r\n            v: 1\r\n          };\r\n\r\n          let sendInteractionThrottled: () => void;\r\n\r\n          managers.appStickersManager.preloadAnimatedEmojiStickerAnimation(emoji);\r\n\r\n          attachClickEvent(div, async(e) => {\r\n            cancelEvent(e);\r\n            const animation = lottieLoader.getAnimation(div);\r\n  \r\n            if(animation.paused) {\r\n              const doc = await managers.appStickersManager.getAnimatedEmojiSoundDocument(emoji);\r\n              if(doc) {\r\n                const audio = document.createElement('audio');\r\n                audio.style.display = 'none';\r\n                div.parentElement.append(audio);\r\n\r\n                try {\r\n                  const url = await appDownloadManager.downloadMediaURL({media: doc});\r\n\r\n                  audio.src = url;\r\n                  audio.play();\r\n                  await onMediaLoad(audio, undefined, true);\r\n                  \r\n                  audio.addEventListener('ended', () => {\r\n                    audio.src = '';\r\n                    audio.remove();\r\n                  }, {once: true});\r\n                } catch(err) {\r\n                  \r\n                }\r\n              }\r\n\r\n              animation.autoplay = true;\r\n              animation.restart();\r\n            }\r\n\r\n            const peerId = appImManager.chat.peerId;\r\n            if(!peerId.isUser()) {\r\n              return;\r\n            }\r\n\r\n            const doc = await managers.appStickersManager.getAnimatedEmojiSticker(emoji, true);\r\n            if(!doc) {\r\n              return;\r\n            }\r\n            \r\n            const bubble = findUpClassName(div, 'bubble');\r\n            const isOut = bubble.classList.contains('is-out');\r\n\r\n            const {animationDiv} = wrapStickerAnimation({\r\n              doc,\r\n              middleware,\r\n              side: isOut ? 'right' : 'left',\r\n              size: 280,\r\n              target: div,\r\n              play: true\r\n            });\r\n\r\n            if(bubble) {\r\n              if(isOut) {\r\n                animationDiv.classList.add('is-out');\r\n              } else {\r\n                animationDiv.classList.add('is-in');\r\n              }\r\n            }\r\n\r\n            if(!sendInteractionThrottled) {\r\n              sendInteractionThrottled = throttle(() => {\r\n                const length = data.a.length;\r\n                if(!length) {\r\n                  return;\r\n                }\r\n      \r\n                const firstTime = data.a[0].t;\r\n      \r\n                data.a.forEach((a) => {\r\n                  a.t = (a.t - firstTime) / 1000;\r\n                });\r\n      \r\n                const bubble = findUpClassName(div, 'bubble');\r\n                managers.appMessagesManager.setTyping(appImManager.chat.peerId, {\r\n                  _: 'sendMessageEmojiInteraction',\r\n                  msg_id: getServerMessageId(+bubble.dataset.mid),\r\n                  emoticon: emoji,\r\n                  interaction: {\r\n                    _: 'dataJSON',\r\n                    data: JSON.stringify(data)\r\n                  }\r\n                }, true);\r\n      \r\n                data.a.length = 0;\r\n              }, 1000, false);\r\n            }\r\n\r\n            // using a trick here: simulated event from interlocutor's interaction won't fire ours\r\n            if(e.isTrusted) {\r\n              data.a.push({\r\n                i: 1,\r\n                t: Date.now()\r\n              });\r\n    \r\n              sendInteractionThrottled();\r\n            }\r\n          });\r\n        }\r\n\r\n        return animation;\r\n\r\n        //return deferred;\r\n        //await new Promise((resolve) => setTimeout(resolve, 5e3));\r\n      });\r\n\r\n      //console.timeEnd('render sticker' + doc.id);\r\n    } else if(asStatic || stickerType === 3) {\r\n      let media: HTMLElement;\r\n      if(asStatic) {\r\n        media = new Image();\r\n      } else {\r\n        media = createVideo();\r\n        (media as HTMLVideoElement).muted = true;\r\n\r\n        if(play) {\r\n          (media as HTMLVideoElement).autoplay = true;\r\n          (media as HTMLVideoElement).loop = true;\r\n        }\r\n      }\r\n\r\n      const thumbImage = div.firstElementChild !== media && div.firstElementChild;\r\n      if(needFadeIn !== false) {\r\n        needFadeIn = (needFadeIn || !downloaded || (asStatic ? thumbImage : (!thumbImage || thumbImage.tagName === 'svg'))) && rootScope.settings.animationsEnabled;\r\n      }\r\n\r\n      media.classList.add('media-sticker');\r\n\r\n      if(needFadeIn) {\r\n        media.classList.add('fade-in');\r\n      }\r\n\r\n      return new Promise<void>(async(resolve, reject) => {\r\n        const r = async() => {\r\n          if(middleware && !middleware()) return resolve();\r\n  \r\n          const onLoad = () => {\r\n            sequentialDom.mutateElement(div, () => {\r\n              div.append(media);\r\n              if(thumbImage) {\r\n                thumbImage.classList.add('fade-out');\r\n              }\r\n\r\n              if(stickerType === 3 && !isSavingLottiePreview(doc, toneIndex)) {\r\n                // const perf = performance.now();\r\n                assumeType<HTMLVideoElement>(media);\r\n                const canvas = document.createElement('canvas');\r\n                canvas.width = width * window.devicePixelRatio;\r\n                canvas.height = height * window.devicePixelRatio;\r\n                const ctx = canvas.getContext('2d');\r\n                ctx.drawImage(media, 0, 0, canvas.width, canvas.height);\r\n                saveLottiePreview(doc, canvas, toneIndex);\r\n                // console.log('perf', performance.now() - perf);\r\n              }\r\n\r\n              if(stickerType === 3 && group) {\r\n                animationIntersector.addAnimation(media as HTMLVideoElement, group);\r\n              }\r\n\r\n              resolve();\r\n\r\n              if(needFadeIn) {\r\n                media.addEventListener('animationend', () => {\r\n                  media.classList.remove('fade-in');\r\n                  if(thumbImage) {\r\n                    thumbImage.remove();\r\n                  }\r\n                }, {once: true});\r\n              }\r\n            });\r\n          };\r\n\r\n          await getCacheContext();\r\n          if(asStatic) {\r\n            renderImageFromUrl(media, cacheContext.url, onLoad);\r\n          } else {\r\n            (media as HTMLVideoElement).src = cacheContext.url;\r\n            onMediaLoad(media as HTMLVideoElement).then(onLoad);\r\n          }\r\n        };\r\n\r\n        await getCacheContext();\r\n        if(cacheContext.url) r();\r\n        else {\r\n          let promise: Promise<any>;\r\n          if(stickerType === 2 && asStatic) {\r\n            const thumb = choosePhotoSize(doc, width, height, false) as PhotoSize.photoSize;\r\n            // promise = managers.appDocsManager.getThumbURL(doc, thumb).promise\r\n            promise = appDownloadManager.downloadMediaURL({media: doc, thumb, queueId: lazyLoadQueue?.queueId});\r\n          } else {\r\n            promise = appDownloadManager.downloadMediaURL({media: doc, queueId: lazyLoadQueue?.queueId});\r\n          }\r\n            \r\n          promise.then(r, resolve);\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  const loadPromise: Promise<RLottiePlayer | void> = lazyLoadQueue && (!downloaded || isAnimated) ? \r\n    (lazyLoadQueue.push({div, load}), Promise.resolve()) : \r\n    load();\r\n\r\n  if(downloaded && (asStatic/*  || stickerType === 3 */)) {\r\n    loadThumbPromise = loadPromise as any;\r\n    if(loadPromises) {\r\n      loadPromises.push(loadThumbPromise);\r\n    }\r\n  }\r\n\r\n  return {render: loadPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n/**\r\n  * https://core.telegram.org/api/files#vector-thumbnails\r\n  */\r\nexport default function getPathFromBytes(bytes: Uint8Array) {\r\n  const lookup = \"AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,\";\r\n\r\n  let path = 'M';\r\n  for(let i = 0, length = bytes.length; i < length; ++i) {\r\n    const num = bytes[i];\r\n\r\n    if(num >= (128 + 64)) {\r\n      path += lookup[num - 128 - 64];\r\n    } else {\r\n      if(num >= 128) {\r\n        path += ',';\r\n      } else if(num >= 64) {\r\n        path += '-'; \r\n      }\r\n      path += '' + (num & 63);\r\n    }\r\n  }\r\n  path += 'z';\r\n\r\n  return path;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { InputFile } from \"../layer\";\r\nimport AvatarEdit from \"./avatarEdit\";\r\nimport AvatarElement from \"./avatar\";\r\nimport InputField from \"./inputField\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ButtonCorner from \"./buttonCorner\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nexport default class EditPeer {\r\n  public nextBtn: HTMLButtonElement;\r\n\r\n  public uploadAvatar: () => Promise<InputFile>;\r\n  public avatarEdit: AvatarEdit;\r\n  public avatarElem: AvatarElement;\r\n\r\n  private inputFields: InputField[];\r\n  private listenerSetter: ListenerSetter;\r\n\r\n  private peerId: PeerId;\r\n\r\n  private _disabled = false;\r\n  private avatarSize = 120;\r\n\r\n  constructor(options: {\r\n    peerId?: EditPeer['peerId'],\r\n    inputFields: EditPeer['inputFields'],\r\n    listenerSetter: ListenerSetter,\r\n    doNotEditAvatar?: boolean,\r\n    withoutAvatar?: boolean,\r\n    nextBtn?: HTMLButtonElement,\r\n    avatarSize?: number\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.nextBtn) {\r\n      this.nextBtn = ButtonCorner({icon: 'check'});\r\n    } else if(!this.nextBtn.classList.contains('btn-corner')) {\r\n      this.handleChange = () => {\r\n        this.nextBtn.toggleAttribute('disabled', !this.isChanged() || this.disabled);\r\n      };\r\n    }\r\n\r\n    if(!options.withoutAvatar) {\r\n      this.avatarElem = document.createElement('avatar-element') as AvatarElement;\r\n      this.avatarElem.classList.add('avatar-placeholder', 'avatar-' + this.avatarSize);\r\n      this.avatarElem.updateWithOptions({peerId: this.peerId});\r\n  \r\n      if(!options.doNotEditAvatar) {\r\n        this.avatarEdit = new AvatarEdit((_upload) => {\r\n          this.uploadAvatar = _upload;\r\n          this.handleChange();\r\n          this.avatarElem.remove();\r\n        });\r\n  \r\n        this.avatarEdit.container.append(this.avatarElem);\r\n      }\r\n    }\r\n\r\n    this.inputFields.forEach((inputField) => {\r\n      this.listenerSetter.add(inputField.input)('input', this.handleChange);\r\n    });\r\n\r\n    this.handleChange();\r\n  }\r\n\r\n  public get disabled() {\r\n    return this._disabled;\r\n  }\r\n\r\n  public set disabled(value) {\r\n    this._disabled = value;\r\n    this.inputFields.forEach((inputField) => inputField.input.toggleAttribute('disabled', value));\r\n    this.handleChange();\r\n  }\r\n\r\n  public lockWithPromise(promise: Promise<any>, unlockOnSuccess = false) {\r\n    this.disabled = true;\r\n    promise.then(() => {\r\n      if(unlockOnSuccess) {\r\n        this.disabled = false;\r\n      }\r\n    }, () => {\r\n      this.disabled = false;\r\n    });\r\n  }\r\n\r\n  public isChanged = () => {\r\n    if(this.uploadAvatar) {\r\n      return true;\r\n    }\r\n\r\n    let changedLength = 0, requiredLength = 0, requiredValidLength = 0;\r\n    this.inputFields.forEach((inputField) => {\r\n      if(inputField.isValid()) {\r\n        if(inputField.isChanged()) {\r\n          ++changedLength;\r\n        }\r\n\r\n        if(inputField.required) {\r\n          ++requiredValidLength;\r\n        }\r\n      }\r\n\r\n      if(inputField.required) {\r\n        ++requiredLength;\r\n      }\r\n    });\r\n\r\n    return requiredLength === requiredValidLength && changedLength > 0;\r\n  };\r\n\r\n  public handleChange = () => {\r\n    this.nextBtn.classList.toggle('is-visible', this.isChanged());\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function RadioForm(radios: {container: HTMLElement, input: HTMLInputElement}[], onChange: (value: string, event: Event) => void) {\r\n  const form = document.createElement('form');\r\n\r\n  radios.forEach((r) => {\r\n    const {container, input} = r;\r\n    form.append(container);\r\n    input.addEventListener('change', (e) => {\r\n      if(input.checked) {\r\n        onChange(input.value, e);\r\n      }\r\n    });\r\n  });\r\n\r\n  return form;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport CheckboxField from \"./checkboxField\";\r\nimport RadioField from \"./radioField\";\r\nimport ripple from \"./ripple\";\r\nimport { SliderSuperTab } from \"./slider\";\r\nimport RadioForm from \"./radioForm\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\n\r\nexport default class Row {\r\n  public container: HTMLElement;\r\n  public title: HTMLDivElement;\r\n  public titleRight: HTMLElement;\r\n  public subtitle: HTMLElement;\r\n  public media: HTMLElement;\r\n\r\n  public checkboxField: CheckboxField;\r\n  public radioField: RadioField;\r\n\r\n  public freezed = false;\r\n\r\n  constructor(options: Partial<{\r\n    icon: string,\r\n    subtitle: string | HTMLElement | DocumentFragment,\r\n    subtitleLangKey: LangPackKey,\r\n    subtitleLangArgs: any[],\r\n    radioField: Row['radioField'],\r\n    checkboxField: Row['checkboxField'],\r\n    noCheckboxSubtitle: boolean,\r\n    title: string | HTMLElement | DocumentFragment,\r\n    titleLangKey: LangPackKey,\r\n    titleRight: string | HTMLElement,\r\n    titleRightSecondary: string | HTMLElement,\r\n    clickable: boolean | ((e: Event) => void),\r\n    navigationTab: SliderSuperTab,\r\n    havePadding: boolean,\r\n    noRipple: boolean\r\n  }> = {}) {\r\n    this.container = document.createElement(options.radioField || options.checkboxField ? 'label' : 'div');\r\n    this.container.classList.add('row');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('row-subtitle');\r\n    this.subtitle.setAttribute('dir', 'auto');\r\n    if(options.subtitle) {\r\n      if(typeof(options.subtitle) === 'string') {\r\n        setInnerHTML(this.subtitle, options.subtitle);\r\n      } else {\r\n        this.subtitle.append(options.subtitle);\r\n      }\r\n    } else if(options.subtitleLangKey) {\r\n      this.subtitle.append(i18n(options.subtitleLangKey, options.subtitleLangArgs));\r\n    }\r\n    this.container.append(this.subtitle);\r\n\r\n    let havePadding = !!options.havePadding;\r\n    if(options.radioField || options.checkboxField) {\r\n      if(options.radioField) {\r\n        this.radioField = options.radioField;\r\n        this.container.append(this.radioField.label);\r\n        havePadding = true;\r\n      }\r\n\r\n      if(options.checkboxField) {\r\n        this.checkboxField = options.checkboxField;\r\n        \r\n        const isToggle = options.checkboxField.label.classList.contains('checkbox-field-toggle');\r\n        if(isToggle) {\r\n          this.container.classList.add('row-with-toggle');\r\n          options.titleRight = this.checkboxField.label;\r\n        } else {\r\n          havePadding = true;\r\n          this.container.append(this.checkboxField.label);\r\n        }\r\n\r\n        if(!options.noCheckboxSubtitle && !isToggle) {\r\n          this.checkboxField.input.addEventListener('change', () => {\r\n            replaceContent(this.subtitle, i18n(this.checkboxField.input.checked ? 'Checkbox.Enabled' : 'Checkbox.Disabled'));\r\n          });\r\n        }\r\n      }\r\n\r\n      const i = options.radioField || options.checkboxField;\r\n      i.label.classList.add('disable-hover');\r\n    } \r\n    \r\n    if(options.title || options.titleLangKey) {\r\n      let c: HTMLElement;\r\n      const titleRight = options.titleRight || options.titleRightSecondary;\r\n      if(titleRight) {\r\n        c = document.createElement('div');\r\n        c.classList.add('row-title-row');\r\n        this.container.append(c);\r\n      } else {\r\n        c = this.container;\r\n      }\r\n\r\n      this.title = document.createElement('div');\r\n      this.title.classList.add('row-title');\r\n      this.title.setAttribute('dir', 'auto');\r\n      if(options.title) {\r\n        if(typeof(options.title) === 'string') {\r\n          this.title.innerHTML = options.title;\r\n        } else {\r\n          this.title.append(options.title);\r\n        }\r\n      } else {\r\n        this.title.append(i18n(options.titleLangKey));\r\n      }\r\n      c.append(this.title);\r\n\r\n      if(titleRight) {\r\n        const titleRightEl = this.titleRight = document.createElement('div');\r\n        titleRightEl.classList.add('row-title', 'row-title-right');\r\n\r\n        if(options.titleRightSecondary) {\r\n          titleRightEl.classList.add('row-title-right-secondary');\r\n        }\r\n\r\n        if(typeof(titleRight) === 'string') {\r\n          titleRightEl.innerHTML = titleRight;\r\n        } else {\r\n          titleRightEl.append(titleRight);\r\n        }\r\n\r\n        c.append(titleRightEl);\r\n      }\r\n    }\r\n\r\n    if(options.icon) {\r\n      havePadding = true;\r\n      this.title.classList.add('tgico', 'tgico-' + options.icon);\r\n      this.container.classList.add('row-with-icon');\r\n    }\r\n\r\n    if(havePadding) {\r\n      this.container.classList.add('row-with-padding');\r\n    }\r\n\r\n    if(options.navigationTab) {\r\n      options.clickable = () => options.navigationTab.open();\r\n    }\r\n\r\n    if(options.clickable || options.radioField || options.checkboxField) {\r\n      if(typeof(options.clickable) === 'function') {\r\n        this.container.addEventListener('click', (e) => {\r\n          if(this.freezed) return;\r\n          (options.clickable as any)(e);\r\n        });\r\n      }\r\n\r\n      this.container.classList.add('row-clickable', 'hover-effect');\r\n\r\n      if(!options.noRipple) {\r\n        ripple(this.container, undefined, undefined, true);\r\n      }\r\n\r\n      /* if(options.radioField || options.checkboxField) {\r\n        this.container.prepend(this.container.lastElementChild);\r\n      } */\r\n    }\r\n  }\r\n\r\n  public createMedia(size?: 'small') {\r\n    this.container.classList.add('row-with-padding');\r\n    \r\n    const media = this.media = document.createElement('div');\r\n    media.classList.add('row-media');\r\n\r\n    if(size) {\r\n      media.classList.add('row-media-' + size);\r\n    }\r\n\r\n    this.container.append(media);\r\n\r\n    return media;\r\n  }\r\n}\r\n\r\nexport const RadioFormFromRows = (rows: Row[], onChange: (value: string) => void) => {\r\n  return RadioForm(rows.map((r) => ({container: r.container, input: r.radioField.input})), onChange);\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// https://stackoverflow.com/a/30810322\r\nfunction fallbackCopyTextToClipboard(text: string) {\r\n  var textArea = document.createElement(\"textarea\");\r\n  textArea.value = text;\r\n  \r\n  // Avoid scrolling to bottom\r\n  textArea.style.top = \"0\";\r\n  textArea.style.left = \"0\";\r\n  textArea.style.position = \"fixed\";\r\n\r\n  document.body.appendChild(textArea);\r\n  textArea.focus();\r\n  textArea.select();\r\n\r\n  try {\r\n    document.execCommand('copy');\r\n    //const successful = document.execCommand('copy');\r\n    //const msg = successful ? 'successful' : 'unsuccessful';\r\n    //console.log('Fallback: Copying text command was ' + msg);\r\n  } catch(err) {\r\n    //console.error('Fallback: Oops, unable to copy', err);\r\n  }\r\n\r\n  document.body.removeChild(textArea);\r\n}\r\n\r\nexport function copyTextToClipboard(text: string) {\r\n  if(!navigator.clipboard) {\r\n    fallbackCopyTextToClipboard(text);\r\n    return;\r\n  }\r\n  \r\n  navigator.clipboard.writeText(text);/* .then(function() {\r\n    console.log('Async: Copying to clipboard was successful!');\r\n  }, function(err) {\r\n    console.error('Async: Could not copy text: ', err);\r\n  }); */\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getDeepProperty from \"../helpers/object/getDeepProperty\";\r\nimport { LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport apiManagerProxy from \"../lib/mtproto/mtprotoworker\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport default class RadioField {\r\n  public input: HTMLInputElement;\r\n  public label: HTMLLabelElement;\r\n  public main: HTMLElement;\r\n\r\n  constructor(options: {\r\n    text?: string, \r\n    langKey?: LangPackKey,\r\n    name: string, \r\n    value?: string, \r\n    stateKey?: string,\r\n    alignRight?: boolean\r\n  }) {\r\n    const label = this.label = document.createElement('label');\r\n    label.classList.add('radio-field');\r\n\r\n    if(options.alignRight) {\r\n      label.classList.add('radio-field-right');\r\n    }\r\n  \r\n    const input = this.input = document.createElement('input');\r\n    input.type = 'radio';\r\n    /* input.id =  */input.name = 'input-radio-' + options.name;\r\n  \r\n    if(options.value) {\r\n      input.value = options.value;\r\n  \r\n      if(options.stateKey) {\r\n        apiManagerProxy.getState().then((state) => {\r\n          input.checked = getDeepProperty(state, options.stateKey) === options.value;\r\n        });\r\n    \r\n        input.addEventListener('change', () => {\r\n          rootScope.managers.appStateManager.setByKey(options.stateKey, options.value);\r\n        });\r\n      }\r\n    }\r\n  \r\n    const main = this.main = document.createElement('div');\r\n    main.classList.add('radio-field-main');\r\n  \r\n    if(options.text) {\r\n      main.innerHTML = options.text;\r\n      /* const caption = document.createElement('div');\r\n      caption.classList.add('radio-field-main-caption');\r\n      caption.innerHTML = text;\r\n  \r\n      if(subtitle) {\r\n        label.classList.add('radio-field-with-subtitle');\r\n        caption.insertAdjacentHTML('beforeend', `<div class=\"radio-field-main-subtitle\">${subtitle}</div>`);\r\n      }\r\n  \r\n      main.append(caption); */\r\n    } else if(options.langKey) {\r\n      _i18n(main, options.langKey);\r\n    }\r\n  \r\n    label.append(input, main);\r\n  }\r\n\r\n  get checked() {\r\n    return this.input.checked;\r\n  }\r\n\r\n  set checked(checked: boolean) {\r\n    this.setValueSilently(checked);\r\n\r\n    const event = new Event('change', {bubbles: true, cancelable: true});\r\n    this.input.dispatchEvent(event);\r\n  }\r\n\r\n  public setValueSilently(checked: boolean) {\r\n    this.input.checked = checked;\r\n  }\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../lib/langPack\";\r\n\r\nconst toastEl = document.createElement('div');\r\ntoastEl.classList.add('toast');\r\nexport function toast(content: string | Node) {\r\n  replaceContent(toastEl, content);\r\n  document.body.append(toastEl);\r\n\r\n  if(toastEl.dataset.timeout) clearTimeout(+toastEl.dataset.timeout);\r\n  toastEl.dataset.timeout = '' + setTimeout(() => {\r\n    toastEl.remove();\r\n    delete toastEl.dataset.timeout;\r\n  }, 3000);\r\n}\r\n\r\nexport function toastNew(options: Partial<{\r\n  langPackKey: LangPackKey,\r\n  langPackArguments: FormatterArguments\r\n}>) {\r\n  toast(i18n(options.langPackKey, options.langPackArguments));\r\n}\r\n","export default function isUsernameValid(username: string) {\r\n  return ((username.length >= 5 && username.length <= 32) || !username.length) && /^[a-zA-Z0-9_]*$/.test(username);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport { LangPackKey } from \"../lib/langPack\";\r\nimport InputField, { InputFieldOptions, InputState } from \"./inputField\";\r\nimport isUsernameValid from \"../lib/richTextProcessor/isUsernameValid\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\n\r\nexport class UsernameInputField extends InputField {\r\n  private checkUsernamePromise: Promise<any>;\r\n  private checkUsernameDebounced: (username: string) => void;\r\n  public options: InputFieldOptions & {\r\n    peerId?: PeerId,\r\n    listenerSetter: ListenerSetter,\r\n    onChange?: () => void,\r\n    invalidText: LangPackKey,\r\n    takenText: LangPackKey,\r\n    availableText: LangPackKey,\r\n    head?: string\r\n  };\r\n\r\n  constructor(\r\n    options: UsernameInputField['options'], \r\n    private managers: AppManagers\r\n  ) {\r\n    super(options);\r\n\r\n    this.checkUsernameDebounced = debounce(this.checkUsername.bind(this), 150, false, true);\r\n\r\n    options.listenerSetter.add(this.input)('input', () => {\r\n      const value = this.getValue();\r\n\r\n      //console.log('userNameInput:', value);\r\n      if(value === this.originalValue || !value.length) {\r\n        this.setState(InputState.Neutral, this.options.label);\r\n        this.options.onChange && this.options.onChange();\r\n        return;\r\n      } else if(!isUsernameValid(value)) { // does not check the last underscore\r\n        this.setError(this.options.invalidText);\r\n      } else {\r\n        this.setState(InputState.Neutral);\r\n      }\r\n\r\n      if(this.input.classList.contains('error')) {\r\n        this.options.onChange && this.options.onChange();\r\n        return;\r\n      }\r\n\r\n      this.checkUsernameDebounced(value);\r\n    });\r\n  }\r\n\r\n  public getValue() {\r\n    let value = this.value;\r\n    if(this.options.head) {\r\n      value = value.slice(this.options.head.length);\r\n      this.setValueSilently(this.options.head + value);\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  private checkUsername(username: string) {\r\n    if(this.checkUsernamePromise) return;\r\n\r\n    if(this.options.peerId) {\r\n      this.checkUsernamePromise = this.managers.appChatsManager.checkUsername(this.options.peerId.toChatId(), username);\r\n    } else {\r\n      this.checkUsernamePromise = this.managers.appUsersManager.checkUsername(username);\r\n    }\r\n\r\n    this.checkUsernamePromise.then((available) => {\r\n      if(this.getValue() !== username) return;\r\n\r\n      if(available) {\r\n        this.setState(InputState.Valid, this.options.availableText);\r\n      } else {\r\n        this.setError(this.options.takenText);\r\n      }\r\n    }, (err) => {\r\n      if(this.getValue() !== username) return;\r\n\r\n      switch(err.type) {\r\n        case 'USERNAME_INVALID': {\r\n          this.setError(this.options.invalidText);\r\n          break;\r\n        }\r\n      }\r\n    }).then(() => {\r\n      this.checkUsernamePromise = undefined;\r\n      this.options.onChange && this.options.onChange();\r\n\r\n      const value = this.getValue();\r\n      if(value !== username && this.isValidToChange() && isUsernameValid(value)) {\r\n        this.checkUsername(value);\r\n      }\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarElement from \"../avatar\";\r\nimport PopupElement, { addCancelButton, PopupButton, PopupOptions } from \".\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport CheckboxField, { CheckboxFieldOptions } from \"../checkboxField\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\n\r\nexport type PopupPeerButton = Omit<PopupButton, 'callback'> & Partial<{callback: PopupPeerButtonCallback}>;\r\nexport type PopupPeerButtonCallbackCheckboxes = Set<LangPackKey>;\r\nexport type PopupPeerButtonCallback = (checkboxes?: PopupPeerButtonCallbackCheckboxes) => void;\r\nexport type PopupPeerCheckboxOptions = CheckboxFieldOptions & {checkboxField?: CheckboxField};\r\n\r\nexport type PopupPeerOptions = PopupOptions & Partial<{\r\n  peerId: PeerId,\r\n  title: string | HTMLElement,\r\n  titleLangKey?: LangPackKey,\r\n  titleLangArgs?: any[],\r\n  noTitle?: boolean,\r\n  description: string | DocumentFragment,\r\n  descriptionLangKey?: LangPackKey,\r\n  descriptionLangArgs?: any[],\r\n  buttons?: Array<PopupPeerButton>,\r\n  checkboxes: Array<PopupPeerCheckboxOptions>\r\n}>;\r\nexport default class PopupPeer extends PopupElement {\r\n  protected description: HTMLParagraphElement;\r\n\r\n  constructor(private className: string, options: PopupPeerOptions = {}) {\r\n    super('popup-peer' + (className ? ' ' + className : ''), options.buttons && addCancelButton(options.buttons), {overlayClosable: true, ...options});\r\n\r\n    if(options.peerId) {\r\n      const avatarEl = new AvatarElement();\r\n      avatarEl.classList.add('avatar-32');\r\n      avatarEl.updateWithOptions({\r\n        isDialog: true,\r\n        peerId: options.peerId\r\n      });\r\n      this.header.prepend(avatarEl);\r\n    }\r\n\r\n    if(!options.noTitle) {\r\n      if(options.titleLangKey || !options.title) this.title.append(i18n(options.titleLangKey || 'AppName', options.titleLangArgs));\r\n      else if(options.title instanceof HTMLElement) {\r\n        this.title.append(options.title);\r\n      } else this.title.innerText = options.title || '';\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n\r\n    if(options.descriptionLangKey || options.description) {\r\n      const p = this.description = document.createElement('p');\r\n      p.classList.add('popup-description');\r\n      if(options.descriptionLangKey) p.append(i18n(options.descriptionLangKey, options.descriptionLangArgs));\r\n      else if(options.description) setInnerHTML(p, options.description);\r\n  \r\n      fragment.append(p);\r\n    }\r\n\r\n    if(options.checkboxes) {\r\n      this.container.classList.add('have-checkbox');\r\n      \r\n      options.checkboxes.forEach((o) => {\r\n        o.withRipple = false;\r\n        const checkboxField = new CheckboxField(o);\r\n        o.checkboxField = checkboxField;\r\n        fragment.append(checkboxField.label);\r\n      });\r\n\r\n      options.buttons.forEach((button) => {\r\n        if(button.callback) {\r\n          const original = button.callback;\r\n          button.callback = () => {\r\n            const c: Set<LangPackKey> = new Set();\r\n            options.checkboxes.forEach((o) => {\r\n              if(o.checkboxField.checked) {\r\n                c.add(o.text);\r\n              }\r\n            });\r\n            original(c);\r\n          };\r\n        }\r\n      });\r\n    }\r\n\r\n    this.container.insertBefore(fragment, this.header.nextElementSibling);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { copyTextToClipboard } from \"../../../helpers/clipboard\";\r\nimport { randomLong } from \"../../../helpers/random\";\r\nimport { Chat, ChatFull, ExportedChatInvite } from \"../../../layer\";\r\nimport Button from \"../../button\";\r\nimport { setButtonLoader } from \"../../putPreloader\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { toast } from \"../../toast\";\r\nimport { UsernameInputField } from \"../../usernameInputField\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\n\r\nexport default class AppChatTypeTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n  public chatFull: ChatFull;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'group-type-container');\r\n\r\n    const isBroadcast = await this.managers.appChatsManager.isBroadcast(this.chatId);\r\n\r\n    this.setTitle(isBroadcast ? 'ChannelType' : 'GroupType');\r\n\r\n    const section = new SettingSection({\r\n      name: isBroadcast ? 'ChannelType' : 'GroupType'\r\n    });\r\n\r\n    const random = randomLong();\r\n    const privateRow = new Row({\r\n      radioField: new RadioField({\r\n        langKey: isBroadcast ? 'ChannelPrivate' : 'MegaPrivate', \r\n        name: random, \r\n        value: 'private'\r\n      }),\r\n      subtitleLangKey: isBroadcast ? 'ChannelPrivateInfo' : 'MegaPrivateInfo'\r\n    });\r\n    const publicRow = new Row({\r\n      radioField: new RadioField({\r\n        langKey: isBroadcast ? 'ChannelPublic' : 'MegaPublic', \r\n        name: random, \r\n        value: 'public'\r\n      }),\r\n      subtitleLangKey: isBroadcast ? 'ChannelPublicInfo' : 'MegaPublicInfo'\r\n    });\r\n    const form = RadioFormFromRows([privateRow, publicRow], (value) => {\r\n      const a = [privateSection, publicSection];\r\n      if(value === 'public') a.reverse();\r\n\r\n      a[0].container.classList.remove('hide');\r\n      a[1].container.classList.add('hide');\r\n\r\n      onChange();\r\n    });\r\n\r\n    const chat: Chat = await this.managers.appChatsManager.getChat(this.chatId);\r\n\r\n    section.content.append(form);\r\n\r\n    const privateSection = new SettingSection({});\r\n\r\n    //let revoked = false;\r\n    const linkRow = new Row({\r\n      title: (this.chatFull.exported_invite as ExportedChatInvite.chatInviteExported).link,\r\n      subtitleLangKey: isBroadcast ? 'ChannelPrivateLinkHelp' : 'MegaPrivateLinkHelp',\r\n      clickable: () => {\r\n        copyTextToClipboard((this.chatFull.exported_invite as ExportedChatInvite.chatInviteExported).link);\r\n        toast(I18n.format('LinkCopied', true));\r\n      }\r\n    });\r\n\r\n    const btnRevoke = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'RevokeLink'});\r\n\r\n    attachClickEvent(btnRevoke, () => {\r\n      new PopupPeer('revoke-link', {\r\n        buttons: [{\r\n          langKey: 'RevokeButton',\r\n          callback: () => {\r\n            const toggle = toggleDisability([btnRevoke], true);\r\n            \r\n            this.managers.appProfileManager.getChatInviteLink(this.chatId, true).then((link) => {\r\n              toggle();\r\n              linkRow.title.innerHTML = link;\r\n              //revoked = true;\r\n              //onChange();\r\n            });\r\n          }\r\n        }],\r\n        titleLangKey: 'RevokeLink',\r\n        descriptionLangKey: 'RevokeAlert'\r\n      }).show();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    privateSection.content.append(linkRow.container, btnRevoke);\r\n\r\n    const publicSection = new SettingSection({\r\n      caption: isBroadcast ? 'Channel.UsernameAboutChannel' : 'Channel.UsernameAboutGroup',\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const placeholder = 't.me/';\r\n\r\n    const onChange = () => {\r\n      const changed = (privateRow.radioField.checked && (originalValue !== placeholder/*  || revoked */)) \r\n        || (linkInputField.isValidToChange() && linkInputField.input.classList.contains('valid'));\r\n      applyBtn.classList.toggle('is-visible', changed);\r\n    };\r\n\r\n    const linkInputField = new UsernameInputField({\r\n      label: 'SetUrlPlaceholder',\r\n      name: 'group-public-link',\r\n      plainText: true,\r\n      listenerSetter: this.listenerSetter,\r\n      availableText: 'Link.Available',\r\n      invalidText: 'Link.Invalid',\r\n      takenText: 'Link.Taken',\r\n      onChange: onChange,\r\n      peerId: this.chatId.toPeerId(true),\r\n      head: placeholder\r\n    }, this.managers);\r\n\r\n    const originalValue = placeholder + ((chat as Chat.channel).username || '');\r\n\r\n    inputWrapper.append(linkInputField.container)\r\n    publicSection.content.append(inputWrapper);\r\n\r\n    const applyBtn = ButtonCorner({icon: 'check', className: 'is-visible'});\r\n    this.content.append(applyBtn);\r\n\r\n    attachClickEvent(applyBtn, () => {\r\n      /* const unsetLoader =  */setButtonLoader(applyBtn);\r\n      const username = publicRow.radioField.checked ? linkInputField.getValue() : '';\r\n      this.managers.appChatsManager.migrateChat(this.chatId).then((channelId) => {\r\n        return this.managers.appChatsManager.updateUsername(channelId, username);\r\n      }).then(() => {\r\n        //unsetLoader();\r\n        this.close();\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    (originalValue !== placeholder ? publicRow : privateRow).radioField.checked = true;\r\n    linkInputField.setOriginalValue(originalValue);\r\n\r\n    this.scrollable.append(section.container, privateSection.container, publicSection.container);\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'SavingContentTitle',\r\n        caption: isBroadcast ? 'RestrictSavingContentInfoChannel' : 'RestrictSavingContentInfoGroup'\r\n      });\r\n\r\n      const checkboxField = new CheckboxField({\r\n        text: 'RestrictSavingContent',\r\n        withRipple: true\r\n      });\r\n\r\n      this.listenerSetter.add(checkboxField.input)('change', () => {\r\n        const toggle = checkboxField.toggleDisability(true);\r\n        this.managers.appChatsManager.toggleNoForwards(this.chatId, checkboxField.checked).then(() => {\r\n          toggle();\r\n        });\r\n      });\r\n\r\n      const onChatUpdate = () => {\r\n        checkboxField.setValueSilently(!!(chat as Chat.channel).pFlags.noforwards);\r\n      };\r\n\r\n      this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n        if(this.chatId === chatId) {\r\n          onChatUpdate();\r\n        }\r\n      });\r\n\r\n      onChatUpdate();\r\n\r\n      section.content.append(checkboxField.label);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport default class ScrollableLoader {\r\n  public loading = false;\r\n  private scrollable: Scrollable;\r\n  private getPromise: () => Promise<boolean>;\r\n  private promise: Promise<any>;\r\n  private loaded = false;\r\n\r\n  constructor(options: {\r\n    scrollable: ScrollableLoader['scrollable'],\r\n    getPromise: ScrollableLoader['getPromise']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    options.scrollable.onScrolledBottom = () => {\r\n      this.load();\r\n    };\r\n  }\r\n  \r\n  public load() {\r\n    if(this.loaded) {\r\n      return Promise.resolve();\r\n    }\r\n    \r\n    if(this.loading) {\r\n      return this.promise;\r\n    }\r\n\r\n    this.loading = true;\r\n    this.promise = this.getPromise().then((done) => {\r\n      this.loading = false;\r\n      this.promise = undefined;\r\n\r\n      if(done) {\r\n        this.loaded = true;\r\n        this.scrollable.onScrolledBottom = null;\r\n      } else {\r\n        this.scrollable.checkForTriggers();\r\n      }\r\n    }, () => {\r\n      this.promise = undefined;\r\n      this.loading = false;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_WORKER } from \"./context\";\r\n\r\nexport class WindowSize {\r\n  public width: number;\r\n  public height: number;\r\n\r\n  constructor() {\r\n    if(IS_WORKER) {\r\n      return;\r\n    }\r\n    \r\n    // @ts-ignore\r\n    const w: any = 'visualViewport' in window ? window.visualViewport : window;\r\n    const set = () => {\r\n      this.width = w.width || w.innerWidth;\r\n      this.height = w.height || w.innerHeight;\r\n    };\r\n    w.addEventListener('resize', set);\r\n    set();\r\n  }\r\n}\r\n\r\nconst windowSize = new WindowSize();\r\nexport default windowSize;\r\n","type K = boolean;\r\nexport default async function filterAsync<T>(arr: T[], callback: (item: T, idx: number, arr: T[]) => Promise<K> | K) {\r\n  const promises = arr.map(async(item, idx, arr) => {\r\n    if(await callback(item, idx, arr)) {\r\n      return item;\r\n    }\r\n  });\r\n\r\n  return (await Promise.all(promises)).filter(Boolean);\r\n}\r\n","export default function numberThousandSplitter(x: number, joiner = ' ') {\r\n  const parts = x.toString().split(\".\");\r\n  parts[0] = parts[0].replace(/\\B(?=(\\d{3})+(?!\\d))/g, joiner);\r\n  return parts.join(\".\");\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport numberThousandSplitter from \"../../helpers/number/numberThousandSplitter\";\r\nimport { Chat, ChatParticipants } from \"../../layer\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport default async function getChatMembersString(chatId: ChatId, managers = rootScope.managers) {\r\n  const chat: Chat = await managers.appChatsManager.getChat(chatId);\r\n  if(chat._ === 'chatForbidden') {\r\n    return i18n('YouWereKicked');\r\n  }\r\n\r\n  const chatFull = await managers.appProfileManager.getCachedFullChat(chatId);\r\n  let count: number;\r\n  if(chatFull) {\r\n    if(chatFull._ === 'channelFull') {\r\n      count = chatFull.participants_count;\r\n    } else {\r\n      count = (chatFull.participants as ChatParticipants.chatParticipants).participants?.length;\r\n    }\r\n  } else {\r\n    count = (chat as Chat.chat).participants_count || (chat as any).participants?.participants.length;\r\n  }\r\n\r\n  const isBroadcast = (chat as Chat.channel).pFlags.broadcast;\r\n  count = count || 1;\r\n\r\n  let key: LangPackKey = isBroadcast ? 'Peer.Status.Subscribers' : 'Peer.Status.Member';\r\n  return i18n(key, [numberThousandSplitter(count)]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { ChatRights } from \"../lib/appManagers/appChatsManager\";\r\nimport type { Dialog } from \"../lib/appManagers/appMessagesManager\";\r\nimport appDialogsManager from \"../lib/appManagers/appDialogsManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { FocusDirection } from \"../helpers/fastSmoothScroll\";\r\nimport CheckboxField from \"./checkboxField\";\r\nimport { i18n, LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport findUpAttribute from \"../helpers/dom/findUpAttribute\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport type { IsPeerType } from \"../lib/appManagers/appPeersManager\";\r\nimport { generateDelimiter, SettingSection } from \"./sidebarLeft\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport filterUnique from \"../helpers/array/filterUnique\";\r\nimport indexOfAndSplice from \"../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport AvatarElement from \"./avatar\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport filterAsync from \"../helpers/array/filterAsync\";\r\nimport getParticipantPeerId from \"../lib/appManagers/utils/chats/getParticipantPeerId\";\r\nimport getChatMembersString from \"./wrappers/getChatMembersString\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport { Chat, User } from \"../layer\";\r\nimport canSendToUser from \"../lib/appManagers/utils/users/canSendToUser\";\r\nimport hasRights from \"../lib/appManagers/utils/chats/hasRights\";\r\nimport getDialogIndex from \"../lib/appManagers/utils/dialogs/getDialogIndex\";\r\n\r\ntype SelectSearchPeerType = 'contacts' | 'dialogs' | 'channelParticipants';\r\n\r\n// TODO: правильная сортировка для addMembers, т.е. для peerType: 'contacts', потому что там идут сначала контакты - потом неконтакты, а должно всё сортироваться по имени\r\n\r\nexport default class AppSelectPeers {\r\n  public container = document.createElement('div');\r\n  public list = appDialogsManager.createChatList(/* {\r\n    handheldsSize: 66,\r\n    avatarSize: 48\r\n  } */);\r\n  private chatsContainer = document.createElement('div');\r\n  public scrollable: Scrollable;\r\n  private selectedScrollable: Scrollable;\r\n  \r\n  private selectedContainer: HTMLElement;\r\n  public input: HTMLInputElement;\r\n  \r\n  //public selected: {[peerId: PeerId]: HTMLElement} = {};\r\n  public selected = new Set<PeerId | string>();\r\n\r\n  public freezed = false;\r\n\r\n  private folderId = 0;\r\n  private offsetIndex = 0;\r\n  private promise: Promise<any>;\r\n\r\n  private query = '';\r\n  private cachedContacts: PeerId[];\r\n\r\n  private loadedWhat: Partial<{[k in 'dialogs' | 'archived' | 'contacts' | 'channelParticipants']: true}> = {};\r\n\r\n  private renderedPeerIds: Set<PeerId> = new Set();\r\n\r\n  private appendTo: HTMLElement;\r\n  private onChange: (length: number) => void;\r\n  private peerType: SelectSearchPeerType[] = ['dialogs'];\r\n  private renderResultsFunc: (peerIds: PeerId[]) => void | Promise<void>;\r\n  private chatRightsAction: ChatRights;\r\n  private multiSelect = true;\r\n  private rippleEnabled = true;\r\n  private avatarSize = 48;\r\n  private exceptSelf = false;\r\n  private filterPeerTypeBy: IsPeerType[];\r\n\r\n  private tempIds: {[k in keyof AppSelectPeers['loadedWhat']]: number} = {};\r\n  private peerId: PeerId;\r\n\r\n  private placeholder: LangPackKey;\r\n\r\n  private selfPresence: LangPackKey = 'Presence.YourChat';\r\n  \r\n  private needSwitchList = false;\r\n\r\n  private sectionNameLangPackKey: LangPackKey;\r\n\r\n  private managers: AppManagers;\r\n  \r\n  constructor(options: {\r\n    appendTo: AppSelectPeers['appendTo'], \r\n    onChange?: AppSelectPeers['onChange'], \r\n    peerType?: AppSelectPeers['peerType'], \r\n    peerId?: AppSelectPeers['peerId'],\r\n    onFirstRender?: () => void, \r\n    renderResultsFunc?: AppSelectPeers['renderResultsFunc'], \r\n    chatRightsAction?: AppSelectPeers['chatRightsAction'], \r\n    multiSelect?: AppSelectPeers['multiSelect'],\r\n    rippleEnabled?: AppSelectPeers['rippleEnabled'],\r\n    avatarSize?: AppSelectPeers['avatarSize'],\r\n    placeholder?: AppSelectPeers['placeholder'],\r\n    selfPresence?: AppSelectPeers['selfPresence'],\r\n    exceptSelf?: AppSelectPeers['exceptSelf'],\r\n    filterPeerTypeBy?: AppSelectPeers['filterPeerTypeBy'],\r\n    sectionNameLangPackKey?: AppSelectPeers['sectionNameLangPackKey'],\r\n    managers: AppSelectPeers['managers']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.container.classList.add('selector');\r\n\r\n    const f = (this.renderResultsFunc || this.renderResults).bind(this);\r\n    this.renderResultsFunc = async(peerIds) => {\r\n      if(this.needSwitchList) {\r\n        this.scrollable.splitUp.replaceWith(this.list);\r\n        this.scrollable.setVirtualContainer(this.list);\r\n        this.needSwitchList = false;\r\n      }\r\n      \r\n      peerIds = peerIds.filter((peerId) => {\r\n        const notRendered = !this.renderedPeerIds.has(peerId);\r\n        if(notRendered) this.renderedPeerIds.add(peerId);\r\n        return notRendered;\r\n      });\r\n\r\n      if(this.filterPeerTypeBy) {\r\n        peerIds = await filterAsync(peerIds, async(peerId) => {\r\n          if(peerId.isPeerId()) {\r\n            const peer = await this.managers.appPeersManager.getPeer(peerId);\r\n            if(!peer.deleted) {\r\n              for(const method of this.filterPeerTypeBy) {\r\n                if(await this.managers.appPeersManager[method](peerId)) {\r\n                  return true;\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          return true;\r\n        });\r\n      }\r\n\r\n      return f(peerIds);\r\n    };\r\n\r\n    this.input = document.createElement('input');\r\n    this.input.classList.add('selector-search-input');\r\n    if(this.placeholder) {\r\n      _i18n(this.input, this.placeholder, undefined, 'placeholder');\r\n    } else {\r\n      _i18n(this.input, 'SendMessageTo', undefined, 'placeholder');\r\n    }\r\n\r\n    this.input.type = 'text';\r\n\r\n    if(this.multiSelect) {\r\n      const section = new SettingSection({});\r\n      section.innerContainer.classList.add('selector-search-section');\r\n      let topContainer = document.createElement('div');\r\n      topContainer.classList.add('selector-search-container');\r\n  \r\n      this.selectedContainer = document.createElement('div');\r\n      this.selectedContainer.classList.add('selector-search');\r\n      \r\n      this.selectedContainer.append(this.input);\r\n      topContainer.append(this.selectedContainer);\r\n      this.selectedScrollable = new Scrollable(topContainer);\r\n  \r\n      // let delimiter = document.createElement('hr');\r\n\r\n      attachClickEvent(this.selectedContainer, (e) => {\r\n        if(this.freezed) return;\r\n        let target = e.target as HTMLElement;\r\n        target = findUpClassName(target, 'selector-user');\r\n  \r\n        if(!target) return;\r\n  \r\n        const peerId = target.dataset.key;\r\n        const li = this.chatsContainer.querySelector('[data-peer-id=\"' + peerId + '\"]') as HTMLElement;\r\n        if(!li) {\r\n          this.remove(peerId.toPeerId());\r\n        } else {\r\n          li.click();\r\n        }\r\n      });\r\n\r\n      section.content.append(topContainer);\r\n      this.container.append(section.container/* , delimiter */);\r\n    }\r\n\r\n    this.chatsContainer.classList.add('chatlist-container');\r\n    // this.chatsContainer.append(this.list);\r\n    const section = new SettingSection({\r\n      name: this.sectionNameLangPackKey,\r\n      noShadow: true\r\n    });\r\n    section.content.append(this.list);\r\n    this.chatsContainer.append(section.container);\r\n    this.scrollable = new Scrollable(this.chatsContainer);\r\n    this.scrollable.setVirtualContainer(this.list);\r\n\r\n    attachClickEvent(this.chatsContainer, (e) => {\r\n      const target = findUpAttribute(e.target, 'data-peer-id') as HTMLElement;\r\n      cancelEvent(e);\r\n\r\n      if(!target) return;\r\n      if(this.freezed) return;\r\n\r\n      let key: PeerId | string = target.dataset.peerId;\r\n      key = key.isPeerId() ? key.toPeerId() : key;\r\n\r\n      if(!this.multiSelect) {\r\n        this.add(key);\r\n        return;\r\n      }\r\n\r\n      //target.classList.toggle('active');\r\n      if(this.selected.has(key)) {\r\n        this.remove(key);\r\n      } else {\r\n        this.add(key);\r\n      }\r\n\r\n      const checkbox = target.querySelector('input') as HTMLInputElement;\r\n      checkbox.checked = !checkbox.checked;\r\n    });\r\n\r\n    const debouncedInput = debounce(this.onInput, 200, false, true);\r\n    this.input.addEventListener('input', debouncedInput);\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      this.getMoreResults();\r\n    };\r\n\r\n    this.scrollable.container.prepend(generateDelimiter());\r\n\r\n    this.container.append(this.chatsContainer);\r\n    this.appendTo.append(this.container);\r\n\r\n    // WARNING TIMEOUT\r\n    setTimeout(() => {\r\n      let getResultsPromise = this.getMoreResults() as Promise<any>;\r\n      if(options.onFirstRender) {\r\n        getResultsPromise.then(() => {\r\n          options.onFirstRender();\r\n        });\r\n      }\r\n    }, 0);\r\n  }\r\n\r\n  private onInput = () => {\r\n    const value = this.input.value;\r\n    if(this.query !== value) {\r\n      if(this.peerType.includes('contacts') || this.peerType.includes('dialogs')) {\r\n        this.cachedContacts = null;\r\n      }\r\n      \r\n      if(this.peerType.includes('dialogs')) {\r\n        this.folderId = 0;\r\n        this.offsetIndex = 0;\r\n      }\r\n\r\n      for(let i in this.tempIds) {\r\n        // @ts-ignore\r\n        ++this.tempIds[i];\r\n      }\r\n\r\n      this.list = appDialogsManager.createChatList();\r\n\r\n      this.promise = null;\r\n      this.loadedWhat = {};\r\n      this.query = value;\r\n      this.renderedPeerIds.clear();\r\n      this.needSwitchList = true;\r\n      \r\n      //console.log('selectPeers input:', this.query);\r\n      this.getMoreResults();\r\n    }\r\n  };\r\n\r\n  private async renderSaved() {\r\n    if(\r\n      !this.exceptSelf && \r\n      !this.offsetIndex && \r\n      this.folderId === 0 && \r\n      this.peerType.includes('dialogs') && \r\n      (!this.query || await this.managers.appUsersManager.testSelfSearch(this.query))\r\n    ) {\r\n      await this.renderResultsFunc([rootScope.myId]);\r\n    }\r\n  }\r\n\r\n  private getTempId(type: keyof AppSelectPeers['tempIds']) {\r\n    if(this.tempIds[type] === undefined) {\r\n      this.tempIds[type] = 0;\r\n    }\r\n\r\n    return ++this.tempIds[type];\r\n  }\r\n\r\n  private async getMoreDialogs(): Promise<any> {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.dialogs && this.loadedWhat.archived) {\r\n      return;\r\n    }\r\n    \r\n    // в десктопе - сначала без группы, потом архивные, потом контакты без сообщений\r\n    const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n\r\n    const tempId = this.getTempId('dialogs');\r\n    const promise = this.managers.appMessagesManager.getConversations(this.query, this.offsetIndex, pageCount, this.folderId, true);\r\n    this.promise = promise;\r\n    const value = await promise;\r\n    if(this.tempIds.dialogs !== tempId) {\r\n      return;\r\n    }\r\n\r\n    this.promise = null;\r\n\r\n    let dialogs = value.dialogs as Dialog[];\r\n    if(dialogs.length) {\r\n      const newOffsetIndex = getDialogIndex(dialogs[dialogs.length - 1]) || 0;\r\n\r\n      dialogs = dialogs.slice();\r\n      findAndSplice(dialogs, d => d.peerId === rootScope.myId); // no my account\r\n\r\n      if(this.chatRightsAction) {\r\n        dialogs = await filterAsync(dialogs, (d) => this.filterByRights(d.peerId));\r\n      }\r\n\r\n      await this.renderSaved();\r\n\r\n      this.offsetIndex = newOffsetIndex;\r\n    }\r\n\r\n    this.renderResultsFunc(dialogs.map((dialog) => dialog.peerId));\r\n    \r\n    if(value.isEnd) {\r\n      if(!this.loadedWhat.dialogs) {\r\n        await this.renderSaved();\r\n\r\n        this.loadedWhat.dialogs = true;\r\n        this.offsetIndex = 0;\r\n        this.folderId = 1;\r\n\r\n        return this.getMoreDialogs();\r\n      } else {\r\n        this.loadedWhat.archived = true;\r\n\r\n        if(!this.loadedWhat.contacts/*  && this.peerType.includes('contacts') */) {\r\n          return this.getMoreContacts();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async filterByRights(peerId: PeerId) {\r\n    const peer: User | Chat = await this.managers.appPeersManager.getPeer(peerId);\r\n    if(peerId.isUser()) {\r\n      return this.chatRightsAction !== 'send_messages' || canSendToUser(peer as User.user);\r\n    } else if(hasRights(peer as Chat.chat, this.chatRightsAction)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private async getMoreContacts() {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.contacts) {\r\n      return;\r\n    }\r\n\r\n    const isGlobalSearch = this.peerType.includes('contacts');\r\n\r\n    if(!this.cachedContacts) {\r\n      /* const promises: Promise<any>[] = [appUsersManager.getContacts(this.query)];\r\n      if(!this.peerType.includes('dialogs')) {\r\n        promises.push(appMessagesManager.getConversationsAll());\r\n      }\r\n\r\n      this.promise = Promise.all(promises);\r\n      this.cachedContacts = (await this.promise)[0].slice(); */\r\n      const tempId = this.getTempId('contacts');\r\n      const promise = Promise.all([\r\n        isGlobalSearch ? this.managers.appUsersManager.getContactsPeerIds(this.query) : [],\r\n        this.query ? this.managers.appUsersManager.searchContacts(this.query) : undefined\r\n      ]);\r\n\r\n      this.promise = promise;\r\n      let [cachedContacts, searchResult] = await promise;\r\n      if(this.tempIds.contacts !== tempId) {\r\n        return;\r\n      }\r\n\r\n      if(searchResult) {\r\n        // do not add global result if only dialogs needed\r\n        let resultPeerIds = isGlobalSearch ? searchResult.my_results.concat(searchResult.results) : searchResult.my_results;\r\n\r\n        if(this.chatRightsAction) {\r\n          resultPeerIds = await filterAsync(resultPeerIds, (peerId) => this.filterByRights(peerId));\r\n        }\r\n\r\n        if(!this.peerType.includes('dialogs')) {\r\n          resultPeerIds = resultPeerIds.filter((peerId) => peerId.isUser());\r\n        }\r\n\r\n        this.cachedContacts = filterUnique(cachedContacts.concat(resultPeerIds));\r\n      } else this.cachedContacts = cachedContacts.slice();\r\n\r\n      indexOfAndSplice(this.cachedContacts, rootScope.myId); // no my account\r\n      this.promise = null;\r\n    }\r\n\r\n    // if(this.cachedContacts.length) {\r\n      const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n      const arr = this.cachedContacts.splice(0, pageCount);\r\n      this.renderResultsFunc(arr);\r\n    // }\r\n    \r\n    if(!this.cachedContacts.length) {\r\n      this.loadedWhat.contacts = true;\r\n\r\n      // need to load non-contacts\r\n      /* if(!this.peerType.includes('dialogs')) {\r\n        return this.getMoreDialogs();\r\n      } */\r\n    }\r\n  }\r\n\r\n  private async getMoreChannelParticipants() {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.channelParticipants) {\r\n      return;\r\n    }\r\n\r\n    const pageCount = 50; // same as in group permissions to use cache\r\n\r\n    const tempId = this.getTempId('channelParticipants');\r\n    const promise = this.managers.appProfileManager.getChannelParticipants(this.peerId.toChatId(), {_: 'channelParticipantsSearch', q: this.query}, pageCount, this.list.childElementCount);\r\n    const participants = await promise;\r\n    if(this.tempIds.channelParticipants !== tempId) {\r\n      return;\r\n    }\r\n    \r\n    const peerIds = participants.participants.map((participant) => {\r\n      return getParticipantPeerId(participant);\r\n    });\r\n    indexOfAndSplice(peerIds, rootScope.myId);\r\n    this.renderResultsFunc(peerIds);\r\n\r\n    if(this.list.childElementCount >= participants.count || participants.participants.length < pageCount) {\r\n      this.loadedWhat.channelParticipants = true;\r\n    }\r\n  }\r\n\r\n  checkForTriggers = () => {\r\n    this.scrollable.checkForTriggers();\r\n  };\r\n\r\n  private getMoreResults() {\r\n    const get = () => {\r\n      const promises: Promise<any>[] = [];\r\n\r\n      // if(!loadedAllDialogs && (this.peerType.includes('dialogs')/*  || this.peerType.includes('contacts') */)) {\r\n      //   if(!loadAllDialogsPromise) {\r\n      //     loadAllDialogsPromise = appMessagesManager.getConversationsAll()\r\n      //     .then(() => {\r\n      //       loadedAllDialogs = true;\r\n      //     }).finally(() => {\r\n      //       loadAllDialogsPromise = null;\r\n      //     });\r\n      //   }\r\n\r\n      //   promises.push(loadAllDialogsPromise);\r\n      // }\r\n  \r\n      if((this.peerType.includes('dialogs')/*  || this.loadedWhat.contacts */) && !this.loadedWhat.archived) { // to load non-contacts\r\n        promises.push(this.getMoreDialogs());\r\n  \r\n        if(!this.loadedWhat.archived) {\r\n          return promises;\r\n        }\r\n      }\r\n      \r\n      if((this.peerType.includes('contacts') || this.peerType.includes('dialogs')) && !this.loadedWhat.contacts) {\r\n        promises.push(this.getMoreContacts());\r\n      }\r\n\r\n      if(this.peerType.includes('channelParticipants') && !this.loadedWhat.channelParticipants) {\r\n        promises.push(this.getMoreChannelParticipants());\r\n      }\r\n  \r\n      return promises;\r\n    };\r\n    \r\n    const promises = get();\r\n    const promise = Promise.all(promises);\r\n    if(promises.length) {\r\n      promise.then(this.checkForTriggers);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async renderResults(peerIds: PeerId[]) {\r\n    //console.log('will renderResults:', peerIds);\r\n\r\n    // оставим только неконтакты с диалогов\r\n    if(!this.peerType.includes('dialogs') && this.loadedWhat.contacts) {\r\n      peerIds = await filterAsync(peerIds, (peerId) => {\r\n        return this.managers.appUsersManager.isNonContactUser(peerId);\r\n      });\r\n    }\r\n\r\n    peerIds.forEach(async(peerId) => {\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: this.scrollable,\r\n        rippleEnabled: this.rippleEnabled,\r\n        avatarSize: this.avatarSize\r\n      });\r\n\r\n      if(this.multiSelect) {\r\n        const selected = this.selected.has(peerId);\r\n        const checkboxField = new CheckboxField();\r\n\r\n        if(selected) {\r\n          //dom.listEl.classList.add('active');\r\n          checkboxField.input.checked = true;\r\n        }\r\n\r\n        dom.containerEl.prepend(checkboxField.label);\r\n      }\r\n\r\n      let subtitleEl: HTMLElement;\r\n      if(peerId.isAnyChat()) {\r\n        subtitleEl = await getChatMembersString(peerId.toChatId());\r\n      } else if(peerId === rootScope.myId) {\r\n        subtitleEl = i18n(this.selfPresence);\r\n      } else {\r\n        subtitleEl = getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId()));\r\n      }\r\n\r\n      dom.lastMessageSpan.append(subtitleEl);\r\n    });\r\n  }\r\n\r\n  public add(key: PeerId | string, title?: string | HTMLElement, scroll = true) {\r\n    //console.trace('add');\r\n    this.selected.add(key);\r\n\r\n    if(!this.multiSelect) {\r\n      this.onChange(this.selected.size);\r\n      return;\r\n    }\r\n\r\n    if(this.query.trim()) {\r\n      this.input.value = '';\r\n      this.onInput();\r\n    }\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('selector-user', 'scale-in');\r\n\r\n    const avatarEl = new AvatarElement();\r\n    avatarEl.classList.add('selector-user-avatar', 'tgico', 'avatar-32');\r\n    avatarEl.isDialog = true;\r\n\r\n    div.dataset.key = '' + key;\r\n    if(key.isPeerId()) {\r\n      if(title === undefined) {\r\n        title = new PeerTitle({peerId: key.toPeerId(), dialog: true}).element;\r\n      }\r\n\r\n      avatarEl.updateWithOptions({\r\n        peerId: key as PeerId\r\n      });\r\n    }\r\n\r\n    if(title) {\r\n      if(typeof(title) === 'string') {\r\n        div.innerHTML = title;\r\n      } else {\r\n        replaceContent(div, title);\r\n        div.append(title);\r\n      }\r\n    }\r\n\r\n    div.insertAdjacentElement('afterbegin', avatarEl);\r\n\r\n    this.selectedContainer.insertBefore(div, this.input);\r\n    //this.selectedScrollable.scrollTop = this.selectedScrollable.scrollHeight;\r\n    this.onChange && this.onChange(this.selected.size);\r\n    \r\n    if(scroll) {\r\n      this.selectedScrollable.scrollIntoViewNew({\r\n        element: this.input, \r\n        position: 'center'\r\n      });\r\n    }\r\n    \r\n    return div;\r\n  }\r\n\r\n  public remove(key: PeerId | string) {\r\n    if(!this.multiSelect) return;\r\n    //const div = this.selected[peerId];\r\n    const div = this.selectedContainer.querySelector(`[data-key=\"${key}\"]`) as HTMLElement;\r\n    div.classList.remove('scale-in');\r\n    void div.offsetWidth;\r\n    div.classList.add('scale-out');\r\n\r\n    const onAnimationEnd = () => {\r\n      this.selected.delete(key);\r\n      div.remove();\r\n      this.onChange && this.onChange(this.selected.size);\r\n    };\r\n\r\n    if(rootScope.settings.animationsEnabled) {\r\n      div.addEventListener('animationend', onAnimationEnd, {once: true});\r\n    } else {\r\n      onAnimationEnd();\r\n    }\r\n  }\r\n\r\n  public getSelected() {\r\n    return [...this.selected];\r\n  }\r\n\r\n  public addInitial(values: any[]) {\r\n    values.forEach((value) => {\r\n      this.add(value, undefined, false);\r\n    });\r\n\r\n    window.requestAnimationFrame(() => { // ! not the best place for this raf though it works\r\n      this.selectedScrollable.scrollIntoViewNew({\r\n        element: this.input, \r\n        position: 'center', \r\n        forceDirection: FocusDirection.Static\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport AppSelectPeers from \"../appSelectPeers\";\r\nimport PopupElement from \".\";\r\nimport { LangPackKey, _i18n } from \"../../lib/langPack\";\r\n\r\nexport default class PopupPickUser extends PopupElement {\r\n  protected selector: AppSelectPeers;\r\n  \r\n  constructor(options: {\r\n    peerTypes: AppSelectPeers['peerType'], \r\n    onSelect?: (peerId: PeerId) => Promise<void> | void, \r\n    placeholder: LangPackKey,\r\n    chatRightsAction?: AppSelectPeers['chatRightsAction'],\r\n    peerId?: number,\r\n    selfPresence?: LangPackKey\r\n  }) {\r\n    super('popup-forward', null, {closable: true, overlayClosable: true, body: true});\r\n\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.body, \r\n      onChange: async() => {\r\n        const selected = this.selector.getSelected();\r\n        const peerId = selected[selected.length - 1].toPeerId();\r\n        \r\n        if(options.onSelect) {\r\n          const res = options.onSelect(peerId);\r\n          if(res instanceof Promise) {\r\n            try {\r\n              await res;\r\n            } catch(err) {\r\n              return;\r\n            }\r\n          }\r\n        }\r\n\r\n        this.selector = null;\r\n        this.hide();\r\n      }, \r\n      peerType: options.peerTypes, \r\n      onFirstRender: () => {\r\n        this.show();\r\n        this.selector.checkForTriggers(); // ! due to zero height before mounting\r\n\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          this.selector.input.focus();\r\n        }\r\n      }, \r\n      chatRightsAction: options.chatRightsAction, \r\n      multiSelect: false,\r\n      rippleEnabled: false,\r\n      avatarSize: 46,\r\n      peerId: options.peerId,\r\n      placeholder: options.placeholder,\r\n      selfPresence: options.selfPresence,\r\n      managers: this.managers\r\n    });\r\n\r\n    //this.scrollable = new Scrollable(this.body);\r\n\r\n    this.title.append(this.selector.input);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport { ChannelParticipant } from \"../../../layer\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport Button from \"../../button\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport { ChatPermissions } from \"./groupPermissions\";\r\n\r\nexport default class AppUserPermissionsTab extends SliderSuperTabEventable {\r\n  public participant: ChannelParticipant;\r\n  public chatId: ChatId;\r\n  public userId: UserId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'user-permissions-container');\r\n    this.setTitle('UserRestrictions');\r\n\r\n    let destroyListener: () => void;\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'UserRestrictionsCanDo',\r\n      });\r\n      \r\n      const div = document.createElement('div');\r\n      div.classList.add('chatlist-container');\r\n      section.content.insertBefore(div, section.title);\r\n\r\n      const list = appDialogsManager.createChatList({new: true});\r\n      div.append(list);\r\n\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: this.userId.toPeerId(false),\r\n        container: list,\r\n        rippleEnabled: true,\r\n        avatarSize: 48\r\n      });\r\n\r\n      dom.lastMessageSpan.append(getUserStatusString(await this.managers.appUsersManager.getUser(this.userId)));\r\n\r\n      const p = new ChatPermissions({\r\n        chatId: this.chatId,\r\n        listenerSetter: this.listenerSetter,\r\n        appendTo: section.content,\r\n        participant: this.participant._ === 'channelParticipantBanned' ? this.participant : undefined\r\n      }, this.managers);\r\n\r\n      destroyListener = () => {\r\n        //appChatsManager.editChatDefaultBannedRights(this.chatId, p.takeOut());\r\n        const rights = p.takeOut();\r\n        if(this.participant._ === 'channelParticipantBanned' && deepEqual(this.participant.banned_rights.pFlags, rights.pFlags)) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appChatsManager.editBanned(this.chatId, this.participant, rights);\r\n      };\r\n\r\n      this.eventListener.addEventListener('destroy', destroyListener, {once: true});\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({});\r\n\r\n      if(this.participant._ === 'channelParticipantBanned') {\r\n        const btnDeleteException = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'GroupPermission.Delete'});\r\n\r\n        attachClickEvent(btnDeleteException, () => {\r\n          const toggle = toggleDisability([btnDeleteException], true);\r\n          this.managers.appChatsManager.clearChannelParticipantBannedRights(this.chatId, this.participant).then(() => {\r\n            this.eventListener.removeEventListener('destroy', destroyListener);\r\n            this.close();\r\n          }, () => {\r\n            toggle();\r\n          });\r\n        }, {listenerSetter: this.listenerSetter});\r\n  \r\n        section.content.append(btnDeleteException);\r\n      }\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'deleteuser', text: 'UserRestrictionsBlock'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        const toggle = toggleDisability([btnDelete], true);\r\n        this.managers.appChatsManager.kickFromChannel(this.chatId, this.participant).then(() => {\r\n          this.eventListener.removeEventListener('destroy', destroyListener);\r\n          this.close();\r\n        });\r\n        /* new PopupPeer('popup-group-kick-user', {\r\n          peerId: -this.chatId,\r\n          title: 'Ban User?',\r\n          description: `Are you sure you want to ban <b>${appPeersManager.getPeerTitle(this.userId)}</b>`,\r\n          buttons: addCancelButton([{\r\n            text: 'BAN',\r\n            callback: () => {\r\n              const toggle = toggleDisability([btnDelete], true);\r\n\r\n              appChatsManager.kickFromChannel(this.chatId, this.participant).then(() => {\r\n                this.eventListener.removeEventListener('destroy', destroyListener);\r\n                this.close();\r\n              }, () => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true\r\n          }])\r\n        }).show(); */\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpTag from \"../../../helpers/dom/findUpTag\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport ListenerSetter from \"../../../helpers/listenerSetter\";\r\nimport ScrollableLoader from \"../../../helpers/scrollableLoader\";\r\nimport { ChannelParticipant, Chat, ChatBannedRights, Update } from \"../../../layer\";\r\nimport { ChatRights } from \"../../../lib/appManagers/appChatsManager\";\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport combineParticipantBannedRights from \"../../../lib/appManagers/utils/chats/combineParticipantBannedRights\";\r\nimport hasRights from \"../../../lib/appManagers/utils/chats/hasRights\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport I18n, { i18n, join, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { toast } from \"../../toast\";\r\nimport AppUserPermissionsTab from \"./userPermissions\";\r\n\r\nexport class ChatPermissions {\r\n  public v: Array<{\r\n    flags: ChatRights[],\r\n    text: LangPackKey,\r\n    exceptionText: LangPackKey,\r\n    checkboxField?: CheckboxField,\r\n  }>;\r\n  private toggleWith: Partial<{[chatRight in ChatRights]: ChatRights[]}>;\r\n\r\n  constructor(private options: {\r\n    chatId: ChatId,\r\n    listenerSetter: ListenerSetter,\r\n    appendTo: HTMLElement,\r\n    participant?: ChannelParticipant.channelParticipantBanned\r\n  }, private managers: AppManagers) {\r\n    this.construct();\r\n  }\r\n\r\n  public async construct() {\r\n    this.v = [\r\n      {flags: ['send_messages'], text: 'UserRestrictionsSend', exceptionText: 'UserRestrictionsNoSend'},\r\n      {flags: ['send_media'], text: 'UserRestrictionsSendMedia', exceptionText: 'UserRestrictionsNoSendMedia'},\r\n      {flags: ['send_stickers', 'send_gifs'], text: 'UserRestrictionsSendStickers', exceptionText: 'UserRestrictionsNoSendStickers'},\r\n      {flags: ['send_polls'], text: 'UserRestrictionsSendPolls', exceptionText: 'UserRestrictionsNoSendPolls'},\r\n      {flags: ['embed_links'], text: 'UserRestrictionsEmbedLinks', exceptionText: 'UserRestrictionsNoEmbedLinks'},\r\n      {flags: ['invite_users'], text: 'UserRestrictionsInviteUsers', exceptionText: 'UserRestrictionsNoInviteUsers'},\r\n      {flags: ['pin_messages'], text: 'UserRestrictionsPinMessages', exceptionText: 'UserRestrictionsNoPinMessages'},\r\n      {flags: ['change_info'], text: 'UserRestrictionsChangeInfo', exceptionText: 'UserRestrictionsNoChangeInfo'}\r\n    ];\r\n\r\n    this.toggleWith = {\r\n      'send_messages': ['send_media', 'send_stickers', 'send_polls', 'embed_links']\r\n    };\r\n\r\n    const options = this.options;\r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(options.chatId);\r\n    const defaultBannedRights = chat.default_banned_rights;\r\n    const rights = options.participant ? combineParticipantBannedRights(chat as Chat.channel, options.participant.banned_rights) : defaultBannedRights;\r\n    \r\n    const restrictionText: LangPackKey = options.participant ? 'UserRestrictionsDisabled' : 'EditCantEditPermissionsPublic';\r\n    for(const info of this.v) {\r\n      const mainFlag = info.flags[0];\r\n      info.checkboxField = new CheckboxField({\r\n        text: info.text,\r\n        checked: hasRights(chat, mainFlag, rights),\r\n        restriction: true,\r\n        withRipple: true\r\n      });\r\n\r\n      if((\r\n          options.participant && \r\n          defaultBannedRights.pFlags[mainFlag as keyof typeof defaultBannedRights['pFlags']]\r\n        ) || (\r\n          (chat as Chat.channel).username &&\r\n          (\r\n            info.flags.includes('pin_messages') ||\r\n            info.flags.includes('change_info')\r\n          )\r\n        )\r\n      ) {\r\n        info.checkboxField.input.disabled = true;\r\n        \r\n        /* options.listenerSetter.add(info.checkboxField.input)('change', (e) => {\r\n          if(!e.isTrusted) {\r\n            return;\r\n          }\r\n\r\n          cancelEvent(e);\r\n          toast('This option is disabled for all members in Group Permissions.');\r\n          info.checkboxField.checked = false;\r\n        }); */\r\n\r\n        attachClickEvent(info.checkboxField.label, (e) => {\r\n          toast(I18n.format(restrictionText, true));\r\n        }, {listenerSetter: options.listenerSetter});\r\n      }\r\n\r\n      if(this.toggleWith[mainFlag]) {\r\n        options.listenerSetter.add(info.checkboxField.input)('change', () => {\r\n          if(!info.checkboxField.checked) {\r\n            const other = this.v.filter((i) => this.toggleWith[mainFlag].includes(i.flags[0]));\r\n            other.forEach((info) => {\r\n              info.checkboxField.checked = false;\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      options.appendTo.append(info.checkboxField.label);\r\n    }\r\n  }\r\n\r\n  public takeOut() {\r\n    const rights: ChatBannedRights = {\r\n      _: 'chatBannedRights',\r\n      until_date: 0x7FFFFFFF,\r\n      pFlags: {}\r\n    };\r\n\r\n    for(const info of this.v) {\r\n      const banned = !info.checkboxField.checked;\r\n      if(banned) {\r\n        info.flags.forEach((flag) => {\r\n          // @ts-ignore\r\n          rights.pFlags[flag] = true;\r\n        });\r\n      }\r\n    }\r\n\r\n    return rights;\r\n  }\r\n}\r\n\r\nexport default class AppGroupPermissionsTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'group-permissions-container');\r\n    this.setTitle('ChannelPermissions');\r\n\r\n    let chatPermissions: ChatPermissions;\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'ChannelPermissionsHeader',\r\n      });\r\n\r\n      chatPermissions = new ChatPermissions({\r\n        chatId: this.chatId,\r\n        listenerSetter: this.listenerSetter,\r\n        appendTo: section.content,\r\n      }, this.managers);\r\n\r\n      this.eventListener.addEventListener('destroy', () => {\r\n        this.managers.appChatsManager.editChatDefaultBannedRights(this.chatId, chatPermissions.takeOut());\r\n      }, {once: true});\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({\r\n        name: 'PrivacyExceptions'\r\n      });\r\n\r\n      const addExceptionRow = new Row({\r\n        titleLangKey: 'ChannelAddException',\r\n        subtitleLangKey: 'Loading',\r\n        icon: 'adduser',\r\n        clickable: () => {\r\n          new PopupPickUser({\r\n            peerTypes: ['channelParticipants'],\r\n            onSelect: (peerId) => {\r\n              setTimeout(() => {\r\n                openPermissions(peerId);\r\n              }, 0);\r\n            },\r\n            placeholder: 'ExceptionModal.Search.Placeholder',\r\n            peerId: -this.chatId,\r\n          });\r\n        }\r\n      });\r\n\r\n      const openPermissions = async(peerId: PeerId) => {\r\n        let participant: AppUserPermissionsTab['participant'];\r\n        try {\r\n          participant = await this.managers.appProfileManager.getChannelParticipant(this.chatId, peerId) as any;\r\n        } catch(err) {\r\n          toast('User is no longer participant');\r\n          return;\r\n        }\r\n\r\n        const tab = this.slider.createTab(AppUserPermissionsTab);\r\n        tab.participant = participant;\r\n        tab.chatId = this.chatId;\r\n        tab.userId = peerId;\r\n        tab.open();\r\n      };\r\n\r\n      section.content.append(addExceptionRow.container);\r\n\r\n      /* const removedUsersRow = new Row({\r\n        titleLangKey: 'ChannelBlockedUsers',\r\n        subtitleLangKey: 'NoBlockedUsers',\r\n        icon: 'deleteuser',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(removedUsersRow.container); */\r\n\r\n      const c = section.generateContentElement();\r\n      c.classList.add('chatlist-container');\r\n      \r\n      const list = appDialogsManager.createChatList({new: true});\r\n      c.append(list);\r\n\r\n      attachClickEvent(list, (e) => {\r\n        const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n        if(!target) return;\r\n\r\n        const peerId = target.dataset.peerId.toPeerId();\r\n        openPermissions(peerId);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      const setSubtitle = async(li: Element, participant: ChannelParticipant.channelParticipantBanned) => {\r\n        const bannedRights = participant.banned_rights;//appChatsManager.combineParticipantBannedRights(this.chatId, participant.banned_rights);\r\n        const defaultBannedRights = ((await this.managers.appChatsManager.getChat(this.chatId)) as Chat.channel).default_banned_rights;\r\n        //const combinedRights = appChatsManager.combineParticipantBannedRights(this.chatId, bannedRights);\r\n\r\n        const cantWhat: LangPackKey[] = []/* , canWhat: LangPackKey[] = [] */;\r\n        chatPermissions.v.forEach((info) => {\r\n          const mainFlag = info.flags[0];\r\n          // @ts-ignore\r\n          if(bannedRights.pFlags[mainFlag] && !defaultBannedRights.pFlags[mainFlag]) {\r\n            cantWhat.push(info.exceptionText);\r\n          // @ts-ignore\r\n          }/*  else if(!combinedRights.pFlags[mainFlag]) {\r\n            canWhat.push(info.exceptionText);\r\n          } */\r\n        });\r\n\r\n        const el = li.querySelector('.user-last-message') as HTMLElement;\r\n\r\n        if(cantWhat.length) {\r\n          el.innerHTML = '';\r\n          el.append(...join(cantWhat.map((t) => i18n(t)), false));\r\n        }/*  else if(canWhat.length) {\r\n          str = 'Can ' + canWhat.join(canWhat.length === 2 ? ' and ' : ', ');\r\n        } */\r\n  \r\n        el.classList.toggle('hide', !cantWhat.length);\r\n      };\r\n\r\n      const add = (participant: ChannelParticipant.channelParticipantBanned, append: boolean) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: getPeerId(participant.peer),\r\n          container: list,\r\n          rippleEnabled: true,\r\n          avatarSize: 48,\r\n          append\r\n        });\r\n\r\n        setSubtitle(dom.listEl, participant);\r\n\r\n        //dom.titleSpan.innerHTML = 'Chinaza Akachi';\r\n        //dom.lastMessageSpan.innerHTML = 'Can Add Users and Pin Messages';\r\n      };\r\n\r\n      // this.listenerSetter.add(rootScope)('updateChannelParticipant', (update: Update.updateChannelParticipant) => {\r\n      //   const needAdd = update.new_participant?._ === 'channelParticipantBanned' && !update.new_participant.banned_rights.pFlags.view_messages;\r\n      //   const li = list.querySelector(`[data-peer-id=\"${update.user_id}\"]`);\r\n      //   if(needAdd) {\r\n      //     if(!li) {\r\n      //       add(update.new_participant as ChannelParticipant.channelParticipantBanned, false);\r\n      //     } else {\r\n      //       setSubtitle(li, update.new_participant as ChannelParticipant.channelParticipantBanned);\r\n      //     }\r\n\r\n      //     if(update.prev_participant?._ !== 'channelParticipantBanned') {\r\n      //       ++exceptionsCount;\r\n      //     }\r\n      //   } else {\r\n      //     if(li) {\r\n      //       li.remove();\r\n      //     }\r\n\r\n      //     if(update.prev_participant?._ === 'channelParticipantBanned') {\r\n      //       --exceptionsCount;\r\n      //     }\r\n      //   }\r\n\r\n      //   setLength();\r\n      // });\r\n\r\n      const setLength = () => {\r\n        replaceContent(addExceptionRow.subtitle, i18n(exceptionsCount ? 'Permissions.ExceptionsCount' : 'Permissions.NoExceptions', [exceptionsCount]));\r\n      };\r\n\r\n      let exceptionsCount = 0;\r\n      let loader: ScrollableLoader;\r\n      const setLoader = () => {\r\n        const LOAD_COUNT = 50;\r\n        loader = new ScrollableLoader({\r\n          scrollable: this.scrollable,\r\n          getPromise: () => {\r\n            return this.managers.appProfileManager.getChannelParticipants(this.chatId, {_: 'channelParticipantsBanned', q: ''}, LOAD_COUNT, list.childElementCount).then((res) => {\r\n              for(const participant of res.participants) {\r\n                add(participant as ChannelParticipant.channelParticipantBanned, true);\r\n              }\r\n  \r\n              exceptionsCount = res.count;\r\n              setLength();\r\n  \r\n              return res.participants.length < LOAD_COUNT || res.count === list.childElementCount;\r\n            });\r\n          }\r\n        });\r\n\r\n        return loader.load();\r\n      };\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      if(await this.managers.appChatsManager.isChannel(this.chatId)) {\r\n        await setLoader();\r\n      } else {\r\n        setLength();\r\n        \r\n        this.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n          if(this.chatId === migrateFrom) {\r\n            this.chatId = migrateTo;\r\n            setLoader();\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport copy from \"../../../../helpers/object/copy\";\r\nimport { ChatBannedRights, Chat } from \"../../../../layer\";\r\n\r\nexport default function combineParticipantBannedRights(chat: Chat.channel, rights: ChatBannedRights) {\r\n  if(chat.default_banned_rights) {\r\n    rights = copy(rights);\r\n    const defaultRights = chat.default_banned_rights.pFlags;\r\n    for(let i in defaultRights) {\r\n      // @ts-ignore\r\n      rights.pFlags[i] = defaultRights[i];\r\n    }\r\n  }\r\n\r\n  return rights;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport type { PeerType } from \"../../lib/appManagers/appPeersManager\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\n\r\nexport default class PopupDeleteDialog {\r\n  constructor(\r\n    private peerId: PeerId, \r\n    // actionType: 'leave' | 'delete', \r\n    private peerType?: PeerType, \r\n    private onSelect?: (promise: Promise<any>) => void\r\n  ) {\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    let {peerId, peerType, onSelect} = this;\r\n    const peerTitleElement = new PeerTitle({peerId}).element;\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n    if(peerType === undefined) {\r\n      peerType = await managers.appPeersManager.getDialogType(peerId);\r\n    }\r\n\r\n    /* const callbackFlush = (checked: PopupPeerButtonCallbackCheckboxes) => {\r\n      const promise = appMessagesManager.flushHistory(peerId, checkboxes ? !checked[checkboxes[0].text] : undefined);\r\n      onSelect && onSelect(promise);\r\n    }; */\r\n\r\n    const callbackLeave = (checked: PopupPeerButtonCallbackCheckboxes, flush = checkboxes && !!checked.size) => {\r\n      let promise = managers.appChatsManager.leave(peerId.toChatId());\r\n      \r\n      if(flush) {\r\n        promise = promise.finally(() => {\r\n          return managers.appMessagesManager.flushHistory(peerId);\r\n        }) as any;\r\n      }\r\n      \r\n      onSelect && onSelect(promise);\r\n    };\r\n\r\n    const callbackDelete = (checked: PopupPeerButtonCallbackCheckboxes) => {\r\n      let promise: Promise<any>;\r\n\r\n      if(peerId.isUser()) {\r\n        promise = managers.appMessagesManager.flushHistory(peerId, false, checkboxes ? !!checked.size : undefined);\r\n      } else {\r\n        if(checked.size) {\r\n          promise = managers.appChatsManager.delete(peerId.toChatId());\r\n        } else {\r\n          return callbackLeave(checked);\r\n        }\r\n      }\r\n      \r\n      onSelect && onSelect(promise);\r\n    };\r\n\r\n    let title: LangPackKey, description: LangPackKey, descriptionArgs: any[], buttons: PopupPeerOptions['buttons'], checkboxes: PopupPeerOptions['checkboxes'];\r\n    switch(peerType) {\r\n      case 'channel': {\r\n        if(/* actionType === 'delete' &&  */await managers.appChatsManager.hasRights(peerId.toChatId(), 'delete_chat')) {\r\n          title = 'ChannelDeleteMenu';\r\n          description = 'AreYouSureDeleteAndExitChannel';\r\n          buttons = [{\r\n            langKey: 'ChannelDeleteMenu',\r\n            isDanger: true,\r\n            callback: callbackDelete\r\n          }];\r\n\r\n          checkboxes = [{\r\n            text: 'DeleteChannelForAll'\r\n          }];\r\n        } else {\r\n          title = 'LeaveChannelMenu';\r\n          description = 'ChannelLeaveAlertWithName';\r\n          descriptionArgs = [peerTitleElement];\r\n          buttons = [{\r\n            langKey: 'LeaveChannel',\r\n            isDanger: true,\r\n            callback: callbackLeave\r\n          }];\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      /* case 'megagroup': {\r\n        title = 'Leave Group?';\r\n        description = `Are you sure you want to leave this group?`;\r\n        buttons = [{\r\n          text: 'LEAVE ' + peerTitleElement,\r\n          isDanger: true,\r\n          callback: callbackLeave\r\n        }];\r\n\r\n        break;\r\n      } */\r\n\r\n      case 'chat': {\r\n        title = 'DeleteChatUser';\r\n        description = 'AreYouSureDeleteThisChatWithUser';\r\n        descriptionArgs = [peerTitleElement];\r\n\r\n        buttons = [{\r\n          langKey: 'DeleteChatUser',\r\n          isDanger: true,\r\n          callback: callbackDelete\r\n        }];\r\n\r\n        checkboxes = [{\r\n          text: 'DeleteMessagesOptionAlso',\r\n          textArgs: [\r\n            new PeerTitle({peerId}).element\r\n          ]\r\n        }];\r\n\r\n        break;\r\n      }\r\n\r\n      case 'saved': {\r\n        title = 'DeleteChatUser';\r\n        description = 'AreYouSureDeleteThisChatSavedMessages';\r\n        buttons = [{\r\n          langKey: 'DeleteChatUser',\r\n          isDanger: true,\r\n          callback: callbackDelete\r\n        }];\r\n\r\n        break;\r\n      }\r\n\r\n      case 'megagroup':\r\n      case 'group': {\r\n        if(/* actionType === 'delete' &&  */await managers.appChatsManager.hasRights(peerId.toChatId(), 'delete_chat')) {\r\n          title = 'DeleteMegaMenu';\r\n          description = 'AreYouSureDeleteAndExit';\r\n          buttons = [{\r\n            langKey: 'DeleteMegaMenu',\r\n            isDanger: true,\r\n            callback: callbackDelete\r\n          }];\r\n\r\n          checkboxes = [{\r\n            text: 'DeleteChat.DeleteGroupForAll'\r\n          }];\r\n        } else {\r\n          title = 'LeaveMegaMenu';\r\n          description = 'AreYouSureDeleteAndExitName';\r\n          descriptionArgs = [peerTitleElement];\r\n          buttons = [{\r\n            langKey: 'DeleteChatUser',\r\n            isDanger: true,\r\n            callback: (checkboxes) => callbackLeave(checkboxes, true)\r\n          }];\r\n        }\r\n\r\n        break;\r\n      }\r\n    }\r\n\r\n    new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    }).show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport debounce from \"../../../helpers/schedulers/debounce\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { wrapStickerToRow } from \"../../wrappers\";\r\n\r\nexport default class AppChatReactionsTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n\r\n  protected async init() {\r\n    this.setTitle('Reactions');\r\n\r\n    const availableReactions = await this.managers.appReactionsManager.getActiveAvailableReactions();\r\n    const chatFull = await this.managers.appProfileManager.getChatFull(this.chatId);\r\n    let originalReactions = chatFull.available_reactions ?? [];\r\n    const enabledReactions = new Set(originalReactions);\r\n\r\n    const toggleSection = new SettingSection({\r\n      caption: await this.managers.appChatsManager.isBroadcast(this.chatId) ? 'EnableReactionsChannelInfo' : 'EnableReactionsGroupInfo'\r\n    });\r\n\r\n    const toggleCheckboxField = new CheckboxField({toggle: true, checked: !!enabledReactions.size});\r\n    const toggleRow = new Row({\r\n      checkboxField: toggleCheckboxField,\r\n      titleLangKey: 'EnableReactions'\r\n    });\r\n\r\n    toggleSection.content.append(toggleRow.container);\r\n\r\n    const reactionsSection = new SettingSection({\r\n      name: 'AvailableReactions'\r\n    });\r\n\r\n    const checkboxFields = availableReactions.map((availableReaction) => {\r\n      const checkboxField = new CheckboxField({\r\n        toggle: true, \r\n        checked: enabledReactions.has(availableReaction.reaction)\r\n      });\r\n\r\n      this.listenerSetter.add(checkboxField.input)('change', () => {\r\n        if(checkboxField.checked) {\r\n          enabledReactions.add(availableReaction.reaction);\r\n\r\n          if(!toggleCheckboxField.checked) {\r\n            toggleCheckboxField.setValueSilently(true);\r\n          }\r\n        } else {\r\n          enabledReactions.delete(availableReaction.reaction);\r\n\r\n          if(!enabledReactions.size && toggleCheckboxField.checked) {\r\n            toggleCheckboxField.setValueSilently(false);\r\n          }\r\n        }\r\n\r\n        saveReactionsDebounced();\r\n      });\r\n\r\n      const row = new Row({\r\n        checkboxField,\r\n        title: availableReaction.title,\r\n        havePadding: true\r\n      });\r\n\r\n      wrapStickerToRow({\r\n        row,\r\n        doc: availableReaction.static_icon,\r\n        size: 'small'\r\n      });\r\n\r\n      reactionsSection.content.append(row.container);\r\n\r\n      return checkboxField;\r\n    });\r\n\r\n    this.listenerSetter.add(toggleRow.checkboxField.input)('change', () => {\r\n      if(!toggleCheckboxField.checked) {\r\n        checkboxFields.forEach((checkboxField) => checkboxField.checked = false);\r\n        saveReactionsDebounced();\r\n      } else if(checkboxFields.every((checkboxField) => !checkboxField.checked)) {\r\n        checkboxFields.forEach((checkboxField) => checkboxField.checked = true);\r\n        saveReactionsDebounced();\r\n      }\r\n    });\r\n\r\n    const saveReactions = async() => {\r\n      const newReactions = Array.from(enabledReactions);\r\n      if([...newReactions].sort().join() === [...originalReactions].sort().join()) {\r\n        return;\r\n      }\r\n\r\n      const chatFull = await this.managers.appProfileManager.getCachedFullChat(this.chatId);\r\n      if(chatFull) {\r\n        chatFull.available_reactions = newReactions;\r\n      }\r\n      \r\n      this.managers.appChatsManager.setChatAvailableReactions(this.chatId, newReactions);\r\n      originalReactions = newReactions;\r\n    };\r\n\r\n    const saveReactionsDebounced = debounce(saveReactions, 3000, false, true);\r\n\r\n    this.eventListener.addEventListener('destroy', saveReactions, {once: true});\r\n\r\n    this.scrollable.append(toggleSection.container, reactionsSection.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\"\r\nimport InputField from \"../../inputField\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport Row from \"../../row\";\r\nimport Button from \"../../button\";\r\nimport { ChatRights } from \"../../../lib/appManagers/appChatsManager\";\r\nimport { Chat, ChatFull } from \"../../../layer\";\r\nimport AppChatTypeTab from \"./chatType\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppGroupPermissionsTab from \"./groupPermissions\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport PopupDeleteDialog from \"../../popups/deleteDialog\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport AppChatReactionsTab from \"./chatReactions\";\r\nimport hasRights from \"../../../lib/appManagers/utils/chats/hasRights\";\r\n\r\nexport default class AppEditChatTab extends SliderSuperTab {\r\n  private chatNameInputField: InputField;\r\n  private descriptionInputField: InputField;\r\n  private editPeer: EditPeer;\r\n  private tempId: number;\r\n  public chatId: ChatId;\r\n\r\n  protected async _init() {\r\n    // * cleanup prev\r\n    this.listenerSetter.removeAll();\r\n    this.scrollable.container.innerHTML = '';\r\n    this.tempId ??= 0;\r\n    const tempId = ++this.tempId;\r\n\r\n    this.container.classList.add('edit-peer-container', 'edit-group-container');\r\n    this.setTitle('Edit');\r\n    \r\n    let chatFull = await this.managers.appProfileManager.getChatFull(this.chatId, true);\r\n\r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(this.chatId);\r\n    const isBroadcast = await this.managers.appChatsManager.isBroadcast(this.chatId);\r\n    const isChannel = await this.managers.appChatsManager.isChannel(this.chatId);\r\n\r\n    const chatUpdateListeners: (() => void)[] = [];\r\n    const addChatUpdateListener = (callback: () => void) => {\r\n      chatUpdateListeners.push(callback);\r\n    };\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n      if(this.chatId === chatId) {\r\n        chatUpdateListeners.forEach((callback) => callback());\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_full_update', async(chatId) => {\r\n      if(this.chatId === chatId) {\r\n        chatFull = await this.managers.appProfileManager.getCachedFullChat(chatId) || chatFull;\r\n      }\r\n    });\r\n\r\n    const peerId = this.chatId.toPeerId(true);\r\n    const canChangeType = await this.managers.appChatsManager.hasRights(this.chatId, 'change_type');\r\n    const canChangePermissions = await this.managers.appChatsManager.hasRights(this.chatId, 'change_permissions');\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true});\r\n      const inputFields: InputField[] = [];\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      this.chatNameInputField = new InputField({\r\n        label: isBroadcast ? 'EnterChannelName' : 'CreateGroup.NameHolder',\r\n        name: 'chat-name',\r\n        maxLength: 255,\r\n        required: true\r\n      });\r\n      this.descriptionInputField = new InputField({\r\n        label: 'DescriptionPlaceholder',\r\n        name: 'chat-description',\r\n        maxLength: 255\r\n      });\r\n      \r\n      this.chatNameInputField.setOriginalValue(chat.title);\r\n      this.descriptionInputField.setOriginalValue(chatFull.about);\r\n\r\n      inputWrapper.append(this.chatNameInputField.container, this.descriptionInputField.container);\r\n      \r\n      inputFields.push(this.chatNameInputField, this.descriptionInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      section.content.append(this.editPeer.avatarEdit.container, inputWrapper);\r\n    \r\n      if(canChangeType) {\r\n        const chatTypeRow = new Row({\r\n          titleLangKey: isBroadcast ? 'ChannelType' : 'GroupType',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppChatTypeTab);\r\n            tab.chatId = this.chatId;\r\n            tab.chatFull = chatFull;\r\n            tab.open();\r\n\r\n            this.listenerSetter.add(tab.eventListener)('destroy', setChatTypeSubtitle);\r\n          },\r\n          icon: 'lock'\r\n        });\r\n\r\n        const setChatTypeSubtitle = () => {\r\n          chatTypeRow.subtitle.textContent = '';\r\n\r\n          let key: LangPackKey;\r\n          if(isBroadcast) {\r\n            key = (chat as Chat.channel).username ? 'TypePublic' : 'TypePrivate';\r\n          } else {\r\n            key = (chat as Chat.channel).username ? 'TypePublicGroup' : 'TypePrivateGroup';\r\n          }\r\n\r\n          chatTypeRow.subtitle.append(i18n(key));\r\n        };\r\n\r\n        setChatTypeSubtitle();\r\n        section.content.append(chatTypeRow.container);\r\n      }\r\n\r\n      if(canChangeType || canChangePermissions) {\r\n        const reactionsRow = new Row({\r\n          titleLangKey: 'Reactions',\r\n          icon: 'reactions',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppChatReactionsTab);\r\n            tab.chatId = this.chatId;\r\n            tab.open().then(() => {\r\n              if(this.tempId !== tempId) {\r\n                return;\r\n              }\r\n              \r\n              this.listenerSetter.add(tab.eventListener)('destroy', setReactionsLength);\r\n            });\r\n          }\r\n        });\r\n\r\n        const availableReactions = await this.managers.appReactionsManager.getAvailableReactions();\r\n        const availableReactionsLength = availableReactions.filter((availableReaction) => !availableReaction.pFlags.inactive).length;\r\n        const setReactionsLength = () => {\r\n          const reactions = chatFull.available_reactions ?? [];\r\n          reactionsRow.subtitle.innerHTML = reactions.length + '/' + availableReactionsLength;\r\n        };\r\n\r\n        setReactionsLength();\r\n\r\n        section.content.append(reactionsRow.container);\r\n      }\r\n\r\n      if(canChangePermissions && !isBroadcast) {\r\n        const flags = [\r\n          'send_messages',\r\n          'send_media',\r\n          'send_stickers',\r\n          'send_polls',\r\n          'embed_links',\r\n          'invite_users',\r\n          'pin_messages',\r\n          'change_info'\r\n        ] as ChatRights[];\r\n\r\n        const permissionsRow = new Row({\r\n          titleLangKey: 'ChannelPermissions',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppGroupPermissionsTab);\r\n            tab.chatId = this.chatId;\r\n            tab.open();\r\n          },\r\n          icon: 'permissions',\r\n        });\r\n\r\n        const setPermissionsLength = async() => {\r\n          const chat = await this.managers.appChatsManager.getChatTyped(this.chatId);\r\n          permissionsRow.subtitle.innerHTML = flags.reduce((acc, f) => acc + +hasRights(chat, f, (chat as Chat.chat).default_banned_rights), 0) + '/' + flags.length;\r\n        };\r\n\r\n        setPermissionsLength();        \r\n        section.content.append(permissionsRow.container);\r\n\r\n        this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n          if(this.chatId === chatId) {\r\n            setPermissionsLength();\r\n          }\r\n        });\r\n      }\r\n\r\n      /* const administratorsRow = new Row({\r\n        titleLangKey: 'PeerInfo.Administrators',\r\n        subtitle: '' + ((chatFull as ChatFull.channelFull).admins_count || 1),\r\n        icon: 'admin',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(administratorsRow.container); */\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      attachClickEvent(this.editPeer.nextBtn, () => {\r\n        this.editPeer.nextBtn.disabled = true;\r\n  \r\n        let promises: Promise<any>[] = [];\r\n\r\n        const id = this.chatId;\r\n        if(this.chatNameInputField.isValidToChange()) {\r\n          promises.push(this.managers.appChatsManager.editTitle(id, this.chatNameInputField.value));\r\n        }\r\n\r\n        if(this.descriptionInputField.isValidToChange()) {\r\n          promises.push(this.managers.appChatsManager.editAbout(id, this.descriptionInputField.value));\r\n        }\r\n\r\n        if(this.editPeer.uploadAvatar) {\r\n          promises.push(this.editPeer.uploadAvatar().then((inputFile) => {\r\n            return this.managers.appChatsManager.editPhoto(id, inputFile);\r\n          }));\r\n        }\r\n  \r\n        Promise.race(promises).finally(() => {\r\n          this.editPeer.nextBtn.removeAttribute('disabled');\r\n          this.close();\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      \r\n      /* if(appChatsManager.hasRights(-this.peerId, 'change_info')) {\r\n        const discussionRow = new Row({\r\n          titleLangKey: 'PeerInfo.Discussion',\r\n          subtitleLangKey: 'PeerInfo.Discussion.Add',\r\n          clickable: true,\r\n          icon: 'message'\r\n        });\r\n\r\n        section.content.append(discussionRow.container);\r\n      }\r\n\r\n      const administratorsRow = new Row({\r\n        titleLangKey: 'PeerInfo.Administrators',\r\n        subtitle: '' + chatFull.admins_count,\r\n        icon: 'admin',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(administratorsRow.container); */\r\n\r\n      if(isBroadcast && await this.managers.appChatsManager.hasRights(this.chatId, 'change_info')) {\r\n        const signMessagesCheckboxField = new CheckboxField({\r\n          text: 'PeerInfo.SignMessages',\r\n          checked: !!(chat as Chat.channel).pFlags.signatures,\r\n          withRipple: true\r\n        });\r\n\r\n        this.listenerSetter.add(signMessagesCheckboxField.input)('change', () => {\r\n          const toggle = signMessagesCheckboxField.toggleDisability(true);\r\n          this.managers.appChatsManager.toggleSignatures(this.chatId, signMessagesCheckboxField.checked).then(() => {\r\n            toggle();\r\n          });\r\n        });\r\n\r\n        addChatUpdateListener(() => {\r\n          signMessagesCheckboxField.setValueSilently(!!(chat as Chat.channel).pFlags.signatures);\r\n        });\r\n\r\n        section.content.append(signMessagesCheckboxField.label);\r\n      }\r\n    }\r\n\r\n    if(!isBroadcast) {\r\n      const section = new SettingSection({\r\n\r\n      });\r\n\r\n      /* const membersRow = new Row({\r\n        titleLangKey: isBroadcast ? 'PeerInfo.Subscribers' : 'GroupMembers',\r\n        icon: 'newgroup',\r\n        clickable: true\r\n      });\r\n\r\n      membersRow.subtitle.append(i18n('Subscribers', [numberThousandSplitter(335356)]));\r\n\r\n      section.content.append(membersRow.container); */\r\n\r\n      if(!isBroadcast && canChangeType) {\r\n        const showChatHistoryCheckboxField = new CheckboxField({\r\n          text: 'ChatHistory',\r\n          withRipple: true\r\n        });\r\n\r\n        this.listenerSetter.add(showChatHistoryCheckboxField.input)('change', () => {\r\n          const toggle = showChatHistoryCheckboxField.toggleDisability(true);\r\n          this.managers.appChatsManager.togglePreHistoryHidden(this.chatId, !showChatHistoryCheckboxField.checked).then(() => {\r\n            toggle();\r\n          });\r\n        });\r\n\r\n        // ! it won't be updated because chatFull will be old\r\n        const onChatUpdate = () => {\r\n          showChatHistoryCheckboxField.setValueSilently(isChannel && !(chatFull as ChatFull.channelFull).pFlags.hidden_prehistory);\r\n        };\r\n\r\n        onChatUpdate();\r\n        addChatUpdateListener(onChatUpdate);\r\n  \r\n        section.content.append(showChatHistoryCheckboxField.label);\r\n      }\r\n\r\n      if(section.content.childElementCount) {\r\n        this.scrollable.append(section.container);\r\n      }\r\n    }\r\n\r\n    if(await this.managers.appChatsManager.hasRights(this.chatId, 'delete_chat')) {\r\n      const section = new SettingSection({});\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'delete', text: isBroadcast ? 'PeerInfo.DeleteChannel' : 'DeleteAndExitButton'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        new PopupDeleteDialog(peerId/* , 'delete' */, undefined, (promise) => {\r\n          const toggle = toggleDisability([btnDelete], true);\r\n          promise.then(() => {\r\n            this.close();\r\n          }, () => {\r\n            toggle();\r\n          });\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    if(!isChannel) {\r\n      // ! this one will fire earlier than tab's closeAfterTimeout (destroy) event and listeners will be erased, so destroy won't fire\r\n      this.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n        if(peerId === migrateFrom) {\r\n          this.chatId = migrateTo.toChatId();\r\n          this._init();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  protected init() {\r\n    return this._init();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\n\r\nexport default function formatUserPhone(phone: string) {\r\n  return '+' + formatPhoneNumber(phone).formatted;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\"\r\nimport InputField from \"../../inputField\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport Row from \"../../row\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Button from \"../../button\";\r\nimport PeerTitle from \"../../peerTitle\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport { addCancelButton } from \"../../popups\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport formatUserPhone from \"../../wrappers/formatUserPhone\";\r\n\r\nexport default class AppEditContactTab extends SliderSuperTab {\r\n  private nameInputField: InputField;\r\n  private lastNameInputField: InputField;\r\n  private editPeer: EditPeer;\r\n  public peerId: PeerId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'edit-contact-container');\r\n    const isNew = !(await this.managers.appUsersManager.isContact(this.peerId.toUserId()));\r\n    this.setTitle(isNew ? 'AddContactTitle' : 'Edit');\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true});\r\n      const inputFields: InputField[] = [];\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      this.nameInputField = new InputField({\r\n        label: 'FirstName',\r\n        name: 'contact-name',\r\n        maxLength: 70,\r\n        required: true\r\n      });\r\n      this.lastNameInputField = new InputField({\r\n        label: 'LastName',\r\n        name: 'contact-lastname',\r\n        maxLength: 70\r\n      });\r\n\r\n      if(this.peerId) {\r\n        const user = await this.managers.appUsersManager.getUser(this.peerId);\r\n\r\n        if(isNew) {\r\n          this.nameInputField.setDraftValue(user.first_name);\r\n          this.lastNameInputField.setDraftValue(user.last_name);\r\n        } else {\r\n          this.nameInputField.setOriginalValue(user.first_name);\r\n          this.lastNameInputField.setOriginalValue(user.last_name);\r\n        }\r\n      }\r\n      \r\n      inputWrapper.append(this.nameInputField.container, this.lastNameInputField.container);\r\n      inputFields.push(this.nameInputField, this.lastNameInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId: this.peerId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter,\r\n        doNotEditAvatar: true\r\n      });\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      if(this.peerId) {\r\n        const div = document.createElement('div');\r\n        div.classList.add('avatar-edit');\r\n        div.append(this.editPeer.avatarElem);\r\n  \r\n        const notificationsCheckboxField = new CheckboxField({\r\n          text: 'Notifications'\r\n        });\r\n  \r\n        notificationsCheckboxField.input.addEventListener('change', (e) => {\r\n          if(!e.isTrusted) {\r\n            return;\r\n          }\r\n  \r\n          this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n        });\r\n  \r\n        this.listenerSetter.add(rootScope)('notify_settings', async(update) => {\r\n          if(update.peer._ !== 'notifyPeer') return;\r\n          const peerId = getPeerId(update.peer.peer);\r\n          if(this.peerId === peerId) {\r\n            const enabled = !(await this.managers.appNotificationsManager.isMuted(update.notify_settings));\r\n            if(enabled !== notificationsCheckboxField.checked) {\r\n              notificationsCheckboxField.checked = enabled;\r\n            }\r\n          }\r\n        });\r\n  \r\n        const profileNameDiv = document.createElement('div');\r\n        profileNameDiv.classList.add('profile-name');\r\n        profileNameDiv.append(new PeerTitle({\r\n          peerId: this.peerId\r\n        }).element);\r\n        //profileNameDiv.innerHTML = 'Karen Stanford';\r\n  \r\n        const profileSubtitleDiv = document.createElement('div');\r\n        profileSubtitleDiv.classList.add('profile-subtitle');\r\n        profileSubtitleDiv.append(i18n('EditContact.OriginalName'));\r\n\r\n        section.content.append(div, profileNameDiv, profileSubtitleDiv, inputWrapper);\r\n\r\n        if(!isNew) {\r\n          const notificationsRow = new Row({\r\n            checkboxField: notificationsCheckboxField\r\n          });\r\n    \r\n          const enabled = !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false));\r\n          notificationsCheckboxField.checked = enabled;\r\n\r\n          section.content.append(notificationsRow.container);\r\n        } else {\r\n          const user = await this.managers.appUsersManager.getUser(this.peerId);\r\n\r\n          const phoneRow = new Row({\r\n            icon: 'phone',\r\n            titleLangKey: user.phone ? undefined : 'MobileHidden',\r\n            title: user.phone ? formatUserPhone(user.phone)  : undefined,\r\n            subtitleLangKey: user.phone ? 'Phone' : 'MobileHiddenExceptionInfo',\r\n            subtitleLangArgs: user.phone ? undefined : [new PeerTitle({peerId: this.peerId}).element]\r\n          });\r\n\r\n          section.content.append(phoneRow.container);\r\n        }\r\n      } else {\r\n        section.content.append(inputWrapper);\r\n      }\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      attachClickEvent(this.editPeer.nextBtn, async() => {\r\n        this.editPeer.nextBtn.disabled = true;\r\n\r\n        this.managers.appUsersManager.addContact(\r\n          this.peerId, \r\n          this.nameInputField.value, \r\n          this.lastNameInputField.value, \r\n          (await this.managers.appUsersManager.getUser(this.peerId)).phone\r\n        ).finally(() => {\r\n          this.editPeer.nextBtn.removeAttribute('disabled');\r\n          this.close();\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n    }\r\n\r\n    if(!isNew) {\r\n      const section = new SettingSection({\r\n        \r\n      });\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'PeerInfo.DeleteContact'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        new PopupPeer('popup-delete-contact', {\r\n          peerId: this.peerId,\r\n          titleLangKey: 'DeleteContact',\r\n          descriptionLangKey: 'AreYouSureDeleteContact',\r\n          buttons: addCancelButton([{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              const toggle = toggleDisability([btnDelete], true);\r\n\r\n              this.managers.appUsersManager.deleteContacts([this.peerId]).then(() => {\r\n                this.close();\r\n              }, () => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true\r\n          }])\r\n        }).show();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AppSelectPeers from \"../../appSelectPeers\";\r\nimport { setButtonLoader } from \"../../putPreloader\";\r\nimport { LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\n\r\nexport default class AppAddMembersTab extends SliderSuperTab {\r\n  private nextBtn: HTMLButtonElement;\r\n  private selector: AppSelectPeers;\r\n  private peerType: 'channel' | 'chat' | 'privacy';\r\n  private takeOut: (peerIds: PeerId[]) => Promise<any> | false | void;\r\n  private skippable: boolean;\r\n\r\n  protected init() {\r\n    this.container.classList.add('add-members-container');\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n    this.content.append(this.nextBtn);\r\n    this.scrollable.container.remove();\r\n    \r\n    this.nextBtn.addEventListener('click', () => {\r\n      const peerIds = this.selector.getSelected().map((sel) => sel.toPeerId());\r\n\r\n      if(this.skippable) {\r\n        this.takeOut(peerIds);\r\n        this.close();\r\n      } else {\r\n        const promise = this.takeOut(peerIds);\r\n\r\n        if(promise instanceof Promise) {\r\n          this.attachToPromise(promise);\r\n        } else if(promise === undefined) {\r\n          this.close();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public attachToPromise(promise: Promise<any>) {\r\n    const removeLoader = setButtonLoader(this.nextBtn, 'arrow_next');\r\n\r\n    promise.then(() => {\r\n      this.close();\r\n    }, () => {\r\n      removeLoader();\r\n    });\r\n  }\r\n\r\n  public open(options: {\r\n    title: LangPackKey,\r\n    placeholder: LangPackKey,\r\n    type: AppAddMembersTab['peerType'], \r\n    takeOut?: AppAddMembersTab['takeOut'],\r\n    skippable: boolean,\r\n    selectedPeerIds?: PeerId[]\r\n  }) {\r\n    const ret = super.open();\r\n\r\n    this.setTitle(options.title);\r\n    this.peerType = options.type;\r\n    this.takeOut = options.takeOut;\r\n    this.skippable = options.skippable;\r\n\r\n    const isPrivacy = this.peerType === 'privacy';\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.content, \r\n      onChange: this.skippable ? null : (length) => {\r\n        this.nextBtn.classList.toggle('is-visible', !!length);\r\n      }, \r\n      peerType: [isPrivacy ? 'dialogs' : 'contacts'],\r\n      placeholder: options.placeholder,\r\n      exceptSelf: isPrivacy,\r\n      filterPeerTypeBy: isPrivacy ? ['isAnyGroup', 'isUser'] : undefined,\r\n      managers: this.managers\r\n    });\r\n\r\n    if(options.selectedPeerIds) {\r\n      this.selector.addInitial(options.selectedPeerIds);\r\n    }\r\n\r\n    this.nextBtn.classList.add('tgico-arrow_next');\r\n    this.nextBtn.innerHTML = '';\r\n    this.nextBtn.disabled = false;\r\n    this.nextBtn.classList.toggle('is-visible', this.skippable);\r\n\r\n    return ret;\r\n  }\r\n}","import { _i18n } from \"../lib/langPack\";\r\n\r\nexport default function generateFakeIcon(isScam?: boolean) {\r\n  const span = document.createElement('span');\r\n  span.classList.add('badge-fake');\r\n  _i18n(span, isScam ? 'ScamMessage' : 'FakeMessage');\r\n  return span;\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Chat, User } from \"../layer\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport generateFakeIcon from \"./generateFakeIcon\";\r\n// import generatePremiumIcon from \"./generatePremiumIcon\";\r\nimport generateVerifiedIcon from \"./generateVerifiedIcon\";\r\n\r\nexport default async function generateTitleIcons(peerId: PeerId) {\r\n  const elements: Element[] = [];\r\n  const peer: Chat | User = await rootScope.managers.appPeersManager.getPeer(peerId);\r\n  if((peer as Chat.channel)?.pFlags?.verified) {\r\n    elements.push(generateVerifiedIcon());\r\n  }\r\n\r\n  if((peer as Chat.channel).pFlags.fake || (peer as User.user).pFlags.scam) {\r\n    elements.push(generateFakeIcon((peer as User.user).pFlags.scam));\r\n  }\r\n\r\n  // if((peer as User.user).pFlags.premium) {\r\n  //   elements.push(generatePremiumIcon());\r\n  // }\r\n\r\n  return elements;\r\n}\r\n","export default function generateVerifiedIcon() {\r\n  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n  svg.setAttributeNS(null, 'viewBox', '0 0 24 24');\r\n  svg.setAttributeNS(null, 'width', '24');\r\n  svg.setAttributeNS(null, 'height', '24');\r\n  svg.classList.add('verified-icon');\r\n\r\n  const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use.setAttributeNS(null, 'href', '#verified-background');\r\n  use.classList.add('verified-background');\r\n\r\n  const use2 = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use2.setAttributeNS(null, 'href', '#verified-check');\r\n  use2.classList.add('verified-check');\r\n\r\n  svg.append(use, use2);\r\n\r\n  return svg;\r\n}\r\n","// https://github.com/eelcohn/Telegram-API/wiki/Calculating-color-for-a-Telegram-user-on-IRC\r\n/*\r\n  HTML-color  IRC-color  Description\r\n  #c03d33     4          red\r\n  #4fad2d     3          green\r\n  #d09306     7          yellow\r\n  #168acd     10         blue\r\n  #8544d6     6          purple\r\n  #cd4073     13         pink\r\n  #2996ad     11         sea\r\n  #ce671b     5          orange\r\n*/\r\nconst DialogColorsFg = ['#fc5c51', '#0fb297', '#d09306', '#3d72ed', '#895dd5', '#cd4073', '#00c1a6', '#fa790f'];\r\nconst DialogColors = ['red', 'green', 'yellow', 'blue', 'violet', 'pink', 'cyan', 'orange'];\r\nconst DialogColorsMap = [0, 7, 4, 1, 6, 3, 5];\r\n\r\nexport default function getPeerColorById(peerId: PeerId, pic = true) {\r\n  if(!peerId) return '';\r\n\r\n  const idx = DialogColorsMap[Math.abs(+peerId) % 7];\r\n  const color = (pic ? DialogColors : DialogColorsFg)[idx];\r\n  return color;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport wrapEmojiText from \"./wrapEmojiText\";\r\n\r\nexport default function getAbbreviation(str: string, onlyFirst = false) {\r\n  if(!str) return '';\r\n  const splitted = str.trim().split(' ');\r\n  if(!splitted[0]) return '';\r\n\r\n  const first = [...splitted[0]][0];\r\n\r\n  if(onlyFirst || splitted.length === 1) return wrapEmojiText(first);\r\n\r\n  const last = [...splitted[splitted.length - 1]][0];\r\n\r\n  return wrapEmojiText(first + last);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getPreviewURLFromBytes from \"../helpers/bytes/getPreviewURLFromBytes\";\r\nimport { renderImageFromUrlPromise } from \"../helpers/dom/renderImageFromUrl\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { recordPromise } from \"../helpers/recordPromise\";\r\nimport sequentialDom from \"../helpers/sequentialDom\";\r\nimport { UserProfilePhoto, ChatPhoto } from \"../layer\";\r\nimport type { PeerPhotoSize } from \"../lib/appManagers/appAvatarsManager\";\r\nimport getPeerColorById from \"../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport getAbbreviation from \"../lib/richTextProcessor/getAbbreviation\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport getPeerInitials from \"./wrappers/getPeerInitials\";\r\n\r\nexport async function putAvatar(\r\n  div: HTMLElement, \r\n  peerId: PeerId, \r\n  photo: UserProfilePhoto.userProfilePhoto | ChatPhoto.chatPhoto, \r\n  size: PeerPhotoSize, \r\n  img = new Image(), \r\n  onlyThumb = false\r\n) {\r\n  const r = await rootScope.managers.acknowledged.appAvatarsManager.loadAvatar(peerId, photo, size);\r\n  const loadPromise = r.result;\r\n  const cached = r.cached;\r\n\r\n  img.classList.add('avatar-photo');\r\n\r\n  let renderThumbPromise: Promise<void>;\r\n  let callback: () => void;\r\n  let thumbImage: HTMLImageElement;\r\n  if(cached) {\r\n    // смотри в misc.ts: renderImageFromUrl\r\n    callback = () => {\r\n      replaceContent(div, img);\r\n      div.dataset.color = '';\r\n    };\r\n  } else {\r\n    const animate = rootScope.settings.animationsEnabled;\r\n    if(animate) {\r\n      img.classList.add('fade-in');\r\n    }\r\n\r\n    let isFullLoaded = false;\r\n    if(size === 'photo_big') { // let's load small photo first\r\n      const res = await putAvatar(div, peerId, photo, 'photo_small');\r\n      renderThumbPromise = res.loadPromise;\r\n      thumbImage = res.thumbImage;\r\n    } else if(photo.stripped_thumb) {\r\n      thumbImage = new Image();\r\n      div.classList.add('avatar-relative');\r\n      thumbImage.classList.add('avatar-photo', 'avatar-photo-thumbnail');\r\n      const url = getPreviewURLFromBytes(photo.stripped_thumb);\r\n      renderThumbPromise = renderImageFromUrlPromise(thumbImage, url).then(() => {\r\n        if(isFullLoaded) {\r\n          return;\r\n        }\r\n\r\n        replaceContent(div, thumbImage);\r\n      });\r\n    }\r\n\r\n    callback = () => {\r\n      isFullLoaded = true;\r\n\r\n      if(thumbImage) {\r\n        div.append(img);\r\n      } else {\r\n        replaceContent(div, img);\r\n      }\r\n\r\n      setTimeout(() => {\r\n        if(div.childElementCount) {\r\n          sequentialDom.mutateElement(img, () => {\r\n            div.dataset.color = '';\r\n            \r\n            if(animate) {\r\n              img.classList.remove('fade-in');\r\n            }\r\n\r\n            if(thumbImage) {\r\n              thumbImage.remove();\r\n            }\r\n          });\r\n        }\r\n      }, animate ? 200 : 0);\r\n    };\r\n  }\r\n\r\n  const renderPromise = loadPromise\r\n  .then((url) => renderImageFromUrlPromise(img, url/* , !cached */))\r\n  .then(callback);\r\n\r\n  await (renderThumbPromise || renderPromise);\r\n\r\n  return {\r\n    cached, \r\n    loadPromise: renderThumbPromise || renderPromise,\r\n    thumbImage\r\n  };\r\n}\r\n\r\nfunction set(\r\n  div: HTMLElement, \r\n  innerHTML: Parameters<typeof setInnerHTML>[1], \r\n  color: string, \r\n  icon: string\r\n) {\r\n  setInnerHTML(div, innerHTML);\r\n  div.dataset.color = color;\r\n  div.classList.remove('tgico-saved', 'tgico-deletedaccount', 'tgico-reply_filled');\r\n  icon && div.classList.add(icon);\r\n}\r\n\r\n// peerId === peerId || title\r\nexport default async function putPhoto(\r\n  div: HTMLElement, \r\n  peerId: PeerId, \r\n  isDialog = false, \r\n  title = '', \r\n  onlyThumb = false, \r\n  isBig?: boolean\r\n) {\r\n  const myId = rootScope.myId;\r\n  \r\n  if(peerId === myId && isDialog) {\r\n    set(div, '', '', 'tgico-saved');\r\n    return;\r\n  }\r\n\r\n  const managers = rootScope.managers;\r\n  \r\n  if(peerId !== NULL_PEER_ID && peerId.isUser()) {\r\n    const user = await managers.appUsersManager.getUser(peerId);\r\n    if(user && user.pFlags && user.pFlags.deleted) {\r\n      set(div, '', getPeerColorById(peerId), 'tgico-deletedaccount');\r\n      return;\r\n    }\r\n  }\r\n  \r\n  const size: PeerPhotoSize = isBig ? 'photo_big' : 'photo_small';\r\n  const photo = await managers.appPeersManager.getPeerPhoto(peerId);\r\n  const avatarAvailable = !!photo;\r\n  const avatarRendered = !!div.firstElementChild && !(div.firstElementChild as HTMLElement).classList.contains('emoji');\r\n  if(!avatarAvailable || !avatarRendered || !(await managers.appAvatarsManager.isAvatarCached(peerId, size))) {\r\n    let color = '';\r\n    if(peerId && (peerId !== myId || !isDialog)) {\r\n      color = getPeerColorById(peerId);\r\n    }\r\n\r\n    if(peerId === REPLIES_PEER_ID) {\r\n      set(div, '', color, 'tgico-reply_filled');\r\n      return;\r\n    }\r\n\r\n    const abbr = await (title ? getAbbreviation(title) : getPeerInitials(peerId, managers));\r\n    set(div, abbr, color, '');\r\n    //return Promise.resolve(true);\r\n  }\r\n\r\n  if(avatarAvailable/*  && false */) {\r\n    const promise = putAvatar(div, peerId, photo, size, undefined, onlyThumb);\r\n    // recordPromise(promise, 'putAvatar-' + peerId);\r\n    return promise;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Chat, User } from \"../../layer\";\r\nimport getAbbreviation from \"../../lib/richTextProcessor/getAbbreviation\";\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport default async function getPeerInitials(peerId: PeerId, managers = rootScope.managers) {\r\n  const peer: Chat | User = await managers.appPeersManager.getPeer(peerId);\r\n  return getAbbreviation(\r\n    (peer as Chat.chat).title ?? [(peer as User.user).first_name, (peer as User.user).last_name].filter(Boolean).join(' ')\r\n  );\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appNavigationController from \"../components/appNavigationController\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport { IS_MOBILE_SAFARI } from \"../environment/userAgent\";\r\nimport cancelEvent from \"./dom/cancelEvent\";\r\nimport { CLICK_EVENT_NAME } from \"./dom/clickEvent\";\r\nimport EventListenerBase from \"./eventListenerBase\";\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nclass ContextMenuController extends EventListenerBase<{\r\n  toggle: (open: boolean) => void\r\n}> {\r\n  private openedMenu: HTMLElement;\r\n  private menuOverlay: HTMLElement;\r\n  private openedMenuOnClose: () => void;\r\n\r\n  constructor() {\r\n    super();\r\n    \r\n    mediaSizes.addEventListener('resize', () => {\r\n      if(this.openedMenu) {\r\n        this.closeBtnMenu();\r\n      }\r\n      \r\n      /* if(openedMenu && (openedMenu.style.top || openedMenu.style.left)) {\r\n        const rect = openedMenu.getBoundingClientRect();\r\n        const {innerWidth, innerHeight} = window;\r\n    \r\n        console.log(innerWidth, innerHeight, rect);\r\n      } */\r\n    })\r\n  }\r\n\r\n  public isOpened() {\r\n    return !!this.openedMenu;\r\n  }\r\n\r\n  private onMouseMove = (e: MouseEvent) => {\r\n    let rect = this.openedMenu.getBoundingClientRect();\r\n    let {clientX, clientY} = e;\r\n\r\n    let diffX = clientX >= rect.right ? clientX - rect.right : rect.left - clientX;\r\n    let diffY = clientY >= rect.bottom ? clientY - rect.bottom : rect.top - clientY;\r\n\r\n    if(diffX >= 100 || diffY >= 100) {\r\n      this.closeBtnMenu();\r\n      //openedMenu.parentElement.click();\r\n    }\r\n    //console.log('mousemove', diffX, diffY);\r\n  };\r\n\r\n  private onClick = (e: MouseEvent | TouchEvent) => {\r\n    //cancelEvent(e);\r\n    this.closeBtnMenu();\r\n  };\r\n\r\n  // ! no need in this due to the same handler in appNavigationController\r\n  /* const onKeyDown = (e: KeyboardEvent) => {\r\n    if(e.key === 'Escape') {\r\n      closeBtnMenu();\r\n      cancelEvent(e);\r\n    }\r\n  }; */\r\n\r\n  public closeBtnMenu = () => {\r\n    if(this.openedMenu) {\r\n      this.openedMenu.classList.remove('active');\r\n      this.openedMenu.parentElement.classList.remove('menu-open');\r\n      //openedMenu.previousElementSibling.remove(); // remove overlay\r\n      if(this.menuOverlay) this.menuOverlay.remove();\r\n      this.openedMenu = undefined;\r\n  \r\n      this.dispatchEvent('toggle', false);\r\n    }\r\n    \r\n    if(this.openedMenuOnClose) {\r\n      this.openedMenuOnClose();\r\n      this.openedMenuOnClose = undefined;\r\n    }\r\n  \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      window.removeEventListener('mousemove', this.onMouseMove);\r\n      //window.removeEventListener('keydown', onKeyDown, {capture: true});\r\n      window.removeEventListener('contextmenu', this.onClick);\r\n    }\r\n  \r\n    document.removeEventListener(CLICK_EVENT_NAME, this.onClick);\r\n  \r\n    if(!IS_MOBILE_SAFARI) {\r\n      appNavigationController.removeByType('menu');\r\n    }\r\n  };\r\n\r\n  public openBtnMenu(menuElement: HTMLElement, onClose?: () => void) {\r\n    this.closeBtnMenu();\r\n  \r\n    if(!IS_MOBILE_SAFARI) {\r\n      appNavigationController.pushItem({\r\n        type: 'menu',\r\n        onPop: (canAnimate) => {\r\n          this.closeBtnMenu();\r\n        }\r\n      });\r\n    }\r\n    \r\n    this.openedMenu = menuElement;\r\n    this.openedMenu.classList.add('active');\r\n    this.openedMenu.parentElement.classList.add('menu-open');\r\n  \r\n    if(!this.menuOverlay) {\r\n      this.menuOverlay = document.createElement('div');\r\n      this.menuOverlay.classList.add('btn-menu-overlay');\r\n  \r\n      // ! because this event must be canceled, and can't cancel on menu click (below)\r\n      this.menuOverlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n        cancelEvent(e);\r\n        this.onClick(e);\r\n      });\r\n    }\r\n  \r\n    this.openedMenu.parentElement.insertBefore(this.menuOverlay, this.openedMenu);\r\n  \r\n    //document.body.classList.add('disable-hover');\r\n    \r\n    this.openedMenuOnClose = onClose;\r\n  \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      window.addEventListener('mousemove', this.onMouseMove);\r\n      //window.addEventListener('keydown', onKeyDown, {capture: true});\r\n      window.addEventListener('contextmenu', this.onClick, {once: true});\r\n    }\r\n  \r\n    /* // ! because this event must be canceled, and can't cancel on menu click (below)\r\n    overlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n      cancelEvent(e);\r\n      onClick(e);\r\n    }); */\r\n    \r\n    // ! safari iOS doesn't handle window click event on overlay, idk why\r\n    document.addEventListener(CLICK_EVENT_NAME, this.onClick);\r\n  \r\n    this.dispatchEvent('toggle', true);\r\n  }\r\n}\r\n\r\nconst contextMenuController = new ContextMenuController();\r\nexport default contextMenuController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\n\r\nconst getEvent = (e: TouchEvent | MouseEvent) => {\r\n  return (e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent;\r\n};\r\n\r\nconst attachGlobalListenerTo = window;\r\n\r\nlet RESET_GLOBAL = false;\r\ncontextMenuController.addEventListener('toggle', (visible) => {\r\n  RESET_GLOBAL = visible;\r\n});\r\n\r\nexport type SwipeHandlerOptions = {\r\n  element: SwipeHandler['element'],\r\n  onSwipe: SwipeHandler['onSwipe'],\r\n  verifyTouchTarget?: SwipeHandler['verifyTouchTarget'],\r\n  onFirstSwipe?: SwipeHandler['onFirstSwipe'],\r\n  onReset?: SwipeHandler['onReset'],\r\n  cursor?: SwipeHandler['cursor'],\r\n  cancelEvent?: SwipeHandler['cancelEvent'],\r\n  listenerOptions?: SwipeHandler['listenerOptions']\r\n};\r\n\r\nexport default class SwipeHandler {\r\n  private element: HTMLElement;\r\n  private onSwipe: (xDiff: number, yDiff: number, e: TouchEvent | MouseEvent) => boolean | void;\r\n  private verifyTouchTarget: (evt: TouchEvent | MouseEvent) => boolean | Promise<boolean>;\r\n  private onFirstSwipe: () => void;\r\n  private onReset: () => void;\r\n  private cursor: 'grabbing' | 'move' | 'row-resize' | 'col-resize' | 'nesw-resize' | 'nwse-resize' | 'ne-resize' | 'se-resize' | 'sw-resize' | 'nw-resize' | 'n-resize' | 'e-resize' | 's-resize' | 'w-resize' | '' = 'grabbing';\r\n  private cancelEvent = true;\r\n  private listenerOptions: boolean | AddEventListenerOptions = false;\r\n  private setCursorTo: HTMLElement;\r\n\r\n  private hadMove = false;\r\n  private xDown: number = null;\r\n  private yDown: number = null;\r\n\r\n  constructor(options: SwipeHandlerOptions) {\r\n    safeAssign(this, options);\r\n    \r\n    this.setCursorTo = this.element;\r\n\r\n    this.setListeners();\r\n  }\r\n\r\n  public setListeners() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.addEventListener('mousedown', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.addEventListener('mouseup', this.reset);\r\n    } else {\r\n      this.element.addEventListener('touchstart', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.addEventListener('touchend', this.reset);\r\n    }\r\n  }\r\n\r\n  public removeListeners() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.removeEventListener('mousedown', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.removeEventListener('mouseup', this.reset);\r\n    } else {\r\n      this.element.removeEventListener('touchstart', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.removeEventListener('touchend', this.reset);\r\n    }\r\n  }\r\n\r\n  public setCursor(cursor: SwipeHandler['cursor']) {\r\n    this.cursor = cursor;\r\n    \r\n    if(!IS_TOUCH_SUPPORTED && this.hadMove) {\r\n      this.setCursorTo.style.setProperty('cursor', this.cursor, 'important');\r\n    }\r\n  }\r\n\r\n  reset = (e?: Event) => {\r\n    /* if(e) {\r\n      cancelEvent(e);\r\n    } */\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachGlobalListenerTo.removeEventListener('touchmove', this.handleMove, {capture: true});\r\n    } else {\r\n      attachGlobalListenerTo.removeEventListener('mousemove', this.handleMove);\r\n      this.setCursorTo.style.cursor = '';\r\n    }\r\n\r\n    if(this.onReset && this.hadMove) {\r\n      this.onReset();\r\n    }\r\n\r\n    this.xDown = this.yDown = null;\r\n    this.hadMove = false;\r\n  };\r\n\r\n  handleStart = async(_e: TouchEvent | MouseEvent) => {\r\n    const e = getEvent(_e);\r\n    if(this.verifyTouchTarget && !(await this.verifyTouchTarget(_e))) {\r\n      return this.reset();\r\n    }\r\n\r\n    this.xDown = e.clientX;\r\n    this.yDown = e.clientY;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachGlobalListenerTo.addEventListener('touchmove', this.handleMove, {passive: false, capture: true});\r\n    } else {\r\n      attachGlobalListenerTo.addEventListener('mousemove', this.handleMove, false);\r\n    }\r\n  };\r\n\r\n  handleMove = (_e: TouchEvent | MouseEvent) => {\r\n    if(this.xDown === null || this.yDown === null || RESET_GLOBAL) {\r\n      this.reset();\r\n      return;\r\n    }\r\n\r\n    if(this.cancelEvent) {\r\n      cancelEvent(_e);\r\n    }\r\n\r\n    const e = getEvent(_e);\r\n    const xUp = e.clientX;\r\n    const yUp = e.clientY;\r\n\r\n    const xDiff = this.xDown - xUp;\r\n    const yDiff = this.yDown - yUp;\r\n\r\n    if(!this.hadMove) {\r\n      if(!xDiff && !yDiff) {\r\n        return;\r\n      }\r\n\r\n      this.hadMove = true;\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        this.setCursorTo.style.setProperty('cursor', this.cursor, 'important');\r\n      }\r\n\r\n      if(this.onFirstSwipe) {\r\n        this.onFirstSwipe();\r\n      }\r\n    }\r\n\r\n    // if(Math.abs(xDiff) > Math.abs(yDiff)) { /*most significant*/\r\n    //   if(xDiff > 0) { /* left swipe */ \r\n\r\n    //   } else { /* right swipe */\r\n\r\n    //   }                       \r\n    // } else {\r\n    //   if(yDiff > 0) { /* up swipe */ \r\n        \r\n    //   } else { /* down swipe */\r\n        \r\n    //   }\r\n    // }\r\n\r\n    /* reset values */\r\n    const onSwipeResult = this.onSwipe(xDiff, yDiff, _e);\r\n    if(onSwipeResult !== undefined && onSwipeResult) {\r\n      this.reset();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_PARALLAX_SUPPORTED from \"../environment/parallaxSupport\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport filterChatPhotosMessages from \"../helpers/filterChatPhotosMessages\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ListLoader from \"../helpers/listLoader\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { Message, ChatFull, MessageAction, Photo } from \"../layer\";\r\nimport type { AppMessagesManager } from \"../lib/appManagers/appMessagesManager\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { openAvatarViewer } from \"./avatar\";\r\nimport { putAvatar } from \"./putPhoto\";\r\nimport Scrollable from \"./scrollable\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\nimport { wrapPhoto } from \"./wrappers\";\r\n\r\nconst LOAD_NEAREST = 3;\r\n\r\nexport default class PeerProfileAvatars {\r\n  private static BASE_CLASS = 'profile-avatars';\r\n  private static SCALE = IS_PARALLAX_SUPPORTED ? 2 : 1;\r\n  private static TRANSLATE_TEMPLATE = IS_PARALLAX_SUPPORTED ? `translate3d({x}, 0, -1px) scale(${PeerProfileAvatars.SCALE})` : 'translate({x}, 0)';\r\n  public container: HTMLElement;\r\n  public avatars: HTMLElement;\r\n  public gradient: HTMLElement;\r\n  public info: HTMLElement;\r\n  public arrowPrevious: HTMLElement;\r\n  public arrowNext: HTMLElement;\r\n  private tabs: HTMLDivElement;\r\n  private listLoader: ListLoader<Photo.photo['id'] | Message.messageService, Photo.photo['id'] | Message.messageService>;\r\n  private peerId: PeerId;\r\n  private intersectionObserver: IntersectionObserver;\r\n  private loadCallbacks: Map<Element, () => void>;\r\n  private listenerSetter: ListenerSetter;\r\n  private swipeHandler: SwipeHandler;\r\n\r\n  constructor(\r\n    public scrollable: Scrollable,\r\n    private managers: AppManagers\r\n  ) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(PeerProfileAvatars.BASE_CLASS + '-container');\r\n\r\n    this.avatars = document.createElement('div');\r\n    this.avatars.classList.add(PeerProfileAvatars.BASE_CLASS + '-avatars');\r\n\r\n    this.gradient = document.createElement('div');\r\n    this.gradient.classList.add(PeerProfileAvatars.BASE_CLASS + '-gradient');\r\n\r\n    this.info = document.createElement('div');\r\n    this.info.classList.add(PeerProfileAvatars.BASE_CLASS + '-info');\r\n\r\n    this.tabs = document.createElement('div');\r\n    this.tabs.classList.add(PeerProfileAvatars.BASE_CLASS + '-tabs');\r\n\r\n    this.arrowPrevious = document.createElement('div');\r\n    this.arrowPrevious.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow', 'tgico-avatarprevious');\r\n\r\n    /* const previousIcon = document.createElement('i');\r\n    previousIcon.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow-icon', 'tgico-previous');\r\n    this.arrowBack.append(previousIcon); */\r\n    \r\n    this.arrowNext = document.createElement('div');\r\n    this.arrowNext.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow', PeerProfileAvatars.BASE_CLASS + '-arrow-next', 'tgico-avatarnext');\r\n\r\n    /* const nextIcon = document.createElement('i');\r\n    nextIcon.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow-icon', 'tgico-next');\r\n    this.arrowNext.append(nextIcon); */\r\n\r\n    this.container.append(this.avatars, this.gradient, this.info, this.tabs, this.arrowPrevious, this.arrowNext);\r\n\r\n    this.loadCallbacks = new Map();\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    const checkScrollTop = () => {\r\n      if(this.scrollable.scrollTop !== 0) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.scrollable.container.firstElementChild as HTMLElement, \r\n          position: 'start'\r\n        });\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    const SWITCH_ZONE = 1 / 3;\r\n    let cancel = false;\r\n    let freeze = false;\r\n    attachClickEvent(this.container, async(_e) => {\r\n      if(freeze) {\r\n        cancelEvent(_e);\r\n        return;\r\n      }\r\n\r\n      if(cancel) {\r\n        cancel = false;\r\n        return;\r\n      }\r\n\r\n      if(!checkScrollTop()) {\r\n        return;\r\n      }\r\n\r\n      const rect = this.container.getBoundingClientRect();\r\n\r\n      // const e = (_e as TouchEvent).touches ? (_e as TouchEvent).touches[0] : _e as MouseEvent;\r\n      const e = _e;\r\n      const x = e.pageX;\r\n\r\n      const clickX = x - rect.left;\r\n      if((!this.listLoader.previous.length && !this.listLoader.next.length) \r\n        || (clickX > (rect.width * SWITCH_ZONE) && clickX < (rect.width - rect.width * SWITCH_ZONE))) {\r\n        const peerId = this.peerId;\r\n\r\n        const targets: {element: HTMLElement, item: Photo.photo['id'] | Message.messageService}[] = [];\r\n        this.listLoader.previous.concat(this.listLoader.current, this.listLoader.next).forEach((item, idx) => {\r\n          targets.push({\r\n            element: /* null */this.avatars.children[idx] as HTMLElement,\r\n            item\r\n          });\r\n        });\r\n\r\n        const prevTargets = targets.slice(0, this.listLoader.previous.length);\r\n        const nextTargets = targets.slice(this.listLoader.previous.length + 1);\r\n\r\n        const target = this.avatars.children[this.listLoader.previous.length] as HTMLElement;\r\n        freeze = true;\r\n        openAvatarViewer(target, peerId, () => peerId === this.peerId, this.listLoader.current, prevTargets, nextTargets);\r\n        freeze = false;\r\n      } else {\r\n        const centerX = rect.right - (rect.width / 2);\r\n        const toRight = x > centerX;\r\n  \r\n        // this.avatars.classList.remove('no-transition');\r\n        // fastRaf(() => {\r\n          this.avatars.classList.add('no-transition');\r\n          void this.avatars.offsetLeft; // reflow\r\n\r\n          let distance: number;\r\n          if(this.listLoader.index === 0 && !toRight) distance = this.listLoader.count - 1;\r\n          else if(this.listLoader.index === (this.listLoader.count - 1) && toRight) distance = -(this.listLoader.count - 1);\r\n          else distance = toRight ? 1 : -1;\r\n          this.listLoader.go(distance);\r\n\r\n          fastRaf(() => {\r\n            this.avatars.classList.remove('no-transition');\r\n          });\r\n        // });\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const cancelNextClick = () => {\r\n      cancel = true;\r\n      document.body.addEventListener(IS_TOUCH_SUPPORTED ? 'touchend' : 'click', (e) => {\r\n        cancel = false;\r\n      }, {once: true});\r\n    };\r\n\r\n    let width = 0, x = 0, lastDiffX = 0, lastIndex = 0, minX = 0;\r\n    const swipeHandler = this.swipeHandler = new SwipeHandler({\r\n      element: this.avatars, \r\n      onSwipe: (xDiff, yDiff) => {\r\n        lastDiffX = xDiff;\r\n        let lastX = x + xDiff * -PeerProfileAvatars.SCALE;\r\n        if(lastX > 0) lastX = 0;\r\n        else if(lastX < minX) lastX = minX;\r\n\r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', lastX + 'px');\r\n        //console.log(xDiff, yDiff);\r\n        return false;\r\n      }, \r\n      verifyTouchTarget: (e) => {\r\n        if(!checkScrollTop()) {\r\n          cancelNextClick();\r\n          cancelEvent(e);\r\n          return false;\r\n        } else if(this.container.classList.contains('is-single') || freeze) {\r\n          return false;\r\n        }\r\n\r\n        return true;\r\n      }, \r\n      onFirstSwipe: () => {\r\n        const rect = this.avatars.getBoundingClientRect();\r\n        width = rect.width;\r\n        minX = -width * (this.tabs.childElementCount - 1);\r\n\r\n        /* lastIndex = whichChild(this.tabs.querySelector('.active'));\r\n        x = -width * lastIndex; */\r\n        x = rect.left - this.container.getBoundingClientRect().left;\r\n        \r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', x + 'px');\r\n\r\n        this.container.classList.add('is-swiping');\r\n        this.avatars.classList.add('no-transition');\r\n        void this.avatars.offsetLeft; // reflow\r\n      },\r\n      onReset: () => {\r\n        const addIndex = Math.ceil(Math.abs(lastDiffX) / (width / PeerProfileAvatars.SCALE)) * (lastDiffX >= 0 ? 1 : -1);\r\n        cancelNextClick();\r\n        \r\n        //console.log(addIndex);\r\n\r\n        this.avatars.classList.remove('no-transition');\r\n        fastRaf(() => {\r\n          this.listLoader.go(addIndex);\r\n          this.container.classList.remove('is-swiping');\r\n        });\r\n      }\r\n    });\r\n\r\n    this.intersectionObserver = new IntersectionObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        if(!entry.isIntersecting) {\r\n          return;\r\n        }\r\n\r\n        this.loadNearestToTarget(entry.target);\r\n      });\r\n    });\r\n\r\n    /* this.listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        const photo = appPeersManager.getPeerPhoto(peerId);\r\n        if(photo) {\r\n          const id = photo.photo_id;\r\n          const previous = this.listLoader.previous;\r\n          for(let i = 0; i < previous.length; ++i) {\r\n            if(previous[i] === id)\r\n          }\r\n          this.listLoader.previous.forEach((_id, idx, arr) => {});\r\n        }\r\n      }\r\n    }); */\r\n  }\r\n\r\n  public async setPeer(peerId: PeerId) {\r\n    this.peerId = peerId;\r\n\r\n    const photo = await this.managers.appPeersManager.getPeerPhoto(peerId);\r\n    if(!photo) {\r\n      return;\r\n    }\r\n\r\n    const listLoader: PeerProfileAvatars['listLoader'] = this.listLoader = new ListLoader({\r\n      loadCount: 50,\r\n      loadMore: (anchor, older, loadCount) => {\r\n        if(!older) return Promise.resolve({count: undefined, items: []});\r\n\r\n        if(peerId.isUser()) {\r\n          const maxId: Photo.photo['id'] = anchor as any;\r\n          return this.managers.appPhotosManager.getUserPhotos(peerId, maxId, loadCount).then((value) => {\r\n            return {\r\n              count: value.count,\r\n              items: value.photos\r\n            };\r\n          });\r\n        } else {\r\n          const promises: [Promise<ChatFull> | ChatFull, ReturnType<AppMessagesManager['getSearch']>] = [] as any;\r\n          if(!listLoader.current) {\r\n            promises.push(this.managers.appProfileManager.getChatFull(peerId.toChatId()));\r\n          }\r\n          \r\n          promises.push(this.managers.appMessagesManager.getSearch({\r\n            peerId,\r\n            maxId: Number.MAX_SAFE_INTEGER,\r\n            inputFilter: {\r\n              _: 'inputMessagesFilterChatPhotos'\r\n            },\r\n            limit: loadCount,\r\n            backLimit: 0\r\n          }));\r\n\r\n          return Promise.all(promises).then(async(result) => {\r\n            const value = result.pop() as typeof result[1];\r\n\r\n            filterChatPhotosMessages(value);\r\n\r\n            if(!listLoader.current) {\r\n              const chatFull = result[0];\r\n              const message = findAndSplice(value.history, (message) => {\r\n                return ((message as Message.messageService).action as MessageAction.messageActionChannelEditPhoto).photo.id === chatFull.chat_photo.id;\r\n              }) as Message.messageService;\r\n              \r\n              listLoader.current = message || await this.managers.appMessagesManager.generateFakeAvatarMessage(this.peerId, chatFull.chat_photo);\r\n            }\r\n\r\n            //console.log('avatars loaded:', value);\r\n            return {\r\n              count: value.count,\r\n              items: value.history\r\n            };\r\n          });\r\n        }\r\n      },\r\n      processItem: this.processItem,\r\n      onJump: (item, older) => {\r\n        const id = this.listLoader.index;\r\n        //const nextId = Math.max(0, id);\r\n        const x = 100 * PeerProfileAvatars.SCALE * id;\r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', `-${x}%`);\r\n\r\n        const activeTab = this.tabs.querySelector('.active');\r\n        if(activeTab) activeTab.classList.remove('active');\r\n\r\n        const tab = this.tabs.children[id] as HTMLElement;\r\n        tab.classList.add('active');\r\n\r\n        this.loadNearestToTarget(this.avatars.children[id]);\r\n      }\r\n    });\r\n\r\n    if(photo._ === 'userProfilePhoto') {\r\n      listLoader.current = photo.photo_id;\r\n    }\r\n\r\n    await this.processItem(listLoader.current);\r\n\r\n    // listLoader.loaded\r\n    listLoader.load(true);\r\n  }\r\n\r\n  public addTab() {\r\n    const tab = document.createElement('div');\r\n    tab.classList.add(PeerProfileAvatars.BASE_CLASS + '-tab');\r\n    this.tabs.append(tab);\r\n\r\n    if(this.tabs.childElementCount === 1) {\r\n      tab.classList.add('active');\r\n    }\r\n\r\n    this.container.classList.toggle('is-single', this.tabs.childElementCount <= 1);\r\n  }\r\n\r\n  public processItem = async(photoId: Photo.photo['id'] | Message.messageService) => {\r\n    const avatar = document.createElement('div');\r\n    avatar.classList.add(PeerProfileAvatars.BASE_CLASS + '-avatar', 'media-container', 'hide');\r\n\r\n    this.avatars.append(avatar);\r\n\r\n    let photo: Photo.photo;\r\n    if(photoId) {\r\n      photo = typeof(photoId) !== 'object' ? \r\n        await this.managers.appPhotosManager.getPhoto(photoId) : \r\n        (photoId.action as MessageAction.messageActionChannelEditPhoto).photo as Photo.photo;\r\n    }\r\n\r\n    const img = new Image();\r\n    img.classList.add('avatar-photo');\r\n    img.draggable = false;\r\n\r\n    const loadCallback = async() => {\r\n      if(photo) {\r\n        const res = await wrapPhoto({\r\n          container: avatar,\r\n          photo,\r\n          size: choosePhotoSize(photo, 420, 420, false),\r\n          withoutPreloader: true\r\n        });\r\n  \r\n        [res.images.thumb, res.images.full].filter(Boolean).forEach((img) => {\r\n          img.classList.add('avatar-photo');\r\n        });\r\n      } else {\r\n        const photo = await this.managers.appPeersManager.getPeerPhoto(this.peerId);\r\n        await putAvatar(avatar, this.peerId, photo, 'photo_big', img);\r\n      }\r\n\r\n      avatar.classList.remove('hide');\r\n    };\r\n\r\n    if(this.avatars.childElementCount <= LOAD_NEAREST) {\r\n      await loadCallback();\r\n    } else {\r\n      this.intersectionObserver.observe(avatar);\r\n      this.loadCallbacks.set(avatar, loadCallback);\r\n    }\r\n\r\n    this.addTab();\r\n\r\n    return photoId;\r\n  };\r\n\r\n  private loadNearestToTarget(target: Element) {\r\n    const children = Array.from(target.parentElement.children);\r\n    const idx = children.indexOf(target);\r\n    const slice = children.slice(Math.max(0, idx - LOAD_NEAREST), Math.min(children.length, idx + LOAD_NEAREST));\r\n\r\n    slice.forEach((target) => {\r\n      const callback = this.loadCallbacks.get(target);\r\n      if(callback) {\r\n        callback();\r\n        this.loadCallbacks.delete(target);\r\n        this.intersectionObserver.unobserve(target);\r\n      }\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.listenerSetter.removeAll();\r\n    this.swipeHandler.removeListeners();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PeerTitle, { PeerTitleOptions } from \"../peerTitle\";\r\n\r\nexport default async function wrapPeerTitle(options: PeerTitleOptions) {\r\n  const peerTitle = new PeerTitle();\r\n  await peerTitle.update(options);\r\n  return peerTitle.element;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_PARALLAX_SUPPORTED from \"../environment/parallaxSupport\";\r\nimport { copyTextToClipboard } from \"../helpers/clipboard\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { Chat, ChatFull, User, UserFull } from \"../layer\";\r\nimport type { Channel } from \"../lib/appManagers/appChatsManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport I18n from \"../lib/langPack\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport AvatarElement from \"./avatar\";\r\nimport CheckboxField from \"./checkboxField\";\r\nimport generateTitleIcons from \"./generateTitleIcons\";\r\nimport PeerProfileAvatars from \"./peerProfileAvatars\";\r\nimport Row from \"./row\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { SettingSection, generateDelimiter } from \"./sidebarLeft\";\r\nimport { toast } from \"./toast\";\r\nimport formatUserPhone from \"./wrappers/formatUserPhone\";\r\nimport wrapPeerTitle from \"./wrappers/peerTitle\";\r\n\r\nlet setText = (text: Parameters<typeof setInnerHTML>[1], row: Row) => {\r\n  //fastRaf(() => {\r\n    setInnerHTML(row.title, text || '');\r\n    row.container.style.display = text ? '' : 'none';\r\n  //});\r\n};\r\n\r\nexport default class PeerProfile {\r\n  public element: HTMLElement;\r\n  private avatars: PeerProfileAvatars;\r\n  private avatar: AvatarElement;\r\n  private section: SettingSection;\r\n  private name: HTMLDivElement;\r\n  private subtitle: HTMLDivElement;\r\n  private bio: Row;\r\n  private username: Row;\r\n  private phone: Row;\r\n  private notifications: Row;\r\n  private location: Row;\r\n  private link: Row;\r\n  \r\n  private cleaned: boolean;\r\n  private setMoreDetailsTimeout: number;\r\n  private setPeerStatusInterval: number;\r\n\r\n  private peerId: PeerId;\r\n  private threadId: number;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    public scrollable: Scrollable, \r\n    private listenerSetter?: ListenerSetter,\r\n    private isDialog = true\r\n  ) {\r\n    if(!IS_PARALLAX_SUPPORTED) {\r\n      this.scrollable.container.classList.add('no-parallax');\r\n    }\r\n\r\n    if(!listenerSetter) {\r\n      this.listenerSetter = new ListenerSetter();\r\n    }\r\n  }\r\n\r\n  public init() {\r\n    this.init = null;\r\n\r\n\r\n    this.element = document.createElement('div');\r\n    this.element.classList.add('profile-content');\r\n\r\n    this.section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    this.avatar = new AvatarElement();\r\n    this.avatar.classList.add('profile-avatar', 'avatar-120');\r\n    this.avatar.isDialog = this.isDialog;\r\n    this.avatar.attachClickEvent();\r\n\r\n    this.name = document.createElement('div');\r\n    this.name.classList.add('profile-name');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('profile-subtitle');\r\n\r\n    this.bio = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'UserBio',\r\n      icon: 'info',\r\n      clickable: async(e) => {\r\n        if((e.target as HTMLElement).tagName === 'A') {\r\n          return;\r\n        }\r\n        \r\n        const full = await this.managers.appProfileManager.getProfileByPeerId(this.peerId);\r\n        copyTextToClipboard(full.about);\r\n        toast(I18n.format('BioCopied', true));\r\n      }\r\n    });\r\n\r\n    this.bio.title.classList.add('pre-wrap');\r\n\r\n    this.username = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'Username',\r\n      icon: 'username',\r\n      clickable: async() => {\r\n        const peer: Channel | User.user = await this.managers.appPeersManager.getPeer(this.peerId);\r\n        copyTextToClipboard('@' + peer.username);\r\n        toast(I18n.format('UsernameCopied', true));\r\n      }\r\n    });\r\n\r\n    this.phone = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'Phone',\r\n      icon: 'phone',\r\n      clickable: async() => {\r\n        const peer: User = await this.managers.appUsersManager.getUser(this.peerId);\r\n        copyTextToClipboard('+' + peer.phone);\r\n        toast(I18n.format('PhoneCopied', true));\r\n      }\r\n    });\r\n\r\n    this.link = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'SetUrlPlaceholder',\r\n      icon: 'link',\r\n      clickable: () => {\r\n        copyTextToClipboard(this.link.title.textContent);\r\n        // Promise.resolve(appProfileManager.getChatFull(this.peerId.toChatId())).then((chatFull) => {\r\n          // copyTextToClipboard(chatFull.exported_invite.link);\r\n          toast(I18n.format('LinkCopied', true));\r\n        // });\r\n      }\r\n    });\r\n\r\n    this.location = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'ChatLocation',\r\n      icon: 'location'\r\n    });\r\n\r\n    this.section.content.append(\r\n      this.phone.container,\r\n      this.username.container,\r\n      this.location.container,\r\n      this.bio.container,\r\n      this.link.container\r\n    );\r\n\r\n    const {listenerSetter} = this;\r\n    if(this.isDialog) {\r\n      this.notifications = new Row({\r\n        checkboxField: new CheckboxField({toggle: true}),\r\n        titleLangKey: 'Notifications',\r\n        icon: 'unmute'\r\n      });\r\n\r\n      listenerSetter.add(this.notifications.checkboxField.input)('change', (e) => {\r\n        if(!e.isTrusted) {\r\n          return;\r\n        }\r\n  \r\n        //let checked = this.notificationsCheckbox.checked;\r\n        this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n      });\r\n\r\n      listenerSetter.add(rootScope)('dialog_notify_settings', async(dialog) => {\r\n        if(this.peerId === dialog.peerId) {\r\n          const muted = await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false);\r\n          this.notifications.checkboxField.checked = !muted;\r\n        }\r\n      });\r\n\r\n      this.section.content.append(this.notifications.container);\r\n    }\r\n\r\n    this.element.append(this.section.container);\r\n\r\n    if(IS_PARALLAX_SUPPORTED) {\r\n      this.element.append(generateDelimiter());\r\n    }\r\n\r\n    listenerSetter.add(rootScope)('peer_typings', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('peer_bio_edit', (peerId) => {\r\n      if(peerId === this.peerId) {\r\n        this.setMoreDetails(true);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('peer_title_edit', (peerId) => {\r\n      if(peerId === this.peerId) {\r\n        this.fillUsername();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('user_update', (userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('contacts_update', async(userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        const user = await this.managers.appUsersManager.getUser(userId);\r\n        if(!user.pFlags.self || !this.isDialog) {\r\n          this.fillUserPhone();\r\n        }\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        // const photo = appPeersManager.getPeerPhoto(peerId);\r\n        // if(!photo && this.avatars) {\r\n          this.setAvatar();\r\n        // }\r\n      }\r\n    });\r\n\r\n    this.setPeerStatusInterval = window.setInterval(this.setPeerStatus, 60e3);\r\n  }\r\n\r\n  private setPeerStatus = (needClear = false) => {\r\n    const peerId = this.peerId;\r\n    this.element.classList.toggle('is-me', peerId === rootScope.myId);\r\n    if(!peerId || (rootScope.myId === peerId && this.isDialog)) return;\r\n\r\n    return appImManager.setPeerStatus(\r\n      peerId, \r\n      this.subtitle, \r\n      needClear, \r\n      true, \r\n      () => peerId === this.peerId, \r\n      !this.isDialog\r\n    ).then((callback) => {\r\n      if(callback) {\r\n        callback();\r\n      }\r\n    });\r\n  };\r\n\r\n  public cleanupHTML() {\r\n    [\r\n      this.bio,\r\n      this.phone,\r\n      this.username,\r\n      this.location,\r\n      this.link\r\n    ].forEach((row) => {\r\n      row.container.style.display = 'none';\r\n    });\r\n\r\n    if(this.notifications) {\r\n      this.notifications.container.style.display = '';\r\n      this.notifications.checkboxField.checked = true;\r\n    }\r\n\r\n    this.clearSetMoreDetailsTimeout();\r\n  }\r\n\r\n  private canBeDetailed() {\r\n    return this.peerId !== rootScope.myId || !this.isDialog;\r\n  }\r\n\r\n  private async setAvatar() {\r\n    if(this.canBeDetailed()) {\r\n      const photo = await this.managers.appPeersManager.getPeerPhoto(this.peerId);\r\n\r\n      if(photo) {\r\n        const oldAvatars = this.avatars;\r\n        this.avatars = new PeerProfileAvatars(this.scrollable, this.managers);\r\n        await this.avatars.setPeer(this.peerId);\r\n        this.avatars.info.append(this.name, this.subtitle);\r\n  \r\n        this.avatar.remove();\r\n    \r\n        if(oldAvatars) oldAvatars.container.replaceWith(this.avatars.container);\r\n        else this.element.prepend(this.avatars.container);\r\n\r\n        if(IS_PARALLAX_SUPPORTED) {\r\n          this.scrollable.container.classList.add('parallax');\r\n        }\r\n\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(IS_PARALLAX_SUPPORTED) {\r\n      this.scrollable.container.classList.remove('parallax');\r\n    }\r\n\r\n    if(this.avatars) {\r\n      this.avatars.container.remove();\r\n      this.avatars.cleanup();\r\n      this.avatars = undefined;\r\n    }\r\n\r\n    await this.avatar.updateWithOptions({peerId: this.peerId});\r\n\r\n    this.section.content.prepend(this.avatar, this.name, this.subtitle);\r\n  }\r\n\r\n  private async fillUsername() {\r\n    const {peerId} = this;\r\n    if(peerId.isUser() && this.canBeDetailed()) {\r\n      const username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n      return setText(username, this.username);\r\n    }\r\n  }\r\n\r\n  private async fillUserPhone() {\r\n    const {peerId} = this;\r\n    if(peerId.isUser() && this.canBeDetailed()) {\r\n      const user = await this.managers.appUsersManager.getUser(peerId);\r\n      return setText(user.phone ? formatUserPhone(user.phone) : undefined, this.phone);\r\n    }\r\n  }\r\n\r\n  private async fillNotifications() {\r\n    const notificationsRow = this.notifications;\r\n    if(!notificationsRow) {\r\n      return;\r\n    }\r\n\r\n    if(this.canBeDetailed()) {\r\n      const muted = await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false);\r\n      notificationsRow.checkboxField.checked = !muted;\r\n    } else {\r\n      fastRaf(() => {\r\n        notificationsRow.container.style.display = 'none';\r\n      });\r\n    }\r\n  }\r\n\r\n  private async fillRows() {\r\n    const peerId = this.peerId;\r\n\r\n    await Promise.all([\r\n      this.fillUsername(),\r\n      this.fillUserPhone(),\r\n      this.fillNotifications(),\r\n      this.setMoreDetails(),\r\n      (async() => {\r\n        const [element, icons] = await Promise.all([\r\n          wrapPeerTitle({\r\n            peerId,\r\n            dialog: this.isDialog,\r\n          }),\r\n\r\n          generateTitleIcons(peerId)\r\n        ]);\r\n        replaceContent(this.name, element);\r\n        this.name.append(...icons);\r\n      })(),\r\n      this.setPeerStatus(true)\r\n    ]);\r\n  }\r\n\r\n  public async fillProfileElements() {\r\n    if(!this.cleaned) return;\r\n    this.cleaned = false;\r\n    \r\n    this.cleanupHTML();\r\n    await Promise.all([\r\n      this.setAvatar(),\r\n      this.fillRows(),\r\n    ]);\r\n  }\r\n\r\n  private async _setMoreDetails(peerId: PeerId, peerFull: ChatFull | UserFull) {\r\n    // if(peerFull.about) {\r\n    setText(peerFull.about ? wrapRichText(peerFull.about) : undefined, this.bio);\r\n    // }\r\n\r\n    if(!peerId.isUser()) {\r\n      const chat: Chat.channel = await this.managers.appChatsManager.getChat(peerId.toChatId());\r\n      if(chat.username) {\r\n        setText('https://t.me/' + chat.username, this.link);\r\n      } else {\r\n        const exportedInvite = (peerFull as ChatFull.channelFull).exported_invite;\r\n        if(exportedInvite?._ === 'chatInviteExported') {\r\n          setText(exportedInvite.link, this.link);\r\n        }\r\n      }\r\n    }\r\n\r\n    const location = (peerFull as ChatFull.channelFull).location;\r\n    if(location?._ == 'channelLocation') {\r\n      setText(location.address, this.location);\r\n    }\r\n\r\n    this.setMoreDetailsTimeout = window.setTimeout(() => this.setMoreDetails(true), 60e3);\r\n  }\r\n\r\n  private async setMoreDetails(override?: true) {\r\n    this.clearSetMoreDetailsTimeout();\r\n\r\n    const peerId = this.peerId;\r\n    const threadId = this.threadId;\r\n\r\n    if(!peerId || await this.managers.appPeersManager.isRestricted(peerId) || !this.canBeDetailed()) {\r\n      return;\r\n    }\r\n\r\n    const result = await this.managers.acknowledged.appProfileManager.getProfileByPeerId(peerId, override);\r\n    const setPromise = result.result.then(async(peerFull) => {\r\n      if(this.peerId !== peerId || this.threadId !== threadId || await this.managers.appPeersManager.isRestricted(peerId)) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n      \r\n      await this._setMoreDetails(peerId, peerFull);\r\n    });\r\n\r\n    if(result.cached) {\r\n      await setPromise;\r\n    }\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, threadId = 0) {\r\n    if(this.peerId === peerId && this.threadId === threadId) return;\r\n\r\n    if(this.init) {\r\n      this.init();\r\n    }\r\n\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n    \r\n    this.cleaned = true;\r\n  }\r\n\r\n  public clearSetMoreDetailsTimeout() {\r\n    if(this.setMoreDetailsTimeout !== undefined) {\r\n      clearTimeout(this.setMoreDetailsTimeout);\r\n      this.setMoreDetailsTimeout = undefined;\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    this.clearSetMoreDetailsTimeout();\r\n    clearInterval(this.setPeerStatusInterval);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppSearchSuper, { SearchSuperType } from \"../../appSearchSuper.\";\r\nimport SidebarSlider, { SliderSuperTab } from \"../../slider\";\r\nimport { TransitionSlider } from \"../../transition\";\r\nimport AppEditChatTab from \"./editChat\";\r\nimport PeerTitle from \"../../peerTitle\";\r\nimport AppEditContactTab from \"./editContact\";\r\nimport Button from \"../../button\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { toastNew } from \"../../toast\";\r\nimport AppAddMembersTab from \"../../sidebarLeft/tabs/addMembers\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerCheckboxOptions } from \"../../popups/peer\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport PeerProfile from \"../../peerProfile\";\r\nimport { Message } from \"../../../layer\";\r\n\r\nconst historiesStorage: {\r\n  [peerId: PeerId]: Partial<{\r\n    [type in SearchSuperType]: {mid: number, peerId: PeerId}[]\r\n  }>\r\n} = {};\r\n\r\n// TODO: отредактированное сообщение не изменится\r\nexport default class AppSharedMediaTab extends SliderSuperTab {\r\n  private editBtn: HTMLElement;\r\n\r\n  private peerId: PeerId;\r\n  private threadId = 0;\r\n\r\n  private searchSuper: AppSearchSuper;\r\n\r\n  private profile: PeerProfile;\r\n  private peerChanged: boolean;\r\n\r\n  constructor(slider: SidebarSlider) {\r\n    super(slider, false);\r\n  }\r\n\r\n  public init() {\r\n    //const perf = performance.now();\r\n\r\n    this.container.classList.add('shared-media-container', 'profile-container');\r\n\r\n    // * header\r\n    const newCloseBtn = Button('btn-icon sidebar-close-button', {noRipple: true});\r\n    this.closeBtn.replaceWith(newCloseBtn);\r\n    this.closeBtn = newCloseBtn;\r\n\r\n    const animatedCloseIcon = document.createElement('div');\r\n    animatedCloseIcon.classList.add('animated-close-icon');\r\n    newCloseBtn.append(animatedCloseIcon);\r\n\r\n    const transitionContainer = document.createElement('div');\r\n    transitionContainer.className = 'transition slide-fade';\r\n    \r\n    const transitionFirstItem = document.createElement('div');\r\n    transitionFirstItem.classList.add('transition-item');\r\n\r\n    this.title.append(i18n('Profile'));\r\n    this.editBtn = ButtonIcon('edit');\r\n    //const moreBtn = ButtonIcon('more');\r\n\r\n    transitionFirstItem.append(this.title, this.editBtn/* , moreBtn */);\r\n\r\n    const transitionLastItem = document.createElement('div');\r\n    transitionLastItem.classList.add('transition-item');\r\n\r\n    const secondTitle: HTMLElement = this.title.cloneNode() as any;\r\n    secondTitle.append(i18n('PeerInfo.SharedMedia'));\r\n\r\n    transitionLastItem.append(secondTitle);\r\n\r\n    transitionContainer.append(transitionFirstItem, transitionLastItem);\r\n\r\n    this.header.append(transitionContainer);\r\n\r\n    // * body\r\n\r\n    this.profile = new PeerProfile(this.managers, this.scrollable);\r\n    this.profile.init();\r\n    \r\n    this.scrollable.append(this.profile.element);\r\n\r\n    const HEADER_HEIGHT = 56;\r\n    this.scrollable.onAdditionalScroll = () => {\r\n      const rect = this.searchSuper.nav.getBoundingClientRect(); \r\n      if(!rect.width) return;\r\n\r\n      const top = rect.top - 1;\r\n      setIsSharedMedia(top <= HEADER_HEIGHT);\r\n    };\r\n\r\n    const setIsSharedMedia = (isSharedMedia: boolean) => {\r\n      animatedCloseIcon.classList.toggle('state-back', isSharedMedia);\r\n      this.searchSuper.container.classList.toggle('is-full-viewport', isSharedMedia);\r\n      transition(+isSharedMedia);\r\n\r\n      if(!isSharedMedia) {\r\n        this.searchSuper.cleanScrollPositions();\r\n      }\r\n    };\r\n\r\n    const transition = TransitionSlider(transitionContainer, 'slide-fade', 400, null, false);\r\n\r\n    transition(0);\r\n\r\n    attachClickEvent(this.closeBtn, (e) => {\r\n      if(this.closeBtn.firstElementChild.classList.contains('state-back')) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.scrollable.container.firstElementChild as HTMLElement, \r\n          position: 'start'\r\n        });\r\n        transition(0);\r\n        animatedCloseIcon.classList.remove('state-back');\r\n      } else if(!this.scrollable.isHeavyAnimationInProgress) {\r\n        this.slider.onCloseBtnClick();\r\n      }\r\n    });\r\n\r\n    attachClickEvent(this.editBtn, (e) => {\r\n      let tab: AppEditChatTab | AppEditContactTab;\r\n      if(this.peerId.isAnyChat()) {\r\n        tab = this.slider.createTab(AppEditChatTab);\r\n      } else {\r\n        tab = this.slider.createTab(AppEditContactTab);\r\n      }\r\n\r\n      if(tab) {\r\n        if(tab instanceof AppEditChatTab) {\r\n          tab.chatId = this.peerId.toChatId();\r\n        } else {\r\n          tab.peerId = this.peerId;\r\n        }\r\n        \r\n        tab.open();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('contacts_update', (userId) => {\r\n      if(this.peerId === userId) {\r\n        this.toggleEditBtn();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        this.toggleEditBtn();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('history_multiappend', (message) => {\r\n      this.renderNewMessages(message);\r\n    });\r\n    \r\n    this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n      this.deleteDeletedMessages(peerId, Array.from(msgs));\r\n    });\r\n\r\n    // Calls when message successfully sent and we have an id\r\n    this.listenerSetter.add(rootScope)('message_sent', ({message}) => {\r\n      this.renderNewMessages(message);\r\n    });\r\n\r\n    //this.container.prepend(this.closeBtn.parentElement);\r\n\r\n    this.searchSuper = new AppSearchSuper({\r\n      mediaTabs: [{\r\n        inputFilter: 'inputMessagesFilterEmpty',\r\n        name: 'PeerMedia.Members',\r\n        type: 'members'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterPhotoVideo',\r\n        name: 'SharedMediaTab2',\r\n        type: 'media'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterDocument',\r\n        name: 'SharedFilesTab2',\r\n        type: 'files'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterUrl',\r\n        name: 'SharedLinksTab2',\r\n        type: 'links'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterMusic',\r\n        name: 'SharedMusicTab2',\r\n        type: 'music'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterRoundVoice',\r\n        name: 'SharedVoiceTab2',\r\n        type: 'voice'\r\n      }], \r\n      scrollable: this.scrollable,\r\n      onChangeTab: (mediaTab) => {\r\n        let timeout = mediaTab.type === 'members' && rootScope.settings.animationsEnabled ? 250 : 0;\r\n        setTimeout(() => {\r\n          btnAddMembers.classList.toggle('is-hidden', mediaTab.type !== 'members');\r\n        }, timeout);\r\n      },\r\n      managers: this.managers\r\n    });\r\n\r\n    this.searchSuper.scrollStartCallback = () => {\r\n      setIsSharedMedia(true);\r\n    };\r\n\r\n    this.profile.element.append(this.searchSuper.container);\r\n\r\n    const btnAddMembers = ButtonCorner({icon: 'addmember_filled'});\r\n    this.content.append(btnAddMembers);\r\n\r\n    btnAddMembers.addEventListener('click', async() => {\r\n      const peerId = this.peerId;\r\n      const id = this.peerId.toChatId();\r\n      const isChannel = await this.managers.appChatsManager.isChannel(id);\r\n\r\n      const showConfirmation = (peerIds: PeerId[], callback: (checked: PopupPeerButtonCallbackCheckboxes) => void) => {\r\n        let titleLangKey: LangPackKey, titleLangArgs: any[],\r\n          descriptionLangKey: LangPackKey, descriptionLangArgs: any[],\r\n          checkboxes: PopupPeerCheckboxOptions[];\r\n\r\n        if(peerIds.length > 1) {\r\n          titleLangKey = 'AddMembersAlertTitle';\r\n          titleLangArgs = [i18n('Members', [peerIds.length])];\r\n          descriptionLangKey = 'AddMembersAlertCountText';\r\n          descriptionLangArgs = peerIds.map((peerId) => {\r\n            const b = document.createElement('b');\r\n            b.append(new PeerTitle({peerId}).element);\r\n            return b;\r\n          });\r\n\r\n          if(!isChannel) {\r\n            checkboxes = [{\r\n              text: 'AddMembersForwardMessages',\r\n              checked: true\r\n            }];\r\n          }\r\n        } else {\r\n          titleLangKey = 'AddOneMemberAlertTitle';\r\n          descriptionLangKey = 'AddMembersAlertNamesText';\r\n          const b = document.createElement('b');\r\n          b.append(new PeerTitle({\r\n            peerId: peerIds[0]\r\n          }).element);\r\n          descriptionLangArgs = [b];\r\n\r\n          if(!isChannel) {\r\n            checkboxes = [{\r\n              text: 'AddOneMemberForwardMessages',\r\n              textArgs: [new PeerTitle({peerId: peerIds[0]}).element],\r\n              checked: true\r\n            }];\r\n          }\r\n        }\r\n\r\n        descriptionLangArgs.push(new PeerTitle({\r\n          peerId\r\n        }).element);\r\n\r\n        new PopupPeer('popup-add-members', {\r\n          peerId,\r\n          titleLangKey,\r\n          descriptionLangKey,\r\n          descriptionLangArgs,\r\n          buttons: [{\r\n            langKey: 'Add',\r\n            callback\r\n          }],\r\n          checkboxes\r\n        }).show();\r\n      };\r\n\r\n      const onError = (err: any) => {\r\n        if(err.type === 'USER_PRIVACY_RESTRICTED') {\r\n          toastNew({langPackKey: 'InviteToGroupError'});\r\n        }\r\n      };\r\n      \r\n      if(isChannel) {\r\n        const tab = this.slider.createTab(AppAddMembersTab);\r\n        tab.open({\r\n          type: 'channel',\r\n          skippable: false,\r\n          takeOut: (peerIds) => {\r\n            showConfirmation(peerIds, () => {\r\n              const promise = this.managers.appChatsManager.inviteToChannel(id, peerIds);\r\n              promise.catch(onError);\r\n              tab.attachToPromise(promise);\r\n            });\r\n\r\n            return false;\r\n          },\r\n          title: 'GroupAddMembers',\r\n          placeholder: 'SendMessageTo'\r\n        });\r\n      } else {\r\n        new PopupPickUser({\r\n          peerTypes: ['contacts'],\r\n          placeholder: 'Search',\r\n          onSelect: (peerId) => {\r\n            setTimeout(() => {\r\n              showConfirmation([peerId], (checked) => {\r\n                this.managers.appChatsManager.addChatUser(id, peerId, checked.size ? undefined : 0)\r\n                .catch(onError);\r\n              });\r\n            }, 0);\r\n          },\r\n        });\r\n      }\r\n    });\r\n\r\n    //console.log('construct shared media time:', performance.now() - perf);\r\n  }\r\n\r\n  public async renderNewMessages(message: Message.message | Message.messageService) {\r\n    if(this.init) return; // * not inited yet\r\n\r\n    const {peerId} = message;\r\n    if(!historiesStorage[peerId]) return;\r\n\r\n    for(const mediaTab of this.searchSuper.mediaTabs) {\r\n      const inputFilter = mediaTab.inputFilter;\r\n      const history = historiesStorage[peerId][inputFilter];\r\n      if(!history) {\r\n        continue;\r\n      }\r\n\r\n      const filtered = this.searchSuper.filterMessagesByType([message], inputFilter).filter((message) => !history.find((m) => m.mid === message.mid && m.peerId === message.peerId));\r\n      if(filtered.length) {\r\n        history.unshift(...filtered.map((message) => ({mid: message.mid, peerId: message.peerId})));\r\n\r\n        if(this.peerId === peerId && this.searchSuper.usedFromHistory[inputFilter] !== -1) {\r\n          this.searchSuper.usedFromHistory[inputFilter] += filtered.length;\r\n          this.searchSuper.performSearchResult(filtered, mediaTab, false);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public deleteDeletedMessages(peerId: PeerId, mids: number[]) {\r\n    if(this.init) return; // * not inited yet\r\n\r\n    if(!historiesStorage[peerId]) return;\r\n\r\n    for(const mid of mids) {\r\n      for(const type of this.searchSuper.mediaTabs) {\r\n        const inputFilter = type.inputFilter;\r\n\r\n        const history = historiesStorage[peerId][inputFilter];\r\n        if(!history) continue;\r\n\r\n        const idx = history.findIndex((m) => m.mid === mid);\r\n        if(idx === -1) {\r\n          continue;\r\n        }\r\n\r\n        history.splice(idx, 1);\r\n\r\n        if(this.peerId === peerId) {\r\n          const container = this.searchSuper.tabs[inputFilter];\r\n          const div = container.querySelector(`[data-mid=\"${mid}\"][data-peer-id=\"${peerId}\"]`) as HTMLElement;\r\n          if(div) {\r\n            if(this.searchSuper.selection.isSelecting) {\r\n              this.searchSuper.selection.toggleByElement(div);\r\n            }\r\n\r\n            div.remove();\r\n          }\r\n\r\n          if(this.searchSuper.usedFromHistory[inputFilter] >= (idx + 1)) {\r\n            --this.searchSuper.usedFromHistory[inputFilter];\r\n          }\r\n        }\r\n\r\n        // can have element in different tabs somehow\r\n        // break;\r\n      }\r\n    }\r\n\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  public async cleanupHTML() {\r\n    // const perf = performance.now();\r\n    this.profile.cleanupHTML();\r\n    this.editBtn.classList.add('hide');\r\n    this.searchSuper.cleanupHTML(true);\r\n    this.container.classList.toggle('can-add-members', await this.searchSuper.canViewMembers() && await this.managers.appChatsManager.hasRights(this.peerId.toChatId(), 'invite_users'));\r\n    // console.log('cleanupHTML shared media time:', performance.now() - perf);\r\n  }\r\n\r\n  public setLoadMutex(promise: Promise<any>) {\r\n    this.searchSuper.loadMutex = promise;\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, threadId = 0) {\r\n    if(this.peerId === peerId && this.threadId === threadId) return false;\r\n\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n    this.peerChanged = true;\r\n\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.searchSuper.setQuery({\r\n      peerId, \r\n      //threadId, \r\n      historyStorage: historiesStorage[peerId] ??= {}\r\n    });\r\n\r\n    this.profile.setPeer(peerId, threadId);\r\n    \r\n    return true;\r\n  }\r\n\r\n  public async fillProfileElements() {\r\n    if(!this.peerChanged) {\r\n      return;\r\n    }\r\n\r\n    this.peerChanged = false;\r\n    await this.cleanupHTML();\r\n    await this.toggleEditBtn();\r\n    await this.profile.fillProfileElements();\r\n  }\r\n\r\n  private async toggleEditBtn() {\r\n    let show: boolean;\r\n    if(this.peerId.isUser()) {\r\n      show = this.peerId !== rootScope.myId && await this.managers.appUsersManager.isContact(this.peerId.toUserId());\r\n    } else {\r\n      show = await this.managers.appChatsManager.hasRights(this.peerId.toChatId(), 'change_info');\r\n    }\r\n\r\n    this.editBtn.classList.toggle('hide', !show);\r\n  }\r\n\r\n  public loadSidebarMedia(single: boolean, justLoad?: boolean) {\r\n    this.searchSuper.load(single, justLoad);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  public destroy() {\r\n    this.destroyable = true;\r\n    this.onCloseAfterTimeout();\r\n    this.profile.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport SidebarSlider from \"../slider\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport AppSharedMediaTab from \"./tabs/sharedMedia\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport const RIGHT_COLUMN_ACTIVE_CLASSNAME = 'is-right-column-shown';\r\n\r\nexport class AppSidebarRight extends SidebarSlider {\r\n  private isColumnProportionSet = false;\r\n  private sharedMediaTab: AppSharedMediaTab;\r\n\r\n  constructor() {\r\n    super({\r\n      sidebarEl: document.getElementById('column-right') as HTMLElement,\r\n      canHideFirst: true,\r\n      navigationType: 'right'\r\n    });\r\n  }\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    mediaSizes.addEventListener('changeScreen', (from, to) => {\r\n      if(to === ScreenSize.medium && from !== ScreenSize.mobile) {\r\n        this.toggleSidebar(false);\r\n      }\r\n    });\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      this.setColumnProportion();\r\n    });\r\n  }\r\n\r\n  public createSharedMediaTab() {\r\n    const tab = this.createTab(AppSharedMediaTab, true);\r\n    tab.slider = this;\r\n    // this.tabsContainer.prepend(tab.container);\r\n    return tab;\r\n  }\r\n\r\n  public replaceSharedMediaTab(tab: AppSharedMediaTab) {\r\n    let previousTab = this.sharedMediaTab;\r\n    if(previousTab) {\r\n      const wasActive = previousTab.container.classList.contains('active');\r\n      if(wasActive) {\r\n        tab.container.classList.add('active');\r\n      }\r\n      \r\n      previousTab.container.replaceWith(tab.container);\r\n    } else {\r\n      this.tabsContainer.prepend(tab.container);\r\n    }\r\n\r\n    this.sharedMediaTab = tab;\r\n  }\r\n\r\n  public onCloseTab(id: number, animate: boolean, isNavigation?: boolean) {\r\n    if(!this.historyTabIds.length) {\r\n      this.toggleSidebar(false, animate);\r\n    }\r\n\r\n    super.onCloseTab(id, animate, isNavigation);\r\n  }\r\n\r\n  private setColumnProportion() {\r\n    const proportion = this.sidebarEl.scrollWidth / this.sidebarEl.previousElementSibling.scrollWidth;\r\n    document.documentElement.style.setProperty('--right-column-proportion', '' + proportion);\r\n  }\r\n\r\n  public toggleSidebar(enable?: boolean, animate?: boolean) {\r\n    const active = document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME);\r\n    let willChange: boolean;\r\n    if(enable !== undefined) {\r\n      if(enable) {\r\n        if(!active) {\r\n          willChange = true;\r\n        }\r\n      } else if(active) {\r\n        willChange = true;\r\n      }\r\n    } else {\r\n      willChange = true;\r\n    }\r\n\r\n    if(!willChange) return Promise.resolve();\r\n\r\n    if(!active && !this.historyTabIds.length) {\r\n      this.sharedMediaTab.open();\r\n    }\r\n\r\n    if(!this.isColumnProportionSet) {\r\n      this.setColumnProportion();\r\n      this.isColumnProportionSet = true;\r\n    }\r\n\r\n    const animationPromise = appImManager.selectTab(active ? 1 : 2, animate);\r\n    document.body.classList.toggle(RIGHT_COLUMN_ACTIVE_CLASSNAME, enable);\r\n    return animationPromise;\r\n\r\n    /* return new Promise((resolve, reject) => {\r\n      const hidden: {element: HTMLDivElement, height: number}[] = [];\r\n      const observer = new IntersectionObserver((entries) => {\r\n        for(const entry of entries) {\r\n          const bubble = entry.target as HTMLDivElement;\r\n          if(!entry.isIntersecting) {\r\n            hidden.push({element: bubble, height: bubble.scrollHeight});\r\n          }\r\n        }\r\n  \r\n        for(const item of hidden) {\r\n          item.element.style.minHeight = item.height + 'px';\r\n          (item.element.firstElementChild as HTMLElement).style.display = 'none';\r\n          item.element.style.width = '1px';\r\n        }\r\n  \r\n        //console.log('hidden', hidden);\r\n        observer.disconnect();\r\n  \r\n        set();\r\n  \r\n        setTimeout(() => {\r\n          for(const item of hidden) {\r\n            item.element.style.minHeight = '';\r\n            item.element.style.width = '';\r\n            (item.element.firstElementChild as HTMLElement).style.display = '';\r\n          }\r\n\r\n          resolve();\r\n        }, 200);\r\n      });\r\n  \r\n      const length = Object.keys(appImManager.bubbles).length;\r\n      if(length) {\r\n        for(const i in appImManager.bubbles) {\r\n          observer.observe(appImManager.bubbles[i]);\r\n        }\r\n      } else {\r\n        set();\r\n        setTimeout(resolve, 200);\r\n      }\r\n    }); */\r\n  }\r\n}\r\n\r\nconst appSidebarRight = new AppSidebarRight();\r\nMOUNT_CLASS_TO.appSidebarRight = appSidebarRight;\r\nexport default appSidebarRight;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport appSidebarRight from \"..\";\r\nimport { roundPercents } from \"../../poll\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport ripple from \"../../ripple\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppPollResultsTab extends SliderSuperTab {\r\n  private resultsDiv: HTMLElement;\r\n\r\n  protected init() {\r\n    this.container.id = 'poll-results-container';\r\n    this.container.classList.add('chatlist-container');\r\n\r\n    this.resultsDiv = document.createElement('div');\r\n    this.resultsDiv.classList.add('poll-results');\r\n    this.scrollable.append(this.resultsDiv);\r\n  }\r\n\r\n  public async open(message: any) {\r\n    const ret = super.open();\r\n    const poll = await this.managers.appPollsManager.getPoll(message.media.poll.id);\r\n\r\n    this.setTitle(poll.poll.pFlags.quiz ? 'PollResults.Title.Quiz' : 'PollResults.Title.Poll');\r\n\r\n    const title = document.createElement('h3');\r\n    setInnerHTML(title, wrapEmojiText(poll.poll.question));\r\n\r\n    const percents = poll.results.results.map((v) => v.voters / poll.results.total_voters * 100);\r\n    roundPercents(percents);\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    poll.results.results.forEach((result, idx) => {\r\n      if(!result.voters) return;\r\n\r\n      const hr = document.createElement('hr');\r\n\r\n      const answer = poll.poll.answers[idx];\r\n\r\n      // Head\r\n      const answerEl = document.createElement('div');\r\n      answerEl.classList.add('poll-results-answer');\r\n\r\n      const answerTitle = document.createElement('div');\r\n      setInnerHTML(answerTitle, wrapEmojiText(answer.text));\r\n\r\n      const answerPercents = document.createElement('div');\r\n      answerPercents.innerText = Math.round(percents[idx]) + '%';\r\n\r\n      answerEl.append(answerTitle, answerPercents);\r\n\r\n      // Humans\r\n      const list = appDialogsManager.createChatList();\r\n      list.classList.add('poll-results-voters');\r\n\r\n      appDialogsManager.setListClickListener(list, () => {\r\n        appSidebarRight.onCloseBtnClick();\r\n      }, undefined, true);\r\n\r\n      list.style.minHeight = Math.min(result.voters, 4) * 50 + 'px';\r\n\r\n      fragment.append(hr, answerEl, list);\r\n\r\n      let offset: string, limit = 4, loading = false, left = result.voters - 4;\r\n      const load = () => {\r\n        if(loading) return;\r\n        loading = true;\r\n\r\n        this.managers.appPollsManager.getVotes(message, answer.option, offset, limit).then((votesList) => {\r\n          votesList.votes.forEach((vote) => {\r\n            const {dom} = appDialogsManager.addDialogNew({\r\n              peerId: vote.user_id.toPeerId(false),\r\n              container: list,\r\n              rippleEnabled: false, \r\n              meAsSaved: false,\r\n              avatarSize: 32\r\n            });\r\n            dom.lastMessageSpan.parentElement.remove();\r\n          });\r\n\r\n          if(offset) {\r\n            left -= votesList.votes.length;\r\n            (showMore.lastElementChild as HTMLElement).replaceWith(i18n('PollResults.LoadMore', [Math.min(20, left)]));\r\n          }\r\n          \r\n          offset = votesList.next_offset;\r\n          limit = 20;\r\n\r\n          if(!left || !votesList.votes.length) {\r\n            showMore.remove();\r\n          }\r\n        }).finally(() => {\r\n          loading = false;\r\n        });\r\n      };\r\n\r\n      load();\r\n\r\n      if(left <= 0) return;\r\n\r\n      const showMore = document.createElement('div');\r\n      showMore.classList.add('poll-results-more', 'show-more', 'rp-overflow');\r\n      showMore.addEventListener('click', load);\r\n      ripple(showMore);\r\n      const down = document.createElement('div');\r\n      down.classList.add('tgico-down');\r\n      showMore.append(down, i18n('PollResults.LoadMore', [Math.min(20, left)]));\r\n\r\n      fragment.append(showMore);\r\n    });\r\n\r\n    this.resultsDiv.append(title, fragment);\r\n\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      /* appPollsManager.getVotes(mid).then((votes) => {\r\n        console.log('gOt VotEs', votes);\r\n      }); */\r\n    });\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarElement from \"./avatar\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\n\r\nconst CLASS_NAME = 'stacked-avatars';\r\nconst AVATAR_CLASS_NAME = CLASS_NAME + '-avatar';\r\nconst AVATAR_CONTAINER_CLASS_NAME = AVATAR_CLASS_NAME + '-container';\r\n\r\nexport default class StackedAvatars {\r\n  public container: HTMLElement;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private avatarSize: number;\r\n\r\n  constructor(options: {\r\n    lazyLoadQueue?: StackedAvatars['lazyLoadQueue'],\r\n    avatarSize: StackedAvatars['avatarSize']\r\n  }) {\r\n    this.lazyLoadQueue = options.lazyLoadQueue;\r\n    this.avatarSize = options.avatarSize;\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(CLASS_NAME);\r\n\r\n    this.container.style.setProperty('--avatar-size', options.avatarSize + 'px');\r\n  }\r\n  /**\r\n   * MACOS, ANDROID - без реверса\r\n   * WINDOWS DESKTOP - реверс\r\n   * все приложения накладывают аватарку первую на вторую, а в макете зато вторая на первую, ЛОЛ!\r\n   */\r\n  public render(peerIds: PeerId[], loadPromises?: Promise<any>[]) {\r\n    const children = this.container.children;\r\n    peerIds = peerIds.slice().reverse();\r\n    if(peerIds.length > 3) {\r\n      peerIds = peerIds.slice(-3);\r\n    }\r\n\r\n    peerIds.forEach((peerId, idx) => {\r\n      let avatarContainer = children[idx] as HTMLElement;\r\n      if(!avatarContainer) {\r\n        avatarContainer = document.createElement('div');\r\n        avatarContainer.classList.add(AVATAR_CONTAINER_CLASS_NAME);\r\n      }\r\n\r\n      let avatarElem = avatarContainer.firstElementChild as AvatarElement;\r\n      if(!avatarElem) {\r\n        avatarElem = new AvatarElement();\r\n        avatarElem.classList.add('avatar-' + this.avatarSize, AVATAR_CLASS_NAME);\r\n        avatarElem.updateOptions({\r\n          isDialog: false,\r\n          loadPromises\r\n        });\r\n      }\r\n\r\n      avatarElem.updateWithOptions({\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        peerId: peerId\r\n      });\r\n      \r\n      if(!avatarElem.parentNode) {\r\n        avatarContainer.append(avatarElem);\r\n      }\r\n\r\n      if(!avatarContainer.parentNode) {\r\n        this.container.append(avatarContainer);\r\n      }\r\n    });\r\n\r\n    // if were 3 and became 2\r\n    (Array.from(children) as HTMLElement[]).slice(peerIds.length).forEach((el) => el.remove());\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ripple from \"./ripple\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport AppPollResultsTab from \"./sidebarRight/tabs/pollResults\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport { Message, MessageMedia, Poll, PollResults } from \"../layer\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport StackedAvatars from \"./stackedAvatars\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\n\r\nlet lineTotalLength = 0;\r\nconst tailLength = 9;\r\nconst times = 10;\r\nconst fullTime = 340;\r\nconst oneTime = fullTime / times;\r\n\r\nexport const roundPercents = (percents: number[]) => {\r\n  //console.log('roundPercents before percents:', percents);\r\n\r\n  const sum = percents.reduce((acc, p) => acc + Math.round(p), 0);\r\n  if(sum > 100) {\r\n    const diff = sum - 100;\r\n    const length = percents.length;\r\n    for(let i = 0; i < diff; ++i) {\r\n      let minIndex = -1, minRemainder = 1;\r\n      for(let k = 0; k < length; ++k) {\r\n        let remainder = percents[k] % 1;\r\n        if(remainder >= 0.5 && remainder < minRemainder) {\r\n          minRemainder = remainder;\r\n          minIndex = k;\r\n        }\r\n      }\r\n\r\n      if(minIndex === -1) {\r\n        //throw new Error('lol chto');\r\n        return;\r\n      }\r\n\r\n      percents[minIndex] -= minRemainder;\r\n    }\r\n  } else if(sum < 100) {\r\n    const diff = 100 - sum;\r\n    const length = percents.length;\r\n    for(let i = 0; i < diff; ++i) {\r\n      let minIndex = -1, maxRemainder = 0;\r\n      for(let k = 0; k < length; ++k) {\r\n        let remainder = percents[k] % 1;\r\n        if(remainder < 0.5 && remainder > maxRemainder) {\r\n          maxRemainder = remainder;\r\n          minIndex = k;\r\n        }\r\n      }\r\n\r\n      if(minIndex === -1) {\r\n        //throw new Error('lol chto');\r\n        return;\r\n      }\r\n\r\n      percents[minIndex] += 1 - maxRemainder;\r\n    }\r\n  }\r\n\r\n  //console.log('roundPercents after percents:', percents);\r\n};\r\n\r\n/* const connectedPolls: {id: string, element: PollElement}[] = [];\r\nrootScope.on('poll_update', (e) => {\r\n  const {poll, results} = e as {poll: Poll, results: PollResults};\r\n\r\n  //console.log('poll_update', poll, results);\r\n  for(const connected of connectedPolls) {\r\n    if(connected.id === poll.id) {\r\n      const pollElement = connected.element;\r\n      pollElement.isClosed = !!poll.pFlags.closed;\r\n      pollElement.performResults(results, poll.chosenIndexes);\r\n    }\r\n  }\r\n}); */\r\n\r\nrootScope.addEventListener('poll_update', ({poll, results}) => {\r\n  const pollElements = Array.from(document.querySelectorAll(`poll-element[poll-id=\"${poll.id}\"]`)) as PollElement[];\r\n  pollElements.forEach((pollElement) => {\r\n    //console.log('poll_update', poll, results);\r\n    pollElement.isClosed = !!poll.pFlags.closed;\r\n    pollElement.performResults(results, poll.chosenIndexes);\r\n  });\r\n});\r\n\r\nmediaSizes.addEventListener('resize', () => {\r\n  PollElement.setMaxLength();\r\n  PollElement.resizePolls();\r\n});\r\n\r\nmediaSizes.addEventListener('changeScreen', () => {\r\n  PollElement.setMaxLength();\r\n});\r\n\r\nconst hideQuizHint = (element: HTMLElement, onHide: () => void, timeout: number) => {\r\n  element.classList.remove('active');\r\n\r\n  clearTimeout(timeout);\r\n  setTimeout(() => {\r\n    onHide();\r\n    element.remove();\r\n\r\n    if(prevQuizHint === element && prevQuizHintOnHide === onHide && prevQuizHintTimeout === timeout) {\r\n      prevQuizHint = prevQuizHintOnHide = null;\r\n      prevQuizHintTimeout = 0;\r\n    }\r\n  }, 200);\r\n};\r\n\r\nlet prevQuizHint: HTMLElement, prevQuizHintOnHide: () => void, prevQuizHintTimeout: number;\r\nlet isListenerSet = false;\r\nconst setQuizHint = (solution: string, solution_entities: any[], onHide: () => void) => {\r\n  if(prevQuizHint) {\r\n    hideQuizHint(prevQuizHint, prevQuizHintOnHide, prevQuizHintTimeout);\r\n  }\r\n\r\n  const element = document.createElement('div');\r\n  element.classList.add('quiz-hint');\r\n\r\n  const container = document.createElement('div');\r\n  container.classList.add('container', 'tgico');\r\n\r\n  const textEl = document.createElement('div');\r\n  textEl.classList.add('text');\r\n\r\n  container.append(textEl);\r\n  element.append(container);\r\n\r\n  setInnerHTML(textEl, wrapRichText(solution, {entities: solution_entities}));\r\n  appImManager.chat.bubbles.container.append(element);\r\n\r\n  void element.offsetLeft; // reflow\r\n  element.classList.add('active');\r\n\r\n  prevQuizHint = element;\r\n  prevQuizHintOnHide = onHide;\r\n  prevQuizHintTimeout = window.setTimeout(() => {\r\n    hideQuizHint(element, onHide, prevQuizHintTimeout);\r\n  }, IS_TOUCH_SUPPORTED ? 5000 : 7000);\r\n\r\n  if(!isListenerSet) {\r\n    isListenerSet = true;\r\n    appImManager.addEventListener('peer_changed', () => {\r\n      if(prevQuizHint) {\r\n        hideQuizHint(prevQuizHint, prevQuizHintOnHide, prevQuizHintTimeout);\r\n      }\r\n    });\r\n  }\r\n};\r\n\r\nexport default class PollElement extends HTMLElement {\r\n  public static MAX_OFFSET = -46.5;\r\n  public static MAX_LENGTH = 0;\r\n  public svgLines: SVGSVGElement[];\r\n  private numberDivs: HTMLDivElement[];\r\n  private answerDivs: HTMLDivElement[];\r\n  private descDiv: HTMLElement;\r\n  private typeDiv: HTMLElement;\r\n  private avatarsDiv: HTMLElement;\r\n  private viewResults: HTMLElement;\r\n  private votersCountDiv: HTMLDivElement;\r\n\r\n  // private maxLength: number;\r\n  // private maxLengths: number[];\r\n  private maxPercents: number[];\r\n\r\n  public isClosed = false;\r\n  private isQuiz = false;\r\n  private isRetracted = false;\r\n  private isPublic = false;\r\n  private isMultiple = false;\r\n  private chosenIndexes: number[] = [];\r\n  private percents: number[];\r\n\r\n  public message: Message.message;\r\n  public managers: AppManagers;\r\n\r\n  private quizInterval: number;\r\n  private quizTimer: SVGSVGElement;\r\n\r\n  private sendVoteBtn: HTMLElement;\r\n  private chosingIndexes: number[] = [];\r\n\r\n  private sendVotePromise: Promise<void>;\r\n  private sentVote = false;\r\n\r\n  public static setMaxLength() {\r\n    const width = windowSize.width <= 360 ? windowSize.width - 120 : mediaSizes.active.poll.width;\r\n    this.MAX_LENGTH = width + tailLength + this.MAX_OFFSET + -13.7; // 13 - position left\r\n  }\r\n\r\n  public static resizePolls() {\r\n    if(!this.MAX_LENGTH) return;\r\n    const pollElements = Array.from(document.querySelectorAll('poll-element.is-voted')) as PollElement[];\r\n    pollElements.forEach((pollElement) => {\r\n      pollElement.svgLines.forEach((svg, idx) => {\r\n        //void svg.getBoundingClientRect(); // reflow\r\n        pollElement.setLineProgress(idx, 1);\r\n      });\r\n    });\r\n  }\r\n\r\n  public async render() {\r\n    // браузер вызывает этот метод при добавлении элемента в документ\r\n    // (может вызываться много раз, если элемент многократно добавляется/удаляется)\r\n\r\n    if(!lineTotalLength) {\r\n      lineTotalLength = (document.getElementById('poll-line') as any as SVGPathElement).getTotalLength();\r\n      //console.log('line total length:', lineTotalLength);\r\n      PollElement.setMaxLength();\r\n    }\r\n\r\n    // const {poll, results} = this.managers.appPollsManager.getPoll(pollId);\r\n    const {poll, results} = this.message.media as MessageMedia.messageMediaPoll;\r\n\r\n    /* const timestamp = Date.now() / 1000 | 0;\r\n    if(timestamp < this.message.date) { */\r\n    if(this.message.pFlags.is_scheduled) {\r\n      this.classList.add('disable-hover');\r\n    }\r\n\r\n    //console.log('pollElement poll:', poll, results);\r\n\r\n    let descKey: LangPackKey;\r\n    if(poll.pFlags) {\r\n      this.isPublic = !!poll.pFlags.public_voters;\r\n      this.isQuiz = !!poll.pFlags.quiz;\r\n      this.isClosed = !!poll.pFlags.closed;\r\n      this.isMultiple = !!poll.pFlags.multiple_choice;\r\n\r\n      if(this.isClosed) {\r\n        descKey = 'Chat.Poll.Type.Closed';\r\n        this.classList.add('is-closed');\r\n      } else if(this.isQuiz) {\r\n        descKey = this.isPublic ? 'Chat.Poll.Type.Quiz' : 'Chat.Poll.Type.AnonymousQuiz';\r\n      } else {\r\n        descKey = this.isPublic ? 'Chat.Poll.Type.Public' : 'Chat.Poll.Type.Anonymous';\r\n      }\r\n    }\r\n\r\n    this.classList.toggle('is-multiple', this.isMultiple);\r\n\r\n    const multipleSelect = this.isMultiple ? '<span class=\"poll-answer-selected tgico-check\"></span>' : '';\r\n    const votes = poll.answers.map((answer, idx) => {\r\n      return `\r\n        <div class=\"poll-answer\" data-index=\"${idx}\">\r\n          <div class=\"circle-hover\">\r\n            <div class=\"animation-ring\"></div>\r\n            <svg class=\"progress-ring\">\r\n              <circle class=\"progress-ring__circle\" cx=\"13\" cy=\"13\" r=\"9\"></circle>\r\n            </svg>\r\n            ${multipleSelect}\r\n          </div>\r\n          <div class=\"poll-answer-percents\"></div>\r\n          <div class=\"poll-answer-text\"></div>\r\n          <svg version=\"1.1\" class=\"poll-line\" style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 485.9 35\" xml:space=\"preserve\">\r\n            <use href=\"#poll-line\"></use>\r\n          </svg>\r\n          <span class=\"poll-answer-selected tgico\"></span>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    this.innerHTML = `\r\n      <div class=\"poll-title\"></div>\r\n      <div class=\"poll-desc\">\r\n        <div class=\"poll-type\"></div>\r\n        <div class=\"poll-avatars\"></div>\r\n      </div>\r\n      ${votes}`;\r\n    \r\n    setInnerHTML(this.firstElementChild, wrapEmojiText(poll.question));\r\n\r\n    Array.from(this.querySelectorAll('.poll-answer-text')).forEach((el, idx) => {\r\n      setInnerHTML(el, wrapEmojiText(poll.answers[idx].text));\r\n    });\r\n\r\n    this.descDiv = this.firstElementChild.nextElementSibling as HTMLElement;\r\n    this.typeDiv = this.descDiv.firstElementChild as HTMLElement;\r\n    this.avatarsDiv = this.descDiv.lastElementChild as HTMLElement;\r\n\r\n    if(descKey) {\r\n      this.typeDiv.append(i18n(descKey));\r\n    }\r\n\r\n    if(this.isQuiz) {\r\n      this.classList.add('is-quiz');\r\n\r\n      if(poll.close_period && poll.close_date) {\r\n        const timeLeftDiv = document.createElement('div');\r\n        timeLeftDiv.classList.add('poll-time');\r\n        this.descDiv.append(timeLeftDiv);\r\n\r\n        const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n        //svg.setAttributeNS(null, 'viewBox', '0 0 15 15');\r\n        svg.classList.add('poll-quiz-timer');\r\n\r\n        this.quizTimer = svg;\r\n\r\n        const strokeWidth = 2;\r\n        const radius = 7;\r\n        const circumference = 2 * Math.PI * radius;\r\n\r\n        const circle = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n        circle.classList.add('poll-quiz-timer-circle');\r\n        circle.setAttributeNS(null, 'cx', '16');\r\n        circle.setAttributeNS(null, 'cy', '16');\r\n        circle.setAttributeNS(null, 'r', '' + radius);\r\n        circle.setAttributeNS(null, 'stroke-width', '' + strokeWidth);\r\n\r\n        svg.append(circle);\r\n        this.descDiv.append(svg);\r\n        \r\n        const period = poll.close_period * 1000;\r\n        const closeTime = (poll.close_date - await rootScope.managers.timeManager.getServerTimeOffset()) * 1000;\r\n\r\n        //console.log('closeTime:', poll.close_date, serverTimeManager.serverTimeOffset, Date.now() / 1000 | 0);\r\n\r\n        // let time = Date.now();\r\n        // let percents = (closeTime - time) / period;\r\n\r\n        // timeLeftDiv.innerHTML = String((closeTime - time) / 1000 + 1 | 0).toHHMMSS();\r\n\r\n        // // @ts-ignore\r\n        // circle.style.strokeDashoffset = circumference + percents * circumference;\r\n        // circle.style.strokeDasharray = ${circumference} ${circumference};\r\n\r\n        this.quizInterval = window.setInterval(() => {\r\n          const time = Date.now();\r\n          const percents = (closeTime - time) / period;\r\n          const timeLeft = (closeTime - time) / 1000 + 1 | 0;\r\n          timeLeftDiv.innerHTML = toHHMMSS(timeLeft);\r\n          \r\n          if (timeLeft <= 5) {\r\n            timeLeftDiv.style.color = '#ee545c';\r\n            circle.style.stroke = '#ee545c';\r\n          }\r\n          //timeLeftDiv.style.visibility = 'visible';\r\n\r\n          // @ts-ignore\r\n          circle.style.strokeDashoffset = circumference + percents * circumference;\r\n          circle.style.strokeDasharray = `${circumference} ${circumference}`;\r\n\r\n          if(time >= closeTime) {\r\n            clearInterval(this.quizInterval);\r\n            timeLeftDiv.innerHTML = '';\r\n            // @ts-ignore\r\n            circle.style.strokeDashoffset = circumference;\r\n            this.quizInterval = 0;\r\n\r\n            setTimeout(() => {\r\n              // нужно запросить апдейт чтобы опрос обновился\r\n              this.managers.appPollsManager.getResults(this.message);\r\n            }, 3e3);\r\n          }\r\n        }, 1e3);\r\n      }\r\n    }\r\n    \r\n    this.answerDivs = Array.from(this.querySelectorAll('.poll-answer')) as HTMLDivElement[];\r\n    this.svgLines = Array.from(this.querySelectorAll('.poll-line')) as SVGSVGElement[];\r\n    this.numberDivs = Array.from(this.querySelectorAll('.poll-answer-percents')) as HTMLDivElement[];\r\n\r\n    const footerDiv = document.createElement('div');\r\n    footerDiv.classList.add('poll-footer');\r\n\r\n    this.viewResults = document.createElement('div');\r\n    this.viewResults.className = 'poll-footer-button poll-view-results hide';\r\n    this.viewResults.append(i18n('Chat.Poll.ViewResults'));\r\n\r\n    this.votersCountDiv = document.createElement('div');\r\n    this.votersCountDiv.className = 'poll-votes-count';\r\n\r\n    footerDiv.append(this.viewResults, this.votersCountDiv);\r\n    this.append(footerDiv);\r\n\r\n    this.viewResults.addEventListener('click', (e) => {\r\n      cancelEvent(e);\r\n\r\n      if(!appSidebarRight.isTabExists(AppPollResultsTab)) {\r\n        appSidebarRight.createTab(AppPollResultsTab).open(this.message);\r\n      }\r\n    });\r\n    ripple(this.viewResults);\r\n\r\n    if(this.isMultiple) {\r\n      this.sendVoteBtn = document.createElement('div');\r\n      this.sendVoteBtn.classList.add('poll-footer-button', 'poll-send-vote');\r\n      this.sendVoteBtn.append(i18n('Chat.Poll.SubmitVote'));\r\n      ripple(this.sendVoteBtn);\r\n\r\n      if(!poll.chosenIndexes.length) {\r\n        this.votersCountDiv.classList.add('hide');\r\n      }\r\n\r\n      attachClickEvent(this.sendVoteBtn, (e) => {\r\n        cancelEvent(e);\r\n        /* const indexes = this.answerDivs.filter((el) => el.classList.contains('is-chosing')).map((el) => +el.dataset.index);\r\n        if(indexes.length) {\r\n          \r\n        } */\r\n        if(this.chosingIndexes.length) {\r\n          this.sendVotes(this.chosingIndexes).then(() => {\r\n            this.chosingIndexes.length = 0;\r\n            this.answerDivs.forEach((el) => {\r\n              el.classList.remove('is-chosing');\r\n            });\r\n          });\r\n        }\r\n      });\r\n\r\n      footerDiv.append(this.sendVoteBtn);\r\n    }\r\n\r\n    // const width = this.getBoundingClientRect().width;\r\n    // const width = mediaSizes.active.poll.width;\r\n    // this.maxLength = width + tailLength + this.maxOffset + -13.7; // 13 - position left\r\n\r\n    const canVote = !(poll.chosenIndexes.length || this.isClosed);\r\n    if(!canVote || this.isPublic) {\r\n      this.performResults(results, poll.chosenIndexes, false);\r\n    }\r\n\r\n    if(canVote) {\r\n      this.setVotersCount(results);\r\n      attachClickEvent(this, this.clickHandler);\r\n    }\r\n  }\r\n\r\n  initQuizHint(results: PollResults) {\r\n    if(results.solution && results.solution_entities) {\r\n      const toggleHint = document.createElement('div');\r\n      toggleHint.classList.add('tgico-tip', 'poll-hint');\r\n      this.descDiv.append(toggleHint);\r\n\r\n      //let active = false;\r\n      attachClickEvent(toggleHint, (e) => {\r\n        cancelEvent(e);\r\n\r\n        //active = true;\r\n        toggleHint.classList.add('active');\r\n        setQuizHint(results.solution, results.solution_entities, () => {\r\n          //active = false;\r\n          toggleHint.classList.remove('active');\r\n        });\r\n      });\r\n\r\n      if(this.sentVote) {\r\n        const correctResult = results.results.find((r) => r.pFlags.correct);\r\n        if(correctResult && !correctResult.pFlags.chosen) {\r\n          toggleHint.click();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  clickHandler(e: Event) {\r\n    const target = findUpClassName(e.target, 'poll-answer') as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n    \r\n    cancelEvent(e);\r\n    const answerIndex = +target.dataset.index;\r\n    if(this.isMultiple) {\r\n      target.classList.toggle('is-chosing');\r\n\r\n      const foundIndex = this.chosingIndexes.indexOf(answerIndex);\r\n      if(foundIndex !== -1) {\r\n        this.chosingIndexes.splice(foundIndex, 1);\r\n      } else {\r\n        this.chosingIndexes.push(answerIndex);\r\n      }\r\n    } else {\r\n      this.sendVotes([answerIndex]);\r\n    }\r\n    \r\n    /* target.classList.add('is-voting');\r\n    setTimeout(() => { // simulate\r\n      this.setResults([100, 0], answerIndex);\r\n      target.classList.remove('is-voting');\r\n    }, 1000); */\r\n  }\r\n\r\n  sendVotes(indexes: number[]) {\r\n    if(this.sendVotePromise) return this.sendVotePromise;\r\n\r\n    const targets = this.answerDivs.filter((_, idx) => indexes.includes(idx));\r\n    targets.forEach((target) => {\r\n      target.classList.add('is-voting');\r\n    });\r\n    \r\n    this.classList.add('disable-hover');\r\n    this.sentVote = true;\r\n    return this.sendVotePromise = this.managers.appPollsManager.sendVote(this.message, indexes).then(() => {\r\n      targets.forEach((target) => {\r\n        target.classList.remove('is-voting');\r\n      });\r\n\r\n      this.classList.remove('disable-hover');\r\n    }).catch(() => {\r\n      this.sentVote = false;\r\n    }).finally(() => {\r\n      this.sendVotePromise = null;\r\n    });\r\n  }\r\n\r\n  performResults(results: PollResults, chosenIndexes: number[], animate = true) {\r\n    if(!rootScope.settings.animationsEnabled) {\r\n      animate = false;\r\n    }\r\n\r\n    if(this.isQuiz && (results.results?.length || this.isClosed)) {\r\n      this.answerDivs.forEach((el, idx) => {\r\n        el.classList.toggle('is-correct', !!results.results[idx].pFlags.correct);\r\n      });\r\n\r\n      if(this.initQuizHint) {\r\n        this.initQuizHint(results);\r\n        this.initQuizHint = null;\r\n      }\r\n\r\n      if(this.quizInterval) {\r\n        clearInterval(this.quizInterval);\r\n        this.quizInterval = 0;\r\n      }\r\n\r\n      if(this.quizTimer?.parentElement) {\r\n        this.quizTimer.remove();\r\n      }\r\n\r\n      const timeEl = this.descDiv.querySelector('.poll-time');\r\n      if(timeEl) {\r\n        timeEl.remove();\r\n      }\r\n    }\r\n\r\n    if(this.isClosed) {\r\n      this.classList.add('is-closed');\r\n      replaceContent(this.typeDiv, i18n('Chat.Poll.Type.Closed'));\r\n    }\r\n\r\n    // set chosen\r\n    if(this.chosenIndexes.length !== chosenIndexes.length || this.isClosed) { // if we voted\r\n      this.isRetracted = this.chosenIndexes.length && !chosenIndexes.length;\r\n      this.chosenIndexes = chosenIndexes.slice();\r\n\r\n      if(this.isRetracted) {\r\n        attachClickEvent(this, this.clickHandler);\r\n      } else {\r\n        detachClickEvent(this, this.clickHandler);\r\n      }\r\n    }\r\n    \r\n    // is need update\r\n    if(this.chosenIndexes.length || this.isRetracted || this.isClosed) {\r\n      const percents = results.results.map((v) => results.total_voters ? v.voters / results.total_voters * 100 : 0);\r\n\r\n      this.classList.toggle('no-transition', !animate);\r\n      if(animate) {\r\n        SetTransition(this, '', !this.isRetracted, 340);\r\n      }\r\n\r\n      fastRaf(() => {\r\n        this.setResults(this.isRetracted ? this.percents : percents, this.chosenIndexes, animate);\r\n        this.percents = percents;\r\n        this.isRetracted = false;\r\n      });\r\n    }\r\n    \r\n    this.setVotersCount(results);\r\n\r\n    if(this.isPublic) {\r\n      if(!this.isMultiple) {\r\n        this.viewResults.classList.toggle('hide', !results.total_voters || !this.chosenIndexes.length);\r\n        this.votersCountDiv.classList.toggle('hide', !!this.chosenIndexes.length);\r\n      }\r\n\r\n      const peerIds = (results.recent_voters || []).map((userId) => userId.toPeerId());\r\n      const stackedAvatars = new StackedAvatars({avatarSize: 16});\r\n      stackedAvatars.render(peerIds);\r\n      replaceContent(this.avatarsDiv, stackedAvatars.container);\r\n    }\r\n\r\n    if(this.isMultiple) {\r\n      const isVoted = !!this.chosenIndexes.length;\r\n\r\n      const hideSendVoteBtn = this.isClosed || isVoted;\r\n      const hideViewResultsBtn = !this.isPublic || !results.total_voters || (!isVoted && !this.isClosed);\r\n      this.sendVoteBtn.classList.toggle('hide', hideSendVoteBtn);\r\n      this.viewResults.classList.toggle('hide', hideViewResultsBtn);\r\n      this.votersCountDiv.classList.toggle('hide', !hideSendVoteBtn || !hideViewResultsBtn);\r\n    }\r\n  }\r\n\r\n  setResults(percents: number[], chosenIndexes: number[], animate: boolean) {\r\n    this.svgLines.forEach((svg) => svg.style.display = '');\r\n\r\n    this.answerDivs.forEach((el, idx) => {\r\n      el.classList.toggle('is-chosen', chosenIndexes.includes(idx));\r\n    });\r\n\r\n    const maxValue = Math.max(...percents);\r\n    // this.maxLengths = percents.map((p) => p / maxValue * this.maxLength);\r\n    this.maxPercents = percents.map((p) => p / maxValue);\r\n\r\n    // line\r\n    if(this.isRetracted) {\r\n      this.svgLines.forEach((svg, idx) => {\r\n        this.setLineProgress(idx, -1);\r\n      });\r\n    } else {\r\n      const cb = () => {\r\n        this.svgLines.forEach((svg, idx) => {\r\n          //void svg.getBoundingClientRect(); // reflow\r\n          this.setLineProgress(idx, 1);\r\n        });\r\n      };\r\n      \r\n      animate ? fastRaf(cb) : cb();\r\n    }\r\n\r\n    percents = percents.slice();\r\n    roundPercents(percents);\r\n    let getPercentValue: (percents: number, index: number) => number;\r\n    const iterate = (i: number) => {\r\n      percents.forEach((percents, idx) => {\r\n        const value = getPercentValue(percents, i);\r\n        this.numberDivs[idx].innerText = value + '%';\r\n      });\r\n    };\r\n    // numbers\r\n    if(this.isRetracted) {\r\n      getPercentValue = (percents, index) => Math.round(percents / times * index);\r\n\r\n      if(animate) {\r\n        for(let i = (times - 1), k = 0; i >= 0; --i, ++k) {\r\n          setTimeout(() => {\r\n            iterate(i);\r\n          }, oneTime * k);\r\n        }\r\n      } else {\r\n        iterate(0);\r\n      }\r\n    } else {\r\n      getPercentValue = (percents, index) => Math.round(percents / times * (index + 1));\r\n\r\n      if(animate) {\r\n        for(let i = 0; i < times; ++i) {\r\n          setTimeout(() => {\r\n            iterate(i);\r\n          }, oneTime * i);\r\n        }\r\n      } else {\r\n        iterate(times - 1);\r\n      }\r\n    }\r\n\r\n    if(this.isRetracted) {\r\n      if(animate) {\r\n        this.classList.add('is-retracting');\r\n      }\r\n\r\n      this.classList.remove('is-voted');\r\n      const cb = () => {\r\n        this.svgLines.forEach((svg) => svg.style.display = 'none');\r\n      };\r\n\r\n      if(animate) {\r\n        setTimeout(() => {\r\n          this.classList.remove('is-retracting');\r\n          cb();\r\n        }, fullTime);\r\n      } else {\r\n        cb();\r\n      }\r\n    } else {\r\n      this.classList.add('is-voted');\r\n    }\r\n  }\r\n\r\n  setVotersCount(results: PollResults) {\r\n    const votersCount = results.total_voters || 0;\r\n    let key: LangPackKey, args = [votersCount];\r\n    if(this.isClosed) {\r\n      if(this.isQuiz) key = votersCount ? 'Chat.Quiz.TotalVotes' : 'Chat.Quiz.TotalVotesResultEmpty';\r\n      else key = votersCount ? 'Chat.Poll.TotalVotes1' : 'Chat.Poll.TotalVotesResultEmpty';\r\n    } else {\r\n      if(this.isQuiz) key = votersCount ? 'Chat.Quiz.TotalVotes' : 'Chat.Quiz.TotalVotesEmpty';\r\n      else key = votersCount ? 'Chat.Poll.TotalVotes1' : 'Chat.Poll.TotalVotesEmpty';\r\n    }\r\n    \r\n    replaceContent(this.votersCountDiv, i18n(key, args));\r\n  }\r\n\r\n  setLineProgress(index: number, multiplier: number) {\r\n    const svg = this.svgLines[index];\r\n\r\n    if(multiplier === -1) {\r\n      svg.style.strokeDasharray = '';\r\n      svg.style.strokeDashoffset = '';\r\n    } else {\r\n      // svg.style.strokeDasharray = (multiplier * this.maxLengths[index]) + ', 485.9';\r\n      svg.style.strokeDasharray = (multiplier * this.maxPercents[index] * PollElement.MAX_LENGTH) + ', 485.9';\r\n      // svg.style.strokeDasharray = (multiplier * this.maxPercents[index] * 100) + '%, 485.9';\r\n      svg.style.strokeDashoffset = '' + multiplier * PollElement.MAX_OFFSET;\r\n    }\r\n  }\r\n\r\n  // у элемента могут быть ещё другие методы и свойства\r\n}\r\n\r\ncustomElements.define(\"poll-element\", PollElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class DivAndCaption<T> {\r\n  public container: HTMLElement;\r\n  public border: HTMLElement;\r\n  public content: HTMLElement;\r\n  public title: HTMLElement;\r\n  public subtitle: HTMLElement;\r\n\r\n  constructor(protected className: string, public fill?: T) {\r\n    this.container = document.createElement('div');\r\n    this.container.className = className;\r\n\r\n    this.border = document.createElement('div');\r\n    this.border.classList.add(className + '-border');\r\n    \r\n    this.content = document.createElement('div');\r\n    this.content.classList.add(className + '-content');\r\n\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add(className + '-title');\r\n    this.title.setAttribute('dir', 'auto');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add(className + '-subtitle');\r\n    this.subtitle.setAttribute('dir', 'auto');\r\n\r\n    this.content.append(this.title, this.subtitle);\r\n    this.container.append(this.border, this.content);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function htmlToDocumentFragment(html: string | DocumentFragment) {\r\n  if(html instanceof DocumentFragment) return html;\r\n  const template = document.createElement('template');\r\n  html = html.trim(); // Never return a text node of whitespace as the result\r\n  template.innerHTML = html;\r\n  return template.content;\r\n}\r\n","import { RestrictionReason } from \"../layer\";\r\n\r\nconst platforms = new Set([\r\n  'all',\r\n  'web',\r\n  'webk'\r\n]);\r\n\r\nconst ignore = new Set();\r\n\r\nexport function getRestrictionReason(reasons: RestrictionReason[]) {\r\n  // return reasons[0];\r\n  return reasons.find((reason) => platforms.has(reason.platform) && !ignore.has(reason.reason));\r\n}\r\n\r\nexport function isRestricted(reasons: RestrictionReason[]) {\r\n  return !!getRestrictionReason(reasons);\r\n}\r\n\r\nexport function ignoreRestrictionReasons(reasons: string[]) {\r\n  ignore.clear();\r\n  reasons.forEach((reason) => {\r\n    ignore.add(reason);\r\n  });\r\n}\r\n","// credits to https://github.com/sindresorhus/escape-string-regexp/blob/master/index.js\r\nexport default function escapeRegExp(str: string) {\r\n  return str\r\n    .replace(/[|\\\\{}()[\\]^$+*?.]/g, '\\\\$&')\r\n    .replace(/-/g, '\\\\x2d');\r\n}\r\n","import { isRestricted } from \"../../../../helpers/restrictions\";\r\nimport { Message } from \"../../../../layer\";\r\n\r\nexport default function isMessageRestricted(message: Message.message) {\r\n  return !!(message.restriction_reason && isRestricted(message.restriction_reason));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport I18n, { i18n, join, LangPackKey } from \"../lib/langPack\";\r\nimport formatDuration, { DurationType } from \"./formatDuration\";\r\n\r\nconst CALL_DURATION_LANG_KEYS: {[type in DurationType]: LangPackKey} = {\r\n  s: 'Seconds',\r\n  m: 'Minutes',\r\n  h: 'Hours',\r\n  d: 'Days',\r\n  w: 'Weeks'\r\n};\r\nexport default function formatCallDuration(duration: number, plain?: boolean) {\r\n  const a = formatDuration(duration, 2);\r\n  if(plain) {\r\n    const strings = a.map((d) => I18n.format(CALL_DURATION_LANG_KEYS[d.type], true, [d.duration]));\r\n    return join(strings, false, plain);\r\n  }\r\n\r\n  const elements = a.map((d) => i18n(CALL_DURATION_LANG_KEYS[d.type], [d.duration]));\r\n\r\n  const fragment = document.createElement('span');\r\n  fragment.append(...join(elements, false));\r\n\r\n  return fragment;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type DurationType = 's' | 'm' | 'h' | 'd' | 'w';\r\nexport default function formatDuration(duration: number, showLast = 2) {\r\n  if(!duration) {\r\n    duration = 1;\r\n  }\r\n\r\n  let d: {duration: number, type: DurationType}[] = [];\r\n  const p = [\r\n    {m: 1, t: 's'},\r\n    {m: 60, t: 'm'}, \r\n    {m: 60, t: 'h'}, \r\n    {m: 24, t: 'd'}, \r\n    {m: 7, t: 'w'}\r\n  ] as Array<{m?: number, t: DurationType}>\r\n  const s = 1;\r\n  let t = s;\r\n  p.forEach((o, idx) => {\r\n    t *= o.m;\r\n\r\n    if(duration < t) {\r\n      return;\r\n    }\r\n\r\n    const modulus = p[idx === (p.length - 1) ? idx : idx + 1].m;\r\n    d.push({\r\n      duration: (duration / t % modulus | 0),\r\n      type: o.t\r\n    });\r\n  });\r\n\r\n  const out = d.slice(-showLast).reverse();\r\n  for(let i = out.length - 1; i >= 0; --i) {\r\n    if(out[i].duration === 0) {\r\n      out.splice(i, 1);\r\n    }\r\n  }\r\n  \r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message, MessageAction } from \"../../layer\";\r\nimport wrapUrl from \"../../lib/richTextProcessor/wrapUrl\";\r\n\r\nexport default function wrapJoinVoiceChatAnchor(message: Message.messageService) {\r\n  const action = message.action as MessageAction.messageActionInviteToGroupCall;\r\n  const {onclick, url} = wrapUrl(`tg://voicechat?chat_id=${message.peerId.toChatId()}&id=${action.call.id}&access_hash=${action.call.access_hash}`);\r\n  if(!onclick) {\r\n    return document.createElement('span');\r\n  }\r\n  \r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.setAttribute('onclick', onclick + '(this)');\r\n\r\n  return a;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport wrapMessageActionTextNewUnsafe from \"./messageActionTextNewUnsafe\";\r\n\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain: true): Promise<string>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain?: false): Promise<HTMLElement>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain: boolean): Promise<HTMLElement | string>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain?: boolean): Promise<HTMLElement | string> {\r\n  try {\r\n    return await wrapMessageActionTextNewUnsafe(message, plain);\r\n  } catch(err) {\r\n    console.error('wrapMessageActionTextNewUnsafe error:', err);\r\n    return plain ? '' : document.createElement('span');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport { formatTime } from \"../../helpers/date\";\r\nimport htmlToSpan from \"../../helpers/dom/htmlToSpan\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport formatCallDuration from \"../../helpers/formatCallDuration\";\r\nimport { MessageAction } from \"../../layer\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport I18n, { FormatterArgument, FormatterArguments, i18n, join, langPack, LangPackKey, _i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport getPeerTitle from \"./getPeerTitle\";\r\nimport wrapJoinVoiceChatAnchor from \"./joinVoiceChatAnchor\";\r\nimport wrapMessageForReply from \"./messageForReply\";\r\n\r\nexport default async function wrapMessageActionTextNewUnsafe(message: MyMessage, plain?: boolean) {\r\n  const element: HTMLElement = plain ? undefined : document.createElement('span');\r\n  const action = 'action' in message && message.action;\r\n\r\n  // this.log('message action:', action);\r\n\r\n  if((action as MessageAction.messageActionCustomAction).message) {\r\n    const unsafeMessage = (action as MessageAction.messageActionCustomAction).message;\r\n    if(plain) {\r\n      return wrapPlainText(unsafeMessage);\r\n    } else {\r\n      setInnerHTML(element, wrapRichText(unsafeMessage, {noLinebreaks: true}));\r\n      return element;\r\n    }\r\n  } else {\r\n    let _ = action._;\r\n    //let suffix = '';\r\n    let langPackKey: LangPackKey;\r\n    let args: Array<FormatterArgument | Promise<FormatterArgument>>;\r\n\r\n    const managers = rootScope.managers;\r\n\r\n    const getNameDivHTML = async(peerId: PeerId, plain: boolean) => {\r\n      return plain ? getPeerTitle(peerId, plain) : (new PeerTitle({peerId})).element;\r\n    };\r\n\r\n    switch(action._) {\r\n      case 'messageActionPhoneCall': {\r\n        _ += '.' + (action as any).type;\r\n\r\n        args = [formatCallDuration(action.duration, plain)];\r\n        break;\r\n      }\r\n\r\n      case 'messageActionGroupCall': {\r\n        _ += '.' + (action as any).type;\r\n\r\n        args = [];\r\n        if(!_.endsWith('You') && !message.pFlags.post) {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        if(action.duration !== undefined) {\r\n          args.push(formatCallDuration(action.duration, plain));\r\n        } else {\r\n          args.push(wrapJoinVoiceChatAnchor(message as any));\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionInviteToGroupCall': {\r\n        const peerIds = [message.fromId, action.users[0].toPeerId()];\r\n        let a = 'Chat.Service.VoiceChatInvitation';\r\n        const myId = rootScope.myId;\r\n        if(peerIds[0] === myId) a += 'ByYou';\r\n        else if(peerIds[1] === myId) a += 'ForYou';\r\n        indexOfAndSplice(peerIds, myId);\r\n\r\n        langPackKey = a as LangPackKey;\r\n        args = peerIds.map((peerId) => getNameDivHTML(peerId, plain));\r\n        args.push(wrapJoinVoiceChatAnchor(message as any));\r\n        break;\r\n      }\r\n\r\n      case 'messageActionGroupCallScheduled': {\r\n        const today = new Date();\r\n        const date = new Date(action.schedule_date * 1000);\r\n        const daysToStart = (date.getTime() - today.getTime()) / 86400e3;\r\n        const tomorrowDate = new Date(today);\r\n        tomorrowDate.setDate(tomorrowDate.getDate() + 1);\r\n\r\n        const isBroadcast = await managers.appPeersManager.isBroadcast(message.peerId);\r\n        langPackKey = isBroadcast ? 'ChatList.Service.VoiceChatScheduled.Channel' : 'ChatList.Service.VoiceChatScheduled';\r\n        args = [];\r\n        const myId = rootScope.myId;\r\n        if(message.fromId === myId) {\r\n          langPackKey += 'You';\r\n        } else if(!isBroadcast) {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        let k: LangPackKey, _args: FormatterArguments = [];\r\n        if(daysToStart < 1 && date.getDate() === today.getDate()) {\r\n          k = 'TodayAtFormattedWithToday';\r\n        } else if(daysToStart < 2 && date.getDate() === tomorrowDate.getDate()) {\r\n          k = 'Time.TomorrowAt';\r\n        } else {\r\n          k = 'formatDateAtTime';\r\n          _args.push(new I18n.IntlDateElement({\r\n            date, \r\n            options: {\r\n              day: '2-digit',\r\n              month: '2-digit',\r\n              year: '2-digit'\r\n            }\r\n          }).element);\r\n        }\r\n\r\n        _args.push(formatTime(date));\r\n        const t = i18n(k, _args);\r\n        args.push(t);\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatCreate': {\r\n        const myId = rootScope.myId;\r\n        if(message.fromId === myId) {\r\n          _ += 'You';\r\n        } else {\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n        }\r\n        \r\n        break;\r\n      }\r\n\r\n      case 'messageActionPinMessage': {\r\n        const peerId = message.peerId;\r\n        const pinnedMessage = await managers.appMessagesManager.getMessageByPeer(peerId, message.reply_to_mid);\r\n\r\n        args = [\r\n          getNameDivHTML(message.fromId, plain),\r\n        ];\r\n        \r\n        if(!pinnedMessage/*  || true */) {\r\n          langPackKey = 'ActionPinnedNoText';\r\n\r\n          if(message.reply_to_mid) { // refresh original message\r\n            managers.appMessagesManager.fetchMessageReplyTo(message).then(async(originalMessage) => {\r\n              if(originalMessage && message) {\r\n                rootScope.dispatchEvent('message_edit', {\r\n                  storageKey: `${peerId}_history`,\r\n                  peerId: peerId,\r\n                  mid: message.mid,\r\n                  message\r\n                });\r\n\r\n                if(managers.appMessagesManager.isMessageIsTopMessage(message)) {\r\n                  rootScope.dispatchEvent('dialogs_multiupdate', {\r\n                    [peerId]: await managers.appMessagesManager.getDialogOnly(peerId)\r\n                  });\r\n                }\r\n              }\r\n            });\r\n          }\r\n        } else {\r\n          const a = document.createElement('i');\r\n          a.dataset.savedFrom = pinnedMessage.peerId + '_' + pinnedMessage.mid;\r\n          a.dir = 'auto';\r\n          a.append(await wrapMessageForReply(pinnedMessage, undefined, undefined, plain as any));\r\n          args.push(a);\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatJoinedByRequest': {\r\n        const isBroadcast = await managers.appPeersManager.isBroadcast(message.peerId);\r\n        if(message.pFlags.out) {\r\n          langPackKey = isBroadcast ? 'RequestToJoinChannelApproved' : 'RequestToJoinGroupApproved';\r\n        } else {\r\n          langPackKey = isBroadcast ? 'ChatService.UserJoinedChannelByRequest' : 'ChatService.UserJoinedGroupByRequest';\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n        }\r\n        break;\r\n      }\r\n\r\n      case 'messageActionContactSignUp':\r\n      case 'messageActionChatReturn':\r\n      case 'messageActionChatLeave':\r\n      case 'messageActionChatJoined':\r\n      case 'messageActionChatEditPhoto':\r\n      case 'messageActionChatDeletePhoto':\r\n      case 'messageActionChatEditVideo':\r\n      case 'messageActionChatJoinedByLink':\r\n      case 'messageActionChannelEditVideo':\r\n      case 'messageActionChannelDeletePhoto': {\r\n        args = [getNameDivHTML(message.fromId, plain)];\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChannelEditTitle':\r\n      case 'messageActionChatEditTitle': {\r\n        args = [];\r\n        if(action._ === 'messageActionChatEditTitle') {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        args.push(plain ? action.title : htmlToSpan(wrapEmojiText(action.title)));\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatDeleteUser':\r\n      case 'messageActionChatAddUsers':\r\n      case 'messageActionChatAddUser': {\r\n        const users = (action as MessageAction.messageActionChatAddUser).users \r\n          || [(action as MessageAction.messageActionChatDeleteUser).user_id];\r\n\r\n        args = [getNameDivHTML(message.fromId, plain)];\r\n\r\n        if(users.length > 1) {\r\n          const joined = join(\r\n            await Promise.all(users.map((userId: UserId) => getNameDivHTML(userId.toPeerId(), plain))),\r\n            false,\r\n            plain\r\n          );\r\n          \r\n          if(plain) {\r\n            args.push(...joined);\r\n          } else {\r\n            const fragment = document.createElement('span');\r\n            fragment.append(...joined);\r\n            args.push(fragment);\r\n          }\r\n        } else {\r\n          args.push(getNameDivHTML(users[0].toPeerId(), plain));\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionBotAllowed': {\r\n        const anchorHTML = wrapRichText(action.domain, {\r\n          entities: [{\r\n            _: 'messageEntityUrl',\r\n            length: action.domain.length,\r\n            offset: 0\r\n          }]\r\n        });\r\n\r\n        const node = htmlToSpan(anchorHTML);\r\n\r\n        args = [node];\r\n        break;\r\n      }\r\n\r\n      default:\r\n        langPackKey = (langPack[_] || `[${action._}]`) as any;\r\n        break;\r\n    }\r\n\r\n    if(!langPackKey) {\r\n      langPackKey = langPack[_];\r\n      if(langPackKey === undefined) {\r\n        langPackKey = '[' + _ + ']' as any;\r\n      }\r\n    }\r\n\r\n    const waited = args && await Promise.all(args);\r\n\r\n    if(plain) {\r\n      return I18n.format(langPackKey, true, waited);\r\n    } else {\r\n      return _i18n(element, langPackKey, waited);\r\n    }\r\n\r\n    //str = !langPackKey || langPackKey[0].toUpperCase() === langPackKey[0] ? langPackKey : getNameDivHTML(message.fromId) + langPackKey + (suffix ? ' ' : '');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport htmlToDocumentFragment from \"../../helpers/dom/htmlToDocumentFragment\";\r\nimport { getRestrictionReason } from \"../../helpers/restrictions\";\r\nimport escapeRegExp from \"../../helpers/string/escapeRegExp\";\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { Message, DocumentAttribute } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { MyDraftMessage } from \"../../lib/appManagers/appDraftsManager\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport isMessageRestricted from \"../../lib/appManagers/utils/messages/isMessageRestricted\";\r\nimport I18n, { LangPackKey, i18n, UNSUPPORTED_LANG_PACK_KEY } from \"../../lib/langPack\";\r\nimport sortEntities from \"../../lib/richTextProcessor/sortEntities\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport wrapMessageActionTextNew from \"./messageActionTextNew\";\r\n\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text: string, usingMids: number[], plain: true, highlightWord?: string, withoutMediaType?: boolean): Promise<string>;\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text?: string, usingMids?: number[], plain?: false, highlightWord?: string, withoutMediaType?: boolean): Promise<DocumentFragment>;\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text: string = (message as Message.message).message, usingMids?: number[], plain?: boolean, highlightWord?: string, withoutMediaType?: boolean): Promise<DocumentFragment | string> {\r\n  const parts: (Node | string)[] = [];\r\n\r\n  let hasAlbumKey = false;\r\n  const addPart = (langKey: LangPackKey, part?: string | HTMLElement | DocumentFragment) => {\r\n    if(langKey) {\r\n      if(part === undefined && hasAlbumKey) {\r\n        return;\r\n      }\r\n      \r\n      part = plain ? I18n.format(langKey, true) : i18n(langKey);\r\n    }\r\n    \r\n    if(plain) {\r\n      parts.push(part);\r\n    } else {\r\n      const el = document.createElement('i');\r\n      if(typeof(part) === 'string') el.innerHTML = part;\r\n      else el.append(part);\r\n      parts.push(el);\r\n    }\r\n  };\r\n\r\n  const managers = rootScope.managers;\r\n  const appMessagesManager = managers.appMessagesManager;\r\n\r\n  const isRestricted = isMessageRestricted(message as any);\r\n\r\n  let entities = (message as Message.message).totalEntities;\r\n  if((message as Message.message).media && !isRestricted) {\r\n    assumeType<Message.message>(message);\r\n    let usingFullAlbum = true;\r\n    if(message.grouped_id) {\r\n      if(usingMids) {\r\n        const mids = await appMessagesManager.getMidsByMessage(message);\r\n        if(usingMids.length === mids.length) {\r\n          for(const mid of mids) {\r\n            if(!usingMids.includes(mid)) {\r\n              usingFullAlbum = false;\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          usingFullAlbum = false;\r\n        }\r\n      }\r\n\r\n      if(usingFullAlbum) {\r\n        const albumText = await appMessagesManager.getAlbumText(message.grouped_id);\r\n        text = albumText.message;\r\n        entities = albumText.totalEntities;\r\n\r\n        if(!withoutMediaType) {\r\n          addPart('AttachAlbum');\r\n          hasAlbumKey = true;\r\n        }\r\n      }\r\n    } else {\r\n      usingFullAlbum = false;\r\n    }\r\n\r\n    if((!usingFullAlbum && !withoutMediaType) || !text) {\r\n      const media = message.media;\r\n      switch(media._) {\r\n        case 'messageMediaPhoto':\r\n          addPart('AttachPhoto');\r\n          break;\r\n        case 'messageMediaDice':\r\n          addPart(undefined, plain ? media.emoticon : wrapEmojiText(media.emoticon));\r\n          break;\r\n        case 'messageMediaVenue': {\r\n          text = media.title;\r\n          addPart('AttachLocation');\r\n          break;\r\n        }\r\n        case 'messageMediaGeo':\r\n          addPart('AttachLocation');\r\n          break;\r\n        case 'messageMediaGeoLive':\r\n          addPart('AttachLiveLocation');\r\n          break;\r\n        case 'messageMediaPoll':\r\n          const f = '📊' + ' ' + (media.poll.question || 'poll');\r\n          addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          break;\r\n        case 'messageMediaContact':\r\n          addPart('AttachContact');\r\n          break;\r\n        case 'messageMediaGame': {\r\n          const f = '🎮' + ' ' + media.game.title;\r\n          addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          break;\r\n        }\r\n        case 'messageMediaDocument': {\r\n          const document = media.document as MyDocument;\r\n\r\n          if(document.type === 'video') {\r\n            addPart('AttachVideo');\r\n          } else if(document.type === 'voice') {\r\n            addPart('AttachAudio');\r\n          } else if(document.type === 'gif') {\r\n            addPart('AttachGif');\r\n          } else if(document.type === 'round') {\r\n            addPart('AttachRound');\r\n          } else if(document.type === 'sticker') {\r\n            const i = parts.length;\r\n            if(document.stickerEmojiRaw) {\r\n              const f = document.stickerEmojiRaw + ' ';\r\n              addPart(undefined, plain ? f : wrapEmojiText(f));\r\n            }\r\n            \r\n            addPart('AttachSticker');\r\n\r\n            // will combine two parts into one\r\n            const p = parts.splice(i, 2);\r\n            if(plain) parts.push((p[0] as string) + (p[1] as string));\r\n            else {\r\n              const span = window.document.createElement('span');\r\n              span.append(...p);\r\n              parts.push(span);\r\n            }\r\n\r\n            text = '';\r\n          } else if(document.type === 'audio') {\r\n            const attribute = document.attributes.find((attribute) => attribute._ === 'documentAttributeAudio' && (attribute.title || attribute.performer)) as DocumentAttribute.documentAttributeAudio;\r\n            const f = '🎵' + ' ' + (attribute ? [attribute.title, attribute.performer].filter(Boolean).join(' - ') : document.file_name);\r\n            addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          } else {\r\n            addPart(undefined, plain ? document.file_name : wrapEmojiText(document.file_name));\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaUnsupported': {\r\n          addPart(UNSUPPORTED_LANG_PACK_KEY);\r\n          break;\r\n        }\r\n\r\n        default:\r\n          //messageText += media._;\r\n          ///////appMessagesManager.log.warn('Got unknown media type!', message);\r\n          break;\r\n      }\r\n    }\r\n\r\n    const length = parts.length;\r\n    for(let i = 1; i < length; i += 2) {\r\n      parts.splice(i, 0, ', ');\r\n    }\r\n\r\n    if(text && length) {\r\n      parts.push(', ');\r\n    }\r\n  }\r\n\r\n  if((message as Message.messageService).action) {\r\n    const actionWrapped = await wrapMessageActionTextNew((message as Message.messageService), plain);\r\n    if(actionWrapped) {\r\n      addPart(undefined, actionWrapped);\r\n    }\r\n  }\r\n\r\n  if(isRestricted) {\r\n    text = getRestrictionReason((message as Message.message).restriction_reason).text;\r\n    entities = [];\r\n  }\r\n\r\n  if(text) {\r\n    text = limitSymbols(text, 100);\r\n\r\n    if(!entities) {\r\n      entities = [];\r\n    }\r\n\r\n    if(plain) {\r\n      parts.push(wrapPlainText(text, entities));\r\n    } else {\r\n      // let entities = parseEntities(text.replace(/\\n/g, ' '));\r\n\r\n      if(highlightWord) {\r\n        highlightWord = highlightWord.trim();\r\n        let found = false;\r\n        let match: any;\r\n        let regExp = new RegExp(escapeRegExp(highlightWord), 'gi');\r\n        entities = entities.slice(); // fix leaving highlight entity\r\n        while((match = regExp.exec(text)) !== null) {\r\n          entities.push({_: 'messageEntityHighlight', length: highlightWord.length, offset: match.index});\r\n          found = true;\r\n        }\r\n    \r\n        if(found) {\r\n          sortEntities(entities);\r\n        }\r\n      }\r\n\r\n      const messageWrapped = wrapRichText(text, {\r\n        noLinebreaks: true, \r\n        entities, \r\n        noLinks: true,\r\n        noTextFormat: true\r\n      });\r\n\r\n      parts.push(htmlToDocumentFragment(messageWrapped));\r\n    }\r\n  }\r\n\r\n  if(plain) {\r\n    return parts.join('');\r\n  } else {\r\n    const fragment = document.createDocumentFragment();\r\n    fragment.append(...parts);\r\n    return fragment;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport appImManager, { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport { wrapPhoto, wrapSticker } from \"../wrappers\";\r\nimport wrapMessageForReply from \"../wrappers/messageForReply\";\r\n\r\nconst MEDIA_SIZE = 32;\r\n\r\nexport async function wrapReplyDivAndCaption(options: {\r\n  title: string | HTMLElement | DocumentFragment,\r\n  titleEl: HTMLElement,\r\n  subtitle: string | HTMLElement | DocumentFragment,\r\n  subtitleEl: HTMLElement,\r\n  message: any,\r\n  mediaEl: HTMLElement,\r\n  loadPromises?: Promise<any>[]\r\n}) {\r\n  let {title, titleEl, subtitle, subtitleEl, mediaEl, message, loadPromises} = options;\r\n  if(title !== undefined) {\r\n    if(typeof(title) === 'string') {\r\n      title = limitSymbols(title, 140);\r\n      title = wrapEmojiText(title);\r\n    }\r\n\r\n    replaceContent(titleEl, title);\r\n  }\r\n\r\n  if(!loadPromises) {\r\n    loadPromises = [];\r\n  }\r\n\r\n  let media = message && message.media;\r\n  let setMedia = false, isRound = false;\r\n  const mediaChildren = mediaEl ? Array.from(mediaEl.children).slice() : [];\r\n  let middleware: () => boolean;\r\n  if(media && mediaEl) {\r\n    subtitleEl.textContent = '';\r\n    subtitleEl.append(await wrapMessageForReply(message, undefined, undefined, undefined, undefined, true));\r\n\r\n    //console.log('wrap reply', media);\r\n\r\n    if(media.webpage) {\r\n      media = media.webpage;\r\n    }\r\n    \r\n    if(media.photo || (media.document && media.document.thumbs?.length)/* ['video', 'sticker', 'gif', 'round', 'photo', 'audio'].indexOf(media.document.type) !== -1) */) {\r\n      middleware = appImManager.chat.bubbles.getMiddleware();\r\n      const lazyLoadQueue = appImManager.chat.bubbles.lazyLoadQueue;\r\n\r\n      if(media.document?.type === 'sticker') {\r\n        setMedia = true;\r\n        await wrapSticker({\r\n          doc: media.document,\r\n          div: mediaEl,\r\n          lazyLoadQueue,\r\n          group: CHAT_ANIMATION_GROUP,\r\n          //onlyThumb: media.document.sticker === 2,\r\n          width: MEDIA_SIZE,\r\n          height: MEDIA_SIZE,\r\n          middleware,\r\n          loadPromises\r\n        });\r\n      } else {\r\n        const photo = media.photo || media.document;\r\n\r\n        isRound = photo.type === 'round';\r\n\r\n        try {\r\n          await wrapPhoto({\r\n            photo,\r\n            container: mediaEl,\r\n            boxWidth: MEDIA_SIZE,\r\n            boxHeight: MEDIA_SIZE,\r\n            size: choosePhotoSize(photo, MEDIA_SIZE, MEDIA_SIZE),\r\n            middleware,\r\n            lazyLoadQueue,\r\n            noBlur: true,\r\n            withoutPreloader: true,\r\n            loadPromises\r\n          });\r\n          setMedia = true;\r\n        } catch(err) {\r\n\r\n        }\r\n      }\r\n    }\r\n  } else {\r\n    if(message) {\r\n      subtitleEl.textContent = '';\r\n      subtitleEl.append(await wrapMessageForReply(message));\r\n    } else {\r\n      if(typeof(subtitle) === 'string') {\r\n        subtitle = limitSymbols(subtitle, 140);\r\n        subtitle = wrapEmojiText(subtitle);\r\n      }\r\n\r\n      replaceContent(subtitleEl, subtitle || '');\r\n    }\r\n  }\r\n\r\n  Promise.all(loadPromises).then(() => {\r\n    if(middleware && !middleware()) return;\r\n    mediaChildren.forEach((child) => child.remove());\r\n\r\n    if(mediaEl) {\r\n      mediaEl.classList.toggle('is-round', isRound);\r\n    }\r\n  });\r\n\r\n  return setMedia;\r\n}\r\n\r\nexport default class ReplyContainer extends DivAndCaption<(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message?: any) => Promise<void>> {\r\n  private mediaEl: HTMLElement;\r\n\r\n  constructor(protected className: string) {\r\n    super(className, async(title, subtitle = '', message?) => {\r\n      if(!this.mediaEl) {\r\n        this.mediaEl = document.createElement('div');\r\n        this.mediaEl.classList.add(this.className + '-media');\r\n      }\r\n\r\n      const isMediaSet = await wrapReplyDivAndCaption({\r\n        title,\r\n        titleEl: this.title,\r\n        subtitle,\r\n        subtitleEl: this.subtitle,\r\n        mediaEl: this.mediaEl,\r\n        message\r\n      });\r\n      \r\n      this.container.classList.toggle('is-media', isMediaSet);\r\n      if(isMediaSet) {\r\n        this.content.prepend(this.mediaEl);\r\n      } else {\r\n        this.mediaEl.remove();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { hexToRgb } from \"../../helpers/color\";\r\nimport { Message } from \"../../layer\";\r\nimport getPeerColorById from \"../../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport ReplyContainer from \"../chat/replyContainer\";\r\n\r\nexport default function wrapReply(\r\n  title: Parameters<ReplyContainer['fill']>[0], \r\n  subtitle: Parameters<ReplyContainer['fill']>[1], \r\n  message?: Message.message | Message.messageService,\r\n  setColorPeerId?: PeerId\r\n) {\r\n  const replyContainer = new ReplyContainer('reply');\r\n  const fillPromise = replyContainer.fill(title, subtitle, message);\r\n\r\n  if(setColorPeerId) {\r\n    const hex = getPeerColorById(setColorPeerId, false);\r\n    const [r, g, b] = hexToRgb(hex);\r\n    replyContainer.container.style.setProperty('--override-color', `${r}, ${g}, ${b}`);\r\n    replyContainer.container.classList.add('is-overriding-color');\r\n    // replyContainer.border.style.backgroundColor = hex;\r\n    // replyContainer.title.style.color = hex;\r\n  }\r\n\r\n  return {container: replyContainer.container, fillPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport { StickerSet } from \"../../layer\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default async function wrapStickerSetThumb({set, lazyLoadQueue, container, group, autoplay, width, height, managers = rootScope.managers}: {\r\n  set: StickerSet.stickerSet,\r\n  lazyLoadQueue: LazyLoadQueue,\r\n  container: HTMLElement,\r\n  group: string,\r\n  autoplay: boolean,\r\n  width: number,\r\n  height: number,\r\n  managers?: AppManagers\r\n}) {\r\n  if(set.thumbs?.length) {\r\n    container.classList.add('media-sticker-wrapper');\r\n    lazyLoadQueue.push({\r\n      div: container,\r\n      load: async() => {\r\n        const downloadOptions = await managers.appStickersManager.getStickerSetThumbDownloadOptions(set);\r\n        const promise = appDownloadManager.download(downloadOptions);\r\n\r\n        if(set.pFlags.animated && !set.pFlags.videos) {\r\n          return promise\r\n          .then((blob) => {\r\n            lottieLoader.loadAnimationWorker({\r\n              container,\r\n              loop: true,\r\n              autoplay,\r\n              animationData: blob,\r\n              width,\r\n              height,\r\n              needUpscale: true,\r\n              name: 'setThumb' + set.id\r\n            }, group);\r\n          });\r\n        } else {\r\n          let media: HTMLElement;\r\n          if(set.pFlags.videos) {\r\n            media = createVideo();\r\n            (media as HTMLVideoElement).autoplay = true;\r\n            (media as HTMLVideoElement).muted = true;\r\n            (media as HTMLVideoElement).loop = true;\r\n          } else {\r\n            media = new Image();\r\n          }\r\n\r\n          media.classList.add('media-sticker');\r\n  \r\n          return promise.then((blob) => {\r\n            renderImageFromUrl(media, URL.createObjectURL(blob), () => {\r\n              container.append(media);\r\n            });\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    return;\r\n  }\r\n\r\n  const promise = managers.appStickersManager.getStickerSet(set);\r\n  const stickerSet = await promise;\r\n  if(stickerSet.documents[0]._ !== 'documentEmpty') { // as thumb will be used first sticker\r\n    wrapSticker({\r\n      doc: stickerSet.documents[0],\r\n      div: container, \r\n      group: group,\r\n      lazyLoadQueue,\r\n      managers\r\n    }); // kostil\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport Row from \"../row\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default function wrapStickerToRow({doc, row, size, managers}: {\r\n  doc: MyDocument,\r\n  row: Row,\r\n  size?: 'small' | 'large',\r\n  managers?: AppManagers\r\n}) {\r\n  const previousMedia = row.media;\r\n  const media = row.createMedia('small');\r\n\r\n  if(previousMedia) {\r\n    media.classList.add('hide');\r\n  }\r\n\r\n  const loadPromises: Promise<any>[] = previousMedia ? [] : undefined;\r\n\r\n  const _size = size === 'small' ? 32 : 48;\r\n  const result = wrapSticker({\r\n    div: media,\r\n    doc: doc,\r\n    width: _size,\r\n    height: _size,\r\n    loadPromises,\r\n    managers\r\n  }).then(({render}) => render);\r\n\r\n  loadPromises && Promise.all(loadPromises).then(() => {\r\n    media.classList.remove('hide');\r\n    previousMedia.remove();\r\n  });\r\n\r\n  return result;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport whichChild from \"./whichChild\";\r\n\r\nexport default function positionElementByIndex(element: HTMLElement, container: HTMLElement, pos: number, prevPos?: number) {\r\n  if(prevPos === undefined) {\r\n    prevPos = element.parentElement === container ? whichChild(element) : -1;\r\n  }\r\n\r\n  if(prevPos === pos) {\r\n    return false;\r\n  } else if(prevPos !== -1 && prevPos < pos) { // was higher\r\n    pos += 1;\r\n  }\r\n\r\n  if(!pos) {\r\n    container.prepend(element);\r\n  } else if(container.childElementCount > pos) {\r\n    container.insertBefore(element, container.children[pos]);\r\n  } else {\r\n    container.append(element);\r\n  }\r\n\r\n  return true;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport insertInDescendSortedArray from \"./array/insertInDescendSortedArray\";\r\nimport { getMiddleware } from \"./middleware\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport type SortedElementId = PeerId;\r\nexport type SortedElementBase = {\r\n  id: SortedElementId, \r\n  index: number\r\n};\r\n\r\nexport default class SortedList<SortedElement extends SortedElementBase> {\r\n  protected elements: Map<SortedElementId, SortedElement>;\r\n  protected sorted: Array<SortedElement>;\r\n\r\n  protected getIndex: (element: SortedElement) => PromiseLike<number> | number;\r\n  protected onDelete: (element: SortedElement) => void;\r\n  protected onUpdate: (element: SortedElement) => void;\r\n  protected onSort: (element: SortedElement, idx: number) => void;\r\n  protected onElementCreate: (base: SortedElementBase, batch: boolean) => SortedElement;\r\n\r\n  protected updateElementWith = (callback: () => void) => callback();\r\n  protected updateListWith = (callback: (canUpdate: boolean | undefined) => void) => callback(true);\r\n\r\n  protected middleware = getMiddleware();\r\n\r\n  constructor(options: {\r\n    getIndex: SortedList<SortedElement>['getIndex'],\r\n    onDelete?: SortedList<SortedElement>['onDelete'],\r\n    onUpdate?: SortedList<SortedElement>['onUpdate'],\r\n    onSort?: SortedList<SortedElement>['onSort'],\r\n    onElementCreate: SortedList<SortedElement>['onElementCreate'],\r\n\r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith'],\r\n    updateListWith?: SortedList<SortedElement>['updateListWith']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.elements = new Map();\r\n    this.sorted = [];\r\n  }\r\n\r\n  public clear() {\r\n    this.middleware.clean();\r\n    this.elements.clear();\r\n    this.sorted.length = 0;\r\n  }\r\n\r\n  protected _updateList() {\r\n    this.elements.forEach((element) => {\r\n      this.update(element.id, true);\r\n    });\r\n\r\n    if(this.onSort) {\r\n      this.sorted.forEach((element, idx) => {\r\n        this.onSort(element, idx);\r\n      });\r\n    }\r\n  }\r\n\r\n  public updateList(callback: (updated: boolean) => void) {\r\n    const middleware = this.middleware.get();\r\n    this.updateListWith((canUpdate) => {\r\n      if(!middleware() || (canUpdate !== undefined && !canUpdate)) {\r\n        return callback(false);\r\n      }\r\n\r\n      this._updateList();\r\n  \r\n      callback(true);\r\n    });\r\n  }\r\n\r\n  public has(id: SortedElementId) {\r\n    return this.elements.has(id);\r\n  }\r\n\r\n  public get(id: SortedElementId) {\r\n    return this.elements.get(id);\r\n  }\r\n\r\n  public getAll() {\r\n    return this.elements;\r\n  }\r\n\r\n  public add(\r\n    id: SortedElementId, \r\n    batch = false, \r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith'], \r\n    updateBatch = batch\r\n  ) {\r\n    let element = this.get(id);\r\n    if(element) {\r\n      return element;\r\n    }\r\n\r\n    const base: SortedElementBase = {\r\n      id,\r\n      index: 0\r\n    };\r\n\r\n    element = this.onElementCreate(base, batch);\r\n    this.elements.set(id, element);\r\n    this.update(id, updateBatch, element, updateElementWith);\r\n\r\n    return element;\r\n  }\r\n\r\n  public delete(id: SortedElementId, noScheduler?: boolean) {\r\n    const element = this.elements.get(id);\r\n    if(!element) {\r\n      return false;\r\n    }\r\n    \r\n    this.elements.delete(id);\r\n    \r\n    const idx = this.sorted.indexOf(element);\r\n    if(idx !== -1) {\r\n      this.sorted.splice(idx, 1);\r\n    }\r\n\r\n    if(this.onDelete) {\r\n      if(noScheduler) {\r\n        this.onDelete(element);\r\n      } else {\r\n        const middleware = this.middleware.get();\r\n        this.updateElementWith(() => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n\r\n          this.onDelete(element);\r\n        });\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public async update(\r\n    id: SortedElementId, \r\n    batch = false, \r\n    element = this.get(id), \r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith']\r\n  ) {\r\n    if(!element) {\r\n      return;\r\n    }\r\n\r\n    element.index = await this.getIndex(element);\r\n    this.onUpdate && this.onUpdate(element);\r\n\r\n    const idx = insertInDescendSortedArray(this.sorted, element, 'index');\r\n    if(!batch && this.onSort) {\r\n      const middleware = this.middleware.get();\r\n      (updateElementWith || this.updateElementWith)(() => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        // * в случае пересортировки этого же элемента во время ожидания вызовется вторая такая же. нужно соблюдать последовательность событий\r\n        this.onSort(element, idx);\r\n        /* if(this.get(id) === element) {\r\n          this.onSort(element, this.sorted.indexOf(element));\r\n        } */\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { AppDialogsManager, DialogDom } from \"../lib/appManagers/appDialogsManager\";\r\nimport { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\nimport positionElementByIndex from \"../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport SortedList, { SortedElementBase } from \"../helpers/sortedList\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\n\r\ninterface SortedUser extends SortedElementBase {\r\n  dom: DialogDom\r\n}\r\n\r\nexport default class SortedUserList extends SortedList<SortedUser> {\r\n  protected static SORT_INTERVAL = 30e3;\r\n  public list: HTMLUListElement;\r\n  \r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected avatarSize = 48;\r\n  protected rippleEnabled = true;\r\n  protected autonomous = true;\r\n  protected createChatListOptions: Parameters<AppDialogsManager['createChatList']>[0];\r\n  protected onListLengthChange: () => void;\r\n  protected getIndex: (element: SortedUser) => number;\r\n  protected onUpdate: (element: SortedUser) => void;\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: Partial<{\r\n    lazyLoadQueue: SortedUserList['lazyLoadQueue'],\r\n    avatarSize: SortedUserList['avatarSize'],\r\n    rippleEnabled: SortedUserList['rippleEnabled'],\r\n    createChatListOptions: SortedUserList['createChatListOptions'],\r\n    autonomous: SortedUserList['autonomous'],\r\n    onListLengthChange: SortedUserList['onListLengthChange'],\r\n    getIndex: SortedUserList['getIndex'],\r\n    onUpdate: SortedUserList['onUpdate']\r\n  }> & {\r\n    managers: SortedUserList['managers']\r\n  }) {\r\n    super({\r\n      getIndex: options.getIndex || ((element) => this.managers.appUsersManager.getUserStatusForSort(element.id)),\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onListLengthChange && this.onListLengthChange();\r\n      },\r\n      onUpdate: options.onUpdate || (async(element) => {\r\n        const status = getUserStatusString(await this.managers.appUsersManager.getUser(element.id));\r\n        replaceContent(element.dom.lastMessageSpan, status);\r\n      }),\r\n      onSort: (element, idx) => {\r\n        const willChangeLength = element.dom.listEl.parentElement !== this.list;\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n\r\n        if(willChangeLength && this.onListLengthChange) {\r\n          this.onListLengthChange();\r\n        }\r\n      },\r\n      onElementCreate: (base) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: base.id,\r\n          container: false,\r\n          avatarSize: this.avatarSize,\r\n          autonomous: this.autonomous,\r\n          meAsSaved: false,\r\n          rippleEnabled: this.rippleEnabled,\r\n          lazyLoadQueue: this.lazyLoadQueue\r\n        });\r\n\r\n        (base as SortedUser).dom = dom;\r\n        return base as SortedUser;\r\n      },\r\n      updateElementWith: fastRaf,\r\n      updateListWith: async(callback) => {\r\n        if(!isInDOM(this.list)) {\r\n          return callback(false);\r\n        }\r\n    \r\n        await getHeavyAnimationPromise();\r\n    \r\n        if(!isInDOM(this.list)) {\r\n          return callback(false);\r\n        }\r\n\r\n        callback(true);\r\n      }\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.list = appDialogsManager.createChatList(this.createChatListOptions);\r\n\r\n    let timeout: number;\r\n    const doTimeout = () => {\r\n      timeout = window.setTimeout(() => {\r\n        this.updateList((good) => {\r\n          if(good) {\r\n            doTimeout();\r\n          }\r\n        });\r\n      }, SortedUserList.SORT_INTERVAL);\r\n    };\r\n\r\n    doTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_APPLE } from \"../../environment/userAgent\";\r\nimport contextMenuController from \"../contextMenuController\";\r\nimport ListenerSetter from \"../listenerSetter\";\r\nimport cancelEvent from \"./cancelEvent\";\r\n\r\nlet _cancelContextMenuOpening = false, _cancelContextMenuOpeningTimeout = 0;\r\nexport function cancelContextMenuOpening() {\r\n  if(_cancelContextMenuOpeningTimeout) {\r\n    clearTimeout(_cancelContextMenuOpeningTimeout);\r\n  }\r\n    \r\n  _cancelContextMenuOpeningTimeout = window.setTimeout(() => {\r\n    _cancelContextMenuOpeningTimeout = 0;\r\n    _cancelContextMenuOpening = false;\r\n  }, .4e3);\r\n\r\n  _cancelContextMenuOpening = true;\r\n}\r\n\r\nexport function attachContextMenuListener(element: HTMLElement, callback: (e: Touch | MouseEvent) => void, listenerSetter?: ListenerSetter) {\r\n  const add = listenerSetter ? listenerSetter.add(element) : element.addEventListener.bind(element);\r\n  const remove = listenerSetter ? listenerSetter.removeManual.bind(listenerSetter, element) : element.removeEventListener.bind(element);\r\n\r\n  if(IS_APPLE && IS_TOUCH_SUPPORTED) {\r\n    let timeout: number;\r\n\r\n    const options: EventListenerOptions = {capture: true};\r\n\r\n    const onCancel = () => {\r\n      clearTimeout(timeout);\r\n      // @ts-ignore\r\n      remove('touchmove', onCancel, options);\r\n      // @ts-ignore\r\n      remove('touchend', onCancel, options);\r\n      // @ts-ignore\r\n      remove('touchcancel', onCancel, options);\r\n    };\r\n\r\n    add('touchstart', (e: TouchEvent) => {\r\n      if(e.touches.length > 1) {\r\n        onCancel();\r\n        return;\r\n      }\r\n  \r\n      add('touchmove', onCancel, options);\r\n      add('touchend', onCancel, options);\r\n      add('touchcancel', onCancel, options);\r\n\r\n      timeout = window.setTimeout(() => {\r\n        if(_cancelContextMenuOpening) {\r\n          onCancel();\r\n          return;\r\n        }\r\n\r\n        callback(e.touches[0]);\r\n        onCancel();\r\n\r\n        if(contextMenuController.isOpened()) {\r\n          element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n        }\r\n      }, .4e3);\r\n    });\r\n\r\n    /* if(!isSafari) {\r\n      add('contextmenu', (e: any) => {\r\n        cancelEvent(e);\r\n      }, {passive: false, capture: true});\r\n    } */\r\n  } else {\r\n    add('contextmenu', IS_TOUCH_SUPPORTED ? (e: any) => {\r\n      callback(e);\r\n\r\n      if(contextMenuController.isOpened()) {\r\n        element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n      }\r\n    } : callback);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SwipeHandler, { SwipeHandlerOptions } from \"../../components/swipeHandler\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport findUpClassName from \"./findUpClassName\";\r\nimport isSwipingBackSafari from \"./isSwipingBackSafari\";\r\n\r\nexport type SwipeHandlerHorizontalOptions = SwipeHandlerOptions & {\r\n  // xThreshold?: number\r\n};\r\n\r\nexport default function handleHorizontalSwipe(options: SwipeHandlerHorizontalOptions) {\r\n  let cancelY = false;\r\n  return new SwipeHandler({\r\n    ...options,\r\n    verifyTouchTarget: (e) => {\r\n      return !findUpClassName(e.target, 'progress-line') && \r\n        !isSwipingBackSafari(e) && \r\n        (options.verifyTouchTarget ? options.verifyTouchTarget(e) : true);\r\n    },\r\n    onSwipe: (xDiff, yDiff, e) => {\r\n      if(!cancelY && Math.abs(yDiff) > 20) {\r\n        return true;\r\n      }\r\n\r\n      if(Math.abs(xDiff) > Math.abs(yDiff)) {\r\n        cancelEvent(e);\r\n        cancelY = true;\r\n      } else if(!cancelY && Math.abs(yDiff) > Math.abs(xDiff)/*  || Math.abs(yDiff) > 20 */) {\r\n        return true;\r\n      }\r\n\r\n      /* if(!cancelY && options.xThreshold !== undefined && xDiff >= options.xThreshold) {\r\n        cancelY = true;\r\n      } */\r\n\r\n      return options.onSwipe(xDiff, yDiff, e);\r\n    },\r\n    onReset: () => {\r\n      cancelY = false;\r\n      options.onReset && options.onReset();\r\n    },\r\n    cancelEvent: false // cannot use cancelEvent on Safari iOS because scroll will be canceled too\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { cancelContextMenuOpening } from \"./attachContextMenuListener\";\r\nimport handleHorizontalSwipe, { SwipeHandlerHorizontalOptions } from \"./handleHorizontalSwipe\";\r\n\r\nexport default function handleTabSwipe(options: SwipeHandlerHorizontalOptions) {\r\n  return handleHorizontalSwipe({\r\n    ...options,\r\n    onSwipe: (xDiff, yDiff, e) => {\r\n      if(Math.abs(xDiff) > 50) {\r\n        options.onSwipe(xDiff, yDiff, e);\r\n        cancelContextMenuOpening();\r\n\r\n        return true;\r\n      }\r\n    }\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { AttachClickOptions, attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../lib/langPack\";\r\nimport CheckboxField from \"./checkboxField\";\r\n\r\nexport type ButtonMenuItemOptions = {\r\n  icon?: string, \r\n  text?: LangPackKey, \r\n  textArgs?: FormatterArguments,\r\n  regularText?: string, \r\n  onClick: (e: MouseEvent | TouchEvent) => void | boolean | any, \r\n  element?: HTMLElement,\r\n  textElement?: HTMLElement,\r\n  options?: AttachClickOptions,\r\n  checkboxField?: CheckboxField,\r\n  noCheckboxClickListener?: boolean,\r\n  keepOpen?: boolean\r\n  /* , cancelEvent?: true */\r\n};\r\n\r\nconst ButtonMenuItem = (options: ButtonMenuItemOptions) => {\r\n  if(options.element) return options.element;\r\n\r\n  const {icon, text, onClick, checkboxField, noCheckboxClickListener} = options;\r\n  const el = document.createElement('div');\r\n  el.className = 'btn-menu-item rp-overflow' + (icon ? ' tgico-' + icon : '');\r\n  // ripple(el);\r\n\r\n  let textElement = options.textElement;\r\n  if(!textElement) {\r\n    textElement = options.textElement = text ? i18n(text, options.textArgs) : document.createElement('span');\r\n    if(options.regularText) textElement.innerHTML = options.regularText;\r\n  }\r\n  \r\n  textElement.classList.add('btn-menu-item-text');\r\n  el.append(textElement);\r\n\r\n  const keepOpen = !!checkboxField || !!options.keepOpen;\r\n\r\n  // * cancel mobile keyboard close\r\n  onClick && attachClickEvent(el, /* CLICK_EVENT_NAME !== 'click' || keepOpen ? */ (e) => {\r\n    cancelEvent(e);\r\n\r\n    const menu = findUpClassName(e.target, 'btn-menu');\r\n    if(menu && !menu.classList.contains('active')) {\r\n      return;\r\n    }\r\n    \r\n    const result = onClick(e);\r\n\r\n    if(result === false) {\r\n      return;\r\n    }\r\n\r\n    if(!keepOpen) {\r\n      contextMenuController.closeBtnMenu();\r\n    }\r\n\r\n    if(checkboxField && !noCheckboxClickListener/*  && result !== false */) {\r\n      checkboxField.checked = checkboxField.input.type === 'radio' ? true : !checkboxField.checked;\r\n    }\r\n  }/*  : onClick */, options.options);\r\n\r\n  if(checkboxField) {\r\n    el.append(checkboxField.label);\r\n  }\r\n\r\n  return options.element = el;\r\n};\r\n\r\nconst ButtonMenu = (buttons: ButtonMenuItemOptions[], listenerSetter?: ListenerSetter) => {\r\n  const el = document.createElement('div');\r\n  el.classList.add('btn-menu');\r\n\r\n  if(listenerSetter) {\r\n    buttons.forEach((b) => {\r\n      if(b.options) {\r\n        b.options.listenerSetter = listenerSetter;\r\n      } else {\r\n        b.options = {listenerSetter};\r\n      }\r\n    });\r\n  }\r\n\r\n  const items = buttons.map(ButtonMenuItem);\r\n\r\n  el.append(...items);\r\n\r\n  return el;\r\n};\r\n\r\nexport default ButtonMenu;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport PopupPickUser from \"./pickUser\";\r\n\r\nexport default class PopupForward extends PopupPickUser {\r\n  constructor(\r\n    peerIdMids: {[fromPeerId: PeerId]: number[]}, \r\n    onSelect?: (peerId: PeerId) => Promise<void> | void, \r\n    overrideOnSelect = false\r\n  ) {\r\n    super({\r\n      peerTypes: ['dialogs', 'contacts'],\r\n      onSelect: overrideOnSelect ? onSelect : async(peerId) => {\r\n        if(onSelect) {\r\n          const res = onSelect(peerId);\r\n          if(res instanceof Promise) {\r\n            await res;\r\n          }\r\n        }\r\n\r\n        appImManager.setInnerPeer({peerId});\r\n        appImManager.chat.input.initMessagesForward(peerIdMids);\r\n      },\r\n      placeholder: 'ShareModal.Search.ForwardPlaceholder',\r\n      chatRightsAction: 'send_messages',\r\n      selfPresence: 'ChatYourSelf'\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\nimport { ChatType } from \"../chat/chat\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport hasRights from \"../../lib/appManagers/utils/chats/hasRights\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\n\r\nexport default class PopupDeleteMessages {\r\n  constructor(private peerId: PeerId, private mids: number[], private type: ChatType, private onConfirm?: () => void) {\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    let {peerId, mids, type, onConfirm} = this;\r\n\r\n    const peerTitleElement = new PeerTitle({peerId}).element;\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n\r\n    mids = mids.slice();\r\n    const callback = (checked: PopupPeerButtonCallbackCheckboxes, revoke?: boolean) => {\r\n      onConfirm && onConfirm();\r\n      if(type === 'scheduled') {\r\n        managers.appMessagesManager.deleteScheduledMessages(peerId, mids);\r\n      } else {\r\n        managers.appMessagesManager.deleteMessages(peerId, mids, !!checked.size || revoke);\r\n      }\r\n    };\r\n\r\n    let title: LangPackKey, titleArgs: any[], description: LangPackKey, descriptionArgs: any[], buttons: PopupPeerOptions['buttons'], checkboxes: PopupPeerOptions['checkboxes'] = [];\r\n    if(mids.length === 1) {\r\n      title = 'DeleteSingleMessagesTitle';\r\n    } else {\r\n      title = 'DeleteMessagesTitle';\r\n      titleArgs = [i18n('messages', [mids.length])];\r\n    }\r\n    \r\n    if(await managers.appPeersManager.isMegagroup(peerId)) {\r\n      description = mids.length === 1 ? 'AreYouSureDeleteSingleMessageMega' : 'AreYouSureDeleteFewMessagesMega';\r\n    } else {\r\n      description = mids.length === 1 ? 'AreYouSureDeleteSingleMessage' : 'AreYouSureDeleteFewMessages';\r\n    }\r\n\r\n    buttons = [{\r\n      langKey: 'Delete',\r\n      isDanger: true,\r\n      callback\r\n    }];\r\n\r\n    if(peerId === rootScope.myId || type === 'scheduled') {\r\n      \r\n    } else {\r\n      if(peerId.isUser()) {\r\n        checkboxes.push({\r\n          text: 'DeleteMessagesOptionAlso',\r\n          textArgs: [peerTitleElement]\r\n        });\r\n      } else {\r\n        const chat = await managers.appChatsManager.getChat(peerId.toChatId());\r\n\r\n        const _hasRights = hasRights(chat, 'delete_messages');\r\n        if(chat._ === 'chat') {\r\n          const canRevoke = _hasRights ? mids.slice() : await filterAsync(mids, async(mid) => {\r\n            const message = await managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n            return message.fromId === rootScope.myId;\r\n          });\r\n\r\n          if(canRevoke.length) {\r\n            if(canRevoke.length === mids.length) {\r\n              checkboxes.push({\r\n                text: 'DeleteForAll'\r\n              });\r\n            } else {\r\n              checkboxes.push({\r\n                text: 'DeleteMessagesOption'\r\n              });\r\n\r\n              description = 'DeleteMessagesTextGroup';\r\n              descriptionArgs = [i18n('messages', [canRevoke.length])];\r\n              //description = `You can also delete the ${canRevoke.length} message${canRevoke.length > 1 ? 's' : ''} you sent from the inboxes of other group members by pressing \"${buttonText}\".`;\r\n            }\r\n          }\r\n        } else {\r\n          buttons[0].callback = (checked) => callback(checked, true);\r\n        }\r\n      }\r\n    }\r\n\r\n    addCancelButton(buttons);\r\n\r\n    const popup = new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      titleLangArgs: titleArgs,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    });\r\n\r\n    popup.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupSendNow extends PopupPeer {\r\n  constructor(peerId: PeerId, mids: number[], onConfirm?: () => void) {\r\n    super('popup-delete-chat', {\r\n      title: `Send Message${mids.length > 1 ? 's' : ''} Now`,\r\n      description: mids.length > 1 ? 'Send ' + mids.length + ' messages now?' : 'Send message now?',\r\n      buttons: [{\r\n        langKey: 'Send',\r\n        callback: () => {\r\n          onConfirm && onConfirm();\r\n          this.managers.appMessagesManager.sendScheduledMessages(peerId, mids);\r\n        }\r\n      }]\r\n    });\r\n    \r\n    this.show();\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function cancelSelection() {\r\n  if(window.getSelection) {\r\n    if(window.getSelection().empty) {  // Chrome\r\n      window.getSelection().empty();\r\n    } else if(window.getSelection().removeAllRanges) {  // Firefox\r\n      window.getSelection().removeAllRanges();\r\n    }\r\n    // @ts-ignore\r\n  } else if(document.selection) {  // IE?\r\n    // @ts-ignore\r\n    document.selection.empty();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppMessagesManager, MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type ChatBubbles from \"./bubbles\";\r\nimport type ChatInput from \"./input\";\r\nimport type Chat from \"./chat\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport Button from \"../button\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport PopupDeleteMessages from \"../popups/deleteMessages\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport { toast } from \"../toast\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PopupSendNow from \"../popups/sendNow\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport I18n, { i18n, _i18n } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport cancelSelection from \"../../helpers/dom/cancelSelection\";\r\nimport getSelectedText from \"../../helpers/dom/getSelectedText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport AppSearchSuper from \"../appSearchSuper.\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport { randomLong } from \"../../helpers/random\";\r\nimport { attachClickEvent, AttachClickOptions } from \"../../helpers/dom/clickEvent\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport filterUnique from \"../../helpers/array/filterUnique\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\n\r\nconst accumulateMapSet = (map: Map<any, Set<number>>) => {\r\n  return [...map.values()].reduce((acc, v) => acc + v.size, 0);\r\n};\r\n\r\n//const MIN_CLICK_MOVE = 32; // minimum bubble height\r\n\r\nclass AppSelection extends EventListenerBase<{\r\n  toggle: (isSelecting: boolean) => void\r\n}> {\r\n  public selectedMids: Map<PeerId, Set<number>> = new Map();\r\n  public isSelecting = false;\r\n\r\n  public selectedText: string;\r\n\r\n  protected listenerSetter: ListenerSetter;\r\n  protected isScheduled: boolean;\r\n  protected listenElement: HTMLElement;\r\n\r\n  protected onToggleSelection: (forwards: boolean, animate: boolean) => void;\r\n  protected onUpdateContainer: (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => void;\r\n  protected onCancelSelection: () => void;\r\n  protected toggleByMid: (peerId: PeerId, mid: number) => void;\r\n  protected toggleByElement: (bubble: HTMLElement) => void;\r\n\r\n  protected navigationType: NavigationItem['type'];\r\n\r\n  protected getElementFromTarget: (target: HTMLElement) => HTMLElement;\r\n  protected verifyTarget: (e: MouseEvent, target: HTMLElement) => boolean;\r\n  protected verifyMouseMoveTarget: (e: MouseEvent, element: HTMLElement, selecting: boolean) => boolean;\r\n  protected verifyTouchLongPress: () => boolean;\r\n  protected targetLookupClassName: string;\r\n  protected lookupBetweenParentClassName: string;\r\n  protected lookupBetweenElementsQuery: string;\r\n\r\n  protected doNotAnimate: boolean;\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    managers: AppManagers,\r\n    getElementFromTarget: AppSelection['getElementFromTarget'],\r\n    verifyTarget?: AppSelection['verifyTarget'],\r\n    verifyMouseMoveTarget?: AppSelection['verifyMouseMoveTarget'],\r\n    verifyTouchLongPress?: AppSelection['verifyTouchLongPress'],\r\n    targetLookupClassName: string,\r\n    lookupBetweenParentClassName: string,\r\n    lookupBetweenElementsQuery: string,\r\n    isScheduled?: AppSelection['isScheduled']\r\n  }) {\r\n    super(false);\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.navigationType = 'multiselect-' + randomLong() as any;\r\n  }\r\n\r\n  public attachListeners(listenElement: HTMLElement, listenerSetter: ListenerSetter) {\r\n    if(this.listenElement) {\r\n      this.listenerSetter.removeAll();\r\n    }\r\n\r\n    this.listenElement = listenElement;\r\n    this.listenerSetter = listenerSetter;\r\n\r\n    if(!listenElement) {\r\n      return;\r\n    }\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      listenerSetter.add(listenElement)('touchend', () => {\r\n        if(!this.isSelecting) return;\r\n        this.selectedText = getSelectedText();\r\n      });\r\n\r\n      attachContextMenuListener(listenElement, (e) => {\r\n        if(this.isSelecting || (this.verifyTouchLongPress && !this.verifyTouchLongPress())) return;\r\n\r\n        // * these two lines will fix instant text selection on iOS Safari\r\n        document.body.classList.add('no-select'); // * need no-select on body because chat-input transforms in channels\r\n        listenElement.addEventListener('touchend', (e) => {\r\n          cancelEvent(e); // ! this one will fix propagation to document loader button, etc\r\n          document.body.classList.remove('no-select');\r\n\r\n          //this.chat.bubbles.onBubblesClick(e);\r\n        }, {once: true, capture: true});\r\n\r\n        cancelSelection();\r\n        //cancelEvent(e as any);\r\n        const element = this.getElementFromTarget(e.target as HTMLElement);\r\n        if(element) {\r\n          this.toggleByElement(element);\r\n        }\r\n      }, listenerSetter);\r\n\r\n      return;\r\n    }\r\n\r\n    listenerSetter.add(listenElement)('mousedown', this.onMouseDown);\r\n  }\r\n\r\n  private onMouseDown = (e: MouseEvent) => {\r\n    //console.log('selection mousedown', e);\r\n    const element = findUpClassName(e.target, this.targetLookupClassName);\r\n    if(e.button !== 0) {\r\n      return;\r\n    }\r\n\r\n    if(this.verifyTarget && !this.verifyTarget(e, element)) {\r\n      return;\r\n    }\r\n\r\n    const seen: AppSelection['selectedMids'] = new Map();\r\n    let selecting: boolean;\r\n\r\n    /* let good = false;\r\n    const {x, y} = e; */\r\n\r\n    /* const bubbles = appImManager.bubbles;\r\n    for(const mid in bubbles) {\r\n      const bubble = bubbles[mid];\r\n      bubble.addEventListener('mouseover', () => {\r\n        console.log('mouseover');\r\n      }, {once: true});\r\n    } */\r\n\r\n    let firstTarget = element;\r\n\r\n    const processElement = (element: HTMLElement, checkBetween = true) => {\r\n      const mid = +element.dataset.mid;\r\n      if(!mid || !element.dataset.peerId) return;\r\n      const peerId = element.dataset.peerId.toPeerId();\r\n\r\n      if(!isInDOM(firstTarget)) {\r\n        firstTarget = element;\r\n      }\r\n\r\n      let seenSet = seen.get(peerId);\r\n      if(!seenSet) {\r\n        seen.set(peerId, seenSet = new Set());\r\n      }\r\n\r\n      if(seenSet.has(mid)) {\r\n        return;\r\n      }\r\n\r\n      const isSelected = this.isMidSelected(peerId, mid);\r\n      if(selecting === undefined) {\r\n        //bubblesContainer.classList.add('no-select');\r\n        selecting = !isSelected;\r\n      }\r\n\r\n      seenSet.add(mid);\r\n\r\n      if((selecting && !isSelected) || (!selecting && isSelected)) {\r\n        const seenLength = accumulateMapSet(seen);\r\n        if(this.toggleByElement && checkBetween) {\r\n          if(seenLength < 2) {\r\n            if(findUpAsChild(element, firstTarget)) {\r\n              firstTarget = element;\r\n            }\r\n          }\r\n\r\n          const elementsBetween = this.getElementsBetween(firstTarget, element);\r\n          // console.log(elementsBetween);\r\n          if(elementsBetween.length) {\r\n            elementsBetween.forEach((element) => {\r\n              processElement(element, false);\r\n            });\r\n          }\r\n        }\r\n\r\n        if(!this.selectedMids.size) {\r\n          if(seenLength === 2 && this.toggleByMid) {\r\n            for(const [peerId, mids] of seen) {\r\n              for(const mid of mids) {\r\n                this.toggleByMid(peerId, mid);\r\n              }\r\n            }\r\n          }\r\n        } else if(this.toggleByElement) {\r\n          this.toggleByElement(element);\r\n        }\r\n      }\r\n    };\r\n\r\n    //const foundTargets: Map<HTMLElement, true> = new Map();\r\n    let canceledSelection = false;\r\n    const onMouseMove = (e: MouseEvent) => {\r\n      if(!canceledSelection) {\r\n        cancelSelection();\r\n        canceledSelection = true;\r\n      }\r\n      /* if(!good) {\r\n        if(Math.abs(e.x - x) > MIN_CLICK_MOVE || Math.abs(e.y - y) > MIN_CLICK_MOVE) {\r\n          good = true;\r\n        } else {\r\n          return;\r\n        }\r\n      } */\r\n\r\n      /* if(foundTargets.has(e.target as HTMLElement)) return;\r\n      foundTargets.set(e.target as HTMLElement, true); */\r\n      const element = this.getElementFromTarget(e.target as HTMLElement);\r\n      if(!element) {\r\n        //console.error('found no bubble', e);\r\n        return;\r\n      }\r\n\r\n      if(this.verifyMouseMoveTarget && !this.verifyMouseMoveTarget(e, element, selecting)) {\r\n        this.listenerSetter.removeManual(this.listenElement, 'mousemove', onMouseMove);\r\n        this.listenerSetter.removeManual(document, 'mouseup', onMouseUp, documentListenerOptions);\r\n        return;\r\n      }\r\n\r\n      processElement(element);\r\n    };\r\n\r\n    const onMouseUp = (e: MouseEvent) => {\r\n      if(seen.size) {\r\n        attachClickEvent(window, cancelEvent, {capture: true, once: true, passive: false});\r\n      }\r\n\r\n      this.listenerSetter.removeManual(this.listenElement, 'mousemove', onMouseMove);\r\n      //bubblesContainer.classList.remove('no-select');\r\n\r\n      // ! CANCEL USER SELECTION !\r\n      cancelSelection();\r\n    };\r\n\r\n    const documentListenerOptions = {once: true};\r\n    this.listenerSetter.add(this.listenElement)('mousemove', onMouseMove);\r\n    this.listenerSetter.add(document)('mouseup', onMouseUp, documentListenerOptions);\r\n  };\r\n\r\n  private getElementsBetween = (first: HTMLElement, last: HTMLElement) => { \r\n    if(first === last) {\r\n      return [];\r\n    }\r\n\r\n    const firstRect = first.getBoundingClientRect();\r\n    const lastRect = last.getBoundingClientRect();\r\n    const difference = (firstRect.top - lastRect.top) || (firstRect.left - lastRect.left);\r\n    const isHigher = difference < 0;\r\n\r\n    const parent = findUpClassName(first, this.lookupBetweenParentClassName);\r\n    if(!parent) {\r\n      return [];\r\n    }\r\n\r\n    const elements = Array.from(parent.querySelectorAll(this.lookupBetweenElementsQuery)) as HTMLElement[];\r\n    let firstIndex = elements.indexOf(first);\r\n    let lastIndex = elements.indexOf(last);\r\n\r\n    if(!isHigher) {\r\n      [lastIndex, firstIndex] = [firstIndex, lastIndex];\r\n    }\r\n\r\n    const slice = elements.slice(firstIndex + 1, lastIndex);\r\n\r\n    // console.log('getElementsBetween', first, last, slice, firstIndex, lastIndex, isHigher);\r\n\r\n    return slice;\r\n  };\r\n\r\n  protected isElementShouldBeSelected(element: HTMLElement) {\r\n    return this.isMidSelected(element.dataset.peerId.toPeerId(), +element.dataset.mid);\r\n  }\r\n\r\n  protected appendCheckbox(element: HTMLElement, checkboxField: CheckboxField) {\r\n    element.prepend(checkboxField.label);\r\n  }\r\n\r\n  public toggleElementCheckbox(element: HTMLElement, show: boolean) {\r\n    const hasCheckbox = !!this.getCheckboxInputFromElement(element);\r\n    if(show) {\r\n      if(hasCheckbox) {\r\n        return false;\r\n      }\r\n      \r\n      const checkboxField = new CheckboxField({\r\n        name: element.dataset.mid, \r\n        round: true\r\n      });\r\n      \r\n      // * if it is a render of new message\r\n      if(this.isSelecting) { // ! avoid breaking animation on start\r\n        if(this.isElementShouldBeSelected(element)) {\r\n          checkboxField.input.checked = true;\r\n          element.classList.add('is-selected');\r\n        }\r\n      }\r\n      \r\n      this.appendCheckbox(element, checkboxField);\r\n    } else if(hasCheckbox) {\r\n      this.getCheckboxInputFromElement(element).parentElement.remove();\r\n      SetTransition(element, 'is-selected', false, 200);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  protected getCheckboxInputFromElement(element: HTMLElement): HTMLInputElement {\r\n    return element.firstElementChild?.tagName === 'LABEL' && \r\n      element.firstElementChild.firstElementChild as HTMLInputElement;\r\n  }\r\n\r\n  protected async updateContainer(forceSelection = false) {\r\n    const size = this.selectedMids.size;\r\n    if(!size && !forceSelection) return;\r\n    \r\n    let cantForward = !size, \r\n      cantDelete = !size, \r\n      cantSend = !size;\r\n    for(const [peerId, mids] of this.selectedMids) {\r\n      const storageKey: MessagesStorageKey = `${peerId}_${this.isScheduled ? 'scheduled' : 'history'}`;\r\n      const r = await this.managers.appMessagesManager.cantForwardDeleteMids(storageKey, Array.from(mids));\r\n      cantForward = r.cantForward;\r\n      cantDelete = r.cantDelete;\r\n\r\n      if(cantForward && cantDelete) break;\r\n    }\r\n    \r\n    this.onUpdateContainer && this.onUpdateContainer(cantForward, cantDelete, cantSend);\r\n  }\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const wasSelecting = this.isSelecting;\r\n    const size = this.selectedMids.size;\r\n    this.isSelecting = !!size || forceSelection;\r\n\r\n    if(wasSelecting === this.isSelecting) return false;\r\n\r\n    this.dispatchEvent('toggle', this.isSelecting);\r\n    \r\n    // const bubblesContainer = this.bubbles.bubblesContainer;\r\n    //bubblesContainer.classList.toggle('is-selecting', !!size);\r\n\r\n    /* if(bubblesContainer.classList.contains('is-chat-input-hidden')) {\r\n      const scrollable = this.appImManager.scrollable;\r\n      if(scrollable.isScrolledDown) {\r\n        scrollable.scrollTo(scrollable.scrollHeight, 'top', true, true, 200);\r\n      }\r\n    } */\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.listenElement.classList.toggle('no-select', this.isSelecting);\r\n\r\n      if(wasSelecting) {\r\n        // ! CANCEL USER SELECTION !\r\n        cancelSelection();\r\n      }\r\n    }/*  else {\r\n      if(!wasSelecting) {\r\n        bubblesContainer.classList.add('no-select');\r\n        setTimeout(() => {\r\n          cancelSelection();\r\n          bubblesContainer.classList.remove('no-select');\r\n          cancelSelection();\r\n        }, 100);\r\n      }\r\n    } */\r\n\r\n    blurActiveElement();\r\n\r\n    const forwards = !!size || forceSelection;\r\n    this.onToggleSelection && this.onToggleSelection(forwards, !this.doNotAnimate);\r\n\r\n    if(!IS_MOBILE_SAFARI) {\r\n      if(forwards) {\r\n        appNavigationController.pushItem({\r\n          type: this.navigationType,\r\n          onPop: () => {\r\n            this.cancelSelection();\r\n          }\r\n        });\r\n      } else {\r\n        appNavigationController.removeByType(this.navigationType);\r\n      }\r\n    }\r\n\r\n    if(forceSelection) {\r\n      this.updateContainer(forceSelection);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public cancelSelection = async(doNotAnimate?: boolean) => {\r\n    if(doNotAnimate) this.doNotAnimate = true;\r\n    this.onCancelSelection && await this.onCancelSelection();\r\n    this.selectedMids.clear();\r\n    this.toggleSelection();\r\n    cancelSelection();\r\n    if(doNotAnimate) this.doNotAnimate = undefined;\r\n  };\r\n\r\n  public cleanup() {\r\n    this.doNotAnimate = true;\r\n    this.selectedMids.clear();\r\n    this.toggleSelection(false);\r\n    this.doNotAnimate = undefined;\r\n  }\r\n\r\n  protected updateElementSelection(element: HTMLElement, isSelected: boolean) {\r\n    this.toggleElementCheckbox(element, true);\r\n    const input = this.getCheckboxInputFromElement(element);\r\n    input.checked = isSelected;\r\n\r\n    this.toggleSelection();\r\n    this.updateContainer();\r\n    SetTransition(element, 'is-selected', isSelected, 200);\r\n  }\r\n\r\n  public isMidSelected(peerId: PeerId, mid: number) {\r\n    const set = this.selectedMids.get(peerId);\r\n    return set?.has(mid);\r\n  }\r\n\r\n  public length() {\r\n    return accumulateMapSet(this.selectedMids);\r\n  }\r\n\r\n  protected toggleMid(peerId: PeerId, mid: number, unselect?: boolean) {\r\n    let set = this.selectedMids.get(peerId);\r\n    if(unselect || (unselect === undefined && set?.has(mid))) {\r\n      if(set) {\r\n        set.delete(mid);\r\n\r\n        if(!set.size) {\r\n          this.selectedMids.delete(peerId);\r\n        }\r\n      }\r\n    } else {\r\n      // const diff = rootScope.config.forwarded_count_max - this.length() - 1;\r\n      // if(diff < 0) {\r\n      //   toast(I18n.format('Chat.Selection.LimitToast', true));\r\n      //   return false;\r\n      //   /* const it = this.selectedMids.values();\r\n      //   do {\r\n      //     const mid = it.next().value;\r\n      //     const mounted = this.appImManager.getMountedBubble(mid);\r\n      //     if(mounted) {\r\n      //       this.toggleByBubble(mounted.bubble);\r\n      //     } else {\r\n      //       const mids = this.appMessagesManager.getMidsByMid(mid);\r\n      //       for(const mid of mids) {\r\n      //         this.selectedMids.delete(mid);\r\n      //       }\r\n      //     }\r\n      //   } while(this.selectedMids.size > MAX_SELECTION_LENGTH); */\r\n      // }\r\n\r\n      if(!set) {\r\n        set = new Set();\r\n        this.selectedMids.set(peerId, set);\r\n      }\r\n\r\n      set.add(mid);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * ! Call this method only to handle deleted messages\r\n   */\r\n  public deleteSelectedMids(peerId: PeerId, mids: number[]) {\r\n    const set = this.selectedMids.get(peerId);\r\n    if(!set) {\r\n      return;\r\n    }\r\n\r\n    mids.forEach((mid) => {\r\n      set.delete(mid);\r\n    });\r\n\r\n    if(!set.size) {\r\n      this.selectedMids.delete(peerId);\r\n    }\r\n\r\n    this.updateContainer();\r\n    this.toggleSelection();\r\n  }\r\n}\r\n\r\nexport class SearchSelection extends AppSelection {\r\n  protected selectionContainer: HTMLElement;\r\n  protected selectionCountEl: HTMLElement;\r\n  public selectionForwardBtn: HTMLElement;\r\n  public selectionDeleteBtn: HTMLElement;\r\n  public selectionGotoBtn: HTMLElement;\r\n\r\n  private isPrivate: boolean;\r\n\r\n  constructor(private searchSuper: AppSearchSuper, managers: AppManagers) {\r\n    super({\r\n      managers,\r\n      verifyTarget: (e, target) => !!target && this.isSelecting,\r\n      getElementFromTarget: (target) => findUpClassName(target, 'search-super-item'),\r\n      targetLookupClassName: 'search-super-item',\r\n      lookupBetweenParentClassName: 'tabs-tab',\r\n      lookupBetweenElementsQuery: '.search-super-item'\r\n    });\r\n\r\n    this.isPrivate = !searchSuper.showSender;\r\n    this.attachListeners(searchSuper.container, new ListenerSetter());\r\n  }\r\n\r\n  /* public appendCheckbox(element: HTMLElement, checkboxField: CheckboxField) {\r\n    checkboxField.label.classList.add('bubble-select-checkbox');\r\n\r\n    if(element.classList.contains('document') || element.tagName === 'AUDIO-ELEMENT') {\r\n      element.querySelector('.document, audio-element').append(checkboxField.label);\r\n    } else {\r\n      super.appendCheckbox(bubble, checkboxField);\r\n    }\r\n  } */\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const ret = super.toggleSelection(toggleCheckboxes, forceSelection);\r\n\r\n    if(ret && toggleCheckboxes) {\r\n      const elements = Array.from(this.searchSuper.tabsContainer.querySelectorAll('.search-super-item')) as HTMLElement[];\r\n      elements.forEach((element) => {\r\n        this.toggleElementCheckbox(element, this.isSelecting);\r\n      });\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public toggleByElement = (element: HTMLElement) => {\r\n    const mid = +element.dataset.mid;\r\n    const peerId = element.dataset.peerId.toPeerId();\r\n\r\n    if(!this.toggleMid(peerId, mid)) {\r\n      return;\r\n    }\r\n\r\n    this.updateElementSelection(element, this.isMidSelected(peerId, mid));\r\n  };\r\n\r\n  public toggleByMid = (peerId: PeerId, mid: number) => {\r\n    const element = this.searchSuper.mediaTab.contentTab.querySelector(`.search-super-item[data-peer-id=\"${peerId}\"][data-mid=\"${mid}\"]`) as HTMLElement;\r\n    this.toggleByElement(element);\r\n  };\r\n\r\n  protected onUpdateContainer = (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => {\r\n    const length = this.length();\r\n    replaceContent(this.selectionCountEl, i18n('messages', [length]));\r\n    this.selectionGotoBtn.classList.toggle('hide', length !== 1);\r\n    this.selectionForwardBtn.classList.toggle('hide', cantForward);\r\n    this.selectionDeleteBtn && this.selectionDeleteBtn.classList.toggle('hide', cantDelete);\r\n  };\r\n\r\n  protected onToggleSelection = (forwards: boolean, animate: boolean) => {\r\n    SetTransition(this.searchSuper.navScrollableContainer, 'is-selecting', forwards, animate ? 200 : 0, () => {\r\n      if(!this.isSelecting) {\r\n        this.selectionContainer.remove();\r\n        this.selectionContainer = \r\n          this.selectionForwardBtn = \r\n          this.selectionDeleteBtn = \r\n          null;\r\n        this.selectedText = undefined;\r\n      }\r\n    });\r\n\r\n    SetTransition(this.searchSuper.container, 'is-selecting', forwards, 200);\r\n\r\n    if(this.isSelecting) {\r\n      if(!this.selectionContainer) {\r\n        const BASE_CLASS = 'search-super-selection';\r\n        this.selectionContainer = document.createElement('div');\r\n        this.selectionContainer.classList.add(BASE_CLASS + '-container');\r\n\r\n        const btnCancel = ButtonIcon(`close ${BASE_CLASS}-cancel`, {noRipple: true});\r\n        this.listenerSetter.add(btnCancel)('click', () => this.cancelSelection(), {once: true});\r\n\r\n        this.selectionCountEl = document.createElement('div');\r\n        this.selectionCountEl.classList.add(BASE_CLASS + '-count');\r\n\r\n        this.selectionGotoBtn = ButtonIcon(`message ${BASE_CLASS}-goto`);\r\n\r\n        const attachClickOptions: AttachClickOptions = {listenerSetter: this.listenerSetter};\r\n        attachClickEvent(this.selectionGotoBtn, () => {\r\n          const peerId = [...this.selectedMids.keys()][0];\r\n          const mid = [...this.selectedMids.get(peerId)][0];\r\n          this.cancelSelection();\r\n\r\n          appImManager.setInnerPeer({peerId, lastMsgId: mid});\r\n        }, attachClickOptions);\r\n\r\n        this.selectionForwardBtn = ButtonIcon(`forward ${BASE_CLASS}-forward`);\r\n        attachClickEvent(this.selectionForwardBtn, () => {\r\n          const obj: {[fromPeerId: PeerId]: number[]} = {};\r\n          for(const [fromPeerId, mids] of this.selectedMids) {\r\n            obj[fromPeerId] = Array.from(mids).sort((a, b) => a - b);\r\n          }\r\n\r\n          new PopupForward(obj, () => {\r\n            this.cancelSelection();\r\n          });\r\n        }, attachClickOptions);\r\n\r\n        if(this.isPrivate) {\r\n          this.selectionDeleteBtn = ButtonIcon(`delete danger ${BASE_CLASS}-delete`);\r\n          attachClickEvent(this.selectionDeleteBtn, () => {\r\n            const peerId = [...this.selectedMids.keys()][0];\r\n            new PopupDeleteMessages(peerId, [...this.selectedMids.get(peerId)], 'chat', () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        }\r\n\r\n        this.selectionContainer.append(...[\r\n          btnCancel, \r\n          this.selectionCountEl, \r\n          this.selectionGotoBtn, \r\n          this.selectionForwardBtn, \r\n          this.selectionDeleteBtn\r\n        ].filter(Boolean));\r\n\r\n        const transitionElement = this.selectionContainer;\r\n        transitionElement.style.opacity = '0';\r\n        this.searchSuper.navScrollableContainer.append(transitionElement);\r\n\r\n        void transitionElement.offsetLeft; // reflow\r\n        transitionElement.style.opacity = '';\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\nexport default class ChatSelection extends AppSelection {\r\n  protected selectionInputWrapper: HTMLElement;\r\n  protected selectionContainer: HTMLElement;\r\n  protected selectionCountEl: HTMLElement;\r\n  public selectionSendNowBtn: HTMLElement;\r\n  public selectionForwardBtn: HTMLElement;\r\n  public selectionDeleteBtn: HTMLElement;\r\n  private selectionLeft: HTMLDivElement;\r\n  private selectionRight: HTMLDivElement;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private bubbles: ChatBubbles, \r\n    private input: ChatInput, \r\n    managers: AppManagers\r\n  ) {\r\n    super({\r\n      managers,\r\n      getElementFromTarget: (target) => findUpClassName(target, 'grouped-item') || findUpClassName(target, 'bubble'),\r\n      verifyTarget: (e, target) => {\r\n        // LEFT BUTTON\r\n        // проверка внизу нужна для того, чтобы не активировать селект если target потомок .bubble\r\n        const bad = !this.selectedMids.size \r\n          && !(e.target as HTMLElement).classList.contains('bubble')\r\n          && !(e.target as HTMLElement).classList.contains('document-selection')\r\n          && target;\r\n\r\n        return !bad;\r\n      },\r\n      verifyMouseMoveTarget: (e, element, selecting) => {\r\n        const bad = e.target !== element && \r\n          !(e.target as HTMLElement).classList.contains('document-selection') && \r\n          selecting === undefined && \r\n          !this.selectedMids.size;\r\n        return !bad;\r\n      },\r\n      verifyTouchLongPress: () => !this.chat.input.recording,\r\n      targetLookupClassName: 'bubble',\r\n      lookupBetweenParentClassName: 'bubbles-inner',\r\n      lookupBetweenElementsQuery: '.bubble:not(.is-multiple-documents), .grouped-item',\r\n      isScheduled: chat.type === 'scheduled'\r\n    });\r\n  }\r\n\r\n  public appendCheckbox(bubble: HTMLElement, checkboxField: CheckboxField) {\r\n    checkboxField.label.classList.add('bubble-select-checkbox');\r\n\r\n    if(bubble.classList.contains('document-container')) {\r\n      bubble.querySelector('.document, audio-element').append(checkboxField.label);\r\n    } else {\r\n      super.appendCheckbox(bubble, checkboxField);\r\n    }\r\n  }\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const ret = super.toggleSelection(toggleCheckboxes, forceSelection);\r\n\r\n    if(ret && toggleCheckboxes) {\r\n      for(const mid in this.bubbles.bubbles) {\r\n        if(this.bubbles.skippedMids.has(+mid)) {\r\n          continue;\r\n        }\r\n        \r\n        const bubble = this.bubbles.bubbles[mid];\r\n        this.toggleElementCheckbox(bubble, this.isSelecting);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public toggleElementCheckbox(bubble: HTMLElement, show: boolean) {\r\n    if(!this.canSelectBubble(bubble)) return;\r\n\r\n    const ret = super.toggleElementCheckbox(bubble, show);\r\n    if(ret) {\r\n      const isGrouped = bubble.classList.contains('is-grouped');\r\n      if(isGrouped) {\r\n        this.bubbles.getBubbleGroupedItems(bubble).forEach((item) => this.toggleElementCheckbox(item, show));\r\n      }\r\n    }\r\n    \r\n    return ret;\r\n  }\r\n\r\n  public toggleByElement = (bubble: HTMLElement): Promise<void> => {\r\n    if(!this.canSelectBubble(bubble)) return;\r\n\r\n    const mid = +bubble.dataset.mid;\r\n\r\n    const isGrouped = bubble.classList.contains('is-grouped');\r\n    if(isGrouped) {\r\n      if(!this.isGroupedBubbleSelected(bubble)) {\r\n        const set = this.selectedMids.get(this.chat.peerId);\r\n        if(set) {\r\n          // const mids = await this.chat.getMidsByMid(mid);\r\n          const mids = this.getMidsFromGroupContainer(bubble);\r\n          mids.forEach((mid) => set.delete(mid));\r\n        }\r\n      }\r\n\r\n      /* const promises =  */this.bubbles.getBubbleGroupedItems(bubble).map(this.toggleByElement);\r\n      // await Promise.all(promises);\r\n      return;\r\n    }\r\n\r\n    if(!this.toggleMid(this.chat.peerId, mid)) {\r\n      return;\r\n    }\r\n\r\n    const isGroupedItem = bubble.classList.contains('grouped-item');\r\n    if(isGroupedItem) {\r\n      const groupContainer = findUpClassName(bubble, 'bubble');\r\n      const isGroupedSelected = this.isGroupedBubbleSelected(groupContainer);\r\n      const isGroupedMidsSelected = this.isGroupedMidsSelected(groupContainer);\r\n\r\n      const willChange = isGroupedMidsSelected || isGroupedSelected;\r\n      if(willChange) {\r\n        this.updateElementSelection(groupContainer, isGroupedMidsSelected);\r\n      }\r\n    }\r\n\r\n    this.updateElementSelection(bubble, this.isMidSelected(this.chat.peerId, mid));\r\n  };\r\n\r\n  protected toggleByMid = async(peerId: PeerId, mid: number) => {\r\n    const mounted = await this.bubbles.getMountedBubble(mid);\r\n    if(mounted) {\r\n      this.toggleByElement(mounted.bubble);\r\n    }\r\n  };\r\n\r\n  public isElementShouldBeSelected(element: HTMLElement) {\r\n    const isGrouped = element.classList.contains('is-grouped');\r\n    return super.isElementShouldBeSelected(element) && (!isGrouped || this.isGroupedMidsSelected(element));\r\n  }\r\n\r\n  protected isGroupedBubbleSelected(bubble: HTMLElement) {\r\n    const groupedCheckboxInput = this.getCheckboxInputFromElement(bubble);\r\n    return groupedCheckboxInput?.checked;\r\n  }\r\n\r\n  protected getMidsFromGroupContainer(groupContainer: HTMLElement) {\r\n    const elements = this.chat.bubbles.getBubbleGroupedItems(groupContainer);\r\n    if(!elements.length) {\r\n      elements.push(groupContainer);\r\n    }\r\n\r\n    return elements.map((element) => +element.dataset.mid);\r\n  }\r\n\r\n  protected isGroupedMidsSelected(groupContainer: HTMLElement) {\r\n    const mids = this.getMidsFromGroupContainer(groupContainer);\r\n    const selectedMids = mids.filter((mid) => this.isMidSelected(this.chat.peerId, mid));\r\n    return mids.length === selectedMids.length;\r\n  }\r\n\r\n  protected getCheckboxInputFromElement(bubble: HTMLElement) {\r\n    /* let perf = performance.now();\r\n    let checkbox = bubble.firstElementChild.tagName === 'LABEL' && bubble.firstElementChild.firstElementChild as HTMLInputElement;\r\n    console.log('getCheckboxInputFromBubble firstElementChild time:', performance.now() - perf);\r\n  \r\n    perf = performance.now();\r\n    checkbox = bubble.querySelector('label input');\r\n    console.log('getCheckboxInputFromBubble querySelector time:', performance.now() - perf); */\r\n    /* let perf = performance.now();\r\n    let contains = bubble.classList.contains('document-container');\r\n    console.log('getCheckboxInputFromBubble classList time:', performance.now() - perf);\r\n  \r\n    perf = performance.now();\r\n    contains = bubble.className.includes('document-container');\r\n    console.log('getCheckboxInputFromBubble className time:', performance.now() - perf); */\r\n  \r\n    return bubble.classList.contains('document-container') ? \r\n      bubble.querySelector('label input') as HTMLInputElement : \r\n      super.getCheckboxInputFromElement(bubble);\r\n  }\r\n\r\n  public canSelectBubble(bubble: HTMLElement) {\r\n    return !bubble.classList.contains('service') && \r\n      !bubble.classList.contains('is-outgoing') && \r\n      !bubble.classList.contains('bubble-first') && \r\n      !bubble.classList.contains('avoid-selection');\r\n  }\r\n\r\n  protected onToggleSelection = async(forwards: boolean, animate: boolean) => {\r\n    const {needTranslateX, widthFrom, widthTo} = await this.chat.input.center(animate);\r\n\r\n    SetTransition(this.listenElement, 'is-selecting', forwards, animate ? 200 : 0, () => {\r\n      if(!this.isSelecting) {\r\n        this.selectionInputWrapper.remove();\r\n        this.selectionInputWrapper = \r\n          this.selectionContainer = \r\n          this.selectionSendNowBtn = \r\n          this.selectionForwardBtn = \r\n          this.selectionDeleteBtn = \r\n          this.selectionLeft = \r\n          this.selectionRight = \r\n          null;\r\n        this.selectedText = undefined;\r\n      }\r\n      \r\n      /* fastRaf(() => {\r\n        this.bubbles.onScroll();\r\n      }); */\r\n    });\r\n\r\n    //const chatInput = this.appImManager.chatInput;\r\n\r\n    const translateButtonsX = widthFrom < widthTo ? undefined : needTranslateX * 2;\r\n    if(this.isSelecting) {\r\n      if(!this.selectionContainer) {\r\n        this.selectionInputWrapper = document.createElement('div');\r\n        this.selectionInputWrapper.classList.add('chat-input-wrapper', 'selection-wrapper');\r\n\r\n        // const background = document.createElement('div');\r\n        // background.classList.add('chat-input-wrapper-background');\r\n\r\n        this.selectionContainer = document.createElement('div');\r\n        this.selectionContainer.classList.add('selection-container');\r\n\r\n        const attachClickOptions: AttachClickOptions = {listenerSetter: this.listenerSetter};\r\n        const btnCancel = ButtonIcon('close', {noRipple: true});\r\n        attachClickEvent(btnCancel, () => this.cancelSelection(), {once: true, listenerSetter: this.listenerSetter});\r\n\r\n        this.selectionCountEl = document.createElement('div');\r\n        this.selectionCountEl.classList.add('selection-container-count');\r\n\r\n        if(this.chat.type === 'scheduled') {\r\n          this.selectionSendNowBtn = Button('btn-primary btn-transparent btn-short text-bold selection-container-send', {icon: 'send2'});\r\n          this.selectionSendNowBtn.append(i18n('MessageScheduleSend'));\r\n          attachClickEvent(this.selectionSendNowBtn, () => {\r\n            new PopupSendNow(this.chat.peerId, [...this.selectedMids.get(this.chat.peerId)], () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        } else {\r\n          this.selectionForwardBtn = Button('btn-primary btn-transparent text-bold selection-container-forward', {icon: 'forward'});\r\n          this.selectionForwardBtn.append(i18n('Forward'));\r\n          attachClickEvent(this.selectionForwardBtn, () => {\r\n            const obj: {[fromPeerId: PeerId]: number[]} = {};\r\n            for(const [fromPeerId, mids] of this.selectedMids) {\r\n              obj[fromPeerId] = Array.from(mids).sort((a, b) => a - b);\r\n            }\r\n\r\n            new PopupForward(obj, () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        }\r\n\r\n        this.selectionDeleteBtn = Button('btn-primary btn-transparent danger text-bold selection-container-delete', {icon: 'delete'});\r\n        this.selectionDeleteBtn.append(i18n('Delete'));\r\n        attachClickEvent(this.selectionDeleteBtn, () => {\r\n          new PopupDeleteMessages(this.chat.peerId, [...this.selectedMids.get(this.chat.peerId)], this.chat.type, () => {\r\n            this.cancelSelection();\r\n          });\r\n        }, attachClickOptions);\r\n\r\n        const left = this.selectionLeft = document.createElement('div');\r\n        left.classList.add('selection-container-left');\r\n        left.append(btnCancel, this.selectionCountEl);\r\n\r\n        const right = this.selectionRight = document.createElement('div');\r\n        right.classList.add('selection-container-right');\r\n        right.append(...[\r\n          this.selectionSendNowBtn, \r\n          this.selectionForwardBtn, \r\n          this.selectionDeleteBtn\r\n        ].filter(Boolean))\r\n\r\n        if(translateButtonsX !== undefined) {\r\n          left.style.transform = `translateX(${-translateButtonsX}px)`;\r\n          right.style.transform = `translateX(${translateButtonsX}px)`;\r\n        }\r\n\r\n        this.selectionContainer.append(left, right);\r\n\r\n        // background.style.opacity = '0';\r\n        this.selectionInputWrapper.style.opacity = '0';\r\n        this.selectionInputWrapper.append(/* background,  */this.selectionContainer);\r\n        this.input.inputContainer.append(this.selectionInputWrapper);\r\n        \r\n        void this.selectionInputWrapper.offsetLeft; // reflow\r\n        // background.style.opacity = '';\r\n        this.selectionInputWrapper.style.opacity = '';\r\n        left.style.transform = '';\r\n        right.style.transform = '';\r\n      }\r\n    } else if(this.selectionLeft && translateButtonsX !== undefined) {\r\n      this.selectionLeft.style.transform = `translateX(-${translateButtonsX}px)`;\r\n      this.selectionRight.style.transform = `translateX(${translateButtonsX}px)`;\r\n    }\r\n  };\r\n\r\n  protected onUpdateContainer = (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => {\r\n    replaceContent(this.selectionCountEl, i18n('messages', [this.length()]));\r\n    this.selectionSendNowBtn && this.selectionSendNowBtn.toggleAttribute('disabled', cantSend);\r\n    this.selectionForwardBtn && this.selectionForwardBtn.toggleAttribute('disabled', cantForward);\r\n    this.selectionDeleteBtn.toggleAttribute('disabled', cantDelete);\r\n  };\r\n\r\n  protected onCancelSelection = async() => {\r\n    return;\r\n    const promises: Promise<HTMLElement>[] = [];\r\n    for(const [peerId, mids] of this.selectedMids) {\r\n      for(const mid of mids) {\r\n        promises.push(this.bubbles.getMountedBubble(mid).then((m) => m?.bubble));\r\n      }\r\n    }\r\n\r\n    const bubbles = filterUnique((await Promise.all(promises)).filter(Boolean));\r\n    bubbles.forEach((bubble) => {\r\n      this.toggleByElement(bubble);\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getSelectedText(): string {\r\n  if(window.getSelection) {\r\n    return window.getSelection().toString();\r\n    // @ts-ignore\r\n  } else if(document.selection) {\r\n    // @ts-ignore\r\n    return document.selection.createRange().text;\r\n  }\r\n  \r\n  return '';\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { WebPage } from \"../../layer\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\n\r\nexport default function wrapWebPageDescription(webPage: WebPage.webPage) {\r\n  const shortDescriptionText = limitSymbols(webPage.description || '', 150, 180);\r\n  // const siteName = webPage.site_name;\r\n  // let contextHashtag = '';\r\n  // if(siteName === 'GitHub') {\r\n  //   const matches = apiWebPage.url.match(/(https?:\\/\\/github\\.com\\/[^\\/]+\\/[^\\/]+)/);\r\n  //   if(matches) {\r\n  //     contextHashtag = matches[0] + '/issues/{1}';\r\n  //   }\r\n  // }\r\n  return wrapRichText(shortDescriptionText/* , {\r\n    contextSite: siteName || 'external',\r\n    contextHashtag: contextHashtag\r\n  } */);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { WebPage } from \"../../layer\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\n\r\nexport default function wrapWebPageTitle(webPage: WebPage.webPage) {\r\n  let shortTitle = webPage.title || webPage.author || webPage.site_name || '';\r\n  shortTitle = limitSymbols(shortTitle, 80, 100);\r\n  return wrapRichText(shortTitle, {noLinks: true, noLinebreaks: true});\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nexport type MenuPositionPadding = {\r\n  top?: number, \r\n  right?: number, \r\n  bottom?: number, \r\n  left?: number\r\n};\r\n\r\nconst PADDING_TOP = 8;\r\nconst PADDING_BOTTOM = PADDING_TOP;\r\nconst PADDING_LEFT = 8;\r\nconst PADDING_RIGHT = PADDING_LEFT;\r\nexport default function positionMenu({pageX, pageY}: MouseEvent | Touch, elem: HTMLElement, side?: 'left' | 'right' | 'center', additionalPadding?: MenuPositionPadding) {\r\n  //let {clientX, clientY} = e;\r\n\r\n  // * side mean the OPEN side\r\n\r\n  const getScrollWidthFromElement = (Array.from(elem.children) as HTMLElement[]).find((element) => element.classList.contains('btn-menu-item') && !element.classList.contains('hide')) || elem;\r\n\r\n  let {scrollWidth: menuWidth} = getScrollWidthFromElement;\r\n  let {scrollHeight: menuHeight} = elem;\r\n  //let {innerWidth: windowWidth, innerHeight: windowHeight} = window;\r\n  const rect = document.body.getBoundingClientRect();\r\n  const windowWidth = rect.width;\r\n  const windowHeight = rect.height;\r\n\r\n  let paddingTop = PADDING_TOP, paddingRight = PADDING_RIGHT, paddingBottom = PADDING_BOTTOM, paddingLeft = PADDING_LEFT;\r\n  if(additionalPadding) {\r\n    if(additionalPadding.top) paddingTop += additionalPadding.top;\r\n    if(additionalPadding.right) paddingRight += additionalPadding.right;\r\n    if(additionalPadding.bottom) paddingBottom += additionalPadding.bottom;\r\n    if(additionalPadding.left) paddingLeft += additionalPadding.left;\r\n  }\r\n\r\n  side = mediaSizes.isMobile ? 'right' : 'left';\r\n  let verticalSide: 'top' /* | 'bottom' */ | 'center' = 'top';\r\n\r\n  const maxTop = windowHeight - menuHeight - paddingBottom;\r\n  const maxLeft = windowWidth - menuWidth - paddingRight;\r\n  const minTop = paddingTop;\r\n  const minLeft = paddingLeft;\r\n\r\n  const getSides = () => {\r\n    return {\r\n      x: {\r\n        left: pageX,\r\n        right: Math.min(maxLeft, pageX - menuWidth)\r\n      },\r\n      intermediateX: side === 'right' ? minLeft : maxLeft,\r\n      //intermediateX: clientX < windowWidth / 2 ? PADDING_LEFT : windowWidth - menuWidth - PADDING_LEFT,\r\n      y: {\r\n        top: pageY,\r\n        bottom: pageY - menuHeight\r\n      },\r\n      //intermediateY: verticalSide === 'top' ? paddingTop : windowHeight - menuHeight - paddingTop,\r\n      // intermediateY: pageY < (windowHeight / 2) ? paddingTop : windowHeight - menuHeight - paddingBottom,\r\n      intermediateY: maxTop,\r\n    };\r\n  };\r\n\r\n  const sides = getSides();\r\n\r\n  const possibleSides = {\r\n    x: {\r\n      left: (sides.x.left + menuWidth + paddingRight) <= windowWidth,\r\n      right: sides.x.right >= paddingLeft\r\n    },\r\n    y: {\r\n      top: (sides.y.top + menuHeight + paddingBottom) <= windowHeight,\r\n      bottom: (sides.y.bottom - paddingBottom) >= paddingBottom\r\n    }\r\n  };\r\n\r\n  /* if(side === undefined) {\r\n    if((clientX + menuWidth + PADDING_LEFT) > windowWidth) {\r\n      side = 'right';\r\n    }\r\n  } */\r\n\r\n  {\r\n    /* const x = sides.x;\r\n\r\n    const s = Object.keys(x) as (keyof typeof possibleSides.x)[];\r\n    if(side) {\r\n      s.findAndSplice((s) => s === side);\r\n      s.unshift(side);\r\n    }\r\n\r\n    const possibleSide = s.find((s) => possibleSides.x[s]); */\r\n    let left: number;\r\n    /* if(possibleSide) {\r\n      left = x[possibleSide];\r\n      side = possibleSide;\r\n    } else {\r\n      left = sides.intermediateX;\r\n      side = undefined;\r\n    } */\r\n    left = possibleSides.x[side] ? sides.x[side] : (side = 'center', sides.intermediateX);\r\n  \r\n    elem.style.left = left + 'px';\r\n  }\r\n\r\n  /* if((clientY + menuHeight + PADDING_TOP) > windowHeight) {\r\n    elem.style.top = clamp(clientY - menuHeight, PADDING_TOP, windowHeight - menuHeight - PADDING_TOP) + 'px';\r\n    // elem.style.top = (innerHeight - scrollHeight - PADDING_TOP) + 'px';\r\n    verticalSide = 'bottom';\r\n  } else {\r\n    elem.style.top = Math.max(PADDING_TOP, clientY) + 'px';\r\n    verticalSide = 'top';\r\n  } */\r\n\r\n  {\r\n    let top: number;\r\n\r\n    top = possibleSides.y[verticalSide] ? sides.y[verticalSide] : (verticalSide = 'center', sides.intermediateY);\r\n  \r\n    elem.style.top = top + 'px';\r\n  }\r\n  \r\n  elem.className = elem.className.replace(/(top|center|bottom)-(left|center|right)/g, '');\r\n  elem.classList.add(\r\n    //(verticalSide === 'center' ? verticalSide : (verticalSide === 'bottom' ? 'top' : 'bottom')) +\r\n    (verticalSide === 'center' ? verticalSide : 'bottom') +\r\n    '-' +\r\n    (side === 'center' ? side : (side === 'left' ? 'right' : 'left')));\r\n\r\n  return {\r\n    width: menuWidth,\r\n    height: menuHeight\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../lib/appManagers/appDialogsManager\";\r\nimport type { MyInputMessagesFilter, MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { logger } from \"../lib/logger\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { SearchGroup, SearchGroupType } from \"./appSearch\";\r\nimport { horizontalMenu } from \"./horizontalMenu\";\r\nimport LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport { putPreloader } from \"./putPreloader\";\r\nimport ripple from \"./ripple\";\r\nimport Scrollable, { ScrollableX } from \"./scrollable\";\r\nimport { wrapDocument, wrapPhoto, wrapVideo } from \"./wrappers\";\r\nimport useHeavyAnimationCheck, { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport I18n, { LangPackKey, i18n } from \"../lib/langPack\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport { getMiddleware } from \"../helpers/middleware\";\r\nimport { ChannelParticipant, ChatFull, ChatParticipant, ChatParticipants, Document, Message, MessageMedia, Photo, WebPage } from \"../layer\";\r\nimport SortedUserList from \"./sortedUserList\";\r\nimport findUpTag from \"../helpers/dom/findUpTag\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport positionElementByIndex from \"../helpers/dom/positionElementByIndex\";\r\nimport cleanSearchText from \"../helpers/cleanSearchText\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport handleTabSwipe from \"../helpers/dom/handleTabSwipe\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport { formatPhoneNumber } from \"../helpers/formatPhoneNumber\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupForward from \"./popups/forward\";\r\nimport PopupDeleteMessages from \"./popups/deleteMessages\";\r\nimport Row from \"./row\";\r\nimport htmlToDocumentFragment from \"../helpers/dom/htmlToDocumentFragment\";\r\nimport { SearchSelection } from \"./chat/selection\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport AppMediaViewer from \"./appMediaViewer\";\r\nimport lockTouchScroll from \"../helpers/dom/lockTouchScroll\";\r\nimport copy from \"../helpers/object/copy\";\r\nimport getObjectKeysAndSort from \"../helpers/object/getObjectKeysAndSort\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport escapeRegExp from \"../helpers/string/escapeRegExp\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport { ScrollStartCallbackDimensions } from \"../helpers/fastSmoothScroll\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport wrapWebPageDescription from \"./wrappers/webPageDescription\";\r\nimport wrapWebPageTitle from \"./wrappers/webPageTitle\";\r\nimport getAbbreviation from \"../lib/richTextProcessor/getAbbreviation\";\r\nimport matchUrl from \"../lib/richTextProcessor/matchUrl\";\r\nimport wrapPlainText from \"../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport wrapSenderToPeer from \"./wrappers/senderToPeer\";\r\nimport wrapSentTime from \"./wrappers/sentTime\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport filterMessagesByInputFilter from \"../lib/appManagers/utils/messages/filterMessagesByInputFilter\";\r\nimport getChatMembersString from \"./wrappers/getChatMembersString\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport getParticipantPeerId from \"../lib/appManagers/utils/chats/getParticipantPeerId\";\r\nimport { Awaited } from \"../types\";\r\nimport { attachContextMenuListener } from \"../helpers/dom/attachContextMenuListener\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport positionMenu from \"../helpers/positionMenu\";\r\nimport apiManagerProxy from \"../lib/mtproto/mtprotoworker\";\r\n\r\n//const testScroll = false;\r\n\r\nexport type SearchSuperType = MyInputMessagesFilter/*  | 'members' */;\r\nexport type SearchSuperContext = {\r\n  peerId: PeerId,\r\n  inputFilter: {_: MyInputMessagesFilter},\r\n  query?: string,\r\n  maxId?: number,\r\n  folderId?: number,\r\n  threadId?: number,\r\n  date?: number,\r\n  nextRate?: number,\r\n  minDate?: number,\r\n  maxDate?: number\r\n};\r\n\r\nexport type SearchSuperMediaType = 'members' | 'media' | 'files' | 'links' | 'music' | 'chats' | 'voice';\r\nexport type SearchSuperMediaTab = {\r\n  inputFilter: SearchSuperType,\r\n  name: LangPackKey,\r\n  type: SearchSuperMediaType,\r\n  contentTab?: HTMLElement,\r\n  menuTab?: HTMLElement,\r\n  scroll?: {scrollTop: number, scrollHeight: number}\r\n};\r\n\r\nclass SearchContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify?: () => boolean | Promise<boolean>, withSelection?: true})[];\r\n  private element: HTMLElement;\r\n  private target: HTMLElement;\r\n  private peerId: PeerId;\r\n  private mid: number;\r\n  private isSelected: boolean;\r\n  private managers: AppManagers;\r\n\r\n  constructor(\r\n    private attachTo: HTMLElement,\r\n    private searchSuper: AppSearchSuper\r\n  ) {\r\n    this.managers = searchSuper.managers;\r\n\r\n    const onContextMenu = (e: MouseEvent) => {\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      let item: HTMLElement;\r\n      try {\r\n        item = findUpClassName(e.target, 'search-super-item');\r\n      } catch(e) {}\r\n\r\n      if(!item) return;\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      if(this.element.classList.contains('active')) {\r\n        return false;\r\n      }\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      const r = async() => {\r\n        this.target = item;\r\n        this.peerId = item.dataset.peerId.toPeerId();\r\n        this.mid = +item.dataset.mid;\r\n        this.isSelected = searchSuper.selection.isMidSelected(this.peerId, this.mid);\r\n  \r\n        await Promise.all(this.buttons.map(async(button) => {\r\n          let good: boolean;\r\n  \r\n          if(this.isSelected && !button.withSelection) {\r\n            good = false;\r\n          } else {\r\n            good = button.verify ? await button.verify() : true;\r\n          }\r\n  \r\n          button.element.classList.toggle('hide', !good);\r\n        }));\r\n  \r\n        item.classList.add('menu-open');\r\n  \r\n        positionMenu(e, this.element);\r\n        contextMenuController.openBtnMenu(this.element, () => {\r\n          item.classList.remove('menu-open');\r\n        });\r\n      };\r\n\r\n      r();\r\n    };\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n\r\n    } else {\r\n      attachContextMenuListener(attachTo, onContextMenu as any);\r\n    }\r\n  }\r\n\r\n  private init() {\r\n    this.buttons = [{\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: async() => this.managers.appMessagesManager.canForward(await this.managers.appMessagesManager.getMessageByPeer(this.peerId, this.mid))\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Message.Context.Selection.Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: () => this.isSelected && \r\n        !this.searchSuper.selection.selectionForwardBtn.classList.contains('hide'),\r\n      withSelection: true\r\n    }, {\r\n      icon: 'message',\r\n      text: 'Message.Context.Goto',\r\n      onClick: this.onGotoClick,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Select',\r\n      onClick: this.onSelectClick\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Selection.Clear',\r\n      onClick: this.onClearSelectionClick,\r\n      verify: () => this.isSelected,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: async() => this.managers.appMessagesManager.canDeleteMessage(await this.managers.appMessagesManager.getMessageByPeer(this.peerId, this.mid))\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Message.Context.Selection.Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => this.isSelected && !this.searchSuper.selection.selectionDeleteBtn.classList.contains('hide'),\r\n      withSelection: true\r\n    }];\r\n\r\n    this.element = ButtonMenu(this.buttons);\r\n    this.element.classList.add('search-contextmenu', 'contextmenu');\r\n    document.getElementById('page-chats').append(this.element);\r\n  }\r\n\r\n  private onGotoClick = () => {\r\n    appImManager.setInnerPeer({\r\n      peerId: this.peerId,\r\n      lastMsgId: this.mid,\r\n      threadId: this.searchSuper.searchContext.threadId\r\n    });\r\n  };\r\n\r\n  private onForwardClick = () => {\r\n    if(this.searchSuper.selection.isSelecting) {\r\n      simulateClickEvent(this.searchSuper.selection.selectionForwardBtn);\r\n    } else {\r\n      new PopupForward({\r\n        [this.peerId]: [this.mid]\r\n      });\r\n    }\r\n  };\r\n\r\n  private onSelectClick = () => {\r\n    this.searchSuper.selection.toggleByElement(this.target);\r\n  };\r\n\r\n  private onClearSelectionClick = () => {\r\n    this.searchSuper.selection.cancelSelection();\r\n  };\r\n\r\n  private onDeleteClick = () => {\r\n    if(this.searchSuper.selection.isSelecting) {\r\n      simulateClickEvent(this.searchSuper.selection.selectionDeleteBtn);\r\n    } else {\r\n      new PopupDeleteMessages(this.peerId, [this.mid], 'chat');\r\n    }\r\n  };\r\n}\r\n\r\nexport type ProcessSearchSuperResult = {\r\n  message: Message.message, \r\n  middleware: () => boolean, \r\n  promises: Promise<any>[], \r\n  elemsToAppend: {element: HTMLElement, message: any}[],\r\n  inputFilter: MyInputMessagesFilter,\r\n  searchGroup?: SearchGroup\r\n};\r\n\r\nexport default class AppSearchSuper {\r\n  public tabs: {[t in SearchSuperType]: HTMLDivElement} = {} as any;\r\n\r\n  public mediaTab: SearchSuperMediaTab;\r\n\r\n  public container: HTMLElement;\r\n  public nav: HTMLElement;\r\n  public navScrollableContainer: HTMLDivElement;\r\n  public tabsContainer: HTMLElement;\r\n  public navScrollable: ScrollableX;\r\n  private tabsMenu: HTMLElement;\r\n  private prevTabId = -1;\r\n  \r\n  private lazyLoadQueue = new LazyLoadQueue();\r\n  public middleware = getMiddleware();\r\n\r\n  public historyStorage: Partial<{[type in SearchSuperType]: {mid: number, peerId: PeerId}[]}> = {};\r\n  public usedFromHistory: Partial<{[type in SearchSuperType]: number}> = {};\r\n  public urlsToRevoke: string[] = [];\r\n\r\n  public searchContext: SearchSuperContext;\r\n  public loadMutex: Promise<any> = Promise.resolve();\r\n\r\n  private nextRates: Partial<{[type in SearchSuperType]: number}> = {};\r\n  private loadPromises: Partial<{[type in SearchSuperType]: Promise<void>}> = {};\r\n  private loaded: Partial<{[type in SearchSuperType]: boolean}> = {};\r\n  private loadedChats = false;\r\n  private firstLoad = true;\r\n\r\n  private log = logger('SEARCH-SUPER');\r\n  public selectTab: ReturnType<typeof horizontalMenu>;\r\n  \r\n  private monthContainers: Partial<{\r\n    [type in SearchSuperType]: {\r\n      [timestamp: number]: {\r\n        container: HTMLElement,\r\n        items: HTMLElement\r\n      }\r\n    }\r\n  }> = {};\r\n\r\n  private searchGroupMedia: SearchGroup;\r\n\r\n  public mediaTabsMap: Map<SearchSuperMediaType, SearchSuperMediaTab> = new Map();\r\n\r\n  private membersList: SortedUserList;\r\n\r\n  private skipScroll: boolean;\r\n\r\n  // * arguments\r\n  public mediaTabs: SearchSuperMediaTab[];\r\n  public scrollable: Scrollable;\r\n  public searchGroups?: {[group in SearchGroupType]: SearchGroup};\r\n  public asChatList? = false;\r\n  public groupByMonth? = true;\r\n  public hideEmptyTabs? = true;\r\n  public onChangeTab?: (mediaTab: SearchSuperMediaTab) => void;\r\n  public showSender? = false;\r\n\r\n  private searchContextMenu: SearchContextMenu;\r\n  public selection: SearchSelection;\r\n\r\n  public scrollStartCallback: (dimensions: ScrollStartCallbackDimensions) => void;\r\n\r\n  public managers: AppManagers;\r\n  private loadFirstTimePromise: Promise<void>;\r\n\r\n  constructor(options: Pick<AppSearchSuper, 'mediaTabs' | 'scrollable' | 'searchGroups' | 'asChatList' | 'groupByMonth' | 'hideEmptyTabs' | 'onChangeTab' | 'showSender' | 'managers'>) {\r\n    safeAssign(this, options);\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('search-super');\r\n\r\n    this.searchContextMenu = new SearchContextMenu(this.container, this);\r\n    this.selection = new SearchSelection(this, this.managers);\r\n\r\n    const navScrollableContainer = this.navScrollableContainer = document.createElement('div');\r\n    navScrollableContainer.classList.add('search-super-tabs-scrollable', 'menu-horizontal-scrollable', 'sticky');\r\n\r\n    const navScrollable = this.navScrollable = new ScrollableX(navScrollableContainer);\r\n    navScrollable.container.classList.add('search-super-nav-scrollable');\r\n\r\n    const nav = this.nav = document.createElement('nav');\r\n    nav.classList.add('search-super-tabs', 'menu-horizontal-div');\r\n    this.tabsMenu = nav;\r\n\r\n    navScrollable.container.append(nav);\r\n\r\n    for(const mediaTab of this.mediaTabs) {\r\n      const menuTab = document.createElement('div');\r\n      menuTab.classList.add('menu-horizontal-div-item');\r\n      const span = document.createElement('span');\r\n      const i = document.createElement('i');\r\n\r\n      span.append(i18n(mediaTab.name));\r\n      span.append(i);\r\n\r\n      menuTab.append(span);\r\n\r\n      ripple(menuTab);\r\n\r\n      this.tabsMenu.append(menuTab);\r\n\r\n      this.mediaTabsMap.set(mediaTab.type, mediaTab);\r\n\r\n      mediaTab.menuTab = menuTab;\r\n    }\r\n\r\n    this.tabsContainer = document.createElement('div');\r\n    this.tabsContainer.classList.add('search-super-tabs-container', 'tabs-container');\r\n\r\n    let unlockScroll: ReturnType<typeof lockTouchScroll>;\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      handleTabSwipe({\r\n        element: this.tabsContainer, \r\n        onSwipe: (xDiff, yDiff, e) => {\r\n          const prevId = this.selectTab.prevId();\r\n          const children = Array.from(this.tabsMenu.children) as HTMLElement[];\r\n          let idx: number;\r\n          if(xDiff > 0) {\r\n            for(let i = prevId + 1; i < children.length; ++i) {\r\n              if(!children[i].classList.contains('hide')) {\r\n                idx = i;\r\n                break;\r\n              }\r\n            }\r\n          } else {\r\n            for(let i = prevId - 1; i >= 0; --i) {\r\n              if(!children[i].classList.contains('hide')) {\r\n                idx = i;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n\r\n          if(idx !== undefined) {\r\n            unlockScroll = lockTouchScroll(this.tabsContainer);\r\n            this.selectTab(idx);\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    for(const mediaTab of this.mediaTabs) {\r\n      const container = document.createElement('div');\r\n      container.classList.add('search-super-container-' + mediaTab.type, 'tabs-tab');\r\n\r\n      const content = document.createElement('div');\r\n      content.classList.add('search-super-content-' + mediaTab.type);\r\n\r\n      container.append(content);\r\n\r\n      this.tabsContainer.append(container);\r\n\r\n      this.tabs[mediaTab.inputFilter] = content;\r\n\r\n      mediaTab.contentTab = content;\r\n    }\r\n\r\n    this.container.append(navScrollableContainer, this.tabsContainer);\r\n\r\n    // * construct end\r\n\r\n    this.searchGroupMedia = new SearchGroup(false, 'messages', true);\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(this.mediaTab.contentTab && this.canLoadMediaTab(this.mediaTab)/* && false */) {\r\n        //this.log('onScrolledBottom will load media');\r\n        this.load(true);\r\n      }\r\n    };\r\n    //this.scroll.attachSentinels(undefined, 400);\r\n\r\n    this.selectTab = horizontalMenu(this.tabsMenu, this.tabsContainer, (id, tabContent, animate) => {\r\n      if(this.prevTabId === id && !this.skipScroll) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.container, \r\n          position: 'start',\r\n          startCallback: this.scrollStartCallback\r\n        });\r\n        return;\r\n      }\r\n      \r\n      const newMediaTab = this.mediaTabs[id];\r\n      if(this.onChangeTab) {\r\n        this.onChangeTab(newMediaTab);\r\n      }\r\n      \r\n      const fromMediaTab = this.mediaTab;\r\n      this.mediaTab = newMediaTab;\r\n\r\n      if(this.prevTabId !== -1 && animate) {\r\n        this.onTransitionStart();\r\n      }\r\n\r\n      if(this.skipScroll) {\r\n        this.skipScroll = false;\r\n      } else {\r\n        const offsetTop = this.container.offsetTop;\r\n        let scrollTop = this.scrollable.scrollTop;\r\n        if(scrollTop < offsetTop) {\r\n          this.scrollable.scrollIntoViewNew({\r\n            element: this.container, \r\n            position: 'start',\r\n            startCallback: this.scrollStartCallback\r\n          });\r\n          scrollTop = offsetTop;\r\n        }\r\n        \r\n        fromMediaTab.scroll = {scrollTop: scrollTop, scrollHeight: this.scrollable.scrollHeight};\r\n  \r\n        if(newMediaTab.scroll === undefined) {\r\n          const rect = this.container.getBoundingClientRect();\r\n          const rect2 = this.container.parentElement.getBoundingClientRect();\r\n          const diff = rect.y - rect2.y;\r\n  \r\n          if(scrollTop > diff) {\r\n            newMediaTab.scroll = {scrollTop: diff, scrollHeight: 0};\r\n          }\r\n        }\r\n  \r\n        if(newMediaTab.scroll) {\r\n          const diff = fromMediaTab.scroll.scrollTop - newMediaTab.scroll.scrollTop;\r\n          //console.log('what you gonna do', this.goingHard, diff);\r\n  \r\n          //this.scrollable.scrollTop = scrollTop;\r\n          if(diff/*  && diff < 0 */) {\r\n            /* if(diff > -(fromMediaTab.contentTab.scrollHeight + this.nav.scrollHeight)) {\r\n              fromMediaTab.contentTab.style.transform = `translateY(${diff}px)`;\r\n              this.scrollable.scrollTop = scrollTop - diff;\r\n            } else { */\r\n              newMediaTab.contentTab.style.transform = `translateY(${diff}px)`;\r\n            //}\r\n          }\r\n        }\r\n      }\r\n      \r\n      /* if(this.prevTabId !== -1 && nav.offsetTop) {\r\n        this.scrollable.scrollTop -= nav.offsetTop;\r\n      } */\r\n\r\n      /* this.log('setVirtualContainer', id, this.sharedMediaSelected, this.sharedMediaSelected.childElementCount);\r\n      this.scroll.setVirtualContainer(this.sharedMediaSelected); */\r\n\r\n      if(this.prevTabId !== -1 && !newMediaTab.contentTab.childElementCount) { // quick brown fix\r\n        //this.contentContainer.classList.remove('loaded');\r\n        this.load(true);\r\n      }\r\n\r\n      this.prevTabId = id;\r\n    }, () => {\r\n      this.scrollable.onScroll();\r\n      \r\n      //console.log('what y', this.tabSelected.style.transform);\r\n      if(this.mediaTab.scroll !== undefined) {\r\n        this.mediaTab.contentTab.style.transform = '';\r\n        this.scrollable.scrollTop = this.mediaTab.scroll.scrollTop;\r\n      }\r\n\r\n      if(unlockScroll) {\r\n        unlockScroll();\r\n        unlockScroll = undefined;\r\n      }\r\n\r\n      this.onTransitionEnd();\r\n    }, undefined, navScrollable);\r\n\r\n    attachClickEvent(this.tabsContainer, (e) => {\r\n      if(this.selection.isSelecting) {\r\n        cancelEvent(e);\r\n        this.selection.toggleByElement(findUpClassName(e.target, 'search-super-item'));\r\n      }\r\n    }, {capture: true, passive: false});\r\n    \r\n    const onMediaClick = async(className: string, targetClassName: string, inputFilter: MyInputMessagesFilter, e: MouseEvent) => {\r\n      const target = findUpClassName(e.target as HTMLDivElement, className);\r\n      if(!target) return;\r\n      \r\n      const mid = +target.dataset.mid;\r\n      if(!mid) {\r\n        this.log.warn('no messageId by click on target:', target);\r\n        return;\r\n      }\r\n\r\n      const peerId = target.dataset.peerId.toPeerId();\r\n\r\n      const targets = (Array.from(this.tabs[inputFilter].querySelectorAll('.' + targetClassName)) as HTMLElement[]).map((el) => {\r\n        const containerEl = findUpClassName(el, className);\r\n        return {\r\n          element: el, \r\n          mid: +containerEl.dataset.mid, \r\n          peerId: containerEl.dataset.peerId.toPeerId()\r\n        };\r\n      });\r\n\r\n      //const ids = Object.keys(this.mediaDivsByIds).map((k) => +k).sort((a, b) => a - b);\r\n      const idx = targets.findIndex((item) => item.mid === mid && item.peerId === peerId);\r\n      \r\n      const message = await this.managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n      new AppMediaViewer()\r\n      .setSearchContext(this.copySearchContext(inputFilter))\r\n      .openMedia(message, targets[idx].element, 0, false, targets.slice(0, idx), targets.slice(idx + 1));\r\n    };\r\n\r\n    attachClickEvent(this.tabs.inputMessagesFilterPhotoVideo, onMediaClick.bind(null, 'grid-item', 'grid-item', 'inputMessagesFilterPhotoVideo'));\r\n    attachClickEvent(this.tabs.inputMessagesFilterDocument, onMediaClick.bind(null, 'document-with-thumb', 'media-container', 'inputMessagesFilterDocument'));\r\n\r\n    /* attachClickEvent(this.tabs.inputMessagesFilterUrl, (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if(target.tagName === 'A') {\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const a = findUpClassName(target, 'row').querySelector('.anchor-url:last-child') as HTMLAnchorElement;\r\n        a.click();\r\n      } catch(err) {}\r\n    }); */\r\n\r\n    this.mediaTab = this.mediaTabs[0];\r\n\r\n    useHeavyAnimationCheck(() => {\r\n      this.lazyLoadQueue.lock();\r\n    }, () => {\r\n      this.lazyLoadQueue.unlockAndRefresh(); // ! maybe not so efficient\r\n    });\r\n  }\r\n\r\n  private onTransitionStart = () => {\r\n    this.container.classList.add('sliding');\r\n  };\r\n\r\n  private onTransitionEnd = () => {\r\n    this.container.classList.remove('sliding');\r\n  };\r\n\r\n  public filterMessagesByType(messages: any[], type: SearchSuperType): MyMessage[] {\r\n    return filterMessagesByInputFilter(type, messages, messages.length);\r\n  }\r\n\r\n  private processEmptyFilter({message, searchGroup}: ProcessSearchSuperResult) {\r\n    const loadPromises: Promise<any>[] = [];\r\n    const {dom} = appDialogsManager.addDialogNew({\r\n      peerId: message.peerId, \r\n      container: searchGroup.list, \r\n      avatarSize: 54,\r\n      loadPromises\r\n    });\r\n\r\n    const setLastMessagePromise = appDialogsManager.setLastMessageN({\r\n      dialog: {\r\n        _: 'dialog',\r\n        peerId: message.peerId\r\n      } as any,  \r\n      lastMessage: message, \r\n      dom, \r\n      highlightWord: this.searchContext.query\r\n    });\r\n\r\n    loadPromises.push(setLastMessagePromise);\r\n    return Promise.all(loadPromises);\r\n  }\r\n\r\n  private async processPhotoVideoFilter({message, promises, middleware}: ProcessSearchSuperResult) {\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('grid-item');\r\n    //this.log(message, photo);\r\n\r\n    let wrapped: Awaited<ReturnType<typeof wrapPhoto>>;\r\n    const size = choosePhotoSize(media, 200, 200);\r\n    if(media._ !== 'photo') {\r\n      wrapped = await (await wrapVideo({\r\n        doc: media,\r\n        message,\r\n        container: div,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        onlyPreview: true,\r\n        withoutPreloader: true,\r\n        noPlayButton: true,\r\n        size\r\n      })).thumb;\r\n    } else {\r\n      wrapped = await wrapPhoto({\r\n        photo: media,\r\n        message,\r\n        container: div,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        withoutPreloader: true,\r\n        noBlur: true,\r\n        size\r\n      });\r\n    }\r\n\r\n    [wrapped.images.thumb, wrapped.images.full].filter(Boolean).forEach((image) => {\r\n      image.classList.add('grid-item-media');\r\n    });\r\n\r\n    promises.push(wrapped.loadPromises.thumb);\r\n\r\n    return {element: div, message};\r\n  }\r\n\r\n  private async processDocumentFilter({message, inputFilter}: ProcessSearchSuperResult) {\r\n    const document = getMediaFromMessage(message) as Document.document;\r\n    const showSender = this.showSender || (['voice', 'round'] as MyDocument['type'][]).includes(document.type);\r\n\r\n    const div = await wrapDocument({\r\n      message,\r\n      withTime: !showSender,\r\n      fontWeight: 400,\r\n      voiceAsMusic: true,\r\n      showSender,\r\n      searchContext: this.copySearchContext(inputFilter),\r\n      lazyLoadQueue: this.lazyLoadQueue,\r\n      autoDownloadSize: 0\r\n    });\r\n\r\n    if((['audio', 'voice', 'round'] as MyDocument['type'][]).includes(document.type)) {\r\n      div.classList.add('audio-48');\r\n    }\r\n\r\n    return {message, element: div};\r\n  }\r\n\r\n  private async processUrlFilter({message, promises, middleware}: ProcessSearchSuperResult) {\r\n    let webpage = (message.media as MessageMedia.messageMediaWebPage)?.webpage as WebPage.webPage;\r\n\r\n    if(!webpage) {\r\n      const entity = message.totalEntities ? message.totalEntities.find((e: any) => e._ === 'messageEntityUrl' || e._ === 'messageEntityTextUrl') : null;\r\n      let url: string, display_url: string, sliced: string;\r\n\r\n      if(!entity) {\r\n        //this.log.error('NO ENTITY:', message);\r\n        const match = matchUrl(message.message);\r\n        if(!match) {\r\n          //this.log.error('NO ENTITY AND NO MATCH:', message);\r\n          return;\r\n        }\r\n\r\n        url = match[0];\r\n      } else {\r\n        sliced = message.message.slice(entity.offset, entity.offset + entity.length);\r\n      }\r\n\r\n      if(entity?._ === 'messageEntityTextUrl') {\r\n        url = entity.url;\r\n        //display_url = sliced;\r\n      } else {\r\n        url = url || sliced;\r\n      }\r\n\r\n      display_url = url;\r\n\r\n      const same = message.message === url;\r\n      if(!url.match(/^(ftp|http|https):\\/\\//)) {\r\n        display_url = 'https://' + url;\r\n        url = url.includes('@') ? url : 'https://' + url;\r\n      }\r\n\r\n      display_url = new URL(display_url).hostname;\r\n\r\n      webpage = {\r\n        _: 'webPage',\r\n        url,\r\n        display_url,\r\n        id: '',\r\n        hash: 0\r\n      };\r\n\r\n      if(!same) {\r\n        webpage.description = message.message;\r\n      }\r\n    }\r\n\r\n    let previewDiv = document.createElement('div');\r\n    previewDiv.classList.add('preview', 'row-media');\r\n    \r\n    //this.log('wrapping webpage', webpage);\r\n    \r\n    if(webpage.photo) {\r\n      const res = wrapPhoto({\r\n        container: previewDiv,\r\n        message: null,\r\n        photo: webpage.photo as Photo.photo,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        size: choosePhotoSize(webpage.photo as Photo.photo, 60, 60, false),\r\n        loadPromises: promises,\r\n        noBlur: true\r\n      });\r\n    } else {\r\n      previewDiv.classList.add('empty');\r\n      setInnerHTML(previewDiv, getAbbreviation(webpage.title || webpage.display_url || webpage.description || webpage.url, true));\r\n    }\r\n    \r\n    let title = wrapWebPageTitle(webpage);\r\n\r\n    const subtitleFragment = wrapWebPageDescription(webpage);\r\n    const aFragment = htmlToDocumentFragment(wrapRichText(webpage.url || ''));\r\n    const a = aFragment.firstElementChild;\r\n    if(a instanceof HTMLAnchorElement) {\r\n      try { // can have 'URIError: URI malformed'\r\n        a.innerText = decodeURIComponent(a.href);\r\n      } catch(err) {\r\n\r\n      }\r\n    }\r\n\r\n    if(subtitleFragment.firstChild) {\r\n      subtitleFragment.append('\\n');\r\n    }\r\n\r\n    subtitleFragment.append(a);\r\n\r\n    if(this.showSender) {\r\n      subtitleFragment.append('\\n', await wrapSenderToPeer(message));\r\n    }\r\n    \r\n    if(!title.textContent) {\r\n      //title = new URL(webpage.url).hostname;\r\n      title.append(wrapPlainText(webpage.display_url.split('/', 1)[0]));\r\n    }\r\n\r\n    const row = new Row({\r\n      title,\r\n      titleRight: wrapSentTime(message),\r\n      subtitle: subtitleFragment,\r\n      havePadding: true,\r\n      clickable: true,\r\n      noRipple: true\r\n    });\r\n\r\n    /* const mediaDiv = document.createElement('div');\r\n    mediaDiv.classList.add('row-media'); */\r\n\r\n    row.container.append(previewDiv);\r\n    \r\n    /* ripple(div);\r\n    div.append(previewDiv);\r\n    div.insertAdjacentHTML('beforeend', `\r\n    <div class=\"title\">${title}${titleAdditionHTML}</div>\r\n    <div class=\"subtitle\">${subtitle}</div>\r\n    <div class=\"url\">${url}</div>\r\n    ${sender}\r\n    `); */\r\n    \r\n    if(row.container.innerText.trim().length) {\r\n      return {message, element: row.container};\r\n    }\r\n  }\r\n  \r\n  public async performSearchResult(messages: any[], mediaTab: SearchSuperMediaTab, append = true) {\r\n    const elemsToAppend: {element: HTMLElement, message: any}[] = [];\r\n    const sharedMediaDiv: HTMLElement = mediaTab.contentTab;\r\n    const promises: Promise<any>[] = [];\r\n    const middleware = this.middleware.get();\r\n    let inputFilter = mediaTab.inputFilter;\r\n\r\n    await getHeavyAnimationPromise();\r\n    \r\n    let searchGroup: SearchGroup;\r\n    if(inputFilter === 'inputMessagesFilterPhotoVideo' && !!this.searchContext.query.trim()) {\r\n      inputFilter = 'inputMessagesFilterEmpty';\r\n      searchGroup = this.searchGroupMedia;\r\n      sharedMediaDiv.append(searchGroup.container);\r\n    } else if(inputFilter === 'inputMessagesFilterEmpty') {\r\n      searchGroup = this.searchGroups.messages;\r\n    }\r\n\r\n    const options: ProcessSearchSuperResult = {\r\n      elemsToAppend,\r\n      inputFilter,\r\n      message: undefined,\r\n      middleware,\r\n      promises,\r\n      searchGroup\r\n    };\r\n\r\n    let processCallback: (options: ProcessSearchSuperResult) => any;\r\n\r\n    // https://core.telegram.org/type/MessagesFilter\r\n    switch(inputFilter) {\r\n      case 'inputMessagesFilterEmpty': {\r\n        processCallback = this.processEmptyFilter;\r\n        break;\r\n      }\r\n\r\n      case 'inputMessagesFilterPhotoVideo': {\r\n        processCallback = this.processPhotoVideoFilter;\r\n        break;\r\n      }\r\n      \r\n      case 'inputMessagesFilterVoice':\r\n      case 'inputMessagesFilterRoundVoice':\r\n      case 'inputMessagesFilterMusic':\r\n      case 'inputMessagesFilterDocument': {\r\n        processCallback = this.processDocumentFilter;\r\n        break;\r\n      }\r\n      \r\n      case 'inputMessagesFilterUrl': {\r\n        processCallback = this.processUrlFilter;\r\n        break;\r\n      }\r\n\r\n      default:\r\n        //this.log.warn('death is my friend', messages);\r\n        break;\r\n    }\r\n\r\n    if(processCallback) {\r\n      processCallback = processCallback.bind(this);\r\n\r\n      type K = {element: HTMLElement, message: Message.message | Message.messageService};\r\n      const results: (Promise<K> | K)[] = messages.map(async(message) => {\r\n        try {\r\n          options.message = message;\r\n          return await processCallback(options);\r\n        } catch(err) {\r\n          this.log.error('error rendering filter', inputFilter, options, message, err);\r\n        }\r\n      });\r\n\r\n      const awaited = (await Promise.all(results)).filter(Boolean);\r\n      elemsToAppend.push(...awaited.filter(Boolean));\r\n    }\r\n    \r\n    if(searchGroup && searchGroup.list.childElementCount) {\r\n      searchGroup.setActive();\r\n    }\r\n\r\n    if(this.loadMutex) {\r\n      promises.push(this.loadMutex);\r\n    }\r\n\r\n    if(promises.length) {\r\n      await Promise.all(promises);\r\n      if(!middleware()) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n    }\r\n    \r\n    if(elemsToAppend.length) {\r\n      const method = append ? 'append' : 'prepend';\r\n      elemsToAppend.forEach((details) => {\r\n        const {element, message} = details;\r\n        const monthContainer = this.getMonthContainerByTimestamp(this.groupByMonth ? message.date : 0, inputFilter);\r\n        element.classList.add('search-super-item');\r\n        element.dataset.mid = '' + message.mid;\r\n        element.dataset.peerId = '' + message.peerId;\r\n        monthContainer.items[method](element);\r\n\r\n        if(this.selection.isSelecting) {\r\n          this.selection.toggleElementCheckbox(element, true);\r\n        }\r\n      });\r\n    }\r\n    \r\n    //if(type !== 'inputMessagesFilterEmpty') {\r\n      this.afterPerforming(inputFilter === 'inputMessagesFilterEmpty' ? 1 : messages.length, sharedMediaDiv);\r\n    //}\r\n  }\r\n\r\n  private afterPerforming(length: number, contentTab: HTMLElement) {\r\n    if(contentTab) {\r\n      const parent = contentTab.parentElement;\r\n      Array.from(parent.children).slice(1).forEach((child) => {\r\n        child.remove();\r\n      });\r\n\r\n      //this.contentContainer.classList.add('loaded');\r\n\r\n      if(!length && !contentTab.childElementCount) {\r\n        const div = document.createElement('div');\r\n        div.innerText = 'Nothing interesting here yet...';\r\n        div.classList.add('position-center', 'text-center', 'content-empty', 'no-select');\r\n\r\n        parent.append(div);\r\n      }\r\n    }\r\n  }\r\n\r\n  private loadChats() {\r\n    const renderedPeerIds: Set<PeerId> = new Set();\r\n    const middleware = this.middleware.get();\r\n\r\n    for(let i in this.searchGroups) {\r\n      const group = this.searchGroups[i as SearchGroupType];\r\n      this.tabs.inputMessagesFilterEmpty.append(group.container);\r\n      group.clear();\r\n    }\r\n\r\n    const query = this.searchContext.query;\r\n    if(query) {\r\n      const setResults = (results: PeerId[], group: SearchGroup, showMembersCount = false) => {\r\n        results.map((peerId) => {\r\n          if(renderedPeerIds.has(peerId)) {\r\n            return;\r\n          }\r\n  \r\n          renderedPeerIds.add(peerId);\r\n  \r\n          const {dom} = appDialogsManager.addDialogNew({\r\n            peerId: peerId, \r\n            container: group.list, \r\n            avatarSize: 48,\r\n            autonomous: group.autonomous\r\n          });\r\n\r\n          return {dom, peerId};\r\n        }).forEach(async({dom, peerId}) => {\r\n          const peer = await this.managers.appPeersManager.getPeer(peerId);\r\n          if(showMembersCount && (peer.participants_count || peer.participants)) {\r\n            const regExp = new RegExp(`(${escapeRegExp(query)}|${escapeRegExp(cleanSearchText(query))})`, 'gi');\r\n            dom.titleSpan.innerHTML = dom.titleSpan.innerHTML.replace(regExp, '<i>$1</i>');\r\n            dom.lastMessageSpan.append(await getChatMembersString(peerId.toChatId()));\r\n          } else if(peerId === rootScope.myId) {\r\n            dom.lastMessageSpan.append(i18n('Presence.YourChat'));\r\n          } else {\r\n            let username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n            if(!username) {\r\n              const user = await this.managers.appUsersManager.getUser(peerId);\r\n              if(user && user.phone) {\r\n                username = '+' + formatPhoneNumber(user.phone).formatted;\r\n              }\r\n            } else {\r\n              username = '@' + username;\r\n            }\r\n  \r\n            dom.lastMessageSpan.innerHTML = '<i>' + username + '</i>';\r\n          }\r\n        });\r\n  \r\n        group.toggle();\r\n      };\r\n  \r\n      const onLoad = <T>(arg: T) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n  \r\n        //this.loadedContacts = true;\r\n  \r\n        return arg;\r\n      };\r\n  \r\n      return Promise.all([\r\n        this.managers.appUsersManager.getContactsPeerIds(query, true)\r\n        .then(onLoad)\r\n        .then((contacts) => {\r\n          if(contacts) {\r\n            setResults(contacts, this.searchGroups.contacts, true);\r\n          }\r\n        }),\r\n  \r\n        this.managers.appUsersManager.searchContacts(query, 20)\r\n        .then(onLoad)\r\n        .then((contacts) => {\r\n          if(contacts) {\r\n            setResults(contacts.my_results, this.searchGroups.contacts, true);\r\n            setResults(contacts.results/* .concat(contacts.results, contacts.results, contacts.results) */, this.searchGroups.globalContacts);\r\n\r\n            this.searchGroups.globalContacts.container.classList.add('is-short');\r\n\r\n            if(this.searchGroups.globalContacts.nameEl.lastElementChild !== this.searchGroups.globalContacts.nameEl.firstElementChild) {\r\n              this.searchGroups.globalContacts.nameEl.lastElementChild.remove();\r\n            }\r\n            \r\n            if(this.searchGroups.globalContacts.list.childElementCount > 3) {\r\n              const showMore = document.createElement('div');\r\n              showMore.classList.add('search-group__show-more');\r\n              const intlElement = new I18n.IntlElement({\r\n                key: 'Separator.ShowMore'\r\n              });\r\n              showMore.append(intlElement.element);\r\n              this.searchGroups.globalContacts.nameEl.append(showMore);\r\n              attachClickEvent(showMore, () => {\r\n                const isShort = this.searchGroups.globalContacts.container.classList.toggle('is-short');\r\n                intlElement.key = isShort ? 'Separator.ShowMore' : 'Separator.ShowLess';\r\n                intlElement.update();\r\n              });\r\n            }\r\n          }\r\n        }),\r\n  \r\n        this.managers.appMessagesManager.getConversations(query, 0, 20, 0)\r\n        .then(onLoad)\r\n        .then((value) => {\r\n          if(value) {\r\n            setResults(value.dialogs.map((d) => d.peerId), this.searchGroups.contacts, true);\r\n          }\r\n        })\r\n      ]);\r\n    } else if(!this.searchContext.peerId && !this.searchContext.minDate) {\r\n      const renderRecentSearch = (setActive = true) => {\r\n        return apiManagerProxy.getState().then((state) => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n    \r\n          this.searchGroups.recent.list.innerHTML = '';\r\n    \r\n          state.recentSearch.slice(0, 20).forEach(async(peerId) => {\r\n            let {dom} = appDialogsManager.addDialogNew({\r\n              peerId: peerId,\r\n              container: this.searchGroups.recent.list,\r\n              meAsSaved: true,\r\n              avatarSize: 48,\r\n              autonomous: true\r\n            });\r\n    \r\n            dom.lastMessageSpan.append(await (peerId.isUser() ? \r\n              getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId())) : \r\n              getChatMembersString(peerId.toChatId())));\r\n          });\r\n    \r\n          if(!state.recentSearch.length) {\r\n            this.searchGroups.recent.clear();\r\n          } else if(setActive) {\r\n            this.searchGroups.recent.setActive();\r\n          }\r\n        });\r\n      };\r\n\r\n      return Promise.all([\r\n        this.managers.appUsersManager.getTopPeers('correspondents').then((peers) => {\r\n          if(!middleware()) return;\r\n\r\n          const idx = peers.findIndex((peer) => peer.id === rootScope.myId);\r\n          if(idx !== -1) {\r\n            peers = peers.slice();\r\n            peers.splice(idx, 1);\r\n          }\r\n          //console.log('got top categories:', categories);\r\n          if(peers.length) {\r\n            peers.forEach((peer) => {\r\n              appDialogsManager.addDialogNew({\r\n                peerId: peer.id, \r\n                container: this.searchGroups.people.list, \r\n                onlyFirstName: true,\r\n                avatarSize: 54,\r\n                autonomous: false\r\n              });\r\n            });\r\n          }\r\n    \r\n          this.searchGroups.people.setActive();\r\n        }),\r\n\r\n        renderRecentSearch()\r\n      ]);\r\n    } else return Promise.resolve();\r\n  }\r\n\r\n  private async loadMembers(mediaTab: SearchSuperMediaTab) {\r\n    const id = this.searchContext.peerId.toChatId();\r\n    const middleware = this.middleware.get();\r\n    let promise: Promise<void>;\r\n\r\n    const renderParticipants = async(participants: (ChatParticipant | ChannelParticipant)[]) => {\r\n      if(this.loadMutex) {\r\n        await this.loadMutex;\r\n\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n      }\r\n      \r\n      if(!this.membersList) {\r\n        this.membersList = new SortedUserList({\r\n          lazyLoadQueue: this.lazyLoadQueue, \r\n          rippleEnabled: false,\r\n          managers: this.managers\r\n        });\r\n        attachClickEvent(this.membersList.list, (e) => {\r\n          const li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n          if(!li) {\r\n            return;\r\n          }\r\n\r\n          const peerId = li.dataset.peerId.toPeerId();\r\n          let promise: Promise<any> = Promise.resolve();\r\n          if(mediaSizes.isMobile) {\r\n            promise = appSidebarRight.toggleSidebar(false);\r\n          }\r\n          \r\n          promise.then(() => {\r\n            appImManager.setInnerPeer({peerId});\r\n          });\r\n        });\r\n        mediaTab.contentTab.append(this.membersList.list);\r\n        this.afterPerforming(1, mediaTab.contentTab);\r\n      }\r\n\r\n      for(const participant of participants) {\r\n        const peerId = getParticipantPeerId(participant);\r\n        if(peerId.isAnyChat()) {\r\n          continue;\r\n        }\r\n\r\n        const user = await this.managers.appUsersManager.getUser(peerId);\r\n        if(user.pFlags.deleted) {\r\n          continue;\r\n        }\r\n\r\n        this.membersList.add(peerId);\r\n      }\r\n    };\r\n\r\n    if(await this.managers.appChatsManager.isChannel(id)) {\r\n      const LOAD_COUNT = !this.membersList ? 50 : 200;\r\n      promise = this.managers.appProfileManager.getChannelParticipants(id, undefined, LOAD_COUNT, this.nextRates[mediaTab.inputFilter]).then((participants) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        let list = mediaTab.contentTab.firstElementChild as HTMLUListElement;\r\n        this.nextRates[mediaTab.inputFilter] = (list ? list.childElementCount : 0) + participants.participants.length;\r\n\r\n        if(participants.participants.length < LOAD_COUNT) {\r\n          this.loaded[mediaTab.inputFilter] = true;\r\n        }\r\n\r\n        return renderParticipants(participants.participants);\r\n      });\r\n    } else {\r\n      promise = this.managers.appProfileManager.getChatFull(id).then((chatFull) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        //console.log('anymore', chatFull);\r\n        this.loaded[mediaTab.inputFilter] = true;\r\n        const participants = (chatFull as ChatFull.chatFull).participants;\r\n        if(participants._ === 'chatParticipantsForbidden') {\r\n          return;\r\n        }\r\n        \r\n        return renderParticipants(participants.participants);\r\n      });\r\n    }\r\n\r\n    return this.loadPromises[mediaTab.inputFilter] = promise.finally(() => { \r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      this.loadPromises[mediaTab.inputFilter] = null;\r\n    });\r\n  }\r\n\r\n  private loadType(mediaTab: SearchSuperMediaTab, justLoad: boolean, loadCount: number, middleware: () => boolean) {\r\n    const type = mediaTab.inputFilter;\r\n\r\n    if(this.loadPromises[type]) {\r\n      return this.loadPromises[type];\r\n    }\r\n\r\n    if(mediaTab.type === 'members') {\r\n      return this.loadMembers(mediaTab);\r\n    }\r\n\r\n    const history = this.historyStorage[type] ?? (this.historyStorage[type] = []);\r\n\r\n    if(type === 'inputMessagesFilterEmpty' && !history.length) {\r\n      if(!this.loadedChats) {\r\n        this.loadChats();\r\n        this.loadedChats = true;\r\n      }\r\n\r\n      if(!this.searchContext.query.trim() && !this.searchContext.peerId && !this.searchContext.minDate) {\r\n        this.loaded[type] = true;\r\n        return Promise.resolve();\r\n      }\r\n    }\r\n\r\n    const promise = this.loadPromises[type] = Promise.resolve().then(async() => {\r\n      // render from cache\r\n      if(history.length && this.usedFromHistory[type] < history.length && !justLoad) {\r\n        let messages: any[] = [];\r\n        let used = Math.max(0, this.usedFromHistory[type]);\r\n        let slicedLength = 0;\r\n\r\n        do {\r\n          let ids = history.slice(used, used + loadCount);\r\n          used += ids.length;\r\n          slicedLength += ids.length;\r\n\r\n          const notFilteredMessages = await Promise.all(ids.map((m) => this.managers.appMessagesManager.getMessageByPeer(m.peerId, m.mid)));\r\n\r\n          messages.push(...this.filterMessagesByType(notFilteredMessages, type));\r\n        } while(slicedLength < loadCount && used < history.length);\r\n        \r\n        // если перебор\r\n        /* if(slicedLength > loadCount) {\r\n          let diff = messages.length - loadCount;\r\n          messages = messages.slice(0, messages.length - diff);\r\n          used -= diff;\r\n        } */\r\n\r\n        this.usedFromHistory[type] = used;\r\n        //if(messages.length) {\r\n          return this.performSearchResult(messages, mediaTab).finally(() => {\r\n            setTimeout(() => {\r\n              this.scrollable.checkForTriggers();\r\n            }, 0);\r\n          });\r\n        //}\r\n      }\r\n      \r\n      let maxId = history.length ? history[history.length - 1].mid : 0;\r\n\r\n      const value = await this.managers.appMessagesManager.getSearch({\r\n        ...this.searchContext,\r\n        inputFilter: {_: type},\r\n        maxId, \r\n        limit: loadCount,\r\n        nextRate: this.nextRates[type] ??= 0\r\n      });\r\n\r\n      history.push(...value.history.map((m) => ({mid: m.mid, peerId: m.peerId})));\r\n\r\n      if(!middleware()) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n\r\n      // ! Фикс случая, когда не загружаются документы при открытой панели разработчиков (происходит из-за того, что не совпадают критерии отбора документов в getSearch)\r\n      if(value.history.length < loadCount || (this.searchContext.folderId !== undefined && !value.next_rate) || value.history.length === value.count) {\r\n      //if((value.count || history.length === value.count) && history.length >= value.count) {\r\n        //this.log(logStr + 'loaded all media', value, loadCount);\r\n        this.loaded[type] = true;\r\n      }\r\n\r\n      this.nextRates[type] = value.next_rate;\r\n\r\n      if(justLoad) {\r\n        return;\r\n      }\r\n\r\n      this.usedFromHistory[type] = history.length;\r\n\r\n      if(!this.loaded[type]) {\r\n        promise.then(() => {\r\n          setTimeout(() => {\r\n            if(!middleware()) return;\r\n            //this.log('will preload more');\r\n            if(this.mediaTab === mediaTab) {\r\n              const promise = this.load(true, true);\r\n              if(promise) {\r\n                promise.then(() => {\r\n                  if(!middleware()) return;\r\n                  //this.log('preloaded more');\r\n                  setTimeout(() => {\r\n                    this.scrollable.checkForTriggers();\r\n                  }, 0);\r\n                });\r\n              }\r\n            }\r\n          }, 0);\r\n        });\r\n      }\r\n\r\n      //if(value.history.length) {\r\n        return this.performSearchResult(this.filterMessagesByType(value.history, type), mediaTab);\r\n      //}\r\n    }).catch((err) => {\r\n      this.log.error('load error:', err);\r\n    }).finally(() => {\r\n      this.loadPromises[type] = null;\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private canLoadMediaTab(mediaTab: SearchSuperMediaTab) {\r\n    const inputFilter = mediaTab.inputFilter;\r\n    return !this.loaded[inputFilter] || (this.historyStorage[inputFilter] && this.usedFromHistory[inputFilter] < this.historyStorage[inputFilter].length);\r\n  }\r\n\r\n  private async loadFirstTime() {\r\n    const middleware = this.middleware.get();\r\n    const peerId = this.searchContext.peerId;\r\n    if(!this.hideEmptyTabs) {\r\n      return;\r\n    }\r\n\r\n    const mediaTabs = this.mediaTabs.filter((mediaTab) => mediaTab.inputFilter !== 'inputMessagesFilterEmpty');\r\n    const filters = mediaTabs.map((mediaTab) => ({_: mediaTab.inputFilter}));\r\n\r\n    const [counters, canViewMembers] = await Promise.all([\r\n      this.managers.appMessagesManager.getSearchCounters(peerId, filters),\r\n      this.canViewMembers()\r\n    ]);\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    if(this.loadMutex) {\r\n      await this.loadMutex;\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    let firstMediaTab: SearchSuperMediaTab;\r\n    let count = 0;\r\n    mediaTabs.forEach((mediaTab) => {\r\n      const counter = counters.find((c) => c.filter._ === mediaTab.inputFilter);\r\n\r\n      mediaTab.menuTab.classList.toggle('hide', !counter.count);\r\n      mediaTab.menuTab.classList.remove('active');\r\n      //mediaTab.contentTab.classList.toggle('hide', !counter.count);\r\n\r\n      if(counter.count) {\r\n        if(firstMediaTab === undefined) {\r\n          firstMediaTab = mediaTab;\r\n        }\r\n\r\n        ++count;\r\n      }\r\n    });\r\n\r\n    const membersTab = this.mediaTabsMap.get('members');\r\n    membersTab.menuTab.classList.toggle('hide', !canViewMembers);\r\n\r\n    if(canViewMembers) {\r\n      firstMediaTab = membersTab;\r\n    }\r\n\r\n    this.container.classList.toggle('hide', !firstMediaTab);\r\n    this.container.parentElement.classList.toggle('search-empty', !firstMediaTab);\r\n    if(firstMediaTab) {\r\n      this.skipScroll = true;\r\n      this.selectTab(this.mediaTabs.indexOf(firstMediaTab), false);\r\n      // firstMediaTab.menuTab.classList.add('active');\r\n\r\n      this.navScrollableContainer.classList.toggle('hide', count <= 1);\r\n    }\r\n  }\r\n  \r\n  public async load(single = false, justLoad = false) {\r\n    const peerId = this.searchContext.peerId;\r\n    this.log('load', single, peerId, this.loadPromises);\r\n    const middleware = this.middleware.get();\r\n\r\n    if(this.firstLoad) {\r\n      await (this.loadFirstTimePromise ??= this.loadFirstTime());\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      this.loadFirstTimePromise = undefined;\r\n      this.firstLoad = false;\r\n    }\r\n    \r\n    let toLoad = single ? [this.mediaTab] : this.mediaTabs.filter((t) => t !== this.mediaTab);\r\n    toLoad = toLoad.filter((mediaTab) => {\r\n      return this.canLoadMediaTab(mediaTab);\r\n    });\r\n\r\n    if(peerId.isUser()) {\r\n      findAndSplice(toLoad, (mediaTab) => mediaTab.type === 'members');\r\n    }\r\n\r\n    if(!toLoad.length) {\r\n      return;\r\n    }\r\n\r\n    const loadCount = justLoad ? 50 : Math.round((windowSize.height / 130 | 0) * 3 * 1.25); // that's good for all types\r\n\r\n    const promises: Promise<any>[] = toLoad.map((mediaTab) => {\r\n      return this.loadType(mediaTab, justLoad, loadCount, middleware);\r\n    });\r\n\r\n    return Promise.all(promises).catch((err) => {\r\n      this.log.error('Load error all promises:', err);\r\n    });\r\n  }\r\n  \r\n  public getMonthContainerByTimestamp(timestamp: number, type: SearchSuperType) {\r\n    const date = new Date(timestamp * 1000);\r\n    date.setHours(0, 0, 0);\r\n    date.setDate(1);\r\n    const dateTimestamp = date.getTime();\r\n    const containers = this.monthContainers[type] ?? (this.monthContainers[type] = {});\r\n    if(!(dateTimestamp in containers)) {\r\n      const container = document.createElement('div');\r\n      container.className = 'search-super-month';\r\n\r\n      const name = document.createElement('div');\r\n      name.classList.add('search-super-month-name');\r\n\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        month: 'long'\r\n      };\r\n\r\n      if(date.getFullYear() !== new Date().getFullYear()) {\r\n        options.year = 'numeric';\r\n      }\r\n\r\n      const dateElement = new I18n.IntlDateElement({\r\n        date,\r\n        options\r\n      }).element;\r\n      name.append(dateElement);\r\n\r\n      container.append(name);\r\n\r\n      const items = document.createElement('div');\r\n      items.classList.add('search-super-month-items');\r\n\r\n      container.append(name, items);\r\n\r\n      const haveTimestamps = getObjectKeysAndSort(containers, 'desc');\r\n      let i = 0;\r\n      for(; i < haveTimestamps.length; ++i) {\r\n        const t = haveTimestamps[i];\r\n        if(dateTimestamp > t) {\r\n          break;\r\n        }\r\n      }\r\n      \r\n      containers[dateTimestamp] = {container, items};\r\n      positionElementByIndex(container, this.tabs[type], i);\r\n    }\r\n\r\n    return containers[dateTimestamp];\r\n  }\r\n\r\n  public canViewMembers() {\r\n    return Promise.all([\r\n      this.searchContext.peerId.isAnyChat(),\r\n      this.managers.appChatsManager.isBroadcast(this.searchContext.peerId.toChatId()),\r\n      this.managers.appChatsManager.hasRights(this.searchContext.peerId.toChatId(), 'view_participants')\r\n    ]).then(([isAnyChat, isBroadcast, hasRights]) => {\r\n      return isAnyChat && !isBroadcast && hasRights;\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.loadPromises = {};\r\n    this.loaded = {};\r\n    this.loadedChats = false;\r\n    this.nextRates = {};\r\n    this.firstLoad = true;\r\n    this.prevTabId = -1;\r\n\r\n    this.lazyLoadQueue.clear();\r\n\r\n    this.mediaTabs.forEach((mediaTab) => {\r\n      this.usedFromHistory[mediaTab.inputFilter] = -1;\r\n    });\r\n\r\n    if(this.selection.isSelecting) {\r\n      this.selection.cancelSelection();\r\n    }\r\n\r\n    // * must go to first tab (это костыль)\r\n    /* const membersTab = this.mediaTabsMap.get('members');\r\n    if(membersTab) {\r\n      const tab = this.canViewMembers() ? membersTab : this.mediaTabs[this.mediaTabs.indexOf(membersTab) + 1];\r\n      this.mediaTab = tab;\r\n    } */\r\n\r\n    this.middleware.clean();\r\n    this.loadFirstTimePromise = undefined;\r\n    this.cleanScrollPositions();\r\n    this.membersList = undefined;\r\n  }\r\n\r\n  public cleanScrollPositions() {\r\n    this.mediaTabs.forEach((mediaTab) => {\r\n      mediaTab.scroll = undefined;\r\n    });\r\n  }\r\n\r\n  public cleanupHTML(goFirst = false) {\r\n    if(this.urlsToRevoke.length) {\r\n      this.urlsToRevoke.forEach((url) => {\r\n        URL.revokeObjectURL(url);\r\n      });\r\n      this.urlsToRevoke.length = 0;\r\n    }\r\n\r\n    this.mediaTabs.forEach((tab) => {\r\n      tab.contentTab.innerHTML = '';\r\n\r\n      if(this.hideEmptyTabs) {\r\n        //tab.menuTab.classList.add('hide');\r\n        this.container.classList.add('hide');\r\n        this.container.parentElement.classList.add('search-empty');\r\n      }\r\n\r\n      if(tab.type === 'chats') {\r\n        return;\r\n      }\r\n      \r\n      if(!this.historyStorage[tab.inputFilter]) {\r\n        const parent = tab.contentTab.parentElement;\r\n        //if(!testScroll) {\r\n          if(!parent.querySelector('.preloader')) {\r\n            putPreloader(parent, true);\r\n          }\r\n        //}\r\n\r\n        const empty = parent.querySelector('.content-empty');\r\n        if(empty) {\r\n          empty.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    /* if(goFirst) {\r\n      const membersTab = this.mediaTabsMap.get('members');\r\n      if(membersTab) {\r\n        let idx = this.canViewMembers() ? 0 : 1;\r\n        membersTab.menuTab.classList.toggle('hide', idx !== 0);\r\n\r\n        this.selectTab(idx, false);\r\n      } else {\r\n        this.selectTab(0, false);\r\n      }\r\n    } */\r\n\r\n    this.monthContainers = {};\r\n    this.searchGroupMedia.clear();\r\n    this.scrollable.scrollTop = 0;\r\n\r\n    /* if(testScroll) {\r\n      for(let i = 0; i < 1500; ++i) {\r\n        let div = document.createElement('div');\r\n        div.insertAdjacentHTML('beforeend', `<img class=\"media-image\" src=\"assets/img/camomile.jpg\">`);\r\n        div.classList.add('grid-item');\r\n        div.dataset.id = '' + (i / 3 | 0);\r\n        //div.innerText = '' + (i / 3 | 0);\r\n        this.tabs.inputMessagesFilterPhotoVideo.append(div);\r\n      }\r\n    } */\r\n  }\r\n\r\n  private copySearchContext(newInputFilter: MyInputMessagesFilter) {\r\n    const context = copy(this.searchContext);\r\n    context.inputFilter = {_: newInputFilter};\r\n    context.nextRate = this.nextRates[newInputFilter];\r\n    return context;\r\n  }\r\n\r\n  public setQuery({peerId, query, threadId, historyStorage, folderId, minDate, maxDate}: {\r\n    peerId: PeerId, \r\n    query?: string, \r\n    threadId?: number, \r\n    historyStorage?: AppSearchSuper['historyStorage'], \r\n    folderId?: number,\r\n    minDate?: number,\r\n    maxDate?: number\r\n  }) {\r\n    this.searchContext = {\r\n      peerId,\r\n      query: query || '',\r\n      inputFilter: {_: this.mediaTab.inputFilter},\r\n      threadId,\r\n      folderId,\r\n      minDate,\r\n      maxDate\r\n    };\r\n    \r\n    this.historyStorage = historyStorage ?? {};\r\n\r\n    this.cleanup();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"./cancelEvent\";\r\n\r\nexport default function lockTouchScroll(container: HTMLElement) {\r\n  const onTouchMove = (e: TouchEvent) => {\r\n    cancelEvent(e);\r\n  };\r\n\r\n  let lockers = 2;\r\n  const cb = () => {\r\n    if(!--lockers) {\r\n      container.removeEventListener('touchmove', onTouchMove, {capture: true});\r\n    }\r\n  };\r\n\r\n  container.addEventListener('touchmove', onTouchMove, {capture: true, passive: false});\r\n  container.addEventListener('touchend', cb, {once: true});\r\n\r\n  return cb;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { AttachClickOptions, CLICK_EVENT_NAME } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\n\r\nconst ButtonMenuToggle = (\r\n  options: Partial<{\r\n    noRipple: true, \r\n    onlyMobile: true, \r\n    listenerSetter: ListenerSetter, \r\n    asDiv: boolean,\r\n    container: HTMLElement\r\n  }> = {}, \r\n  direction: 'bottom-left' | 'bottom-right' | 'top-left' | 'top-right', \r\n  buttons: ButtonMenuItemOptions[], \r\n  onOpen?: (e: Event) => void,\r\n  onClose?: () => void\r\n) => {\r\n  options.asDiv = true;\r\n  const button = options.container ?? ButtonIcon('more', options);\r\n  button.classList.add('btn-menu-toggle');\r\n\r\n  const btnMenu = ButtonMenu(buttons, options.listenerSetter);\r\n  btnMenu.classList.add(direction);\r\n  ButtonMenuToggleHandler(button, onOpen, options, onClose);\r\n  button.append(btnMenu);\r\n  return button;\r\n};\r\n\r\n// TODO: refactor for attachClickEvent, because if move finger after touchstart, it will start anyway\r\nconst ButtonMenuToggleHandler = (el: HTMLElement, onOpen?: (e: Event) => void | Promise<any>, options?: AttachClickOptions, onClose?: () => void) => {\r\n  const add = options?.listenerSetter ? options.listenerSetter.add(el) : el.addEventListener.bind(el);\r\n\r\n  //console.trace('ButtonMenuToggleHandler attach', el, onOpen, options);\r\n  add(CLICK_EVENT_NAME, (e: Event) => {\r\n    //console.log('ButtonMenuToggleHandler click', e);\r\n    if(!el.classList.contains('btn-menu-toggle')) return false;\r\n\r\n    //window.removeEventListener('mousemove', onMouseMove);\r\n    const openedMenu = el.querySelector('.btn-menu') as HTMLDivElement;\r\n    cancelEvent(e);\r\n\r\n    if(el.classList.contains('menu-open')) {\r\n      contextMenuController.closeBtnMenu();\r\n    } else {\r\n      const result = onOpen && onOpen(e);\r\n      const open = () => {\r\n        contextMenuController.openBtnMenu(openedMenu, onClose);\r\n      };\r\n\r\n      if(result instanceof Promise) {\r\n        result.then(open);\r\n      } else {\r\n        open();\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nexport { ButtonMenuToggleHandler };\r\nexport default ButtonMenuToggle;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PrivacyRule } from \"../../../../layer\";\r\nimport PrivacyType from \"./privacyType\";\r\n\r\nexport default function getPrivacyRulesDetails(rules: PrivacyRule[]) {\r\n  const types: PrivacyType[] = [];\r\n\r\n  type peers = {users: UserId[], chats: ChatId[]};\r\n  let allowPeers: peers = {users: [], chats: []}, disallowPeers: peers = {users: [], chats: []};\r\n  rules.forEach((rule) => {\r\n    switch(rule._) {\r\n      case 'privacyValueAllowAll':\r\n        types.push(2);\r\n        break;\r\n      case 'privacyValueDisallowAll':\r\n        types.push(0);\r\n        break;\r\n      case 'privacyValueAllowContacts': \r\n        types.push(1);\r\n        break;\r\n      /* case 'privacyValueDisallowContacts':\r\n        types.push('Except My Contacts');\r\n        break; */\r\n      case 'privacyValueAllowChatParticipants':\r\n        allowPeers.chats.push(...rule.chats);\r\n        break;\r\n      case 'privacyValueAllowUsers':\r\n        allowPeers.users.push(...rule.users);\r\n        break;\r\n      case 'privacyValueDisallowChatParticipants':\r\n        disallowPeers.chats.push(...rule.chats);\r\n        break;\r\n      case 'privacyValueDisallowUsers':\r\n        disallowPeers.users.push(...rule.users);\r\n        break;\r\n    }\r\n  });\r\n\r\n  return {type: types[0], disallowPeers, allowPeers};\r\n}\r\n","enum PrivacyType {\r\n  Everybody = 2,\r\n  Contacts = 1,\r\n  Nobody = 0\r\n}\r\n\r\nexport default PrivacyType;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { randomLong } from \"../helpers/random\";\r\nimport { InputPrivacyKey, InputPrivacyRule } from \"../layer\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getPrivacyRulesDetails from \"../lib/appManagers/utils/privacy/getPrivacyRulesDetails\";\r\nimport PrivacyType from \"../lib/appManagers/utils/privacy/privacyType\";\r\nimport { i18n, join, LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport RadioField from \"./radioField\";\r\nimport Row, { RadioFormFromRows } from \"./row\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { SettingSection, generateSection } from \"./sidebarLeft\";\r\nimport AppAddMembersTab from \"./sidebarLeft/tabs/addMembers\";\r\nimport { SliderSuperTabEventable } from \"./sliderTab\";\r\n\r\nexport type PrivacySectionStr = LangPackKey | '' | HTMLElement;\r\nexport default class PrivacySection {\r\n  public radioRows: Map<PrivacyType, Row>;\r\n  public radioSection: SettingSection;\r\n  public exceptions: Map<keyof PrivacySection['peerIds'], {\r\n    titleLangKey: LangPackKey,\r\n    key: keyof PrivacySection['peerIds'],\r\n    row: Row,\r\n    icon: string,\r\n    subtitleLangKey: LangPackKey,\r\n    clickable: true\r\n  }>;\r\n  public peerIds: {\r\n    disallow?: PeerId[],\r\n    allow?: PeerId[]\r\n  };\r\n  public type: PrivacyType;\r\n\r\n  constructor(public options: {\r\n    tab: SliderSuperTabEventable,\r\n    title: LangPackKey, \r\n    inputKey: InputPrivacyKey['_'], \r\n    captions?: [PrivacySectionStr, PrivacySectionStr, PrivacySectionStr],\r\n    appendTo?: Scrollable,\r\n    noExceptions?: boolean,\r\n    onRadioChange?: (value: number) => any,\r\n    skipTypes?: PrivacyType[],\r\n    exceptionTexts?: [LangPackKey, LangPackKey],\r\n    managers: AppManagers\r\n  }) {\r\n    if(options.captions) {\r\n      options.captions.reverse();\r\n    }\r\n\r\n    const managers = options.managers;\r\n\r\n    this.radioSection = new SettingSection({name: options.title, caption: true});\r\n\r\n    this.radioRows = new Map();\r\n\r\n    let r: Array<{type: PrivacyType, langKey: LangPackKey}> = [{\r\n      type: PrivacyType.Everybody,\r\n      langKey: 'PrivacySettingsController.Everbody'\r\n    }, {\r\n      type: PrivacyType.Contacts,\r\n      langKey: 'PrivacySettingsController.MyContacts'\r\n    }, {\r\n      type: PrivacyType.Nobody,\r\n      langKey: 'PrivacySettingsController.Nobody'\r\n    }];\r\n\r\n    if(options.skipTypes) {\r\n      r = r.filter((r) => !options.skipTypes.includes(r.type));\r\n    }\r\n    \r\n    const random = randomLong();\r\n    r.forEach(({type, langKey}) => {\r\n      const row = new Row({\r\n        radioField: new RadioField({\r\n          langKey, \r\n          name: random, \r\n          value: '' + type\r\n        })\r\n      });\r\n      \r\n      this.radioRows.set(type, row);\r\n    });\r\n\r\n    const form = RadioFormFromRows([...this.radioRows.values()], this.onRadioChange);\r\n\r\n    this.radioSection.content.append(form);\r\n    if(options.appendTo) {\r\n      options.appendTo.append(this.radioSection.container);\r\n    }\r\n\r\n    if(!options.noExceptions) {\r\n      const container = generateSection(options.appendTo, 'PrivacyExceptions', 'PrivacySettingsController.PeerInfo');\r\n\r\n      this.exceptions = new Map([[\r\n        'disallow', \r\n        {\r\n          titleLangKey: options.exceptionTexts[0],\r\n          key: 'disallow',\r\n          row: null,\r\n          icon: 'deleteuser',\r\n          subtitleLangKey: 'PrivacySettingsController.AddUsers',\r\n          clickable: true\r\n        }\r\n      ], [\r\n        'allow', \r\n        {\r\n          titleLangKey: options.exceptionTexts[1],\r\n          key: 'allow',\r\n          row: null,\r\n          icon: 'adduser',\r\n          subtitleLangKey: 'PrivacySettingsController.AddUsers',\r\n          clickable: true\r\n        }\r\n      ]]);\r\n\r\n      this.exceptions.forEach((exception) => {\r\n        exception.row = new Row(exception);\r\n\r\n        exception.row.container.addEventListener('click', () => {\r\n          promise.then(() => {\r\n            const _peerIds = this.peerIds[exception.key];\r\n            options.tab.slider.createTab(AppAddMembersTab).open({\r\n              type: 'privacy',\r\n              skippable: true,\r\n              title: exception.titleLangKey,\r\n              placeholder: 'PrivacyModal.Search.Placeholder',\r\n              takeOut: (newPeerIds) => {\r\n                _peerIds.length = 0;\r\n                _peerIds.push(...newPeerIds);\r\n                exception.row.subtitle.innerHTML = '';\r\n                exception.row.subtitle.append(...this.generateStr(this.splitPeersByType(newPeerIds)));\r\n              },\r\n              selectedPeerIds: _peerIds\r\n            });\r\n          });\r\n        });\r\n\r\n        container.append(exception.row.container);\r\n      });\r\n    }\r\n\r\n    /* setTimeout(() => {\r\n      this.setRadio(PrivacyType.Contacts);\r\n    }, 0); */\r\n\r\n    const promise = managers.appPrivacyManager.getPrivacy(options.inputKey).then((rules) => {\r\n      const details = getPrivacyRulesDetails(rules);\r\n      this.setRadio(details.type);\r\n\r\n      if(this.exceptions) {\r\n        this.peerIds = {};\r\n        ['allow' as const, 'disallow' as const].forEach((k) => {\r\n          const arr = [];\r\n          const from = k === 'allow' ? details.allowPeers : details.disallowPeers;\r\n          arr.push(...from.users.map((id) => id.toPeerId()));\r\n          arr.push(...from.chats.map((id) => id.toPeerId(true)));\r\n          this.peerIds[k] = arr;\r\n          const s = this.exceptions.get(k).row.subtitle;\r\n          s.innerHTML = '';\r\n          s.append(...this.generateStr(from));\r\n        });\r\n      }\r\n\r\n      options.tab.eventListener.addEventListener('destroy', async() => {\r\n        const rules: InputPrivacyRule[] = [];\r\n\r\n        switch(this.type) {\r\n          case PrivacyType.Everybody:\r\n            rules.push({_: 'inputPrivacyValueAllowAll'});\r\n            break;\r\n          case PrivacyType.Contacts:\r\n            rules.push({_: 'inputPrivacyValueAllowContacts'});\r\n            break;\r\n          case PrivacyType.Nobody:\r\n            rules.push({_: 'inputPrivacyValueDisallowAll'});\r\n            break;\r\n        }\r\n\r\n        if(this.exceptions) {\r\n          const a = ([\r\n            ['allow',     'inputPrivacyValueAllowChatParticipants',     'inputPrivacyValueAllowUsers'],\r\n            ['disallow',  'inputPrivacyValueDisallowChatParticipants',  'inputPrivacyValueDisallowUsers']\r\n          ] as Array<[\r\n            'allow' | 'disallow', \r\n            'inputPrivacyValueAllowChatParticipants' | 'inputPrivacyValueDisallowChatParticipants', \r\n            'inputPrivacyValueAllowUsers' | 'inputPrivacyValueDisallowUsers'\r\n          ]>);\r\n          for(const [k, chatKey, usersKey] of a) {\r\n            if(this.exceptions.get(k).row.container.classList.contains('hide')) {\r\n              return;\r\n            }\r\n\r\n            const _peerIds = this.peerIds[k];\r\n            if(_peerIds) {\r\n              const splitted = this.splitPeersByType(_peerIds);\r\n              if(splitted.chats.length) {\r\n                rules.push({_: chatKey, chats: splitted.chats});\r\n              }\r\n  \r\n              if(splitted.users.length) {\r\n                rules.push({\r\n                  _: usersKey, \r\n                  users: await Promise.all(splitted.users.map((id) => managers.appUsersManager.getUserInput(id)))\r\n                });\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        managers.appPrivacyManager.setPrivacy(options.inputKey, rules);\r\n      }, {once: true});\r\n    });\r\n  }\r\n\r\n  private onRadioChange = (value: string | PrivacySection['type']) => {\r\n    value = +value as PrivacySection['type'];\r\n    this.type = value;\r\n\r\n    const caption = this.options.captions[this.type];\r\n    const captionElement = this.radioSection.caption;\r\n    if(!caption) {\r\n      captionElement.innerHTML = '';\r\n    } else if(caption instanceof HTMLElement) {\r\n      replaceContent(captionElement, caption);\r\n    } else {\r\n      _i18n(captionElement, caption);\r\n    }\r\n    captionElement.classList.toggle('hide', !caption);\r\n\r\n    if(this.exceptions) {\r\n      this.exceptions.get('allow').row.container.classList.toggle('hide', this.type === PrivacyType.Everybody);\r\n      this.exceptions.get('disallow').row.container.classList.toggle('hide', this.type === PrivacyType.Nobody);\r\n    }\r\n\r\n    this.options.onRadioChange && this.options.onRadioChange(value);\r\n  };\r\n\r\n  public setRadio(type: PrivacySection['type']) {\r\n    const row = this.radioRows.get(type);\r\n    this.onRadioChange(type);\r\n    row.radioField.input.checked = true;\r\n  }\r\n  \r\n  private splitPeersByType(peerIds: PeerId[]) {\r\n    const peers = {users: [] as UserId[], chats: [] as ChatId[]};\r\n    peerIds.forEach((peerId) => {\r\n      peers[peerId.isAnyChat() ? 'chats' : 'users'].push(peerId.isAnyChat() ? peerId.toChatId() : peerId);\r\n    });\r\n\r\n    return peers;\r\n  }\r\n\r\n  private generateStr(peers: {users: UserId[], chats: ChatId[]}) {\r\n    if(!peers.users.length && !peers.chats.length) {\r\n      return [i18n('PrivacySettingsController.AddUsers')];\r\n    }\r\n\r\n    return join([\r\n      peers.users.length ? i18n('Users', [peers.users.length]) : null, \r\n      peers.chats.length ? i18n('Chats', [peers.chats.length]) : null\r\n    ].filter(Boolean), false);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { i18n, LangPackKey } from \"../../../../lib/langPack\";\r\nimport anchorCopy from \"../../../../helpers/dom/anchorCopy\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyPhoneNumberTab extends SliderSuperTabEventable {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-phone-number');\r\n    this.setTitle('PrivacyPhone');\r\n\r\n    const formatted = '+' + (await this.managers.appUsersManager.getSelf()).phone;\r\n    const captionEl = document.createElement('div');\r\n    captionEl.append(\r\n      i18n('PrivacyPhoneInfo'), \r\n      document.createElement('br'), \r\n      document.createElement('br'), \r\n      i18n('PrivacyPhoneInfo4'),\r\n      document.createElement('br'),\r\n      anchorCopy({\r\n        mePath: formatted\r\n      })\r\n    );\r\n\r\n    const phoneSection = new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyPhoneTitle',\r\n      inputKey: 'inputPrivacyKeyPhoneNumber',\r\n      captions: [captionEl, captionEl, ''],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      onRadioChange: (type) => {\r\n        s.setRadio(PrivacyType.Everybody);\r\n        s.radioSection.container.classList.toggle('hide', type !== PrivacyType.Nobody);\r\n      },\r\n      managers: this.managers\r\n    });\r\n\r\n    const sCaption: LangPackKey = 'PrivacyPhoneInfo3';\r\n    const s = new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyPhoneTitle2',\r\n      inputKey: 'inputPrivacyKeyAddedByPhone',\r\n      captions: [sCaption, sCaption, ''],\r\n      noExceptions: true,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n\r\n    this.scrollable.container.insertBefore(s.radioSection.container, phoneSection.radioSection.container.nextSibling);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { toastNew } from \"../../components/toast\";\r\nimport { copyTextToClipboard } from \"../clipboard\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport { attachClickEvent } from \"./clickEvent\";\r\n\r\nexport default function anchorCopy(options: Partial<{\r\n  // href: string,\r\n  mePath: string\r\n}> = {}) {\r\n  const anchor = document.createElement('a');\r\n  anchor.classList.add('anchor-copy');\r\n\r\n  if(options.mePath) {\r\n    const href = 'https://t.me/' + options.mePath;\r\n    anchor.href = anchor.innerText = href;\r\n  }\r\n\r\n  attachClickEvent(anchor, (e) => {\r\n    cancelEvent(e);\r\n    copyTextToClipboard(anchor.href);\r\n    toastNew({langPackKey: 'LinkCopied'});\r\n  });\r\n\r\n  return anchor;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport wrapSticker from \"./sticker\"\r\n\r\nexport default async function wrapStickerEmoji({emoji, div, width, height, managers = rootScope.managers}: {\r\n  emoji: string,\r\n  div: HTMLElement,\r\n  managers?: AppManagers,\r\n  width: number,\r\n  height: number\r\n}) {\r\n  const doc = await managers.appStickersManager.getAnimatedEmojiSticker(emoji);\r\n  if(!doc) {\r\n    div.classList.add('media-sticker-wrapper');\r\n    throw new Error('no sticker');\r\n  }\r\n\r\n  return wrapSticker({\r\n    doc,\r\n    div,\r\n    emoji,\r\n    width,\r\n    height,\r\n    loop: false,\r\n    play: true\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\nimport AppSettingsTab from \"../settings\";\r\n\r\nexport default class AppTwoStepVerificationSetTab extends SliderSuperTab {\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-set');\r\n    this.setTitle('TwoStepVerificationPasswordSet');\r\n\r\n    const section = new SettingSection({\r\n      caption: 'TwoStepVerificationPasswordSetInfo',\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '🥳';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      emoji,\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const btnReturn = Button('btn-primary btn-color-primary', {text: 'TwoStepVerificationPasswordReturnSettings'});\r\n\r\n    attachClickEvent(btnReturn, (e) => {\r\n      this.close();\r\n    });\r\n\r\n    this.slider.sliceTabsUntilTab(AppSettingsTab, this);\r\n\r\n    inputWrapper.append(btnReturn);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\n\r\nexport function canFocus(isFirstInput: boolean) {\r\n  return !IS_MOBILE_SAFARI || !isFirstInput;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport AppTwoStepVerificationSetTab from \"./passwordSet\";\r\nimport CodeInputField from \"../../../codeInputField\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport { i18n, _i18n } from \"../../../../lib/langPack\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../../helpers/dom/replaceContent\";\r\nimport toggleDisability from \"../../../../helpers/dom/toggleDisability\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationEmailConfirmationTab extends SliderSuperTab {\r\n  public codeInputField: CodeInputField;\r\n  public state: AccountPassword;\r\n  public email: string;\r\n  public length: number;\r\n  public isFirst = false;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-email-confirmation');\r\n    this.setTitle('TwoStepAuth.RecoveryTitle');\r\n\r\n    const section = new SettingSection({\r\n      caption: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    _i18n(section.caption, 'TwoStepAuth.ConfirmEmailCodeDesc', [this.email]);\r\n\r\n    const emoji = '📬';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.codeInputField = new CodeInputField({\r\n      name: 'recovery-email-code',\r\n      label: 'TwoStepAuth.RecoveryCode',\r\n      length: this.length,\r\n      onFill: (code) => {\r\n        freeze(true);\r\n        \r\n        this.managers.passwordManager.confirmPasswordEmail('' + code)\r\n        .then((value) => {\r\n          if(!value) {\r\n\r\n          }\r\n\r\n          goNext();\r\n        })\r\n        .catch((err) => {\r\n          switch(err.type) {\r\n            case 'CODE_INVALID':\r\n              inputField.input.classList.add('error');\r\n              replaceContent(inputField.label, i18n('TwoStepAuth.RecoveryCodeInvalid'));\r\n              break;\r\n\r\n            case 'EMAIL_HASH_EXPIRED':\r\n              inputField.input.classList.add('error');\r\n              replaceContent(inputField.label, i18n('TwoStepAuth.RecoveryCodeExpired'));\r\n              break;\r\n            \r\n            default:\r\n              console.error('confirm error', err);\r\n              break;\r\n          }\r\n\r\n          freeze(false);\r\n        });\r\n      }\r\n    });\r\n\r\n    const btnChange = Button('btn-primary btn-primary-transparent primary', {text: 'TwoStepAuth.EmailCodeChangeEmail'});\r\n    const btnResend = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'ResendCode'});\r\n\r\n    const goNext = () => {\r\n      this.slider.createTab(AppTwoStepVerificationSetTab).open();\r\n    };\r\n\r\n    const freeze = (disable: boolean) => {\r\n      toggleDisability([inputField.input, btnChange, btnResend], disable);\r\n    };\r\n\r\n    attachClickEvent(btnChange, (e) => {\r\n      freeze(true);\r\n      this.managers.passwordManager.cancelPasswordEmail().then((value) => {\r\n        this.slider.sliceTabsUntilTab(AppTwoStepVerificationEmailTab, this);\r\n        this.close();\r\n      }, () => {\r\n        freeze(false);\r\n      });\r\n    });\r\n\r\n    attachClickEvent(btnResend, (e) => {\r\n      freeze(true);\r\n      const d = putPreloader(btnResend);\r\n      this.managers.passwordManager.resendPasswordEmail().then((value) => {\r\n        d.remove();\r\n        freeze(false);\r\n      });\r\n    });\r\n\r\n    inputWrapper.append(inputField.container, btnChange, btnResend);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.codeInputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport InputField from \"../../../inputField\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport AppTwoStepVerificationSetTab from \"./passwordSet\";\r\nimport AppTwoStepVerificationEmailConfirmationTab from \"./emailConfirmation\";\r\nimport PopupPeer from \"../../../popups/peer\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport matchEmail from \"../../../../lib/richTextProcessor/matchEmail\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationEmailTab extends SliderSuperTab {\r\n  public inputField: InputField;\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n  public hint: string;\r\n  public isFirst = false;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-email');\r\n    this.setTitle('RecoveryEmailTitle');\r\n\r\n    const section = new SettingSection({\r\n      caption: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '💌';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.inputField = new InputField({\r\n      name: 'recovery-email',\r\n      label: 'RecoveryEmail',\r\n      plainText: true\r\n    });\r\n\r\n    inputField.input.addEventListener('keypress', (e) => {\r\n      if(e.key === 'Enter') {\r\n        cancelEvent(e);\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    inputField.input.addEventListener('input', (e) => {\r\n      inputField.input.classList.remove('error');\r\n    });\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n    const btnSkip = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'YourEmailSkip'});\r\n\r\n    const goNext = () => {\r\n      this.slider.createTab(AppTwoStepVerificationSetTab).open();\r\n    };\r\n\r\n    const onContinueClick = () => {\r\n      const email = inputField.value.trim();\r\n      const match = matchEmail(email);\r\n      if(!match || match[0].length !== email.length) {\r\n        inputField.input.classList.add('error');\r\n        return;\r\n      }\r\n\r\n      toggleButtons(true);\r\n      const d = putPreloader(btnContinue);\r\n\r\n      this.managers.passwordManager.updateSettings({\r\n        hint: this.hint,\r\n        currentPassword: this.plainPassword,\r\n        newPassword: this.newPassword,\r\n        email\r\n      }).then((value) => {\r\n        goNext();\r\n      }, (err) => {\r\n        if(err.type.includes('EMAIL_UNCONFIRMED')) {\r\n          const symbols = +err.type.match(/^EMAIL_UNCONFIRMED_(\\d+)/)[1];\r\n\r\n          const tab = this.slider.createTab(AppTwoStepVerificationEmailConfirmationTab);\r\n          tab.state = this.state;\r\n          tab.email = email;\r\n          tab.length = symbols;\r\n          tab.open();\r\n        } else {\r\n          console.log('password set error', err);\r\n        }\r\n\r\n        toggleButtons(false);\r\n        d.remove();\r\n      });\r\n    };\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    const toggleButtons = (freeze: boolean) => {\r\n      if(freeze) {\r\n        btnContinue.setAttribute('disabled', 'true');\r\n        btnSkip.setAttribute('disabled', 'true');\r\n      } else {\r\n        btnContinue.removeAttribute('disabled');\r\n        btnSkip.removeAttribute('disabled');\r\n      }\r\n    };\r\n\r\n    attachClickEvent(btnSkip, (e) => {\r\n      const popup = new PopupPeer('popup-skip-email', {\r\n        buttons: [{\r\n          langKey: 'Cancel',\r\n          isCancel: true\r\n        }, {\r\n          langKey: 'YourEmailSkip',\r\n          callback: () => {\r\n            //inputContent.classList.add('sidebar-left-section-disabled');\r\n            toggleButtons(true);\r\n            putPreloader(btnSkip);\r\n            this.managers.passwordManager.updateSettings({\r\n              hint: this.hint, \r\n              currentPassword: this.plainPassword,\r\n              newPassword: this.newPassword,\r\n              email: ''\r\n            }).then(() => {\r\n              goNext();\r\n            }, (err) => {\r\n              toggleButtons(false);\r\n            });\r\n          },\r\n          isDanger: true,\r\n        }], \r\n        titleLangKey: 'YourEmailSkipWarning',\r\n        descriptionLangKey: 'YourEmailSkipWarningText'\r\n      });\r\n\r\n      popup.show();\r\n    });\r\n\r\n    inputWrapper.append(inputField.container, btnContinue, btnSkip);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.inputField.input.focus();\r\n  }\r\n}\r\n","import { EMAIL_REG_EXP } from \".\";\r\n\r\nexport default function matchEmail(text: string) {\r\n  return !text ? null : text.match(EMAIL_REG_EXP);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport InputField from \"../../../inputField\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport { toast } from \"../../../toast\";\r\nimport I18n from \"../../../../lib/langPack\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationHintTab extends SliderSuperTab {\r\n  public inputField: InputField;\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-hint');\r\n    this.setTitle('TwoStepAuth.SetupHintTitle');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '💡';\r\n    const stickerContainer = document.createElement('div');\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.inputField = new InputField({\r\n      name: 'hint',\r\n      label: 'TwoStepAuth.SetupHintPlaceholder'\r\n    });\r\n\r\n    inputField.input.addEventListener('keypress', (e) => {\r\n      if(e.key === 'Enter') {\r\n        cancelEvent(e);\r\n        return inputField.value ? onContinueClick() : onSkipClick();\r\n      }\r\n    });\r\n\r\n    const goNext = (e?: Event, saveHint?: boolean) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n      \r\n      const hint = saveHint ? inputField.value : undefined;\r\n      if(hint && this.newPassword === hint) {\r\n        toast(I18n.format('PasswordAsHintError', true));\r\n        return;\r\n      }\r\n\r\n      const tab = this.slider.createTab(AppTwoStepVerificationEmailTab);\r\n      tab.state = this.state;\r\n      tab.plainPassword = this.plainPassword;\r\n      tab.newPassword = this.newPassword;\r\n      tab.hint = hint;\r\n\r\n      tab.open();\r\n    };\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n    const btnSkip = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'YourEmailSkip'});\r\n\r\n    const onContinueClick = (e?: Event) => goNext(e, true);\r\n    const onSkipClick = (e?: Event) => goNext(e, false);\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n    attachClickEvent(btnSkip, onSkipClick);\r\n\r\n    inputWrapper.append(inputField.container, btnContinue, btnSkip);\r\n\r\n    section.content.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.inputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport PasswordInputField from \"../../../passwordInputField\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport TrackingMonkey from \"../../../monkeys/tracking\";\r\nimport AppTwoStepVerificationHintTab from \"./hint\";\r\nimport { InputState } from \"../../../inputField\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\n\r\nexport default class AppTwoStepVerificationReEnterPasswordTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public passwordInputField: PasswordInputField;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-enter-password', 'two-step-verification-re-enter-password');\r\n    this.setTitle('PleaseReEnterPassword');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const passwordInputField = this.passwordInputField = new PasswordInputField({\r\n      name: 're-enter-password',\r\n      label: 'PleaseReEnterPassword'\r\n    });\r\n\r\n    const monkey = new TrackingMonkey(passwordInputField, 157);\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n\r\n    inputWrapper.append(passwordInputField.container, btnContinue);\r\n    section.content.append(monkey.container, inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n\r\n    passwordInputField.input.addEventListener('keypress', (e) => {\r\n      if(passwordInputField.input.classList.contains('error')) {\r\n        passwordInputField.setState(InputState.Neutral);\r\n      }\r\n  \r\n      if(e.key === 'Enter') {\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    const verifyInput = () => {\r\n      if(this.newPassword !== passwordInputField.value) {\r\n        passwordInputField.setError();\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    const onContinueClick = (e?: Event) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n\r\n      if(!verifyInput()) return;\r\n\r\n      const tab = this.slider.createTab(AppTwoStepVerificationHintTab);\r\n      tab.state = this.state;\r\n      tab.plainPassword = this.plainPassword;\r\n      tab.newPassword = this.newPassword;\r\n      tab.open();\r\n    };\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    return monkey.load();\r\n  }\r\n  \r\n  onOpenAfterTimeout() {\r\n    this.passwordInputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AppTwoStepVerificationTab from \".\";\r\nimport { SettingSection } from \"../..\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../../../helpers/dom/setInnerHTML\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport I18n, { i18n } from \"../../../../lib/langPack\";\r\nimport wrapEmojiText from \"../../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport Button from \"../../../button\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport PasswordMonkey from \"../../../monkeys/password\";\r\nimport PasswordInputField from \"../../../passwordInputField\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport AppTwoStepVerificationReEnterPasswordTab from \"./reEnterPassword\";\r\n\r\nexport default class AppTwoStepVerificationEnterPasswordTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public passwordInputField: PasswordInputField;\r\n  public plainPassword: string;\r\n  public isFirst = true;\r\n  \r\n  protected init() {\r\n    const isNew = !this.state.pFlags.has_password || this.plainPassword;\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-enter-password');\r\n    this.setTitle(isNew ? 'PleaseEnterFirstPassword' : 'PleaseEnterCurrentPassword');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const passwordInputField = this.passwordInputField = new PasswordInputField({\r\n      name: 'enter-password',\r\n      label: isNew ? 'PleaseEnterFirstPassword' : (this.state.hint ? undefined : 'LoginPassword'),\r\n      labelText: !isNew && this.state.hint ? wrapEmojiText(this.state.hint) : undefined\r\n    });\r\n\r\n    const monkey = new PasswordMonkey(passwordInputField, 157);\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary');\r\n    const textEl = new I18n.IntlElement({key: 'Continue'});\r\n\r\n    btnContinue.append(textEl.element);\r\n\r\n    inputWrapper.append(passwordInputField.container, btnContinue);\r\n    section.content.append(monkey.container, inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n\r\n    passwordInputField.input.addEventListener('keypress', (e) => {\r\n      if(passwordInputField.input.classList.contains('error')) {\r\n        passwordInputField.input.classList.remove('error');\r\n        textEl.key = 'Continue';\r\n        textEl.update();\r\n      }\r\n  \r\n      if(e.key === 'Enter') {\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    const verifyInput = () => {\r\n      if(!passwordInputField.value.length) {\r\n        passwordInputField.input.classList.add('error');\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    let onContinueClick: (e?: Event) => void;\r\n    if(!isNew) {\r\n      let getStateInterval: number;\r\n\r\n      let getState = () => {\r\n        // * just to check session relevance\r\n        if(!getStateInterval) {\r\n          getStateInterval = window.setInterval(getState, 10e3);\r\n        }\r\n  \r\n        return this.managers.passwordManager.getState().then((_state) => {\r\n          this.state = _state;\r\n  \r\n          if(this.state.hint) {\r\n            setInnerHTML(passwordInputField.label, wrapEmojiText(this.state.hint));\r\n          } else {\r\n            replaceContent(passwordInputField.label, i18n('LoginPassword'));\r\n          }\r\n        });\r\n      };\r\n  \r\n      const submit = (e?: Event) => {\r\n        if(!verifyInput()) {\r\n          cancelEvent(e);\r\n          return;\r\n        }\r\n\r\n        btnContinue.setAttribute('disabled', 'true');\r\n        textEl.key = 'PleaseWait';\r\n        textEl.update();\r\n        const preloader = putPreloader(btnContinue);\r\n  \r\n        const plainPassword = passwordInputField.value;\r\n        this.managers.passwordManager.check(passwordInputField.value, this.state).then((auth) => {\r\n          console.log(auth);\r\n  \r\n          if(auth._ === 'auth.authorization') {\r\n            clearInterval(getStateInterval);\r\n            if(monkey) monkey.remove();\r\n            const tab = this.slider.createTab(AppTwoStepVerificationTab);\r\n            tab.state = this.state;\r\n            tab.plainPassword = plainPassword;\r\n            tab.open();\r\n            this.slider.removeTabFromHistory(this);\r\n          }\r\n        }, (err) => {\r\n          btnContinue.removeAttribute('disabled');\r\n          passwordInputField.input.classList.add('error');\r\n          \r\n          switch(err.type) {\r\n            default:\r\n              //btnContinue.innerText = err.type;\r\n              textEl.key = 'TwoStepAuth.InvalidPassword';\r\n              textEl.update();\r\n              preloader.remove();\r\n              passwordInputField.select();\r\n              break;\r\n          }\r\n  \r\n          getState();\r\n        });\r\n      };\r\n  \r\n      onContinueClick = submit;\r\n\r\n      getState();\r\n    } else {\r\n      onContinueClick = (e) => {\r\n        if(e) {\r\n          cancelEvent(e);\r\n        }\r\n\r\n        if(!verifyInput()) return;\r\n\r\n        const tab = this.slider.createTab(AppTwoStepVerificationReEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.newPassword = passwordInputField.value;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.open();\r\n      };\r\n    }\r\n\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    return monkey.load();\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.passwordInputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport { _i18n } from \"../../../../lib/langPack\";\r\nimport Button from \"../../../button\";\r\nimport PopupPeer from \"../../../popups/peer\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\nimport AppSettingsTab from \"../settings\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport AppTwoStepVerificationEnterPasswordTab from \"./enterPassword\";\r\n\r\nexport default class AppTwoStepVerificationTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-main');\r\n    this.setTitle('TwoStepVerificationTitle');\r\n\r\n    const section = new SettingSection({\r\n      caption: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '🔐';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 168,\r\n      height: 168,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const c = section.generateContentElement();\r\n    if(this.state.pFlags.has_password) {\r\n      _i18n(section.caption, 'TwoStepAuth.GenericHelp');\r\n\r\n      const btnChangePassword = Button('btn-primary btn-transparent', {icon: 'edit', text: 'TwoStepAuth.ChangePassword'});\r\n      const btnDisablePassword = Button('btn-primary btn-transparent', {icon: 'passwordoff', text: 'TwoStepAuth.RemovePassword'});\r\n      const btnSetRecoveryEmail = Button('btn-primary btn-transparent', {icon: 'email', text: this.state.pFlags.has_recovery ? 'TwoStepAuth.ChangeEmail' : 'TwoStepAuth.SetupEmail'});\r\n\r\n      attachClickEvent(btnChangePassword, () => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.open();\r\n      });\r\n\r\n      attachClickEvent(btnDisablePassword, () => {\r\n        const popup = new PopupPeer('popup-disable-password', {\r\n          buttons: [{\r\n            langKey: 'Disable',\r\n            callback: () => {\r\n              this.managers.passwordManager.updateSettings({currentPassword: this.plainPassword}).then(() => {\r\n                this.slider.sliceTabsUntilTab(AppSettingsTab, this);\r\n                this.close();\r\n              });\r\n            },\r\n            isDanger: true,\r\n          }], \r\n          titleLangKey: 'TurnPasswordOffQuestionTitle',\r\n          descriptionLangKey: 'TurnPasswordOffQuestion'\r\n        });\r\n\r\n        popup.show();\r\n      });\r\n\r\n      attachClickEvent(btnSetRecoveryEmail, () => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEmailTab);\r\n        tab.state = this.state;\r\n        tab.hint = this.state.hint;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.newPassword = this.plainPassword;\r\n        tab.isFirst = true;\r\n        tab.open();\r\n      });\r\n\r\n      c.append(btnChangePassword, btnDisablePassword, btnSetRecoveryEmail);\r\n    } else {\r\n      _i18n(section.caption, 'TwoStepAuth.SetPasswordHelp');\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n\r\n      const btnSetPassword = Button('btn-primary btn-color-primary', {text: 'TwoStepVerificationSetPassword'});\r\n      \r\n      inputWrapper.append(btnSetPassword);\r\n      c.append(inputWrapper);\r\n\r\n      attachClickEvent(btnSetPassword, (e) => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.open();\r\n      });\r\n    }\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyLastSeenTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-last-seen');\r\n    this.setTitle('PrivacyLastSeen');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.LastSeenDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'LastSeenTitle',\r\n      inputKey: 'inputPrivacyKeyStatusTimestamp',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyProfilePhotoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-profile-photo');\r\n    this.setTitle('PrivacyProfilePhoto');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.ProfilePhoto.CustomHelp';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyProfilePhotoTitle',\r\n      inputKey: 'inputPrivacyKeyProfilePhoto',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyForwardMessagesTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-forward-messages');\r\n    this.setTitle('PrivacySettings.Forwards');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.Forwards.CustomHelp';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyForwardsTitle',\r\n      inputKey: 'inputPrivacyKeyForwards',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyAddToGroupsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-add-to-groups');\r\n    this.setTitle('PrivacySettings.Groups');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.GroupDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'WhoCanAddMe',\r\n      inputKey: 'inputPrivacyKeyChatInvite',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyCallsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-calls');\r\n    this.setTitle('PrivacySettings.VoiceCalls');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.PhoneCallDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'WhoCanCallMe',\r\n      inputKey: 'inputPrivacyKeyPhoneCall',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n\r\n    {\r\n      const caption: LangPackKey = 'PrivacySettingsController.P2p.Desc';\r\n      new PrivacySection({\r\n        tab: this,\r\n        title: 'PrivacyP2PHeader',\r\n        inputKey: 'inputPrivacyKeyPhoneP2P',\r\n        captions: [caption, caption, caption],\r\n        exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n        appendTo: this.scrollable,\r\n        managers: this.managers\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport Button from \"../../button\";\r\nimport Row from \"../../row\";\r\nimport { Authorization } from \"../../../layer\";\r\nimport { formatDateAccordingToTodayNew } from \"../../../helpers/date\";\r\nimport ButtonMenu from \"../../buttonMenu\";\r\nimport { toast } from \"../../toast\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport findAndSplice from \"../../../helpers/array/findAndSplice\";\r\nimport { attachContextMenuListener } from \"../../../helpers/dom/attachContextMenuListener\";\r\nimport positionMenu from \"../../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../../helpers/contextMenuController\";\r\n\r\nexport default class AppActiveSessionsTab extends SliderSuperTabEventable {\r\n  public authorizations: Authorization.authorization[];\r\n  private menuElement: HTMLElement;\r\n  \r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('active-sessions-container');\r\n    this.setTitle('SessionsTitle');\r\n\r\n    const Session = (auth: Authorization.authorization) => {\r\n      const row = new Row({\r\n        title: [auth.app_name, auth.app_version].join(' '),\r\n        subtitle: [auth.ip, auth.country].join(' - '),\r\n        clickable: true,\r\n        titleRight: auth.pFlags.current ? undefined : formatDateAccordingToTodayNew(new Date(Math.max(auth.date_active, auth.date_created) * 1000))\r\n      });\r\n\r\n      row.container.dataset.hash = '' + auth.hash;\r\n\r\n      const midtitle = document.createElement('div');\r\n      midtitle.classList.add('row-midtitle');\r\n      midtitle.innerHTML = [auth.device_model, auth.system_version || auth.platform].filter(Boolean).join(', ');\r\n\r\n      row.subtitle.parentElement.insertBefore(midtitle, row.subtitle);\r\n\r\n      return row;\r\n    };\r\n\r\n    const authorizations = this.authorizations.slice();\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'CurrentSession',\r\n        caption: 'ClearOtherSessionsHelp'\r\n      });\r\n\r\n      const auth = findAndSplice(authorizations, auth => auth.pFlags.current);\r\n      const session = Session(auth);\r\n\r\n      section.content.append(session.container);\r\n\r\n      if(authorizations.length) {\r\n        const btnTerminate = Button('btn-primary btn-transparent danger', {icon: 'stop', text: 'TerminateAllSessions'});\r\n        attachClickEvent(btnTerminate, (e) => {\r\n          new PopupPeer('revoke-session', {\r\n            buttons: [{\r\n              langKey: 'Terminate',\r\n              isDanger: true,\r\n              callback: () => {\r\n                const toggle = toggleDisability([btnTerminate], true);\r\n                this.managers.apiManager.invokeApi('auth.resetAuthorizations').then((value) => {\r\n                  //toggleDisability([btnTerminate], false);\r\n                  btnTerminate.remove();\r\n                  otherSection.container.remove();\r\n                }, onError).finally(() => {\r\n                  toggle();\r\n                });\r\n              }\r\n            }],\r\n            titleLangKey: 'AreYouSureSessionsTitle',\r\n            descriptionLangKey: 'AreYouSureSessions'\r\n          }).show();\r\n        });\r\n  \r\n        section.content.append(btnTerminate);\r\n      }\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    if(!authorizations.length) {\r\n      return;\r\n    }\r\n\r\n    const otherSection = new SettingSection({\r\n      name: 'OtherSessions',\r\n      caption: 'SessionsListInfo'\r\n    });\r\n\r\n    authorizations.forEach((auth) => {\r\n      otherSection.content.append(Session(auth).container);\r\n    });\r\n\r\n    this.scrollable.append(otherSection.container);\r\n\r\n    const onError = (err: any) => {\r\n      if(err.type === 'FRESH_RESET_AUTHORISATION_FORBIDDEN') {\r\n        toast(I18n.format('RecentSessions.Error.FreshReset', true));\r\n      }\r\n    };\r\n\r\n    let target: HTMLElement;\r\n    const onTerminateClick = () => {\r\n      const hash = target.dataset.hash;\r\n      \r\n      new PopupPeer('revoke-session', {\r\n        buttons: [{\r\n          langKey: 'Terminate',\r\n          isDanger: true,\r\n          callback: () => {\r\n            this.managers.apiManager.invokeApi('account.resetAuthorization', {hash})\r\n            .then((value) => {\r\n              if(value) {\r\n                target.remove();\r\n              }\r\n            }, onError);\r\n          }\r\n        }],\r\n        titleLangKey: 'AreYouSureSessionTitle',\r\n        descriptionLangKey: 'TerminateSessionText'\r\n      }).show();\r\n    };\r\n\r\n    const element = this.menuElement = ButtonMenu([{\r\n      icon: 'stop',\r\n      text: 'Terminate',\r\n      onClick: onTerminateClick\r\n    }]);\r\n    element.id = 'active-sessions-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    document.getElementById('page-chats').append(element);\r\n\r\n    attachContextMenuListener(this.scrollable.container, (e) => {\r\n      target = findUpClassName(e.target, 'row');\r\n      if(!target || target.dataset.hash === '0') {\r\n        return;\r\n      }\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      // smth\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      positionMenu(e, element);\r\n      contextMenuController.openBtnMenu(element);\r\n    });\r\n\r\n    attachClickEvent(this.scrollable.container, (e) => {\r\n      target = findUpClassName(e.target, 'row');\r\n      if(!target || target.dataset.hash === '0') {\r\n        return;\r\n      }\r\n\r\n      onTerminateClick();\r\n    });\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.menuElement) {\r\n      this.menuElement.remove();\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { SettingSection } from \"..\";\r\nimport ButtonMenu from \"../../buttonMenu\";\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../../../lib/appManagers/appDialogsManager\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport findUpTag from \"../../../helpers/dom/findUpTag\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport formatUserPhone from \"../../wrappers/formatUserPhone\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport { attachContextMenuListener } from \"../../../helpers/dom/attachContextMenuListener\";\r\nimport positionMenu from \"../../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../../helpers/contextMenuController\";\r\n\r\nexport default class AppBlockedUsersTab extends SliderSuperTab {\r\n  public peerIds: PeerId[];\r\n  private menuElement: HTMLElement;\r\n  \r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('blocked-users-container');\r\n    this.setTitle('BlockedUsers');\r\n\r\n    const section = new SettingSection({\r\n      caption: 'BlockedUsersInfo'\r\n    });\r\n\r\n    section.caption.parentElement.prepend(section.caption);\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    const btnAdd = ButtonCorner({icon: 'add', className: 'is-visible'});\r\n    this.content.append(btnAdd);\r\n\r\n    attachClickEvent(btnAdd, (e) => {\r\n      new PopupPickUser({\r\n        peerTypes: ['contacts'],\r\n        placeholder: 'BlockModal.Search.Placeholder',\r\n        onSelect: (peerId) => {\r\n          //console.log('block', peerId);\r\n          this.managers.appUsersManager.toggleBlock(peerId, true);\r\n        },\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const list = appDialogsManager.createChatList();\r\n    this.scrollable.container.classList.add('chatlist-container');\r\n    section.content.append(list);\r\n\r\n    const add = async(peerId: PeerId, append: boolean) => {\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: list,\r\n        rippleEnabled: true,\r\n        avatarSize: 48,\r\n        append\r\n      });\r\n\r\n      const user = await this.managers.appUsersManager.getUser(peerId);\r\n      if(user.pFlags.bot) {\r\n        dom.lastMessageSpan.append('@' + user.username);\r\n      } else {\r\n        if(user.phone) dom.lastMessageSpan.innerHTML = formatUserPhone(user.phone);\r\n        else dom.lastMessageSpan.append(user.username ? '@' + user.username : getUserStatusString(user));\r\n      }\r\n\r\n      //dom.titleSpan.innerHTML = 'Raaid El Syed';\r\n      //dom.lastMessageSpan.innerHTML = '+1 234 567891';\r\n    };\r\n\r\n    for(const peerId of this.peerIds) {\r\n      add(peerId, true);\r\n    }\r\n\r\n    let target: HTMLElement;\r\n    const onUnblock = () => {\r\n      const peerId = target.dataset.peerId.toPeerId();\r\n      this.managers.appUsersManager.toggleBlock(peerId, false);\r\n    };\r\n\r\n    const element = this.menuElement = ButtonMenu([{\r\n      icon: 'lockoff',\r\n      text: 'Unblock',\r\n      onClick: onUnblock,\r\n      options: {listenerSetter: this.listenerSetter}\r\n    }]);\r\n    element.id = 'blocked-users-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    document.getElementById('page-chats').append(element);\r\n\r\n    attachContextMenuListener(this.scrollable.container, (e) => {\r\n      target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      // smth\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      positionMenu(e, element);\r\n      contextMenuController.openBtnMenu(element);\r\n    }, this.listenerSetter);\r\n\r\n    this.listenerSetter.add(rootScope)('peer_block', (update) => {\r\n      const {peerId, blocked} = update;\r\n      const li = list.querySelector(`[data-peer-id=\"${peerId}\"]`);\r\n      if(blocked) {\r\n        if(!li) {\r\n          add(peerId, false);\r\n        }\r\n      } else {\r\n        if(li) {\r\n          li.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    const LOAD_COUNT = 50;\r\n    let loading = false;\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(loading) {\r\n        return;\r\n      }\r\n\r\n      loading = true;\r\n      this.managers.appUsersManager.getBlocked(list.childElementCount, LOAD_COUNT).then((res) => {\r\n        for(const peerId of res.peerIds) {\r\n          add(peerId, true);\r\n        }\r\n\r\n        if(res.peerIds.length < LOAD_COUNT || list.childElementCount === res.count) {\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n\r\n        this.scrollable.checkForTriggers();\r\n      }).finally(() => {\r\n        loading = false;\r\n      });\r\n    };\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.menuElement) {\r\n      this.menuElement.remove();\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","export default function convertKeyToInputKey(key: string) {\r\n  key = key[0].toUpperCase() + key.slice(1);\r\n  key = 'input' + key;\r\n  return key;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport { AccountPassword, Authorization, InputPrivacyKey, Updates } from \"../../../layer\";\r\nimport AppPrivacyPhoneNumberTab from \"./privacy/phoneNumber\";\r\nimport AppTwoStepVerificationTab from \"./2fa\";\r\nimport AppTwoStepVerificationEnterPasswordTab from \"./2fa/enterPassword\";\r\nimport AppTwoStepVerificationEmailConfirmationTab from \"./2fa/emailConfirmation\";\r\nimport AppPrivacyLastSeenTab from \"./privacy/lastSeen\";\r\nimport AppPrivacyProfilePhotoTab from \"./privacy/profilePhoto\";\r\nimport AppPrivacyForwardMessagesTab from \"./privacy/forwardMessages\";\r\nimport AppPrivacyAddToGroupsTab from \"./privacy/addToGroups\";\r\nimport AppPrivacyCallsTab from \"./privacy/calls\";\r\nimport AppActiveSessionsTab from \"./activeSessions\";\r\nimport AppBlockedUsersTab from \"./blockedUsers\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { i18n, LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport Button from \"../../button\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport convertKeyToInputKey from \"../../../helpers/string/convertKeyToInputKey\";\r\nimport getPrivacyRulesDetails from \"../../../lib/appManagers/utils/privacy/getPrivacyRulesDetails\";\r\nimport PrivacyType from \"../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyAndSecurityTab extends SliderSuperTabEventable {\r\n  private activeSessionsRow: Row;\r\n  private authorizations: Authorization.authorization[];\r\n\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('dont-u-dare-block-me');\r\n    this.setTitle('PrivacySettings');\r\n\r\n    const SUBTITLE: LangPackKey = 'Loading';\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true, caption: 'SessionsInfo'});\r\n\r\n      let blockedPeerIds: PeerId[];\r\n      const blockedUsersRow = new Row({\r\n        icon: 'deleteuser',\r\n        titleLangKey: 'BlockedUsers',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          const tab = this.slider.createTab(AppBlockedUsersTab);\r\n          tab.peerIds = blockedPeerIds;\r\n          tab.open();\r\n        }\r\n      });\r\n      blockedUsersRow.freezed = true;\r\n\r\n      let passwordState: AccountPassword;\r\n      const twoFactorRowOptions = {\r\n        icon: 'lock',\r\n        titleLangKey: 'TwoStepVerification' as LangPackKey,\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: (e: Event) => {\r\n          let tab: AppTwoStepVerificationTab | AppTwoStepVerificationEnterPasswordTab | AppTwoStepVerificationEmailConfirmationTab;\r\n          if(passwordState.pFlags.has_password) {\r\n            tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n          } else if(passwordState.email_unconfirmed_pattern) {\r\n            tab = this.slider.createTab(AppTwoStepVerificationEmailConfirmationTab);\r\n            tab.email = passwordState.email_unconfirmed_pattern;\r\n            tab.length = 6;\r\n            tab.isFirst = true;\r\n            this.managers.passwordManager.resendPasswordEmail();\r\n          } else {\r\n            tab = this.slider.createTab(AppTwoStepVerificationTab);\r\n          }\r\n          \r\n          tab.state = passwordState;\r\n          tab.open();\r\n        }\r\n      };\r\n      \r\n      const twoFactorRow = new Row(twoFactorRowOptions);\r\n      twoFactorRow.freezed = true;\r\n\r\n      const activeSessionsRow = this.activeSessionsRow = new Row({\r\n        icon: 'activesessions',\r\n        titleLangKey: 'SessionsTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          const tab = this.slider.createTab(AppActiveSessionsTab);\r\n          tab.authorizations = this.authorizations;\r\n          tab.eventListener.addEventListener('destroy', () => {\r\n            this.updateActiveSessions();\r\n          }, {once: true});\r\n          tab.open();\r\n        }\r\n      });\r\n      activeSessionsRow.freezed = true;\r\n\r\n      section.content.append(blockedUsersRow.container, twoFactorRow.container, activeSessionsRow.container);\r\n      this.scrollable.append(section.container);\r\n\r\n      const setBlockedCount = (count: number) => {\r\n        if(count) {\r\n          replaceContent(blockedUsersRow.subtitle, i18n('PrivacySettingsController.UserCount', [count]));\r\n        } else {\r\n          replaceContent(blockedUsersRow.subtitle, i18n('BlockedEmpty', [count]));\r\n        }\r\n      };\r\n\r\n      this.listenerSetter.add(rootScope)('peer_block', () => {\r\n        /* const {blocked, peerId} = update;\r\n        if(!blocked) blockedPeerIds.findAndSplice((p) => p === peerId);\r\n        else blockedPeerIds.unshift(peerId);\r\n        blockedCount += blocked ? 1 : -1;\r\n        setBlockedCount(blockedCount); */\r\n        updateBlocked();\r\n      });\r\n\r\n      const updateBlocked = () => {\r\n        this.managers.appUsersManager.getBlocked().then((res) => {\r\n          blockedUsersRow.freezed = false;\r\n          setBlockedCount(res.count);\r\n          blockedPeerIds = res.peerIds;\r\n        });\r\n      };\r\n\r\n      updateBlocked();\r\n\r\n      this.managers.passwordManager.getState().then((state) => {\r\n        passwordState = state;\r\n        replaceContent(twoFactorRow.subtitle, i18n(state.pFlags.has_password ? 'PrivacyAndSecurity.Item.On' : 'PrivacyAndSecurity.Item.Off'));\r\n        twoFactorRow.freezed = false;\r\n        \r\n        //console.log('password state', state);\r\n      });\r\n\r\n      this.updateActiveSessions();\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'PrivacyTitle', caption: 'GroupsAndChannelsHelp'});\r\n\r\n      section.content.classList.add('privacy-navigation-container');\r\n\r\n      const rowsByKeys: Partial<{\r\n        [key in InputPrivacyKey['_']]: Row\r\n      }> = {};\r\n\r\n      const numberVisibilityRow = rowsByKeys['inputPrivacyKeyPhoneNumber'] = new Row({\r\n        titleLangKey: 'PrivacyPhoneTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyPhoneNumberTab).open();\r\n        }\r\n      });\r\n\r\n      const lastSeenTimeRow = rowsByKeys['inputPrivacyKeyStatusTimestamp'] = new Row({\r\n        titleLangKey: 'LastSeenTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyLastSeenTab).open();\r\n        }\r\n      });\r\n\r\n      const photoVisibilityRow = rowsByKeys['inputPrivacyKeyProfilePhoto'] = new Row({\r\n        titleLangKey: 'PrivacyProfilePhotoTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyProfilePhotoTab).open();\r\n        }\r\n      });\r\n\r\n      const callRow = rowsByKeys['inputPrivacyKeyPhoneCall'] = new Row({\r\n        titleLangKey: 'WhoCanCallMe',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyCallsTab).open();\r\n        }\r\n      });\r\n\r\n      const linkAccountRow = rowsByKeys['inputPrivacyKeyForwards'] = new Row({\r\n        titleLangKey: 'PrivacyForwardsTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyForwardMessagesTab).open();\r\n        }\r\n      });\r\n\r\n      const groupChatsAddRow = rowsByKeys['inputPrivacyKeyChatInvite'] = new Row({\r\n        titleLangKey: 'WhoCanAddMe',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyAddToGroupsTab).open();\r\n        }\r\n      });\r\n\r\n      const updatePrivacyRow = (key: InputPrivacyKey['_']) => {\r\n        const row = rowsByKeys[key];\r\n        if(!row) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appPrivacyManager.getPrivacy(key).then((rules) => {\r\n          const details = getPrivacyRulesDetails(rules);\r\n          const langKey = details.type === PrivacyType.Everybody ? 'PrivacySettingsController.Everbody' : (details.type === PrivacyType.Contacts ? 'PrivacySettingsController.MyContacts' : 'PrivacySettingsController.Nobody');\r\n          const disallowLength = details.disallowPeers.users.length + details.disallowPeers.chats.length;\r\n          const allowLength = details.allowPeers.users.length + details.allowPeers.chats.length;\r\n\r\n          row.subtitle.innerHTML = '';\r\n          const s = i18n(langKey);\r\n          row.subtitle.append(s);\r\n          if(disallowLength || allowLength) {\r\n            row.subtitle.append(` (${[-disallowLength, allowLength ? '+' + allowLength : 0].filter(Boolean).join(', ')})`);\r\n          }\r\n        });\r\n      };\r\n\r\n      section.content.append(\r\n        numberVisibilityRow.container, \r\n        lastSeenTimeRow.container, \r\n        photoVisibilityRow.container, \r\n        callRow.container, \r\n        linkAccountRow.container, \r\n        groupChatsAddRow.container\r\n      );\r\n      this.scrollable.append(section.container);\r\n\r\n      for(const key in rowsByKeys) {\r\n        updatePrivacyRow(key as keyof typeof rowsByKeys);\r\n      }\r\n\r\n      rootScope.addEventListener('privacy_update', (update) => {\r\n        updatePrivacyRow(convertKeyToInputKey(update.key._) as any);\r\n      });\r\n    }\r\n\r\n    const promises: Promise<any>[] = [];\r\n    {\r\n      const section = new SettingSection({name: 'Privacy.SensitiveContent'});\r\n      section.container.classList.add('hide');\r\n\r\n      promises.push(this.managers.apiManager.invokeApi('account.getContentSettings').then((settings) => {\r\n        if(!settings.pFlags.sensitive_can_change) {\r\n          return;\r\n        }\r\n        \r\n        const enabled = settings.pFlags.sensitive_enabled;\r\n\r\n        const sensitiveRow = new Row({\r\n          checkboxField: new CheckboxField({text: 'PrivacyAndSecurity.SensitiveText', checked: enabled}),\r\n          subtitleLangKey: 'PrivacyAndSecurity.SensitiveDesc',\r\n          noCheckboxSubtitle: true\r\n        });\r\n        \r\n        section.content.append(sensitiveRow.container);\r\n        section.container.classList.remove('hide');\r\n        \r\n        this.eventListener.addEventListener('destroy', () => {\r\n          const _enabled = sensitiveRow.checkboxField.checked;\r\n          const isChanged = _enabled !== enabled;\r\n          if(!isChanged) {\r\n            return;\r\n          }\r\n          \r\n          this.managers.apiManager.invokeApi('account.setContentSettings', {\r\n            sensitive_enabled: _enabled\r\n          });\r\n        }, {once: true});\r\n      }));\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'FilterChats'});\r\n\r\n      const onDeleteClick = () => {\r\n        const popup = new PopupPeer('popup-delete-drafts', {\r\n          buttons: [{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              const toggle = toggleDisability([deleteButton], true);\r\n              this.managers.appDraftsManager.clearAllDrafts().then(() => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true,\r\n          }], \r\n          titleLangKey: 'AreYouSureClearDraftsTitle',\r\n          descriptionLangKey: 'AreYouSureClearDrafts'\r\n        });\r\n  \r\n        popup.show();\r\n      };\r\n\r\n      const deleteButton = Button('btn-primary btn-transparent', {icon: 'delete', text: 'PrivacyDeleteCloudDrafts'});\r\n      this.listenerSetter.add(deleteButton)('click', onDeleteClick);\r\n      section.content.append(deleteButton);\r\n\r\n      /* promises.push(apiManager.invokeApi('messages.getAllDrafts').then((drafts) => {\r\n        const draftsRow = new Row({\r\n          titleLangKey: 'PrivacyDeleteCloudDrafts',\r\n          subtitleLangKey: 'Drafts',\r\n          subtitleLangArgs: [(drafts as Updates.updates).updates.length],\r\n          icon: 'delete',\r\n          clickable: onDeleteClick\r\n        });\r\n        \r\n        section.content.append(draftsRow.container);\r\n      })); */\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  public updateActiveSessions() {\r\n    this.managers.apiManager.invokeApi('account.getAuthorizations').then((auths) => {\r\n      this.activeSessionsRow.freezed = false;\r\n      this.authorizations = auths.authorizations;\r\n      _i18n(this.activeSessionsRow.subtitle, 'Privacy.Devices', [this.authorizations.length]);\r\n      //console.log('auths', auths);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport renderImageFromUrl from \"./dom/renderImageFromUrl\";\r\n\r\nexport function averageColorFromCanvas(canvas: HTMLCanvasElement) {\r\n  const context = canvas.getContext('2d');\r\n\r\n  const pixel = new Array(4).fill(0);\r\n  const pixels = context.getImageData(0, 0, canvas.width, canvas.height).data;\r\n  for(let i = 0; i < pixels.length; i += 4) {\r\n    pixel[0] += pixels[i];\r\n    pixel[1] += pixels[i + 1];\r\n    pixel[2] += pixels[i + 2];\r\n    pixel[3] += pixels[i + 3];\r\n  }\r\n\r\n  const pixelsLength = pixels.length / 4;\r\n  const outPixel = new Uint8ClampedArray(4);\r\n  outPixel[0] = pixel[0] / pixelsLength;\r\n  outPixel[1] = pixel[1] / pixelsLength;\r\n  outPixel[2] = pixel[2] / pixelsLength;\r\n  outPixel[3] = pixel[3] / pixelsLength;\r\n  return outPixel;\r\n}\r\n\r\nexport function averageColor(imageUrl: string) {\r\n  const img = document.createElement('img');\r\n  return new Promise<Uint8ClampedArray>((resolve) => {\r\n    renderImageFromUrl(img, imageUrl, () => {\r\n      const canvas = document.createElement('canvas');\r\n      const ratio = img.naturalWidth / img.naturalHeight;\r\n      const DIMENSIONS = 50;\r\n      if(ratio === 1) {\r\n        canvas.width = DIMENSIONS;\r\n        canvas.height = canvas.width / ratio;\r\n      } else if(ratio > 1) {\r\n        canvas.height = DIMENSIONS;\r\n        canvas.width = canvas.height / ratio;\r\n      } else {\r\n        canvas.width = canvas.height = DIMENSIONS;\r\n      }\r\n      \r\n      const context = canvas.getContext('2d');\r\n      context.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, canvas.width, canvas.height);\r\n      resolve(averageColorFromCanvas(canvas));\r\n    });\r\n  });\r\n};\r\n","import { rgbaToHsla } from \"./color\";\r\n\r\n// * https://github.com/TelegramMessenger/Telegram-iOS/blob/3d062fff78cc6b287c74e6171f855a3500c0156d/submodules/TelegramPresentationData/Sources/PresentationData.swift#L453\r\nexport default function highlightningColor(rgba: [number, number, number, number?]) {\r\n  let {h, s, l} = rgbaToHsla(rgba[0], rgba[1], rgba[2]);\r\n  if(s > 0) {\r\n    s = Math.min(100, s + 5 + 0.1 * (100 - s));\r\n  }\r\n  l = Math.max(0, l * .65);\r\n  \r\n  const hsla = `hsla(${h}, ${s}%, ${l}%, .4)`;\r\n  return hsla;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko, Artem Kolnogorov and unknown creator of the script taken from http://useless.altervista.org/gradient.html\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../../helpers/animation\";\r\nimport { hexToRgb } from \"../../helpers/color\";\r\n\r\nconst WIDTH = 50;\r\nconst HEIGHT = WIDTH;\r\n\r\nexport default class ChatBackgroundGradientRenderer {\r\n  private readonly _width = WIDTH;\r\n  private readonly _height = HEIGHT;\r\n  private _phase: number;\r\n  private _tail: number;\r\n  private readonly _tails = 90;\r\n  private readonly _scrollTails = 50;\r\n  private _frames: ImageData[];\r\n  private _colors: {r: number, g: number, b: number}[];\r\n  /* private readonly _curve = [ \r\n    0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 500, 600, 700, 800, 900, \r\n    1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1830, 1860, 1890, 1920, \r\n    1950, 1980, 2010, 2040, 2070, 2100, 2130, 2160, 2190, 2220, 2250, 2280, 2310, \r\n    2340, 2370, 2400, 2430, 2460, 2490, 2520, 2550, 2580, 2610, 2630, 2640, 2650, \r\n    2660, 2670, 2680, 2690, 2700\r\n  ]; */\r\n  private readonly _curve = [\r\n    0 , 0.25 , 0.50 , 0.75 , 1 , 1.5 , 2 , 2.5 , 3 , 3.5 , 4 , 5 , 6 , 7 , 8 , 9 , 10 , 11 , 12 ,\r\n    13 , 14 , 15 , 16 , 17 , 18 , 18.3 , 18.6 , 18.9 , 19.2 , 19.5 , 19.8 , 20.1 , 20.4 , 20.7 ,\r\n    21.0 , 21.3 , 21.6 , 21.9 , 22.2 , 22.5 , 22.8 , 23.1 , 23.4 , 23.7 , 24.0 , 24.3 , 24.6 ,\r\n    24.9 , 25.2 , 25.5 , 25.8 , 26.1 , 26.3 , 26.4 , 26.5 , 26.6 , 26.7 , 26.8 , 26.9 , 27 ,\r\n  ];\r\n  private readonly _incrementalCurve: number[];\r\n  private readonly _positions = [\r\n    { x: 0.80, y: 0.10 },\r\n    { x: 0.60, y: 0.20 },\r\n    { x: 0.35, y: 0.25 },\r\n    { x: 0.25, y: 0.60 },\r\n    { x: 0.20, y: 0.90 },\r\n    { x: 0.40, y: 0.80 },\r\n    { x: 0.65, y: 0.75 },\r\n    { x: 0.75, y: 0.40 }\r\n  ];\r\n  private readonly _phases = this._positions.length;\r\n  private _onWheelRAF: number;\r\n  private _scrollDelta: number;\r\n\r\n  // private _ts = 0;\r\n  // private _fps = 15;\r\n  // private _frametime = 1000 / this._fps;\r\n  // private _raf: number;\r\n\r\n  private _canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _hc: HTMLCanvasElement;\r\n  private _hctx: CanvasRenderingContext2D;\r\n\r\n  private _addedScrollListener: boolean;\r\n  private _animatingToNextPosition: boolean;\r\n\r\n  constructor() {\r\n    const diff = this._tails / this._curve[this._curve.length - 1];\r\n\r\n    for(let i = 0, length = this._curve.length; i < length; ++i) {\r\n      this._curve[i] = this._curve[i] * diff;\r\n    }\r\n\r\n    this._incrementalCurve = this._curve.map((v, i, arr) => {\r\n      return v - (arr[i - 1] ?? 0);\r\n    });\r\n  }\r\n\r\n  private hexToRgb(hex: string) {\r\n    const result = hexToRgb(hex);\r\n    return {r: result[0], g: result[1], b: result[2]};\r\n  }\r\n\r\n  private getPositions(shift: number) {\r\n    const positions = this._positions.slice();\r\n    while(shift > 0) {\r\n      positions.push(positions.shift());\r\n      --shift;\r\n    }\r\n\r\n    const result: typeof positions = [];\r\n    for(let i = 0; i < positions.length; i += 2) {\r\n      result.push(positions[i]);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private getNextPositions(phase: number, curveMax: number, curve: number[]) {\r\n    const pos = this.getPositions(phase);\r\n    if(!curve[0] && curve.length === 1) {\r\n      return [pos];\r\n    }\r\n    \r\n    const nextPos = this.getPositions(++phase % this._phases);\r\n    const distances = nextPos.map((nextPos, idx) => {\r\n      return {\r\n        x: (nextPos.x - pos[idx].x) / curveMax,\r\n        y: (nextPos.y - pos[idx].y) / curveMax,\r\n      };\r\n    });\r\n\r\n    const positions = curve.map((value) => {\r\n      return distances.map((distance, idx) => {\r\n        return {\r\n          x: pos[idx].x + distance.x * value,\r\n          y: pos[idx].y + distance.y * value\r\n        };\r\n      });\r\n    });\r\n\r\n    return positions;\r\n  }\r\n \r\n  private curPosition(phase: number, tail: number) {\r\n    const positions = this.getNextPositions(phase, this._tails, [tail]);\r\n    return positions[0];\r\n  }\r\n\r\n  private changeTail(diff: number) {\r\n    this._tail += diff;\r\n\r\n    while(this._tail >= this._tails) {\r\n      this._tail -= this._tails;\r\n      if(++this._phase >= this._phases) {\r\n        this._phase -= this._phases;\r\n      }\r\n    }\r\n\r\n    while(this._tail < 0) {\r\n      this._tail += this._tails;\r\n      if(--this._phase < 0) {\r\n        this._phase += this._phases;\r\n      }\r\n    }\r\n  }\r\n  \r\n  private onWheel = (e: {deltaY: number}) => {\r\n    if(this._animatingToNextPosition) {\r\n      return;\r\n    }\r\n\r\n    this._scrollDelta += e.deltaY;\r\n    if(this._onWheelRAF === undefined) {\r\n      this._onWheelRAF = requestAnimationFrame(this.drawOnWheel);\r\n    }\r\n  };\r\n\r\n  private drawOnWheel = () => {\r\n    let diff = this._scrollDelta / this._scrollTails;\r\n    this._scrollDelta %= this._scrollTails;\r\n    diff = diff > 0 ? Math.floor(diff) : Math.ceil(diff);\r\n    if(diff) {\r\n      this.changeTail(diff);\r\n      const curPos = this.curPosition(this._phase, this._tail);\r\n      this.drawGradient(curPos);\r\n    }\r\n    this._onWheelRAF = undefined;\r\n  };\r\n\r\n  private drawNextPositionAnimated = () => {\r\n    const frames = this._frames;\r\n    const id = frames.shift();\r\n    if(id) {\r\n      this.drawImageData(id);\r\n    }\r\n    \r\n    const leftLength = frames.length;\r\n    if(!leftLength) {\r\n      this._animatingToNextPosition = undefined;\r\n    }\r\n\r\n    return !!leftLength;\r\n  };\r\n\r\n  private getGradientImageData(positions: {x: number, y: number}[]) {\r\n    const id = this._hctx.createImageData(this._width, this._height);\r\n    const pixels = id.data;\r\n\r\n    let offset = 0;\r\n    for(let y = 0; y < this._height; ++y) {\r\n      const directPixelY = y / this._height;\r\n      const centerDistanceY = directPixelY - 0.5;\r\n      const centerDistanceY2 = centerDistanceY * centerDistanceY;\r\n\r\n      for(let x = 0; x < this._width; ++x) {\r\n        const directPixelX = x / this._width;\r\n\r\n        const centerDistanceX = directPixelX - 0.5;\r\n        const centerDistance = Math.sqrt(centerDistanceX * centerDistanceX + centerDistanceY2);\r\n\r\n        const swirlFactor = 0.35 * centerDistance;\r\n        const theta = swirlFactor * swirlFactor * 0.8 * 8.0;\r\n        const sinTheta = Math.sin(theta);\r\n        const cosTheta = Math.cos(theta);\r\n\r\n        const pixelX = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * cosTheta - centerDistanceY * sinTheta));\r\n        const pixelY = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * sinTheta + centerDistanceY * cosTheta));\r\n\r\n        let distanceSum = 0.0;\r\n\r\n        let r = 0.0;\r\n        let g = 0.0;\r\n        let b = 0.0;\r\n\r\n        for(let i = 0; i < this._colors.length; i++) {\r\n          const colorX = positions[i].x;\r\n          const colorY = positions[i].y;\r\n\r\n          const distanceX = pixelX - colorX;\r\n          const distanceY = pixelY - colorY;\r\n\r\n          let distance = Math.max(0.0, 0.9 - Math.sqrt(distanceX * distanceX + distanceY * distanceY));\r\n          distance = distance * distance * distance * distance;\r\n          distanceSum += distance;\r\n\r\n          r += distance * this._colors[i].r / 255;\r\n          g += distance * this._colors[i].g / 255;\r\n          b += distance * this._colors[i].b / 255;\r\n        }\r\n\r\n        pixels[offset++] = r / distanceSum * 255.0;\r\n        pixels[offset++] = g / distanceSum * 255.0;\r\n        pixels[offset++] = b / distanceSum * 255.0;\r\n        pixels[offset++] = 0xFF;\r\n      }\r\n    }\r\n    return id;\r\n  }\r\n\r\n  private drawImageData(id: ImageData) {\r\n    this._hctx.putImageData(id, 0, 0);\r\n    this._ctx.drawImage(this._hc, 0, 0, this._width, this._height);\r\n  }\r\n\r\n  private drawGradient(positions: {x: number, y: number}[]) {\r\n    this.drawImageData(this.getGradientImageData(positions));\r\n  }\r\n\r\n  // private doAnimate = () => {\r\n  //   const now = +Date.now();\r\n  //   if(!document.hasFocus() || (now - this._ts) < this._frametime) {\r\n  //     this._raf = requestAnimationFrame(this.doAnimate);\r\n  //     return;\r\n  //   }\r\n\r\n  //   this._ts = now;\r\n  //   this.changeTail(1);\r\n  //   const cur_pos = this.curPosition(this._phase, this._tail);\r\n  //   this.drawGradient(cur_pos);\r\n  //   this._raf = requestAnimationFrame(this.doAnimate);\r\n  // };\r\n\r\n  // public animate(start?: boolean) {\r\n  //   if(!start) {\r\n  //     cancelAnimationFrame(this._raf);\r\n  //     return;\r\n  //   }\r\n  //   this.doAnimate();\r\n  // }\r\n\r\n  public init(el: HTMLCanvasElement) {\r\n    this._frames = [];\r\n    this._phase = 0;\r\n    this._tail = 0;\r\n    this._scrollDelta = 0;\r\n    if(this._onWheelRAF !== undefined) {\r\n      cancelAnimationFrame(this._onWheelRAF);\r\n      this._onWheelRAF = undefined;\r\n    }\r\n\r\n    const colors = el.getAttribute('data-colors').split(',').reverse();\r\n    this._colors = colors.map((color) => {\r\n      return this.hexToRgb(color);\r\n    });\r\n\r\n    if(!this._hc) {\r\n      this._hc = document.createElement('canvas');\r\n      this._hc.width = this._width;\r\n      this._hc.height = this._height;\r\n      this._hctx = this._hc.getContext('2d');\r\n    }\r\n\r\n    this._canvas = el;\r\n    this._ctx = this._canvas.getContext('2d');\r\n    this.update();\r\n  }\r\n\r\n  public update() {\r\n    if(this._colors.length < 2) {\r\n      const color = this._colors[0];\r\n      this._ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;\r\n      this._ctx.fillRect(0, 0, this._width, this._height);\r\n      return;\r\n    }\r\n    \r\n    const pos = this.curPosition(this._phase, this._tail);\r\n    this.drawGradient(pos);\r\n  }\r\n\r\n  public toNextPosition() {\r\n    if(this._colors.length < 2) {\r\n      return;\r\n    }\r\n\r\n    const tail = this._tail;\r\n    const tails = this._tails;\r\n\r\n    let nextPhaseOnIdx: number;\r\n\r\n    const curve: number[] = [];\r\n    for(let i = 0, length = this._incrementalCurve.length; i < length; ++i) {\r\n      const inc = this._incrementalCurve[i];\r\n      let value = (curve[i - 1] ?? tail) + inc;\r\n\r\n      if(+value.toFixed(2) > tails && nextPhaseOnIdx === undefined) {\r\n        nextPhaseOnIdx = i;\r\n        value %= tails;\r\n      }\r\n      \r\n      curve.push(value);\r\n    }\r\n\r\n    const currentPhaseCurve = curve.slice(0, nextPhaseOnIdx);\r\n    const nextPhaseCurve = nextPhaseOnIdx !== undefined ? curve.slice(nextPhaseOnIdx) : [];\r\n\r\n    [currentPhaseCurve, nextPhaseCurve].forEach((curve, idx, curves) => {\r\n      const last = curve[curve.length - 1];\r\n      if(last !== undefined && last > tails) {\r\n        curve[curve.length - 1] = +last.toFixed(2);\r\n      }\r\n      \r\n      this._tail = last ?? 0;\r\n\r\n      if(!curve.length) {\r\n        return;\r\n      }\r\n\r\n      const positions = this.getNextPositions(this._phase, tails, curve);\r\n      if(idx !== (curves.length - 1)) {\r\n        if(++this._phase >= this._phases) {\r\n          this._phase -= this._phases;\r\n        }\r\n      }\r\n\r\n      const ids = positions.map((pos) => {\r\n        return this.getGradientImageData(pos);\r\n      });\r\n  \r\n      this._frames.push(...ids);\r\n    });\r\n\r\n    this._animatingToNextPosition = true;\r\n    animate(this.drawNextPositionAnimated);\r\n  }\r\n\r\n  public scrollAnimate(start?: boolean) {\r\n    if(this._colors.length < 2 && start) {\r\n      return;\r\n    }\r\n\r\n    if(start && !this._addedScrollListener) {\r\n      document.addEventListener('wheel', this.onWheel);\r\n      this._addedScrollListener = true;\r\n    } else if(!start && this._addedScrollListener) {\r\n      document.removeEventListener('wheel', this.onWheel);\r\n      this._addedScrollListener = false;\r\n    }\r\n  }\r\n\r\n  public cleanup() {\r\n    this.scrollAnimate(false);\r\n    // this.animate(false);\r\n  }\r\n\r\n  public static createCanvas(colors?: string) {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = WIDTH;\r\n    canvas.height = HEIGHT;\r\n    if(colors !== undefined) {\r\n      canvas.dataset.colors = colors;\r\n    }\r\n\r\n    return canvas;\r\n  }\r\n\r\n  public static create(colors?: string) {\r\n    const canvas = this.createCanvas(colors);\r\n    const gradientRenderer = new ChatBackgroundGradientRenderer();\r\n    gradientRenderer.init(canvas);\r\n\r\n    return {gradientRenderer, canvas};\r\n  }\r\n}\r\n","import { ColorHsla, ColorRgba, hexaToHsla, hslaToRgba, rgbaToHexa as rgbaToHexa, rgbaToHsla } from \"../helpers/color\";\r\nimport attachGrabListeners from \"../helpers/dom/attachGrabListeners\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport InputField, { InputState } from \"./inputField\";\r\n\r\nexport type ColorPickerColor = { \r\n  hsl: string; \r\n  rgb: string; \r\n  hex: string; \r\n  hsla: string; \r\n  rgba: string; \r\n  hexa: string; \r\n  rgbaArray: ColorRgba; \r\n};\r\n\r\nexport default class ColorPicker {\r\n  private static BASE_CLASS = 'color-picker';\r\n  public container: HTMLElement;\r\n\r\n  private boxRect: DOMRect;\r\n  //private boxDraggerRect: DOMRect;\r\n  private hueRect: DOMRect;\r\n  //private hueDraggerRect: DOMRect;\r\n\r\n\tprivate hue = 0;\r\n\tprivate saturation = 100;\r\n\tprivate lightness = 50;\r\n\tprivate alpha = 1;\r\n  private elements: {\r\n    box: SVGSVGElement,\r\n    boxDragger: SVGSVGElement,\r\n    sliders: HTMLElement,\r\n    hue: SVGSVGElement,\r\n    hueDragger: SVGSVGElement,\r\n    saturation: SVGLinearGradientElement,\r\n  } = {} as any;\r\n  private hexInputField: InputField;\r\n  private rgbInputField: InputField;\r\n  public onChange: (color: ReturnType<ColorPicker['getCurrentColor']>) => void;\r\n\r\n  constructor() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(ColorPicker.BASE_CLASS);\r\n\r\n    const html = `\r\n      <svg class=\"${ColorPicker.BASE_CLASS + '-box'}\" viewBox=\"0 0 380 198\">\r\n        <defs>\r\n          <linearGradient id=\"color-picker-saturation\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop offset=\"0%\" stop-color=\"#fff\"></stop>\r\n            <stop offset=\"100%\" stop-color=\"hsl(0,100%,50%)\"></stop>\r\n          </linearGradient>\r\n          <linearGradient id=\"color-picker-brightness\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\r\n            <stop offset=\"0%\" stop-color=\"rgba(0,0,0,0)\"></stop>\r\n            <stop offset=\"100%\" stop-color=\"#000\"></stop>\r\n          </linearGradient>\r\n          <pattern id=\"color-picker-pattern\" width=\"100%\" height=\"100%\">\r\n            <rect x=\"0\" y=\"0\" width=\"100%\" height=\"100%\" fill=\"url(#color-picker-saturation)\"></rect>\r\n            <rect x=\"0\" y=\"0\" width=\"100%\" height=\"100%\" fill=\"url(#color-picker-brightness)\"></rect>\r\n          </pattern>\r\n        </defs>\r\n        <rect rx=\"10\" ry=\"10\" x=\"0\" y=\"0\" width=\"380\" height=\"198\" fill=\"url(#color-picker-pattern)\"></rect>\r\n        <svg class=\"${ColorPicker.BASE_CLASS + '-dragger'} ${ColorPicker.BASE_CLASS + '-box-dragger'}\" x=\"0\" y=\"0\">\r\n          <circle r=\"11\" fill=\"inherit\" stroke=\"#fff\" stroke-width=\"2\"></circle>\r\n        </svg>\r\n      </svg>\r\n      <div class=\"${ColorPicker.BASE_CLASS + '-sliders'}\">\r\n        <svg class=\"${ColorPicker.BASE_CLASS + '-color-slider'}\" viewBox=\"0 0 380 24\">\r\n          <defs>\r\n            <linearGradient id=\"hue\" x1=\"100%\" y1=\"0%\" x2=\"0%\" y2=\"0%\">\r\n              <stop offset=\"0%\" stop-color=\"#f00\"></stop>\r\n              <stop offset=\"16.666%\" stop-color=\"#f0f\"></stop>\r\n              <stop offset=\"33.333%\" stop-color=\"#00f\"></stop>\r\n              <stop offset=\"50%\" stop-color=\"#0ff\"></stop>\r\n              <stop offset=\"66.666%\" stop-color=\"#0f0\"></stop>\r\n              <stop offset=\"83.333%\" stop-color=\"#ff0\"></stop>\r\n              <stop offset=\"100%\" stop-color=\"#f00\"></stop>\r\n            </linearGradient>\r\n          </defs>\r\n          <rect rx=\"4\" ry=\"4\" x=\"0\" y=\"9\" width=\"380\" height=\"8\" fill=\"url(#hue)\"></rect>\r\n          <svg class=\"${ColorPicker.BASE_CLASS + '-dragger'} ${ColorPicker.BASE_CLASS + '-color-slider-dragger'}\" x=\"0\" y=\"13\">\r\n            <circle r=\"11\" fill=\"inherit\" stroke=\"#fff\" stroke-width=\"2\"></circle>\r\n          </svg>\r\n        </svg>\r\n      </div>\r\n    `;\r\n\r\n    this.container.innerHTML = html;\r\n\r\n    this.elements.box = this.container.firstElementChild as any;\r\n    this.elements.boxDragger = this.elements.box.lastElementChild as any;\r\n    this.elements.saturation = this.elements.box.firstElementChild.firstElementChild as any;\r\n\r\n    this.elements.sliders = this.elements.box.nextElementSibling as any;\r\n\r\n    this.elements.hue = this.elements.sliders.firstElementChild as any;\r\n    this.elements.hueDragger = this.elements.hue.lastElementChild as any;\r\n\r\n    this.hexInputField = new InputField({plainText: true, label: 'Appearance.Color.Hex'});\r\n    this.rgbInputField = new InputField({plainText: true, label: 'Appearance.Color.RGB'});\r\n\r\n    const inputs = document.createElement('div');\r\n    inputs.className = ColorPicker.BASE_CLASS + '-inputs';\r\n    inputs.append(this.hexInputField.container, this.rgbInputField.container);\r\n    this.container.append(inputs);\r\n\r\n    this.hexInputField.input.addEventListener('input', () => {\r\n      let value = this.hexInputField.value.replace(/#/g, '').slice(0, 6);\r\n\r\n      const match = value.match(/([a-fA-F\\d]+)/);\r\n      const valid = match && match[0].length === value.length && [/* 3, 4,  */6].includes(value.length);\r\n      this.hexInputField.setState(valid ? InputState.Neutral : InputState.Error);\r\n\r\n      value = '#' + value;\r\n      this.hexInputField.setValueSilently(value);\r\n      \r\n      if(valid) {\r\n        this.setColor(value, false, true);\r\n      }\r\n    });\r\n\r\n    // patched https://stackoverflow.com/a/34029238/6758968\r\n    const rgbRegExp = /^(?:rgb)?\\(?([01]?\\d\\d?|2[0-4]\\d|25[0-5])(?:\\W+)([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\W+(?:([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\)?)$/;\r\n    this.rgbInputField.input.addEventListener('input', () => {\r\n      const match = this.rgbInputField.value.match(rgbRegExp);\r\n      this.rgbInputField.setState(match ? InputState.Neutral : InputState.Error);\r\n\r\n      if(match) {\r\n        this.setColor(rgbaToHsla(+match[1], +match[2], +match[3]), true, false);\r\n      }\r\n    });\r\n\r\n    this.attachBoxListeners();\r\n    this.attachHueListeners();\r\n  }\r\n\r\n  private onGrabStart = () => {\r\n    document.documentElement.style.cursor = this.elements.boxDragger.style.cursor = 'grabbing';\r\n  };\r\n\r\n  private onGrabEnd = () => {\r\n    document.documentElement.style.cursor = this.elements.boxDragger.style.cursor = '';\r\n  };\r\n\r\n  private attachBoxListeners() {\r\n    attachGrabListeners(this.elements.box as any, () => {\r\n      this.onGrabStart();\r\n      this.boxRect = this.elements.box.getBoundingClientRect();\r\n      //this.boxDraggerRect = this.elements.boxDragger.getBoundingClientRect();\r\n    }, (pos) => {\r\n      this.saturationHandler(pos.x, pos.y);\r\n    }, () => {\r\n      this.onGrabEnd();\r\n    });\r\n  }\r\n\r\n  private attachHueListeners() {\r\n    attachGrabListeners(this.elements.hue as any, () => {\r\n      this.onGrabStart();\r\n      this.hueRect = this.elements.hue.getBoundingClientRect();\r\n      //this.hueDraggerRect = this.elements.hueDragger.getBoundingClientRect();\r\n    }, (pos) => {\r\n      this.hueHandler(pos.x);\r\n    }, () => {\r\n      this.onGrabEnd();\r\n    });\r\n  }\r\n\r\n  public setColor(color: ColorHsla | string, updateHexInput = true, updateRgbInput = true) {\r\n    if(color === undefined) { // * set to red\r\n      color = {\r\n        h: 0,\r\n        s: 100,\r\n        l: 50,\r\n        a: 1\r\n      };\r\n    } else if(typeof(color) === 'string') {\r\n      if(color[0] === '#') {\r\n        color = hexaToHsla(color);\r\n      } else {\r\n        const rgb = color.match(/[.?\\d]+/g);\r\n        color = rgbaToHsla(+rgb[0], +rgb[1], +rgb[2], rgb[3] === undefined ? 1 : +rgb[3]);\r\n      }\r\n    }\r\n\r\n    // Set box\r\n    this.boxRect = this.elements.box.getBoundingClientRect();\r\n\r\n    const boxX = this.boxRect.width / 100 * color.s;\r\n    const percentY = 100 - (color.l / (100 - color.s / 2)) * 100;\r\n    const boxY = this.boxRect.height / 100 * percentY;\r\n\r\n    this.saturationHandler(this.boxRect.left + boxX, this.boxRect.top + boxY, false);\r\n\r\n    // Set hue\r\n    this.hueRect = this.elements.hue.getBoundingClientRect();\r\n\r\n    const percentHue = color.h / 360;\r\n    const hueX = this.hueRect.left + this.hueRect.width * percentHue;\r\n\r\n    this.hueHandler(hueX, false);\r\n\r\n    // Set values\r\n    this.hue = color.h;\r\n    this.saturation = color.s;\r\n    this.lightness = color.l;\r\n    this.alpha = color.a;\r\n\r\n    this.updatePicker(updateHexInput, updateRgbInput);\r\n  };\r\n\r\n  public getCurrentColor(): ColorPickerColor {\r\n    const rgbaArray = hslaToRgba(this.hue, this.saturation, this.lightness, this.alpha);\r\n    const hexa = rgbaToHexa(rgbaArray);\r\n    const hex = hexa.slice(0, -2);\r\n\r\n    return {\r\n      hsl: `hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`,\r\n      rgb: `rgb(${rgbaArray[0]}, ${rgbaArray[1]}, ${rgbaArray[2]})`,\r\n      hex: hex,\r\n      hsla: `hsla(${this.hue}, ${this.saturation}%, ${this.lightness}%, ${this.alpha})`,\r\n      rgba: `rgba(${rgbaArray[0]}, ${rgbaArray[1]}, ${rgbaArray[2]}, ${rgbaArray[3]})`,\r\n      hexa: hexa,\r\n      rgbaArray: rgbaArray\r\n    };\r\n  }\r\n\r\n  public updatePicker(updateHexInput = true, updateRgbInput = true) {\r\n    const color = this.getCurrentColor();\r\n    this.elements.boxDragger.setAttributeNS(null, 'fill', color.hex);\r\n\r\n    if(updateHexInput) {\r\n      this.hexInputField.setValueSilently(color.hex);\r\n      this.hexInputField.setState(InputState.Neutral);\r\n    }\r\n\r\n    if(updateRgbInput) {\r\n      this.rgbInputField.setValueSilently(color.rgbaArray.slice(0, -1).join(', '));\r\n      this.rgbInputField.setState(InputState.Neutral);\r\n    }\r\n\r\n    if(this.onChange) {\r\n      this.onChange(color);\r\n    }\r\n  }\r\n\r\n  private hueHandler(pageX: number, update = true) {\r\n    const eventX = clamp(pageX - this.hueRect.left, 0, this.hueRect.width);\r\n\r\n    const percents = eventX / this.hueRect.width;\r\n    this.hue = Math.round(360 * percents);\r\n    \r\n    const hsla = `hsla(${this.hue}, 100%, 50%, ${this.alpha})`;\r\n\r\n    this.elements.hueDragger.setAttributeNS(null, 'x', (percents * 100) + '%');\r\n    this.elements.hueDragger.setAttributeNS(null, 'fill', hsla);\r\n    \r\n    this.elements.saturation.lastElementChild.setAttributeNS(null, 'stop-color', hsla);\r\n\r\n    if(update) {\r\n      this.updatePicker();\r\n    }\r\n  }\r\n\r\n  private saturationHandler(pageX: number, pageY: number, update = true) {\r\n    const maxX = this.boxRect.width;\r\n    const maxY = this.boxRect.height;\r\n\r\n    const eventX = clamp(pageX - this.boxRect.left, 0, maxX);\r\n    const eventY = clamp(pageY - this.boxRect.top, 0, maxY);\r\n\r\n    const posX = eventX / maxX * 100;\r\n    const posY = eventY / maxY * 100;\r\n    \r\n    const boxDragger = this.elements.boxDragger;\r\n    boxDragger.setAttributeNS(null, 'x', posX + '%');\r\n    boxDragger.setAttributeNS(null, 'y', posY + '%');\r\n\r\n    const saturation = clamp(posX, 0, 100);\r\n\r\n    const lightnessX = 100 - saturation / 2;\r\n    const lightnessY = 100 - clamp(posY, 0, 100);\r\n\r\n    const lightness = clamp(lightnessY / 100 * lightnessX, 0, 100);\r\n\r\n    this.saturation = saturation;\r\n    this.lightness = lightness;\r\n\r\n    if(update) {\r\n      this.updatePicker();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport { Theme } from \"../../../config/state\";\r\nimport { hexaToRgba } from \"../../../helpers/color\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport highlightningColor from \"../../../helpers/highlightningColor\";\r\nimport throttle from \"../../../helpers/schedulers/throttle\";\r\nimport themeController from \"../../../helpers/themeController\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport ColorPicker, { ColorPickerColor } from \"../../colorPicker\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppBackgroundColorTab extends SliderSuperTab {\r\n  private colorPicker: ColorPicker;\r\n  private grid: HTMLElement;\r\n  private applyColor: (hex: string, updateColorPicker?: boolean) => void;\r\n  private theme: Theme;\r\n\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('background-container', 'background-color-container');\r\n    this.setTitle('SetColor');\r\n\r\n    this.theme = themeController.getTheme();\r\n\r\n    const section = new SettingSection({});\r\n    this.colorPicker = new ColorPicker();\r\n\r\n    section.content.append(this.colorPicker.container);\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    const gridSection = new SettingSection({});\r\n\r\n    const grid = this.grid = document.createElement('div');\r\n    grid.classList.add('grid');\r\n\r\n    const colors = [\r\n      '#E6EBEE',\r\n      '#B2CEE1',\r\n      '#008DD0',\r\n      '#C6E7CB',\r\n      '#C4E1A6',\r\n      '#60B16E',\r\n      '#CCD0AF',\r\n      '#A6A997',\r\n      '#7A7072',\r\n      '#FDD7AF',\r\n      '#FDB76E',\r\n      '#DD8851'\r\n    ];\r\n\r\n    colors.forEach((color) => {\r\n      const item = document.createElement('div');\r\n      item.classList.add('grid-item');\r\n      item.dataset.color = color.toLowerCase();\r\n\r\n      // * need for transform scale\r\n      const media = document.createElement('div');\r\n      media.classList.add('grid-item-media');\r\n      media.style.backgroundColor = color;\r\n\r\n      item.append(media);\r\n      grid.append(item);\r\n    });\r\n\r\n    attachClickEvent(grid, (e) => {\r\n      const target = findUpClassName(e.target, 'grid-item');\r\n      if(!target || target.classList.contains('active')) {\r\n        return;\r\n      }\r\n\r\n      const color = target.dataset.color;\r\n      if(!color) {\r\n        return;\r\n      }\r\n\r\n      this.applyColor(color);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    gridSection.content.append(grid);\r\n    this.scrollable.append(gridSection.container);\r\n\r\n    this.applyColor = throttle(this._applyColor, 16, true);\r\n  }\r\n\r\n  private setActive() {\r\n    const active = this.grid.querySelector('.active');\r\n    const background = this.theme.background;\r\n    const target = background.color ? this.grid.querySelector(`.grid-item[data-color=\"${background.color}\"]`) : null;\r\n    if(active === target) {\r\n      return;\r\n    }\r\n\r\n    if(active) {\r\n      active.classList.remove('active');\r\n    }\r\n\r\n    if(target) {\r\n      target.classList.add('active');\r\n    }\r\n  }\r\n\r\n  private _applyColor = (hex: string, updateColorPicker = true) => {\r\n    if(updateColorPicker) {\r\n      this.colorPicker.setColor(hex);\r\n    } else {\r\n      const rgba = hexaToRgba(hex);\r\n      const background = this.theme.background;\r\n      const hsla = highlightningColor(rgba);\r\n    \r\n      background.id = '2';\r\n      background.intensity = 0;\r\n      background.slug = '';\r\n      background.color = hex.toLowerCase();\r\n      background.highlightningColor = hsla;\r\n      this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n    \r\n      appImManager.applyCurrentTheme(undefined, undefined, true);\r\n      this.setActive();\r\n    }\r\n  };\r\n\r\n  private onColorChange = (color: ColorPickerColor) => {\r\n    this.applyColor(color.hex, false);\r\n  };\r\n\r\n  onOpen() {\r\n    setTimeout(() => {\r\n      const background = this.theme.background;\r\n\r\n      const color = (background.color || '').split(',')[0];\r\n      const isColored = !!color && !background.slug;\r\n      \r\n      // * set active if type is color\r\n      if(isColored) {\r\n        this.colorPicker.onChange = this.onColorChange;\r\n      }\r\n\r\n      this.colorPicker.setColor(color || '#cccccc');\r\n      \r\n      if(!isColored) {\r\n        this.colorPicker.onChange = this.onColorChange;\r\n      }\r\n    }, 0);\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    this.colorPicker.onChange = undefined;\r\n    this.colorPicker = undefined;\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","import type { MediaSize } from \"../mediaSize\";\r\n\r\nexport default function scaleMediaElement(options: {\r\n  media: CanvasImageSource, \r\n  mediaSize?: MediaSize, \r\n  boxSize?: MediaSize, \r\n  quality?: number,\r\n  mimeType?: 'image/jpeg' | 'image/png',\r\n  size?: MediaSize\r\n}): Promise<{blob: Blob, size: MediaSize}> {\r\n  return new Promise((resolve) => {\r\n    const canvas = document.createElement('canvas');\r\n    const size = options.size ?? options.mediaSize.aspectFitted(options.boxSize);\r\n    canvas.width = size.width * window.devicePixelRatio;\r\n    canvas.height = size.height * window.devicePixelRatio;\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.drawImage(options.media, 0, 0, canvas.width, canvas.height);\r\n    canvas.toBlob((blob) => {\r\n      resolve({blob, size});\r\n    }, options.mimeType ?? 'image/jpeg', options.quality ?? 1);\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { generateSection } from \"..\";\r\nimport { averageColor, averageColorFromCanvas } from \"../../../helpers/averageColor\";\r\nimport blur from \"../../../helpers/blur\";\r\nimport deferredPromise, { CancellablePromise } from \"../../../helpers/cancellablePromise\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport highlightningColor from \"../../../helpers/highlightningColor\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport sequentialDom from \"../../../helpers/sequentialDom\";\r\nimport ChatBackgroundGradientRenderer from \"../../chat/gradientRenderer\";\r\nimport { Document, PhotoSize, WallPaper } from \"../../../layer\";\r\nimport { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager, { AppDownloadManager, DownloadBlob } from \"../../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport ProgressivePreloader from \"../../preloader\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { wrapPhoto } from \"../../wrappers\";\r\nimport AppBackgroundColorTab from \"./backgroundColor\";\r\nimport choosePhotoSize from \"../../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { STATE_INIT, Theme } from \"../../../config/state\";\r\nimport themeController from \"../../../helpers/themeController\";\r\nimport requestFile from \"../../../helpers/files/requestFile\";\r\nimport { renderImageFromUrlPromise } from \"../../../helpers/dom/renderImageFromUrl\";\r\nimport scaleMediaElement from \"../../../helpers/canvas/scaleMediaElement\";\r\nimport { MediaSize } from \"../../../helpers/mediaSize\";\r\n\r\nexport default class AppBackgroundTab extends SliderSuperTab {\r\n  private grid: HTMLElement;\r\n  private tempId = 0;\r\n  private clicked: Set<DocId> = new Set();\r\n  private blurCheckboxField: CheckboxField;\r\n\r\n  private wallPapersByElement: Map<HTMLElement, WallPaper> = new Map();\r\n  private elementsByKey: Map<string, HTMLElement> = new Map();\r\n\r\n  private get theme() {\r\n    return themeController.getTheme();\r\n  }\r\n\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('background-container', 'background-image-container');\r\n    this.setTitle('ChatBackground');\r\n\r\n    {\r\n      const container = generateSection(this.scrollable);\r\n\r\n      const uploadButton = Button('btn-primary btn-transparent', {icon: 'cameraadd', text: 'ChatBackground.UploadWallpaper'});\r\n      const colorButton = Button('btn-primary btn-transparent', {icon: 'colorize', text: 'SetColor'});\r\n      const resetButton = Button('btn-primary btn-transparent', {icon: 'favourites', text: 'Appearance.Reset'});\r\n\r\n      attachClickEvent(uploadButton, this.onUploadClick, {listenerSetter: this.listenerSetter});\r\n\r\n      attachClickEvent(colorButton, () => {\r\n        this.slider.createTab(AppBackgroundColorTab).open();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      attachClickEvent(resetButton, this.onResetClick, {listenerSetter: this.listenerSetter});\r\n\r\n      const blurCheckboxField = this.blurCheckboxField = new CheckboxField({\r\n        text: 'ChatBackground.Blur', \r\n        name: 'blur', \r\n        checked: this.theme.background.blur,\r\n        withRipple: true\r\n      });\r\n\r\n      this.listenerSetter.add(blurCheckboxField.input)('change', async() => {\r\n        this.theme.background.blur = blurCheckboxField.input.checked;\r\n        await this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n\r\n        // * wait for animation end\r\n        setTimeout(() => {\r\n          const active = grid.querySelector('.active') as HTMLElement;\r\n          if(!active) return;\r\n\r\n          const wallpaper = this.wallPapersByElement.get(active);\r\n          if((wallpaper as WallPaper.wallPaper).pFlags.pattern || wallpaper._ === 'wallPaperNoFile') {\r\n            return;\r\n          }\r\n          \r\n          this.setBackgroundDocument(wallpaper);\r\n        }, 100);\r\n      });\r\n\r\n      container.append(uploadButton, colorButton, resetButton, blurCheckboxField.label);\r\n    }\r\n\r\n    rootScope.addEventListener('background_change', this.setActive);\r\n\r\n    this.managers.appDocsManager.getWallPapers().then((wallPapers) => {\r\n      wallPapers.forEach((wallPaper) => {\r\n        this.addWallPaper(wallPaper);\r\n      });\r\n    });\r\n\r\n    const gridContainer = generateSection(this.scrollable);\r\n    const grid = this.grid = document.createElement('div');\r\n    grid.classList.add('grid');\r\n    attachClickEvent(grid, this.onGridClick, {listenerSetter: this.listenerSetter});\r\n    gridContainer.append(grid);\r\n  }\r\n\r\n  private onUploadClick = () => {\r\n    requestFile('image/x-png,image/png,image/jpeg').then(async(file) => {\r\n      if(file.name.endsWith('.png')) {\r\n        const img = document.createElement('img');\r\n        const url = URL.createObjectURL(file);\r\n        await renderImageFromUrlPromise(img, url, false);\r\n        const mimeType = 'image/jpeg';\r\n        const {blob} = await scaleMediaElement({media: img, size: new MediaSize(img.naturalWidth, img.naturalHeight), mimeType});\r\n        file = new File([blob], file.name.replace(/\\.png$/, '.jpg'), {type: mimeType});\r\n      }\r\n\r\n      const wallPaper = await this.managers.appDocsManager.prepareWallPaperUpload(file);\r\n      const uploadPromise = this.managers.appDocsManager.uploadWallPaper(wallPaper.id);\r\n      const uploadDeferred: CancellablePromise<any> = appDownloadManager.getNewDeferredForUpload(file.name, uploadPromise);\r\n\r\n      const deferred = deferredPromise<void>();\r\n      deferred.addNotifyListener = uploadDeferred.addNotifyListener;\r\n      deferred.cancel = uploadDeferred.cancel;\r\n\r\n      uploadDeferred.then((wallPaper) => {\r\n        this.clicked.delete(key);\r\n        this.elementsByKey.delete(key);\r\n        this.wallPapersByElement.set(container, wallPaper);\r\n        const newKey = this.getWallPaperKey(wallPaper);\r\n        this.elementsByKey.set(newKey, container);\r\n\r\n        this.setBackgroundDocument(wallPaper).then(deferred.resolve, deferred.reject);\r\n      }, deferred.reject);\r\n\r\n      const key = this.getWallPaperKey(wallPaper);\r\n      deferred.catch(() => {\r\n        container.remove();\r\n      });\r\n\r\n      const preloader = new ProgressivePreloader({\r\n        isUpload: true,\r\n        cancelable: true,\r\n        tryAgainOnFail: false\r\n      });\r\n\r\n      const container = this.addWallPaper(wallPaper, false);\r\n      this.clicked.add(key);\r\n\r\n      preloader.attach(container, false, deferred);\r\n    });\r\n  };\r\n\r\n  private onResetClick = () => {\r\n    const defaultTheme = STATE_INIT.settings.themes.find((t) => t.name === this.theme.name);\r\n    if(defaultTheme) {\r\n      ++this.tempId;\r\n      this.theme.background = copy(defaultTheme.background);\r\n      this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n      appImManager.applyCurrentTheme(undefined, undefined, true);\r\n      this.blurCheckboxField.setValueSilently(this.theme.background.blur);\r\n    }\r\n  };\r\n\r\n  private getColorsFromWallPaper(wallPaper: WallPaper) {\r\n    return wallPaper.settings ? [\r\n      wallPaper.settings.background_color,\r\n      wallPaper.settings.second_background_color,\r\n      wallPaper.settings.third_background_color,\r\n      wallPaper.settings.fourth_background_color\r\n    ].filter(Boolean).map((color) => '#' + color.toString(16)).join(',') : '';\r\n  }\r\n\r\n  private getWallPaperKey(wallPaper: WallPaper) {\r\n    return '' + wallPaper.id;\r\n  }\r\n\r\n  private getWallPaperKeyFromTheme(theme: Theme) {\r\n    return '' + theme.background.id;\r\n  }\r\n\r\n  private addWallPaper(wallPaper: WallPaper, append = true) {\r\n    const colors = this.getColorsFromWallPaper(wallPaper);\r\n    const hasFile = wallPaper._ === 'wallPaper';\r\n    if((hasFile && wallPaper.pFlags.pattern && !colors)/*  || \r\n      (wallpaper.document as MyDocument).mime_type.indexOf('application/') === 0 */) {\r\n      return;\r\n    }\r\n\r\n    const isDark = !!wallPaper.pFlags.dark;\r\n\r\n    const doc = hasFile ? wallPaper.document as Document.document : undefined;\r\n\r\n    const container = document.createElement('div');\r\n    container.classList.add('grid-item');\r\n\r\n    container.dataset.id = '' + wallPaper.id;\r\n\r\n    const key = this.getWallPaperKey(wallPaper);\r\n    this.wallPapersByElement.set(container, wallPaper);\r\n    this.elementsByKey.set(key, container);\r\n\r\n    const media = document.createElement('div');\r\n    media.classList.add('grid-item-media');\r\n\r\n    let wrapped: ReturnType<typeof wrapPhoto>, size: PhotoSize;\r\n    if(hasFile) {\r\n      size = choosePhotoSize(doc, 200, 200);\r\n      wrapped = wrapPhoto({\r\n        photo: doc,\r\n        message: null,\r\n        container: media,\r\n        withoutPreloader: true,\r\n        size: size,\r\n        noFadeIn: wallPaper.pFlags.pattern\r\n      });\r\n\r\n      if(wallPaper.pFlags.pattern) {\r\n        media.classList.add('is-pattern');\r\n      }\r\n\r\n      wrapped.then(async({loadPromises, images}) => {\r\n        await loadPromises.thumb || loadPromises.full;\r\n        return images;\r\n      }).then((images) => {\r\n        if(wallPaper.pFlags.pattern) {\r\n          if(isDark) {\r\n            images.full.style.display = 'none';\r\n            if(images.thumb) {\r\n              images.thumb.style.display = 'none';\r\n            }\r\n          } else if(wallPaper.settings?.intensity) {\r\n            images.full.style.opacity = '' + Math.abs(wallPaper.settings.intensity) / 100;\r\n          }\r\n        }\r\n\r\n        sequentialDom.mutate(() => {\r\n          container.append(media);\r\n        });\r\n      });\r\n    } else {\r\n      container.append(media);\r\n    }\r\n\r\n    if(wallPaper.settings && wallPaper.settings.background_color !== undefined) {\r\n      const {canvas} = ChatBackgroundGradientRenderer.create(colors);\r\n      canvas.classList.add('background-colors-canvas');\r\n      \r\n      if(isDark && hasFile) {\r\n        wrapped.then(({loadPromises}) => {\r\n          loadPromises.full.then(async() => {\r\n            const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc, size.type);\r\n            canvas.style.webkitMaskImage = `url(${cacheContext.url})`;\r\n            canvas.style.opacity = '' + Math.abs(wallPaper.settings.intensity) / 100;\r\n            media.append(canvas);\r\n          });\r\n        });\r\n      } else {\r\n        media.append(canvas);\r\n      }\r\n    }\r\n\r\n    if(this.getWallPaperKeyFromTheme(this.theme) === key) {\r\n      container.classList.add('active');\r\n    }\r\n\r\n    this.grid[append ? 'append' : 'prepend'](container);\r\n\r\n    return container;\r\n  }\r\n\r\n  private onGridClick = (e: MouseEvent | TouchEvent) => {\r\n    const target = findUpClassName(e.target, 'grid-item') as HTMLElement;\r\n    if(!target) return;\r\n\r\n    const wallpaper = this.wallPapersByElement.get(target);\r\n    if(wallpaper._ === 'wallPaperNoFile') {\r\n      this.setBackgroundDocument(wallpaper);\r\n      return;\r\n    }\r\n    \r\n    const key = this.getWallPaperKey(wallpaper);\r\n    if(this.clicked.has(key)) return;\r\n    this.clicked.add(key);\r\n    \r\n    const doc = wallpaper.document as MyDocument;\r\n    const preloader = new ProgressivePreloader({\r\n      cancelable: true,\r\n      tryAgainOnFail: false\r\n    });\r\n\r\n    const load = async() => {\r\n      const promise = this.setBackgroundDocument(wallpaper);\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc);\r\n      if(!cacheContext.url || this.theme.background.blur) {\r\n        preloader.attach(target, true, promise);\r\n      }\r\n    };\r\n\r\n    preloader.construct();\r\n\r\n    attachClickEvent(target, (e) => {\r\n      if(preloader.preloader.parentElement) {\r\n        preloader.onClick(e);\r\n        preloader.detach();\r\n      } else {\r\n        load();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    load();\r\n\r\n    //console.log(doc);\r\n  };\r\n\r\n  private saveToCache = (slug: string, url: string) => {\r\n    fetch(url).then((response) => {\r\n      appImManager.cacheStorage.save('backgrounds/' + slug, response);\r\n    });\r\n  };\r\n\r\n  private setBackgroundDocument = (wallPaper: WallPaper) => {\r\n    let _tempId = ++this.tempId;\r\n    const middleware = () => _tempId === this.tempId;\r\n\r\n    const doc = (wallPaper as WallPaper.wallPaper).document as MyDocument;\r\n    const deferred = deferredPromise<void>();\r\n    let download: Promise<void> | ReturnType<AppDownloadManager['downloadMediaURL']>;\r\n    if(doc) {\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId: appImManager.chat.bubbles ? appImManager.chat.bubbles.lazyLoadQueue.queueId : 0});\r\n      deferred.addNotifyListener = download.addNotifyListener;\r\n      deferred.cancel = download.cancel;\r\n    } else {\r\n      download = Promise.resolve();\r\n    }\r\n\r\n    download.then(async() => {\r\n      if(!middleware()) {\r\n        deferred.resolve();\r\n        return;\r\n      }\r\n\r\n      const background = this.theme.background;\r\n      const onReady = (url?: string) => {\r\n        //const perf = performance.now();\r\n        let getPixelPromise: Promise<Uint8ClampedArray>;\r\n        if(url && !this.theme.background.color) {\r\n          getPixelPromise = averageColor(url);\r\n        } else {\r\n          const {canvas} = ChatBackgroundGradientRenderer.create(this.getColorsFromWallPaper(wallPaper));\r\n          getPixelPromise = Promise.resolve(averageColorFromCanvas(canvas));\r\n        }\r\n\r\n        getPixelPromise.then((pixel) => {\r\n          if(!middleware()) {\r\n            deferred.resolve();\r\n            return;\r\n          }\r\n          \r\n          const hsla = highlightningColor(Array.from(pixel) as any);\r\n          // const hsla = 'rgba(0, 0, 0, 0.3)';\r\n          //console.log(doc, hsla, performance.now() - perf);\r\n\r\n          const slug = (wallPaper as WallPaper.wallPaper).slug ?? '';\r\n          background.id = wallPaper.id;\r\n          background.intensity = wallPaper.settings?.intensity ?? 0;\r\n          background.color = this.getColorsFromWallPaper(wallPaper);\r\n          background.slug = slug;\r\n          background.highlightningColor = hsla;\r\n          this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n\r\n          if(slug) {\r\n            this.saveToCache(slug, url);\r\n          }\r\n\r\n          appImManager.applyCurrentTheme(slug, url, true).then(deferred.resolve);\r\n        });\r\n      };\r\n\r\n      if(!doc) {\r\n        onReady();\r\n        return;\r\n      }\r\n\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc);\r\n      if(background.blur) {\r\n        setTimeout(() => {\r\n          const {canvas, promise} = blur(cacheContext.url, 12, 4)\r\n          promise.then(() => {\r\n            if(!middleware()) {\r\n              deferred.resolve();\r\n              return;\r\n            }\r\n\r\n            onReady(canvas.toDataURL());\r\n          });\r\n        }, 200);\r\n      } else {\r\n        onReady(cacheContext.url);\r\n      }\r\n    });\r\n\r\n    return deferred;\r\n  };\r\n\r\n  private setActive = () => {\r\n    const active = this.grid.querySelector('.active');\r\n    const target = this.elementsByKey.get(this.getWallPaperKeyFromTheme(this.theme));\r\n    if(active === target) {\r\n      return;\r\n    }\r\n\r\n    if(active) {\r\n      active.classList.remove('active');\r\n    }\r\n\r\n    if(target) {\r\n      target.classList.add('active');\r\n    }\r\n  };\r\n}\r\n","export default function requestFile(accept?: string) {\r\n  const input = document.createElement('input');\r\n  input.type = 'file';\r\n  input.style.display = 'none';\r\n\r\n  if(accept) {\r\n    input.accept = accept;\r\n  }\r\n\r\n  document.body.append(input);\r\n\r\n  const promise = new Promise<File>((resolve, reject) => {\r\n    input.addEventListener('change', (e: any) => {\r\n      const file: File = e.target.files[0];\r\n      if(!file) {\r\n        reject('NO_FILE_SELECTED');\r\n        return;\r\n      }\r\n  \r\n      resolve(file);\r\n    }, {once: true});\r\n  }).finally(() => {\r\n    input.remove();\r\n  });\r\n\r\n  input.click();\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport type { AppStickersManager } from \"../../lib/appManagers/appStickersManager\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { wrapSticker } from \"../wrappers\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport { putPreloader } from \"../putPreloader\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { StickerSet } from \"../../layer\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport Button from \"../button\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport toggleDisability from \"../../helpers/dom/toggleDisability\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { toastNew } from \"../toast\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nconst ANIMATION_GROUP = 'STICKERS-POPUP';\r\n\r\nexport default class PopupStickers extends PopupElement {\r\n  private stickersFooter: HTMLElement;\r\n  private stickersDiv: HTMLElement;\r\n  private h6: HTMLElement;\r\n\r\n  private set: StickerSet.stickerSet;\r\n\r\n  constructor(private stickerSetInput: Parameters<AppStickersManager['getStickerSet']>[0]) {\r\n    super('popup-stickers', null, {closable: true, overlayClosable: true, body: true});\r\n\r\n    this.h6 = document.createElement('h6');\r\n    this.h6.append(i18n('Loading'));\r\n\r\n    this.header.append(this.h6);\r\n\r\n    this.addEventListener('close', () => {\r\n      animationIntersector.setOnlyOnePlayableGroup('');\r\n    });\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('sticker-set');\r\n\r\n    this.stickersDiv = document.createElement('div');\r\n    this.stickersDiv.classList.add('sticker-set-stickers', 'is-loading');\r\n\r\n    attachClickEvent(this.stickersDiv, this.onStickersClick, {listenerSetter: this.listenerSetter});\r\n\r\n    putPreloader(this.stickersDiv, true);\r\n\r\n    this.stickersFooter = document.createElement('div');\r\n    this.stickersFooter.classList.add('sticker-set-footer');\r\n\r\n    div.append(this.stickersDiv);\r\n\r\n    const btn = Button('btn-primary btn-primary-transparent disable-hover', {noRipple: true, text: 'Loading'});\r\n    this.stickersFooter.append(btn);\r\n\r\n    this.body.append(div);\r\n    const scrollable = new Scrollable(this.body);\r\n    this.body.append(this.stickersFooter);\r\n    \r\n    // const editButton = document.createElement('button');\r\n    // editButton.classList.add('btn-primary');\r\n\r\n    // this.stickersFooter.append(editButton);\r\n\r\n    this.loadStickerSet();\r\n  }\r\n\r\n  private onStickersClick = (e: MouseEvent) => {\r\n    const target = findUpClassName(e.target, 'sticker-set-sticker');\r\n    if(!target) return;\r\n\r\n    const fileId = target.dataset.docId;\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId)) {\r\n      this.hide();\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n    }\r\n  };\r\n\r\n  private loadStickerSet() {\r\n    return this.managers.appStickersManager.getStickerSet(this.stickerSetInput).then((set) => {\r\n      if(!set) {\r\n        toastNew({langPackKey: 'StickerSet.DontExist'});\r\n        this.hide();\r\n        return;\r\n      }\r\n      //console.log('PopupStickers loadStickerSet got set:', set);\r\n\r\n      this.set = set.set;\r\n\r\n      animationIntersector.setOnlyOnePlayableGroup(ANIMATION_GROUP);\r\n\r\n      setInnerHTML(this.h6, wrapEmojiText(set.set.title));\r\n      this.stickersFooter.classList.toggle('add', !set.set.installed_date);\r\n\r\n      let button: HTMLElement;\r\n      if(set.set.installed_date) {\r\n        button = Button('btn-primary btn-primary-transparent danger', {noRipple: true});\r\n        button.append(i18n('RemoveStickersCount', [i18n('Stickers', [set.set.count])]));\r\n      } else {\r\n        button = Button('btn-primary btn-color-primary', {noRipple: true});\r\n        button.append(i18n('AddStickersCount', [i18n('Stickers', [set.set.count])]));\r\n      }\r\n\r\n      this.stickersFooter.textContent = '';\r\n      this.stickersFooter.append(button);\r\n\r\n      attachClickEvent(button, () => {\r\n        const toggle = toggleDisability([button], true);\r\n\r\n        this.managers.appStickersManager.toggleStickerSet(this.set).then(() => {\r\n          this.hide();\r\n        }).catch(() => {\r\n          toggle();\r\n        });\r\n      });\r\n\r\n      const lazyLoadQueue = new LazyLoadQueue();\r\n      \r\n      this.stickersDiv.classList.remove('is-loading');\r\n      this.stickersDiv.innerHTML = '';\r\n      for(let doc of set.documents) {\r\n        if(doc._ === 'documentEmpty') {\r\n          continue;\r\n        }\r\n        \r\n        const div = document.createElement('div');\r\n        div.classList.add('sticker-set-sticker');\r\n\r\n        const size = mediaSizes.active.esgSticker.width;\r\n        \r\n        wrapSticker({\r\n          doc, \r\n          div, \r\n          lazyLoadQueue, \r\n          group: ANIMATION_GROUP, \r\n          play: true,\r\n          loop: true,\r\n          width: size,\r\n          height: size\r\n        });\r\n\r\n        this.stickersDiv.append(div);\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport SliderSuperTab from \"../../sliderTab\";\r\nimport { wrapStickerToRow } from \"../../wrappers\";\r\n\r\nexport default class AppQuickReactionTab extends SliderSuperTab {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('DoubleTapSetting');\r\n    this.container.classList.add('quick-reaction-container');\r\n\r\n    return Promise.all([\r\n      this.managers.appReactionsManager.getQuickReaction(),\r\n      this.managers.appReactionsManager.getAvailableReactions()\r\n    ]).then(([quickReaction, availableReactions]) => {\r\n      availableReactions = availableReactions.filter((reaction) => !reaction.pFlags.inactive);\r\n\r\n      const section = new SettingSection();\r\n\r\n      const name = 'quick-reaction';\r\n      const rows = availableReactions.map((availableReaction) => {\r\n        const radioField = new RadioField({\r\n          name,\r\n          text: availableReaction.title,\r\n          value: availableReaction.reaction,\r\n          alignRight: true\r\n        });\r\n\r\n        const row = new Row({\r\n          radioField,\r\n          havePadding: true\r\n        });\r\n\r\n        radioField.main.classList.add('quick-reaction-title');\r\n\r\n        wrapStickerToRow({\r\n          row,\r\n          doc: availableReaction.static_icon,\r\n          size: 'small'\r\n        });\r\n\r\n        if(availableReaction.reaction === quickReaction.reaction) {\r\n          radioField.setValueSilently(true);\r\n        }\r\n\r\n        return row;\r\n      });\r\n\r\n      const form = RadioFormFromRows(rows, (value) => {\r\n        this.managers.appReactionsManager.setDefaultReaction(value);\r\n      });\r\n\r\n      section.content.append(form);\r\n      this.scrollable.append(section.container);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { generateSection, SettingSection } from \"..\";\r\nimport RangeSelector from \"../../rangeSelector\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport RadioField from \"../../radioField\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { IS_APPLE } from \"../../../environment/userAgent\";\r\nimport Row from \"../../row\";\r\nimport AppBackgroundTab from \"./background\";\r\nimport { LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport assumeType from \"../../../helpers/assumeType\";\r\nimport { MessagesAllStickers, StickerSet } from \"../../../layer\";\r\nimport { wrapStickerSetThumb, wrapStickerToRow } from \"../../wrappers\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport eachMinute from \"../../../helpers/eachMinute\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport IS_GEOLOCATION_SUPPORTED from \"../../../environment/geolocationSupport\";\r\nimport AppQuickReactionTab from \"./quickReaction\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { State } from \"../../../config/state\";\r\n\r\nexport class RangeSettingSelector {\r\n  public container: HTMLDivElement;\r\n  public valueContainer: HTMLElement;\r\n  private range: RangeSelector;\r\n\r\n  public onChange: (value: number) => void;\r\n\r\n  constructor(\r\n    name: LangPackKey, \r\n    step: number, \r\n    initialValue: number, \r\n    minValue: number, \r\n    maxValue: number,\r\n    writeValue = true\r\n  ) {\r\n    const BASE_CLASS = 'range-setting-selector';\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(BASE_CLASS);\r\n\r\n    const details = document.createElement('div');\r\n    details.classList.add(BASE_CLASS + '-details');\r\n\r\n    const nameDiv = document.createElement('div');\r\n    nameDiv.classList.add(BASE_CLASS + '-name');\r\n    _i18n(nameDiv, name);\r\n\r\n    const valueDiv = this.valueContainer = document.createElement('div');\r\n    valueDiv.classList.add(BASE_CLASS + '-value');\r\n\r\n    if(writeValue) {\r\n      valueDiv.innerHTML = '' + initialValue;\r\n    }\r\n\r\n    details.append(nameDiv, valueDiv);\r\n\r\n    this.range = new RangeSelector({\r\n      step, \r\n      min: minValue, \r\n      max: maxValue\r\n    }, initialValue);\r\n    this.range.setListeners();\r\n    this.range.setHandlers({\r\n      onScrub: value => {\r\n        if(this.onChange) {\r\n          this.onChange(value);\r\n        }\r\n\r\n        if(writeValue) {\r\n          //console.log('font size scrub:', value);\r\n          valueDiv.innerText = '' + value;\r\n        }\r\n      }\r\n    });\r\n\r\n    this.container.append(details, this.range.container);\r\n  }\r\n}\r\n\r\nexport default class AppGeneralSettingsTab extends SliderSuperTabEventable {\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('general-settings-container');\r\n    this.setTitle('General');\r\n\r\n    const section = generateSection.bind(null, this.scrollable);\r\n\r\n    {\r\n      const container = section('Settings');\r\n      \r\n      const range = new RangeSettingSelector('TextSize', 1, rootScope.settings.messagesTextSize, 12, 20);\r\n      range.onChange = (value) => {\r\n        rootScope.managers.appStateManager.setByKey('settings.messagesTextSize', value);\r\n      };\r\n\r\n      const chatBackgroundButton = Button('btn-primary btn-transparent', {icon: 'image', text: 'ChatBackground'});\r\n\r\n      attachClickEvent(chatBackgroundButton, () => {\r\n        this.slider.createTab(AppBackgroundTab).open();\r\n      });\r\n\r\n      const animationsCheckboxField = new CheckboxField({\r\n        text: 'EnableAnimations', \r\n        name: 'animations', \r\n        stateKey: 'settings.animationsEnabled',\r\n        withRipple: true\r\n      });\r\n      \r\n      container.append(range.container, chatBackgroundButton, animationsCheckboxField.label);\r\n    }\r\n\r\n    {\r\n      const container = section('General.Keyboard');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'send-shortcut';\r\n      const stateKey = 'settings.sendShortcut';\r\n\r\n      const enterRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'General.SendShortcut.Enter', \r\n          name, \r\n          value: 'enter', \r\n          stateKey\r\n        }),\r\n        subtitleLangKey: 'General.SendShortcut.NewLine.ShiftEnter'\r\n      });\r\n\r\n      const ctrlEnterRow = new Row({\r\n        radioField: new RadioField({\r\n          name,\r\n          value: 'ctrlEnter', \r\n          stateKey\r\n        }),\r\n        subtitleLangKey: 'General.SendShortcut.NewLine.Enter'\r\n      });\r\n      _i18n(ctrlEnterRow.radioField.main, 'General.SendShortcut.CtrlEnter', [IS_APPLE ? '⌘' : 'Ctrl']);\r\n      \r\n      form.append(enterRow.container, ctrlEnterRow.container);\r\n      container.append(form);\r\n    }\r\n\r\n    if(IS_GEOLOCATION_SUPPORTED) {\r\n      const container = section('DistanceUnitsTitle');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'distance-unit';\r\n      const stateKey = 'settings.distanceUnit';\r\n\r\n      const kilometersRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'DistanceUnitsKilometers', \r\n          name, \r\n          value: 'kilometers', \r\n          stateKey\r\n        })\r\n      });\r\n\r\n      const milesRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'DistanceUnitsMiles',\r\n          name,\r\n          value: 'miles', \r\n          stateKey\r\n        })\r\n      });\r\n      \r\n      form.append(kilometersRow.container, milesRow.container);\r\n      container.append(form);\r\n    }\r\n\r\n    {\r\n      const container = section('General.TimeFormat');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'time-format';\r\n      const stateKey = 'settings.timeFormat';\r\n\r\n      const formats: [State['settings']['timeFormat'], LangPackKey][] = [\r\n        ['h12', 'General.TimeFormat.h12'], \r\n        ['h23', 'General.TimeFormat.h23']\r\n      ];\r\n\r\n      const rows = formats.map(([format, langPackKey]) => {\r\n        const row = new Row({\r\n          radioField: new RadioField({\r\n            langKey: langPackKey, \r\n            name, \r\n            value: format, \r\n            stateKey\r\n          })\r\n        });\r\n\r\n        return row;\r\n      });\r\n\r\n      const cancel = eachMinute(() => {\r\n        const date = new Date();\r\n\r\n        formats.forEach(([format], idx) => {\r\n          const str = date.toLocaleTimeString(\"en-us-u-hc-\" + format, {\r\n            hour: '2-digit', \r\n            minute: '2-digit'\r\n          });\r\n\r\n          rows[idx].subtitle.textContent = str;\r\n        });\r\n      });\r\n\r\n      this.eventListener.addEventListener('destroy', cancel);\r\n\r\n      form.append(...rows.map((row) => row.container));\r\n      container.append(form);\r\n    }\r\n\r\n    {\r\n      const container = section('Emoji');\r\n\r\n      const suggestCheckboxField = new CheckboxField({\r\n        text: 'GeneralSettings.EmojiPrediction', \r\n        name: 'suggest-emoji', \r\n        stateKey: 'settings.emoji.suggest',\r\n        withRipple: true\r\n      });\r\n      const bigCheckboxField = new CheckboxField({\r\n        text: 'GeneralSettings.BigEmoji', \r\n        name: 'emoji-big', \r\n        stateKey: 'settings.emoji.big',\r\n        withRipple: true\r\n      });\r\n\r\n      container.append(suggestCheckboxField.label, bigCheckboxField.label);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({name: 'Telegram.InstalledStickerPacksController', caption: 'StickersBotInfo'});\r\n\r\n      const reactionsRow = new Row({\r\n        titleLangKey: 'DoubleTapSetting',\r\n        havePadding: true,\r\n        clickable: () => {\r\n          this.slider.createTab(AppQuickReactionTab).open();\r\n        }\r\n      });\r\n\r\n      const renderQuickReaction = () => {\r\n        Promise.resolve(this.managers.appReactionsManager.getQuickReaction()).then((reaction) => {\r\n          wrapStickerToRow({\r\n            row: reactionsRow,\r\n            doc: reaction.static_icon,\r\n            size: 'small'\r\n          });\r\n        });\r\n      };\r\n\r\n      renderQuickReaction();\r\n\r\n      this.listenerSetter.add(rootScope)('quick_reaction', renderQuickReaction);\r\n\r\n      const suggestCheckboxField = new CheckboxField({\r\n        text: 'Stickers.SuggestStickers', \r\n        name: 'suggest', \r\n        stateKey: 'settings.stickers.suggest',\r\n        withRipple: true\r\n      });\r\n      const loopCheckboxField = new CheckboxField({\r\n        text: 'InstalledStickers.LoopAnimated', \r\n        name: 'loop', \r\n        stateKey: 'settings.stickers.loop',\r\n        withRipple: true\r\n      });\r\n\r\n      const stickerSets: {[id: string]: Row} = {};\r\n\r\n      const stickersContent = section.generateContentElement();\r\n\r\n      const lazyLoadQueue = new LazyLoadQueue();\r\n      const renderStickerSet = (stickerSet: StickerSet.stickerSet, method: 'append' | 'prepend' = 'append') => {\r\n        const row = new Row({\r\n          title: wrapEmojiText(stickerSet.title),\r\n          subtitleLangKey: 'Stickers',\r\n          subtitleLangArgs: [stickerSet.count],\r\n          havePadding: true,\r\n          clickable: () => {\r\n            new PopupStickers({id: stickerSet.id, access_hash: stickerSet.access_hash}).show();\r\n          }\r\n        });\r\n\r\n        stickerSets[stickerSet.id] = row;\r\n\r\n        const div = document.createElement('div');\r\n        div.classList.add('row-media');\r\n\r\n        wrapStickerSetThumb({\r\n          set: stickerSet,\r\n          container: div,\r\n          group: 'GENERAL-SETTINGS',\r\n          lazyLoadQueue,\r\n          width: 48,\r\n          height: 48,\r\n          autoplay: true\r\n        });\r\n\r\n        row.container.append(div);\r\n\r\n        stickersContent[method](row.container);\r\n      };\r\n\r\n      this.managers.appStickersManager.getAllStickers().then((allStickers) => {\r\n        assumeType<MessagesAllStickers.messagesAllStickers>(allStickers);\r\n        for(const stickerSet of allStickers.sets) {\r\n          renderStickerSet(stickerSet);\r\n        }\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('stickers_installed', (e) => {\r\n        const set: StickerSet.stickerSet = e;\r\n        \r\n        if(!stickerSets[set.id]) {\r\n          renderStickerSet(set, 'prepend');\r\n        }\r\n      });\r\n  \r\n      this.listenerSetter.add(rootScope)('stickers_deleted', (e) => {\r\n        const set: StickerSet.stickerSet = e;\r\n        \r\n        if(stickerSets[set.id]) {\r\n          stickerSets[set.id].container.remove();\r\n          delete stickerSets[set.id];\r\n        }\r\n      });\r\n\r\n      section.content.append(reactionsRow.container, suggestCheckboxField.label, loopCheckboxField.label);\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n\r\n  onOpen() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport eachTimeout from \"./eachTimeout\";\r\n\r\n// It's better to use timeout instead of interval, because interval can be corrupted\r\nexport default function eachMinute(callback: () => any, runFirst = true) {\r\n  return eachTimeout(callback, () => (60 - new Date().getSeconds()) * 1000, runFirst);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ctx from \"../environment/ctx\";\r\nimport noop from \"./noop\";\r\n\r\n// It's better to use timeout instead of interval, because interval can be corrupted\r\nexport default function eachTimeout(callback: () => any, getNextTimeout: () => number, runFirst = true) {\r\n  const cancel = () => {\r\n    clearTimeout(timeout);\r\n  };\r\n\r\n  // replace callback to run noop and restore after\r\n  const _callback = callback;\r\n  if(!runFirst) {\r\n    callback = noop;\r\n  }\r\n\r\n  let timeout: number;\r\n  (function run() {\r\n    callback();\r\n    timeout = ctx.setTimeout(run, getNextTimeout());\r\n  })();\r\n\r\n  callback = _callback;\r\n\r\n  return cancel;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { UsernameInputField } from \"../../usernameInputField\";\r\nimport { i18n, i18n_ } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { generateSection, SettingSection } from \"..\";\r\n\r\n// TODO: аватарка не поменяется в этой вкладке после изменения почему-то (если поставить в другом клиенте, и потом тут проверить, для этого ещё вышел в чатлист)\r\n\r\nexport default class AppEditProfileTab extends SliderSuperTab {\r\n  private firstNameInputField: InputField;\r\n  private lastNameInputField: InputField;\r\n  private bioInputField: InputField;\r\n  private usernameInputField: InputField;\r\n  \r\n  private profileUrlContainer: HTMLDivElement;\r\n  private profileUrlAnchor: HTMLAnchorElement;\r\n\r\n  private editPeer: EditPeer;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-profile-container');\r\n    this.setTitle('EditAccount.Title');\r\n\r\n    const inputFields: InputField[] = [];\r\n\r\n    {\r\n      const section = generateSection(this.scrollable, undefined, 'Bio.Description');\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      const appConfig = await this.managers.apiManager.getAppConfig();\r\n      this.firstNameInputField = new InputField({\r\n        label: 'EditProfile.FirstNameLabel',\r\n        name: 'first-name',\r\n        maxLength: 70\r\n      });\r\n      this.lastNameInputField = new InputField({\r\n        label: 'Login.Register.LastName.Placeholder',\r\n        name: 'last-name',\r\n        maxLength: 64\r\n      });\r\n      this.bioInputField = new InputField({\r\n        label: 'EditProfile.BioLabel',\r\n        name: 'bio',\r\n        maxLength: rootScope.premium ? appConfig.about_length_limit_premium : appConfig.about_length_limit_default\r\n      });\r\n  \r\n      inputWrapper.append(this.firstNameInputField.container, this.lastNameInputField.container, this.bioInputField.container);\r\n      \r\n      const caption = document.createElement('div');\r\n      caption.classList.add('caption');\r\n      i18n_({element: caption, key: 'Bio.Description'});\r\n\r\n      inputFields.push(this.firstNameInputField, this.lastNameInputField, this.bioInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId: rootScope.myId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      section.append(this.editPeer.avatarEdit.container, inputWrapper);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'EditAccount.Username',\r\n        caption: true\r\n      });\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n\r\n      this.usernameInputField = new UsernameInputField({\r\n        label: 'EditProfile.Username.Label',\r\n        name: 'username',\r\n        plainText: true,\r\n        listenerSetter: this.listenerSetter,\r\n        onChange: () => {\r\n          this.editPeer.handleChange();\r\n          this.setProfileUrl();\r\n        },\r\n        availableText: 'EditProfile.Username.Available',\r\n        takenText: 'EditProfile.Username.Taken',\r\n        invalidText: 'EditProfile.Username.Invalid'\r\n      }, this.managers);\r\n\r\n      inputWrapper.append(this.usernameInputField.container);\r\n\r\n      const caption = section.caption;\r\n      caption.append(i18n('UsernameSettings.ChangeDescription'));\r\n      caption.append(document.createElement('br'), document.createElement('br'));\r\n\r\n      const profileUrlContainer = this.profileUrlContainer = document.createElement('div');\r\n      profileUrlContainer.classList.add('profile-url-container');\r\n      \r\n      const profileUrlAnchor = this.profileUrlAnchor = document.createElement('a');\r\n      profileUrlAnchor.classList.add('profile-url');\r\n      profileUrlAnchor.href = '#';\r\n      profileUrlAnchor.target = '_blank';\r\n\r\n      profileUrlContainer.append(i18n('UsernameHelpLink', [profileUrlAnchor]));\r\n\r\n      caption.append(profileUrlContainer);\r\n\r\n      inputFields.push(this.usernameInputField);\r\n      section.content.append(inputWrapper);\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    attachClickEvent(this.editPeer.nextBtn, () => {\r\n      this.editPeer.nextBtn.disabled = true;\r\n\r\n      let promises: Promise<any>[] = [];\r\n      \r\n      promises.push(this.managers.appProfileManager.updateProfile(this.firstNameInputField.value, this.lastNameInputField.value, this.bioInputField.value).then(() => {\r\n        this.close();\r\n      }, (err) => {\r\n        console.error('updateProfile error:', err);\r\n      }));\r\n\r\n      if(this.editPeer.uploadAvatar) {\r\n        promises.push(this.editPeer.uploadAvatar().then((inputFile) => {\r\n          return this.managers.appProfileManager.uploadProfilePhoto(inputFile);\r\n        }));\r\n      }\r\n\r\n      if(this.usernameInputField.isValidToChange()) {\r\n        promises.push(this.managers.appUsersManager.updateUsername(this.usernameInputField.value));\r\n      }\r\n\r\n      Promise.race(promises).finally(() => {\r\n        this.editPeer.nextBtn.removeAttribute('disabled');\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const user = await this.managers.appUsersManager.getSelf();\r\n\r\n    const userFull = await this.managers.appProfileManager.getProfile(user.id, true);\r\n\r\n    this.firstNameInputField.setOriginalValue(user.first_name, true);\r\n    this.lastNameInputField.setOriginalValue(user.last_name, true);\r\n    this.bioInputField.setOriginalValue(userFull.about, true);\r\n    this.usernameInputField.setOriginalValue(user.username, true);\r\n\r\n    this.setProfileUrl();\r\n    this.editPeer.handleChange();\r\n  }\r\n\r\n  private setProfileUrl() {\r\n    if(this.usernameInputField.input.classList.contains('error') || !this.usernameInputField.value.length) {\r\n      this.profileUrlContainer.style.display = 'none';\r\n    } else {\r\n      this.profileUrlContainer.style.display = '';\r\n      let url = 'https://t.me/' + this.usernameInputField.value;\r\n      this.profileUrlAnchor.innerText = url;\r\n      this.profileUrlAnchor.href = url;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AppSelectPeers from \"../../appSelectPeers\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { MyDialogFilter as DialogFilter } from \"../../../lib/storages/filters\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Button from \"../../button\";\r\nimport AppEditFolderTab from \"./editFolder\";\r\nimport I18n, { i18n, LangPackKey, _i18n, join } from \"../../../lib/langPack\";\r\nimport { SettingSection } from \"..\";\r\nimport { toast } from \"../../toast\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppIncludedChatsTab extends SliderSuperTab {\r\n  private editFolderTab: AppEditFolderTab;\r\n  private confirmBtn: HTMLElement;\r\n\r\n  private selector: AppSelectPeers;\r\n  private type: 'included' | 'excluded';\r\n  private filter: DialogFilter;\r\n  private originalFilter: DialogFilter;\r\n\r\n  private dialogsByFilters: Map<DialogFilter, Set<PeerId>>;\r\n\r\n  protected init() {\r\n    this.content.remove();\r\n    this.container.classList.add('included-chatlist-container');\r\n    this.confirmBtn = ButtonIcon('check btn-confirm blue', {noRipple: true});\r\n    this.confirmBtn.style.display = 'none';\r\n\r\n    this.header.append(this.confirmBtn);\r\n\r\n    this.confirmBtn.addEventListener('click', async() => {\r\n      const selected = this.selector.getSelected();\r\n\r\n      //this.filter.pFlags = {};\r\n\r\n      if(this.type === 'included') {\r\n        for(const key in this.filter.pFlags) {\r\n          if(key.indexOf('exclude_') === 0) {\r\n            continue;\r\n          }\r\n\r\n          // @ts-ignore\r\n          delete this.filter.pFlags[key];\r\n        }\r\n      } else {\r\n        for(const key in this.filter.pFlags) {\r\n          if(key.indexOf('exclude_') !== 0) {\r\n            continue;\r\n          }\r\n\r\n          // @ts-ignore\r\n          delete this.filter.pFlags[key];\r\n        }\r\n      }\r\n\r\n      const peerIds: PeerId[] = [];\r\n      for(const key of selected) {\r\n        if(key.isPeerId()) {\r\n          peerIds.push(key.toPeerId());\r\n        } else {\r\n          // @ts-ignore\r\n          this.filter.pFlags[key] = true;\r\n        }\r\n      }\r\n\r\n      let cmp: (peerId: PeerId) => boolean;\r\n      if(this.type === 'included') {\r\n        cmp = (peerId) => peerIds.includes(peerId);\r\n      } else {\r\n        cmp = (peerId) => !peerIds.includes(peerId);\r\n      }\r\n\r\n      forEachReverse(this.filter.pinnedPeerIds, (peerId, idx) => {\r\n        if(!cmp(peerId)) {\r\n          this.filter.pinnedPeerIds.splice(idx, 1);\r\n          this.filter.pinned_peers.splice(idx, 1);\r\n        }\r\n      });\r\n\r\n      const other = this.type === 'included' ? 'excludePeerIds' : 'includePeerIds';\r\n      const otherLegacy = this.type === 'included' ? 'exclude_peers' : 'include_peers';\r\n      forEachReverse(this.filter[other], (peerId, idx) => {\r\n        if(peerIds.includes(peerId)) {\r\n          this.filter[other].splice(idx, 1);\r\n          this.filter[otherLegacy].splice(idx, 1);\r\n        }\r\n      });\r\n      \r\n      this.filter[this.type === 'included' ? 'includePeerIds' : 'excludePeerIds'] = peerIds;\r\n      this.filter[this.type === 'included' ? 'include_peers' : 'exclude_peers'] = await Promise.all(peerIds.map((peerId) => this.managers.appPeersManager.getInputPeerById(peerId)));\r\n      //this.filter.pinned_peers = this.filter.pinned_peers.filter((peerId) => this.filter.include_peers.includes(peerId));\r\n\r\n      this.editFolderTab.setFilter(this.filter, false);\r\n      this.close();\r\n    });\r\n\r\n    this.dialogsByFilters = new Map();\r\n    return this.managers.filtersStorage.getDialogFilters().then(async(filters) => {\r\n      await Promise.all(filters.map(async(filter) => {\r\n        const dialogs = await this.managers.dialogsStorage.getFolderDialogs(filter.id);\r\n        const peerIds = dialogs.map((d) => d.peerId);\r\n        this.dialogsByFilters.set(filter, new Set(peerIds));\r\n      }));\r\n    });\r\n  }\r\n\r\n  checkbox(selected?: boolean) {\r\n    const checkboxField = new CheckboxField({\r\n      round: true\r\n    });\r\n    if(selected) {\r\n      checkboxField.input.checked = selected;\r\n    }\r\n\r\n    return checkboxField.label;\r\n  }\r\n\r\n  renderResults = async(peerIds: PeerId[]) => {\r\n    //const other = this.type === 'included' ? this.filter.exclude_peers : this.filter.include_peers;\r\n\r\n    await this.managers.appUsersManager.getContacts();\r\n    peerIds.forEach((peerId) => {\r\n      //if(other.includes(peerId)) return;\r\n\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: this.selector.scrollable,\r\n        rippleEnabled: true,\r\n        avatarSize: 46\r\n      });\r\n\r\n      const selected = this.selector.selected.has(peerId);\r\n      dom.containerEl.append(this.checkbox(selected));\r\n      //if(selected) dom.listEl.classList.add('active');\r\n\r\n      const foundInFilters: HTMLElement[] = [];\r\n      this.dialogsByFilters.forEach((dialogs, filter) => {\r\n        if(dialogs.has(peerId)) {\r\n          const span = document.createElement('span');\r\n          setInnerHTML(span, wrapEmojiText(filter.title));\r\n          foundInFilters.push(span);\r\n        }\r\n      });\r\n\r\n      const joined = join(foundInFilters, false);\r\n      joined.forEach((el) => {\r\n        dom.lastMessageSpan.append(el);\r\n      });\r\n    });\r\n  };\r\n\r\n  onOpen() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.confirmBtn.style.display = this.type === 'excluded' ? '' : 'none';\r\n    this.setTitle(this.type === 'included' ? 'FilterAlwaysShow' : 'FilterNeverShow');\r\n\r\n    const filter = this.filter;\r\n\r\n    const categoriesSection = new SettingSection({\r\n      noDelimiter: true,\r\n      name: 'FilterChatTypes'\r\n    });\r\n\r\n    categoriesSection.container.classList.add('folder-categories');\r\n\r\n    let details: {[flag: string]: {ico: string, text: LangPackKey}};\r\n    if(this.type === 'excluded') {\r\n      details = {\r\n        exclude_muted: {ico: 'mute', text: 'ChatList.Filter.MutedChats'},\r\n        exclude_archived: {ico: 'archive', text: 'ChatList.Filter.Archive'},\r\n        exclude_read: {ico: 'readchats', text: 'ChatList.Filter.ReadChats'}\r\n      };\r\n    } else {\r\n      details = {\r\n        contacts: {ico: 'newprivate', text: 'ChatList.Filter.Contacts'},\r\n        non_contacts: {ico: 'noncontacts', text: 'ChatList.Filter.NonContacts'},\r\n        groups: {ico: 'group', text: 'ChatList.Filter.Groups'},\r\n        broadcasts: {ico: 'newchannel', text: 'ChatList.Filter.Channels'},\r\n        bots: {ico: 'bots', text: 'ChatList.Filter.Bots'}\r\n      };\r\n    }\r\n\r\n    const f = document.createDocumentFragment();\r\n    for(const key in details) {\r\n      const button = Button('btn-primary btn-transparent folder-category-button', {icon: details[key].ico, text: details[key].text});\r\n      button.dataset.peerId = key;\r\n      button.append(this.checkbox());\r\n      f.append(button);\r\n    }\r\n    categoriesSection.content.append(f);\r\n\r\n    /////////////////\r\n\r\n    const selectedPeers = (this.type === 'included' ? filter.includePeerIds : filter.excludePeerIds).slice();\r\n\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.container, \r\n      onChange: this.onSelectChange, \r\n      peerType: ['dialogs'], \r\n      renderResultsFunc: this.renderResults,\r\n      placeholder: 'Search',\r\n      sectionNameLangPackKey: 'FilterChats',\r\n      managers: this.managers\r\n    });\r\n    this.selector.selected = new Set(selectedPeers);\r\n\r\n    let addedInitial = false;\r\n    const _add = this.selector.add.bind(this.selector);\r\n    this.selector.add = (peerId, title, scroll) => {\r\n      if(this.selector.selected.size >= 100 && addedInitial && !details[peerId]) {\r\n        const el: HTMLInputElement = this.selector.list.querySelector(`[data-peer-id=\"${peerId}\"] [type=\"checkbox\"]`);\r\n        if(el) {\r\n          setTimeout(() => {\r\n            el.checked = false;\r\n          }, 0);\r\n        }\r\n\r\n        const str = I18n.format(this.type === 'excluded' ? 'ChatList.Filter.Exclude.LimitReached': 'ChatList.Filter.Include.LimitReached', true);\r\n        toast(str);\r\n        return;\r\n      }\r\n\r\n      const div = _add(peerId, details[peerId] ? i18n(details[peerId].text) : undefined, scroll);\r\n      if(details[peerId]) {\r\n        div.querySelector('avatar-element').classList.add('tgico-' + details[peerId].ico);\r\n      }\r\n      return div;\r\n    };\r\n\r\n    this.selector.scrollable.container.append(categoriesSection.container, this.selector.scrollable.container.lastElementChild);\r\n\r\n    this.selector.addInitial(selectedPeers);\r\n    addedInitial = true;\r\n\r\n    for(const flag in filter.pFlags) {\r\n      // @ts-ignore\r\n      if(details.hasOwnProperty(flag) && !!filter.pFlags[flag]) {\r\n        (categoriesSection.content.querySelector(`[data-peer-id=\"${flag}\"]`) as HTMLElement).click();\r\n      }\r\n    }\r\n  }\r\n\r\n  onSelectChange = (length: number) => {\r\n    //const changed = !deepEqual(this.filter, this.originalFilter);\r\n    if(this.type === 'included') {\r\n      this.confirmBtn.style.display = length ? '' : 'none';\r\n    }\r\n  };\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.selector) {\r\n      this.selector.container.remove();\r\n      this.selector = null;\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  /**\r\n   * Do not ignore arguments!\r\n   */\r\n  public open(filter?: DialogFilter, type?: 'included' | 'excluded', editFolderTab?: AppIncludedChatsTab['editFolderTab']) {\r\n    this.originalFilter = filter;\r\n    this.filter = copy(this.originalFilter);\r\n    this.type = type;\r\n    this.editFolderTab = editFolderTab;\r\n    \r\n    return super.open();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { MyDialogFilter as DialogFilter } from \"../../../lib/storages/filters\";\r\nimport lottieLoader, { LottieLoader } from \"../../../lib/rlottie/lottieLoader\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { toast } from \"../../toast\";\r\nimport InputField from \"../../inputField\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport ButtonMenuToggle from \"../../buttonMenuToggle\";\r\nimport { ButtonMenuItemOptions } from \"../../buttonMenu\";\r\nimport Button from \"../../button\";\r\nimport AppIncludedChatsTab from \"./includedChats\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { SettingSection } from \"..\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport RLottiePlayer from \"../../../lib/rlottie/rlottiePlayer\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport documentFragmentToHTML from \"../../../helpers/dom/documentFragmentToHTML\";\r\nimport wrapDraftText from \"../../../lib/richTextProcessor/wrapDraftText\";\r\nimport filterAsync from \"../../../helpers/array/filterAsync\";\r\n\r\nconst MAX_FOLDER_NAME_LENGTH = 12;\r\n\r\nexport default class AppEditFolderTab extends SliderSuperTab {\r\n  private caption: HTMLElement;\r\n  private stickerContainer: HTMLElement;\r\n\r\n  private confirmBtn: HTMLElement;\r\n  private menuBtn: HTMLElement;\r\n  private nameInputField: InputField;\r\n\r\n  private includePeerIds: SettingSection;\r\n  private excludePeerIds: SettingSection;\r\n  private flags: {[k in 'contacts' | 'non_contacts' | 'groups' | 'broadcasts' | 'bots' | 'exclude_muted' | 'exclude_archived' | 'exclude_read']: HTMLElement} = {} as any;\r\n\r\n  private animation: RLottiePlayer;\r\n  private filter: DialogFilter;\r\n  private originalFilter: DialogFilter;\r\n\r\n  private type: 'edit' | 'create';\r\n  private loadAnimationPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  protected init() {\r\n    this.container.classList.add('edit-folder-container');\r\n    this.caption = document.createElement('div');\r\n    this.caption.classList.add('caption');\r\n    this.caption.append(i18n('FilterIncludeExcludeInfo'));\r\n    this.stickerContainer = document.createElement('div');\r\n    this.stickerContainer.classList.add('sticker-container');\r\n\r\n    this.confirmBtn = ButtonIcon('check btn-confirm hide blue');\r\n    const deleteFolderButton: ButtonMenuItemOptions = {\r\n      icon: 'delete danger',\r\n      text: 'FilterMenuDelete',\r\n      onClick: () => {\r\n        new PopupPeer('filter-delete', {\r\n          titleLangKey: 'ChatList.Filter.Confirm.Remove.Header',\r\n          descriptionLangKey: 'ChatList.Filter.Confirm.Remove.Text',\r\n          buttons: [{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              deleteFolderButton.element.setAttribute('disabled', 'true');\r\n              this.managers.filtersStorage.updateDialogFilter(this.filter, true).then((bool) => {\r\n                if(bool) {\r\n                  this.close();\r\n                }\r\n              }).finally(() => {\r\n                deleteFolderButton.element.removeAttribute('disabled');\r\n              });\r\n            },\r\n            isDanger: true\r\n          }]\r\n        }).show();\r\n      }\r\n    };\r\n    this.menuBtn = ButtonMenuToggle({}, 'bottom-left', [deleteFolderButton]);\r\n    this.menuBtn.classList.add('hide');\r\n\r\n    this.header.append(this.confirmBtn, this.menuBtn);\r\n\r\n    const inputSection = new SettingSection({});\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n    \r\n    this.nameInputField = new InputField({\r\n      label: 'FilterNameHint',\r\n      maxLength: MAX_FOLDER_NAME_LENGTH\r\n    });\r\n\r\n    inputWrapper.append(this.nameInputField.container);\r\n    inputSection.content.append(inputWrapper);\r\n\r\n    const generateList = (className: string, h2Text: LangPackKey, buttons: {icon: string, name?: string, withRipple?: true, text: LangPackKey}[], to: any) => {\r\n      const section = new SettingSection({\r\n        name: h2Text,\r\n        noDelimiter: true\r\n      });\r\n\r\n      section.container.classList.add('folder-list', className);\r\n\r\n      const categories = section.generateContentElement();\r\n      categories.classList.add('folder-categories');\r\n\r\n      buttons.forEach((o) => {\r\n        const button = Button('folder-category-button btn btn-primary btn-transparent', {\r\n          icon: o.icon,\r\n          text: o.text,\r\n          noRipple: o.withRipple ? undefined : true\r\n        });\r\n\r\n        if(o.name) {\r\n          to[o.name] = button;\r\n        }\r\n\r\n        categories.append(button);\r\n      });\r\n\r\n      return section;\r\n    };\r\n\r\n    this.includePeerIds = generateList('folder-list-included', 'FilterInclude', [{\r\n      icon: 'add primary',\r\n      text: 'ChatList.Filter.Include.AddChat',\r\n      withRipple: true\r\n    }, {\r\n      text: 'ChatList.Filter.Contacts',\r\n      icon: 'newprivate',\r\n      name: 'contacts'\r\n    }, {\r\n      text: 'ChatList.Filter.NonContacts',\r\n      icon: 'noncontacts',\r\n      name: 'non_contacts'\r\n    }, {\r\n      text: 'ChatList.Filter.Groups',\r\n      icon: 'group',\r\n      name: 'groups'\r\n    }, {\r\n      text: 'ChatList.Filter.Channels',\r\n      icon: 'channel',\r\n      name: 'broadcasts'\r\n    }, {\r\n      text: 'ChatList.Filter.Bots',\r\n      icon: 'bots',\r\n      name: 'bots'\r\n    }], this.flags);\r\n\r\n    this.excludePeerIds = generateList('folder-list-excluded', 'FilterExclude', [{\r\n      icon: 'minus primary',\r\n      text: 'ChatList.Filter.Exclude.AddChat',\r\n      withRipple: true\r\n    }, {\r\n      text: 'ChatList.Filter.MutedChats',\r\n      icon: 'mute',\r\n      name: 'exclude_muted'\r\n    }, {\r\n      text: 'ChatList.Filter.Archive',\r\n      icon: 'archive',\r\n      name: 'exclude_archived'\r\n    }, {\r\n      text: 'ChatList.Filter.ReadChats',\r\n      icon: 'readchats',\r\n      name: 'exclude_read'\r\n    }], this.flags);\r\n\r\n    this.scrollable.append(this.stickerContainer, this.caption, inputSection.container, this.includePeerIds.container, this.excludePeerIds.container);\r\n\r\n    const includedFlagsContainer = this.includePeerIds.container.querySelector('.folder-categories');\r\n    const excludedFlagsContainer = this.excludePeerIds.container.querySelector('.folder-categories');\r\n\r\n    includedFlagsContainer.querySelector('.btn').addEventListener('click', () => {\r\n      this.slider.createTab(AppIncludedChatsTab).open(this.filter, 'included', this);\r\n    });\r\n\r\n    excludedFlagsContainer.querySelector('.btn').addEventListener('click', () => {\r\n      this.slider.createTab(AppIncludedChatsTab).open(this.filter, 'excluded', this);\r\n    });\r\n\r\n    this.confirmBtn.addEventListener('click', () => {\r\n      if(this.nameInputField.input.classList.contains('error')) {\r\n        return;\r\n      }\r\n\r\n      if(!this.nameInputField.value.trim()) {\r\n        this.nameInputField.input.classList.add('error');\r\n        return;\r\n      }\r\n\r\n      let include = (Array.from(includedFlagsContainer.children) as HTMLElement[]).slice(1).reduce((acc, el) => acc + +!el.style.display, 0);\r\n      include += this.filter.include_peers.length;\r\n      \r\n      if(!include) {\r\n        toast('Please choose at least one chat for this folder.');\r\n        return;\r\n      }\r\n\r\n      this.confirmBtn.setAttribute('disabled', 'true');\r\n\r\n      let promise: Promise<boolean>;\r\n      if(!this.filter.id) {\r\n        promise = this.managers.filtersStorage.createDialogFilter(this.filter);\r\n      } else {\r\n        promise = this.managers.filtersStorage.updateDialogFilter(this.filter);\r\n      }\r\n\r\n      promise.then((bool) => {\r\n        if(bool) {\r\n          this.close();\r\n        }\r\n      }).catch((err) => {\r\n        if(err.type === 'DIALOG_FILTERS_TOO_MUCH') {\r\n          toast('Sorry, you can\\'t create more folders.');\r\n        } else {\r\n          console.error('updateDialogFilter error:', err);\r\n        }\r\n      }).finally(() => {\r\n        this.confirmBtn.removeAttribute('disabled');\r\n      });\r\n    });\r\n    \r\n    this.nameInputField.input.addEventListener('input', () => {\r\n      this.filter.title = this.nameInputField.value;\r\n      this.editCheckForChange();\r\n    });\r\n\r\n    const reloadMissingPromises: Promise<any>[] = this.type === 'edit' ? [\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'pinned_peers'),\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'include_peers'),\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'exclude_peers')\r\n    ] : [];\r\n\r\n    return Promise.all([\r\n      this.loadAnimationPromise = lottieLoader.loadAnimationAsAsset({\r\n        container: this.stickerContainer,\r\n        loop: false,\r\n        autoplay: false,\r\n        width: 86,\r\n        height: 86\r\n      }, 'Folders_2').then((player) => {\r\n        this.animation = player;\r\n\r\n        return lottieLoader.waitForFirstFrame(player);\r\n      }),\r\n\r\n      ...reloadMissingPromises\r\n    ]);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.loadAnimationPromise.then(() => {\r\n      this.animation.autoplay = true;\r\n      this.animation.play();\r\n    });\r\n  }\r\n\r\n  private onCreateOpen() {\r\n    // this.caption.style.display = '';\r\n    this.setTitle('FilterNew');\r\n    this.menuBtn.classList.add('hide');\r\n    this.confirmBtn.classList.remove('hide');\r\n    this.nameInputField.value = '';\r\n\r\n    for(const flag in this.flags) {\r\n      // @ts-ignore\r\n      this.flags[flag].style.display = 'none';\r\n    }\r\n  }\r\n\r\n  private onEditOpen() {\r\n    // this.caption.style.display = 'none';\r\n    this.setTitle(this.type === 'create' ? 'FilterNew' : 'FilterHeaderEdit');\r\n\r\n    if(this.type === 'edit') {\r\n      this.menuBtn.classList.remove('hide');\r\n      this.confirmBtn.classList.add('hide');\r\n    }\r\n    \r\n    const filter = this.filter;\r\n    this.nameInputField.value = documentFragmentToHTML(wrapDraftText(filter.title));\r\n\r\n    for(const flag in this.flags) {\r\n      this.flags[flag as keyof AppEditFolderTab['flags']].style.display = !!filter.pFlags[flag as keyof AppEditFolderTab['flags']] ? '' : 'none';\r\n    }\r\n\r\n    (['includePeerIds' as const, 'excludePeerIds' as const]).forEach(async(key) => {\r\n      const section = this[key];\r\n      const ul = appDialogsManager.createChatList({ignoreClick: true});\r\n\r\n      let peers = filter[key];\r\n\r\n      // filter peers where we're kicked\r\n      const hasPeer = async(peerId: PeerId) => {\r\n        return !!(await this.managers.appMessagesManager.getDialogOnly(peerId)) || (peerId.isUser() ? (await this.managers.appUsersManager.getUser(peerId.toUserId()))._ === 'user' : false);\r\n      };\r\n      \r\n      const filtered = await filterAsync(peers, (peerId) => hasPeer(peerId));\r\n      peers.length = 0;\r\n      peers.push(...filtered);\r\n\r\n      peers = peers.slice();\r\n\r\n      const renderMore = async(_length: number) => {\r\n        for(let i = 0, length = Math.min(peers.length, _length); i < length; ++i) {\r\n          const peerId = peers.shift();\r\n          if(peerId.isUser() ? false : !(await this.managers.appMessagesManager.getDialogOnly(peerId))) {\r\n            continue;\r\n          }\r\n\r\n          const {dom} = appDialogsManager.addDialogNew({\r\n            peerId: peerId,\r\n            container: ul,\r\n            rippleEnabled: false,\r\n            meAsSaved: true,\r\n            avatarSize: 32\r\n          });\r\n          dom.lastMessageSpan.parentElement.remove();\r\n        }\r\n\r\n        if(peers.length) {\r\n          showMore.lastElementChild.replaceWith(i18n('FilterShowMoreChats', [peers.length]));\r\n        } else if(showMore) {\r\n          showMore.remove();\r\n        }\r\n      };\r\n      \r\n      section.generateContentElement().append(ul);\r\n\r\n      let showMore: HTMLElement;\r\n      if(peers.length) {\r\n        const content = section.generateContentElement();\r\n        showMore = Button('folder-category-button btn btn-primary btn-transparent', {icon: 'down'});\r\n        showMore.classList.add('load-more', 'rp-overflow');\r\n        showMore.addEventListener('click', () => renderMore(20));\r\n        showMore.append(i18n('FilterShowMoreChats', [peers.length]));\r\n\r\n        content.append(showMore);\r\n      }\r\n\r\n      renderMore(4);\r\n    });\r\n  }\r\n\r\n  editCheckForChange() {\r\n    if(this.type === 'edit') {\r\n      const changed = !deepEqual(this.originalFilter, this.filter);\r\n      this.confirmBtn.classList.toggle('hide', !changed);\r\n      this.menuBtn.classList.toggle('hide', changed);\r\n    }\r\n  };\r\n\r\n  setFilter(filter: DialogFilter, firstTime: boolean) {\r\n    if(this.container) {\r\n      // cleanup\r\n      Array.from(this.container.querySelectorAll('ul, .load-more')).forEach((el) => el.remove());\r\n    }\r\n\r\n    if(firstTime) {\r\n      this.originalFilter = filter;\r\n      this.filter = copy(filter);\r\n    } else {\r\n      this.filter = filter;\r\n      this.onEditOpen();\r\n      this.editCheckForChange();\r\n    }\r\n  }\r\n\r\n  public open(filter?: DialogFilter) {\r\n    if(filter === undefined) {\r\n      this.setFilter({\r\n        _: 'dialogFilter',\r\n        id: 0,\r\n        title: '',\r\n        pFlags: {},\r\n        pinned_peers: [],\r\n        include_peers: [],\r\n        exclude_peers: [],\r\n        pinnedPeerIds: [],\r\n        includePeerIds: [],\r\n        excludePeerIds: []\r\n      }, true);\r\n      this.type = 'create';\r\n    } else {\r\n      this.setFilter(filter, true);\r\n      this.type = 'edit';\r\n    }\r\n\r\n    return super.open().then(() => {\r\n      if(this.type === 'edit') {\r\n        this.setFilter(this.originalFilter, true);\r\n        this.onEditOpen();\r\n      } else {\r\n        this.onCreateOpen();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport lottieLoader, { LottieLoader } from \"../../../lib/rlottie/lottieLoader\";\r\nimport { toast } from \"../../toast\";\r\nimport type { MyDialogFilter } from \"../../../lib/storages/filters\";\r\nimport type { DialogFilterSuggested, DialogFilter } from \"../../../layer\";\r\nimport type _rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppEditFolderTab from \"./editFolder\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"..\";\r\nimport { i18n, i18n_, LangPackKey, join } from \"../../../lib/langPack\";\r\nimport cancelEvent from \"../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport positionElementByIndex from \"../../../helpers/dom/positionElementByIndex\";\r\nimport RLottiePlayer from \"../../../lib/rlottie/rlottiePlayer\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppChatFoldersTab extends SliderSuperTab {\r\n  private createFolderBtn: HTMLElement;\r\n  private foldersSection: SettingSection;\r\n  private suggestedSection: SettingSection;\r\n  private stickerContainer: HTMLElement;\r\n  private animation: RLottiePlayer;\r\n\r\n  private filtersRendered: {[filterId: number]: Row} = {};\r\n  private loadAnimationPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  private async renderFolder(dialogFilter: DialogFilterSuggested | MyDialogFilter, container?: HTMLElement, row?: Row) {\r\n    let filter: MyDialogFilter;\r\n    let description = '';\r\n    let d: HTMLElement[] = [];\r\n    if(dialogFilter._ === 'dialogFilterSuggested') {\r\n      filter = dialogFilter.filter as MyDialogFilter;\r\n      description = dialogFilter.description;\r\n    } else {\r\n      filter = dialogFilter;\r\n\r\n      let enabledFilters = Object.keys(filter.pFlags).length;\r\n      /* (['include_peers', 'exclude_peers'] as ['include_peers', 'exclude_peers']).forEach((key) => {\r\n        enabledFilters += +!!filter[key].length;\r\n      }); */\r\n      \r\n      if(enabledFilters === 1) {\r\n        const pFlags = filter.pFlags;\r\n        let k: LangPackKey;\r\n        if(pFlags.contacts) k = 'FilterAllContacts';\r\n        else if(pFlags.non_contacts) k = 'FilterAllNonContacts';\r\n        else if(pFlags.groups) k = 'FilterAllGroups';\r\n        else if(pFlags.broadcasts) k = 'FilterAllChannels';\r\n        else if(pFlags.bots) k = 'FilterAllBots';\r\n\r\n        if(k) {\r\n          d.push(i18n(k));\r\n        }\r\n      }\r\n      \r\n      if(!d.length) {\r\n        const folder = await this.managers.dialogsStorage.getFolderDialogs(filter.id);\r\n        let chats = 0, channels = 0, groups = 0;\r\n        await Promise.all(folder.map(async(dialog) => {\r\n          if(await this.managers.appPeersManager.isAnyGroup(dialog.peerId)) groups++;\r\n          else if(await this.managers.appPeersManager.isBroadcast(dialog.peerId)) channels++;\r\n          else chats++;\r\n        }));\r\n\r\n        if(chats) d.push(i18n('Chats', [chats]));\r\n        if(channels) d.push(i18n('Channels', [channels]));\r\n        if(groups) d.push(i18n('Groups', [groups]));\r\n      }\r\n    }\r\n\r\n    let div: HTMLElement;\r\n    if(!row) {\r\n      row = new Row({\r\n        title: wrapEmojiText(filter.title),\r\n        subtitle: description,\r\n        clickable: true\r\n      });\r\n\r\n      if(d.length) {\r\n        join(d).forEach((el) => {\r\n          row.subtitle.append(el);\r\n        });\r\n      }\r\n  \r\n      if(dialogFilter._ === 'dialogFilter') {\r\n        const filterId = filter.id;\r\n        if(!this.filtersRendered.hasOwnProperty(filter.id)) {\r\n          attachClickEvent(row.container, async() => {\r\n            this.slider.createTab(AppEditFolderTab).open(await this.managers.filtersStorage.getFilter(filterId));\r\n          }, {listenerSetter: this.listenerSetter});\r\n        }\r\n\r\n        this.filtersRendered[filter.id] = row;\r\n      }\r\n    } else {\r\n      row.subtitle.textContent = '';\r\n      join(d).forEach((el) => {\r\n        row.subtitle.append(el);\r\n      });\r\n    }\r\n\r\n    div = row.container;\r\n\r\n    if((filter as MyDialogFilter).hasOwnProperty('orderIndex')) {\r\n       // ! header will be at 0 index\r\n      positionElementByIndex(div, div.parentElement || container, (filter as MyDialogFilter).orderIndex);\r\n    } else if(container) container.append(div);\r\n    \r\n    return div;\r\n  }\r\n\r\n  protected async init() {\r\n    this.container.classList.add('chat-folders-container');\r\n    this.setTitle('ChatList.Filter.List.Title');\r\n\r\n    this.scrollable.container.classList.add('chat-folders');\r\n\r\n    this.stickerContainer = document.createElement('div');\r\n    this.stickerContainer.classList.add('sticker-container');\r\n    \r\n    const caption = document.createElement('div');\r\n    caption.classList.add('caption');\r\n    i18n_({element: caption, key: 'ChatList.Filter.Header'});\r\n    \r\n    this.createFolderBtn = Button('btn-primary btn-color-primary btn-control tgico', {\r\n      text: 'ChatList.Filter.NewTitle',\r\n      icon: 'add'\r\n    });\r\n\r\n    this.foldersSection = new SettingSection({\r\n      name: 'Filters'\r\n    });\r\n    this.foldersSection.container.style.display = 'none';\r\n\r\n    this.suggestedSection = new SettingSection({\r\n      name: 'FilterRecommended'\r\n    });\r\n    this.suggestedSection.container.style.display = 'none';\r\n\r\n    this.scrollable.append(this.stickerContainer, caption, this.createFolderBtn, this.foldersSection.container, this.suggestedSection.container);\r\n\r\n    attachClickEvent(this.createFolderBtn, async() => {\r\n      const appConfig = await this.managers.apiManager.getAppConfig();\r\n      if(Object.keys(this.filtersRendered).length >= (rootScope.premium ? appConfig.dialog_filters_limit_premium : appConfig.dialog_filters_limit_default)) {\r\n        toast('Sorry, you can\\'t create more folders.');\r\n      } else {\r\n        this.slider.createTab(AppEditFolderTab).open();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const onFiltersContainerUpdate = () => {\r\n      this.foldersSection.container.style.display = Object.keys(this.filtersRendered).length ? '' : 'none';\r\n    };\r\n\r\n    this.managers.filtersStorage.getDialogFilters().then(async(filters) => {\r\n      for(const filter of filters) {\r\n        await this.renderFolder(filter, this.foldersSection.content);\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_update', async(filter) => {\r\n      if(this.filtersRendered.hasOwnProperty(filter.id)) {\r\n        await this.renderFolder(filter, null, this.filtersRendered[filter.id]);\r\n      } else {\r\n        await this.renderFolder(filter, this.foldersSection.content);\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n\r\n      this.getSuggestedFilters();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_delete', (filter) => {\r\n      if(this.filtersRendered.hasOwnProperty(filter.id)) {\r\n        /* for(const suggested of this.suggestedFilters) {\r\n          if(deepEqual(suggested.filter, filter)) {\r\n            \r\n          }\r\n        } */\r\n        this.getSuggestedFilters();\r\n\r\n        this.filtersRendered[filter.id].container.remove();\r\n        delete this.filtersRendered[filter.id];\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_order', (order) => {\r\n      order.forEach((filterId, idx) => {\r\n        const container = this.filtersRendered[filterId].container;\r\n        positionElementByIndex(container, container.parentElement, idx + 1); // ! + 1 due to header \r\n      });\r\n    });\r\n\r\n    this.loadAnimationPromise = lottieLoader.loadAnimationAsAsset({\r\n      container: this.stickerContainer,\r\n      loop: false,\r\n      autoplay: false,\r\n      width: 86,\r\n      height: 86\r\n    }, 'Folders_1').then((player) => {\r\n      this.animation = player;\r\n\r\n      return lottieLoader.waitForFirstFrame(player);\r\n    });\r\n\r\n    this.getSuggestedFilters()\r\n\r\n    /* return Promise.all([\r\n      this.loadAnimationPromise\r\n    ]); */\r\n    return this.loadAnimationPromise;\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.loadAnimationPromise.then(() => {\r\n      this.animation.autoplay = true;\r\n      this.animation.play();\r\n    });\r\n  }\r\n\r\n  private getSuggestedFilters() {\r\n    return this.managers.filtersStorage.getSuggestedDialogsFilters().then(async(suggestedFilters) => {\r\n      this.suggestedSection.container.style.display = suggestedFilters.length ? '' : 'none';\r\n      Array.from(this.suggestedSection.content.children).slice(1).forEach((el) => el.remove());\r\n\r\n      for(const filter of suggestedFilters) {\r\n        const div = await this.renderFolder(filter);\r\n        const button = Button('btn-primary btn-color-primary', {text: 'Add'});\r\n        div.append(button);\r\n        this.suggestedSection.content.append(div);\r\n\r\n        attachClickEvent(button, (e) => {\r\n          cancelEvent(e);\r\n\r\n          if(Object.keys(this.filtersRendered).length >= 10) {\r\n            toast('Sorry, you can\\'t create more folders.');\r\n            return;\r\n          }\r\n\r\n          button.setAttribute('disabled', 'true');\r\n\r\n          const f = filter.filter as MyDialogFilter;\r\n          f.includePeerIds = [];\r\n          f.excludePeerIds = [];\r\n          f.pinnedPeerIds = [];\r\n\r\n          this.managers.filtersStorage.createDialogFilter(f, true).then((bool) => {\r\n            if(bool) {\r\n              div.remove();\r\n            }\r\n          }).finally(() => {\r\n            button.removeAttribute('disabled');\r\n          });\r\n        }, {listenerSetter: this.listenerSetter});\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport { InputNotifyPeer, Update } from \"../../../layer\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { LangPackKey } from \"../../../lib/langPack\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport convertKeyToInputKey from \"../../../helpers/string/convertKeyToInputKey\";\r\nimport { MUTE_UNTIL } from \"../../../lib/mtproto/mtproto_config\";\r\nimport apiManagerProxy from \"../../../lib/mtproto/mtprotoworker\";\r\n\r\ntype InputNotifyKey = Exclude<InputNotifyPeer['_'], 'inputNotifyPeer'>;\r\n\r\nexport default class AppNotificationsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('notifications-container', 'with-border');\r\n    this.setTitle('Telegram.NotificationSettingsViewController');\r\n\r\n    const NotifySection = (options: {\r\n      name: LangPackKey,\r\n      typeText: LangPackKey,\r\n      inputKey: InputNotifyKey,\r\n    }) => {\r\n      const section = new SettingSection({\r\n        name: options.name\r\n      });\r\n\r\n      const enabledRow = new Row({\r\n        checkboxField: new CheckboxField({text: options.typeText, checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n      });\r\n      \r\n      const previewEnabledRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'MessagePreview', checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n      });\r\n\r\n      section.content.append(enabledRow.container, previewEnabledRow.container);\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      const inputNotifyPeer = {_: options.inputKey};\r\n      const ret = this.managers.appNotificationsManager.getNotifySettings(inputNotifyPeer);\r\n      (ret instanceof Promise ? ret : Promise.resolve(ret)).then((notifySettings) => {\r\n        const applySettings = async() => {\r\n          const muted = await this.managers.appNotificationsManager.isMuted(notifySettings);\r\n          enabledRow.checkboxField.checked = !muted;\r\n          previewEnabledRow.checkboxField.checked = notifySettings.show_previews;\r\n  \r\n          return muted;\r\n        };\r\n        \r\n        applySettings();\r\n\r\n        this.eventListener.addEventListener('destroy', async() => {\r\n          const mute = !enabledRow.checkboxField.checked;\r\n          const showPreviews = previewEnabledRow.checkboxField.checked;\r\n\r\n          if(mute === (await this.managers.appNotificationsManager.isMuted(notifySettings)) && showPreviews === notifySettings.show_previews) {\r\n            return;\r\n          }\r\n\r\n          const inputSettings: any = copy(notifySettings);\r\n          inputSettings._ = 'inputPeerNotifySettings';\r\n          inputSettings.mute_until = mute ? MUTE_UNTIL : 0;\r\n          inputSettings.show_previews = showPreviews;\r\n\r\n          this.managers.appNotificationsManager.updateNotifySettings(inputNotifyPeer, inputSettings);\r\n        }, {once: true});\r\n\r\n        this.listenerSetter.add(rootScope)('notify_settings', (update: Update.updateNotifySettings) => {\r\n          const inputKey = convertKeyToInputKey(update.peer._) as any;\r\n          if(options.inputKey === inputKey) {\r\n            notifySettings = update.notify_settings;\r\n            applySettings();\r\n          }\r\n        });\r\n      });\r\n    };\r\n\r\n    NotifySection({\r\n      name: 'NotificationsPrivateChats',\r\n      typeText: 'NotificationsForPrivateChats',\r\n      inputKey: 'inputNotifyUsers'\r\n    });\r\n\r\n    NotifySection({\r\n      name: 'NotificationsGroups',\r\n      typeText: 'NotificationsForGroups',\r\n      inputKey: 'inputNotifyChats'\r\n    });\r\n\r\n    NotifySection({\r\n      name: 'NotificationsChannels',\r\n      typeText: 'NotificationsForChannels',\r\n      inputKey: 'inputNotifyBroadcasts'\r\n    });\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'NotificationsOther'\r\n      });\r\n\r\n      const contactsSignUpRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'ContactJoined', checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n      });\r\n      \r\n      const soundRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'Notifications.Sound', checked: true, stateKey: 'settings.notifications.sound'}),\r\n        subtitleLangKey: 'Loading',\r\n      });\r\n\r\n      apiManagerProxy.getState().then((state) => {\r\n        soundRow.checkboxField.checked = state.settings.notifications.sound;\r\n      });\r\n\r\n      section.content.append(contactsSignUpRow.container, soundRow.container);\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      this.managers.appNotificationsManager.getContactSignUpNotification().then((enabled) => {\r\n        contactsSignUpRow.checkboxField.checked = enabled;\r\n\r\n        this.eventListener.addEventListener('destroy', () => {\r\n          const _enabled = contactsSignUpRow.checkboxField.checked;\r\n          if(enabled !== _enabled) {\r\n            this.managers.appNotificationsManager.setContactSignUpNotification(!_enabled);\r\n          }\r\n        }, {once: true});\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport { randomLong } from \"../../../helpers/random\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport { SliderSuperTab } from \"../../slider\"\r\n\r\nexport default class AppLanguageTab extends SliderSuperTab {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('language-container');\r\n    this.setTitle('Telegram.LanguageViewController');\r\n\r\n    const section = new SettingSection({});\r\n\r\n    const radioRows: Map<string, Row> = new Map();\r\n\r\n    const promise = this.managers.apiManager.invokeApiCacheable('langpack.getLanguages', {\r\n      lang_pack: 'macos'\r\n    }).then((languages) => {\r\n      const random = randomLong();\r\n      languages.forEach((language) => {\r\n        const row = new Row({\r\n          radioField: new RadioField({\r\n            text: language.name, \r\n            name: random, \r\n            value: language.lang_code\r\n          }),\r\n          subtitle: language.native_name\r\n        });\r\n        \r\n        radioRows.set(language.lang_code, row);\r\n      });\r\n\r\n      const form = RadioFormFromRows([...radioRows.values()], (value) => {\r\n        I18n.getLangPack(value);\r\n      });\r\n  \r\n      I18n.getCacheLangPack().then((langPack) => {\r\n        const row = radioRows.get(langPack.lang_code);\r\n        if(!row) {\r\n          console.error('no row', row, langPack);\r\n          return;\r\n        }\r\n  \r\n        row.radioField.setValueSilently(true);\r\n      });\r\n  \r\n      section.content.append(form);\r\n    });\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    return promise;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { addCancelButton } from \"./popups\";\r\nimport PopupPeer, { PopupPeerOptions } from \"./popups/peer\";\r\n\r\n// type PopupConfirmationOptions = Pick<PopupPeerOptions, 'titleLangKey'>;\r\ntype PopupConfirmationOptions = PopupPeerOptions & {\r\n  button: PopupPeerOptions['buttons'][0],\r\n  checkbox?: PopupPeerOptions['checkboxes'][0]\r\n};\r\n\r\nexport default function confirmationPopup(options: PopupConfirmationOptions) {\r\n  return new Promise<boolean | void>((resolve, reject) => {\r\n    const {button, checkbox} = options;\r\n    button.callback = (set) => {\r\n      resolve(set ? !!set.size : undefined);\r\n    };\r\n\r\n    const buttons = addCancelButton([button]);\r\n    const cancelButton = buttons.find((button) => button.isCancel);\r\n    cancelButton.callback = () => {\r\n      reject();\r\n    };\r\n\r\n    options.buttons = buttons;\r\n    options.checkboxes = checkbox && [checkbox];\r\n\r\n    new PopupPeer('popup-confirmation', options).show();\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport CheckboxField from \"../../../checkboxField\";\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\n\r\nexport function autoDownloadPeerTypeSection(type: 'photo' | 'video' | 'file', title: LangPackKey) {\r\n  const section = new SettingSection({name: title});\r\n\r\n  const key = 'settings.autoDownload.' + type + '.';\r\n  const contactsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadContacts', \r\n    name: 'contacts',\r\n    stateKey: key + 'contacts',\r\n    withRipple: true\r\n  });\r\n  const privateCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadPrivateChats', \r\n    name: 'private',\r\n    stateKey: key + 'private',\r\n    withRipple: true\r\n  });\r\n  const groupsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadGroupChats', \r\n    name: 'groups',\r\n    stateKey: key + 'groups',\r\n    withRipple: true\r\n  });\r\n  const channelsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadChannels', \r\n    name: 'channels',\r\n    stateKey: key + 'channels',\r\n    withRipple: true\r\n  });\r\n\r\n  section.content.append(\r\n    contactsCheckboxField.label, \r\n    privateCheckboxField.label, \r\n    groupsCheckboxField.label, \r\n    channelsCheckboxField.label\r\n  );\r\n\r\n  return section;\r\n}\r\n\r\nexport default class AppAutoDownloadPhotoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadPhotos');\r\n\r\n    const section = autoDownloadPeerTypeSection('photo', 'AutoDownloadPhotosTitle');\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport formatBytes from \"../../../../helpers/formatBytes\";\r\nimport debounce from \"../../../../helpers/schedulers/debounce\";\r\nimport I18n from \"../../../../lib/langPack\";\r\nimport rootScope from \"../../../../lib/rootScope\";\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport { RangeSettingSelector } from \"../generalSettings\";\r\nimport { autoDownloadPeerTypeSection } from \"./photo\";\r\n\r\nexport default class AppAutoDownloadFileTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadFiles');\r\n\r\n    const debouncedSave = debounce((sizeMax: number) => {\r\n      this.managers.appStateManager.setByKey('settings.autoDownloadNew.file_size_max', sizeMax);\r\n    }, 200, false, true);\r\n\r\n    const section = autoDownloadPeerTypeSection('file', 'AutoDownloadFilesTitle');\r\n\r\n    const MIN = 512 * 1024;\r\n    // const MAX = 2 * 1024 * 1024 * 1024;\r\n    const MAX = 20 * 1024 * 1024;\r\n    const MAX_RANGE = MAX - MIN;\r\n\r\n    const sizeMax = rootScope.settings.autoDownloadNew.file_size_max;\r\n    const value = Math.sqrt(Math.sqrt((sizeMax - MIN) / MAX_RANGE));\r\n    const upTo = new I18n.IntlElement({\r\n      key: 'AutodownloadSizeLimitUpTo',\r\n      args: [formatBytes(sizeMax)]\r\n    });\r\n    const range = new RangeSettingSelector('AutoDownloadMaxFileSize', 0.01, value, 0, 1, false);\r\n    range.onChange = (value) => {\r\n      const sizeMax = (value ** 4 * MAX_RANGE + MIN) | 0;\r\n\r\n      upTo.compareAndUpdate({args: [formatBytes(sizeMax)]});\r\n\r\n      debouncedSave(sizeMax);\r\n    };\r\n\r\n    range.valueContainer.append(upTo.element);\r\n\r\n    section.content.append(range.container);\r\n\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport { autoDownloadPeerTypeSection } from \"./photo\";\r\n\r\nexport default class AppAutoDownloadVideoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadVideos');\r\n\r\n    const section = autoDownloadPeerTypeSection('video', 'AutoDownloadVideosTitle');\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AutoDownloadPeerTypeSettings, STATE_INIT } from \"../../../config/state\";\r\nimport { SettingSection } from \"..\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport formatBytes from \"../../../helpers/formatBytes\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport { FormatterArguments, i18n, join, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport confirmationPopup from \"../../confirmationPopup\";\r\nimport Row from \"../../row\";\r\nimport { SliderSuperTabEventable, SliderSuperTabEventableConstructable } from \"../../sliderTab\";\r\nimport AppAutoDownloadFileTab from \"./autoDownload/file\";\r\nimport AppAutoDownloadPhotoTab from \"./autoDownload/photo\";\r\nimport AppAutoDownloadVideoTab from \"./autoDownload/video\";\r\nimport apiManagerProxy from \"../../../lib/mtproto/mtprotoworker\";\r\n\r\nconst AUTO_DOWNLOAD_FOR_KEYS: {[k in keyof AutoDownloadPeerTypeSettings]: LangPackKey} = {\r\n  contacts: 'AutoDownloadContacts',\r\n  private: 'AutoDownloadPm',\r\n  groups: 'AutoDownloadGroups',\r\n  channels: 'AutoDownloadChannels'\r\n};\r\n\r\nexport default class AppDataAndStorageTab extends SliderSuperTabEventable {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('DataSettings');\r\n\r\n    {\r\n      const section = new SettingSection({name: 'AutomaticMediaDownload', caption: 'AutoDownloadAudioInfo'});\r\n\r\n      const state = await apiManagerProxy.getState();\r\n\r\n      const autoCheckboxField = new CheckboxField({\r\n        text: 'AutoDownloadMedia', \r\n        name: 'auto',\r\n        checked: !state.settings.autoDownloadNew.pFlags.disabled,\r\n        withRipple: true\r\n      });\r\n\r\n      const onChange = () => {\r\n        toggleDisability([resetButton], \r\n          deepEqual(state.settings.autoDownload, STATE_INIT.settings.autoDownload) && \r\n          deepEqual(state.settings.autoDownloadNew, STATE_INIT.settings.autoDownloadNew));\r\n      };\r\n\r\n      const setSubtitles = () => {\r\n        this.setAutoDownloadSubtitle(photoRow, state.settings.autoDownload.photo, /* state.settings.autoDownloadNew.photo_size_max */);\r\n        this.setAutoDownloadSubtitle(videoRow, state.settings.autoDownload.video/* , state.settings.autoDownloadNew.video_size_max */);\r\n        this.setAutoDownloadSubtitle(fileRow, state.settings.autoDownload.file, state.settings.autoDownloadNew.file_size_max);\r\n      };\r\n\r\n      const openTab = (tabConstructor: SliderSuperTabEventableConstructable) => {\r\n        const tab = new tabConstructor(this.slider, true);\r\n        tab.open();\r\n\r\n        this.listenerSetter.add(tab.eventListener)('destroy', () => {\r\n          setSubtitles();\r\n          onChange();\r\n        }, {once: true});\r\n      };\r\n      \r\n      const photoRow = new Row({\r\n        titleLangKey: 'AutoDownloadPhotos',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadPhotoTab);\r\n        }\r\n      });\r\n\r\n      const videoRow = new Row({\r\n        titleLangKey: 'AutoDownloadVideos',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadVideoTab);\r\n        }\r\n      });\r\n\r\n      const fileRow = new Row({\r\n        titleLangKey: 'AutoDownloadFiles',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadFileTab);\r\n        }\r\n      });\r\n\r\n      const resetButton = Button('btn-primary btn-transparent primary', {icon: 'delete', text: 'ResetAutomaticMediaDownload'});\r\n      attachClickEvent(resetButton, () => {\r\n        confirmationPopup({\r\n          titleLangKey: 'ResetAutomaticMediaDownloadAlertTitle',\r\n          descriptionLangKey: 'ResetAutomaticMediaDownloadAlert',\r\n          button: {\r\n            langKey: 'Reset'\r\n          }\r\n        }).then(() => {\r\n          const settings = rootScope.settings;\r\n          settings.autoDownloadNew = copy(STATE_INIT.settings.autoDownloadNew);\r\n          settings.autoDownload = copy(STATE_INIT.settings.autoDownload);\r\n          this.managers.appStateManager.setByKey('settings', settings);\r\n\r\n          setSubtitles();\r\n          autoCheckboxField.checked = !state.settings.autoDownloadNew.pFlags.disabled;\r\n        });\r\n      });\r\n\r\n      const onDisabledChange = () => {\r\n        const disabled = !autoCheckboxField.checked;\r\n\r\n        const settings = rootScope.settings;\r\n        if(disabled) {\r\n          settings.autoDownloadNew.pFlags.disabled = true;\r\n        } else {\r\n          delete settings.autoDownloadNew.pFlags.disabled;\r\n        }\r\n\r\n        [photoRow, videoRow, fileRow].forEach((row) => {\r\n          row.container.classList.toggle('is-disabled', disabled);\r\n        });\r\n        \r\n        this.managers.appStateManager.setByKey('settings', settings);\r\n\r\n        onChange();\r\n      };\r\n\r\n      autoCheckboxField.input.addEventListener('change', onDisabledChange);\r\n      onDisabledChange();\r\n      setSubtitles();\r\n\r\n      section.content.append(\r\n        autoCheckboxField.label,\r\n        photoRow.container,\r\n        videoRow.container,\r\n        fileRow.container,\r\n        resetButton\r\n      );\r\n      \r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'AutoplayMedia'});\r\n\r\n      const gifsCheckboxField = new CheckboxField({\r\n        text: 'AutoplayGIF', \r\n        name: 'gifs', \r\n        stateKey: 'settings.autoPlay.gifs',\r\n        withRipple: true\r\n      });\r\n      const videosCheckboxField = new CheckboxField({\r\n        text: 'AutoplayVideo', \r\n        name: 'videos', \r\n        stateKey: 'settings.autoPlay.videos',\r\n        withRipple: true\r\n      });\r\n\r\n      section.content.append(gifsCheckboxField.label, videosCheckboxField.label);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n\r\n  private setAutoDownloadSubtitle(row: Row, settings: AutoDownloadPeerTypeSettings, sizeMax?: number) {\r\n    let key: LangPackKey, args: FormatterArguments = [];\r\n    \r\n    const peerKeys = Object.keys(settings) as (keyof typeof AUTO_DOWNLOAD_FOR_KEYS)[];\r\n    const enabledKeys = peerKeys.map((key) => settings[key] ? AUTO_DOWNLOAD_FOR_KEYS[key] : undefined).filter(Boolean);\r\n    if(!enabledKeys.length || sizeMax === 0) {\r\n      key = 'AutoDownloadOff';\r\n    } else {\r\n      const isAll = enabledKeys.length === peerKeys.length;\r\n      if(sizeMax !== undefined) {\r\n        key = isAll ? 'AutoDownloadUpToOnAllChats' : 'AutoDownloadOnUpToFor';\r\n        args.push(formatBytes(sizeMax));\r\n      } else {\r\n        key = isAll ? 'AutoDownloadOnAllChats' : 'AutoDownloadOnFor';\r\n      }\r\n  \r\n      if(!isAll) {\r\n        const fragment = document.createElement('span');\r\n        fragment.append(...join(enabledKeys.map((key) => i18n(key)), true, false));\r\n        args.push(fragment);\r\n      }\r\n    }\r\n    \r\n    replaceContent(row.subtitle, i18n(key, args));\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport ButtonMenuToggle from \"../../buttonMenuToggle\";\r\nimport Button from \"../../button\";\r\nimport AppPrivacyAndSecurityTab from \"./privacyAndSecurity\";\r\nimport AppGeneralSettingsTab from \"./generalSettings\";\r\nimport AppEditProfileTab from \"./editProfile\";\r\nimport AppChatFoldersTab from \"./chatFolders\";\r\nimport AppNotificationsTab from \"./notifications\";\r\nimport AppLanguageTab from \"./language\";\r\nimport lottieLoader from \"../../../lib/rlottie/lottieLoader\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport AppDataAndStorageTab from \"./dataAndStorage\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport PeerProfile from \"../../peerProfile\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport AppActiveSessionsTab from \"./activeSessions\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { SliderSuperTabConstructable } from \"../../sliderTab\";\r\nimport PopupAvatar from \"../../popups/avatar\";\r\nimport { AccountAuthorizations, Authorization } from \"../../../layer\";\r\nimport PopupElement from \"../../popups\";\r\n//import AppMediaViewer from \"../../appMediaViewerNew\";\r\n\r\nexport default class AppSettingsTab extends SliderSuperTab {\r\n  private buttons: {\r\n    edit: HTMLButtonElement,\r\n    folders: HTMLButtonElement,\r\n    general: HTMLButtonElement,\r\n    notifications: HTMLButtonElement,\r\n    storage: HTMLButtonElement,\r\n    privacy: HTMLButtonElement,\r\n  } = {} as any;\r\n  private profile: PeerProfile;\r\n\r\n  private languageRow: Row;\r\n  private devicesRow: Row;\r\n\r\n  private authorizations: Authorization.authorization[];\r\n  private getAuthorizationsPromise: Promise<AccountAuthorizations.accountAuthorizations>;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('settings-container');\r\n    this.setTitle('Settings');\r\n    \r\n    const btnMenu = ButtonMenuToggle({}, 'bottom-left', [{\r\n      icon: 'logout',\r\n      text: 'EditAccount.Logout',\r\n      onClick: () => {\r\n        new PopupPeer('logout', {\r\n          titleLangKey: 'LogOut',\r\n          descriptionLangKey: 'LogOut.Description',\r\n          buttons: [{\r\n            langKey: 'LogOut',\r\n            callback: () => {\r\n              this.managers.apiManager.logOut();\r\n            },\r\n            isDanger: true\r\n          }]\r\n        }).show();\r\n      }\r\n    }]);\r\n\r\n    this.buttons.edit = ButtonIcon('edit');\r\n\r\n    this.header.append(this.buttons.edit, btnMenu);\r\n\r\n    this.profile = new PeerProfile(this.managers, this.scrollable, this.listenerSetter, false);\r\n    this.profile.init();\r\n    this.profile.setPeer(rootScope.myId);\r\n    const fillPromise = this.profile.fillProfileElements();\r\n\r\n    const changeAvatarBtn = Button('btn-circle btn-corner z-depth-1 profile-change-avatar', {icon: 'cameraadd'});\r\n    changeAvatarBtn.addEventListener('click', () => {\r\n      const canvas = document.createElement('canvas');\r\n      PopupElement.createPopup(PopupAvatar).open(canvas, (upload) => {\r\n        upload().then((inputFile) => {\r\n          return this.managers.appProfileManager.uploadProfilePhoto(inputFile);\r\n        });\r\n      });\r\n    });\r\n    this.profile.element.lastElementChild.firstElementChild.append(changeAvatarBtn);\r\n    \r\n    const updateChangeAvatarBtn = async() => {\r\n      const user = await this.managers.appUsersManager.getSelf();\r\n      changeAvatarBtn.classList.toggle('hide', user.photo?._ !== 'userProfilePhoto');\r\n    };\r\n    \r\n    updateChangeAvatarBtn();\r\n    this.listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(rootScope.myId === peerId) {\r\n        updateChangeAvatarBtn();\r\n      }\r\n    });\r\n\r\n    /* const div = document.createElement('div');\r\n    //div.style.cssText = 'border-radius: 8px; overflow: hidden; width: 396px; height: 264px; flex: 0 0 auto; position: relative; margin: 10rem 0 10rem auto;';\r\n    //div.style.width = '135px';\r\n    //div.style.height = '100px';\r\n    div.style.cssText = 'border-radius: 8px; overflow: hidden; width: 396px; height: 264px; flex: 0 0 auto; position: relative; margin: 10rem auto 10rem 0;';\r\n    div.style.width = '135px';\r\n    div.style.height = '100px';\r\n    \r\n    const img = document.createElement('img');\r\n    img.src = 'assets/img/pepe.jpg';\r\n    img.classList.add('media-photo');\r\n    img.style.cssText = 'max-width: 100%;max-height: 100%;';\r\n\r\n    div.append(img);\r\n\r\n    div.addEventListener('click', () => {\r\n      new AppMediaViewer().setSearchContext({peerId: 61004386, inputFilter: 'inputMessagesFilterPhotos'}).openMedia({\r\n        _: 'message',\r\n        mid: 1,\r\n        peerId: 61004386,\r\n        fromId: 61004386,\r\n        message: '',\r\n        media: {\r\n          _: 'messageMediaPhoto',\r\n          photo: {\r\n            _: 'photo',\r\n            url: img.src,\r\n            downloaded: 111,\r\n            sizes: [{\r\n              _: 'photoSize',\r\n              type: 'x',\r\n              w: 618,\r\n              h: 412\r\n            }]\r\n          }\r\n        },\r\n        date: Date.now() / 1000 | 0\r\n      }, img);\r\n    });\r\n\r\n    this.scrollable.append(div); */\r\n    \r\n    const buttonsDiv = document.createElement('div');\r\n    buttonsDiv.classList.add('profile-buttons');\r\n\r\n    const b: [string, LangPackKey, SliderSuperTabConstructable][] = [\r\n      ['unmute', 'AccountSettings.Notifications', AppNotificationsTab],\r\n      ['data', 'DataSettings', AppDataAndStorageTab],\r\n      ['lock', 'AccountSettings.PrivacyAndSecurity', AppPrivacyAndSecurityTab],\r\n      ['settings', 'Telegram.GeneralSettingsViewController', AppGeneralSettingsTab],\r\n      ['folder', 'AccountSettings.Filters', AppChatFoldersTab],\r\n    ];\r\n\r\n    const rows = b.map(([icon, langPackKey, tabConstructor]) => {\r\n      return new Row({\r\n        titleLangKey: langPackKey,\r\n        icon,\r\n        clickable: () => {\r\n          this.slider.createTab(tabConstructor).open();\r\n          // new tabConstructor(this.slider, true).open();\r\n        }\r\n      });\r\n    });\r\n\r\n    rows.push(\r\n      this.devicesRow = new Row({\r\n        titleLangKey: 'Devices',\r\n        titleRightSecondary: ' ',\r\n        icon: 'activesessions',\r\n        clickable: async() => {\r\n          if(!this.authorizations) {\r\n            await this.updateActiveSessions();\r\n          }\r\n\r\n          const tab = this.slider.createTab(AppActiveSessionsTab);\r\n          tab.authorizations = this.authorizations;\r\n          tab.eventListener.addEventListener('destroy', () => {\r\n            this.authorizations = undefined;\r\n            this.updateActiveSessions(true);\r\n          }, {once: true});\r\n          tab.open();\r\n        }\r\n      }),\r\n\r\n      this.languageRow = new Row({\r\n        titleLangKey: 'AccountSettings.Language',\r\n        titleRightSecondary: i18n('LanguageName'),\r\n        icon: 'language',\r\n        clickable: () => {\r\n          this.slider.createTab(AppLanguageTab).open();\r\n        }\r\n      })\r\n    );\r\n\r\n    buttonsDiv.append(...rows.map((row) => row.container));\r\n\r\n    // const profileSection = new SettingSection({fullWidth: true, noPaddingTop: true});\r\n    // profileSection.content.append(this.profile.element);\r\n\r\n    const buttonsSection = new SettingSection();\r\n    buttonsSection.content.append(buttonsDiv);\r\n\r\n    this.scrollable.append(this.profile.element/* profileSection.container */, buttonsSection.container);\r\n\r\n    this.buttons.edit.addEventListener('click', () => {\r\n      const tab = this.slider.createTab(AppEditProfileTab);\r\n      tab.open();\r\n    });\r\n\r\n    lottieLoader.loadLottieWorkers();\r\n\r\n    this.updateActiveSessions();\r\n\r\n    await fillPromise;\r\n  }\r\n\r\n  private getAuthorizations(overwrite?: boolean) {\r\n    if(this.getAuthorizationsPromise && !overwrite) return this.getAuthorizationsPromise;\r\n\r\n    const promise = this.getAuthorizationsPromise = this.managers.apiManager.invokeApi('account.getAuthorizations')\r\n    .finally(() => {\r\n      if(this.getAuthorizationsPromise === promise) {\r\n        this.getAuthorizationsPromise = undefined;\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  public updateActiveSessions(overwrite?: boolean) {\r\n    return this.getAuthorizations(overwrite).then((auths) => {\r\n      this.authorizations = auths.authorizations;\r\n      this.devicesRow.titleRight.textContent = '' + this.authorizations.length;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarLeft, { SettingSection } from \"..\";\r\nimport { InputFile } from \"../../../layer\";\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AvatarEdit from \"../../avatarEdit\";\r\nimport AppAddMembersTab from \"./addMembers\";\r\nimport { _i18n } from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\n\r\nexport default class AppNewChannelTab extends SliderSuperTab {\r\n  private uploadAvatar: () => Promise<InputFile> = null;\r\n\r\n  private channelNameInputField: InputField;\r\n  private channelDescriptionInputField: InputField;\r\n  private nextBtn: HTMLButtonElement;\r\n  private avatarEdit: AvatarEdit;\r\n\r\n  protected init() {\r\n    this.container.classList.add('new-channel-container');\r\n    this.setTitle('NewChannel');\r\n\r\n    this.avatarEdit = new AvatarEdit((_upload) => {\r\n      this.uploadAvatar = _upload;\r\n    });\r\n\r\n    const section = new SettingSection({\r\n      caption: 'Channel.DescriptionHolderDescrpiton'\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    this.channelNameInputField = new InputField({\r\n      label: 'EnterChannelName',\r\n      maxLength: 128\r\n    });\r\n\r\n    this.channelDescriptionInputField = new InputField({\r\n      label: 'DescriptionOptionalPlaceholder',\r\n      maxLength: 255\r\n    });\r\n\r\n    inputWrapper.append(this.channelNameInputField.container, this.channelDescriptionInputField.container);\r\n\r\n    const onLengthChange = () => {\r\n      this.nextBtn.classList.toggle('is-visible', !!this.channelNameInputField.value.length && \r\n        !this.channelNameInputField.input.classList.contains('error') && \r\n        !this.channelDescriptionInputField.input.classList.contains('error'));\r\n    };\r\n\r\n    this.channelNameInputField.input.addEventListener('input', onLengthChange);\r\n    this.channelDescriptionInputField.input.addEventListener('input', onLengthChange);\r\n\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n\r\n    this.nextBtn.addEventListener('click', () => {\r\n      const title = this.channelNameInputField.value;\r\n      const about = this.channelDescriptionInputField.value;\r\n\r\n      this.nextBtn.disabled = true;\r\n      this.managers.appChatsManager.createChannel({\r\n        title, \r\n        about,\r\n        broadcast: true\r\n      }).then((channelId) => {\r\n        if(this.uploadAvatar) {\r\n          this.uploadAvatar().then((inputFile) => {\r\n            this.managers.appChatsManager.editPhoto(channelId, inputFile);\r\n          });\r\n        }\r\n\r\n        appImManager.setInnerPeer({peerId: channelId.toPeerId(true)});\r\n        \r\n        appSidebarLeft.removeTabFromHistory(this);\r\n        this.slider.createTab(AppAddMembersTab).open({\r\n          type: 'channel',\r\n          skippable: true,\r\n          title: 'GroupAddMembers',\r\n          placeholder: 'SendMessageTo',\r\n          takeOut: (peerIds) => {\r\n            return this.managers.appChatsManager.inviteToChannel(channelId, peerIds);\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    this.content.append(this.nextBtn);\r\n    section.content.append(this.avatarEdit.container, inputWrapper);\r\n    this.scrollable.append(section.container);\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.avatarEdit.clear();\r\n    this.uploadAvatar = null;\r\n    this.channelNameInputField.value = '';\r\n    this.channelDescriptionInputField.value = '';\r\n    this.nextBtn.disabled = false;\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../inputField\";\r\nimport PopupElement from \".\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport EditPeer from \"../editPeer\";\r\nimport { _i18n } from \"../../lib/langPack\";\r\nimport TelInputField from \"../telInputField\";\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\nimport { toastNew } from \"../toast\";\r\n\r\nexport default class PopupCreateContact extends PopupElement {\r\n  constructor() {\r\n    super('popup-create-contact popup-send-photo popup-new-media', null, {closable: true, withConfirm: 'Add'});\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    _i18n(this.title, 'AddContactTitle');\r\n\r\n    attachClickEvent(this.btnConfirm, () => {\r\n      const promise = this.managers.appUsersManager.importContact(nameInputField.value, lastNameInputField.value, telInputField.value);\r\n\r\n      promise.then(() => {\r\n        this.hide();\r\n      }, (err) => {\r\n        if(err.type === 'NO_USER') {\r\n          toastNew({langPackKey: 'Contacts.PhoneNumber.NotRegistred'});\r\n          editPeer.disabled = false;\r\n        }\r\n      });\r\n\r\n      editPeer.lockWithPromise(promise);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const inputFields: InputField[] = [];\r\n    const div = document.createElement('div');\r\n    div.classList.add('name-fields');\r\n    const nameInputField = new InputField({\r\n      label: 'FirstName',\r\n      name: 'create-contact-name',\r\n      maxLength: 70,\r\n      required: true\r\n    });\r\n    const lastNameInputField = new InputField({\r\n      label: 'LastName',\r\n      name: 'create-contact-lastname',\r\n      maxLength: 70\r\n    });\r\n    const telInputField = new TelInputField({required: true});\r\n    inputFields.push(nameInputField, lastNameInputField, telInputField);\r\n\r\n    const onInput = () => {\r\n      const name = nameInputField.value + ' ' + lastNameInputField.value;\r\n      // const abbr = getAbbreviation(name);\r\n      editPeer.avatarElem.peerTitle = name;\r\n      editPeer.avatarElem.update();\r\n    };\r\n\r\n    this.listenerSetter.add(nameInputField.input)('input', onInput);\r\n    this.listenerSetter.add(lastNameInputField.input)('input', onInput);\r\n\r\n    telInputField.validate = () => {\r\n      return !!telInputField.value.match(/\\d/);\r\n    };\r\n\r\n    const user = await this.managers.appUsersManager.getSelf();\r\n    const formatted = formatPhoneNumber(user.phone);\r\n    if(formatted.code) {\r\n      telInputField.value = '+' + formatted.code.country_code;\r\n    }\r\n\r\n    const editPeer = new EditPeer({\r\n      inputFields,\r\n      listenerSetter: this.listenerSetter,\r\n      doNotEditAvatar: true,\r\n      nextBtn: this.btnConfirm,\r\n      avatarSize: 100\r\n    });\r\n\r\n    div.append(nameInputField.container, lastNameInputField.container, editPeer.avatarElem);\r\n    this.container.append(div, telInputField.container);\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport { IS_MOBILE } from \"../../../environment/userAgent\";\r\nimport { canFocus } from \"../../../helpers/dom/canFocus\";\r\nimport windowSize from \"../../../helpers/windowSize\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport PopupCreateContact from \"../../popups/createContact\";\r\nimport SortedUserList from \"../../sortedUserList\";\r\nimport { getMiddleware } from \"../../../helpers/middleware\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport PopupElement from \"../../popups\";\r\n\r\n// TODO: поиск по людям глобальный, если не нашло в контактах никого\r\n\r\nexport default class AppContactsTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private sortedUserList: SortedUserList;\r\n  \r\n  protected init() {\r\n    this.container.id = 'contacts-container';\r\n\r\n    // this.list = appDialogsManager.createChatList(/* {avatarSize: 48, handheldsSize: 66} */);\r\n\r\n    const btnAdd = ButtonCorner({icon: 'add', className: 'is-visible'});\r\n    this.content.append(btnAdd);\r\n\r\n    attachClickEvent(btnAdd, () => {\r\n      PopupElement.createPopup(PopupCreateContact);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.inputSearch = new InputSearch('Search', (value) => {\r\n      this.openContacts(value);\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('contacts_update', async(userId) => {\r\n      const isContact = await this.managers.appUsersManager.isContact(userId);\r\n      const peerId = userId.toPeerId();\r\n      if(isContact) this.sortedUserList.add(peerId);\r\n      else this.sortedUserList.delete(peerId);\r\n    });\r\n\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.middleware = getMiddleware();\r\n\r\n    // preload contacts\r\n    // appUsersManager.getContacts();\r\n  }\r\n\r\n  protected createList() {\r\n    const sortedUserList = new SortedUserList({\r\n      managers: this.managers\r\n    });\r\n    const list = sortedUserList.list;\r\n    list.id = 'contacts';\r\n    list.classList.add('contacts-container');\r\n    appDialogsManager.setListClickListener(list, () => {\r\n      this.close();\r\n    }, undefined, true);\r\n    return sortedUserList;\r\n  }\r\n\r\n  protected onClose() {\r\n    this.middleware.clean();\r\n    /* // need to clear, and left 1 page for smooth slide\r\n    let pageCount = appPhotosManager.windowH / 72 * 1.25 | 0;\r\n    (Array.from(this.list.children) as HTMLElement[]).slice(pageCount).forEach((el) => el.remove()); */\r\n  }\r\n\r\n  protected onOpenAfterTimeout() {\r\n    if(IS_MOBILE || !canFocus(true)) return;\r\n    this.inputSearch.input.focus();\r\n  }\r\n\r\n  public openContacts(query?: string) {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.middleware.clean();\r\n    const middleware = this.middleware.get();\r\n    this.scrollable.onScrolledBottom = null;\r\n    this.scrollable.container.textContent = '';\r\n\r\n    this.managers.appUsersManager.getContactsPeerIds(query, undefined, 'online').then((contacts) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const sortedUserList = this.sortedUserList = this.createList();\r\n\r\n      let renderPage = () => {\r\n        const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n        const arr = contacts.splice(0, pageCount); // надо splice!\r\n\r\n        arr.forEach((peerId) => {\r\n          sortedUserList.add(peerId);\r\n        });\r\n\r\n        if(!contacts.length) {\r\n          renderPage = undefined;\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n      };\r\n\r\n      renderPage();\r\n      this.scrollable.onScrolledBottom = () => {\r\n        if(renderPage) {\r\n          renderPage();\r\n        } else {\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n      };\r\n\r\n      replaceContent(this.scrollable.container, sortedUserList.list);\r\n    });\r\n  }\r\n\r\n  public open() {\r\n    this.openContacts();\r\n    return super.open();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport type { LOCAL_FOLDER_ID } from \"../../../lib/storages/dialogs\";\r\nimport type { MyDialogFilter } from \"../../../lib/storages/filters\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppArchivedTab extends SliderSuperTab {\r\n  private static filterId: LOCAL_FOLDER_ID = 1;\r\n  private wasFilterId: number;\r\n\r\n  protected init() {\r\n    this.wasFilterId = appDialogsManager.filterId;\r\n\r\n    this.container.id = 'chats-archived-container';\r\n    this.setTitle('ArchivedChats');\r\n\r\n    if(!appDialogsManager.sortedLists[AppArchivedTab.filterId]) {\r\n      const chatList = appDialogsManager.createChatList();\r\n      appDialogsManager.generateScrollable(chatList, {id: AppArchivedTab.filterId, orderIndex: 1} as any as MyDialogFilter).container.append(chatList);\r\n      appDialogsManager.setListClickListener(chatList, null, true);\r\n      //appDialogsManager.setListClickListener(archivedChatList, null, true); // * to test peer changing\r\n    }\r\n\r\n    const scrollable = appDialogsManager.scrollables[AppArchivedTab.filterId];\r\n    this.scrollable.container.replaceWith(scrollable.container);\r\n    this.scrollable = scrollable;\r\n\r\n    return appDialogsManager.setFilterIdAndChangeTab(AppArchivedTab.filterId).then(({cached, renderPromise}) => {\r\n      if(cached) {\r\n        return renderPromise;\r\n      }\r\n    });\r\n  }\r\n\r\n  // вообще, так делать нельзя, но нет времени чтобы переделать главный чатлист на слайд...\r\n  onOpenAfterTimeout() {\r\n    appDialogsManager.sortedLists[this.wasFilterId].clear();\r\n  }\r\n\r\n  onClose() {\r\n    appDialogsManager.setFilterIdAndChangeTab(this.wasFilterId);\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    appDialogsManager.sortedLists[AppArchivedTab.filterId].clear();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport AppNewGroupTab from \"./newGroup\";\r\nimport { toast } from \"../../toast\";\r\nimport { ButtonMenuItemOptions } from \"../../buttonMenu\";\r\nimport { i18n, join, _i18n } from \"../../../lib/langPack\";\r\nimport rootScope from '../../../lib/rootScope';\r\nimport { wrapSticker } from \"../../wrappers\";\r\nimport SortedUserList from \"../../sortedUserList\";\r\nimport { PeerLocated, Update, Updates } from \"../../../layer\";\r\nimport { SettingChatListSection } from \"..\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport confirmationPopup from \"../../confirmationPopup\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport type LazyLoadQueue from \"../../lazyLoadQueue\";\r\n\r\nexport default class AppPeopleNearbyTab extends SliderSuperTab {\r\n  private latestLocationSaved: {latitude: number, longitude: number, accuracy: number};\r\n  private isLocationWatched: boolean = false;\r\n  private errorCategory: HTMLElement;\r\n  private retryBtn: HTMLButtonElement;\r\n  private btnOptions: HTMLButtonElement;\r\n  private menuButtons: (ButtonMenuItemOptions & {verify?: () => boolean})[];\r\n\r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected peopleSection: SettingChatListSection;\r\n  protected chatsSection: SettingChatListSection;\r\n\r\n  protected locatedPeers: Map<PeerId, PeerLocated.peerLocated>;\r\n\r\n  // protected async init() {\r\n  //   this.container.classList.add('people-nearby-container');\r\n  //   this.setTitle('PeopleNearby');\r\n\r\n  //   this.errorCategory = document.createElement('div');\r\n  //   this.errorCategory.classList.add('text', 'hide', 'nearby-error');\r\n\r\n  //   this.retryBtn = ButtonCorner({icon: 'check'});\r\n\r\n  //   const emoji = '🧭';\r\n  //   const doc = await this.managers.appStickersManager.getAnimatedEmojiSticker(emoji);\r\n  //   const stickerContainer = document.createElement('div');\r\n  //   stickerContainer.classList.add('sticker-container');\r\n\r\n  //   if(doc) {\r\n  //     wrapSticker({\r\n  //       doc,\r\n  //       div: stickerContainer,\r\n  //       loop: false,\r\n  //       play: true,\r\n  //       width: 86,\r\n  //       height: 86,\r\n  //       emoji,\r\n  //       needUpscale: true\r\n  //     }).then(() => {\r\n  //       // this.animation = player;\r\n  //     });\r\n  //   } else {\r\n  //     stickerContainer.classList.add('media-sticker-wrapper');\r\n  //   }\r\n\r\n  //   const caption = document.createElement('div');\r\n  //   caption.classList.add('caption');\r\n  //   _i18n(caption, 'PeopleNearbyInfo2');\r\n\r\n  //   this.locatedPeers = new Map();\r\n\r\n  //   const m = () => {\r\n  //     const sortedUserList = new SortedUserList({\r\n  //       avatarSize: 42, \r\n  //       createChatListOptions: {\r\n  //         dialogSize: 48,\r\n  //         new: true\r\n  //       },\r\n  //       autonomous: false,\r\n  //       onUpdate: (element) => {\r\n  //         const peer = this.locatedPeers.get(element.id);\r\n  //         const elements: HTMLElement[] = [\r\n  //           this.parseDistance(peer.distance)\r\n  //         ];\r\n\r\n  //         if(!element.id.isUser()) {\r\n  //           elements.push(this.managers.appProfileManager.getChatMembersString(element.id.toChatId()));\r\n  //         }\r\n\r\n  //         element.dom.lastMessageSpan.textContent = '';\r\n  //         element.dom.lastMessageSpan.append(...join(elements, false));\r\n  //       },\r\n  //       getIndex: (element) => {\r\n  //         const peer = this.locatedPeers.get(element.id);\r\n  //         return 0x7FFFFFFF - peer.distance;\r\n  //       },\r\n  //       appUsersManager: this.managers.appUsersManager\r\n  //     });\r\n\r\n  //     appDialogsManager.setListClickListener(sortedUserList.list, undefined, undefined, false);\r\n      \r\n  //     return sortedUserList;\r\n  //   };\r\n    \r\n  //   const peopleSection = this.peopleSection = new SettingChatListSection({\r\n  //     name: 'PeopleNearbyHeader',\r\n  //     sortedList: m()\r\n  //   });\r\n\r\n  //   const chatsSection = this.chatsSection = new SettingChatListSection({\r\n  //     name: 'ChatsNearbyHeader',\r\n  //     sortedList: m()\r\n  //   });\r\n\r\n  //   const btnMakeVisible = peopleSection.makeButton({\r\n  //     text: 'MakeMyselfVisible',\r\n  //     icon: 'location'\r\n  //   });\r\n\r\n  //   const btnMakeInvisible = peopleSection.makeButton({\r\n  //     text: 'StopShowingMe',\r\n  //     icon: 'location'\r\n  //   });\r\n\r\n  //   const btnCreateGroup = chatsSection.makeButton({\r\n  //     text: 'NearbyCreateGroup',\r\n  //     icon: 'newgroup'\r\n  //   });\r\n\r\n  //   attachClickEvent(btnMakeVisible, () => {\r\n  //     confirmationPopup({\r\n  //       titleLangKey: 'MakeMyselfVisibleTitle',\r\n  //       descriptionLangKey: 'MakeMyselfVisibleInfo',\r\n  //       button: {\r\n  //         langKey: 'OK'\r\n  //       }\r\n  //     }).then(() => {\r\n  //       this.startWatching();\r\n  //     });\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   attachClickEvent(btnMakeInvisible, () => {\r\n  //     this.stopWatching();\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   attachClickEvent(btnCreateGroup, () => {\r\n  //     this.slider.createTab(AppNewGroupTab).open([], true);\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   btnMakeVisible.classList.add('primary');\r\n  //   btnMakeInvisible.classList.add('danger');\r\n  //   btnCreateGroup.classList.add('primary');\r\n\r\n  //   this.content.append(this.retryBtn);\r\n  //   this.scrollable.append(\r\n  //     stickerContainer,\r\n  //     caption,\r\n  //     peopleSection.container,\r\n  //     chatsSection.container,\r\n  //     this.errorCategory\r\n  //   );\r\n  // }\r\n\r\n  private parseDistance(distance: number) {\r\n    if(rootScope.settings.distanceUnit === 'miles') {\r\n      if(distance > 1609.34) {\r\n        return i18n('MilesAway', [Math.round(distance / 1609)]);\r\n      } else {\r\n        return i18n('FootsAway', [Math.round(distance * 3.281)]);\r\n      }\r\n    } else {\r\n      if(distance >= 1000) {\r\n        return i18n('KMetersAway2', [distance / 1000]);\r\n      } else {\r\n        return i18n('MetersAway2', [distance]);\r\n      }\r\n    }\r\n  }\r\n\r\n  public open() {\r\n    const result = super.open();\r\n    result.then(() => {\r\n      this.retryBtn.classList.remove('is-visible');\r\n      navigator.geolocation.getCurrentPosition((location) => {\r\n        this.latestLocationSaved = {\r\n          latitude: location.coords.latitude,\r\n          longitude: location.coords.longitude,\r\n          accuracy: location.coords.accuracy\r\n        };\r\n\r\n        console.log(this.latestLocationSaved);\r\n\r\n        this.managers.appUsersManager.getLocated(\r\n          location.coords.latitude,\r\n          location.coords.longitude,\r\n          location.coords.accuracy\r\n        ).then((response) => {\r\n          const update = (response as Updates.updates).updates[0] as Update.updatePeerLocated;\r\n          const peers = update.peers as PeerLocated.peerLocated[];\r\n          const orderedPeers = peers.sort((a, b) => a.distance - b.distance);\r\n          const groupsCounter = peers.filter((e) => e.peer._ == 'peerChannel').length;\r\n          const usersCounter = peers.filter((e) => e.peer._ != 'peerChannel').length;\r\n          orderedPeers?.forEach((peer) => {\r\n            const peerId = getPeerId(peer.peer);\r\n            const section = peerId.isUser() ? this.peopleSection : this.chatsSection;\r\n            this.locatedPeers.set(peerId, peer);\r\n            section.sortedList.add(peerId);\r\n          });\r\n\r\n          this.errorCategory.classList.toggle('hide', !!(usersCounter || groupsCounter));\r\n          this.errorCategory.innerHTML = \"No groups or channels found around you.\";\r\n        });\r\n      }, (error) => {\r\n        this.errorCategory.classList.remove('hide');\r\n        this.retryBtn.classList.add('is-visible');\r\n        this.retryBtn.addEventListener('click', this.open);\r\n        if(error instanceof GeolocationPositionError) {\r\n          this.errorCategory.innerHTML = \"Location permission denied. Click below to retry.\";\r\n        } else {\r\n          this.errorCategory.innerHTML = \"An error has occurred. Please retry later clicking the button below.\";\r\n        }\r\n      });\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  private startWatching() {\r\n    if(!this.latestLocationSaved || this.isLocationWatched) return;\r\n    this.isLocationWatched = true;\r\n\r\n    toast('Your position is now being shared. Do not close the page or it will be suspended.');\r\n\r\n    this.managers.appUsersManager.getLocated(\r\n      this.latestLocationSaved.latitude,\r\n      this.latestLocationSaved.longitude,\r\n      this.latestLocationSaved.accuracy,\r\n      true, // background parameter\r\n      0x7fffffff // self_expires parameter\r\n    );\r\n\r\n    navigator.geolocation.watchPosition((result) => {\r\n      const isLongitudeDifferent = result.coords.longitude !== this.latestLocationSaved.longitude;\r\n      const isLatitudeDifferent = result.coords.latitude !== this.latestLocationSaved.latitude;\r\n      const distanceCheck = this.calculateDistance(\r\n        result.coords.latitude, result.coords.longitude,\r\n        this.latestLocationSaved.latitude, this.latestLocationSaved.longitude\r\n      ) > 100;\r\n\r\n      if((isLatitudeDifferent || isLongitudeDifferent) && distanceCheck) {\r\n        this.managers.appUsersManager.getLocated(\r\n          result.coords.latitude,\r\n          result.coords.longitude,\r\n          result.coords.accuracy,\r\n          true, // background parameter\r\n          0x7fffffff // self_expires parameter\r\n        );\r\n        this.latestLocationSaved = {\r\n          latitude: result.coords.latitude,\r\n          longitude: result.coords.longitude,\r\n          accuracy: result.coords.accuracy\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private stopWatching() {\r\n    if(!this.isLocationWatched) return;\r\n    this.isLocationWatched = false;\r\n    toast('The sharing of your position has been stopped. You will no longer be visible to other users.');\r\n    this.managers.appUsersManager.getLocated(\r\n      0, // latitude parameter\r\n      0, // longitude parameter\r\n      0, // accuracy parameter\r\n      false, // background parameter\r\n      0 // self_expires parameter\r\n    );\r\n  }\r\n\r\n  private calculateDistance(lat1: number, long1: number, lat2: number, long2: number) {\r\n    const p = 0.017453292519943295; // Math.PI/180\r\n    return (\r\n      12742 * Math.asin(\r\n        Math.sqrt(\r\n          (0.5 - Math.cos((lat2 - lat1) * p)) +\r\n          (\r\n            Math.cos(lat1 * p) * Math.cos(lat2 * p)\r\n            * (1 - Math.cos((long2 - long1) * p)/2)\r\n          )\r\n        )\r\n      )\r\n    );\r\n  }\r\n}\r\n","export default function formatNumber(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return '0';\r\n\r\n  const k = 1000;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = ['', 'K', 'M', 'B', 'T'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + sizes[i];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { SearchGroup } from \"../appSearch\";\r\nimport \"../avatar\";\r\nimport Scrollable, { ScrollableX } from \"../scrollable\";\r\nimport InputSearch from \"../inputSearch\";\r\nimport SidebarSlider from \"../slider\";\r\nimport { TransitionSlider } from \"../transition\";\r\nimport AppNewGroupTab from \"./tabs/newGroup\";\r\nimport AppSearchSuper from \"../appSearchSuper.\";\r\nimport { DateData, fillTipDates } from \"../../helpers/date\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport AppSettingsTab from \"./tabs/settings\";\r\nimport AppNewChannelTab from \"./tabs/newChannel\";\r\nimport AppContactsTab from \"./tabs/contacts\";\r\nimport AppArchivedTab from \"./tabs/archivedTab\";\r\nimport AppAddMembersTab from \"./tabs/addMembers\";\r\nimport I18n, { FormatterArguments, i18n, i18n_, LangPackKey } from \"../../lib/langPack\";\r\nimport AppPeopleNearbyTab from \"./tabs/peopleNearby\";\r\nimport { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport App from \"../../config/app\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport sessionStorage from \"../../lib/sessionStorage\";\r\nimport { attachClickEvent, CLICK_EVENT_NAME } from \"../../helpers/dom/clickEvent\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport IS_GEOLOCATION_SUPPORTED from \"../../environment/geolocationSupport\";\r\nimport type SortedUserList from \"../sortedUserList\";\r\nimport Button, { ButtonOptions } from \"../button\";\r\nimport noop from \"../../helpers/noop\";\r\nimport ripple from \"../ripple\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport AvatarElement from \"../avatar\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { DIALOG_LIST_ELEMENT_TAG } from \"../../lib/appManagers/appDialogsManager\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\nexport const LEFT_COLUMN_ACTIVE_CLASSNAME = 'is-left-column-shown';\r\n\r\nexport class AppSidebarLeft extends SidebarSlider {\r\n  private toolsBtn: HTMLElement;\r\n  private backBtn: HTMLButtonElement;\r\n  //private searchInput = document.getElementById('global-search') as HTMLInputElement;\r\n  private inputSearch: InputSearch;\r\n  \r\n  public archivedCount: HTMLSpanElement;\r\n\r\n  private newBtnMenu: HTMLElement;\r\n\r\n  //private log = logger('SL');\r\n\r\n  private searchGroups: {[k in 'contacts' | 'globalContacts' | 'messages' | 'people' | 'recent']: SearchGroup} = {} as any;\r\n  private searchSuper: AppSearchSuper;\r\n\r\n  private updateBtn: HTMLElement;\r\n  private hasUpdate: boolean;\r\n\r\n  constructor() {\r\n    super({\r\n      sidebarEl: document.getElementById('column-left') as HTMLDivElement,\r\n      navigationType: 'left'\r\n    });\r\n  }\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    //this._selectTab(0); // make first tab as default\r\n\r\n    this.inputSearch = new InputSearch('Search');\r\n    const sidebarHeader = this.sidebarEl.querySelector('.item-main .sidebar-header');\r\n    sidebarHeader.append(this.inputSearch.container);\r\n\r\n    const onNewGroupClick = () => {\r\n      this.createTab(AppAddMembersTab).open({\r\n        type: 'chat',\r\n        skippable: false,\r\n        takeOut: (peerIds) => {\r\n          this.createTab(AppNewGroupTab).open(peerIds);\r\n        },\r\n        title: 'GroupAddMembers',\r\n        placeholder: 'SendMessageTo'\r\n      });\r\n    };\r\n\r\n    const onContactsClick = () => {\r\n      this.createTab(AppContactsTab).open();\r\n    };\r\n\r\n    //this.toolsBtn = this.sidebarEl.querySelector('.sidebar-tools-button') as HTMLButtonElement;\r\n    this.backBtn = this.sidebarEl.querySelector('.sidebar-back-button') as HTMLButtonElement;\r\n\r\n    const btnArchive: typeof menuButtons[0] = {\r\n      icon: 'archive',\r\n      text: 'ArchivedChats',\r\n      onClick: () => {\r\n        this.createTab(AppArchivedTab).open();\r\n      },\r\n      verify: async() => {\r\n        const folder = await this.managers.dialogsStorage.getFolderDialogs(1, false);\r\n        return !!folder.length || !(await this.managers.dialogsStorage.isDialogsLoaded(1));\r\n      }\r\n    };\r\n\r\n    const themeCheckboxField = new CheckboxField({\r\n      toggle: true,\r\n      checked: themeController.getTheme().name === 'night'\r\n    });\r\n    themeCheckboxField.input.addEventListener('change', async() => {\r\n      await this.managers.appStateManager.setByKey('settings.theme', themeCheckboxField.input.checked ? 'night' : 'day');\r\n      rootScope.dispatchEvent('theme_change');\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      themeCheckboxField.setValueSilently(themeController.getTheme().name === 'night');\r\n    });\r\n\r\n    const menuButtons: (ButtonMenuItemOptions & {verify?: () => boolean | Promise<boolean>})[] = [{\r\n      icon: 'saved',\r\n      text: 'SavedMessages',\r\n      onClick: () => {\r\n        setTimeout(() => { // menu doesn't close if no timeout (lol)\r\n          appImManager.setPeer({\r\n            peerId: appImManager.myId\r\n          });\r\n        }, 0);\r\n      }\r\n    }, btnArchive, {\r\n      icon: 'user',\r\n      text: 'Contacts',\r\n      onClick: onContactsClick\r\n    }, IS_GEOLOCATION_SUPPORTED ? {\r\n      icon: 'group',\r\n      text: 'PeopleNearby',\r\n      onClick: () => {\r\n        this.createTab(AppPeopleNearbyTab).open();\r\n      }\r\n    } : undefined, {\r\n      icon: 'settings',\r\n      text: 'Settings',\r\n      onClick: () => {\r\n        this.createTab(AppSettingsTab).open();\r\n      }\r\n    }, {\r\n      icon: 'darkmode',\r\n      text: 'DarkMode',\r\n      onClick: () => {\r\n        \r\n      },\r\n      checkboxField: themeCheckboxField\r\n    }, {\r\n      icon: 'animations',\r\n      text: 'Animations',\r\n      onClick: () => {\r\n        \r\n      },\r\n      checkboxField: new CheckboxField({\r\n        toggle: true, \r\n        checked: true,\r\n        stateKey: 'settings.animationsEnabled',\r\n      })\r\n    }, {\r\n      icon: 'help',\r\n      text: 'TelegramFeatures',\r\n      onClick: () => {\r\n        const url = I18n.format('TelegramFeaturesUrl', true);\r\n        appImManager.openUrl(url);\r\n      }\r\n    }, {\r\n      icon: 'bug',\r\n      text: 'ReportBug',\r\n      onClick: () => {\r\n        const a = document.createElement('a');\r\n        a.target = '_blank';\r\n        a.href = 'https://bugs.telegram.org/?tag_ids=40&sort=time';\r\n        document.body.append(a);\r\n        a.click();\r\n        setTimeout(() => {\r\n          a.remove();\r\n        }, 0);\r\n      }\r\n    }, {\r\n      icon: 'char z',\r\n      text: 'ChatList.Menu.SwitchTo.Z',\r\n      onClick: () => {\r\n        Promise.all([\r\n          sessionStorage.set({kz_version: 'Z'}),\r\n          sessionStorage.delete('tgme_sync')\r\n        ]).then(() => {\r\n          location.href = 'https://web.telegram.org/z/';\r\n        });\r\n      },\r\n      verify: () => App.isMainDomain\r\n    }, {\r\n      icon: 'char w',\r\n      text: 'ChatList.Menu.SwitchTo.Webogram',\r\n      onClick: () => {\r\n        sessionStorage.delete('tgme_sync').then(() => {\r\n          location.href = 'https://web.telegram.org/?legacy=1';\r\n        });\r\n      },\r\n      verify: () => App.isMainDomain\r\n    }];\r\n\r\n    const filteredButtons = menuButtons.filter(Boolean);\r\n\r\n    this.toolsBtn = ButtonMenuToggle({}, 'bottom-right', filteredButtons, async(e) => {\r\n      await Promise.all(filteredButtons.map(async(button) => {\r\n        if(button.verify) {\r\n          button.element.classList.toggle('hide', !(await button.verify()));\r\n        }\r\n      }));\r\n    });\r\n    this.toolsBtn.classList.remove('tgico-more');\r\n    this.toolsBtn.classList.add('sidebar-tools-button', 'is-visible');\r\n\r\n    this.backBtn.parentElement.insertBefore(this.toolsBtn, this.backBtn);\r\n\r\n    const btnMenu = this.toolsBtn.querySelector('.btn-menu') as HTMLElement;\r\n\r\n    const btnMenuFooter = document.createElement('a');\r\n    btnMenuFooter.href = 'https://github.com/morethanwords/tweb/blob/master/CHANGELOG.md';\r\n    btnMenuFooter.target = '_blank';\r\n    btnMenuFooter.rel = 'noopener noreferrer';\r\n    btnMenuFooter.classList.add('btn-menu-footer');\r\n    btnMenuFooter.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n      e.stopPropagation();\r\n      contextMenuController.closeBtnMenu();\r\n    });\r\n    const t = document.createElement('span');\r\n    t.classList.add('btn-menu-footer-text');\r\n    t.innerHTML = 'Telegram Web' + App.suffix + ' '/* ' alpha ' */ + App.versionFull;\r\n    btnMenuFooter.append(t); \r\n    btnMenu.classList.add('has-footer');\r\n    btnMenu.append(btnMenuFooter);\r\n\r\n    this.newBtnMenu = ButtonMenuToggle({}, 'top-left', [{\r\n      icon: 'newchannel',\r\n      text: 'NewChannel',\r\n      onClick: () => {\r\n        this.createTab(AppNewChannelTab).open();\r\n      }\r\n    }, {\r\n      icon: 'newgroup',\r\n      text: 'NewGroup',\r\n      onClick: onNewGroupClick\r\n    }, {\r\n      icon: 'newprivate',\r\n      text: 'NewPrivateChat',\r\n      onClick: onContactsClick\r\n    }]);\r\n    this.newBtnMenu.className = 'btn-circle rp btn-corner z-depth-1 btn-menu-toggle animated-button-icon';\r\n    this.newBtnMenu.insertAdjacentHTML('afterbegin', `\r\n    <span class=\"tgico tgico-newchat_filled\"></span>\r\n    <span class=\"tgico tgico-close\"></span>\r\n    `);\r\n    this.newBtnMenu.id = 'new-menu';\r\n    sidebarHeader.nextElementSibling.append(this.newBtnMenu);\r\n\r\n    this.updateBtn = document.createElement('div');\r\n    // this.updateBtn.classList.add('btn-update');\r\n    this.updateBtn.className = 'btn-circle rp btn-corner z-depth-1 btn-update is-hidden';\r\n    ripple(this.updateBtn);\r\n    this.updateBtn.append(i18n('Update'));\r\n    // const weave = new TopbarWeave();\r\n    // const weaveContainer = weave.render('btn-update-weave');\r\n    // this.updateBtn.prepend(weaveContainer);\r\n\r\n    attachClickEvent(this.updateBtn, () => {\r\n      if(this.updateBtn.classList.contains('is-hidden')) {\r\n        return;\r\n      }\r\n      \r\n      location.reload();\r\n    });\r\n    \r\n    sidebarHeader.nextElementSibling.append(this.updateBtn);\r\n\r\n    // setTimeout(() => {\r\n    //   weave.componentDidMount();\r\n    //   weave.setCurrentState(GROUP_CALL_STATE.MUTED, true);\r\n    //   weave.setAmplitude(0);\r\n    //   weave.handleBlur();\r\n    // }, 1e3);\r\n\r\n    this.inputSearch.input.addEventListener('focus', () => this.initSearch(), {once: true});\r\n\r\n    //parseMenuButtonsTo(this.newButtons, this.newBtnMenu.firstElementChild.children);\r\n\r\n    this.archivedCount = document.createElement('span');\r\n    this.archivedCount.className = 'archived-count badge badge-24 badge-gray';\r\n\r\n    btnArchive.element.append(this.archivedCount);\r\n\r\n    rootScope.addEventListener('folder_unread', (folder) => {\r\n      if(folder.id === 1) {\r\n        // const count = folder.unreadMessagesCount;\r\n        const count = folder.unreadPeerIds.size;\r\n        this.archivedCount.innerText = '' + formatNumber(count, 1);\r\n        this.archivedCount.classList.toggle('hide', !count);\r\n      }\r\n    });\r\n\r\n    this.managers.appUsersManager.getTopPeers('correspondents');\r\n\r\n    // Focus search input by pressing Escape\r\n    const navigationItem: NavigationItem = {\r\n      type: 'global-search-focus',\r\n      onPop: () => {\r\n        setTimeout(() => {\r\n          this.inputSearch.input.focus();\r\n        }, 0);\r\n\r\n        return false;\r\n      },\r\n      noHistory: true\r\n    };\r\n    appNavigationController.pushItem(navigationItem);\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      const CHECK_UPDATE_INTERVAL = 1800e3;\r\n      const checkUpdateInterval = setInterval(() => {\r\n        fetch('version', {cache: 'no-cache'})\r\n        .then((res) => (res.status === 200 && res.ok && res.text()) || Promise.reject())\r\n        .then((text) => {\r\n          if(text !== App.versionFull) {\r\n            this.hasUpdate = true;\r\n            clearInterval(checkUpdateInterval);\r\n\r\n            if(!this.newBtnMenu.classList.contains('is-hidden')) {\r\n              this.updateBtn.classList.remove('is-hidden');\r\n            }\r\n          }\r\n        })\r\n        .catch(noop);\r\n      }, CHECK_UPDATE_INTERVAL);\r\n    });\r\n  }\r\n\r\n  private initSearch() {\r\n    const searchContainer = this.sidebarEl.querySelector('#search-container') as HTMLDivElement;\r\n\r\n    const scrollable = new Scrollable(searchContainer);\r\n\r\n    const close = () => {\r\n      //setTimeout(() => {\r\n        this.backBtn.click();\r\n      //}, 0);\r\n    };\r\n\r\n    this.searchGroups = {\r\n      contacts: new SearchGroup('SearchAllChatsShort', 'contacts', undefined, undefined, undefined, undefined, close),\r\n      globalContacts: new SearchGroup('GlobalSearch', 'contacts', undefined, undefined, undefined, undefined, close),\r\n      messages: new SearchGroup('SearchMessages', 'messages'),\r\n      people: new SearchGroup(false, 'contacts', true, 'search-group-people', true, false, close),\r\n      recent: new SearchGroup('Recent', 'contacts', true, 'search-group-recent', true, true, close)\r\n    };\r\n\r\n    const searchSuper = this.searchSuper = new AppSearchSuper({\r\n      mediaTabs: [{\r\n        inputFilter: 'inputMessagesFilterEmpty',\r\n        name: 'FilterChats',\r\n        type: 'chats'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterPhotoVideo',\r\n        name: 'SharedMediaTab2',\r\n        type: 'media'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterUrl',\r\n        name: 'SharedLinksTab2',\r\n        type: 'links'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterDocument',\r\n        name: 'SharedFilesTab2',\r\n        type: 'files'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterMusic',\r\n        name: 'SharedMusicTab2',\r\n        type: 'music'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterRoundVoice',\r\n        name: 'SharedVoiceTab2',\r\n        type: 'voice'\r\n      }], \r\n      scrollable, \r\n      searchGroups: this.searchGroups, \r\n      asChatList: true,\r\n      hideEmptyTabs: false,\r\n      showSender: true,\r\n      managers: this.managers\r\n    });\r\n\r\n    searchContainer.prepend(searchSuper.nav.parentElement.parentElement);\r\n    scrollable.container.append(searchSuper.container);\r\n\r\n    const resetSearch = () => {\r\n      searchSuper.setQuery({\r\n        peerId: ''.toPeerId(), \r\n        folderId: 0\r\n      });\r\n      searchSuper.selectTab(0);\r\n      searchSuper.load(true); \r\n    };\r\n\r\n    resetSearch();\r\n\r\n    let pickedElements: HTMLElement[] = [];\r\n    let selectedPeerId: PeerId = ''.toPeerId();\r\n    let selectedMinDate = 0;\r\n    let selectedMaxDate = 0;\r\n    const updatePicked = () => {\r\n      //(this.inputSearch.input as HTMLInputElement).placeholder = pickedElements.length ? 'Search' : 'Telegram Search';\r\n      this.inputSearch.container.classList.toggle('is-picked-twice', pickedElements.length === 2);\r\n      this.inputSearch.container.classList.toggle('is-picked', !!pickedElements.length);\r\n\r\n      if(pickedElements.length) {\r\n        this.inputSearch.input.style.setProperty('--paddingLeft', (pickedElements[pickedElements.length - 1].getBoundingClientRect().right - this.inputSearch.input.getBoundingClientRect().left) + 'px');\r\n      } else {\r\n        this.inputSearch.input.style.removeProperty('--paddingLeft');\r\n      }\r\n    };\r\n\r\n    const helper = document.createElement('div');\r\n    helper.classList.add('search-helper');\r\n    helper.addEventListener('click', (e) => {\r\n      const target = findUpClassName(e.target, 'selector-user');\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const key = target.dataset.key;\r\n      if(key.indexOf('date_') === 0) {\r\n        const [_, minDate, maxDate] = key.split('_');\r\n        selectedMinDate = +minDate;\r\n        selectedMaxDate = +maxDate;\r\n      } else {\r\n        selectedPeerId = key.toPeerId();\r\n      }\r\n\r\n      target.addEventListener('click', () => {\r\n        unselectEntity(target);\r\n      });\r\n\r\n      this.inputSearch.container.append(target);\r\n      this.inputSearch.onChange(this.inputSearch.value = '');\r\n      pickedElements.push(target);\r\n      updatePicked();\r\n    });\r\n\r\n    searchSuper.nav.parentElement.append(helper);\r\n\r\n    const renderEntity = (key: PeerId | string, title?: string | HTMLElement) => {\r\n      const div = document.createElement('div');\r\n      div.classList.add('selector-user'/* , 'scale-in' */);\r\n\r\n      const avatarEl = new AvatarElement();\r\n      avatarEl.classList.add('selector-user-avatar', 'tgico', 'avatar-30');\r\n      avatarEl.isDialog = true;\r\n\r\n      div.dataset.key = '' + key;\r\n      if(key.isPeerId()) {\r\n        if(title === undefined) {\r\n          title = new PeerTitle({peerId: key.toPeerId()}).element;\r\n        }\r\n\r\n        avatarEl.updateWithOptions({peerId: key as PeerId});\r\n      } else {\r\n        avatarEl.classList.add('tgico-calendarfilter');\r\n      }\r\n\r\n      if(title) {\r\n        if(typeof(title) === 'string') {\r\n          div.innerHTML = title;\r\n        } else {\r\n          replaceContent(div, title);\r\n          div.append(title);\r\n        }\r\n      }\r\n\r\n      div.insertAdjacentElement('afterbegin', avatarEl);\r\n\r\n      return div;\r\n    };\r\n\r\n    const unselectEntity = (target: HTMLElement) => {\r\n      const key = target.dataset.key;\r\n      if(key.indexOf('date_') === 0) {\r\n        selectedMinDate = selectedMaxDate = 0;\r\n      } else {\r\n        selectedPeerId = ''.toPeerId();\r\n      }\r\n      \r\n      target.remove();\r\n      indexOfAndSplice(pickedElements, target);\r\n\r\n      setTimeout(() => {\r\n        updatePicked();\r\n        this.inputSearch.onChange(this.inputSearch.value);\r\n      }, 0);\r\n    };\r\n\r\n    this.inputSearch.onClear = () => {\r\n      pickedElements.forEach((el) => {\r\n        unselectEntity(el);\r\n      });\r\n    };\r\n\r\n    this.inputSearch.onChange = (value) => {\r\n      searchSuper.cleanupHTML();\r\n      searchSuper.setQuery({\r\n        peerId: selectedPeerId, \r\n        folderId: selectedPeerId ? undefined : 0,\r\n        query: value,\r\n        minDate: selectedMinDate,\r\n        maxDate: selectedMaxDate\r\n      });\r\n      searchSuper.load(true);\r\n\r\n      helper.innerHTML = '';\r\n      searchSuper.nav.classList.remove('hide');\r\n      if(!value) {\r\n      }\r\n      \r\n      if(!selectedPeerId && value.trim()) {\r\n        const middleware = searchSuper.middleware.get();\r\n        Promise.all([\r\n          // appMessagesManager.getConversationsAll(value).then((dialogs) => dialogs.map((d) => d.peerId)),\r\n          this.managers.appMessagesManager.getConversations(value).then(({dialogs}) => dialogs.map((d) => d.peerId)),\r\n          this.managers.appUsersManager.getContactsPeerIds(value, true)\r\n        ]).then((results) => {\r\n          if(!middleware()) return;\r\n          const peerIds = new Set(results[0].concat(results[1]));\r\n  \r\n          peerIds.forEach((peerId) => {\r\n            helper.append(renderEntity(peerId));\r\n          });\r\n  \r\n          searchSuper.nav.classList.toggle('hide', !!helper.innerHTML);\r\n          //console.log('got peerIds by value:', value, [...peerIds]);\r\n        });\r\n      }\r\n      \r\n      if(!selectedMinDate && value.trim()) {\r\n        const dates: DateData[] = [];\r\n        fillTipDates(value, dates);\r\n        dates.forEach((dateData) => {\r\n          helper.append(renderEntity('date_' + dateData.minDate + '_' + dateData.maxDate, dateData.title));\r\n        });\r\n\r\n        searchSuper.nav.classList.toggle('hide', !!helper.innerHTML);\r\n      }\r\n    };\r\n\r\n    searchSuper.tabs.inputMessagesFilterEmpty.addEventListener('mousedown', (e) => {\r\n      const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG) as HTMLElement;\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const searchGroup = findUpClassName(target, 'search-group');\r\n      if(!searchGroup || searchGroup.classList.contains('search-group-recent') || searchGroup.classList.contains('search-group-people')) {\r\n        return;\r\n      }\r\n\r\n      const peerId = target.getAttribute('data-peer-id').toPeerId();\r\n      this.managers.appUsersManager.pushRecentSearch(peerId);\r\n    }, {capture: true});\r\n\r\n    let peopleContainer = document.createElement('div');\r\n    peopleContainer.classList.add('search-group-scrollable');\r\n    peopleContainer.append(this.searchGroups.people.list);\r\n    this.searchGroups.people.container.append(peopleContainer);\r\n    let peopleScrollable = new ScrollableX(peopleContainer);\r\n\r\n    let first = true;\r\n    let hideNewBtnMenuTimeout: number;\r\n    //const transition = Transition.bind(null, searchContainer.parentElement, 150);\r\n    const transition = TransitionSlider(searchContainer.parentElement, 'zoom-fade', 150, (id) => {\r\n      if(hideNewBtnMenuTimeout) clearTimeout(hideNewBtnMenuTimeout);\r\n\r\n      if(id === 0 && !first) {\r\n        searchSuper.selectTab(0, false);\r\n        this.inputSearch.onClearClick();\r\n        hideNewBtnMenuTimeout = window.setTimeout(() => {\r\n          hideNewBtnMenuTimeout = 0;\r\n          this.newBtnMenu.classList.remove('is-hidden');\r\n          this.hasUpdate && this.updateBtn.classList.remove('is-hidden');\r\n        }, 150);\r\n      }\r\n\r\n      first = false;\r\n    });\r\n\r\n    transition(0);\r\n\r\n    const activeClassName = 'is-visible';\r\n    const onFocus = () => {\r\n      this.toolsBtn.classList.remove(activeClassName);\r\n      this.backBtn.classList.add(activeClassName);\r\n      this.newBtnMenu.classList.add('is-hidden');\r\n      this.updateBtn.classList.add('is-hidden');\r\n      this.toolsBtn.parentElement.firstElementChild.classList.toggle('state-back', true);\r\n\r\n      const navigationType: NavigationItem['type'] = 'global-search';\r\n      if(!IS_MOBILE_SAFARI && !appNavigationController.findItemByType(navigationType)) {\r\n        appNavigationController.pushItem({\r\n          onPop: () => {\r\n            close();\r\n          },\r\n          type: navigationType\r\n        });\r\n      }\r\n\r\n      transition(1);\r\n    };\r\n\r\n    this.inputSearch.input.addEventListener('focus', onFocus);\r\n    onFocus();\r\n\r\n    this.backBtn.addEventListener('click', (e) => {\r\n      this.toolsBtn.classList.add(activeClassName);\r\n      this.backBtn.classList.remove(activeClassName);\r\n      this.toolsBtn.parentElement.firstElementChild.classList.toggle('state-back', false);\r\n\r\n      appNavigationController.removeByType('global-search');\r\n\r\n      transition(0);\r\n    });\r\n\r\n    const clearRecentSearchBtn = ButtonIcon('close');\r\n    this.searchGroups.recent.nameEl.append(clearRecentSearchBtn);\r\n    clearRecentSearchBtn.addEventListener('click', () => {\r\n      confirmationPopup({\r\n        descriptionLangKey: 'Search.Confirm.ClearHistory',\r\n        button: {\r\n          langKey: 'ClearButton',\r\n          isDanger: true\r\n        }\r\n      }).then(() => {\r\n        return this.managers.appUsersManager.clearRecentSearch().then(() => {\r\n          this.searchGroups.recent.clear();\r\n        });\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport type SettingSectionOptions = {\r\n  name?: LangPackKey, \r\n  nameArgs?: FormatterArguments,\r\n  caption?: LangPackKey | true,\r\n  noDelimiter?: boolean,\r\n  fakeGradientDelimiter?: boolean,\r\n  noShadow?: boolean,\r\n  // fullWidth?: boolean,\r\n  // noPaddingTop?: boolean\r\n};\r\n\r\nconst className = 'sidebar-left-section';\r\nexport class SettingSection {\r\n  public container: HTMLElement;\r\n  public innerContainer: HTMLElement;\r\n  public content: HTMLElement;\r\n  public title: HTMLElement;\r\n  public caption: HTMLElement;\r\n\r\n  private fullWidth: boolean;\r\n\r\n  constructor(options: SettingSectionOptions = {}) {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className + '-container');\r\n\r\n    const innerContainer = this.innerContainer = document.createElement('div');\r\n    innerContainer.classList.add(className);\r\n\r\n    if(options.noShadow) {\r\n      innerContainer.classList.add('no-shadow');\r\n    }\r\n\r\n    if(options.fakeGradientDelimiter) {\r\n      innerContainer.append(generateDelimiter());\r\n      innerContainer.classList.add('with-fake-delimiter');\r\n    } else if(!options.noDelimiter) {\r\n      const hr = document.createElement('hr');\r\n      innerContainer.append(hr);\r\n    } else {\r\n      innerContainer.classList.add('no-delimiter');\r\n    }\r\n\r\n    // if(options.fullWidth) {\r\n    //   this.fullWidth = true;\r\n    // }\r\n\r\n    // if(options.noPaddingTop) {\r\n    //   innerContainer.classList.add('no-padding-top');\r\n    // }\r\n\r\n    const content = this.content = this.generateContentElement();\r\n\r\n    if(options.name) {\r\n      const title = this.title = document.createElement('div');\r\n      title.classList.add('sidebar-left-h2', className + '-name');\r\n      i18n_({element: title, key: options.name, args: options.nameArgs});\r\n      content.append(title);\r\n    }\r\n\r\n    container.append(innerContainer);\r\n\r\n    if(options.caption) {\r\n      const caption = this.caption = this.generateContentElement();\r\n      caption.classList.add(className + '-caption');\r\n      container.append(caption);\r\n\r\n      if(options.caption !== true) {\r\n        i18n_({element: caption, key: options.caption});\r\n      }\r\n    }\r\n  }\r\n\r\n  public generateContentElement() {\r\n    const content = document.createElement('div');\r\n    content.classList.add(className + '-content');\r\n\r\n    // if(this.fullWidth) {\r\n    //   content.classList.add('full-width');\r\n    // }\r\n\r\n    this.innerContainer.append(content);\r\n    return content;\r\n  }\r\n}\r\n\r\nexport const generateSection = (appendTo: Scrollable, name?: LangPackKey, caption?: LangPackKey) => {\r\n  const section = new SettingSection({name, caption});\r\n  appendTo.append(section.container);\r\n  return section.content;\r\n};\r\n\r\nexport const generateDelimiter = () => {\r\n  const delimiter = document.createElement('div');\r\n  delimiter.classList.add('gradient-delimiter');\r\n  return delimiter;\r\n};\r\n\r\nexport class SettingChatListSection extends SettingSection {\r\n  public sortedList: SortedUserList;\r\n\r\n  constructor(options: SettingSectionOptions & {sortedList: SortedUserList}) {\r\n    super(options);\r\n\r\n    this.sortedList = options.sortedList;\r\n\r\n    this.content.append(this.sortedList.list);\r\n  }\r\n\r\n  public makeButton(options: ButtonOptions) {\r\n    const button = Button('folder-category-button btn btn-primary btn-transparent', options);\r\n    if(this.title) this.content.insertBefore(button, this.title.nextSibling);\r\n    else this.content.prepend(button);\r\n    return button;\r\n  }\r\n}\r\n\r\nconst appSidebarLeft = new AppSidebarLeft();\r\nMOUNT_CLASS_TO.appSidebarLeft = appSidebarLeft;\r\nexport default appSidebarLeft;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\n//import { generatePathData } from \"../../helpers/dom\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type Chat from \"./chat\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport insertInDescendSortedArray from \"../../helpers/array/insertInDescendSortedArray\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport AvatarElement from \"../avatar\";\r\nimport { Message } from \"../../layer\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { SERVICE_AS_REGULAR, STICKY_OFFSET } from \"./bubbles\";\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport partition from \"../../helpers/array/partition\";\r\n\r\ntype GroupItem = {\r\n  bubble: HTMLElement, \r\n  fromId: PeerId, \r\n  mid: number, \r\n  groupMid?: number, \r\n  timestamp: number, \r\n  dateTimestamp: number, \r\n  mounted: boolean, \r\n  single: boolean, \r\n  group?: BubbleGroup,\r\n  message: Message.message | Message.messageService // use it only to set avatar\r\n};\r\n\r\nclass BubbleGroup {\r\n  container: HTMLElement;\r\n  chat: Chat;\r\n  groups: BubbleGroups;\r\n  items: GroupItem[]; // descend sorted\r\n  avatarContainer: HTMLElement;\r\n  avatarLoadPromise: ReturnType<AvatarElement['updateWithOptions']>;\r\n  avatar: AvatarElement;\r\n  mounted: boolean;\r\n  dateTimestamp: number;\r\n  offset: number;\r\n\r\n  constructor(chat: Chat, groups: BubbleGroups, dateTimestamp: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('bubbles-group');\r\n    this.chat = chat;\r\n    this.groups = groups;\r\n    this.items = [];\r\n    this.dateTimestamp = dateTimestamp;\r\n    this.offset = 0;\r\n  }\r\n\r\n  createAvatar(message: Message.message | Message.messageService) {\r\n    if(this.avatarLoadPromise) {\r\n      return this.avatarLoadPromise;\r\n    } else if(message._ === 'messageService') {\r\n      return;\r\n    }\r\n\r\n    this.avatarContainer = document.createElement('div');\r\n    this.avatarContainer.classList.add('bubbles-group-avatar-container');\r\n    ++this.offset;\r\n\r\n    const fwdFrom = message.fwd_from;\r\n    const fwdFromId = message.fwdFromId;\r\n    const isForwardFromChannel = message.from_id && message.from_id._ === 'peerChannel' && message.fromId === fwdFromId;\r\n    const currentPeerId = this.chat.peerId;\r\n    this.avatar = new AvatarElement();\r\n    this.avatar.classList.add('bubbles-group-avatar', 'user-avatar', 'avatar-40'/* , 'can-zoom-fade' */);\r\n    this.avatarLoadPromise = this.avatar.updateWithOptions({\r\n      lazyLoadQueue: this.chat.bubbles.lazyLoadQueue,\r\n      peerId: ((fwdFrom && (currentPeerId === rootScope.myId || currentPeerId === REPLIES_PEER_ID)) || isForwardFromChannel ? fwdFromId : message.fromId) || NULL_PEER_ID,\r\n      peerTitle: !fwdFromId && fwdFrom && fwdFrom.from_name ? /* '🔥 FF 🔥' */fwdFrom.from_name : undefined,\r\n    });\r\n\r\n    this.avatarContainer.append(this.avatar);\r\n    this.container.append(this.avatarContainer);\r\n\r\n    return this.avatarLoadPromise;\r\n  }\r\n\r\n  get firstTimestamp() {\r\n    return this.firstItem.timestamp;\r\n  }\r\n\r\n  get firstMid() {\r\n    return this.firstItem.mid;\r\n  }\r\n\r\n  get firstItem() {\r\n    return this.items[this.items.length - 1];\r\n  }\r\n\r\n  get lastTimestamp() {\r\n    return this.lastItem.timestamp;\r\n  }\r\n\r\n  get lastMid() {\r\n    return this.lastItem.mid;\r\n  }\r\n\r\n  get lastItem() {\r\n    return this.items[0];\r\n  }\r\n\r\n  updateClassNames() {\r\n    const items = this.items;\r\n    const length = items.length;\r\n    if(!length) {\r\n      return;\r\n    }\r\n    \r\n    // const elements = Array.from(this.container.children);\r\n    // if(this.offset) elements.splice(0, this.offset);\r\n\r\n    // const length = elements.length;\r\n    // if(!length) {\r\n    //   return;\r\n    // }\r\n\r\n    const first = items[length - 1].bubble;\r\n\r\n    if(items.length === 1) {\r\n      first.classList.add('is-group-first', 'is-group-last');\r\n      //this.setClipIfNeeded(first);\r\n      return;\r\n    } else {\r\n      first.classList.remove('is-group-last');\r\n      first.classList.add('is-group-first');\r\n      //this.setClipIfNeeded(first, true);\r\n    }\r\n    \r\n    for(let i = 1, _length = length - 1; i < _length; ++i) {\r\n      const bubble = items[i].bubble;\r\n      bubble.classList.remove('is-group-last', 'is-group-first');\r\n      //this.setClipIfNeeded(bubble, true);\r\n    }\r\n    \r\n    const last = items[0].bubble;\r\n    last.classList.remove('is-group-first');\r\n    last.classList.add('is-group-last');\r\n    //this.setClipIfNeeded(last);\r\n  }\r\n\r\n  insertItem(item: GroupItem) {\r\n    const {items} = this;\r\n    insertInDescendSortedArray(items, item, this.groups.sortGroupItemsKey);\r\n\r\n    item.group = this;\r\n    if(items.length === 1) {\r\n      this.groups.insertGroup(this);\r\n    }\r\n  }\r\n\r\n  removeItem(item: GroupItem) {\r\n    indexOfAndSplice(this.items, item);\r\n\r\n    if(!this.items.length) {\r\n      indexOfAndSplice(this.groups.groups, this);\r\n    }\r\n\r\n    item.group = undefined;\r\n  }\r\n\r\n  mount(updateClassNames?: boolean) {\r\n    if(!this.groups.groups.includes(this) || !this.items.length) { // group can be already removed\r\n      debugger;\r\n\r\n      if(this.mounted) {\r\n        this.onItemUnmount();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const {offset, items} = this;\r\n    const {length} = items;\r\n    forEachReverse(items, (item, idx) => {\r\n      this.mountItem(item, length - 1 - idx, offset);\r\n    });\r\n    \r\n    if(updateClassNames) {\r\n      this.updateClassNames();\r\n    }\r\n\r\n    this.onItemMount();\r\n  }\r\n\r\n  mountItem(item: GroupItem, idx = this.items.indexOf(item), offset = this.offset) {\r\n    if(item.mounted) {\r\n      return;\r\n    }\r\n\r\n    positionElementByIndex(item.bubble, this.container, offset + idx);\r\n    item.mounted = true;\r\n  }\r\n\r\n  unmountItem(item: GroupItem) {\r\n    if(!item.mounted) {\r\n      return;\r\n    }\r\n\r\n    item.bubble.remove();\r\n    item.mounted = false;\r\n    this.onItemUnmount();\r\n  }\r\n\r\n  onItemMount() {\r\n    if(this.mounted) {\r\n      return;\r\n    }\r\n\r\n    const dateContainer = this.chat.bubbles.getDateContainerByTimestamp(this.dateTimestamp / 1000);\r\n    // const idx = this.groups.indexOf(group);\r\n    const dateGroups = this.groups.groups.filter((_group) => _group.dateTimestamp === this.dateTimestamp);\r\n    const dateGroupsLength = dateGroups.length;\r\n    const idx = dateGroups.indexOf(this);\r\n    const unmountedLength = dateGroups.slice(idx + 1).reduce((acc, v) => acc + (v.mounted ? 0 : 1), 0);\r\n    positionElementByIndex(this.container, dateContainer.container, STICKY_OFFSET + dateGroupsLength - 1 - idx - unmountedLength);\r\n    this.mounted = true;\r\n  }\r\n\r\n  onItemUnmount() {\r\n    if(!this.mounted) {\r\n      return;\r\n    }\r\n\r\n    if(!this.items.length) {\r\n      this.container.remove();\r\n      this.chat.bubbles.deleteEmptyDateGroups();\r\n      this.mounted = false;\r\n    } else {\r\n      this.updateClassNames();\r\n    }\r\n  }\r\n}\r\n\r\n// class BubbleGroupItem implements GroupItem {\r\n//   bubble: HTMLElement;\r\n//   fromId: PeerId;\r\n//   mid: number;\r\n//   timestamp: number;\r\n//   dateTimestamp: number;\r\n//   mounted: boolean;\r\n//   single: boolean;\r\n//   group: BubbleGroup;\r\n\r\n//   constructor(details: GroupItem) {\r\n//     Object.assign(this, details);\r\n//   }\r\n// }\r\n\r\nexport default class BubbleGroups {\r\n  public itemsArr: Array<GroupItem> = []; // descend sorted\r\n  private itemsMap: Map<HTMLElement, GroupItem> = new Map();\r\n  public groups: Array<BubbleGroup> = []; // descend sorted\r\n  private newGroupDiff = 121; // * 121 in scheduled messages\r\n  private sortItemsKey: Extract<keyof GroupItem, 'timestamp' | 'mid'>;\r\n  private sortGroupsKey: Extract<keyof BubbleGroup, 'lastMid' | 'lastTimestamp'>;\r\n  public sortGroupItemsKey: Extract<keyof GroupItem, 'groupMid' | 'timestamp'>;\r\n\r\n  constructor(private chat: Chat) {\r\n    this.sortItemsKey = chat.type === 'scheduled' ? 'timestamp' : 'mid';\r\n    this.sortGroupsKey = chat.type === 'scheduled' ? 'lastTimestamp' : 'lastMid';\r\n    this.sortGroupItemsKey = /* chat.type === 'scheduled' ? 'timestamp' :  */'groupMid';\r\n  }\r\n\r\n  removeItem(item: GroupItem) {\r\n    item.group.removeItem(item);\r\n    this.removeItemFromCache(item);\r\n  }\r\n\r\n  removeAndUnmountBubble(bubble: HTMLElement) {\r\n    const item = this.getItemByBubble(bubble);\r\n    if(!item) {\r\n      return;\r\n    }\r\n\r\n    const items = this.itemsArr;\r\n    const index = items.indexOf(item);\r\n    const siblings = this.getSiblingsAtIndex(index, items);\r\n    \r\n    const group = item.group;\r\n    this.removeItem(item);\r\n    group.unmountItem(item);\r\n\r\n    const modifiedGroups: Set<BubbleGroup> = new Set();\r\n    modifiedGroups.add(group);\r\n\r\n    const [previousSibling, nextSibling] = siblings;\r\n    if(\r\n      previousSibling \r\n      && nextSibling \r\n      && this.canItemsBeGrouped(previousSibling, nextSibling) \r\n      && previousSibling.group !== nextSibling.group\r\n    ) {\r\n      const group = nextSibling.group;\r\n      this.f(nextSibling.group.items);\r\n      group.onItemUnmount();\r\n      modifiedGroups.add(previousSibling.group);\r\n      this.groupUngrouped();\r\n    }\r\n\r\n    this.mountUnmountGroups(Array.from(modifiedGroups));\r\n  }\r\n\r\n  mountUnmountGroups(groups: BubbleGroup[]) {\r\n    // groups.sort((a, b) => (b.lastItem?.mid ?? 0) - (a.lastItem?.mid ?? 0));\r\n\r\n    const [toMount, toUnmount] = partition(groups, (group) => !!group.items.length);\r\n    toUnmount.forEach((group) => {\r\n      group.onItemUnmount();\r\n    })\r\n\r\n    toMount.forEach((group) => {\r\n      group.mount(true);\r\n    });\r\n\r\n    // toMount.forEach((group) => {\r\n    //   group.updateClassNames();\r\n    // });\r\n  }\r\n\r\n  f(items: GroupItem[], index: number = 0, length = items.length) {\r\n    for(; index < length; ++index) {\r\n      const item = items[index];\r\n      item.mounted = false;\r\n      item.group.removeItem(item);\r\n      --length;\r\n      --index;\r\n    }\r\n  }\r\n\r\n  getItemByBubble(bubble: HTMLElement) {\r\n    return this.itemsMap.get(bubble);\r\n  }\r\n\r\n  getLastGroup() {\r\n    return this.groups[0];\r\n  }\r\n\r\n  changeBubbleMid(bubble: HTMLElement, mid: number) {\r\n    const item = this.getItemByBubble(bubble);\r\n    if(!item) {\r\n      return;\r\n    }\r\n\r\n    item.mid = mid;\r\n    \r\n    // indexOfAndSplice(item.group.items, item);\r\n    // // const canChangeGroupMid = !item.group.items.length || item.group.items.every((item) => item.groupMid === item.mid);\r\n    // // if(canChangeGroupMid) item.groupMid = mid;\r\n    // item.group.insertItem(item);\r\n    \r\n    indexOfAndSplice(this.itemsArr, item);\r\n    this.insertItemToArray(item, this.itemsArr);\r\n  }\r\n\r\n  changeItemBubble(item: GroupItem, bubble: HTMLElement) {\r\n    this.itemsMap.delete(item.bubble);\r\n    item.bubble = bubble;\r\n    this.itemsMap.set(bubble, item);\r\n  }\r\n  \r\n  changeBubbleByBubble(from: HTMLElement, to: HTMLElement) {\r\n    const item = this.getItemByBubble(from);\r\n    if(!item) {\r\n      return;\r\n    }\r\n    \r\n    this.changeItemBubble(item, to);\r\n  }\r\n\r\n  canItemsBeGrouped(item1: GroupItem, item2: GroupItem) { \r\n    return item2.fromId === item1.fromId \r\n      && Math.abs(item2.timestamp - item1.timestamp) <= this.newGroupDiff \r\n      && item1.dateTimestamp === item2.dateTimestamp \r\n      && !item1.single \r\n      && !item2.single;\r\n  }\r\n\r\n  getSiblingsAtIndex(itemIndex: number, items: GroupItem[]) {\r\n    return [items[itemIndex - 1], items[itemIndex + 1]] as const;\r\n  }\r\n\r\n  // findGroupSiblingInSiblings(item: GroupItem, siblings: ReturnType<BubbleGroups['getSiblingsAtIndex']>) {\r\n  //   return siblings.find((sibling) => sibling && this.canItemsBeGrouped(item, sibling));\r\n  // }\r\n\r\n  findGroupSiblingByItem(item: GroupItem, items: GroupItem[]) {\r\n    items = items.slice();\r\n    const idx = this.insertItemToArray(item, items);\r\n    // return this.findGroupSiblingInSiblings(item, this.getSiblingsAtIndex(idx, items));\r\n    return this.findGroupSiblingInItems(item, items, idx);\r\n  }\r\n\r\n  findGroupSiblingInItems(item: GroupItem, items: GroupItem[], index = items.indexOf(item), length = items.length) {\r\n    const previousItem = items[index - 1];\r\n    let siblingGroupedItem: GroupItem;\r\n    if(previousItem?.group && this.canItemsBeGrouped(item, previousItem)) {\r\n      siblingGroupedItem = previousItem;\r\n    } else {\r\n      for(let k = index + 1; k < length; ++k) {\r\n        const nextItem = items[k];\r\n        if(this.canItemsBeGrouped(item, nextItem)) {\r\n          if(nextItem.group) {\r\n            siblingGroupedItem = nextItem;\r\n          }\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return siblingGroupedItem;\r\n  }\r\n\r\n  addItemToGroup(item: GroupItem, group: BubbleGroup) {\r\n    group.insertItem(item);\r\n    this.addItemToCache(item);\r\n  }\r\n\r\n  insertItemToArray(item: GroupItem, array: GroupItem[]) {\r\n    return insertInDescendSortedArray(array, item, this.sortItemsKey);\r\n  }\r\n\r\n  insertGroup(group: BubbleGroup) {\r\n    return insertInDescendSortedArray(this.groups, group, this.sortGroupsKey);\r\n  }\r\n\r\n  addItemToCache(item: GroupItem) {\r\n    this.insertItemToArray(item, this.itemsArr);\r\n    this.itemsMap.set(item.bubble, item);\r\n  }\r\n\r\n  removeItemFromCache(item: GroupItem) {\r\n    indexOfAndSplice(this.itemsArr, item);\r\n    this.itemsMap.delete(item.bubble);\r\n  }\r\n\r\n  getMessageFromId(message: MyMessage) {\r\n    let fromId = message.viaBotId || message.fromId;\r\n\r\n    // fix for saved messages forward to self\r\n    if(fromId === rootScope.myId && message.peerId === rootScope.myId && (message as Message.message).fwdFromId === fromId) {\r\n      fromId = fromId.toPeerId(true);\r\n    }\r\n\r\n    return fromId;\r\n  }\r\n\r\n  createItem(bubble: HTMLElement, message: MyMessage) {\r\n    const single = !(message._ === 'message' || (message.action && SERVICE_AS_REGULAR.has(message.action._)));\r\n    const {mid, date: timestamp} = message;\r\n    const {dateTimestamp} = this.chat.bubbles.getDateForDateContainer(timestamp);\r\n    const item: GroupItem = {\r\n      mid, \r\n      groupMid: this.chat.type === 'scheduled' ? +`${(timestamp * 1000 - dateTimestamp) / 1000}.${mid}` : mid, \r\n      fromId: this.getMessageFromId(message), \r\n      bubble, \r\n      // timestamp: this.chat.type === 'scheduled' ? +`${(timestamp * 1000 - dateTimestamp) / 1000}.${mid}` : timestamp, \r\n      timestamp,\r\n      dateTimestamp, \r\n      mounted: false, \r\n      single,\r\n      message\r\n    };\r\n\r\n    return item;\r\n  }\r\n\r\n  splitSiblingsOnGrouping(siblings: ReturnType<BubbleGroups['getSiblingsAtIndex']>) {\r\n    const [previousSibling, nextSibling] = siblings;\r\n    const previousGroup = previousSibling?.group;\r\n    const nextGroup = nextSibling?.group;\r\n\r\n    if(!previousGroup) {\r\n      return;\r\n    }\r\n\r\n    // will refresh group\r\n    // if(previousGroup === nextGroup) {\r\n      const items = previousGroup.items;\r\n      const index = items.indexOf(previousSibling) + 1;\r\n      const length = items.length;\r\n      if(index === length) {\r\n        return;\r\n      }\r\n\r\n      const modifiedGroups: BubbleGroup[] = [previousGroup];\r\n      // if(previousGroup !== nextGroup && nextGroup) {\r\n      //   modifiedGroups.push(nextGroup);\r\n      // }\r\n\r\n      this.f(items, index, length);\r\n      return modifiedGroups;\r\n    // }\r\n  }\r\n\r\n  prepareForGrouping(bubble: HTMLElement, message: MyMessage) {\r\n    const foundItem = this.getItemByBubble(bubble);\r\n    if(foundItem) { // should happen only on edit\r\n      // debugger;\r\n      return;\r\n    }\r\n\r\n    const item = this.createItem(bubble, message);\r\n    this.addItemToCache(item);\r\n  }\r\n\r\n  groupUngrouped() {\r\n    const items = this.itemsArr;\r\n    const length = items.length;\r\n    const modifiedGroups: Set<BubbleGroup> = new Set();\r\n    // for(let i = length - 1; i >= 0; --i) {\r\n    for(let i = 0; i < length; ++i) {\r\n      const item = items[i];\r\n      if(item.group) {\r\n        continue;\r\n      }\r\n\r\n      let hadGroup = true;\r\n      const siblings = this.getSiblingsAtIndex(i, items);\r\n      const siblingGroupedItem = this.findGroupSiblingInItems(item, items, i, length);\r\n\r\n      // const foundItem = this.findGroupSiblingInSiblings(item, siblings);\r\n      const foundItem = siblingGroupedItem;\r\n      const group = foundItem?.group ?? (hadGroup = false, new BubbleGroup(this.chat, this, item.dateTimestamp));\r\n\r\n      modifiedGroups.add(group);\r\n      group.insertItem(item);\r\n\r\n      if(!hadGroup) {\r\n        const splittedGroups = this.splitSiblingsOnGrouping(siblings);\r\n        if(splittedGroups) {\r\n          splittedGroups.forEach((group) => modifiedGroups.add(group));\r\n        }\r\n      }\r\n    }\r\n\r\n    return modifiedGroups;\r\n  }\r\n\r\n  // addBubble(bubble: HTMLElement, message: MyMessage, unmountIfFound?: boolean) {\r\n  //   const oldItem = this.getItemByBubble(bubble);\r\n  //   if(unmountIfFound) { // updating position\r\n  //     this.removeAndUnmountBubble(bubble);\r\n  //   } else if(oldItem) { // editing\r\n  //     const group = oldItem.group;\r\n  //     this.changeItemBubble(oldItem, bubble);\r\n  //     oldItem.mounted = false;\r\n\r\n  //     return {item: oldItem, group};\r\n  //   }\r\n\r\n  //   const item = this.createItem(bubble, message);\r\n\r\n  //   const foundItem = this.findSameGroupItem(item, this.itemsArr);\r\n\r\n  //   const group = foundItem?.group ?? new BubbleGroup(this.chat, this, item.dateTimestamp);\r\n  //   this.addItemToGroup(item, group);\r\n    \r\n  //   return {item, group};\r\n  // }\r\n\r\n  /* setClipIfNeeded(bubble: HTMLDivElement, remove = false) {\r\n    //console.log('setClipIfNeeded', bubble, remove);\r\n    const className = bubble.className;\r\n    if(className.includes('is-message-empty') && (className.includes('photo') || className.includes('video'))) {\r\n      let container = bubble.querySelector('.bubble__media-container') as SVGSVGElement;\r\n      //console.log('setClipIfNeeded', bubble, remove, container);\r\n      if(!container) return;\r\n\r\n      try {\r\n        Array.from(container.children).forEach((object) => {\r\n          if(object instanceof SVGDefsElement) return;\r\n  \r\n          if(remove) {\r\n            object.removeAttributeNS(null, 'clip-path');\r\n          } else {\r\n            let clipId = container.dataset.clipId;\r\n            let path = container.firstElementChild.firstElementChild.lastElementChild as SVGPathElement;\r\n            let width = +object.getAttributeNS(null, 'width');\r\n            let height = +object.getAttributeNS(null, 'height');\r\n            let isOut = className.includes('is-out');\r\n            let isReply = className.includes('is-reply');\r\n            let d = '';\r\n    \r\n            //console.log('setClipIfNeeded', object, width, height, isOut);\r\n    \r\n            let tr: number, tl: number;\r\n            if(className.includes('forwarded') || isReply) {\r\n              tr = tl = 0;\r\n            } else if(isOut) {\r\n              tr = className.includes('is-group-first') ? 12 : 6;\r\n              tl = 12;\r\n            } else {\r\n              tr = 12;\r\n              tl = className.includes('is-group-first') ? 12 : 6;\r\n            }\r\n    \r\n            if(isOut) {\r\n              d = generatePathData(0, 0, width - 9, height, tl, tr, 0, 12);\r\n            } else {\r\n              d = generatePathData(9, 0, width - 9, height, tl, tr, 12, 0);\r\n            }\r\n            \r\n            path.setAttributeNS(null, 'd', d);\r\n            object.setAttributeNS(null, 'clip-path', 'url(#' + clipId + ')');\r\n          }\r\n        });\r\n      } catch(err) {}\r\n    }\r\n  } */\r\n  \r\n  // updateGroupByMessageId(mid: number) {\r\n  //   const item = this.itemsArr.find((g) => g.mid === mid);\r\n  //   if(item) {\r\n  //     item.group.updateGroup();\r\n  //   }\r\n  // }\r\n  \r\n  cleanup() {\r\n    this.itemsArr = [];\r\n    this.groups = [];\r\n    this.itemsMap.clear();\r\n  }\r\n\r\n  // findIncorrentPositions() {\r\n  //   var bubbles = Array.from(this.chat.bubbles.chatInner.querySelectorAll('.bubbles-group .bubble')).reverse();\r\n  //   var items = this.itemsArr;\r\n  //   for(var i = 0, length = items.length; i < length; ++i) {\r\n  //     const item = items[i];\r\n  //     const foundBubble = bubbles[i];\r\n  //     if(item.bubble !== foundBubble) {\r\n  //       console.log('incorrect position', i, item, foundBubble);\r\n  //       // debugger;\r\n  //       // break;\r\n  //     }\r\n  //   }\r\n  // }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function partition<T>(arr: T[], callback: (item: T, idx: number, arr: T[]) => boolean) {\r\n  const good: T[] = [], bad: T[] = [];\r\n  for(let i = 0, length = arr.length; i < length; ++i) {\r\n    const item = arr[i];\r\n    (callback(item, i, arr) ? good : bad).push(item);\r\n  }\r\n\r\n  return [good, bad];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { PopupOptions } from \".\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport I18n, { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport InputField from \"../inputField\";\r\n\r\nexport default class PopupDatePicker extends PopupElement {\r\n  protected controlsDiv: HTMLElement;\r\n  protected monthTitle: HTMLElement;\r\n  protected prevBtn: HTMLElement;\r\n  protected nextBtn: HTMLElement;\r\n\r\n  protected monthsContainer: HTMLElement;\r\n  protected month: HTMLElement;\r\n\r\n  protected minMonth: Date;\r\n  protected maxMonth: Date;\r\n  protected minDate: Date;\r\n  protected maxDate: Date;\r\n  protected selectedDate: Date;\r\n  protected selectedMonth: Date;\r\n  protected selectedEl: HTMLElement;\r\n\r\n  protected timeDiv: HTMLDivElement;\r\n  protected hoursInputField: InputField;\r\n  protected minutesInputField: InputField;\r\n\r\n  constructor(initDate: Date, public onPick: (timestamp: number) => void, protected options: Partial<{\r\n    noButtons: true, \r\n    noTitle: true, \r\n    minDate: Date,\r\n    maxDate: Date\r\n    withTime: true,\r\n    showOverflowMonths: true\r\n  }> & PopupOptions = {}) {\r\n    super('popup-date-picker', options.noButtons ? [] : [{\r\n      langKey: 'JumpToDate',\r\n      callback: () => {\r\n        if(this.onPick) {\r\n          this.onPick(this.selectedDate.getTime() / 1000 | 0);\r\n        }\r\n      }\r\n    }, {\r\n      langKey: 'Cancel',\r\n      isCancel: true\r\n    }], {body: true, overlayClosable: true, ...options});\r\n\r\n    this.minDate = options.minDate || new Date('2013-08-01T00:00:00');\r\n\r\n    if(initDate < this.minDate) {\r\n      initDate.setFullYear(this.minDate.getFullYear(), this.minDate.getMonth(), this.minDate.getDate());\r\n    }\r\n\r\n    // Controls\r\n    this.controlsDiv = document.createElement('div');\r\n    this.controlsDiv.classList.add('date-picker-controls');\r\n\r\n    this.prevBtn = document.createElement('button');\r\n    this.prevBtn.classList.add('btn-icon', 'tgico-down', 'date-picker-prev');\r\n    attachClickEvent(this.prevBtn, this.onPrevClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.nextBtn = document.createElement('button');\r\n    this.nextBtn.classList.add('btn-icon', 'tgico-down', 'date-picker-next');\r\n    attachClickEvent(this.nextBtn, this.onNextClick, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.monthTitle = document.createElement('div');\r\n    this.monthTitle.classList.add('date-picker-month-title');\r\n\r\n    this.controlsDiv.append(this.prevBtn, this.monthTitle, this.nextBtn);\r\n\r\n    // Month\r\n    this.monthsContainer = document.createElement('div');\r\n    this.monthsContainer.classList.add('date-picker-months');\r\n    attachClickEvent(this.monthsContainer, this.onDateClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.body.append(this.controlsDiv, this.monthsContainer);\r\n\r\n    // Time inputs\r\n    if(options.withTime) {\r\n      this.timeDiv = document.createElement('div');\r\n      this.timeDiv.classList.add('date-picker-time');\r\n\r\n      const delimiter = document.createElement('div');\r\n      delimiter.classList.add('date-picker-time-delimiter');\r\n      delimiter.append(':');\r\n\r\n      const handleTimeInput = (max: number, inputField: InputField, onInput: (length: number) => void, onOverflow?: (number: number) => void) => {\r\n        const maxString = '' + max;\r\n        this.listenerSetter.add(inputField.input)('input', (e) => {\r\n          let value = inputField.value.replace(/\\D/g, '');\r\n          if(value.length > 2) {\r\n            value = value.slice(0, 2);\r\n          } else {\r\n            if((value.length === 1 && +value[0] > +maxString[0]) || (value.length === 2 && +value > max)) {\r\n              if(value.length === 2 && onOverflow) {\r\n                onOverflow(+value[1]);\r\n              }\r\n\r\n              value = '0' + value[0];\r\n            }\r\n          }\r\n\r\n          inputField.setValueSilently(value);\r\n          onInput(value.length);\r\n        });\r\n      };\r\n\r\n      this.hoursInputField = new InputField({plainText: true});\r\n      this.minutesInputField = new InputField({plainText: true});\r\n\r\n      handleTimeInput(23, this.hoursInputField, (length) => {\r\n        if(length === 2) {\r\n          this.minutesInputField.input.focus();\r\n        }\r\n\r\n        this.setTimeTitle();\r\n      }, (number) => {\r\n        this.minutesInputField.value = (number + this.minutesInputField.value).slice(0, 2);\r\n      });\r\n      handleTimeInput(59, this.minutesInputField, (length) => {\r\n        if(!length) {\r\n          this.hoursInputField.input.focus();\r\n        }\r\n\r\n        this.setTimeTitle();\r\n      });\r\n\r\n      this.selectedDate = initDate;\r\n\r\n      initDate.setMinutes(initDate.getMinutes() + 10);\r\n      \r\n      this.hoursInputField.setValueSilently(('0' + initDate.getHours()).slice(-2));\r\n      this.minutesInputField.setValueSilently(('0' + initDate.getMinutes()).slice(-2));\r\n\r\n      initDate.setHours(0, 0, 0, 0);\r\n      \r\n      this.timeDiv.append(this.hoursInputField.container, delimiter, this.minutesInputField.container);\r\n\r\n      attachClickEvent(this.btnConfirm, () => {\r\n        if(this.onPick) {\r\n          this.selectedDate.setHours(+this.hoursInputField.value || 0, +this.minutesInputField.value || 0, 0, 0);\r\n          this.onPick(this.selectedDate.getTime() / 1000 | 0);\r\n        }\r\n\r\n        this.hide();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.body.append(this.timeDiv);\r\n\r\n      this.prevBtn.classList.add('primary');\r\n      this.nextBtn.classList.add('primary');\r\n    }\r\n\r\n    const popupCenterer = document.createElement('div');\r\n    popupCenterer.classList.add('popup-centerer');\r\n    popupCenterer.append(this.container);\r\n    this.element.append(popupCenterer);\r\n\r\n    //const passed = (initDate.getTime() - (initDate.getTimezoneOffset() * 60000)) % 86400000;\r\n    //this.selectedDate = this.maxDate = new Date(initDate.getTime() - passed);\r\n    initDate.setHours(0, 0, 0, 0);\r\n    this.selectedDate = initDate;\r\n\r\n    this.maxDate = options.maxDate || new Date();\r\n    this.maxDate.setHours(0, 0, 0, 0);\r\n\r\n    this.selectedMonth = new Date(this.selectedDate);\r\n    this.selectedMonth.setDate(1);\r\n\r\n    this.maxMonth = new Date(this.maxDate);\r\n    this.maxMonth.setDate(1);\r\n\r\n    this.minMonth = new Date(this.minDate);\r\n    this.minMonth.setHours(0, 0, 0, 0);\r\n    this.minMonth.setDate(1);\r\n\r\n    if(this.selectedMonth.getTime() === this.minMonth.getTime()) {\r\n      this.prevBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(this.selectedMonth.getTime() === this.maxMonth.getTime()) {\r\n      this.nextBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(options.noTitle) {\r\n      this.setTitle = () => {};\r\n    }\r\n\r\n    this.setTimeTitle();\r\n    this.setTitle();\r\n    this.setMonth();\r\n  }\r\n\r\n  onPrevClick = (e: MouseEvent) => {\r\n    this.selectedMonth.setMonth(this.selectedMonth.getMonth() - 1);\r\n    this.setMonth();\r\n\r\n    if(this.selectedMonth.getTime() === this.minMonth.getTime()) {\r\n      this.prevBtn.setAttribute('disabled', 'true');\r\n    }\r\n    \r\n    this.nextBtn.removeAttribute('disabled');\r\n  };\r\n\r\n  onNextClick = (e: MouseEvent) => {\r\n    this.selectedMonth.setMonth(this.selectedMonth.getMonth() + 1);\r\n    this.setMonth();\r\n\r\n    if(this.selectedMonth.getTime() === this.maxMonth.getTime()) {\r\n      this.nextBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    this.prevBtn.removeAttribute('disabled');\r\n  };\r\n\r\n  onDateClick = (e: MouseEvent) => {\r\n    //cancelEvent(e);\r\n    const target = e.target as HTMLElement;\r\n\r\n    if(!target.dataset.timestamp) return;\r\n\r\n    if(this.selectedEl) {\r\n      if(this.selectedEl === target) return;\r\n      this.selectedEl.classList.remove('active');\r\n    }\r\n\r\n    this.selectedEl = target;\r\n    \r\n    target.classList.add('active');\r\n    const timestamp = +target.dataset.timestamp;\r\n\r\n    this.selectedDate = new Date(timestamp);\r\n\r\n    this.setTitle();\r\n    this.setTimeTitle();\r\n  };\r\n\r\n  public setTimeTitle() {\r\n    if(this.btnConfirm && this.selectedDate) {\r\n      let key: LangPackKey, args: any[] = [];\r\n      const date = new Date();\r\n      date.setHours(0, 0, 0, 0);\r\n\r\n      const timeOptions: Intl.DateTimeFormatOptions = {\r\n        minute: '2-digit',\r\n        hour: '2-digit'\r\n      };\r\n      \r\n      const sendDate = new Date(this.selectedDate.getTime());\r\n      sendDate.setHours(+this.hoursInputField.value, +this.minutesInputField.value);\r\n\r\n      if(this.selectedDate.getTime() === date.getTime()) {\r\n        key = 'Schedule.SendToday';\r\n      }/*  else if(this.selectedDate.getTime() === (date.getTime() + 86400e3)) {\r\n        dayStr = 'Tomorrow';\r\n      } */ else {\r\n        key = 'Schedule.SendDate';\r\n\r\n        const dateOptions: Intl.DateTimeFormatOptions = {\r\n          month: 'short',\r\n          day: 'numeric'\r\n        };\r\n\r\n        if(sendDate.getFullYear() !== date.getFullYear()) {\r\n          dateOptions.year = 'numeric';\r\n        }\r\n\r\n        args.push(new I18n.IntlDateElement({\r\n          date: sendDate,\r\n          options: dateOptions\r\n        }).element);\r\n      }\r\n\r\n      args.push(new I18n.IntlDateElement({\r\n        date: sendDate,\r\n        options: timeOptions\r\n      }).element);\r\n\r\n      this.btnConfirm.firstChild.replaceWith(i18n(key, args));\r\n    }\r\n  }\r\n\r\n  public setTitle() {\r\n    //const splitted = this.selectedDate.toString().split(' ', 3);\r\n    //this.title.innerText = splitted[0] + ', ' + splitted[1] + ' ' + splitted[2];\r\n    this.title.textContent = '';\r\n    this.title.append(new I18n.IntlDateElement({\r\n      date: this.selectedDate,\r\n      options: {\r\n        day: 'numeric',\r\n        month: 'long',\r\n        weekday: 'short'\r\n      }\r\n    }).element);\r\n  }\r\n\r\n  private renderElement(disabled: boolean, innerText: string | HTMLElement = '') {\r\n    const el = document.createElement('button');\r\n    el.classList.add('btn-icon', 'date-picker-month-date');\r\n\r\n    if(disabled) {\r\n      el.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(innerText) {\r\n      el.append(innerText);\r\n    }\r\n\r\n    return el;\r\n  }\r\n\r\n  public setMonth() {\r\n    const firstDate = new Date(this.selectedMonth);\r\n\r\n    const options: Intl.DateTimeFormatOptions = {\r\n      year: 'numeric',\r\n      month: this.timeDiv && mediaSizes.isMobile ? 'short' : 'long'\r\n    };\r\n\r\n    this.monthTitle.textContent = '';\r\n    this.monthTitle.append(new I18n.IntlDateElement({date: firstDate, options}).element);\r\n    //this.monthTitle.innerText = (this.timeDiv && mediaSizes.isMobile ? monthName.slice(0, 3) : monthName) + ' ' + this.selectedMonth.getFullYear();\r\n\r\n    if(this.month) {\r\n      this.month.remove();\r\n    }\r\n\r\n    this.month = document.createElement('div');\r\n    this.month.classList.add('date-picker-month');\r\n\r\n    const weekStartDate = new Date();\r\n    const day = weekStartDate.getDay();\r\n    if(day !== 1) {\r\n      weekStartDate.setHours(-24 * (day - 1)); \r\n    }\r\n\r\n    for(let i = 0; i < 7; ++i) {\r\n      const el = this.renderElement(true, new I18n.IntlDateElement({date: weekStartDate, options: {weekday: 'narrow'}}).element);\r\n      el.classList.remove('date-picker-month-date');\r\n      el.classList.add('date-picker-month-day');\r\n      this.month.append(el);\r\n      weekStartDate.setDate(weekStartDate.getDate() + 1);\r\n    }\r\n\r\n    // 0 - sunday\r\n    let dayIndex = firstDate.getDay() - 1;\r\n    if(dayIndex === -1) dayIndex = 7 - 1;\r\n\r\n    const clonedDate = new Date(firstDate.getTime());\r\n    clonedDate.setDate(clonedDate.getDate() - dayIndex - 1);\r\n\r\n    // Padding first week\r\n    for(let i = 0; i < dayIndex; ++i) {\r\n      if(this.options.showOverflowMonths) {\r\n        clonedDate.setDate(clonedDate.getDate() + 1);\r\n        this.month.append(this.renderElement(true, '' + clonedDate.getDate()));\r\n      } else {\r\n        this.month.append(this.renderElement(true));\r\n      }\r\n    }\r\n\r\n    do {\r\n      const date = firstDate.getDate();\r\n      const el = this.renderElement(firstDate > this.maxDate || firstDate < this.minDate, '' + date);\r\n      el.dataset.timestamp = '' + firstDate.getTime();\r\n\r\n      if(firstDate.getTime() === this.selectedDate.getTime()) {\r\n        this.selectedEl = el;\r\n        el.classList.add('active');\r\n      }\r\n\r\n      this.month.append(el);\r\n\r\n      firstDate.setDate(date + 1);\r\n    } while(firstDate.getDate() !== 1);\r\n\r\n    const remainder = this.month.childElementCount % 7;\r\n    if(this.options.showOverflowMonths && remainder) {\r\n      for(let i = remainder; i < 7; ++i) {\r\n        this.month.append(this.renderElement(true, '' + firstDate.getDate()));\r\n        firstDate.setDate(firstDate.getDate() + 1);\r\n      }\r\n    }\r\n\r\n    const lines = Math.ceil(this.month.childElementCount / 7);\r\n    this.container.dataset.lines = '' + lines;\r\n\r\n    this.monthsContainer.append(this.month);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class StickyIntersector {\r\n  private headersObserver: IntersectionObserver;\r\n  private elementsObserver: IntersectionObserver;\r\n\r\n  constructor(private container: HTMLElement, private handler: (stuck: boolean, target: HTMLElement) => void) {\r\n    this.observeHeaders();\r\n    this.observeElements();\r\n  }\r\n\r\n  /**\r\n   * Sets up an intersection observer to notify when elements with the class\r\n   * `.sticky_sentinel--top` become visible/invisible at the top of the container.\r\n   * @param {!Element} container\r\n   */\r\n  private observeHeaders() {\r\n    this.headersObserver = new IntersectionObserver((entries) => {\r\n      for(const entry of entries) {\r\n        const targetInfo = entry.boundingClientRect;\r\n        const stickyTarget = entry.target.parentElement;\r\n        const rootBoundsInfo = entry.rootBounds;\r\n  \r\n        // Started sticking.\r\n        if(targetInfo.bottom < rootBoundsInfo.top) {\r\n          this.handler(true, stickyTarget);\r\n        }\r\n  \r\n        // Stopped sticking.\r\n        if(targetInfo.bottom >= rootBoundsInfo.top &&\r\n            targetInfo.bottom < rootBoundsInfo.bottom) {\r\n          this.handler(false, stickyTarget);\r\n        }\r\n      }\r\n    }, {threshold: 0, root: this.container});\r\n  }\r\n  \r\n  private observeElements() {\r\n    this.elementsObserver = new IntersectionObserver((entries) => {\r\n      const entry = entries\r\n      .filter((entry) => entry.boundingClientRect.top < entry.rootBounds.top)\r\n      .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];\r\n      if(!entry) return;\r\n\r\n      const container = entry.isIntersecting ? entry.target : entry.target.nextElementSibling;\r\n      this.handler(true, container as HTMLElement);\r\n    }, {root: this.container});\r\n  }\r\n\r\n  /**\r\n   * @param {!Element} container\r\n   * @param {string} className\r\n   */\r\n  private addSentinel(container: HTMLElement, className: string) {\r\n    const sentinel = document.createElement('div');\r\n    sentinel.classList.add('sticky_sentinel', className);\r\n    return container.appendChild(sentinel);\r\n  }\r\n\r\n  /**\r\n   * Notifies when elements w/ the `sticky` class begin to stick or stop sticking.\r\n   * Note: the elements should be children of `container`.\r\n   * @param {!Element} container\r\n   */\r\n  public observeStickyHeaderChanges(element: HTMLElement) {\r\n    const headerSentinel = this.addSentinel(element, 'sticky_sentinel--top');\r\n    this.headersObserver.observe(headerSentinel);\r\n\r\n    this.elementsObserver.observe(element);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.headersObserver.disconnect();\r\n    this.elementsObserver.disconnect();\r\n  }\r\n\r\n  public unobserve(element: HTMLElement, headerSentinel: HTMLElement) {\r\n    this.elementsObserver.unobserve(element);\r\n    this.headersObserver.unobserve(headerSentinel);\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport { MessagePeerReaction, ReactionCount } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport { wrapSticker, wrapStickerAnimation } from \"../wrappers\";\r\nimport { Awaited } from \"../../types\";\r\n\r\nconst CLASS_NAME = 'reaction';\r\nconst TAG_NAME = CLASS_NAME + '-element';\r\nconst REACTION_INLINE_SIZE = 14;\r\nconst REACTION_BLOCK_SIZE = 22;\r\n\r\nexport const REACTION_DISPLAY_INLINE_COUNTER_AT = 2;\r\nexport const REACTION_DISPLAY_BLOCK_COUNTER_AT = 4;\r\n\r\nexport type ReactionLayoutType = 'block' | 'inline';\r\n\r\nexport default class ReactionElement extends HTMLElement {\r\n  private type: ReactionLayoutType;\r\n  private counter: HTMLElement;\r\n  private stickerContainer: HTMLElement;\r\n  private stackedAvatars: StackedAvatars;\r\n  private canRenderAvatars: boolean;\r\n  private _reactionCount: ReactionCount;\r\n  private wrapStickerPromise: Awaited<ReturnType<typeof wrapSticker>>['render'];\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super();\r\n    this.classList.add(CLASS_NAME);\r\n    this.managers = rootScope.managers;\r\n  }\r\n\r\n  public get reactionCount() {\r\n    return this._reactionCount;\r\n  }\r\n  \r\n  public set reactionCount(reactionCount: ReactionCount) {\r\n    this._reactionCount = reactionCount;\r\n  }\r\n\r\n  public get count() {\r\n    return this.reactionCount.count;\r\n  }\r\n\r\n  public init(type: ReactionLayoutType) {\r\n    this.type = type;\r\n    this.classList.add(CLASS_NAME + '-' + type);\r\n  }\r\n\r\n  public setCanRenderAvatars(canRenderAvatars: boolean) {\r\n    this.canRenderAvatars = canRenderAvatars;\r\n  }\r\n\r\n  public render(doNotRenderSticker?: boolean) {\r\n    const hadStickerContainer = !!this.stickerContainer;\r\n    if(!hadStickerContainer) {\r\n      this.stickerContainer = document.createElement('div');\r\n      this.stickerContainer.classList.add(CLASS_NAME + '-sticker');\r\n      this.append(this.stickerContainer);\r\n    }\r\n    \r\n    const reactionCount = this.reactionCount;\r\n    if(!doNotRenderSticker && !hadStickerContainer) {\r\n      const availableReaction = this.managers.appReactionsManager.getReaction(reactionCount.reaction);\r\n      callbackify(availableReaction, (availableReaction) => {\r\n        if(!availableReaction.center_icon) {\r\n          this.stickerContainer.classList.add('is-static');\r\n        }\r\n\r\n        if(availableReaction.pFlags.inactive) {\r\n          this.classList.add('is-inactive');\r\n        }\r\n\r\n        const size = this.type === 'inline' ? REACTION_INLINE_SIZE : REACTION_BLOCK_SIZE;\r\n        const wrapPromise = this.wrapStickerPromise = wrapSticker({\r\n          div: this.stickerContainer,\r\n          doc: availableReaction.center_icon ?? availableReaction.static_icon,\r\n          width: size,\r\n          height: size,\r\n          static: true,\r\n          managers: this.managers\r\n        }).then(({render}) => render).finally(() => {\r\n          if(this.wrapStickerPromise === wrapPromise) {\r\n            this.wrapStickerPromise = undefined;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  public renderCounter() {\r\n    const reactionCount = this.reactionCount;\r\n    const displayOn = this.type === 'inline' ? REACTION_DISPLAY_INLINE_COUNTER_AT : REACTION_DISPLAY_BLOCK_COUNTER_AT;\r\n    if(reactionCount.count >= displayOn || (this.type === 'block' && !this.canRenderAvatars)) {\r\n      if(!this.counter) {\r\n        this.counter = document.createElement(this.type === 'inline' ? 'i' : 'span');\r\n        this.counter.classList.add(CLASS_NAME + '-counter');\r\n      }\r\n\r\n      const formatted = formatNumber(reactionCount.count);\r\n      if(this.counter.textContent !== formatted) {\r\n        this.counter.textContent = formatted;\r\n      }\r\n\r\n      if(!this.counter.parentElement) {\r\n        this.append(this.counter);\r\n      }\r\n    } else if(this.counter?.parentElement) {\r\n      this.counter.remove();\r\n      this.counter = undefined;\r\n    }\r\n  }\r\n\r\n  public renderAvatars(recentReactions: MessagePeerReaction[]) {\r\n    if(this.type === 'inline') {\r\n      return;\r\n    }\r\n\r\n    if(this.reactionCount.count >= REACTION_DISPLAY_BLOCK_COUNTER_AT || !this.canRenderAvatars) {\r\n      if(this.stackedAvatars) {\r\n        this.stackedAvatars.container.remove();\r\n        this.stackedAvatars = undefined;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!this.stackedAvatars) {\r\n      this.stackedAvatars = new StackedAvatars({\r\n        avatarSize: 24\r\n      });\r\n\r\n      this.append(this.stackedAvatars.container);\r\n    }\r\n\r\n    this.stackedAvatars.render(recentReactions.map((reaction) => getPeerId(reaction.peer_id)));\r\n  }\r\n\r\n  public setIsChosen(isChosen = !!this.reactionCount.pFlags.chosen) {\r\n    if(this.type === 'inline') return;\r\n    const wasChosen = this.classList.contains('is-chosen') && !this.classList.contains('backwards');\r\n    if(wasChosen !== isChosen) {\r\n      SetTransition(this, 'is-chosen', isChosen, this.isConnected ? 300 : 0);\r\n    }\r\n  }\r\n\r\n  public fireAroundAnimation() {\r\n    callbackify(this.managers.appReactionsManager.getReaction(this.reactionCount.reaction), (availableReaction) => {\r\n      const size = this.type === 'inline' ? REACTION_INLINE_SIZE + 14 : REACTION_BLOCK_SIZE + 18;\r\n      const div = document.createElement('div');\r\n      div.classList.add(CLASS_NAME + '-sticker-activate');\r\n\r\n      Promise.all([\r\n        wrapSticker({\r\n          div: div,\r\n          doc: availableReaction.center_icon,\r\n          width: size,\r\n          height: size,\r\n          withThumb: false,\r\n          needUpscale: true,\r\n          play: false,\r\n          skipRatio: 1,\r\n          group: 'none',\r\n          needFadeIn: false,\r\n          managers: this.managers\r\n        }).then(({render}) => render as Promise<RLottiePlayer>),\r\n\r\n        wrapStickerAnimation({\r\n          doc: availableReaction.around_animation,\r\n          size: 80,\r\n          target: this.stickerContainer,\r\n          side: 'center',\r\n          skipRatio: 1,\r\n          play: false,\r\n          managers: this.managers\r\n        }).stickerPromise\r\n      ]).then(([iconPlayer, aroundPlayer]) => {\r\n        const remove = () => {\r\n          // if(!isInDOM(div)) return;\r\n          fastRaf(() => {\r\n            // if(!isInDOM(div)) return;\r\n            iconPlayer.remove();\r\n            div.remove();\r\n            this.stickerContainer.classList.remove('has-animation');\r\n          });\r\n        };\r\n\r\n        iconPlayer.addEventListener('enterFrame', (frameNo) => {\r\n          if(frameNo === iconPlayer.maxFrame) {\r\n            if(this.wrapStickerPromise) { // wait for fade in animation\r\n              this.wrapStickerPromise.then(() => {\r\n                setTimeout(remove, 1e3);\r\n              });\r\n            } else {\r\n              remove();\r\n            }\r\n          }\r\n        });\r\n\r\n        iconPlayer.addEventListener('firstFrame', () => {\r\n          this.stickerContainer.append(div);\r\n          this.stickerContainer.classList.add('has-animation');\r\n          iconPlayer.play();\r\n          aroundPlayer.play();\r\n        }, {once: true});\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, ReactionElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport { Message, ReactionCount } from \"../../layer\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ReactionElement, { ReactionLayoutType, REACTION_DISPLAY_BLOCK_COUNTER_AT } from \"./reaction\";\r\n\r\nconst CLASS_NAME = 'reactions';\r\nconst TAG_NAME = CLASS_NAME + '-element';\r\n\r\nconst REACTIONS_ELEMENTS: Map<string, Set<ReactionsElement>> = new Map();\r\nexport { REACTIONS_ELEMENTS };\r\n\r\nexport default class ReactionsElement extends HTMLElement {\r\n  private message: Message.message;\r\n  private key: string;\r\n  private isPlaceholder: boolean;\r\n  private type: ReactionLayoutType;\r\n  private sorted: ReactionElement[];\r\n  private onConnectCallback: () => void;\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super();\r\n    this.classList.add(CLASS_NAME);\r\n    this.sorted = [];\r\n    this.managers = rootScope.managers;\r\n  }\r\n  \r\n  connectedCallback() {\r\n    let set = REACTIONS_ELEMENTS.get(this.key);\r\n    if(!set) {\r\n      REACTIONS_ELEMENTS.set(this.key, set = new Set());\r\n    }\r\n\r\n    set.add(this);\r\n\r\n    if(this.onConnectCallback && this.isConnected) {\r\n      this.onConnectCallback();\r\n      this.onConnectCallback = undefined;\r\n    }\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    const set = REACTIONS_ELEMENTS.get(this.key);\r\n    set.delete(this);\r\n    if(!set.size) {\r\n      REACTIONS_ELEMENTS.delete(this.key);\r\n    }\r\n  }\r\n\r\n  public getReactionCount(reactionElement: ReactionElement) {\r\n    return this.sorted[this.sorted.indexOf(reactionElement)].reactionCount;\r\n  }\r\n\r\n  public getMessage() {\r\n    return this.message;\r\n  }\r\n\r\n  public init(message: Message.message, type: ReactionLayoutType, isPlaceholder?: boolean) {\r\n    if(this.key !== undefined) {\r\n      this.disconnectedCallback();\r\n    }\r\n\r\n    this.message = message;\r\n    this.key = this.message.peerId + '_' + this.message.mid;\r\n    this.isPlaceholder = isPlaceholder;\r\n\r\n    if(this.type !== type) {\r\n      this.type = type;\r\n      this.classList.add(CLASS_NAME + '-' + type);\r\n    }\r\n\r\n    this.connectedCallback();\r\n  }\r\n\r\n  public changeMessage(message: Message.message) {\r\n    return this.init(message, this.type, this.isPlaceholder);\r\n  }\r\n\r\n  public update(message: Message.message, changedResults?: ReactionCount[]) {\r\n    this.message = message;\r\n    this.render(changedResults);\r\n  }\r\n\r\n  public render(changedResults?: ReactionCount[]) {\r\n    const reactions = this.message.reactions;\r\n    const hasReactions = !!(reactions && reactions.results.length);\r\n    this.classList.toggle('has-no-reactions', !hasReactions);\r\n    if(!hasReactions && !this.sorted.length) return;\r\n\r\n    const availableReactionsResult = this.managers.appReactionsManager.getAvailableReactions();\r\n    // callbackify(availableReactionsResult, () => {\r\n      const counts = hasReactions ? (\r\n        availableReactionsResult instanceof Promise ? \r\n          reactions.results : \r\n          reactions.results.filter((reactionCount) => {\r\n            return this.managers.appReactionsManager.isReactionActive(reactionCount.reaction);\r\n          })\r\n      ) : [];\r\n\r\n      forEachReverse(this.sorted, (reactionElement, idx, arr) => {\r\n        const reaction = reactionElement.reactionCount.reaction;\r\n        const found = counts.some((reactionCount) => reactionCount.reaction === reaction);\r\n        if(!found) {\r\n          arr.splice(idx, 1);\r\n          reactionElement.remove();\r\n        }\r\n      });\r\n\r\n      const totalReactions = counts.reduce((acc, c) => acc + c.count, 0);\r\n      const canRenderAvatars = reactions && !!reactions.pFlags.can_see_list && totalReactions < REACTION_DISPLAY_BLOCK_COUNTER_AT;\r\n      this.sorted = counts.map((reactionCount, idx) => {\r\n        const reactionElementIdx = this.sorted.findIndex((reactionElement) => reactionElement.reactionCount.reaction === reactionCount.reaction);\r\n        let reactionElement = reactionElementIdx !== -1 && this.sorted[reactionElementIdx];\r\n        if(!reactionElement) {\r\n          reactionElement = new ReactionElement();\r\n          reactionElement.init(this.type);\r\n        }\r\n\r\n        positionElementByIndex(reactionElement, this, idx);\r\n        \r\n        const recentReactions = reactions.recent_reactions ? reactions.recent_reactions.filter((reaction) => reaction.reaction === reactionCount.reaction) : [];\r\n        reactionElement.reactionCount = {...reactionCount};\r\n        reactionElement.setCanRenderAvatars(canRenderAvatars);\r\n        reactionElement.render(this.isPlaceholder);\r\n        reactionElement.renderCounter();\r\n        reactionElement.renderAvatars(recentReactions);\r\n        reactionElement.setIsChosen();\r\n\r\n        return reactionElement;\r\n      });\r\n\r\n      // this.sorted.forEach((reactionElement, idx) => {\r\n      //   /* if(this.type === 'block' && this.childElementCount !== this.sorted.length) { // because of appended time\r\n      //     idx += 1;\r\n      //   } */\r\n\r\n      //   positionElementByIndex(reactionElement, this, idx);\r\n      // });\r\n\r\n      if(!this.isPlaceholder && changedResults?.length) {\r\n        if(this.isConnected) {\r\n          this.handleChangedResults(changedResults);\r\n        } else {\r\n          this.onConnectCallback = () => {\r\n            this.handleChangedResults(changedResults);\r\n          };\r\n        }\r\n      }\r\n    // });\r\n\r\n    // ! тут вообще не должно быть этого кода, но пока он побудет тут\r\n    if(!this.sorted.length && this.type === 'block') {\r\n      const parentElement = this.parentElement;\r\n      this.remove();\r\n\r\n      if(parentElement.classList.contains('document-message') && !parentElement.childNodes.length) {\r\n        parentElement.remove();\r\n        return;\r\n      }\r\n\r\n      const timeSpan = this.querySelector('.time');\r\n      if(timeSpan) {\r\n        parentElement.append(timeSpan);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleChangedResults(changedResults: ReactionCount[]) {\r\n    // ! temp\r\n    if(this.message.peerId !== appImManager.chat.peerId) return;\r\n\r\n    changedResults.forEach((reactionCount) => {\r\n      const reactionElement = this.sorted.find((reactionElement) => reactionElement.reactionCount.reaction === reactionCount.reaction);\r\n      if(reactionElement) {\r\n        reactionElement.fireAroundAnimation();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, ReactionsElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message } from \"../../layer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ripple from \"../ripple\";\r\nimport I18n from \"../../lib/langPack\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\n\r\nconst TAG_NAME = 'replies-element';\r\n\r\nrootScope.addEventListener('replies_updated', (message) => {\r\n  (Array.from(document.querySelectorAll(TAG_NAME + `[data-post-key=\"${message.peerId}_${message.mid}\"]`)) as RepliesElement[]).forEach((element) => {\r\n    element.message = message;\r\n    element.render();\r\n  });\r\n});\r\n\r\nexport default class RepliesElement extends HTMLElement {\r\n  public message: Message.message;\r\n  public type: 'footer' | 'beside';\r\n  public loadPromises: Promise<any>[];\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public stackedAvatars: StackedAvatars;\r\n  public text: I18n.IntlElement;\r\n  public managers: AppManagers;\r\n  \r\n  private updated = false;\r\n\r\n  constructor() {\r\n    super();\r\n    this.managers = rootScope.managers;\r\n  }\r\n\r\n  public init() {\r\n    this.render();\r\n    this.dataset.postKey = this.message.peerId + '_' + this.message.mid;\r\n    this.classList.add('replies', 'replies-' + this.type);\r\n  }\r\n\r\n  public render() {\r\n    const replies = this.message.replies;\r\n\r\n    /* if(this.firstChild) {\r\n      this.innerHTML = '';\r\n    } */\r\n\r\n    if(this.type === 'footer') {\r\n      let leftPart: HTMLElement;\r\n      if(this.firstElementChild) {\r\n        leftPart = this.firstElementChild as HTMLElement;\r\n      }\r\n\r\n      if(replies?.recent_repliers) {\r\n        if(leftPart && !leftPart.classList.contains('replies-footer-avatars')) {\r\n          this.innerHTML = '';\r\n          leftPart = null;\r\n        }\r\n\r\n        if(!this.stackedAvatars) {\r\n          this.stackedAvatars = new StackedAvatars({\r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            avatarSize: 30\r\n          });\r\n\r\n          this.stackedAvatars.container.classList.add('replies-footer-avatars');\r\n        }\r\n\r\n        leftPart = this.stackedAvatars.container;\r\n\r\n        this.stackedAvatars.render(replies.recent_repliers.map((peer) => getPeerId(peer)), this.loadPromises);\r\n      } else {\r\n        if(leftPart && !leftPart.classList.contains('tgico-comments')) {\r\n          leftPart.remove();\r\n          leftPart = null;\r\n        }\r\n\r\n        if(!leftPart) {\r\n          leftPart = document.createElement('span');\r\n          leftPart.classList.add('tgico-comments');\r\n        }\r\n      }\r\n\r\n      if(!leftPart.parentElement) {\r\n        this.prepend(leftPart);\r\n      }\r\n  \r\n      if(!this.text) {\r\n        this.text = new I18n.IntlElement();\r\n      }\r\n\r\n      const text = this.text;\r\n      if(replies) {\r\n        if(replies.replies) {\r\n          text.compareAndUpdate({key: 'Comments', args: [replies.replies]});\r\n        } else {\r\n          text.compareAndUpdate({key: 'LeaveAComment'});\r\n        }\r\n      } else {\r\n        text.compareAndUpdate({key: 'ViewInChat'});\r\n      }\r\n\r\n      if(replies) {\r\n        // const historyStorage = appMessagesManager.getHistoryStorage(replies.channel_id.toPeerId(true));\r\n        let isUnread = false;\r\n        if(replies.replies) {\r\n          if(replies.read_max_id !== undefined && replies.max_id !== undefined) {\r\n            isUnread = replies.read_max_id < replies.max_id;\r\n          }/*  else {\r\n            isUnread = !historyStorage.readMaxId || historyStorage.readMaxId < (replies.max_id || 0);\r\n          } */\r\n        }\r\n        this.classList.toggle('is-unread', isUnread);\r\n      }\r\n\r\n      let textSpan = this.children[1] as HTMLElement;\r\n      if(!textSpan) {\r\n        textSpan = document.createElement('span');\r\n        textSpan.classList.add('replies-footer-text');\r\n\r\n        const iconSpan = document.createElement('span');\r\n        iconSpan.classList.add('tgico-next');\r\n\r\n        const rippleContainer = document.createElement('div');\r\n        ripple(rippleContainer);\r\n\r\n        this.append(textSpan, iconSpan, rippleContainer);\r\n      }\r\n\r\n      replaceContent(textSpan, text.element);\r\n    } else {\r\n      this.classList.add('bubble-beside-button');\r\n      this.innerHTML = `<span class=\"tgico-commentssticker\"></span><span class=\"replies-beside-text\">${replies?.replies ? formatNumber(replies.replies, 0) : ''}</span>`;\r\n    }\r\n\r\n    if(replies && !this.updated && !this.message.pFlags.is_outgoing) {\r\n      this.managers.appMessagesManager.subscribeRepliesThread(this.message.peerId, this.message.mid);\r\n      this.managers.appMessagesManager.updateMessage(this.message.peerId, this.message.mid, 'replies_updated');\r\n      this.updated = true;\r\n    }\r\n\r\n    if(this.loadPromises) {\r\n      this.loadPromises = undefined;\r\n    }\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, RepliesElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatTime, getFullDate } from \"../../helpers/date\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { Message } from \"../../layer\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { i18n, _i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { wrapReply } from \"../wrappers\";\r\nimport Chat, { ChatType } from \"./chat\";\r\nimport ReactionsElement from \"./reactions\";\r\nimport RepliesElement from \"./replies\";\r\n\r\nconst NBSP = '&nbsp;';\r\n\r\nconst makeEdited = () => {\r\n  const edited = document.createElement('i');\r\n  edited.classList.add('edited');\r\n  _i18n(edited, 'EditedMessage');\r\n  return edited;\r\n};\r\n\r\nconst makeSponsored = () => i18n('SponsoredMessage');\r\n\r\nexport namespace MessageRender {\r\n  /* export const setText = () => {\r\n\r\n  }; */\r\n\r\n  export const setTime = (options: {\r\n    chatType: ChatType, \r\n    message: Message.message | Message.messageService,\r\n    reactionsMessage?: Message.message\r\n  }) => {\r\n    const {chatType, message} = options;\r\n    const date = new Date(message.date * 1000);\r\n    const args: (HTMLElement | string)[] = [];\r\n    \r\n    let editedSpan: HTMLElement, sponsoredSpan: HTMLElement, reactionsElement: ReactionsElement, reactionsMessage: Message.message;\r\n    \r\n    const isSponsored = !!(message as Message.message).pFlags.sponsored;\r\n    const isMessage = !('action' in message) && !isSponsored;\r\n    let hasReactions: boolean;\r\n    \r\n    let time: HTMLElement = isSponsored ? undefined : formatTime(date);\r\n    if(isMessage) {\r\n      if(message.views) {\r\n        const postAuthor = message.post_author || message.fwd_from?.post_author;\r\n  \r\n        const postViewsSpan = document.createElement('span');\r\n        postViewsSpan.classList.add('post-views');\r\n        postViewsSpan.innerHTML = formatNumber(message.views, 1);\r\n  \r\n        const channelViews = document.createElement('i');\r\n        channelViews.classList.add('tgico-channelviews', 'time-icon');\r\n  \r\n        args.push(postViewsSpan, channelViews);\r\n        if(postAuthor) {\r\n          const span = document.createElement('span');\r\n          setInnerHTML(span, wrapEmojiText(postAuthor));\r\n          span.insertAdjacentHTML('beforeend', ',' + NBSP)\r\n          args.push(span);\r\n        }\r\n      }\r\n\r\n      if(message.edit_date && chatType !== 'scheduled' && !message.pFlags.edit_hide) {\r\n        args.unshift(editedSpan = makeEdited());\r\n      }\r\n  \r\n      if(chatType !== 'pinned' && message.pFlags.pinned) {\r\n        const i = document.createElement('i');\r\n        i.classList.add('tgico-pinnedchat', 'time-icon');\r\n        args.unshift(i);\r\n      }\r\n\r\n      if(message.peer_id._ === 'peerUser'/*  && message.reactions?.results?.length */) {\r\n        hasReactions = true;\r\n\r\n        reactionsMessage = options.reactionsMessage;\r\n        reactionsElement = new ReactionsElement();\r\n        reactionsElement.init(reactionsMessage, 'inline', true);\r\n        reactionsElement.render();\r\n        args.unshift(reactionsElement);\r\n      }\r\n    } else if(isSponsored) {\r\n      args.push(sponsoredSpan = makeSponsored());\r\n    }\r\n    \r\n    if(time) {\r\n      args.push(time);\r\n    }\r\n\r\n    let title = isSponsored ? undefined : getFullDate(date);\r\n    if(isMessage) {\r\n      title += (message.edit_date && !message.pFlags.edit_hide ? `\\nEdited: ${getFullDate(new Date(message.edit_date * 1000))}` : '')\r\n        + (message.fwd_from ? `\\nOriginal: ${getFullDate(new Date(message.fwd_from.date * 1000))}` : '');\r\n    }\r\n\r\n    const timeSpan = document.createElement('span');\r\n    timeSpan.classList.add('time', 'tgico');\r\n    // if(title) timeSpan.title = title;\r\n    timeSpan.append(...args);\r\n\r\n    const inner = document.createElement('div');\r\n    inner.classList.add('inner', 'tgico');\r\n    if(title) inner.title = title;\r\n\r\n    let clonedArgs = args;\r\n    if(editedSpan) {\r\n      clonedArgs[clonedArgs.indexOf(editedSpan)] = makeEdited();\r\n    }\r\n    if(sponsoredSpan) {\r\n      clonedArgs[clonedArgs.indexOf(sponsoredSpan)] = makeSponsored();\r\n    }\r\n    if(reactionsElement) {\r\n      const _reactionsElement = clonedArgs[clonedArgs.indexOf(reactionsElement)] = new ReactionsElement();\r\n      _reactionsElement.init(reactionsMessage, 'inline');\r\n      _reactionsElement.render();\r\n    }\r\n    clonedArgs = clonedArgs.map((a) => a instanceof HTMLElement && !a.classList.contains('i18n') && !a.classList.contains('reactions') ? a.cloneNode(true) as HTMLElement : a);\r\n    if(time) {\r\n      clonedArgs[clonedArgs.length - 1] = formatTime(date); // clone time\r\n    }\r\n    inner.append(...clonedArgs);\r\n\r\n    timeSpan.append(inner);\r\n\r\n    return timeSpan;\r\n  };\r\n\r\n  export const renderReplies = ({bubble, bubbleContainer, message, messageDiv, loadPromises, lazyLoadQueue}: {\r\n    bubble: HTMLElement,\r\n    bubbleContainer: HTMLElement,\r\n    message: Message.message,\r\n    messageDiv: HTMLElement,\r\n    loadPromises?: Promise<any>[],\r\n    lazyLoadQueue?: LazyLoadQueue\r\n  }) => {\r\n    const isFooter = !bubble.classList.contains('sticker') && !bubble.classList.contains('emoji-big') && !bubble.classList.contains('round');\r\n    const repliesFooter = new RepliesElement();\r\n    repliesFooter.message = message;\r\n    repliesFooter.type = isFooter ? 'footer' : 'beside';\r\n    repliesFooter.loadPromises = loadPromises;\r\n    repliesFooter.lazyLoadQueue = lazyLoadQueue;\r\n    repliesFooter.init();\r\n    bubbleContainer.prepend(repliesFooter);\r\n    return isFooter;\r\n  };\r\n\r\n  export const setReply = async({chat, bubble, bubbleContainer, message}: {\r\n    chat: Chat,\r\n    bubble: HTMLElement,\r\n    bubbleContainer?: HTMLElement,\r\n    message: Message.message\r\n  }) => {\r\n    const isReplacing = !bubbleContainer;\r\n    if(isReplacing) {\r\n      bubbleContainer = bubble.querySelector('.bubble-content');\r\n    }\r\n\r\n    const currentReplyDiv = isReplacing ? bubbleContainer.querySelector('.reply') : null;\r\n    if(!message.reply_to_mid) {\r\n      if(currentReplyDiv) {\r\n        currentReplyDiv.remove();\r\n      }\r\n\r\n      bubble.classList.remove('is-reply');\r\n      return;\r\n    }\r\n\r\n\r\n    const replyToPeerId = message.reply_to.reply_to_peer_id ? getPeerId(message.reply_to.reply_to_peer_id) : chat.peerId;\r\n\r\n    let originalMessage = await rootScope.managers.appMessagesManager.getMessageByPeer(replyToPeerId, message.reply_to_mid);\r\n    let originalPeerTitle: string | HTMLElement;\r\n    \r\n    /////////this.log('message to render reply', originalMessage, originalPeerTitle, bubble, message);\r\n    \r\n    let titlePeerId: PeerId;\r\n    // need to download separately\r\n    if(!originalMessage) {\r\n      //////////this.log('message to render reply empty, need download', message, message.reply_to_mid);\r\n      rootScope.managers.appMessagesManager.fetchMessageReplyTo(message);\r\n      chat.bubbles.needUpdate.push({replyToPeerId, replyMid: message.reply_to_mid, mid: message.mid});\r\n      \r\n      originalPeerTitle = i18n('Loading');\r\n    } else {\r\n      const originalMessageFwdFromId = (originalMessage as Message.message).fwdFromId;\r\n      titlePeerId = message.fwdFromId && message.fwdFromId === originalMessageFwdFromId ? message.fwdFromId : originalMessage.fromId || originalMessageFwdFromId;\r\n      originalPeerTitle = new PeerTitle({\r\n        peerId: titlePeerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      }).element;\r\n    }\r\n\r\n    const {container, fillPromise} = wrapReply(originalPeerTitle, undefined, originalMessage, chat.isAnyGroup ? titlePeerId : undefined);\r\n    await fillPromise;\r\n    if(currentReplyDiv) {\r\n      currentReplyDiv.replaceWith(container);\r\n    } else {\r\n      bubbleContainer.append(container);\r\n    }\r\n    //bubbleContainer.insertBefore(, nameContainer);\r\n    bubble.classList.add('is-reply');\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\n\r\nexport function getElementByPoint(container: HTMLElement, verticalSide: 'top' | 'bottom', horizontalSide: 'center' | 'left'): HTMLElement {\r\n  //return null;\r\n  const rect = container.getBoundingClientRect();\r\n  const x = horizontalSide === 'center' ? Math.ceil(rect.left + ((rect.right - rect.left) / 2) + 1) : Math.ceil(rect.left + 1);\r\n  const y = verticalSide === 'bottom' ? Math.floor(rect.top + rect.height - 1) : Math.ceil(rect.top + 1);\r\n  return document.elementFromPoint(x, y) as any;\r\n};\r\n\r\nMOUNT_CLASS_TO.getElementByPoint = getElementByPoint;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function reflowScrollableElement(element: HTMLElement) {\r\n  element.style.display = 'none';\r\n  void element.offsetLeft; // reflow\r\n  element.style.display = '';\r\n}\r\n","export const SEND_WHEN_ONLINE_TIMESTAMP = 0x7FFFFFFE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getVisibleRect(\r\n  element: HTMLElement, \r\n  overflowElement: HTMLElement, \r\n  lookForSticky?: boolean, \r\n  rect = element.getBoundingClientRect(),\r\n  overflowRect = overflowElement.getBoundingClientRect()\r\n) {\r\n  let {top: overflowTop, right: overflowRight, bottom: overflowBottom, left: overflowLeft} = overflowRect;\r\n\r\n  // * respect sticky headers\r\n  if(lookForSticky) {\r\n    const sticky = overflowElement.querySelector('.sticky');\r\n    if(sticky) {\r\n      const stickyRect = sticky.getBoundingClientRect();\r\n      overflowTop = stickyRect.bottom;\r\n    }\r\n  }\r\n\r\n  if(rect.top >= overflowBottom\r\n    || rect.bottom <= overflowTop\r\n    || rect.right <= overflowLeft\r\n    || rect.left >= overflowRight) {\r\n    return null;\r\n  }\r\n\r\n  const overflow = {\r\n    top: false,\r\n    right: false,\r\n    bottom: false,\r\n    left: false,\r\n    vertical: 0 as 0 | 1 | 2,\r\n    horizontal: 0 as 0 | 1 | 2\r\n  };\r\n\r\n  // @ts-ignore\r\n  const w: any = 'visualViewport' in window ? window.visualViewport : window;\r\n  const windowWidth = w.width || w.innerWidth;\r\n  const windowHeight = w.height || w.innerHeight;\r\n\r\n  return {\r\n    rect: {\r\n      top: rect.top < overflowTop && overflowTop !== 0 ? (overflow.top = true, ++overflow.vertical, overflowTop) : rect.top,\r\n      right: rect.right > overflowRight && overflowRight !== windowWidth ? (overflow.right = true, ++overflow.horizontal, overflowRight) : rect.right,\r\n      bottom: rect.bottom > overflowBottom && overflowBottom !== windowHeight ? (overflow.bottom = true, ++overflow.vertical, overflowBottom) : rect.bottom,\r\n      left: rect.left < overflowLeft && overflowLeft !== 0 ? (overflow.left = true, ++overflow.horizontal, overflowLeft) : rect.left\r\n    },\r\n    overflow\r\n  };\r\n}\r\n\r\n(window as any).getVisibleRect = getVisibleRect;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport enum INTERNAL_LINK_TYPE {\r\n  MESSAGE,\r\n  PRIVATE_POST,\r\n  STICKER_SET,\r\n  JOIN_CHAT,\r\n  VOICE_CHAT,\r\n  USER_PHONE_NUMBER\r\n};\r\n\r\nexport type InternalLink = InternalLink.InternalLinkMessage | InternalLink.InternalLinkPrivatePost | InternalLink.InternalLinkStickerSet | InternalLink.InternalLinkJoinChat | InternalLink.InternalLinkVoiceChat | InternalLink.InternalLinkUserPhoneNumber;\r\n\r\nexport namespace InternalLink {\r\n  export interface InternalLinkMessage {\r\n    _: INTERNAL_LINK_TYPE.MESSAGE,\r\n    domain: string,\r\n    post?: string,\r\n    comment?: string,\r\n    start?: string\r\n  }\r\n\r\n  export interface InternalLinkPrivatePost {\r\n    _: INTERNAL_LINK_TYPE.PRIVATE_POST,\r\n    channel: string,\r\n    post: string,\r\n    thread?: string,\r\n    comment?: string\r\n  }\r\n\r\n  export interface InternalLinkStickerSet {\r\n    _: INTERNAL_LINK_TYPE.STICKER_SET,\r\n    set: string\r\n  }\r\n\r\n  export interface InternalLinkJoinChat {\r\n    _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n    invite: string\r\n  }\r\n\r\n  /**\r\n   * LOCAL LINK\r\n   */\r\n  export interface InternalLinkVoiceChat {\r\n    _: INTERNAL_LINK_TYPE.VOICE_CHAT,\r\n    id: string,\r\n    access_hash: string,\r\n    chat_id: string\r\n  }\r\n\r\n  export interface InternalLinkUserPhoneNumber {\r\n    _: INTERNAL_LINK_TYPE.USER_PHONE_NUMBER,\r\n    phone: string\r\n  }\r\n}\r\n\r\nexport type InternalLinkTypeMap = {\r\n  [INTERNAL_LINK_TYPE.MESSAGE]: InternalLink.InternalLinkMessage,\r\n  [INTERNAL_LINK_TYPE.PRIVATE_POST]: InternalLink.InternalLinkPrivatePost,\r\n  [INTERNAL_LINK_TYPE.STICKER_SET]: InternalLink.InternalLinkStickerSet,\r\n  [INTERNAL_LINK_TYPE.JOIN_CHAT]: InternalLink.InternalLinkJoinChat,\r\n  [INTERNAL_LINK_TYPE.VOICE_CHAT]: InternalLink.InternalLinkVoiceChat,\r\n  [INTERNAL_LINK_TYPE.USER_PHONE_NUMBER]: InternalLink.InternalLinkUserPhoneNumber\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport numberThousandSplitter from \"../../helpers/number/numberThousandSplitter\";\r\nimport { ChatInvite } from \"../../layer\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { i18n, _i18n } from \"../../lib/langPack\";\r\nimport { NULL_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport AvatarElement from \"../avatar\";\r\nimport putPhoto from \"../putPhoto\";\r\nimport { toastNew } from \"../toast\";\r\nimport { wrapPhoto } from \"../wrappers\";\r\n\r\n// const FAKE_CHAT_ID = Number.MAX_SAFE_INTEGER - 0x1000;\r\n\r\nexport default class PopupJoinChatInvite extends PopupElement {\r\n  constructor(\r\n    private hash: string, \r\n    private chatInvite: ChatInvite.chatInvite, \r\n  ) {\r\n    super('popup-join-chat-invite', addCancelButton([{\r\n      langKey: chatInvite.pFlags.request_needed ? 'RequestJoin.Button' : (chatInvite.pFlags.broadcast ? 'JoinByPeekChannelTitle' : 'JoinByPeekGroupTitle'),\r\n      callback: () => {\r\n        this.managers.appChatsManager.importChatInvite(hash)\r\n        .then((chatId) => {\r\n          const peerId = chatId.toPeerId(true);\r\n          appImManager.setInnerPeer({peerId});\r\n        }, (error) => {\r\n          if(error.type === 'INVITE_REQUEST_SENT') {\r\n            toastNew({langPackKey: 'RequestToJoinSent'});\r\n          }\r\n        });\r\n      }\r\n    }]), {closable: true, overlayClosable: true, body: true});\r\n\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    this.header.remove();\r\n    /* const fakeChat: Chat.channel | Chat.chat = {\r\n      _: chatInvite.pFlags.channel ? 'channel' : 'chat',\r\n      id: FAKE_CHAT_ID,\r\n      title: chatInvite.title,\r\n      photo: chatInvite.photo as any,\r\n      date: Date.now() / 1000 | 0,\r\n      version: 0,\r\n      participants_count: chatInvite.participants_count,\r\n      pFlags: chatInvite.pFlags as any\r\n    };\r\n\r\n    appChatsManager.saveApiChat(fakeChat); */\r\n\r\n    const {chatInvite, managers, hash} = this;\r\n    \r\n    const avatarElem = new AvatarElement();\r\n    avatarElem.classList.add('avatar-100');\r\n    avatarElem.isDialog = false;\r\n    if(chatInvite.photo._ === 'photo') {\r\n      chatInvite.photo = await managers.appPhotosManager.savePhoto(chatInvite.photo);\r\n      wrapPhoto({\r\n        container: avatarElem,\r\n        message: null,\r\n        photo: chatInvite.photo,\r\n        boxHeight: 100,\r\n        boxWidth: 100,\r\n        withoutPreloader: true\r\n      });\r\n      avatarElem.style.width = avatarElem.style.height = '';\r\n    } else {\r\n      putPhoto(avatarElem, NULL_PEER_ID, false, chatInvite.title);\r\n    }\r\n\r\n    const title = document.createElement('div');\r\n    title.classList.add('chat-title');\r\n    setInnerHTML(title, wrapEmojiText(chatInvite.title));\r\n    //avatarElem.setAttribute('peer', '' + -fakeChat.id);\r\n    \r\n    const isBroadcast = chatInvite.pFlags.broadcast;\r\n    const peopleCount = i18n(isBroadcast ? 'Subscribers' : 'Members', [numberThousandSplitter(chatInvite.participants_count)]);\r\n    peopleCount.classList.add('chat-participants-count');\r\n\r\n    this.body.append(avatarElem, title, peopleCount);\r\n\r\n    if(chatInvite.pFlags.request_needed) {\r\n      const caption = document.createElement('div');\r\n      _i18n(caption, isBroadcast ? 'RequestToJoinChannelDescription' : 'RequestToJoinGroupDescription');\r\n      caption.classList.add('chat-participants-count', 'request-caption');\r\n\r\n      this.body.append(caption);\r\n    }\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport { IS_SAFARI } from \"../environment/userAgent\";\r\nimport getVisibleRect from \"./dom/getVisibleRect\";\r\nimport reflowScrollableElement from \"./dom/reflowScrollableElement\";\r\n\r\nexport default class ScrollSaver {\r\n  private scrollHeight: number;\r\n  private scrollHeightMinusTop: number;\r\n  private scrollTop: number;\r\n  private clientHeight: number;\r\n  private elements: {element: HTMLElement, rect: DOMRect}[];\r\n\r\n  /**\r\n   * \r\n   * @param scrollable to reset scroll position and direction\r\n   * @param reverse true means top\r\n   */\r\n  constructor(\r\n    private scrollable: Scrollable, \r\n    private query: string, \r\n    private reverse: boolean\r\n  ) {\r\n\r\n  }\r\n\r\n  private get container() {\r\n    return this.scrollable.container;\r\n  }\r\n\r\n  public getSaved() {\r\n    return {\r\n      scrollHeight: this.scrollHeight, \r\n      scrollTop: this.scrollTop,\r\n      clientHeight: this.clientHeight\r\n    };\r\n  }\r\n\r\n  public findElements() {\r\n    const {container} = this;\r\n    const containerRect = container.getBoundingClientRect();\r\n    const bubbles = Array.from(container.querySelectorAll(this.query)) as HTMLElement[];\r\n    const elements: ScrollSaver['elements'] = [];\r\n    for(const bubble of bubbles) {\r\n      const elementRect = bubble.getBoundingClientRect();\r\n      const visibleRect = getVisibleRect(bubble, container, undefined, elementRect, containerRect);\r\n      if(visibleRect) {\r\n        elements.push({element: bubble, rect: elementRect});\r\n        // break; // find first\r\n      } else if(elements.length) { // find last\r\n        break;\r\n      }\r\n    }\r\n\r\n    if(!elements.length) {\r\n      const bubble = bubbles[0];\r\n      if(bubble) {\r\n        elements.push({element: bubble, rect: bubble.getBoundingClientRect()});\r\n      }\r\n    }\r\n\r\n    return elements;\r\n  }\r\n\r\n  public replaceSaved(from: HTMLElement, to: HTMLElement) {\r\n    if(!this.elements) {\r\n      return;\r\n    }\r\n\r\n    const idx = this.elements.findIndex(({element}) => from === element);\r\n    if(idx !== -1) {\r\n      this.elements[idx].element = to;\r\n    }\r\n  }\r\n\r\n  public findAndSetElements() {\r\n    this.elements = this.findElements();\r\n  }\r\n\r\n  public save() {\r\n    this.findAndSetElements();\r\n    // console.warn('scroll save', this.elements);\r\n    this._save();\r\n  }\r\n\r\n  public _save() {\r\n    const {scrollTop, scrollHeight, clientHeight} = this.container;\r\n\r\n    //previousScrollHeight = scrollHeight;\r\n    //previousScrollHeight = scrollHeight + padding;\r\n    this.scrollHeight = scrollHeight;\r\n    this.scrollTop = scrollTop;\r\n    this.clientHeight = clientHeight;\r\n    this.scrollHeightMinusTop = this.reverse ? scrollHeight - scrollTop : scrollTop;\r\n\r\n    //this.chatInner.style.paddingTop = padding + 'px';\r\n    /* if(reverse) {\r\n      previousScrollHeightMinusTop = this.scrollable.scrollHeight - scrollTop;\r\n    } else {\r\n      previousScrollHeightMinusTop = scrollTop;\r\n    } */\r\n  }\r\n\r\n  private onRestore(useReflow?: boolean) {\r\n    if(IS_SAFARI && useReflow/*  && !isAppleMobile */) { // * fix blinking and jumping\r\n      reflowScrollableElement(this.container);\r\n    }\r\n  }\r\n\r\n  private setScrollTop(newScrollTop: number, useReflow?: boolean) {\r\n    // touchSupport for safari iOS\r\n    //isTouchSupported && isApple && (container.container.style.overflow = 'hidden');\r\n    this.scrollable.setScrollTopSilently(this.scrollTop = newScrollTop);\r\n    //container.scrollTop = scrollHeight;\r\n    //isTouchSupported && isApple && (container.container.style.overflow = '');\r\n\r\n    this.onRestore(useReflow);\r\n  }\r\n\r\n  public restore(useReflow?: boolean) {\r\n    const {scrollTop, scrollHeight} = this.scrollable;\r\n    this.scrollHeight = scrollHeight;\r\n\r\n    let anchor: ScrollSaver['elements'][0];\r\n    // for(let i = this.elements.length - 1; i >= 0; --i) {\r\n    //   const _anchor = this.elements[i];\r\n    //   if(_anchor.element.parentElement) {\r\n    //     anchor = _anchor;\r\n    //     break;\r\n    //   }\r\n    // }\r\n    anchor = this.elements[this.elements.length - 1];\r\n    \r\n    if(!anchor?.element?.parentElement) { // try to find new anchor\r\n      this.findAndSetElements();\r\n      anchor = this.elements[this.elements.length - 1];\r\n\r\n      if(!anchor) { // fallback to old method if smth is really strange\r\n        this._restore(useReflow);\r\n        return;\r\n      }\r\n    }\r\n\r\n    const {element, rect} = anchor;\r\n    const newRect = element.getBoundingClientRect();\r\n    const diff = newRect.bottom - rect.bottom;\r\n    this.setScrollTop(scrollTop + diff, useReflow);\r\n    // if(diff) debugger;\r\n    // console.warn('scroll restore', rect, diff, newRect);\r\n  }\r\n\r\n  public _restore(useReflow?: boolean) {\r\n    const {scrollHeightMinusTop: previousScrollHeightMinusTop, scrollable} = this;\r\n    // if(previousScrollHeightMinusTop === undefined) {\r\n    //   throw new Error('scroll was not saved');\r\n    // }\r\n\r\n    // const scrollHeight = container.scrollHeight;\r\n    const scrollHeight = this.scrollHeight;\r\n    // if(scrollHeight === this.scrollHeight) {\r\n    //   return;\r\n    // }\r\n\r\n    // this.scrollHeight = scrollHeight;\r\n\r\n    /* const scrollHeight = container.scrollHeight;\r\n    const addedHeight = scrollHeight - previousScrollHeight;\r\n    \r\n    this.chatInner.style.paddingTop = (10000 - addedHeight) + 'px'; */\r\n    /* const scrollHeight = scrollHeight;\r\n    const addedHeight = scrollHeight - previousScrollHeight;\r\n    \r\n    this.chatInner.style.paddingTop = (padding - addedHeight) + 'px';\r\n    \r\n    //const newScrollTop = reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    const newScrollTop = reverse ? scrollHeight - addedHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    this.log('performHistoryResult: will set scrollTop', \r\n    previousScrollHeightMinusTop, scrollHeight, \r\n    newScrollTop, container.container.clientHeight); */\r\n    //const newScrollTop = reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    const newScrollTop = this.reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    \r\n    /* if(DEBUG) {\r\n      this.log('performHistoryResult: will set up scrollTop:', newScrollTop, this.isHeavyAnimationInProgress);\r\n    } */\r\n\r\n    this.setScrollTop(newScrollTop, useReflow);\r\n\r\n    /* if(DEBUG) {\r\n      this.log('performHistoryResult: have set up scrollTop:', newScrollTop, container.scrollTop, container.scrollHeight, this.isHeavyAnimationInProgress);\r\n    } */\r\n  }\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.ScrollSaver = ScrollSaver);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type IntersectionTarget = Element;\r\nexport type IntersectionCallback = (entry: IntersectionObserverEntry) => void;\r\n\r\nexport default class SuperIntersectionObserver {\r\n  private observing: Map<IntersectionTarget, Set<IntersectionCallback>>;\r\n  private observingQueue: SuperIntersectionObserver['observing'];\r\n  private observer: IntersectionObserver;\r\n  private freezedObservingNew: boolean;\r\n\r\n  constructor(init?: IntersectionObserverInit) {\r\n    this.observing = new Map();\r\n    this.observingQueue = new Map();\r\n    this.freezedObservingNew = false;\r\n\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      const observing = this.observing;\r\n      for(let i = 0, length = entries.length; i < length; ++i) {\r\n        const entry = entries[i];\r\n        const callbacks = observing.get(entry.target);\r\n        if(!callbacks) {\r\n          debugger;\r\n        }\r\n\r\n        for(const callback of callbacks) {\r\n          try {\r\n            callback(entry);\r\n          } catch(err) {\r\n            console.error('intersection process callback error:', err);\r\n          }\r\n        }\r\n      }\r\n    }, init);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.observing.clear();\r\n    this.observingQueue.clear();\r\n    this.observer.disconnect();\r\n  }\r\n\r\n  public toggleObservingNew(value: boolean) {\r\n    if(this.freezedObservingNew === value) {\r\n      return;\r\n    }\r\n\r\n    this.freezedObservingNew = value;\r\n\r\n    const queue = this.observingQueue;\r\n    if(!value && queue.size) {\r\n      for(const [target, callbacks] of queue) {\r\n        for(const callback of callbacks) {\r\n          this.observe(target, callback);\r\n        }\r\n      }\r\n\r\n      queue.clear();\r\n    }\r\n  }\r\n\r\n  public has(target: IntersectionTarget, callback: IntersectionCallback, observing = this.observing) {\r\n    const callbacks = observing.get(target);\r\n    return !!(callbacks && callbacks.has(callback));\r\n  }\r\n\r\n  public observe(target: IntersectionTarget, callback: IntersectionCallback) {\r\n    if(this.freezedObservingNew && this.has(target, callback)) {\r\n      return;\r\n    }\r\n\r\n    const observing = this.freezedObservingNew ? this.observingQueue : this.observing;\r\n    let callbacks = observing.get(target);\r\n    if(callbacks && callbacks.has(callback)) {\r\n      return;\r\n    }\r\n\r\n    if(!callbacks) {\r\n      callbacks = new Set();\r\n      observing.set(target, callbacks);\r\n\r\n      if(observing === this.observing) {\r\n        this.observer.observe(target);\r\n      }\r\n    }\r\n\r\n    callbacks.add(callback);\r\n  }\r\n\r\n  public unobserve(target: IntersectionTarget, callback: IntersectionCallback) {\r\n    const observing = this.freezedObservingNew && !this.has(target, callback) ? this.observingQueue : this.observing;\r\n    const callbacks = observing.get(target);\r\n    if(!callbacks) {\r\n      return;\r\n    }\r\n\r\n    callbacks.delete(callback);\r\n    if(!callbacks.size) {\r\n      observing.delete(target);\r\n      this.observer.unobserve(target);\r\n    }\r\n  }\r\n}\r\n","import type { MyDocument } from \"../../appDocsManager\";\r\nimport type { MyMessage } from \"../../appMessagesManager\";\r\nimport { Message, MessageMedia } from \"../../../../layer\";\r\n\r\nexport default function isMentionUnread(message: MyMessage) {\r\n  if(!message) {\r\n    return false;\r\n  }\r\n\r\n  const doc = ((message as Message.message).media as MessageMedia.messageMediaDocument)?.document as MyDocument;\r\n  return !!(\r\n    message.pFlags.media_unread && \r\n    message.pFlags.mentioned && \r\n    (\r\n      !doc || \r\n      !(['voice', 'round'] as MyDocument['type'][]).includes(doc.type)\r\n    )\r\n  );\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function middlewarePromise(middleware: () => boolean, throwWhat: any = '') {\r\n  return <T>(promise: T): T => {\r\n    if(!(promise instanceof Promise)) {\r\n      if(promise instanceof Error) {\r\n        throw promise;\r\n      } else {\r\n        return promise;\r\n      }\r\n    }\r\n\r\n    return (promise as any as Promise<any>).then((result) => {\r\n      if(!middleware()) {\r\n        throw throwWhat;\r\n      }\r\n\r\n      return result;\r\n    }) as any;\r\n  };\r\n}\r\n","import { MessageEntity } from \"../../layer\";\r\nimport { toCodePoints } from \"../../vendor/emoji\";\r\n\r\nexport default function getEmojiEntityFromEmoji(emoji: string): MessageEntity.messageEntityEmoji {\r\n  return {\r\n    _: 'messageEntityEmoji',\r\n    offset: 0,\r\n    length: emoji.length,\r\n    unicode: toCodePoints(emoji).join('-').replace(/-?fe0f/g, '')\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EmoticonsTab } from \"..\";\r\nimport cancelEvent from \"../../../helpers/dom/cancelEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { fastRaf } from \"../../../helpers/schedulers\";\r\nimport pause from \"../../../helpers/schedulers/pause\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { emojiFromCodePoints } from \"../../../vendor/emoji\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport Scrollable from \"../../scrollable\";\r\nimport StickyIntersector from \"../../stickyIntersector\";\r\nimport IS_EMOJI_SUPPORTED from \"../../../environment/emojiSupport\";\r\nimport IS_TOUCH_SUPPORTED from \"../../../environment/touchSupport\";\r\nimport blurActiveElement from \"../../../helpers/dom/blurActiveElement\";\r\nimport Emoji from \"../../../config/emoji\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport fixEmoji from \"../../../lib/richTextProcessor/fixEmoji\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapSingleEmoji from \"../../../lib/richTextProcessor/wrapSingleEmoji\";\r\n\r\nconst loadedURLs: Set<string> = new Set();\r\nexport function appendEmoji(emoji: string, container: HTMLElement, prepend = false, unify = false) {\r\n  //const emoji = details.unified;\r\n  //const emoji = (details.unified as string).split('-')\r\n  //.reduce((prev, curr) => prev + String.fromCodePoint(parseInt(curr, 16)), '');\r\n\r\n  const spanEmoji = document.createElement('span');\r\n  spanEmoji.classList.add('super-emoji');\r\n\r\n  let kek: DocumentFragment;\r\n  if(unify && !IS_EMOJI_SUPPORTED) {\r\n    kek = wrapSingleEmoji(emoji);\r\n  } else {\r\n    emoji = fixEmoji(emoji);\r\n    kek = wrapEmojiText(emoji);\r\n  }\r\n\r\n  /* if(!kek.includes('emoji')) {\r\n    console.log(emoji, kek, spanEmoji, emoji.length, new TextEncoder().encode(emoji), emojiUnicode(emoji));\r\n    return;\r\n  } */\r\n\r\n  //console.log(kek);\r\n\r\n  spanEmoji.append(kek);\r\n\r\n  if(spanEmoji.children.length > 1) {\r\n    const first = spanEmoji.firstElementChild;\r\n    spanEmoji.innerHTML = '';\r\n    spanEmoji.append(first);\r\n  }\r\n\r\n  if(spanEmoji.firstElementChild?.tagName === 'IMG') {\r\n    const image = spanEmoji.firstElementChild as HTMLImageElement;\r\n    \r\n    const url = image.src;\r\n    if(!loadedURLs.has(url)) {\r\n      image.setAttribute('loading', 'lazy');\r\n      const placeholder = document.createElement('span');\r\n      placeholder.classList.add('emoji-placeholder');\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        image.style.opacity = '0';\r\n        placeholder.style.opacity = '1';\r\n      }\r\n\r\n      image.addEventListener('load', () => {\r\n        fastRaf(() => {\r\n          if(rootScope.settings.animationsEnabled) {\r\n            image.style.opacity = '';\r\n            placeholder.style.opacity = '';\r\n          }\r\n\r\n          spanEmoji.classList.remove('empty');\r\n\r\n          loadedURLs.add(url);\r\n        });\r\n      }, {once: true});\r\n\r\n      spanEmoji.append(placeholder);\r\n    }\r\n  }\r\n\r\n  //spanEmoji = spanEmoji.firstElementChild as HTMLSpanElement;\r\n  //spanEmoji.setAttribute('emoji', emoji);\r\n  if(prepend) container.prepend(spanEmoji);\r\n  else container.appendChild(spanEmoji);\r\n}\r\n\r\nexport function getEmojiFromElement(element: HTMLElement) {\r\n  if(!findUpClassName(element, 'super-emoji')) return '';\r\n\r\n  if(element.nodeType === 3) return element.nodeValue;\r\n  if(element.tagName === 'SPAN' && !element.classList.contains('emoji') && element.firstElementChild) {\r\n    element = element.firstElementChild as HTMLElement;\r\n  }\r\n  \r\n  return element.getAttribute('alt') || element.innerText;\r\n}\r\n\r\nexport default class EmojiTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n\r\n  private recentItemsDiv: HTMLElement;\r\n\r\n  private scroll: Scrollable;\r\n  private stickyIntersector: StickyIntersector;\r\n  private menu: HTMLElement;\r\n\r\n  private closeScrollTop = 0;\r\n  private setMenuActive: (id: number) => boolean;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  init() {\r\n    this.content = document.getElementById('content-emoji') as HTMLDivElement;\r\n\r\n    const categories: LangPackKey[] = [\r\n      'Emoji.SmilesAndPeople', \r\n      'Emoji.AnimalsAndNature', \r\n      'Emoji.FoodAndDrink', \r\n      'Emoji.TravelAndPlaces', \r\n      'Emoji.ActivityAndSport', \r\n      'Emoji.Objects', \r\n      /* 'Emoji.Symbols',  */\r\n      'Emoji.Flags', \r\n      'Skin Tones' as any\r\n    ];\r\n    const divs: {\r\n      [category in LangPackKey]?: HTMLDivElement\r\n    } = {};\r\n\r\n    const sorted: Map<LangPackKey, string[]> = new Map([\r\n      [\r\n        'Emoji.Recent',\r\n        []\r\n      ]\r\n    ]);\r\n\r\n    for(const emoji in Emoji) {\r\n      const details = Emoji[emoji];\r\n      const i = '' + details;\r\n      const category = categories[+i[0] - 1];\r\n      if(!category) continue; // maybe it's skin tones\r\n\r\n      let s = sorted.get(category);\r\n      if(!s) {\r\n        s = [];\r\n        sorted.set(category, s);\r\n      }\r\n      \r\n      s[+i.slice(1) || 0] = emoji;\r\n    }\r\n\r\n    //console.log('emoticons sorted:', sorted);\r\n\r\n    //Object.keys(sorted).forEach((c) => sorted[c].sort((a, b) => a - b));\r\n\r\n    sorted.delete(categories.pop());\r\n\r\n    //console.time('emojiParse');\r\n    sorted.forEach((emojis, category) => {\r\n      const div = document.createElement('div');\r\n      div.classList.add('emoji-category');\r\n\r\n      const titleDiv = document.createElement('div');\r\n      titleDiv.classList.add('category-title');\r\n      titleDiv.append(i18n(category));\r\n\r\n      const itemsDiv = document.createElement('div');\r\n      itemsDiv.classList.add('super-emojis');\r\n\r\n      div.append(titleDiv, itemsDiv);\r\n\r\n      emojis.forEach((unified) => {\r\n        /* if(emojiUnicode(emoji) === '1f481-200d-2642') {\r\n          console.log('append emoji', emoji, emojiUnicode(emoji));\r\n        } */\r\n\r\n        let emoji = emojiFromCodePoints(unified);\r\n        //if(emoji.includes('🕵')) {\r\n          //console.log('toCodePoints', toCodePoints(emoji));\r\n          //emoji = emoji.replace(/(\\u200d[\\u2640\\u2642\\u2695])(?!\\ufe0f)/, '\\ufe0f$1');\r\n          // const zwjIndex = emoji.indexOf('\\u200d');\r\n          // if(zwjIndex !== -1 && !emoji.includes('\\ufe0f')) {\r\n          //   /* if(zwjIndex !== (emoji.length - 1)) {\r\n          //     emoji = emoji.replace(/(\\u200d)/g, '\\ufe0f$1');\r\n          //   } */\r\n\r\n          //   emoji += '\\ufe0f';\r\n          //   //emoji += '\\ufe0f';\r\n          // }\r\n\r\n          //debugger;\r\n        //}\r\n\r\n        appendEmoji(emoji/* .replace(/[\\ufe0f\\u2640\\u2642\\u2695]/g, '') */, itemsDiv, false/* , false */);\r\n\r\n        /* if(category === 'Smileys & Emotion') {\r\n          console.log('appended emoji', emoji, itemsDiv.children[itemsDiv.childElementCount - 1].innerHTML, emojiUnicode(emoji));\r\n        } */\r\n      });\r\n\r\n      divs[category] = div;\r\n    });\r\n\r\n    //console.timeEnd('emojiParse');\r\n\r\n    const menu = this.menu = this.content.previousElementSibling as HTMLElement;\r\n    const emojiScroll = this.scroll = new Scrollable(this.content, 'EMOJI');\r\n\r\n    //emojiScroll.setVirtualContainer(emojiScroll.container);\r\n\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    Promise.all([\r\n      pause(200),\r\n      this.managers.appEmojiManager.getRecentEmojis().then((recent) => {\r\n        const hasRecent = !!recent.length;\r\n        const activeId = hasRecent ? 0 : 1;\r\n        this.menu.children[0].classList.toggle('hide', !hasRecent);\r\n        this.menu.children[activeId].classList.add('active');\r\n        const m = EmoticonsDropdown.menuOnClick(menu, emojiScroll, undefined, activeId);\r\n        this.stickyIntersector = m.stickyIntersector;\r\n        this.setMenuActive = m.setActive;\r\n        return recent;\r\n      })\r\n    ]).then(([_, recent]) => {\r\n      preloader.remove();\r\n\r\n      this.recentItemsDiv = divs['Emoji.Recent'].querySelector('.super-emojis');\r\n      for(const emoji of recent) {\r\n        appendEmoji(emoji, this.recentItemsDiv);\r\n      }\r\n\r\n      this.recentItemsDiv.parentElement.classList.toggle('hide', !this.recentItemsDiv.childElementCount);\r\n\r\n      categories.unshift('Emoji.Recent');\r\n      categories.map((category) => {\r\n        const div = divs[category];\r\n  \r\n        if(!div) {\r\n          console.error('no div by category:', category);\r\n        }\r\n  \r\n        emojiScroll.container.append(div);\r\n        this.stickyIntersector.observeStickyHeaderChanges(div);\r\n        return div;\r\n      });\r\n    });\r\n\r\n    this.content.addEventListener('click', this.onContentClick);\r\n    this.init = null;\r\n\r\n    rootScope.addEventListener('emoji_recent', (emoji) => {\r\n      const children = Array.from(this.recentItemsDiv.children) as HTMLElement[];\r\n      for(let i = 0, length = children.length; i < length; ++i) {\r\n        const el = children[i];\r\n        const _emoji = fixEmoji(getEmojiFromElement(el));\r\n        if(emoji === _emoji) {\r\n          if(i === 0) {\r\n            return;\r\n          }\r\n\r\n          el.remove();\r\n        }\r\n      }\r\n\r\n      appendEmoji(emoji, this.recentItemsDiv, true);\r\n      this.recentItemsDiv.parentElement.classList.remove('hide');\r\n      this.menu.children[0].classList.remove('hide');\r\n\r\n      if(!this.closeScrollTop) {\r\n        this.setMenuActive(0);\r\n      }\r\n    });\r\n\r\n    emoticonsDropdown.addEventListener('close', () => {\r\n      this.closeScrollTop = this.scroll.scrollTop;\r\n    });\r\n  }\r\n\r\n  onContentClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    \r\n    const emoji = getEmojiFromElement(e.target as HTMLElement);\r\n    if(!emoji) {\r\n      return;\r\n    }\r\n\r\n    appImManager.chat.input.onEmojiSelected(emoji, false);\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      blurActiveElement();\r\n    }\r\n  };\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getEmojiEntityFromEmoji from \"./getEmojiEntityFromEmoji\";\r\nimport wrapRichText from \"./wrapRichText\";\r\n\r\nexport default function wrapSingleEmoji(emoji: string) {\r\n  return wrapRichText(emoji, {\r\n    entities: [getEmojiEntityFromEmoji(emoji)]\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueIntersector from \"./lazyLoadQueueIntersector\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"./visibilityIntersector\";\r\n\r\nexport default class LazyLoadQueueRepeat2 extends LazyLoadQueueIntersector {\r\n  constructor(parallelLimit?: number, protected onVisibilityChange?: OnVisibilityChange) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((target, visible) => {\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible && spliced.length) {\r\n        spliced.forEach((item) => {\r\n          this.queue.unshift(item);\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(target, visible);\r\n      this.setProcessQueueTimeout();\r\n    });\r\n  }\r\n\r\n  public observe(el: HTMLElement) {\r\n    this.intersector.observe(el);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { wrapVideo } from \"./wrappers\";\r\nimport animationIntersector from \"./animationIntersector\";\r\nimport Scrollable from \"./scrollable\";\r\nimport deferredPromise, { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport renderImageFromUrl from \"../helpers/dom/renderImageFromUrl\";\r\nimport calcImageInBox from \"../helpers/calcImageInBox\";\r\nimport { doubleRaf } from \"../helpers/schedulers\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport LazyLoadQueueRepeat2 from \"./lazyLoadQueueRepeat2\";\r\n\r\nconst width = 400;\r\nconst maxSingleWidth = width - 100;\r\nconst height = 100;\r\n\r\nexport default class GifsMasonry {\r\n  public lazyLoadQueue: LazyLoadQueueRepeat2;\r\n  private scrollPromise: CancellablePromise<void> = Promise.resolve();\r\n  private timeout: number = 0;\r\n  private managers: AppManagers;\r\n\r\n  constructor(\r\n    private element: HTMLElement, \r\n    private group: string, \r\n    private scrollable: Scrollable, \r\n    attach = true\r\n  ) {\r\n    this.managers = rootScope.managers;\r\n\r\n    this.lazyLoadQueue = new LazyLoadQueueRepeat2(undefined, (target, visible) => {\r\n      if(visible) {\r\n        this.processVisibleDiv(target);\r\n      } else {\r\n        this.processInvisibleDiv(target);\r\n      }\r\n    });\r\n\r\n    /* setInterval(() => {\r\n      // @ts-ignore\r\n      const players = animationIntersector.byGroups[group];\r\n\r\n      if(players) {\r\n        console.log(`GIFS RENDERED IN ${group}:`, players.length, players.filter((p) => !p.animation.paused).length, this.lazyLoadQueue.intersector.getVisible().length);\r\n      }\r\n    }, .25e3); */\r\n\r\n    if(attach) {\r\n      this.attach();\r\n    }\r\n  }\r\n  \r\n  private onScroll = () => {\r\n    if(this.timeout) {\r\n      clearTimeout(this.timeout);\r\n    } else {\r\n      this.scrollPromise = deferredPromise<void>();\r\n      //animationIntersector.checkAnimations(true, group);\r\n    }\r\n\r\n    this.timeout = window.setTimeout(() => {\r\n      this.timeout = 0;\r\n      this.scrollPromise.resolve();\r\n      //animationIntersector.checkAnimations(false, group);\r\n    }, 150);\r\n  };\r\n\r\n  public attach() {\r\n    this.scrollable.container.addEventListener('scroll', this.onScroll);\r\n  }\r\n\r\n  public detach() {\r\n    this.clear();\r\n    this.scrollable.container.removeEventListener('scroll', this.onScroll);\r\n  }\r\n\r\n  public clear() {\r\n    this.lazyLoadQueue.clear();\r\n  }\r\n\r\n  private processVisibleDiv(div: HTMLElement) {\r\n    const video = div.querySelector('video');\r\n    if(video) {\r\n      return;\r\n    }\r\n\r\n    //console.log('processVisibleDiv');\r\n\r\n    const load = () => {\r\n      const docId = div.dataset.docId;\r\n      const promise = Promise.all([this.managers.appDocsManager.getDoc(docId), this.scrollPromise]).then(async([doc]) => {\r\n        const res = await wrapVideo({\r\n          doc,\r\n          container: div as HTMLDivElement,\r\n          lazyLoadQueue: null,\r\n          //lazyLoadQueue: EmoticonsDropdown.lazyLoadQueue,\r\n          group: this.group,\r\n          noInfo: true,\r\n        });\r\n    \r\n        const promise = res.loadPromise;\r\n        promise.finally(() => {\r\n          const video = div.querySelector('video');\r\n\r\n          div.style.opacity = '';\r\n          const img = div.querySelector('img');\r\n          img && img.classList.add('hide');\r\n\r\n          if(video && !video.parentElement) {\r\n            setTimeout(() => {\r\n              video.src = '';\r\n              video.load();\r\n              const animations = animationIntersector.getAnimations(video);\r\n              animations.forEach((item) => {\r\n                animationIntersector.checkAnimation(item, true, true);\r\n              });\r\n            }, 0);\r\n          }\r\n\r\n          //clearTimeout(timeout);\r\n          if(!this.lazyLoadQueue.intersector.isVisible(div)) {\r\n            this.processInvisibleDiv(div);\r\n          }\r\n        });\r\n\r\n        return promise;\r\n      });\r\n\r\n      /* let timeout = window.setTimeout(() => {\r\n        console.error('processVisibleDiv timeout', div, doc);\r\n      }, 1e3); */\r\n\r\n      return promise;\r\n    };\r\n\r\n    //return load();\r\n    \r\n    this.lazyLoadQueue.push({div, load});\r\n  }\r\n\r\n  public processInvisibleDiv = (div: HTMLElement) => {\r\n    return this.scrollPromise.then(async() => {\r\n      //return;\r\n\r\n      if(this.lazyLoadQueue.intersector.isVisible(div)) {\r\n        return;\r\n      }\r\n\r\n      const video = div.querySelector('video');\r\n      const img = div.querySelector('img');\r\n  \r\n      if(img) {\r\n        img && img.classList.remove('hide');\r\n  \r\n        await doubleRaf();\r\n      }\r\n\r\n      if(this.lazyLoadQueue.intersector.isVisible(div)) {\r\n        return;\r\n      }\r\n  \r\n      if(video) {\r\n        video.remove();\r\n        video.src = '';\r\n        video.load();\r\n        const animations = animationIntersector.getAnimations(video);\r\n        animations.forEach((item) => {\r\n          animationIntersector.checkAnimation(item, true, true);\r\n        });\r\n      }\r\n    });\r\n  };\r\n\r\n  public add(doc: MyDocument, appendTo = this.element) {\r\n    let gifWidth = doc.w;\r\n    let gifHeight = doc.h;\r\n    if(gifHeight < height) {\r\n      gifWidth = height / gifHeight * gifWidth;\r\n      gifHeight = height;\r\n    }\r\n\r\n    const willUseWidth = Math.min(maxSingleWidth, width, gifWidth);\r\n    const size = calcImageInBox(gifWidth, gifHeight, willUseWidth, height);\r\n\r\n    /* wastedWidth += w;\r\n\r\n    if(wastedWidth === width || h < height) {\r\n      wastedWidth = 0;\r\n      console.log('completed line', i, line);\r\n      line = [];\r\n      continue;\r\n    }\r\n\r\n    line.push(gif); */\r\n\r\n    //console.log('gif:', gif, w, h);\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('gif', 'fade-in-transition');\r\n    div.style.width = size.width + 'px';\r\n    div.style.opacity = '0';\r\n    //div.style.height = h + 'px';\r\n    div.dataset.docId = '' + doc.id;\r\n\r\n    appendTo.append(div);\r\n\r\n    //this.lazyLoadQueue.observe({div, load: this.processVisibleDiv});\r\n    this.lazyLoadQueue.observe(div);\r\n\r\n    //let preloader = new ProgressivePreloader(div);\r\n\r\n    // const gotThumb = this.managers.appDocsManager.getThumb(doc, false);\r\n\r\n    // const willBeAPoster = !!gotThumb;\r\n    // let img: HTMLImageElement;\r\n    // if(willBeAPoster) {\r\n    //   img = new Image();\r\n    //   img.classList.add('media-poster');\r\n\r\n    //   if(!gotThumb.cacheContext.url) {\r\n    //     gotThumb.promise.then(() => {\r\n    //       img.src = gotThumb.cacheContext.url;\r\n    //     });\r\n    //   }\r\n    // }\r\n\r\n    // const afterRender = () => {\r\n    //   if(img) {\r\n    //     div.append(img);\r\n    //     div.style.opacity = '';\r\n    //   }\r\n    // };\r\n\r\n    // (gotThumb?.cacheContext?.url ? renderImageFromUrl(img, gotThumb.cacheContext.url, afterRender) : afterRender());\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EmoticonsTab, EMOTICONSSTICKERGROUP } from \"..\";\r\nimport GifsMasonry from \"../../gifsMasonry\";\r\nimport Scrollable from \"../../scrollable\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\n\r\nexport default class GifsTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  init() {\r\n    this.content = document.getElementById('content-gifs');\r\n    const gifsContainer = this.content.firstElementChild as HTMLDivElement;\r\n    gifsContainer.addEventListener('click', EmoticonsDropdown.onMediaClick);\r\n\r\n    const scroll = new Scrollable(this.content, 'GIFS');\r\n    const masonry = new GifsMasonry(gifsContainer, EMOTICONSSTICKERGROUP, scroll);\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    this.managers.appDocsManager.getGifs().then((docs) => {\r\n      docs.forEach((doc) => {\r\n        masonry.add(doc);\r\n      });\r\n\r\n      preloader.remove();\r\n    });\r\n\r\n    emoticonsDropdown.addLazyLoadQueueRepeat(masonry.lazyLoadQueue, masonry.processInvisibleDiv);\r\n\r\n    this.init = null;\r\n  }\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueIntersector, { LazyLoadElement } from \"./lazyLoadQueueIntersector\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"./visibilityIntersector\";\r\n\r\nexport default class LazyLoadQueueRepeat extends LazyLoadQueueIntersector {\r\n  private _queue: Map<HTMLElement, LazyLoadElement> = new Map();\r\n\r\n  constructor(parallelLimit?: number, protected onVisibilityChange?: OnVisibilityChange) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((target, visible) => {\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible) {\r\n        const items = spliced.length ? spliced : [this._queue.get(target)];\r\n        items.forEach((item) => {\r\n          this.queue.unshift(item || this._queue.get(target));\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(target, visible);\r\n      this.setProcessQueueTimeout();\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this._queue.clear();\r\n  }\r\n\r\n  /* public async processItem(item: LazyLoadElement) {\r\n    //await super.processItem(item);\r\n    await LazyLoadQueueBase.prototype.processItem.call(this, item);\r\n\r\n    if(this.lazyLoadMedia.length) {\r\n      this.processQueue();\r\n    }\r\n  } */\r\n\r\n  public observe(el: LazyLoadElement) {\r\n    this._queue.set(el.div, el);\r\n    this.intersector.observe(el.div);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EMOTICONSSTICKERGROUP, EmoticonsTab } from \"..\";\r\nimport findUpAttribute from \"../../../helpers/dom/findUpAttribute\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport mediaSizes from \"../../../helpers/mediaSizes\";\r\nimport { MessagesAllStickers, StickerSet } from \"../../../layer\";\r\nimport { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport LazyLoadQueueRepeat from \"../../lazyLoadQueueRepeat\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport Scrollable, { ScrollableX } from \"../../scrollable\";\r\nimport StickyIntersector from \"../../stickyIntersector\";\r\nimport { wrapSticker, wrapStickerSetThumb } from \"../../wrappers\";\r\n\r\nexport class SuperStickerRenderer {\r\n  public lazyLoadQueue: LazyLoadQueueRepeat;\r\n  private animatedDivs: Set<HTMLDivElement> = new Set();\r\n\r\n  constructor(\r\n    private regularLazyLoadQueue: LazyLoadQueue, \r\n    private group: string,\r\n    private managers: AppManagers\r\n  ) {\r\n    this.lazyLoadQueue = new LazyLoadQueueRepeat(undefined, (target, visible) => {\r\n      if(!visible) {\r\n        this.processInvisibleDiv(target as HTMLDivElement);\r\n      }\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    this.lazyLoadQueue.clear();\r\n  }\r\n\r\n  public renderSticker(doc: MyDocument, div?: HTMLDivElement, loadPromises?: Promise<any>[]) {\r\n    if(!div) {\r\n      div = document.createElement('div');\r\n      div.classList.add('grid-item', 'super-sticker');\r\n\r\n      if(doc.animated) {\r\n        this.observeAnimatedDiv(div);\r\n      }\r\n    }\r\n\r\n    // * This will wrap only a thumb\r\n    wrapSticker({\r\n      doc, \r\n      div,\r\n      lazyLoadQueue: this.regularLazyLoadQueue, \r\n      group: this.group, \r\n      onlyThumb: doc.animated,\r\n      loadPromises\r\n    });\r\n\r\n    return div;\r\n  }\r\n\r\n  public observeAnimatedDiv(div: HTMLDivElement) {\r\n    this.animatedDivs.add(div);\r\n\r\n    this.lazyLoadQueue.observe({\r\n      div, \r\n      load: this.processVisibleDiv\r\n    });\r\n  }\r\n\r\n  private checkAnimationContainer = (div: HTMLElement, visible: boolean) => {\r\n    //console.error('checkAnimationContainer', div, visible);\r\n    const players = animationIntersector.getAnimations(div);\r\n    players.forEach((player) => {\r\n      if(!visible) {\r\n        animationIntersector.checkAnimation(player, true, true);\r\n      } else {\r\n        animationIntersector.checkAnimation(player, false);\r\n      }\r\n    });\r\n  };\r\n\r\n  private processVisibleDiv = async(div: HTMLElement) => {\r\n    const docId = div.dataset.docId;\r\n    const doc = await this.managers.appDocsManager.getDoc(docId);\r\n    \r\n    const size = mediaSizes.active.esgSticker.width;\r\n\r\n    //console.log('processVisibleDiv:', div);\r\n\r\n    const promise = wrapSticker({\r\n      doc, \r\n      div: div as HTMLDivElement,\r\n      width: size,\r\n      height: size,\r\n      lazyLoadQueue: null, \r\n      group: this.group, \r\n      onlyThumb: false,\r\n      play: true,\r\n      loop: true\r\n    }).then(({render}) => render);\r\n\r\n    promise.then(() => {\r\n      //clearTimeout(timeout);\r\n      this.checkAnimationContainer(div, this.lazyLoadQueue.intersector.isVisible(div));\r\n    });\r\n\r\n    /* let timeout = window.setTimeout(() => {\r\n      console.error('processVisibleDiv timeout', div, doc);\r\n    }, 1e3); */\r\n\r\n    return promise;\r\n  };\r\n\r\n  public processInvisibleDiv = async(div: HTMLElement) => {\r\n    const docId = div.dataset.docId;\r\n    const doc = await this.managers.appDocsManager.getDoc(docId);\r\n\r\n    //console.log('STICKER INvisible:', /* div,  */docId);\r\n\r\n    this.checkAnimationContainer(div, false);\r\n\r\n    div.innerHTML = '';\r\n    this.renderSticker(doc, div as HTMLDivElement);\r\n  };\r\n}\r\n\r\nexport default class StickersTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n  private stickersDiv: HTMLElement;\r\n\r\n  private stickerSets: {[id: string]: {\r\n    stickers: HTMLElement,\r\n    tab: HTMLElement\r\n  }} = {};\r\n\r\n  private recentDiv: HTMLElement;\r\n  private recentStickers: MyDocument[] = [];\r\n\r\n  private scroll: Scrollable;\r\n\r\n  private menu: HTMLElement;\r\n  \r\n  private mounted = false;\r\n\r\n  private queueCategoryPush: {element: HTMLElement, prepend: boolean}[] = [];\r\n\r\n  private stickyIntersector: StickyIntersector;\r\n\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  categoryPush(categoryDiv: HTMLElement, categoryTitle: DocumentFragment | string = '', promise: Promise<MyDocument[]>, prepend?: boolean) {\r\n    //if((docs.length % 5) !== 0) categoryDiv.classList.add('not-full');\r\n\r\n    const itemsDiv = document.createElement('div');\r\n    itemsDiv.classList.add('category-items', 'super-stickers');\r\n\r\n    const titleDiv = document.createElement('div');\r\n    titleDiv.classList.add('category-title');\r\n\r\n    if(categoryTitle) {\r\n      if(typeof(categoryTitle) === 'string') titleDiv.innerHTML = categoryTitle;\r\n      else titleDiv.append(categoryTitle);\r\n    }\r\n\r\n    categoryDiv.append(titleDiv, itemsDiv);\r\n\r\n    this.stickyIntersector.observeStickyHeaderChanges(categoryDiv);\r\n\r\n    this.queueCategoryPush.push({element: categoryDiv, prepend});\r\n\r\n    promise.then((documents) => {\r\n      documents.forEach((doc) => {\r\n        //if(doc._ === 'documentEmpty') return;\r\n        itemsDiv.append(this.superStickerRenderer.renderSticker(doc));\r\n      });\r\n\r\n      if(this.queueCategoryPush.length) {\r\n        this.queueCategoryPush.forEach(({element, prepend}) => {\r\n          if(prepend) {\r\n            if(this.recentDiv.parentElement) {\r\n              this.stickersDiv.prepend(element);\r\n              this.stickersDiv.prepend(this.recentDiv);\r\n            } else {\r\n              this.stickersDiv.prepend(element);\r\n            }\r\n          } else this.stickersDiv.append(element);\r\n        });\r\n\r\n        this.queueCategoryPush.length = 0;\r\n      }\r\n    });\r\n\r\n    return {titleDiv};\r\n  }\r\n\r\n  async renderStickerSet(set: StickerSet.stickerSet, prepend = false) {\r\n    const categoryDiv = document.createElement('div');\r\n    categoryDiv.classList.add('sticker-category');\r\n    categoryDiv.dataset.id = '' + set.id;\r\n    categoryDiv.dataset.access_hash = '' + set.access_hash;\r\n\r\n    const button = document.createElement('button');\r\n    button.classList.add('btn-icon', 'menu-horizontal-div-item');\r\n\r\n    this.stickerSets[set.id] = {\r\n      stickers: categoryDiv,\r\n      tab: button\r\n    };\r\n\r\n    if(prepend) {\r\n      this.menu.insertBefore(button, this.menu.firstElementChild.nextSibling);\r\n    } else {\r\n      this.menu.append(button);\r\n    }\r\n\r\n    //stickersScroll.append(categoryDiv);\r\n\r\n    const promise = this.managers.appStickersManager.getStickerSet(set);\r\n    this.categoryPush(categoryDiv, wrapEmojiText(set.title), promise.then((stickerSet) => stickerSet.documents as MyDocument[]), prepend);\r\n    const stickerSet = await promise;\r\n\r\n    //console.log('got stickerSet', stickerSet, li);\r\n    \r\n    wrapStickerSetThumb({\r\n      set,\r\n      container: button,\r\n      group: EMOTICONSSTICKERGROUP,\r\n      lazyLoadQueue: EmoticonsDropdown.lazyLoadQueue,\r\n      width: 32,\r\n      height: 32,\r\n      autoplay: false\r\n    });\r\n  }\r\n\r\n  init() {\r\n    this.content = document.getElementById('content-stickers');\r\n    //let stickersDiv = contentStickersDiv.querySelector('.os-content') as HTMLDivElement;\r\n\r\n    this.recentDiv = document.createElement('div');\r\n    this.recentDiv.classList.add('sticker-category', 'stickers-recent');\r\n\r\n    let menuWrapper = this.content.previousElementSibling as HTMLDivElement;\r\n    this.menu = menuWrapper.firstElementChild as HTMLUListElement;\r\n\r\n    let menuScroll = new ScrollableX(menuWrapper);\r\n\r\n    this.stickersDiv = document.createElement('div');\r\n    this.stickersDiv.classList.add('stickers-categories');\r\n    this.content.append(this.stickersDiv);\r\n\r\n    /* stickersDiv.addEventListener('mouseover', (e) => {\r\n      let target = e.target as HTMLElement;\r\n\r\n      if(target.tagName === 'CANVAS') { // turn on sticker\r\n        let animation = lottieLoader.getAnimation(target.parentElement, EMOTICONSSTICKERGROUP);\r\n\r\n        if(animation) {\r\n          // @ts-ignore\r\n          if(animation.currentFrame === animation.totalFrames - 1) {\r\n            animation.goToAndPlay(0, true);\r\n          } else {\r\n            animation.play();\r\n          }\r\n        }\r\n      }\r\n    }); */\r\n\r\n    rootScope.addEventListener('stickers_installed', (e) => {\r\n      const set: StickerSet.stickerSet = e;\r\n      \r\n      if(!this.stickerSets[set.id] && this.mounted) {\r\n        this.renderStickerSet(set, true);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('stickers_deleted', (e) => {\r\n      const set: StickerSet.stickerSet = e;\r\n      \r\n      if(this.stickerSets[set.id] && this.mounted) {\r\n        const elements = this.stickerSets[set.id];\r\n        elements.stickers.remove();\r\n        elements.tab.remove();\r\n        delete this.stickerSets[set.id];\r\n      }\r\n    });\r\n\r\n    this.stickersDiv.addEventListener('click', (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if(findUpClassName(target, 'category-title')) {\r\n        const el = findUpAttribute(target, 'data-id');\r\n        new PopupStickers({id: el.dataset.id, access_hash: el.dataset.access_hash}).show();\r\n        return;\r\n      }\r\n\r\n      EmoticonsDropdown.onMediaClick(e);\r\n    });\r\n\r\n    const setTyping = (cancel = false) => {\r\n      rootScope.dispatchEvent('choosing_sticker', !cancel);\r\n    };\r\n\r\n    this.scroll = new Scrollable(this.content, 'STICKERS');\r\n    this.scroll.setVirtualContainer(this.stickersDiv);\r\n    this.scroll.onAdditionalScroll = () => {\r\n      setTyping();\r\n    };\r\n\r\n    emoticonsDropdown.addEventListener('closed', () => {\r\n      setTyping(true);\r\n    });\r\n\r\n    emoticonsDropdown.addEventListener('opened', () => {\r\n      setTyping();\r\n    });\r\n\r\n    this.stickyIntersector = EmoticonsDropdown.menuOnClick(this.menu, this.scroll, menuScroll).stickyIntersector;\r\n\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    Promise.all([\r\n      this.managers.appStickersManager.getRecentStickers().then((stickers) => {\r\n        this.recentStickers = stickers.stickers.slice(0, 20) as MyDocument[];\r\n  \r\n        //stickersScroll.prepend(categoryDiv);\r\n\r\n        this.stickerSets['recent'] = {\r\n          stickers: this.recentDiv,\r\n          tab: this.menu.firstElementChild as HTMLElement\r\n        };\r\n\r\n        preloader.remove();\r\n        const {titleDiv} = this.categoryPush(this.recentDiv, '', Promise.resolve(this.recentStickers), true);\r\n        titleDiv.append(i18n('Stickers.Recent'));\r\n      }),\r\n\r\n      this.managers.appStickersManager.getAllStickers().then((res) => {\r\n        preloader.remove();\r\n\r\n        for(let set of (res as MessagesAllStickers.messagesAllStickers).sets) {\r\n          this.renderStickerSet(set);\r\n        }\r\n      })\r\n    ]).finally(() => {\r\n      this.mounted = true;\r\n      setTyping();\r\n    });\r\n\r\n    this.superStickerRenderer = new SuperStickerRenderer(EmoticonsDropdown.lazyLoadQueue, EMOTICONSSTICKERGROUP, this.managers);\r\n\r\n    emoticonsDropdown.addLazyLoadQueueRepeat(this.superStickerRenderer.lazyLoadQueue, this.superStickerRenderer.processInvisibleDiv);\r\n\r\n    /* setInterval(() => {\r\n      // @ts-ignore\r\n      const players = Object.values(lottieLoader.players).filter((p) => p.width === 80);\r\n      \r\n      console.log('STICKERS RENDERED IN PANEL:', players.length, players.filter((p) => !p.paused).length, this.superStickerRenderer.lazyLoadQueue.intersector.getVisible().length);\r\n    }, .25e3); */\r\n    \r\n\r\n    this.init = null;\r\n  }\r\n\r\n  pushRecentSticker(doc: MyDocument) {\r\n    this.managers.appStickersManager.pushRecentSticker(doc);\r\n    \r\n    if(!this.recentDiv?.parentElement) {\r\n      return;\r\n    }\r\n\r\n    let div = this.recentDiv.querySelector(`[data-doc-id=\"${doc.id}\"]`);\r\n    if(!div) {\r\n      div = this.superStickerRenderer.renderSticker(doc);\r\n    }\r\n\r\n    const items = this.recentDiv.querySelector('.category-items');\r\n    items.prepend(div);\r\n\r\n    if(items.childElementCount > 20) {\r\n      (Array.from(items.children) as HTMLElement[]).slice(20).forEach((el) => el.remove());\r\n    }\r\n  }\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport appSidebarRight from \"..\";\r\nimport { AppInlineBotsManager } from \"../../../lib/appManagers/appInlineBotsManager\";\r\nimport GifsMasonry from \"../../gifsMasonry\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport type { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport mediaSizes from \"../../../helpers/mediaSizes\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport { NULL_PEER_ID } from \"../../../lib/mtproto/mtproto_config\";\r\n\r\nconst ANIMATIONGROUP = 'GIFS-SEARCH';\r\n\r\nexport default class AppGifsTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private gifsDiv: HTMLDivElement;\r\n\r\n  private nextOffset = '';\r\n  private loadedAll = false;\r\n\r\n  private gifBotPeerId: PeerId;\r\n  private masonry: GifsMasonry;\r\n\r\n  private searchPromise: ReturnType<AppInlineBotsManager['getInlineResults']>;\r\n\r\n  protected init() {\r\n    this.container.id = 'search-gifs-container';\r\n    \r\n    this.inputSearch = new InputSearch('SearchGifsTitle', (value) => {\r\n      this.reset();\r\n      this.search(value);\r\n    });\r\n    \r\n    this.title.replaceWith(this.inputSearch.container);\r\n    \r\n    this.gifsDiv = document.createElement('div');\r\n    this.gifsDiv.classList.add('gifs-masonry');\r\n    attachClickEvent(this.gifsDiv, this.onGifsClick, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.scrollable.append(this.gifsDiv);\r\n    \r\n    this.masonry = new GifsMasonry(this.gifsDiv, ANIMATIONGROUP, this.scrollable);\r\n    //this.backBtn.parentElement.append(this.inputSearch.container);\r\n  }\r\n\r\n  private onGifsClick = (e: MouseEvent | TouchEvent) => {\r\n    const target = findUpClassName(e.target, 'gif');\r\n    if(!target) return;\r\n\r\n    const fileId = target.dataset.docId;\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId)) {\r\n      if(mediaSizes.isMobile) {\r\n        appSidebarRight.onCloseBtnClick();\r\n      }\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n    }\r\n  };\r\n\r\n  public onClose() {\r\n    this.scrollable.onScrolledBottom = () => {};\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.reset();\r\n    this.gifsDiv.innerHTML = '';\r\n    animationIntersector.checkAnimations(undefined, ANIMATIONGROUP);\r\n    this.inputSearch.remove();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  private reset() {\r\n    this.searchPromise = null;\r\n    this.nextOffset = '';\r\n    this.loadedAll = false;\r\n    this.masonry.clear();\r\n  }\r\n\r\n  public open() {\r\n    const ret = super.open();\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      this.search('', true);\r\n\r\n      this.scrollable.onScrolledBottom = () => {\r\n        this.search(this.inputSearch.value, false);\r\n      };\r\n    });\r\n    return ret;\r\n  }\r\n\r\n  public async search(query: string, newSearch = true) {\r\n    if(this.searchPromise || this.loadedAll) return;\r\n\r\n    if(!this.gifBotPeerId) {\r\n      this.gifBotPeerId = (await this.managers.appUsersManager.resolveUsername('gif')).id.toPeerId(false);\r\n    }\r\n\r\n    try {\r\n      this.searchPromise = this.managers.appInlineBotsManager.getInlineResults(NULL_PEER_ID, this.gifBotPeerId, query, this.nextOffset);\r\n      const { results, next_offset } = await this.searchPromise;\r\n\r\n      if(this.inputSearch.value !== query) {\r\n        return;\r\n      }\r\n\r\n      this.searchPromise = null;\r\n      this.nextOffset = next_offset;\r\n      if(newSearch) {\r\n        this.gifsDiv.innerHTML = '';\r\n      }\r\n\r\n      if(results.length) {\r\n        results.forEach((result) => {\r\n          if(result._ === 'botInlineMediaResult' && result.document) {\r\n            this.masonry.add(result.document as MyDocument);\r\n          }\r\n        });\r\n      } else {\r\n        this.loadedAll = true;\r\n      }\r\n\r\n      this.scrollable.onScroll();\r\n    } catch(err) {\r\n      this.searchPromise = null;\r\n      console.error('gifs loading error:', err);\r\n      throw err;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport { wrapSticker } from \"../../wrappers\";\r\nimport appSidebarRight from \"..\";\r\nimport { StickerSet, StickerSetCovered } from \"../../../layer\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppStickersTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private setsDiv: HTMLDivElement;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n\r\n  protected init() {\r\n    this.container.id = 'stickers-container';\r\n    this.container.classList.add('chatlist-container');\r\n\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n\r\n    this.inputSearch = new InputSearch('StickersTab.SearchPlaceholder', (value) => {\r\n      this.search(value);\r\n    });\r\n\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.setsDiv = document.createElement('div');\r\n    this.setsDiv.classList.add('sticker-sets');\r\n    this.scrollable.append(this.setsDiv);\r\n\r\n    attachClickEvent(this.setsDiv, (e) => {\r\n      const sticker = findUpClassName(e.target, 'sticker-set-sticker');\r\n      if(sticker) {\r\n        const docId = sticker.dataset.docId;\r\n        appImManager.chat.input.sendMessageWithDocument(docId);\r\n        return;\r\n      }\r\n\r\n      const target = findUpClassName(e.target, 'sticker-set');\r\n      if(!target) return;\r\n\r\n      const id = target.dataset.stickerSet as string;\r\n      const access_hash = target.dataset.access_hash as string;\r\n\r\n      const button = findUpClassName(e.target, 'sticker-set-button') as HTMLElement;\r\n      if(button) {\r\n        e.preventDefault();\r\n        e.cancelBubble = true;\r\n\r\n        button.setAttribute('disabled', 'true');\r\n        \r\n        this.managers.appStickersManager.getStickerSet({id, access_hash}).then((full) => {\r\n          this.managers.appStickersManager.toggleStickerSet(full.set).then((changed) => {\r\n            if(changed) {\r\n              button.textContent = '';\r\n              button.append(i18n(full.set.installed_date ? 'Stickers.SearchAdded' : 'Stickers.SearchAdd'));\r\n              button.classList.toggle('gray', !!full.set.installed_date);\r\n            }\r\n          }).finally(() => {\r\n            //button.style.width = set.installed_date ? '68px' : '52px';\r\n            button.removeAttribute('disabled');\r\n          });\r\n        });\r\n      } else {\r\n        this.managers.appStickersManager.getStickerSet({id, access_hash}).then((full) => {\r\n          new PopupStickers(full.set).show();\r\n        });\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.setsDiv.innerHTML = '';\r\n    animationIntersector.checkAnimations(undefined, 'STICKERS-SEARCH');\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  public renderSet(set: StickerSet.stickerSet) {\r\n    //console.log('renderSet:', set);\r\n    const div = document.createElement('div');\r\n    div.classList.add('sticker-set');\r\n\r\n    const header = document.createElement('div');\r\n    header.classList.add('sticker-set-header');\r\n\r\n    const details = document.createElement('div');\r\n    details.classList.add('sticker-set-details');\r\n    details.innerHTML = `<div class=\"sticker-set-name\"></div>`;\r\n\r\n    setInnerHTML(details.firstElementChild, wrapEmojiText(set.title));\r\n\r\n    const countDiv = document.createElement('div');\r\n    countDiv.classList.add('sticker-set-count');\r\n    countDiv.append(i18n('Stickers', [set.count]));\r\n    details.append(countDiv);\r\n    \r\n    const button = document.createElement('button');\r\n    button.classList.add('btn-primary', 'btn-color-primary', 'sticker-set-button');\r\n    button.append(i18n(set.installed_date ? 'Stickers.SearchAdded' : 'Stickers.SearchAdd'));\r\n   // button.style.width = set.installed_date ? '68px' : '52px';\r\n\r\n    if(set.installed_date) {\r\n      button.classList.add('gray');\r\n    }\r\n\r\n    //ripple(button);\r\n\r\n    header.append(details, button);\r\n\r\n    const stickersDiv = document.createElement('div');\r\n    stickersDiv.classList.add('sticker-set-stickers');\r\n\r\n    const count = Math.min(5, set.count);\r\n    for(let i = 0; i < count; ++i) {\r\n      const stickerDiv = document.createElement('div');\r\n      stickerDiv.classList.add('sticker-set-sticker');\r\n\r\n      stickersDiv.append(stickerDiv);\r\n    }\r\n\r\n    this.managers.appStickersManager.getStickerSet(set).then((set) => {\r\n      //console.log('renderSet got set:', set);\r\n      \r\n      for(let i = 0; i < count; ++i) {\r\n        const div = stickersDiv.children[i] as HTMLDivElement;\r\n        const doc = set.documents[i];\r\n        if(doc._ === 'documentEmpty') {\r\n          continue;\r\n        }\r\n\r\n        wrapSticker({\r\n          doc, \r\n          div, \r\n          lazyLoadQueue: this.lazyLoadQueue, \r\n          group: 'STICKERS-SEARCH', \r\n          /* play: false,\r\n          loop: false, */\r\n          play: true,\r\n          loop: true,\r\n          width: 68,\r\n          height: 68\r\n        });\r\n      }\r\n    });\r\n\r\n    /* const onMouseOver = () => {\r\n      const animations: AnimationItem['animation'][] = [];\r\n      for(let i = 0; i < count; ++i) {\r\n        const stickerDiv = stickersDiv.children[i] as HTMLElement;\r\n        const animationItem = animationIntersector.getAnimation(stickerDiv);\r\n        if(!animationItem) continue;\r\n\r\n        const animation = animationItem.animation;\r\n\r\n        animations.push(animation);\r\n        animation.loop = true;\r\n        animation.play();\r\n      }\r\n\r\n      div.addEventListener('mouseout', () => {\r\n        animations.forEach((animation) => {\r\n          animation.loop = false;\r\n        });\r\n\r\n        div.addEventListener('mouseover', onMouseOver, {once: true});\r\n      }, {once: true});\r\n    };\r\n\r\n    div.addEventListener('mouseover', onMouseOver, {once: true}); */\r\n\r\n    div.dataset.stickerSet = '' + set.id;\r\n    div.dataset.access_hash = '' + set.access_hash;\r\n    div.dataset.title = set.title;\r\n\r\n    div.append(header, stickersDiv);\r\n\r\n    this.setsDiv.append(div);\r\n  }\r\n\r\n  public open() {\r\n    const ret = super.open();\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      this.renderFeatured();\r\n    });\r\n\r\n    return ret;\r\n  }\r\n\r\n  public renderFeatured() {\r\n    return this.managers.appStickersManager.getFeaturedStickers().then((coveredSets) => {\r\n      if(this.inputSearch.value) {\r\n        return;\r\n      }\r\n\r\n      coveredSets = this.filterRendered('', coveredSets);\r\n      coveredSets.forEach((set) => {\r\n        this.renderSet(set.set);\r\n      });\r\n    });\r\n  }\r\n\r\n  private filterRendered(query: string, coveredSets: StickerSetCovered[]) {\r\n    coveredSets = coveredSets.slice();\r\n\r\n    const children = Array.from(this.setsDiv.children) as HTMLElement[];\r\n    forEachReverse(children, el => {\r\n      const id = el.dataset.stickerSet;\r\n      const index = coveredSets.findIndex((covered) => covered.set.id === id);\r\n  \r\n      if(index !== -1) {\r\n        coveredSets.splice(index, 1);\r\n      } else if(!query || !el.dataset.title.toLowerCase().includes(query.toLowerCase())) {\r\n        el.remove();\r\n      }\r\n    });\r\n\r\n    animationIntersector.checkAnimations(undefined, 'STICKERS-SEARCH');\r\n\r\n    return coveredSets;\r\n  }\r\n\r\n  public search(query: string) {\r\n    if(!query) {\r\n      return this.renderFeatured();\r\n    }\r\n\r\n    return this.managers.appStickersManager.searchStickerSets(query, false).then((coveredSets) => {\r\n      if(this.inputSearch.value !== query) {\r\n        return;\r\n      }\r\n\r\n      //console.log('search result:', coveredSets);\r\n\r\n      coveredSets = this.filterRendered(query, coveredSets);\r\n      coveredSets.forEach((set) => {\r\n        this.renderSet(set.set);\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"./dom/clickEvent\";\r\nimport findUpAsChild from \"./dom/findUpAsChild\";\r\nimport EventListenerBase from \"./eventListenerBase\";\r\nimport ListenerSetter from \"./listenerSetter\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nconst KEEP_OPEN = false;\r\nconst TOGGLE_TIMEOUT = 200;\r\nconst ANIMATION_DURATION = 200;\r\n\r\nexport default class DropdownHover extends EventListenerBase<{\r\n  open: () => Promise<any> | void,\r\n  opened: () => any,\r\n  close: () => any,\r\n  closed: () => any\r\n}> {\r\n  protected element: HTMLElement;\r\n  protected displayTimeout: number;\r\n  protected forceClose = false;\r\n  protected inited = false;\r\n\r\n  constructor(options: {\r\n    element: DropdownHover['element']\r\n  }) {\r\n    super(false);\r\n    safeAssign(this, options);\r\n  }\r\n\r\n  public attachButtonListener(button: HTMLElement, listenerSetter: ListenerSetter) {\r\n    let firstTime = true;\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachClickEvent(button, () => {\r\n        if(firstTime) {\r\n          firstTime = false;\r\n          this.toggle(true);\r\n        } else {\r\n          this.toggle();\r\n        }\r\n      }, {listenerSetter});\r\n    } else {\r\n      listenerSetter.add(button)('mouseover', (e) => {\r\n        //console.log('onmouseover button');\r\n        if(firstTime) {\r\n          listenerSetter.add(button)('mouseout', this.onMouseOut);\r\n          firstTime = false;\r\n        }\r\n\r\n        clearTimeout(this.displayTimeout);\r\n        this.displayTimeout = window.setTimeout(() => {\r\n          this.toggle(true);\r\n        }, TOGGLE_TIMEOUT);\r\n      });\r\n    }\r\n  }\r\n\r\n  private onMouseOut = (e: MouseEvent) => {\r\n    if(KEEP_OPEN) return;\r\n    clearTimeout(this.displayTimeout);\r\n    if(!this.isActive()) return;\r\n\r\n    const toElement = (e as any).toElement as Element;\r\n    if(toElement && findUpAsChild(toElement, this.element)) {\r\n      return;\r\n    }\r\n\r\n    this.displayTimeout = window.setTimeout(() => {\r\n      this.toggle(false);\r\n    }, TOGGLE_TIMEOUT);\r\n  };\r\n\r\n  protected init() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.onmouseout = this.onMouseOut;\r\n      this.element.onmouseover = (e) => {\r\n        if(this.forceClose) {\r\n          return;\r\n        }\r\n\r\n        //console.log('onmouseover element');\r\n        clearTimeout(this.displayTimeout);\r\n      };\r\n    }\r\n  }\r\n\r\n  public toggle = async(enable?: boolean) => {\r\n    //if(!this.element) return;\r\n    const willBeActive = (!!this.element.style.display && enable === undefined) || enable;\r\n    if(this.init) {\r\n      if(willBeActive) {\r\n        this.init();\r\n        this.init = null;\r\n      } else {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(willBeActive === this.isActive()) {\r\n      return;\r\n    }\r\n    \r\n    if((this.element.style.display && enable === undefined) || enable) {\r\n      const res = this.dispatchResultableEvent('open');\r\n      await Promise.all(res);\r\n\r\n      this.element.style.display = '';\r\n      void this.element.offsetLeft; // reflow\r\n      this.element.classList.add('active');\r\n\r\n      clearTimeout(this.displayTimeout);\r\n      this.displayTimeout = window.setTimeout(() => {\r\n        this.forceClose = false;\r\n        this.dispatchEvent('opened');\r\n      }, IS_TOUCH_SUPPORTED ? 0 : ANIMATION_DURATION);\r\n\r\n      // ! can't use together with resizeObserver\r\n      /* if(isTouchSupported) {\r\n        const height = this.element.scrollHeight + appImManager.chat.input.inputContainer.scrollHeight - 10;\r\n        console.log('[ESG]: toggle: enable height', height);\r\n        appImManager.chat.bubbles.scrollable.scrollTop += height;\r\n      } */\r\n\r\n      /* if(touchSupport) {\r\n        this.restoreScroll();\r\n      } */\r\n    } else {\r\n      this.dispatchEvent('close');\r\n\r\n      this.element.classList.remove('active');\r\n\r\n      clearTimeout(this.displayTimeout);\r\n      this.displayTimeout = window.setTimeout(() => {\r\n        this.element.style.display = 'none';\r\n        this.forceClose = false;\r\n        this.dispatchEvent('closed');\r\n      }, IS_TOUCH_SUPPORTED ? 0 : ANIMATION_DURATION);\r\n\r\n      /* if(isTouchSupported) {\r\n        const scrollHeight = this.container.scrollHeight;\r\n        if(scrollHeight) {\r\n          const height = this.container.scrollHeight + appImManager.chat.input.inputContainer.scrollHeight - 10;\r\n          appImManager.chat.bubbles.scrollable.scrollTop -= height;\r\n        }\r\n      } */\r\n\r\n      /* if(touchSupport) {\r\n        this.restoreScroll();\r\n      } */\r\n    }\r\n\r\n    //animationIntersector.checkAnimations(false, EMOTICONSSTICKERGROUP);\r\n  };\r\n\r\n  public isActive() {\r\n    return this.element.classList.contains('active');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport { horizontalMenu } from \"../horizontalMenu\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable, { ScrollableX } from \"../scrollable\";\r\nimport appSidebarRight from \"../sidebarRight\";\r\nimport StickyIntersector from \"../stickyIntersector\";\r\nimport EmojiTab from \"./tabs/emoji\";\r\nimport GifsTab from \"./tabs/gifs\";\r\nimport StickersTab from \"./tabs/stickers\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport AppGifsTab from \"../sidebarRight/tabs/gifs\";\r\nimport AppStickersTab from \"../sidebarRight/tabs/stickers\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport DropdownHover from \"../../helpers/dropdownHover\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport { IS_APPLE_MOBILE } from \"../../environment/userAgent\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport type LazyLoadQueueIntersector from \"../lazyLoadQueueIntersector\";\r\n\r\nexport const EMOTICONSSTICKERGROUP = 'emoticons-dropdown';\r\n\r\nexport interface EmoticonsTab {\r\n  init: () => void,\r\n  onCloseAfterTimeout?: () => void\r\n}\r\n\r\nexport class EmoticonsDropdown extends DropdownHover {\r\n  public static lazyLoadQueue = new LazyLoadQueue();\r\n\r\n  private emojiTab: EmojiTab;\r\n  public stickersTab: StickersTab;\r\n  private gifsTab: GifsTab;\r\n\r\n  private container: HTMLElement;\r\n  private tabsEl: HTMLElement;\r\n  private tabId = -1;\r\n\r\n  private tabs: {[id: number]: EmoticonsTab};\r\n\r\n  private searchButton: HTMLElement;\r\n  private deleteBtn: HTMLElement;\r\n\r\n  private selectTab: ReturnType<typeof horizontalMenu>;\r\n\r\n  private savedRange: Range;\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super({\r\n      element: document.getElementById('emoji-dropdown') as HTMLDivElement\r\n    });\r\n\r\n    this.addEventListener('open', async() => {\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        //appImManager.chat.input.saveScroll();\r\n        if(blurActiveElement()) {\r\n          await pause(100);\r\n        }\r\n      }\r\n\r\n      if(this.element.parentElement !== appImManager.chat.input.chatInput) {\r\n        appImManager.chat.input.chatInput.append(this.element);\r\n      }\r\n\r\n      this.savedRange = this.getGoodRange();\r\n\r\n      EmoticonsDropdown.lazyLoadQueue.lock();\r\n      //EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      animationIntersector.lockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.addEventListener('opened', () => {\r\n      animationIntersector.unlockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      EmoticonsDropdown.lazyLoadQueue.refresh();\r\n\r\n      this.container.classList.remove('disable-hover');\r\n    });\r\n\r\n    this.addEventListener('close', () => {\r\n      EmoticonsDropdown.lazyLoadQueue.lock();\r\n      //EmoticonsDropdown.lazyLoadQueue.lock();\r\n\r\n      // нужно залочить группу и выключить стикеры\r\n      animationIntersector.lockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      animationIntersector.checkAnimations(true, EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.addEventListener('closed', () => {\r\n      // теперь можно убрать visible, чтобы они не включились после фокуса\r\n      animationIntersector.unlockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      EmoticonsDropdown.lazyLoadQueue.refresh();\r\n\r\n      this.container.classList.remove('disable-hover');\r\n\r\n      this.savedRange = undefined;\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.managers = rootScope.managers;\r\n    this.emojiTab = new EmojiTab(this.managers);\r\n    this.stickersTab = new StickersTab(this.managers);\r\n    this.gifsTab = new GifsTab(this.managers);\r\n\r\n    this.tabs = {\r\n      0: this.emojiTab,\r\n      1: this.stickersTab,\r\n      2: this.gifsTab\r\n    };\r\n\r\n    this.container = this.element.querySelector('.emoji-container .tabs-container') as HTMLDivElement;\r\n    this.tabsEl = this.element.querySelector('.emoji-tabs') as HTMLUListElement;\r\n    this.selectTab = horizontalMenu(this.tabsEl, this.container, this.onSelectTabClick, () => {\r\n      const tab = this.tabs[this.tabId];\r\n      if(tab.init) {\r\n        tab.init();\r\n      }\r\n\r\n      tab.onCloseAfterTimeout && tab.onCloseAfterTimeout();\r\n      animationIntersector.checkAnimations(false, EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.searchButton = this.element.querySelector('.emoji-tabs-search');\r\n    this.searchButton.addEventListener('click', () => {\r\n      if(this.tabId === 1) {\r\n        if(!appSidebarRight.isTabExists(AppStickersTab)) {\r\n          appSidebarRight.createTab(AppStickersTab).open();\r\n        }\r\n      } else {\r\n        if(!appSidebarRight.isTabExists(AppGifsTab)) {\r\n          appSidebarRight.createTab(AppGifsTab).open();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.deleteBtn = this.element.querySelector('.emoji-tabs-delete');\r\n    this.deleteBtn.addEventListener('click', (e) => {\r\n      const input = appImManager.chat.input.messageInput;\r\n      if((input.lastChild as any)?.tagName) {\r\n        input.lastElementChild.remove();\r\n      } else if(input.lastChild) {\r\n        if(!input.lastChild.textContent.length) {\r\n          input.lastChild.remove();\r\n        } else {\r\n          input.lastChild.textContent = input.lastChild.textContent.slice(0, -1);\r\n        }\r\n      }\r\n\r\n      const event = new Event('input', {bubbles: true, cancelable: true});\r\n      appImManager.chat.input.messageInput.dispatchEvent(event);\r\n      //appSidebarRight.stickersTab.init();\r\n\r\n      cancelEvent(e);\r\n    });\r\n    \r\n    const HIDE_EMOJI_TAB = IS_APPLE_MOBILE;\r\n\r\n    const INIT_TAB_ID = HIDE_EMOJI_TAB ? 1 : 0;\r\n\r\n    if(HIDE_EMOJI_TAB) {\r\n      (this.tabsEl.children[1] as HTMLElement).classList.add('hide');\r\n    }\r\n\r\n    (this.tabsEl.children[INIT_TAB_ID + 1] as HTMLLIElement).click(); // set emoji tab\r\n    if(this.tabs[INIT_TAB_ID].init) {\r\n      this.tabs[INIT_TAB_ID].init(); // onTransitionEnd не вызовется, т.к. это первая открытая вкладка\r\n    }\r\n\r\n    appImManager.addEventListener('peer_changed', this.checkRights);\r\n    this.checkRights();\r\n\r\n    return super.init();\r\n  }\r\n\r\n  private onSelectTabClick = (id: number) => {\r\n    if(this.tabId === id) {\r\n      return;\r\n    }\r\n    \r\n    animationIntersector.checkAnimations(true, EMOTICONSSTICKERGROUP);\r\n\r\n    this.tabId = id;\r\n    this.searchButton.classList.toggle('hide', this.tabId === 0);\r\n    this.deleteBtn.classList.toggle('hide', this.tabId !== 0);\r\n  };\r\n\r\n  private checkRights = () => {\r\n    const {peerId, threadId} = appImManager.chat;\r\n    const children = this.tabsEl.children;\r\n    const tabsElements = Array.from(children) as HTMLElement[];\r\n\r\n    const canSendStickers = this.managers.appMessagesManager.canSendToPeer(peerId, threadId, 'send_stickers');\r\n    tabsElements[2].toggleAttribute('disabled', !canSendStickers);\r\n\r\n    const canSendGifs = this.managers.appMessagesManager.canSendToPeer(peerId, threadId, 'send_gifs');\r\n    tabsElements[3].toggleAttribute('disabled', !canSendGifs);\r\n\r\n    const active = this.tabsEl.querySelector('.active');\r\n    if(active && whichChild(active) !== 1 && (!canSendStickers || !canSendGifs)) {\r\n      this.selectTab(0, false);\r\n    }\r\n  };\r\n\r\n  public static menuOnClick = (menu: HTMLElement, scroll: Scrollable, menuScroll?: ScrollableX, prevId = 0) => {\r\n    let jumpedTo = -1;\r\n\r\n    const setActive = (id: number) => {\r\n      if(id === prevId) {\r\n        return false;\r\n      }\r\n\r\n      menu.children[prevId].classList.remove('active');\r\n      menu.children[id].classList.add('active');\r\n      prevId = id;\r\n\r\n      return true;\r\n    };\r\n\r\n    const stickyIntersector = new StickyIntersector(scroll.container, (stuck, target) => {\r\n      //console.log('sticky scrollTOp', stuck, target, scroll.container.scrollTop);\r\n\r\n      if(Math.abs(jumpedTo - scroll.container.scrollTop) <= 1) {\r\n        return;\r\n      } else {\r\n        jumpedTo = -1;\r\n      }\r\n\r\n      const which = whichChild(target);\r\n      if(!stuck && which) { // * due to stickyIntersector\r\n        return;\r\n      }\r\n\r\n      setActive(which);\r\n\r\n      if(menuScroll) {\r\n        if(which < menu.childElementCount - 4) {\r\n          menuScroll.container.scrollLeft = (which - 3) * 47;\r\n        } else {\r\n          menuScroll.container.scrollLeft = which * 47;\r\n        }\r\n      }\r\n    });\r\n\r\n    menu.addEventListener('click', (e) => {\r\n      let target = e.target as HTMLElement;\r\n      target = findUpClassName(target, 'menu-horizontal-div-item');\r\n\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const which = whichChild(target);\r\n\r\n      /* if(menuScroll) {\r\n        menuScroll.scrollIntoView(target, false, 0);\r\n      } */\r\n\r\n      if(!setActive(which)) {\r\n        return;\r\n      }\r\n\r\n      const element = (scroll.splitUp || scroll.container).children[which] as HTMLElement;\r\n      const offsetTop = element.offsetTop + 1; // * due to stickyIntersector\r\n\r\n      scroll.container.scrollTop = jumpedTo = offsetTop;\r\n\r\n      //console.log('set scrollTop:', offsetTop);\r\n    });\r\n\r\n    return {stickyIntersector, setActive};\r\n  };\r\n\r\n  public static onMediaClick = (e: {target: EventTarget | Element}, clearDraft = false) => {\r\n    let target = e.target as HTMLElement;\r\n    target = findUpTag(target, 'DIV');\r\n\r\n    if(!target) return false;\r\n    \r\n    const fileId = target.dataset.docId;\r\n    if(!fileId) return false;\r\n\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId, undefined, clearDraft)) {\r\n      /* dropdown.classList.remove('active');\r\n      toggleEl.classList.remove('active'); */\r\n      if(emoticonsDropdown.container) {\r\n        emoticonsDropdown.forceClose = true;\r\n        emoticonsDropdown.container.classList.add('disable-hover');\r\n        emoticonsDropdown.toggle(false);\r\n      }\r\n\r\n      return true;\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  public addLazyLoadQueueRepeat(lazyLoadQueue: LazyLoadQueueIntersector, processInvisibleDiv: (div: HTMLElement) => void) {\r\n    this.addEventListener('close', () => {\r\n      lazyLoadQueue.lock();\r\n    });\r\n\r\n    this.addEventListener('closed', () => {\r\n      const divs = lazyLoadQueue.intersector.getVisible();\r\n\r\n      for(const div of divs) {\r\n        processInvisibleDiv(div);\r\n      }\r\n\r\n      lazyLoadQueue.intersector.clearVisible();\r\n    });\r\n\r\n    this.addEventListener('opened', () => {\r\n      lazyLoadQueue.unlockAndRefresh();\r\n    });\r\n  }\r\n\r\n  public getSavedRange() {\r\n    return this.getGoodRange() || this.savedRange;\r\n  }\r\n\r\n  private getGoodRange() {\r\n    const sel = document.getSelection();\r\n    if(sel.rangeCount && document.activeElement === appImManager.chat.input.messageInput) {\r\n      return sel.getRangeAt(0);\r\n    }\r\n  }\r\n}\r\n\r\nconst emoticonsDropdown = new EmoticonsDropdown();\r\nMOUNT_CLASS_TO.emoticonsDropdown = emoticonsDropdown;\r\nexport default emoticonsDropdown;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppImManager, ChatSavedPosition } from \"../../lib/appManagers/appImManager\";\r\nimport type { HistoryResult, MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type Chat from \"./chat\";\r\nimport { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { logger } from \"../../lib/logger\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport BubbleGroups from \"./bubbleGroups\";\r\nimport PopupDatePicker from \"../popups/datePicker\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport PopupStickers from \"../popups/stickers\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport Scrollable, { SliceSides } from \"../scrollable\";\r\nimport StickyIntersector from \"../stickyIntersector\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { IS_ANDROID, IS_APPLE, IS_MOBILE, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport I18n, { FormatterArguments, i18n, langPack, LangPackKey, UNSUPPORTED_LANG_PACK_KEY, _i18n } from \"../../lib/langPack\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ripple from \"../ripple\";\r\nimport { wrapAlbum, wrapPhoto, wrapVideo, wrapDocument, wrapSticker, wrapPoll, wrapGroupedDocuments } from \"../wrappers\";\r\nimport { MessageRender } from \"./messageRender\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PollElement from \"../poll\";\r\nimport AudioElement from \"../audio\";\r\nimport { ChatInvite, Document, Message, MessageEntity,  MessageMedia,  MessageReplyHeader, Photo, PhotoSize, ReactionCount, ReplyMarkup, SponsoredMessage, Update, User, WebPage } from \"../../layer\";\r\nimport { BOT_START_PARAM, NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { FocusDirection, ScrollStartCallbackDimensions } from \"../../helpers/fastSmoothScroll\";\r\nimport useHeavyAnimationCheck, { getHeavyAnimationPromise, dispatchHeavyAnimationEvent, interruptHeavyAnimation } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport { fastRaf, fastRafPromise } from \"../../helpers/schedulers\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport RepliesElement from \"./replies\";\r\nimport DEBUG from \"../../config/debug\";\r\nimport { SliceEnd } from \"../../helpers/slicedArray\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport { toast, toastNew } from \"../toast\";\r\nimport { getElementByPoint } from \"../../helpers/dom/getElementByPoint\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport htmlToDocumentFragment from \"../../helpers/dom/htmlToDocumentFragment\";\r\nimport reflowScrollableElement from \"../../helpers/dom/reflowScrollableElement\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport { cancelAnimationByKey } from \"../../helpers/animation\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport debounce, { DebounceReturnType } from \"../../helpers/schedulers/debounce\";\r\nimport { SEND_WHEN_ONLINE_TIMESTAMP } from \"../../lib/mtproto/constants\";\r\nimport windowSize from \"../../helpers/windowSize\";\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\nimport AppMediaViewer from \"../appMediaViewer\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport handleHorizontalSwipe from \"../../helpers/dom/handleHorizontalSwipe\";\r\nimport findUpAttribute from \"../../helpers/dom/findUpAttribute\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport formatCallDuration from \"../../helpers/formatCallDuration\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport Button from \"../button\";\r\nimport { CallType } from \"../../lib/calls/types\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport PopupJoinChatInvite from \"../popups/joinChatInvite\";\r\nimport { InternalLink, INTERNAL_LINK_TYPE } from \"../../lib/appManagers/internalLink\";\r\nimport ReactionsElement, { REACTIONS_ELEMENTS } from \"./reactions\";\r\nimport type ReactionElement from \"./reaction\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport ScrollSaver from \"../../helpers/scrollSaver\";\r\nimport getObjectKeysAndSort from \"../../helpers/object/getObjectKeysAndSort\";\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport getViewportSlice from \"../../helpers/dom/getViewportSlice\";\r\nimport SuperIntersectionObserver from \"../../helpers/dom/superIntersectionObserver\";\r\nimport generateFakeIcon from \"../generateFakeIcon\";\r\nimport copyFromElement from \"../../helpers/dom/copyFromElement\";\r\nimport PopupElement from \"../popups\";\r\nimport setAttachmentSize from \"../../helpers/setAttachmentSize\";\r\nimport wrapWebPageDescription from \"../wrappers/webPageDescription\";\r\nimport wrapWebPageTitle from \"../wrappers/webPageTitle\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport wrapMessageActionTextNew from \"../wrappers/messageActionTextNew\";\r\nimport isMentionUnread from \"../../lib/appManagers/utils/messages/isMentionUnread\";\r\nimport getMediaFromMessage from \"../../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport getPeerColorById from \"../../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport generateMessageId from \"../../lib/appManagers/utils/messageId/generateMessageId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { Awaited } from \"../../types\";\r\nimport idleController from \"../../helpers/idleController\";\r\nimport overlayCounter from \"../../helpers/overlayCounter\";\r\nimport { cancelContextMenuOpening } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { AckedResult } from \"../../lib/mtproto/superMessagePort\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport { EmoticonsDropdown } from \"../emoticonsDropdown\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport noop from \"../../helpers/noop\";\r\nimport getAlbumText from \"../../lib/appManagers/utils/messages/getAlbumText\";\r\n\r\nconst USE_MEDIA_TAILS = false;\r\nconst IGNORE_ACTIONS: Set<Message.messageService['action']['_']> = new Set([\r\n  'messageActionHistoryClear',\r\n  'messageActionChatCreate'/* ,\r\n  'messageActionChannelMigrateFrom' */\r\n]);\r\n\r\nexport const SERVICE_AS_REGULAR: Set<Message.messageService['action']['_']> = new Set();\r\n\r\nif(IS_CALL_SUPPORTED) {\r\n  SERVICE_AS_REGULAR.add('messageActionPhoneCall');\r\n}\r\n\r\nconst TEST_SCROLL_TIMES: number = undefined;\r\nlet TEST_SCROLL = TEST_SCROLL_TIMES;\r\n\r\nlet queueId = 0;\r\n\r\ntype GenerateLocalMessageType<IsService> = IsService extends true ? Message.messageService : Message.message;\r\n\r\nconst SPONSORED_MESSAGE_ID_OFFSET = 1;\r\nexport const STICKY_OFFSET = 3;\r\nconst SCROLLED_DOWN_THRESHOLD = 300;\r\nconst PEER_CHANGED_ERROR = new Error('peer changed');\r\n\r\nconst DO_NOT_SLICE_VIEWPORT = false;\r\nconst DO_NOT_SLICE_VIEWPORT_ON_RENDER = false;\r\nconst DO_NOT_UPDATE_MESSAGE_VIEWS = false;\r\nconst DO_NOT_UPDATE_MESSAGE_REACTIONS = false;\r\nconst DO_NOT_UPDATE_MESSAGE_REPLY = false;\r\n\r\ntype Bubble = {\r\n  bubble: HTMLElement, \r\n  mids: Set<number>, \r\n  groupedId?: string\r\n};\r\n\r\ntype MyHistoryResult = HistoryResult | {history: number[]};\r\n\r\nfunction getMainMidForGrouped(mids: number[]) {\r\n  return Math.max(...mids);\r\n}\r\n\r\nexport default class ChatBubbles {\r\n  public container: HTMLDivElement;\r\n  public chatInner: HTMLDivElement;\r\n  public scrollable: Scrollable;\r\n\r\n  private getHistoryTopPromise: Promise<boolean>;\r\n  private getHistoryBottomPromise: Promise<boolean>;\r\n\r\n  //public messagesCount: number = -1;\r\n\r\n  private unreadOut = new Set<number>();\r\n  public needUpdate: {replyToPeerId: PeerId, replyMid: number, mid: number}[] = []; // if need wrapSingleMessage\r\n\r\n  public bubbles: {[mid: string]: HTMLElement} = {};\r\n  public skippedMids: Set<number> = new Set();\r\n  public bubblesNewByGroupedId: {[groupId: string]: Bubble} = {};\r\n  public bubblesNew: {[mid: string]: Bubble} = {};\r\n  private dateMessages: {[timestamp: number]: { \r\n    div: HTMLElement, \r\n    firstTimestamp: number, \r\n    container: HTMLElement,\r\n    timeout?: number \r\n  }} = {};\r\n\r\n  private scrolledDown = true;\r\n  private isScrollingTimeout = 0;\r\n\r\n  private stickyIntersector: StickyIntersector;\r\n\r\n  private unreaded: Map<HTMLElement, number> = new Map();\r\n  private unreadedSeen: Set<number> = new Set();\r\n  private readPromise: Promise<void>;\r\n\r\n  private bubbleGroups: BubbleGroups;\r\n\r\n  private preloader: ProgressivePreloader = null;\r\n\r\n  public messagesQueuePromise: Promise<void> = null;\r\n  private messagesQueue: ReturnType<ChatBubbles['safeRenderMessage']>[] = [];\r\n  // private messagesQueueOnRender: () => void = null;\r\n  private messagesQueueOnRenderAdditional: () => void = null;\r\n\r\n  private firstUnreadBubble: HTMLElement = null;\r\n  private attachedUnreadBubble: boolean;\r\n\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n\r\n  private middleware = getMiddleware();\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  private replyFollowHistory: number[] = [];\r\n\r\n  private isHeavyAnimationInProgress = false;\r\n  private scrollingToBubble: HTMLElement;\r\n\r\n  private isFirstLoad = true;\r\n  private needReflowScroll: boolean;\r\n\r\n  private fetchNewPromise: Promise<void>;\r\n\r\n  private passEntities: Partial<{\r\n    [_ in MessageEntity['_']]: boolean\r\n  }> = {};\r\n\r\n  private onAnimateLadder: () => Promise<any> | void;\r\n  // private ladderDeferred: CancellablePromise<void>;\r\n  private resolveLadderAnimation: () => Promise<any>;\r\n  private emptyPlaceholderBubble: HTMLElement;\r\n\r\n  private viewsMids: Set<number> = new Set();\r\n  private sendViewCountersDebounced: () => Promise<void>;\r\n\r\n  private isTopPaddingSet = false;\r\n\r\n  private getSponsoredMessagePromise: Promise<void>;\r\n\r\n  private previousStickyDate: HTMLElement;\r\n  private sponsoredMessage: SponsoredMessage.sponsoredMessage;\r\n  \r\n  private hoverBubble: HTMLElement;\r\n  private hoverReaction: HTMLElement;\r\n  private sliceViewportDebounced: DebounceReturnType<ChatBubbles['sliceViewport']>;\r\n  private resizeObserver: ResizeObserver;\r\n  private willScrollOnLoad: boolean;\r\n  private observer: SuperIntersectionObserver;\r\n\r\n  private renderingMessages: Set<number> = new Set();\r\n  private setPeerCached: boolean;\r\n  private attachPlaceholderOnRender: () => void;\r\n\r\n  private bubblesToEject: Set<HTMLElement> = new Set();\r\n  private bubblesToReplace: Map<HTMLElement, HTMLElement> = new Map(); // TO -> FROM\r\n  private updatePlaceholderPosition: () => void;\r\n  private setPeerOptions: {lastMsgId: number; topMessage: number;};\r\n\r\n  private setPeerTempId: number = 0;\r\n\r\n  private renderNewPromises: Set<Promise<any>> = new Set();\r\n\r\n  // private reactions: Map<number, ReactionsElement>;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.log = this.chat.log;\r\n    //this.chat.log.error('Bubbles construction');\r\n    \r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.constructBubbles();\r\n\r\n    // * constructor end\r\n\r\n    this.bubbleGroups = new BubbleGroups(this.chat);\r\n    this.preloader = new ProgressivePreloader({\r\n      cancelable: false\r\n    });\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.lazyLoadQueue.queueId = ++queueId;\r\n\r\n    // this.reactions = new Map();\r\n\r\n    // * events\r\n\r\n    // will call when sent for update pos\r\n    this.listenerSetter.add(rootScope)('history_update', async({storageKey, sequential, message}) => {\r\n      if(this.chat.messagesStorageKey !== storageKey || this.chat.type === 'scheduled') {\r\n        return;\r\n      }\r\n\r\n      const {mid} = message;\r\n      const log = false ? this.log.bindPrefix('history_update-' + mid) : undefined;\r\n      log && log('start');\r\n\r\n      const bubble = this.bubbles[mid];\r\n      if(!bubble) return;\r\n\r\n      if(this.renderNewPromises.size) {\r\n        log && log.error('will await new messages render');\r\n        await Promise.all(Array.from(this.renderNewPromises));\r\n      }\r\n\r\n      if(this.messagesQueuePromise) {\r\n        log && log.error('messages render in process');\r\n        await this.messagesQueuePromise;\r\n      }\r\n\r\n      if(this.bubbles[mid] !== bubble) return;\r\n\r\n      // await getHeavyAnimationPromise();\r\n      \r\n      const item = this.bubbleGroups.getItemByBubble(bubble);\r\n      if(!item) { // probably a group item\r\n        log && log.error('no item by bubble', bubble);\r\n        return;\r\n      } else if(item.mid === mid) {\r\n        log && log.warn('wow what', item, mid);\r\n        return;\r\n      }\r\n\r\n      if(sequential) {\r\n        const group = item.group;\r\n        const newItem = this.bubbleGroups.createItem(bubble, message);\r\n        // newItem.mid = item.mid;\r\n        const _items = this.bubbleGroups.itemsArr.slice();\r\n        indexOfAndSplice(_items, item);\r\n        const foundItem = this.bubbleGroups.findGroupSiblingByItem(newItem, _items);\r\n        if(\r\n          group === foundItem?.group \r\n          || (group === this.bubbleGroups.getLastGroup() && group.items.length === 1 && newItem.dateTimestamp === item.dateTimestamp) \r\n          || (this.peerId === rootScope.myId && sequential && newItem.dateTimestamp === item.dateTimestamp)\r\n        ) {\r\n          log && log('item has correct position', item);\r\n          this.bubbleGroups.changeBubbleMid(bubble, mid);\r\n          return;\r\n        }\r\n      }\r\n\r\n      // return;\r\n\r\n      // await fastRafPromise();\r\n      // if(this.bubbles[mid] !== bubble) return;\r\n\r\n      // const groupIndex = this.bubbleGroups.groups.indexOf(group);\r\n      this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n      // if(!group.items.length) { // group has collapsed, next message can have higher mid so have to reposition them too\r\n      //   log && log('group has collapsed', item);\r\n\r\n      //   const siblingGroups = this.bubbleGroups.groups.slice(0, groupIndex + 1);\r\n      //   for(let length = siblingGroups.length, i = length - 2; i >= 0; --i) {\r\n      //     const siblingGroup = siblingGroups[i];\r\n      //     const siblingItems = siblingGroup.items;\r\n      //     const nextGroup = siblingGroups[i + 1];\r\n      //     const nextItems = nextGroup.items;\r\n\r\n      //     let _break = false, moved = false;\r\n      //     for(let j = siblingItems.length - 1; j >= 0; --j) {\r\n      //       const siblingItem = siblingItems[j];\r\n      //       const foundItem = this.bubbleGroups.findGroupSiblingByItem(siblingItem, nextItems);\r\n      //       if(!foundItem) {\r\n      //         _break = true;\r\n      //         break;\r\n      //       }\r\n\r\n      //       log('will move item', siblingItem, nextGroup);\r\n      //       this.bubbleGroups.removeAndUnmountBubble(siblingItem.bubble);\r\n      //       this.bubbleGroups.addItemToGroup(siblingItem, nextGroup);\r\n      //       moved = true;\r\n      //     }\r\n\r\n      //     if(moved) {\r\n      //       nextGroup.mount();\r\n      //     }\r\n\r\n      //     if(_break) {\r\n      //       break;\r\n      //     }\r\n      //   }\r\n      // }\r\n\r\n      const {groups} = this.groupBubbles([{bubble, message}]);\r\n      this.bubbleGroups.mountUnmountGroups(groups);\r\n\r\n      if(this.scrollingToBubble) {\r\n        this.scrollToEnd();\r\n      }\r\n\r\n      log && log('end');\r\n\r\n      // this.bubbleGroups.findIncorrentPositions();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_flush', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.deleteMessagesByIds(Object.keys(this.bubbles).map((m) => +m));\r\n      }\r\n    });\r\n\r\n    // Calls when message successfully sent and we have an id\r\n    this.listenerSetter.add(rootScope)('message_sent', async(e) => {\r\n      const {storageKey, tempId, tempMessage, mid, message} = e;\r\n\r\n      // ! can't use peerId to validate here, because id can be the same in 'scheduled' and 'chat' types\r\n      if(this.chat.messagesStorageKey !== storageKey) {\r\n        return;\r\n      }\r\n\r\n      const bubbles = this.bubbles;\r\n      const _bubble = bubbles[tempId];\r\n      if(_bubble) {\r\n        const bubble = bubbles[tempId];\r\n        bubbles[mid] = bubble;\r\n        bubble.dataset.mid = '' + mid;\r\n        delete bubbles[tempId];\r\n\r\n        fastRaf(() => {\r\n          const mid = +bubble.dataset.mid;\r\n          if(bubbles[mid] === bubble && bubble.classList.contains('is-outgoing')) {\r\n            bubble.classList.remove('is-sending', 'is-outgoing');\r\n            bubble.classList.add((this.peerId === rootScope.myId && this.chat.type !== 'scheduled') || !this.unreadOut.has(mid) ? 'is-read' : 'is-sent');\r\n          }\r\n        });\r\n      }\r\n\r\n      if(this.unreadOut.has(tempId)) {\r\n        this.unreadOut.delete(tempId);\r\n        this.unreadOut.add(mid);\r\n      }\r\n\r\n      // * check timing of scheduled message\r\n      if(this.chat.type === 'scheduled') {\r\n        const timestamp = Date.now() / 1000 | 0;\r\n        const maxTimestamp = tempMessage.date - 10;\r\n        if(timestamp >= maxTimestamp) {\r\n          this.deleteMessagesByIds([mid]);\r\n        }\r\n      }\r\n\r\n      if(!_bubble) {\r\n        return;\r\n      }\r\n\r\n      let messages: (Message.message | Message.messageService)[], tempIds: number[];\r\n      const groupedId = (message as Message.message).grouped_id;\r\n      if(groupedId) {\r\n        messages = await this.managers.appMessagesManager.getMessagesByAlbum(groupedId);\r\n        const mids = messages.map(({mid}) => mid);\r\n        if(!mids.length || getMainMidForGrouped(mids) !== mid || bubbles[mid] !== _bubble) {\r\n          return;\r\n        }\r\n  \r\n        if(bubbles[mid] !== _bubble) {\r\n          return;\r\n        }\r\n\r\n        tempIds = (Array.from(_bubble.querySelectorAll('.grouped-item')) as HTMLElement[]).map((el) => +el.dataset.mid);\r\n      } else {\r\n        messages = [message];\r\n        tempIds = [tempId];\r\n      }\r\n\r\n      const reactionsElements = Array.from(_bubble.querySelectorAll('reactions-element')) as ReactionsElement[];\r\n      if(reactionsElements.length) {\r\n        reactionsElements.forEach((reactionsElement) => {\r\n          reactionsElement.changeMessage(message as Message.message);\r\n        });\r\n      }\r\n\r\n      (messages as Message.message[]).forEach((message, idx) => {\r\n        if(!message) {\r\n          return;\r\n        }\r\n\r\n        const tempId = tempIds[idx];\r\n        const mid = message.mid;\r\n        const bubble: HTMLElement = _bubble.querySelector(`.document-container[data-mid=\"${mid}\"]`) || _bubble;\r\n\r\n        if(message._ !== 'message') {\r\n          return;\r\n        }\r\n\r\n        if(message.replies) {\r\n          const repliesElement = _bubble.querySelector('replies-element') as RepliesElement;\r\n          if(repliesElement) {\r\n            repliesElement.message = message;\r\n            repliesElement.init();\r\n          }\r\n        }\r\n\r\n        const media = message.media ?? {} as MessageMedia.messageMediaEmpty;\r\n        const doc = (media as MessageMedia.messageMediaDocument).document as Document.document;\r\n        const poll = (media as MessageMedia.messageMediaPoll).poll;\r\n        const webPage = (media as MessageMedia.messageMediaWebPage).webpage as WebPage.webPage;\r\n        if(doc) {\r\n          const div = bubble.querySelector(`.document-container[data-mid=\"${tempId}\"] .document`);\r\n          if(div) {\r\n            const container = findUpClassName(div, 'document-container');\r\n\r\n            if(!tempMessage.media?.document?.thumbs?.length && doc.thumbs?.length) {\r\n              getHeavyAnimationPromise().then(async() => {\r\n                const timeSpan = div.querySelector('.time');\r\n                const newDiv = await wrapDocument({message});\r\n                div.replaceWith(newDiv);\r\n                \r\n                if(timeSpan) {\r\n                  newDiv.querySelector('.document-size').append(timeSpan);\r\n                }\r\n              });\r\n            }\r\n\r\n            if(container) {\r\n              container.dataset.mid = '' + mid;\r\n            }\r\n          }\r\n\r\n          const element = bubble.querySelector(`audio-element[data-mid=\"${tempId}\"], .document[data-doc-id=\"${tempId}\"], .media-round[data-mid=\"${tempId}\"]`) as HTMLElement;\r\n          if(element) {\r\n            if(element instanceof AudioElement || element.classList.contains('media-round')) {\r\n              element.dataset.mid = '' + message.mid;\r\n              delete element.dataset.isOutgoing;\r\n              (element as any).message = message;\r\n              (element as any).onLoad(true);\r\n            } else {\r\n              element.dataset.docId = '' + doc.id;\r\n            }\r\n          }\r\n        } else if(poll) {\r\n          const pollElement = bubble.querySelector('poll-element') as PollElement;\r\n          if(pollElement) {\r\n            pollElement.message = message;\r\n            pollElement.setAttribute('poll-id', '' + poll.id);\r\n            pollElement.setAttribute('message-id', '' + mid);\r\n          }\r\n        } else if(webPage && !bubble.querySelector('.web')) {\r\n          getHeavyAnimationPromise().then(() => {\r\n            this.safeRenderMessage(message, true, bubble);\r\n            this.scrollToBubbleIfLast(bubble);\r\n          });\r\n        }\r\n        \r\n        // set new mids to album items for mediaViewer\r\n        if(groupedId) {\r\n          const item = (bubble.querySelector(`.grouped-item[data-mid=\"${tempId}\"]`) as HTMLElement) || bubble; // * it can be .document-container\r\n          if(item) {\r\n            item.dataset.mid = '' + mid;\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('message_edit', ({storageKey, message}) => {\r\n      if(storageKey !== this.chat.messagesStorageKey) return;\r\n\r\n      const bubble = this.bubbles[message.mid];\r\n      if(!bubble) return;\r\n\r\n      this.safeRenderMessage(message, true, bubble);\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('album_edit', ({peerId, messages, deletedMids}) => {\r\n      if(peerId !== this.peerId) return;\r\n      \r\n      const mids = messages.map(({mid}) => mid);\r\n      const oldMids = mids.concat(Array.from(deletedMids));\r\n      const wasMainMid = getMainMidForGrouped(oldMids);\r\n      const bubble = this.bubbles[wasMainMid];\r\n      if(!bubble) {\r\n        return;\r\n      }\r\n\r\n      const mainMid = getMainMidForGrouped(mids);\r\n      const message = messages.find((message) => message.mid === mainMid);\r\n      this.safeRenderMessage(message, true, bubble);\r\n    });\r\n\r\n    if(this.chat.type !== 'scheduled' && !DO_NOT_UPDATE_MESSAGE_REACTIONS/*  && false */) {\r\n      this.listenerSetter.add(rootScope)('messages_reactions', async(arr) => {\r\n        let scrollSaver: ScrollSaver;\r\n\r\n        const a = arr.map(async({message, changedResults}) => {\r\n          if(this.peerId !== message.peerId) {\r\n            return;\r\n          }\r\n\r\n          const result = await this.getMountedBubble(message.mid, message);\r\n          if(!result) {\r\n            return;\r\n          }\r\n\r\n          return {bubble: result.bubble, message, changedResults};\r\n        });\r\n\r\n        let top: number;\r\n        (await Promise.all(a)).filter(Boolean).forEach(({bubble, message, changedResults}) => {\r\n          if(!scrollSaver) {\r\n            scrollSaver = this.createScrollSaver(false);\r\n            scrollSaver.save();\r\n          }\r\n  \r\n          const key = message.peerId + '_' + message.mid;\r\n          const set = REACTIONS_ELEMENTS.get(key);\r\n          if(set) {\r\n            for(const element of set) {\r\n              element.update(message, changedResults);\r\n            }\r\n          } else if(!message.reactions || !message.reactions.results.length) {\r\n            return;\r\n          } else {\r\n            this.appendReactionsElementToBubble(bubble, message, message, changedResults);\r\n          }\r\n        });\r\n\r\n        if(scrollSaver) {\r\n          scrollSaver.restore();\r\n        }\r\n      });\r\n    }\r\n\r\n    !DO_NOT_UPDATE_MESSAGE_REPLY && this.listenerSetter.add(rootScope)('messages_downloaded', async({peerId, mids}) => {\r\n      const middleware = this.getMiddleware();\r\n      await getHeavyAnimationPromise();\r\n      if(!middleware()) return;\r\n\r\n      (mids as number[]).forEach((mid) => {\r\n        const needUpdate = this.needUpdate;\r\n        const filtered: typeof needUpdate[0][] = [];\r\n        forEachReverse(this.needUpdate, (obj, idx) => {\r\n          if(obj.replyMid === mid && obj.replyToPeerId === peerId) {\r\n            this.needUpdate.splice(idx, 1)[0];\r\n            filtered.push(obj);\r\n          }\r\n        });\r\n\r\n        filtered.forEach(async({mid, replyMid, replyToPeerId}) => {\r\n          const bubble = this.bubbles[mid];\r\n          if(!bubble) return;\r\n\r\n          const message = (await this.chat.getMessage(mid)) as Message.message;\r\n          \r\n          MessageRender.setReply({\r\n            chat: this.chat,\r\n            bubble,\r\n            message\r\n          });\r\n        });\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.scrollable.container, this.onBubblesClick, {listenerSetter: this.listenerSetter});\r\n    // this.listenerSetter.add(this.bubblesContainer)('click', this.onBubblesClick/* , {capture: true, passive: false} */);\r\n\r\n    this.listenerSetter.add(this.scrollable.container)('mousedown', (e) => {\r\n      if(e.button !== 0) return;\r\n      \r\n      const code: HTMLElement = findUpTag(e.target, 'CODE');\r\n      if(code) {\r\n        cancelEvent(e);\r\n        copyFromElement(code);\r\n        toastNew({langPackKey: 'TextCopied'});\r\n        return;\r\n      }\r\n    });\r\n\r\n    /* if(false)  */this.stickyIntersector = new StickyIntersector(this.scrollable.container, (stuck, target) => {\r\n      for(const timestamp in this.dateMessages) {\r\n        const dateMessage = this.dateMessages[timestamp];\r\n        if(dateMessage.container === target) {\r\n          const dateBubble = dateMessage.div;\r\n\r\n          // dateMessage.container.classList.add('has-sticky-dates');\r\n\r\n          // SetTransition(dateBubble, 'kek', stuck, this.previousStickyDate ? 300 : 0);\r\n          // if(this.previousStickyDate) {\r\n            // dateBubble.classList.add('kek');\r\n          // }\r\n\r\n          dateBubble.classList.toggle('is-sticky', stuck);\r\n          if(stuck) {\r\n            this.previousStickyDate = dateBubble;\r\n          }\r\n\r\n          break;\r\n        }\r\n      }\r\n\r\n      if(this.previousStickyDate) {\r\n        // fastRaf(() => {\r\n          // this.bubblesContainer.classList.add('has-sticky-dates');\r\n        // });\r\n      }\r\n    });\r\n\r\n    if(!IS_SAFARI) {\r\n      this.sliceViewportDebounced = debounce(this.sliceViewport.bind(this), 3000, false, true);\r\n    }\r\n\r\n    let middleware: ReturnType<ChatBubbles['getMiddleware']>;\r\n    useHeavyAnimationCheck(() => {\r\n      this.isHeavyAnimationInProgress = true;\r\n      this.lazyLoadQueue.lock();\r\n      middleware = this.getMiddleware();\r\n\r\n      // if(this.sliceViewportDebounced) {\r\n      //   this.sliceViewportDebounced.clearTimeout();\r\n      // }\r\n    }, () => {\r\n      this.isHeavyAnimationInProgress = false;\r\n\r\n      if(middleware && middleware()) {\r\n        this.lazyLoadQueue.unlock();\r\n        this.lazyLoadQueue.refresh();\r\n\r\n        // if(this.sliceViewportDebounced) {\r\n        //   this.sliceViewportDebounced();\r\n        // }\r\n      }\r\n\r\n      middleware = null;\r\n    }, this.listenerSetter);\r\n  }\r\n\r\n  private constructBubbles() {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add('bubbles', 'scrolled-down');\r\n\r\n    const chatInner = this.chatInner = document.createElement('div');\r\n    chatInner.classList.add('bubbles-inner');\r\n\r\n    this.setScroll();\r\n\r\n    container.append(this.scrollable.container);\r\n  }\r\n\r\n  public attachContainerListeners() {\r\n    const container = this.container;\r\n\r\n    this.chat.contextMenu.attachTo(container);\r\n    this.chat.selection.attachListeners(container, new ListenerSetter());\r\n\r\n    if(DEBUG) {\r\n      this.listenerSetter.add(container)('dblclick', async(e) => {\r\n        const bubble = findUpClassName(e.target, 'grouped-item') || findUpClassName(e.target, 'bubble');\r\n        if(bubble) {\r\n          const mid = +bubble.dataset.mid\r\n          this.log('debug message:', await this.chat.getMessage(mid));\r\n          this.highlightBubble(bubble);\r\n        }\r\n      });\r\n    }\r\n\r\n    if(this.chat.type !== 'pinned' && this.chat.type !== 'scheduled') {\r\n      if(!IS_MOBILE) {\r\n        this.listenerSetter.add(container)('dblclick', async(e) => {\r\n          if(this.chat.selection.isSelecting || \r\n            !(await this.chat.canSend())) {\r\n            return;\r\n          }\r\n          \r\n          const target = e.target as HTMLElement;\r\n          const bubble = target.classList.contains('bubble') ? \r\n            target : \r\n            (target.classList.contains('document-selection') ? target.parentElement : null);\r\n          if(bubble && !bubble.classList.contains('bubble-first')) {\r\n            const mid = +bubble.dataset.mid;\r\n            const message = await this.chat.getMessage(mid);\r\n            if(message.pFlags.is_outgoing) {\r\n              return;\r\n            }\r\n            \r\n            this.chat.input.initMessageReply(mid);\r\n          }\r\n        });\r\n      } else if(IS_TOUCH_SUPPORTED) {\r\n        const className = 'is-gesturing-reply';\r\n        const MAX = 64;\r\n        const replyAfter = MAX * .75;\r\n        let shouldReply = false;\r\n        let target: HTMLElement;\r\n        let icon: HTMLElement;\r\n        handleHorizontalSwipe({\r\n          element: container,\r\n          verifyTouchTarget: async(e) => {\r\n            if(this.chat.selection.isSelecting || !(await this.chat.canSend())) {\r\n              return false;\r\n            }\r\n  \r\n            // cancelEvent(e);\r\n            target = findUpClassName(e.target, 'bubble');\r\n            if(target) {\r\n              SetTransition(target, className, true, 250);\r\n              void target.offsetLeft; // reflow\r\n  \r\n              if(!icon) {\r\n                icon = document.createElement('span');\r\n                icon.classList.add('tgico-reply_filled', 'bubble-gesture-reply-icon');\r\n              } else {\r\n                icon.classList.remove('is-visible');\r\n                icon.style.opacity = '';\r\n              }\r\n  \r\n              target/* .querySelector('.bubble-content') */.append(icon);\r\n            }\r\n  \r\n            return !!target;\r\n          },\r\n          onSwipe: (xDiff, yDiff) => {\r\n            shouldReply = xDiff >= replyAfter;\r\n  \r\n            if(shouldReply && !icon.classList.contains('is-visible')) {\r\n              icon.classList.add('is-visible');\r\n            }\r\n            icon.style.opacity = '' + Math.min(1, xDiff / replyAfter);\r\n  \r\n            const x = -Math.max(0, Math.min(MAX, xDiff));\r\n            target.style.transform = `translateX(${x}px)`;\r\n            cancelContextMenuOpening();\r\n          },\r\n          onReset: () => {\r\n            const _target = target;\r\n            SetTransition(_target, className, false, 250, () => {\r\n              if(icon.parentElement === _target) {\r\n                icon.classList.remove('is-visible');\r\n                icon.remove();\r\n              }\r\n            });\r\n  \r\n            fastRaf(() => {\r\n              _target.style.transform = ``;\r\n  \r\n              if(shouldReply) {\r\n                const {mid} = _target.dataset;\r\n                this.chat.input.initMessageReply(+mid);\r\n                shouldReply = false;\r\n              }\r\n            });\r\n          },\r\n          listenerOptions: {capture: true}\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    // will call when message is sent (only 1)\r\n    this.listenerSetter.add(rootScope)('history_append', async({storageKey, message}) => {\r\n      if(storageKey !== this.chat.messagesStorageKey) return;\r\n\r\n      if(!this.scrollable.loadedAll.bottom) {\r\n        this.chat.setMessageId();\r\n      } else {\r\n        this.renderNewMessage(message, true);\r\n      }\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        const gradientRenderer = this.chat.gradientRenderer;\r\n        if(gradientRenderer) {\r\n          gradientRenderer.toNextPosition();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('history_multiappend', (message) => {\r\n      if(this.peerId !== message.peerId) return;\r\n      this.renderNewMessage(message);\r\n    });\r\n    \r\n    this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n      if(peerId === this.peerId) {\r\n        this.deleteMessagesByIds(Array.from(msgs));\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_unread', ({peerId}) => {\r\n      if(peerId === this.peerId) {\r\n        this.chat.input.setUnreadCount();\r\n\r\n        getHeavyAnimationPromise().then(() => {\r\n          this.updateUnreadByDialog();\r\n        });\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialogs_multiupdate', (dialogs) => {\r\n      if(dialogs[this.peerId]) {\r\n        this.chat.input.setUnreadCount();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_notify_settings', (dialog) => {\r\n      if(this.peerId === dialog.peerId) {\r\n        this.chat.input.setUnreadCount();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', async(chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        const hadRights = this.chatInner.classList.contains('has-rights');\r\n        const hasRights = await this.chat.canSend();\r\n\r\n        if(hadRights !== hasRights) {\r\n          const callbacks = await Promise.all([\r\n            this.finishPeerChange(),\r\n            this.chat.input.finishPeerChange(),\r\n          ]);\r\n\r\n          callbacks.forEach((callback) => callback());\r\n        }\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('settings_updated', async({key}) => {\r\n      if(key === 'settings.emoji.big') {\r\n        const middleware = this.getMiddleware();\r\n        const mids = getObjectKeysAndSort(this.bubbles, 'desc');\r\n        const m = mids.map(async(mid) => {\r\n          const bubble = this.bubbles[mid];\r\n          if(bubble.classList.contains('can-have-big-emoji')) {\r\n            return {bubble, message: await this.chat.getMessage(mid)};\r\n          }\r\n        });\r\n\r\n        const awaited = await Promise.all(m);\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        awaited.forEach(({bubble, message}) => {\r\n          if(this.bubbles[message.mid] !== bubble) {\r\n            return;\r\n          }\r\n          \r\n          this.safeRenderMessage(message, true, bubble);\r\n        });\r\n      }\r\n    });\r\n\r\n    !DO_NOT_UPDATE_MESSAGE_VIEWS && this.listenerSetter.add(rootScope)('messages_views', (arr) => {\r\n      fastRaf(() => {\r\n        let scrollSaver: ScrollSaver;\r\n        for(const {peerId, views, mid} of arr) {\r\n          if(this.peerId !== peerId) continue;\r\n\r\n          const bubble = this.bubbles[mid];\r\n          if(!bubble) continue;\r\n  \r\n          const postViewsElements = Array.from(bubble.querySelectorAll('.post-views')) as HTMLElement[];\r\n          if(!postViewsElements.length) continue;\r\n\r\n          const str = formatNumber(views, 1);\r\n          let different = false;\r\n          postViewsElements.forEach((postViews) => {\r\n            if(different || postViews.textContent !== str) {\r\n              if(!scrollSaver) {\r\n                scrollSaver = this.createScrollSaver(true);\r\n                scrollSaver.save();\r\n              }\r\n\r\n              different = true;\r\n              postViews.textContent = str;\r\n            }\r\n          });\r\n        }\r\n\r\n        if(scrollSaver) {\r\n          scrollSaver.restore();\r\n        }\r\n      });\r\n    });\r\n\r\n    this.observer = new SuperIntersectionObserver({root: this.scrollable.container});\r\n\r\n    this.listenerSetter.add(this.chat.appImManager)('chat_changing', ({to}) => {\r\n      const freeze = to !== this.chat;\r\n\r\n      const cb = () => {\r\n        this.observer.toggleObservingNew(freeze);\r\n      };\r\n\r\n      if(!freeze) {\r\n        setTimeout(() => {\r\n          cb();\r\n        }, 400);\r\n      } else {\r\n        cb();\r\n      }\r\n    });\r\n\r\n    this.sendViewCountersDebounced = debounce(() => {\r\n      const mids = [...this.viewsMids];\r\n      this.viewsMids.clear();\r\n\r\n      this.managers.appMessagesManager.incrementMessageViews(this.peerId, mids);\r\n    }, 1000, false, true);\r\n  }\r\n\r\n  private get peerId() {\r\n    return this.chat.peerId;\r\n  }\r\n\r\n  private createScrollSaver(reverse = true) {\r\n    const scrollSaver = new ScrollSaver(this.scrollable, '.bubble:not(.is-date)', reverse);\r\n    return scrollSaver;\r\n  }\r\n\r\n  private unreadedObserverCallback = (entry: IntersectionObserverEntry) => {\r\n    if(entry.isIntersecting) {\r\n      const target = entry.target as HTMLElement;\r\n      const mid = this.unreaded.get(target as HTMLElement);\r\n      this.onUnreadedInViewport(target, mid);\r\n    }\r\n  };\r\n\r\n  private viewsObserverCallback = (entry: IntersectionObserverEntry) => {\r\n    if(entry.isIntersecting) {\r\n      const mid = +(entry.target as HTMLElement).dataset.mid;\r\n      this.observer.unobserve(entry.target, this.viewsObserverCallback);\r\n\r\n      if(mid) {\r\n        this.viewsMids.add(mid);\r\n        this.sendViewCountersDebounced();\r\n      } else {\r\n        const {sponsoredMessage} = this;\r\n        if(sponsoredMessage && sponsoredMessage.random_id) {\r\n          delete sponsoredMessage.random_id;\r\n          this.managers.appChatsManager.viewSponsoredMessage(this.peerId.toChatId(), sponsoredMessage.random_id);\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private createResizeObserver() {\r\n    if(!('ResizeObserver' in window) || this.resizeObserver) {\r\n      return;\r\n    }\r\n\r\n    const container = this.scrollable.container;\r\n    let wasHeight = 0/* container.offsetHeight */;\r\n    let resizing = false;\r\n    let skip = false;\r\n    let scrolled = 0;\r\n    let part = 0;\r\n    let rAF = 0;\r\n    // let skipNext = true;\r\n\r\n    const onResizeEnd = () => {\r\n      const height = container.offsetHeight;\r\n      const isScrolledDown = this.scrollable.isScrolledDown;\r\n      if(height !== wasHeight && (!skip || !isScrolledDown)) { // * fix opening keyboard while ESG is active, offsetHeight will change right between 'start' and this first frame\r\n        part += wasHeight - height;\r\n      }\r\n\r\n      /* if(DEBUG) {\r\n        this.log('resize end', scrolled, part, this.scrollable.scrollTop, height, wasHeight, this.scrollable.isScrolledDown);\r\n      } */\r\n\r\n      if(part) {\r\n        this.scrollable.setScrollTopSilently(this.scrollable.scrollTop + Math.round(part));\r\n      }\r\n\r\n      wasHeight = height;\r\n      scrolled = 0;\r\n      rAF = 0;\r\n      part = 0;\r\n      resizing = false;\r\n      skip = false;\r\n    };\r\n\r\n    const setEndRAF = (single: boolean) => {\r\n      if(rAF) window.cancelAnimationFrame(rAF);\r\n      rAF = window.requestAnimationFrame(single ? onResizeEnd : () => {\r\n        rAF = window.requestAnimationFrame(onResizeEnd);\r\n        //this.log('resize after RAF', part);\r\n      });\r\n    };\r\n\r\n    const processEntries: ResizeObserverCallback = (entries) => {\r\n      /* if(skipNext) {\r\n        skipNext = false;\r\n        return;\r\n      } */\r\n\r\n      if(skip) {\r\n        setEndRAF(false);\r\n        return;\r\n      }\r\n\r\n      const entry = entries[0];\r\n      const height = entry.contentRect.height;/* Math.ceil(entry.contentRect.height); */\r\n      \r\n      if(!wasHeight) {\r\n        wasHeight = height;\r\n        return;\r\n      }\r\n\r\n      const realDiff = wasHeight - height;\r\n      let diff = realDiff + part;\r\n      const _part = diff % 1;\r\n      diff -= _part;\r\n\r\n      if(!resizing) {\r\n        resizing = true;\r\n\r\n        /* if(DEBUG) {\r\n          this.log('resize start', realDiff, this.scrollable.scrollTop, this.scrollable.container.offsetHeight, this.scrollable.isScrolledDown);\r\n        } */\r\n\r\n        if(realDiff < 0 && this.scrollable.isScrolledDown) {\r\n          //if(isSafari) { // * fix opening keyboard while ESG is active \r\n            part = -realDiff;\r\n          //}\r\n\r\n          skip = true;\r\n          setEndRAF(false);\r\n          return;\r\n        }\r\n      }\r\n\r\n      scrolled += diff;\r\n\r\n      /* if(DEBUG) {\r\n        this.log('resize', wasHeight - height, diff, this.scrollable.container.offsetHeight, this.scrollable.isScrolledDown, height, wasHeight);\r\n      } */\r\n\r\n      if(diff) {\r\n        const needScrollTop = this.scrollable.scrollTop + diff;\r\n        this.scrollable.setScrollTopSilently(needScrollTop);\r\n      }\r\n      \r\n      setEndRAF(false);\r\n\r\n      part = _part;\r\n      wasHeight = height;\r\n    };\r\n\r\n    const resizeObserver = this.resizeObserver = new ResizeObserver(processEntries);\r\n    resizeObserver.observe(container);\r\n  }\r\n\r\n  private destroyResizeObserver() {\r\n    const resizeObserver = this.resizeObserver;\r\n    if(!resizeObserver) {\r\n      return;\r\n    }\r\n\r\n    resizeObserver.disconnect();\r\n    this.resizeObserver = undefined;\r\n  }\r\n\r\n  private onBubblesMouseMove = async(e: MouseEvent) => {\r\n    const content = findUpClassName(e.target, 'bubble-content');\r\n    if(content && !this.chat.selection.isSelecting) {\r\n      const bubble = findUpClassName(content, 'bubble');\r\n      if(!this.chat.selection.canSelectBubble(bubble)) {\r\n        this.unhoverPrevious();\r\n        return;\r\n      }\r\n\r\n      let {hoverBubble, hoverReaction} = this;\r\n      if(bubble === hoverBubble) {\r\n        return;\r\n      }\r\n\r\n      this.unhoverPrevious();\r\n\r\n      hoverBubble = this.hoverBubble = bubble;\r\n      hoverReaction = this.hoverReaction;\r\n      // hoverReaction = contentWrapper.querySelector('.bubble-hover-reaction');\r\n      if(!hoverReaction) {\r\n        hoverReaction = this.hoverReaction = document.createElement('div');\r\n        hoverReaction.classList.add('bubble-hover-reaction');\r\n\r\n        const stickerWrapper = document.createElement('div');\r\n        stickerWrapper.classList.add('bubble-hover-reaction-sticker');\r\n        hoverReaction.append(stickerWrapper);\r\n\r\n        content.append(hoverReaction);\r\n\r\n        let message = (await this.chat.getMessage(+bubble.dataset.mid)) as Message.message;\r\n        message = await this.managers.appMessagesManager.getGroupsFirstMessage(message);\r\n\r\n        const middleware = this.getMiddleware(() => this.hoverReaction === hoverReaction);\r\n        Promise.all([\r\n          this.managers.appReactionsManager.getAvailableReactionsByMessage(message),\r\n          pause(400)\r\n        ]).then(([availableReactions]) => {\r\n          const availableReaction = availableReactions[0];\r\n          if(!availableReaction) {\r\n            hoverReaction.remove();\r\n            return;\r\n          }\r\n\r\n          wrapSticker({\r\n            div: stickerWrapper,\r\n            doc: availableReaction.select_animation,\r\n            width: 18,\r\n            height: 18,\r\n            needUpscale: true,\r\n            middleware,\r\n            group: CHAT_ANIMATION_GROUP,\r\n            withThumb: false,\r\n            needFadeIn: false\r\n          }).then(({render}) => render).then((player) => {\r\n            assumeType<RLottiePlayer>(player);\r\n            if(!middleware()) {\r\n              return;\r\n            }\r\n\r\n            player.addEventListener('firstFrame', () => {\r\n              if(!middleware()) {\r\n                // debugger;\r\n                return;\r\n              }\r\n\r\n              hoverReaction.dataset.loaded = '1';\r\n              this.setHoverVisible(hoverReaction, true);\r\n            }, {once: true});\r\n\r\n            attachClickEvent(hoverReaction, (e) => {\r\n              cancelEvent(e); // cancel triggering selection\r\n\r\n              this.managers.appReactionsManager.sendReaction(message, availableReaction.reaction);\r\n              this.unhoverPrevious();\r\n            }, {listenerSetter: this.listenerSetter});\r\n          });\r\n        });\r\n      } else if(hoverReaction.dataset.loaded) {\r\n        this.setHoverVisible(hoverReaction, true);\r\n      }\r\n    } else {\r\n      this.unhoverPrevious();\r\n    }\r\n  };\r\n\r\n  public setReactionsHoverListeners() {\r\n    this.listenerSetter.add(contextMenuController)('toggle', this.unhoverPrevious);\r\n    this.listenerSetter.add(overlayCounter)('change', this.unhoverPrevious);\r\n    this.listenerSetter.add(this.chat.selection)('toggle', this.unhoverPrevious);\r\n    this.listenerSetter.add(this.container)('mousemove', this.onBubblesMouseMove);\r\n  }\r\n\r\n  private setHoverVisible(hoverReaction: HTMLElement, visible: boolean) {\r\n    SetTransition(hoverReaction, 'is-visible', visible, 200, visible ? undefined : () => {\r\n      hoverReaction.remove();\r\n    }, 2);\r\n  }\r\n\r\n  private unhoverPrevious = () => {\r\n    const {hoverBubble, hoverReaction} = this;\r\n    if(hoverBubble) {\r\n      this.setHoverVisible(hoverReaction, false);\r\n      this.hoverBubble = undefined;\r\n      this.hoverReaction = undefined;\r\n    }\r\n  };\r\n\r\n  public setStickyDateManually() {\r\n    return;\r\n\r\n    const timestamps = Object.keys(this.dateMessages).map((k) => +k).sort((a, b) => b - a);\r\n    let lastVisible: HTMLElement;\r\n\r\n    // if(this.chatInner.classList.contains('is-scrolling')) {\r\n      const {scrollTop} = this.scrollable.container;\r\n      const isOverflown = scrollTop > 0;\r\n      if(isOverflown) {\r\n        for(const timestamp of timestamps) {\r\n          const dateMessage = this.dateMessages[timestamp];\r\n          const visibleRect = getVisibleRect(dateMessage.container, this.scrollable.container);\r\n          if(visibleRect && visibleRect.overflow.top) {\r\n            lastVisible = dateMessage.div;\r\n          } else if(lastVisible) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    // }\r\n\r\n    if(lastVisible === this.previousStickyDate) {\r\n      return;\r\n    }\r\n\r\n    if(lastVisible) {\r\n      const needReflow = /* !!this.chat.setPeerPromise ||  */!this.previousStickyDate;\r\n      if(needReflow) {\r\n        lastVisible.classList.add('no-transition');\r\n      }\r\n\r\n      lastVisible.classList.add('is-sticky');\r\n\r\n      if(needReflow) {\r\n        void lastVisible.offsetLeft; // reflow\r\n        lastVisible.classList.remove('no-transition');\r\n      }\r\n    }\r\n\r\n    if(this.previousStickyDate && this.previousStickyDate !== lastVisible) {\r\n      this.previousStickyDate.classList.remove('is-sticky');\r\n    }\r\n\r\n    this.previousStickyDate = lastVisible;\r\n  }\r\n\r\n  public getRenderedLength() {\r\n    return Object.keys(this.bubbles).length - this.skippedMids.size;\r\n  }\r\n\r\n  private onUnreadedInViewport(target: HTMLElement, mid: number) {\r\n    this.unreadedSeen.add(mid);\r\n    this.observer.unobserve(target, this.unreadedObserverCallback);\r\n    this.unreaded.delete(target);\r\n    this.readUnreaded();\r\n  }\r\n\r\n  private readUnreaded() {\r\n    if(this.readPromise) return;\r\n\r\n    const middleware = this.getMiddleware();\r\n    this.readPromise = idleController.getFocusPromise().then(async() => {\r\n      if(!middleware()) return;\r\n      let maxId = Math.max(...Array.from(this.unreadedSeen));\r\n\r\n      // ? if message with maxId is not rendered ?\r\n      if(this.scrollable.loadedAll.bottom) {\r\n        const bubblesMaxId = Math.max(...Object.keys(this.bubbles).map((i) => +i));\r\n        if(maxId >= bubblesMaxId) {\r\n          maxId = Math.max((await this.chat.getHistoryMaxId()) || 0, maxId);\r\n        }\r\n      }\r\n\r\n      this.unreaded.forEach((mid, target) => {\r\n        if(mid <= maxId) {\r\n          this.onUnreadedInViewport(target, mid);\r\n        }\r\n      });\r\n\r\n      const readContents: number[] = [];\r\n      for(const mid of this.unreadedSeen) {\r\n        const message: MyMessage = await this.chat.getMessage(mid);\r\n        if(isMentionUnread(message)) {\r\n          readContents.push(mid);\r\n        }\r\n      }\r\n\r\n      this.managers.appMessagesManager.readMessages(this.peerId, readContents);\r\n\r\n      this.unreadedSeen.clear();\r\n\r\n      if(DEBUG) {\r\n        this.log('will readHistory by maxId:', maxId);\r\n      }\r\n\r\n      // return;\r\n      \r\n      return this.managers.appMessagesManager.readHistory(this.peerId, maxId, this.chat.threadId).catch((err: any) => {\r\n        this.log.error('readHistory err:', err);\r\n        this.managers.appMessagesManager.readHistory(this.peerId, maxId, this.chat.threadId);\r\n      }).finally(() => {\r\n        if(!middleware()) return;\r\n        this.readPromise = undefined;\r\n\r\n        if(this.unreadedSeen.size) {\r\n          this.readUnreaded();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', (e) => {\r\n      const {peerId, mids, pinned} = e;\r\n      if(peerId !== this.peerId) return;\r\n\r\n      if(mids) {\r\n        if(!pinned) {\r\n          this.deleteMessagesByIds(mids);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public constructScheduledHelpers() {\r\n    const onUpdate = async() => {\r\n      this.chat.topbar.setTitle((await this.managers.appMessagesManager.getScheduledMessagesStorage(this.peerId)).size);\r\n    };\r\n\r\n    this.listenerSetter.add(rootScope)('scheduled_new', (message) => {\r\n      if(message.peerId !== this.peerId) return;\r\n\r\n      this.renderNewMessage(message);\r\n      onUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId, mids}) => {\r\n      if(peerId !== this.peerId) return;\r\n\r\n      this.deleteMessagesByIds(mids);\r\n      onUpdate();\r\n    });\r\n  }\r\n\r\n  public onBubblesClick = async(e: Event) => {\r\n    let target = e.target as HTMLElement;\r\n    let bubble: HTMLElement = null;\r\n    try {\r\n      bubble = findUpClassName(target, 'bubble');\r\n    } catch(err) {}\r\n    \r\n    if(!bubble && !this.chat.selection.isSelecting) {\r\n      const avatar = findUpClassName(target, 'user-avatar');\r\n      if(!avatar) {\r\n        return;\r\n      }\r\n\r\n      const peerId = avatar.dataset.peerId.toPeerId();\r\n      if(peerId !== NULL_PEER_ID) {\r\n        this.chat.appImManager.setInnerPeer({peerId});\r\n      } else {\r\n        toast(I18n.format('HidAccount', true));\r\n      }\r\n      return;\r\n    }\r\n\r\n    if(bubble.classList.contains('is-date') && findUpClassName(target, 'bubble-content')) {\r\n      if(bubble.classList.contains('is-sticky') && !this.chatInner.classList.contains('is-scrolling')) {\r\n        return;\r\n      }\r\n\r\n      for(const timestamp in this.dateMessages) {\r\n        const d = this.dateMessages[timestamp];\r\n        if(d.div === bubble) {\r\n          PopupElement.createPopup(PopupDatePicker, new Date(+timestamp), this.onDatePick).show();\r\n          break;\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!IS_TOUCH_SUPPORTED && findUpClassName(target, 'time')) {\r\n      this.chat.selection.toggleByElement(bubble);\r\n      return;\r\n    }\r\n\r\n    // ! Trusted - due to audio autoclick\r\n    if(this.chat.selection.isSelecting && e.isTrusted) {\r\n      if(bubble.classList.contains('service') && bubble.dataset.mid === undefined) {\r\n        return;\r\n      }\r\n\r\n      cancelEvent(e);\r\n      //console.log('bubble click', e);\r\n\r\n      if(IS_TOUCH_SUPPORTED && this.chat.selection.selectedText) {\r\n        this.chat.selection.selectedText = undefined;\r\n        return;\r\n      }\r\n\r\n      //this.chatSelection.toggleByBubble(bubble);\r\n      this.chat.selection.toggleByElement(findUpClassName(target, 'grouped-item') || bubble);\r\n      return;\r\n    }\r\n\r\n    const contactDiv: HTMLElement = findUpClassName(target, 'contact');\r\n    if(contactDiv) {\r\n      this.chat.appImManager.setInnerPeer({\r\n        peerId: contactDiv.dataset.peerId.toPeerId()\r\n      });\r\n      return;\r\n    }\r\n\r\n    const callDiv: HTMLElement = findUpClassName(target, 'bubble-call');\r\n    if(callDiv) {\r\n      this.chat.appImManager.callUser(this.peerId.toUserId(), callDiv.dataset.type as any);\r\n      return;\r\n    }\r\n\r\n    const spoiler: HTMLElement = findUpClassName(target, 'spoiler');\r\n    if(spoiler) {\r\n      const messageDiv = findUpClassName(spoiler, 'message');\r\n\r\n      const className = 'is-spoiler-visible';\r\n      const isVisible = messageDiv.classList.contains(className);\r\n      if(!isVisible) {\r\n        cancelEvent(e);\r\n      }\r\n\r\n      const duration = 400 / 2;\r\n      const showDuration = 5000;\r\n      const useRafs = !isVisible ? 2 : 0;\r\n      if(useRafs) {\r\n        messageDiv.classList.add('will-change');\r\n      }\r\n\r\n      const spoilerTimeout = messageDiv.dataset.spoilerTimeout;\r\n      if(spoilerTimeout !== null) {\r\n        clearTimeout(+spoilerTimeout);\r\n        delete messageDiv.dataset.spoilerTimeout;\r\n      }\r\n\r\n      SetTransition(messageDiv, className, true, duration, () => {\r\n        messageDiv.dataset.spoilerTimeout = '' + window.setTimeout(() => {\r\n          SetTransition(messageDiv, className, false, duration, () => {\r\n            messageDiv.classList.remove('will-change');\r\n            delete messageDiv.dataset.spoilerTimeout;\r\n          });\r\n        }, showDuration);\r\n      }, useRafs);\r\n\r\n      return;\r\n    }\r\n\r\n    const reactionElement = findUpTag(target, 'REACTION-ELEMENT') as ReactionElement;\r\n    if(reactionElement) {\r\n      cancelEvent(e);\r\n      if(reactionElement.classList.contains('is-inactive')) {\r\n        return;\r\n      }\r\n\r\n      const reactionsElement = reactionElement.parentElement as ReactionsElement;\r\n      const reactionCount = reactionsElement.getReactionCount(reactionElement);\r\n\r\n      const message = reactionsElement.getMessage();\r\n      this.managers.appReactionsManager.sendReaction(message, reactionCount.reaction);\r\n\r\n      return;\r\n    }\r\n\r\n    const commentsDiv: HTMLElement = findUpClassName(target, 'replies');\r\n    if(commentsDiv) {\r\n      const bubbleMid = +bubble.dataset.mid;\r\n      if(this.peerId === REPLIES_PEER_ID) {\r\n        const message = await this.chat.getMessage(bubbleMid) as Message.message;\r\n        const peerId = getPeerId(message.reply_to.reply_to_peer_id);\r\n        const threadId = message.reply_to.reply_to_top_id;\r\n        const lastMsgId = message.fwd_from.saved_from_msg_id;\r\n        this.chat.appImManager.openThread(peerId, lastMsgId, threadId);\r\n      } else {\r\n        const message1 = await this.chat.getMessage(bubbleMid);\r\n        const message = await this.managers.appMessagesManager.getMessageWithReplies(message1 as Message.message);\r\n        const replies = message.replies;\r\n        if(replies) {\r\n          this.managers.appMessagesManager.getDiscussionMessage(this.peerId, message.mid).then((message) => {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId: replies.channel_id.toPeerId(true),\r\n              type: 'discussion', \r\n              threadId: (message as MyMessage).mid\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const via = findUpClassName(target, 'is-via');\r\n    if(via) {\r\n      const el = via.querySelector('.peer-title') as HTMLElement;\r\n      if(target === el || findUpAsChild(target, el)) {\r\n        const message = el.innerText + ' ';\r\n        this.managers.appDraftsManager.setDraft(this.peerId, this.chat.threadId, message);\r\n        cancelEvent(e);\r\n        \r\n        return;\r\n      }\r\n    }\r\n\r\n    const nameDiv = findUpClassName(target, 'peer-title') || findUpTag(target, 'AVATAR-ELEMENT') || findUpAttribute(target, 'data-saved-from');\r\n    if(nameDiv && nameDiv !== bubble) {\r\n      target = nameDiv || target;\r\n      const peerIdStr = target.dataset.peerId || target.getAttribute('peer') || (target as AvatarElement).peerId;\r\n      const savedFrom = target.dataset.savedFrom;\r\n      if(typeof(peerIdStr) === 'string' || savedFrom) {\r\n        if(savedFrom) {\r\n          const [peerId, mid] = savedFrom.split('_');\r\n  \r\n          this.chat.appImManager.setInnerPeer({\r\n            peerId: peerId.toPeerId(), \r\n            lastMsgId: +mid\r\n          });\r\n        } else {\r\n          const peerId = peerIdStr.toPeerId();\r\n          if(peerId !== NULL_PEER_ID) {\r\n            this.chat.appImManager.setInnerPeer({peerId});\r\n          } else {\r\n            toast(I18n.format('HidAccount', true));\r\n          }\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    //this.log('chatInner click:', target);\r\n    // const isVideoComponentElement = target.tagName === 'SPAN' && findUpClassName(target, 'media-container');\r\n    /* if(isVideoComponentElement) {\r\n      const video = target.parentElement.querySelector('video') as HTMLElement;\r\n      if(video) {\r\n        video.click(); // hot-fix for time and play button\r\n        return;\r\n      }\r\n    } */\r\n\r\n    if(bubble.classList.contains('sticker') && target.parentElement.classList.contains('attachment')) {\r\n      const messageId = +bubble.dataset.mid;\r\n      const message = await this.chat.getMessage(messageId);\r\n\r\n      const doc = ((message as Message.message).media as MessageMedia.messageMediaDocument)?.document as Document.document;\r\n\r\n      if(doc?.stickerSetInput) {\r\n        new PopupStickers(doc.stickerSetInput).show();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const documentDiv = findUpClassName(target, 'document-with-thumb');\r\n    if((target.tagName === 'IMG' && !target.classList.contains('emoji') && !target.classList.contains('document-thumb')) \r\n      || target.classList.contains('album-item')\r\n      // || isVideoComponentElement\r\n      || (target.tagName === 'VIDEO' && !bubble.classList.contains('round'))\r\n      || (documentDiv && !documentDiv.querySelector('.preloader-container'))\r\n      || target.classList.contains('canvas-thumbnail')) {\r\n      const groupedItem = findUpClassName(target, 'album-item') || findUpClassName(target, 'document-container');\r\n      const messageId = +(groupedItem || bubble).dataset.mid;\r\n      const message = await this.chat.getMessage(messageId);\r\n      if(!message) {\r\n        this.log.warn('no message by messageId:', messageId);\r\n        return;\r\n      }\r\n\r\n      const preloader = (groupedItem || bubble).querySelector<HTMLElement>('.preloader-container');\r\n      if(preloader) {\r\n        simulateClickEvent(preloader);\r\n        cancelEvent(e);\r\n        return;\r\n      }\r\n\r\n      const SINGLE_MEDIA_CLASSNAME = 'webpage';\r\n      const isSingleMedia = bubble.classList.contains(SINGLE_MEDIA_CLASSNAME);\r\n\r\n      const f = documentDiv ? (media: any) => {\r\n        return AppMediaViewer.isMediaCompatibleForDocumentViewer(media);\r\n      } : (media: any) => {\r\n        return media._ === 'photo' || ['video', 'gif'].includes(media.type);\r\n      };\r\n\r\n      const targets: {element: HTMLElement, mid: number, peerId: PeerId}[] = [];\r\n      const ids = isSingleMedia ? [messageId] : (await Promise.all(Object.keys(this.bubbles).map((k) => +k).map(async(mid) => {\r\n        /* if(isSingleMedia && !this.bubbles[id].classList.contains(SINGLE_MEDIA_CLASSNAME)) {\r\n          return false;\r\n        }  */\r\n        //if(!this.scrollable.visibleElements.find((e) => e.element === this.bubbles[id])) return false;\r\n\r\n        const message = await this.chat.getMessage(mid);\r\n        const media = getMediaFromMessage(message);\r\n        \r\n        return media && f(media) && mid;\r\n      }))).filter(Boolean).sort((a, b) => a - b);\r\n\r\n      ids.forEach((id) => {\r\n        let selector: string;\r\n        if(documentDiv) {\r\n          selector = '.document-container';\r\n        } else {\r\n          const withTail = this.bubbles[id].classList.contains('with-media-tail');\r\n          selector = '.album-item video, .album-item img, .preview video, .preview img, ';\r\n          if(withTail) {\r\n            selector += '.bubble__media-container';\r\n          } else {\r\n            selector += '.attachment video, .attachment img';\r\n          }\r\n        }\r\n\r\n        const elements = Array.from(this.bubbles[id].querySelectorAll(selector)) as HTMLElement[];\r\n        const parents: Set<HTMLElement> = new Set();\r\n        if(documentDiv) {\r\n          elements.forEach((element) => {\r\n            targets.push({\r\n              element: element.querySelector('.document-ico'),\r\n              mid: +element.dataset.mid,\r\n              peerId: this.peerId\r\n            });\r\n          });\r\n        } else {\r\n          const hasAspecter = !!this.bubbles[id].querySelector('.media-container-aspecter');\r\n          elements.forEach((element) => {\r\n            if(hasAspecter && !findUpClassName(element, 'media-container-aspecter')) return;\r\n            let albumItem = findUpClassName(element, 'album-item');\r\n            const parent = albumItem || element.parentElement;\r\n            if(parents.has(parent)) return;\r\n            parents.add(parent);\r\n            targets.push({\r\n              element,\r\n              mid: albumItem ? +albumItem.dataset.mid : id,\r\n              peerId: this.peerId\r\n            });\r\n          });\r\n        }\r\n      });\r\n\r\n      targets.sort((a, b) => a.mid - b.mid);\r\n\r\n      let idx = targets.findIndex((t) => t.mid === messageId);\r\n\r\n      if(DEBUG) {\r\n        this.log('open mediaViewer single with ids:', ids, idx, targets);\r\n      }\r\n\r\n      if(!targets[idx]) {\r\n        this.log('no target for media viewer!', target);\r\n        return;\r\n      }\r\n\r\n      new AppMediaViewer()\r\n      .setSearchContext({\r\n        threadId: this.chat.threadId,\r\n        peerId: this.peerId,\r\n        inputFilter: {_: documentDiv ? 'inputMessagesFilterDocument' : 'inputMessagesFilterPhotoVideo'},\r\n        useSearch: this.chat.type !== 'scheduled' && !isSingleMedia,\r\n        isScheduled: this.chat.type === 'scheduled'\r\n      })\r\n      .openMedia(message, targets[idx].element, 0, true, targets.slice(0, idx), targets.slice(idx + 1));\r\n      \r\n      cancelEvent(e);\r\n      //appMediaViewer.openMedia(message, target as HTMLImageElement);\r\n      return;\r\n    }\r\n    \r\n    if(['IMG', 'DIV', 'SPAN'/* , 'A' */].indexOf(target.tagName) === -1) target = findUpTag(target, 'DIV');\r\n    \r\n    if(['DIV', 'SPAN'].indexOf(target.tagName) !== -1/*  || target.tagName === 'A' */) {\r\n      if(target.classList.contains('goto-original')) {\r\n        const savedFrom = bubble.dataset.savedFrom;\r\n        const [peerId, mid] = savedFrom.split('_');\r\n        ////this.log('savedFrom', peerId, msgID);\r\n        this.chat.appImManager.setInnerPeer({\r\n          peerId: peerId.toPeerId(), \r\n          lastMsgId: +mid\r\n        });\r\n        return;\r\n      } else if(target.classList.contains('forward')) {\r\n        const mid = +bubble.dataset.mid;\r\n        const message = await this.managers.appMessagesManager.getMessageByPeer(this.peerId, mid);\r\n        new PopupForward({\r\n          [this.peerId]: await this.managers.appMessagesManager.getMidsByMessage(message)\r\n        });\r\n        //appSidebarRight.forwardTab.open([mid]);\r\n        return;\r\n      }\r\n      \r\n      let isReplyClick = false;\r\n      \r\n      try {\r\n        isReplyClick = !!findUpClassName(e.target, 'reply');\r\n      } catch(err) {}\r\n      \r\n      if(isReplyClick && bubble.classList.contains('is-reply')/*  || bubble.classList.contains('forwarded') */) {\r\n        const bubbleMid = +bubble.dataset.mid;\r\n        this.replyFollowHistory.push(bubbleMid);\r\n\r\n        const message = (await this.chat.getMessage(bubbleMid)) as Message.message;\r\n\r\n        const replyToPeerId = message.reply_to.reply_to_peer_id ? getPeerId(message.reply_to.reply_to_peer_id) : this.peerId;\r\n        const replyToMid = message.reply_to.reply_to_msg_id;\r\n\r\n        this.chat.appImManager.setInnerPeer({\r\n          peerId: replyToPeerId, \r\n          lastMsgId: replyToMid, \r\n          type: this.chat.type, \r\n          threadId: this.chat.threadId\r\n        });\r\n\r\n        /* if(this.chat.type === 'discussion') {\r\n          this.chat.appImManager.setMessageId(, originalMessageId);\r\n        } else {\r\n          this.chat.appImManager.setInnerPeer(this.peerId, originalMessageId);\r\n        } */\r\n        //this.chat.setMessageId(, originalMessageId);\r\n      }\r\n    }\r\n    \r\n    //console.log('chatInner click', e);\r\n  };\r\n\r\n  public async onGoDownClick() {\r\n    if(!this.replyFollowHistory.length) {\r\n      this.chat.setMessageId(/* , dialog.top_message */);\r\n      // const dialog = this.appMessagesManager.getDialogByPeerId(this.peerId)[0];\r\n      \r\n      // if(dialog) {\r\n      //   this.chat.setPeer(this.peerId/* , dialog.top_message */);\r\n      // } else {\r\n      //   this.log('will scroll down 3');\r\n      //   this.scroll.scrollTop = this.scroll.scrollHeight;\r\n      // }\r\n\r\n      return;\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n    const slice = this.replyFollowHistory.slice();\r\n    const messages = await Promise.all(slice.map((mid) => this.chat.getMessage(mid)));\r\n    if(!middleware()) return;\r\n\r\n    slice.forEach((mid, idx) => {\r\n      const message = messages[idx];\r\n\r\n      const bubble = this.bubbles[mid];\r\n      let bad = true;\r\n      if(bubble) {\r\n        const rect = bubble.getBoundingClientRect();\r\n        bad = (windowSize.height / 2) > rect.top;\r\n      } else if(message) {\r\n        bad = false;\r\n      }\r\n\r\n      if(bad) {\r\n        this.replyFollowHistory.splice(this.replyFollowHistory.indexOf(mid), 1);\r\n      }\r\n    });\r\n\r\n    this.replyFollowHistory.sort((a, b) => b - a);\r\n\r\n    const mid = this.replyFollowHistory.pop();\r\n    this.chat.setMessageId(mid);\r\n  }\r\n\r\n  public getBubbleByPoint(verticalSide: 'top' | 'bottom') {\r\n    let element = getElementByPoint(this.scrollable.container, verticalSide, 'center');\r\n    /* if(element) {\r\n      if(element.classList.contains('bubbles-date-group')) {\r\n        const children = Array.from(element.children) as HTMLElement[];\r\n        if(verticalSide === 'top') {\r\n          element = children[this.stickyIntersector ? 2 : 1];\r\n        } else {\r\n          element = children[children.length - 1];\r\n        }\r\n      } else {\r\n        element = findUpClassName(element, 'bubble');\r\n        if(element && element.classList.contains('is-date')) {\r\n          element = element.nextElementSibling as HTMLElement;\r\n        }\r\n      }\r\n    } */\r\n    if(element) element = findUpClassName(element, 'bubble');\r\n\r\n    return element;\r\n  }\r\n\r\n  public async getGroupedBubble(groupId: string) {\r\n    const mids = await this.managers.appMessagesManager.getMidsByAlbum(groupId);\r\n    for(const mid of mids) {\r\n      if(this.bubbles[mid] && !this.skippedMids.has(mid)) {\r\n        // const maxId = Math.max(...mids); // * because in scheduled album can be rendered by lowest mid during sending\r\n        return {\r\n          bubble: this.bubbles[mid], \r\n          mid: mid,\r\n          // message: await this.chat.getMessage(maxId) as Message.message\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  public getBubbleGroupedItems(bubble: HTMLElement) {\r\n    return Array.from(bubble.querySelectorAll('.grouped-item')) as HTMLElement[];\r\n  }\r\n\r\n  public async getMountedBubble(mid: number, message?: Message.message | Message.messageService) {\r\n    if(message === undefined) {\r\n      message = await this.chat.getMessage(mid);\r\n    }\r\n\r\n    if(!message) {\r\n      return;\r\n    }\r\n\r\n    const groupedId = (message as Message.message).grouped_id;\r\n    if(groupedId) {\r\n      const a = await this.getGroupedBubble(groupedId);\r\n      if(a) {\r\n        a.bubble = a.bubble.querySelector(`.document-container[data-mid=\"${mid}\"]`) || a.bubble;\r\n        return a;\r\n      }\r\n    }\r\n\r\n    const bubble = this.bubbles[mid];\r\n    if(!bubble) return;\r\n\r\n    return {bubble, mid};\r\n  }\r\n\r\n  private findNextMountedBubbleByMsgId(mid: number, prev?: boolean) {\r\n    const mids = getObjectKeysAndSort(this.bubbles, prev ? 'desc' : 'asc');\r\n\r\n    let filterCallback: (_mid: number) => boolean;\r\n    if(prev) filterCallback = (_mid) => _mid < mid;\r\n    else filterCallback = (_mid) => mid < _mid;\r\n\r\n    const foundMid = mids.find((_mid) => {\r\n      if(!filterCallback(_mid)) return false;\r\n      return !!this.bubbles[_mid]?.parentElement;\r\n    });\r\n\r\n    return this.bubbles[foundMid];\r\n  }\r\n\r\n  public loadMoreHistory(top: boolean, justLoad = false) {\r\n    // return;\r\n\r\n    //this.log('loadMoreHistory', top);\r\n    if(\r\n      !this.peerId || \r\n      /* TEST_SCROLL || */ \r\n      this.chat.setPeerPromise || \r\n      this.isHeavyAnimationInProgress || \r\n      (top && (this.getHistoryTopPromise || this.scrollable.loadedAll.top)) || \r\n      (!top && (this.getHistoryBottomPromise || this.scrollable.loadedAll.bottom))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    // warning, если иды только отрицательные то вниз не попадёт (хотя мб и так не попадёт)\r\n    // some messages can have negative id (such as sponsored message)\r\n    const history = Object.keys(this.bubbles)\r\n    .map((id) => +id)\r\n    .filter((id) => id > 0 && !this.skippedMids.has(id))\r\n    .sort((a, b) => a - b);\r\n    if(!history.length) return;\r\n    \r\n    if(top) {\r\n      if(DEBUG) {\r\n        this.log('Will load more (up) history by id:', history[0], 'maxId:', history[history.length - 1], justLoad/* , history */);\r\n      }\r\n\r\n      this.getHistory1(history[0], true, undefined, undefined, justLoad);\r\n    } else {\r\n      //let dialog = this.appMessagesManager.getDialogByPeerId(this.peerId)[0];\r\n      // const historyMaxId = await this.chat.getHistoryMaxId();\r\n          \r\n      // // if scroll down after search\r\n      // if(history.indexOf(historyMaxId) !== -1) {\r\n      //   this.setLoaded('bottom', true);\r\n      //   return;\r\n      // }\r\n\r\n      if(DEBUG) {\r\n        this.log('Will load more (down) history by id:', history[history.length - 1], justLoad/* , history */);\r\n      }\r\n\r\n      this.getHistory1(history[history.length - 1], false, true, undefined, justLoad);\r\n    }\r\n  }\r\n\r\n  public onScroll = (ignoreHeavyAnimation?: boolean, scrollDimensions?: ScrollStartCallbackDimensions) => {\r\n    //return;\r\n\r\n    if(this.isHeavyAnimationInProgress) {\r\n      if(this.sliceViewportDebounced) {\r\n        this.sliceViewportDebounced.clearTimeout();\r\n      }\r\n\r\n      // * В таком случае, кнопка не будет моргать если чат в самом низу, и правильно отработает случай написания нового сообщения и проскролла вниз\r\n      if(this.scrolledDown && !ignoreHeavyAnimation) {\r\n        return;\r\n      }\r\n    } else {\r\n      if(this.chat.topbar.pinnedMessage) {\r\n        this.chat.topbar.pinnedMessage.setCorrectIndexThrottled(this.scrollable.lastScrollDirection);\r\n      }\r\n  \r\n      if(this.sliceViewportDebounced) {\r\n        this.sliceViewportDebounced();\r\n      }\r\n  \r\n      this.setStickyDateManually();\r\n    }\r\n    \r\n    //lottieLoader.checkAnimations(false, 'chat');\r\n\r\n    if(scrollDimensions && scrollDimensions.distanceToEnd < SCROLLED_DOWN_THRESHOLD && this.scrolledDown) {\r\n      return;\r\n    }\r\n\r\n    const distanceToEnd = scrollDimensions?.distanceToEnd ?? this.scrollable.getDistanceToEnd();\r\n    if(/* !IS_TOUCH_SUPPORTED &&  */(this.scrollable.lastScrollDirection !== 0 && distanceToEnd > 0) || scrollDimensions) {\r\n    // if(/* !IS_TOUCH_SUPPORTED &&  */(this.scrollable.lastScrollDirection !== 0 || scrollDimensions) && distanceToEnd > 0) {\r\n      if(this.isScrollingTimeout) {\r\n        clearTimeout(this.isScrollingTimeout);\r\n      } else if(!this.chatInner.classList.contains('is-scrolling')) {\r\n        this.chatInner.classList.add('is-scrolling');\r\n      }\r\n  \r\n      this.isScrollingTimeout = window.setTimeout(() => {\r\n        this.chatInner.classList.remove('is-scrolling');\r\n        this.isScrollingTimeout = 0;\r\n      }, 1350 + (scrollDimensions?.duration ?? 0));\r\n    }\r\n    \r\n    if(distanceToEnd < SCROLLED_DOWN_THRESHOLD && (this.scrollable.loadedAll.bottom || this.chat.setPeerPromise || !this.peerId)) {\r\n      this.container.classList.add('scrolled-down');\r\n      this.scrolledDown = true;\r\n    } else if(this.container.classList.contains('scrolled-down')) {\r\n      this.container.classList.remove('scrolled-down');\r\n      this.scrolledDown = false;\r\n    }\r\n  };\r\n\r\n  public setScroll() {\r\n    if(this.scrollable) {\r\n      this.destroyScrollable();\r\n    }\r\n\r\n    this.scrollable = new Scrollable(null, 'IM', /* 10300 */300);\r\n    this.setLoaded('top', false, false);\r\n    this.setLoaded('bottom', false, false);\r\n\r\n    this.scrollable.container.append(this.chatInner);\r\n\r\n    /* const getScrollOffset = () => {\r\n      //return Math.round(Math.max(300, appPhotosManager.windowH / 1.5));\r\n      return 300; \r\n    };\r\n\r\n    window.addEventListener('resize', () => {\r\n      this.scrollable.onScrollOffset = getScrollOffset();\r\n    });\r\n\r\n    this.scrollable = new Scrollable(this.bubblesContainer, 'y', 'IM', this.chatInner, getScrollOffset()); */\r\n\r\n    this.scrollable.onAdditionalScroll = this.onScroll;\r\n    this.scrollable.onScrolledTop = () => this.loadMoreHistory(true);\r\n    this.scrollable.onScrolledBottom = () => this.loadMoreHistory(false);\r\n    //this.scrollable.attachSentinels(undefined, 300);\r\n\r\n    if(IS_TOUCH_SUPPORTED && false) {\r\n      this.scrollable.container.addEventListener('touchmove', () => {\r\n        if(this.isScrollingTimeout) {\r\n          clearTimeout(this.isScrollingTimeout);\r\n        } else if(!this.chatInner.classList.contains('is-scrolling')) {\r\n          this.chatInner.classList.add('is-scrolling');\r\n        }\r\n      }, {passive: true});\r\n\r\n      this.scrollable.container.addEventListener('touchend', () => {\r\n        if(!this.chatInner.classList.contains('is-scrolling')) {\r\n          return;\r\n        }\r\n\r\n        if(this.isScrollingTimeout) {\r\n          clearTimeout(this.isScrollingTimeout);\r\n        }\r\n\r\n        this.isScrollingTimeout = window.setTimeout(() => {\r\n          this.chatInner.classList.remove('is-scrolling');\r\n          this.isScrollingTimeout = 0;\r\n        }, 1350);\r\n      }, {passive: true});\r\n    }\r\n  }\r\n\r\n  public async updateUnreadByDialog() {\r\n    const historyStorage = await this.chat.getHistoryStorage();\r\n    const maxId = this.peerId === rootScope.myId ? historyStorage.readMaxId : historyStorage.readOutboxMaxId;\r\n    \r\n    ///////this.log('updateUnreadByDialog', maxId, dialog, this.unreadOut);\r\n    \r\n    for(const msgId of this.unreadOut) {\r\n      if(msgId > 0 && msgId <= maxId) {\r\n        const bubble = this.bubbles[msgId];\r\n        if(bubble) {\r\n          this.unreadOut.delete(msgId);\r\n\r\n          if(bubble.classList.contains('is-outgoing')) {\r\n            continue;\r\n          }\r\n          \r\n          bubble.classList.remove('is-sent', 'is-sending', 'is-outgoing'); // is-sending can be when there are bulk of updates (e.g. sending command to Stickers bot)\r\n          bubble.classList.add('is-read');\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  public deleteMessagesByIds(mids: number[], permanent = true, ignoreOnScroll?: boolean) {\r\n    let deleted = false;\r\n    mids.forEach((mid) => {\r\n      const bubble = this.bubbles[mid];\r\n      if(!bubble) return;\r\n      \r\n      deleted = true;\r\n      /* const mounted = this.getMountedBubble(mid);\r\n      if(!mounted) return; */\r\n\r\n      delete this.bubbles[mid];\r\n      this.skippedMids.delete(mid);\r\n\r\n      if(this.firstUnreadBubble === bubble) {\r\n        this.firstUnreadBubble = null;\r\n      }\r\n\r\n      this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n      if(this.observer) {\r\n        this.observer.unobserve(bubble, this.unreadedObserverCallback);\r\n        this.unreaded.delete(bubble);\r\n\r\n        this.observer.unobserve(bubble, this.viewsObserverCallback);\r\n        this.viewsMids.delete(mid);\r\n      }\r\n\r\n      if(this.emptyPlaceholderBubble === bubble) {\r\n        this.emptyPlaceholderBubble = undefined;\r\n      }\r\n\r\n      // this.reactions.delete(mid);\r\n    });\r\n\r\n    if(!deleted) {\r\n      return;\r\n    }\r\n\r\n    this.scrollable.ignoreNextScrollEvent();\r\n    if(permanent && this.chat.selection.isSelecting) {\r\n      this.chat.selection.deleteSelectedMids(this.peerId, mids);\r\n    }\r\n    \r\n    animationIntersector.checkAnimations(false, CHAT_ANIMATION_GROUP);\r\n    this.deleteEmptyDateGroups();\r\n\r\n    if(!ignoreOnScroll) {\r\n      this.scrollable.onScroll();\r\n      // this.onScroll();\r\n    }\r\n  }\r\n\r\n  private setTopPadding(middleware = this.getMiddleware()) {\r\n    let isPaddingNeeded = false;\r\n    let setPaddingTo: HTMLElement;\r\n    if(!this.isTopPaddingSet && this.chat.type !== 'scheduled') {\r\n      const {clientHeight, scrollHeight} = this.scrollable.container;\r\n      isPaddingNeeded = clientHeight === scrollHeight;\r\n      /* const firstEl = this.chatInner.firstElementChild as HTMLElement;\r\n      if(this.chatInner.firstElementChild) {\r\n        const visibleRect = getVisibleRect(firstEl, this.scrollable.container);\r\n        isPaddingNeeded = !visibleRect.overflow.top && (visibleRect.rect.top - firstEl.offsetTop) !== this.scrollable.container.getBoundingClientRect().top;\r\n      } else {\r\n        isPaddingNeeded = true;\r\n      } */\r\n\r\n      if(isPaddingNeeded) {\r\n        /* const add = clientHeight - scrollHeight;\r\n        this.chatInner.style.paddingTop = add + 'px';\r\n        this.scrollable.scrollTop += add; */\r\n        setPaddingTo = this.chatInner;\r\n        setPaddingTo.style.paddingTop = clientHeight + 'px';\r\n        this.scrollable.setScrollTopSilently(scrollHeight);\r\n        this.isTopPaddingSet = true;\r\n      }\r\n    }\r\n\r\n    return {\r\n      isPaddingNeeded,\r\n      unsetPadding: isPaddingNeeded ? () => {\r\n        if(middleware() && isPaddingNeeded) {\r\n          setPaddingTo.style.paddingTop = '';\r\n          this.isTopPaddingSet = false;\r\n        }\r\n      } : undefined\r\n    };\r\n  }\r\n\r\n  private renderNewMessage(message: MyMessage, scrolledDown?: boolean) {\r\n    const promise = this._renderNewMessage(message, scrolledDown);\r\n    this.renderNewPromises.add(promise);\r\n    promise.catch(noop).finally(() => {\r\n      this.renderNewPromises.delete(promise);\r\n    });\r\n    return promise;\r\n  }\r\n  \r\n  private async _renderNewMessage(message: MyMessage, scrolledDown?: boolean) {\r\n    if(!this.scrollable.loadedAll.bottom) { // seems search active or sliced\r\n      //this.log('renderNewMessagesByIds: seems search is active, skipping render:', mids);\r\n      const setPeerPromise = this.chat.setPeerPromise;\r\n      if(setPeerPromise) {\r\n        const middleware = this.getMiddleware();\r\n        setPeerPromise.then(async() => {\r\n          if(!middleware()) return;\r\n          const newMessage = await this.chat.getMessage(message.mid);\r\n          if(!middleware()) return;\r\n          this.renderNewMessage(newMessage);\r\n        });\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(this.chat.threadId) {\r\n      const replyTo = message?.reply_to as MessageReplyHeader;\r\n      if(!(replyTo && (replyTo.reply_to_top_id || replyTo.reply_to_msg_id) === this.chat.threadId)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(this.bubbles[message.mid]) {\r\n      return;\r\n    }\r\n    // ! should scroll even without new messages\r\n    /* if(!mids.length) {\r\n      return;\r\n    } */\r\n\r\n    if(!scrolledDown) {\r\n      scrolledDown = this.scrolledDown && (\r\n        !this.scrollingToBubble || \r\n        this.scrollingToBubble === this.getLastBubble() || \r\n        this.scrollingToBubble === this.chatInner\r\n      );\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n    const {isPaddingNeeded, unsetPadding} = this.setTopPadding(middleware);\r\n\r\n    const promise = this.performHistoryResult({history: [message]}, false);\r\n    if(scrolledDown) {\r\n      promise.then(() => {\r\n        if(!middleware()) return;\r\n        //this.log('renderNewMessagesByIDs: messagesQueuePromise after', this.scrollable.isScrolledDown);\r\n        //this.scrollable.scrollTo(this.scrollable.scrollHeight, 'top', true, true, 5000);\r\n        //const bubble = this.bubbles[Math.max(...mids)];\r\n\r\n        let bubble: HTMLElement;\r\n        if(this.chat.type === 'scheduled') {\r\n          bubble = this.bubbles[message.mid];\r\n        }\r\n\r\n        const promise = bubble ? this.scrollToBubbleEnd(bubble) : this.scrollToEnd();\r\n        if(isPaddingNeeded) {\r\n          // it will be called only once even if was set multiple times (that won't happen)\r\n          promise.then(unsetPadding);\r\n        }\r\n\r\n        //this.scrollable.scrollIntoViewNew(this.chatInner, 'end');\r\n\r\n        /* setTimeout(() => {\r\n          this.log('messagesQueuePromise afterafter:', this.chatInner.childElementCount, this.scrollable.scrollHeight);\r\n        }, 10); */\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public getLastBubble() {\r\n    const group = this.bubbleGroups.getLastGroup();\r\n    return group?.lastItem?.bubble;\r\n  }\r\n\r\n  public scrollToBubble(\r\n    element: HTMLElement, \r\n    position: ScrollLogicalPosition,\r\n    forceDirection?: FocusDirection,\r\n    forceDuration?: number\r\n  ) {\r\n    const bubble = findUpClassName(element, 'bubble');\r\n\r\n    if(!element.parentElement) {\r\n      this.log.error('element is not connected', bubble);\r\n    }\r\n\r\n    let fallbackToElementStartWhenCentering: HTMLElement;\r\n    // * if it's a start, then scroll to start of the group\r\n    if(bubble && position !== 'end') {\r\n      const item = this.bubbleGroups.getItemByBubble(bubble);\r\n      if(item.group.firstItem === item && whichChild(item.group.container) === (this.stickyIntersector ? STICKY_OFFSET : 1)) {\r\n        const dateGroup = item.group.container.parentElement;\r\n        // if(whichChild(dateGroup) === 0) {\r\n          fallbackToElementStartWhenCentering = dateGroup;\r\n          // position = 'start';\r\n          // element = dateGroup;\r\n        // }\r\n      }\r\n    }\r\n\r\n    // const isLastBubble = this.getLastBubble() === bubble;\r\n    /* if(isLastBubble) {\r\n      element = this.getLastDateGroup();\r\n    } */\r\n\r\n    let margin = 4; // * 4 = .25rem\r\n    /* if(isLastBubble && this.chat.type === 'chat' && this.bubblesContainer.classList.contains('is-chat-input-hidden')) {\r\n      margin = 20;\r\n    } */\r\n\r\n    const isChangingHeight = (this.chat.input.messageInput && this.chat.input.messageInput.classList.contains('is-changing-height')) || this.chat.container.classList.contains('is-toggling-helper');\r\n    const promise = this.scrollable.scrollIntoViewNew({\r\n      element, \r\n      position, \r\n      margin, \r\n      forceDirection, \r\n      forceDuration, \r\n      axis: 'y', \r\n      getNormalSize: isChangingHeight ? ({rect}) => {\r\n        // return rect.height;\r\n\r\n        let height = windowSize.height;\r\n        // height -= this.chat.topbar.container.getBoundingClientRect().height;\r\n        height -= this.container.offsetTop;\r\n        height -= mediaSizes.isMobile || windowSize.height < 570 ? 58 : 78;\r\n        return height;\r\n\r\n        /* const rowsWrapperHeight = this.chat.input.rowsWrapper.getBoundingClientRect().height;\r\n        const diff = rowsWrapperHeight - 54;\r\n        return rect.height + diff; */\r\n      } : undefined,\r\n      fallbackToElementStartWhenCentering,\r\n      startCallback: (dimensions) => {\r\n        // this.onScroll(true, this.scrolledDown && dimensions.distanceToEnd <= SCROLLED_DOWN_THRESHOLD ? undefined : dimensions);\r\n        this.onScroll(true, dimensions);\r\n      }\r\n    });\r\n\r\n    // fix flickering date when opening unread chat and focusing message\r\n    if(forceDirection === FocusDirection.Static) {\r\n      this.scrollable.lastScrollPosition = this.scrollable.scrollTop;\r\n    }\r\n    \r\n    return promise;\r\n  }\r\n\r\n  public scrollToEnd() {\r\n    return this.scrollToBubbleEnd(this.chatInner);\r\n  }\r\n\r\n  public async scrollToBubbleEnd(bubble: HTMLElement) {\r\n    /* if(DEBUG) {\r\n      this.log('scrollToNewLastBubble: will scroll into view:', bubble);\r\n    } */\r\n\r\n    if(bubble) {\r\n      this.scrollingToBubble = bubble;\r\n      const middleware = this.getMiddleware();\r\n      await this.scrollToBubble(bubble, 'end', undefined, undefined);\r\n      if(!middleware()) return;\r\n      this.scrollingToBubble = undefined;\r\n    }\r\n  }\r\n\r\n  // ! can't get it by chatInner.lastElementChild because placeholder can be the last...\r\n  // private getLastDateGroup() {\r\n  //   let lastTime = 0, lastElem: HTMLElement;\r\n  //   for(const i in this.dateMessages) {\r\n  //     const dateMessage = this.dateMessages[i];\r\n  //     if(dateMessage.firstTimestamp > lastTime) {\r\n  //       lastElem = dateMessage.container;\r\n  //       lastTime = dateMessage.firstTimestamp;\r\n  //     }\r\n  //   }\r\n\r\n  //   return lastElem;\r\n  // }\r\n\r\n  public async scrollToBubbleIfLast(bubble: HTMLElement) {\r\n    if(this.getLastBubble() === bubble) {\r\n      // return this.scrollToBubbleEnd(bubble);\r\n      return this.scrollToEnd();\r\n    }\r\n  }\r\n\r\n  public highlightBubble(element: HTMLElement) {\r\n    const datasetKey = 'highlightTimeout';\r\n    if(element.dataset[datasetKey]) {\r\n      clearTimeout(+element.dataset[datasetKey]);\r\n      element.classList.remove('is-highlighted');\r\n      void element.offsetWidth; // reflow\r\n    }\r\n\r\n    element.classList.add('is-highlighted');\r\n    element.dataset[datasetKey] = '' + setTimeout(() => {\r\n      element.classList.remove('is-highlighted');\r\n      delete element.dataset[datasetKey];\r\n    }, 2000);\r\n  }\r\n\r\n  private createDateBubble(timestamp: number, date: Date = new Date(timestamp * 1000)) {\r\n    let dateElement: HTMLElement;\r\n      \r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n\r\n    const isScheduled = this.chat.type === 'scheduled';\r\n    \r\n    if(today.getTime() === date.getTime()) {\r\n      dateElement = i18n(isScheduled ? 'Chat.Date.ScheduledForToday' : 'Date.Today');\r\n    } else if(isScheduled && timestamp === SEND_WHEN_ONLINE_TIMESTAMP) {\r\n      dateElement = i18n('MessageScheduledUntilOnline');\r\n    } else {\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        day: 'numeric',\r\n        month: 'long'\r\n      };\r\n\r\n      if(date.getFullYear() !== today.getFullYear()) {\r\n        options.year = 'numeric';\r\n      }\r\n\r\n      dateElement = new I18n.IntlDateElement({\r\n        date,\r\n        options\r\n      }).element;\r\n\r\n      if(isScheduled) {\r\n        dateElement = i18n('Chat.Date.ScheduledFor', [dateElement]);\r\n      }\r\n    }\r\n    \r\n    const bubble = document.createElement('div');\r\n    bubble.className = 'bubble service is-date';\r\n    const bubbleContent = document.createElement('div');\r\n    bubbleContent.classList.add('bubble-content');\r\n    const serviceMsg = document.createElement('div');\r\n    serviceMsg.classList.add('service-msg');\r\n\r\n    serviceMsg.append(dateElement);\r\n\r\n    bubbleContent.append(serviceMsg);\r\n    bubble.append(bubbleContent);\r\n\r\n    return bubble;\r\n  }\r\n\r\n  public getDateForDateContainer(timestamp: number) {\r\n    const date = new Date(timestamp * 1000);\r\n    date.setHours(0, 0, 0);\r\n    return {date, dateTimestamp: date.getTime()};\r\n  }\r\n\r\n  public getDateContainerByTimestamp(timestamp: number) {\r\n    const {date, dateTimestamp} = this.getDateForDateContainer(timestamp);\r\n    if(!this.dateMessages[dateTimestamp]) {\r\n      const bubble = this.createDateBubble(timestamp, date);\r\n      // bubble.classList.add('is-sticky');\r\n      const fakeBubble = this.createDateBubble(timestamp, date);\r\n      fakeBubble.classList.add('is-fake');\r\n\r\n      const container = document.createElement('section');\r\n      container.className = 'bubbles-date-group';\r\n      container.append(bubble, fakeBubble);\r\n\r\n      this.dateMessages[dateTimestamp] = {\r\n        div: bubble,\r\n        container,\r\n        firstTimestamp: date.getTime()\r\n      };\r\n\r\n      const haveTimestamps = getObjectKeysAndSort(this.dateMessages, 'asc');\r\n      let i = 0, length = haveTimestamps.length, insertBefore: HTMLElement; // there can be 'first bubble' (e.g. bot description) so can't insert by index\r\n      for(; i < haveTimestamps.length; ++i) {\r\n        const t = haveTimestamps[i];\r\n        insertBefore = this.dateMessages[t].container;\r\n        if(dateTimestamp < t) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if(i === length && insertBefore) {\r\n        insertBefore = insertBefore.nextElementSibling as HTMLElement;\r\n      }\r\n\r\n      if(!insertBefore) {\r\n        this.chatInner.append(container);\r\n      } else {\r\n        this.chatInner.insertBefore(container, insertBefore);\r\n      }\r\n\r\n      if(this.stickyIntersector) {\r\n        this.stickyIntersector.observeStickyHeaderChanges(container);\r\n      }\r\n\r\n      if(this.chatInner.parentElement) {\r\n        this.container.classList.add('has-groups');\r\n      }\r\n    }\r\n\r\n    return this.dateMessages[dateTimestamp];\r\n  }\r\n\r\n  private destroyScrollable() {\r\n    this.scrollable.removeListeners();\r\n    this.scrollable.onScrolledTop = this.scrollable.onScrolledBottom = this.scrollable.onAdditionalScroll = null;\r\n  }\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Bubbles destroying');\r\n\r\n    this.destroyScrollable();\r\n\r\n    this.listenerSetter.removeAll();\r\n\r\n    this.lazyLoadQueue.clear();\r\n    this.observer && this.observer.disconnect();\r\n    this.stickyIntersector && this.stickyIntersector.disconnect();\r\n\r\n    delete this.lazyLoadQueue;\r\n    this.observer && delete this.observer;\r\n    this.stickyIntersector && delete this.stickyIntersector;\r\n  }\r\n\r\n  public cleanup(bubblesToo = false) {\r\n    this.bubbles = {}; // clean it before so sponsored message won't be deleted faster on peer changing\r\n    ////console.time('appImManager cleanup');\r\n    this.setLoaded('top', false, false);\r\n    this.setLoaded('bottom', false, false);\r\n\r\n    // cancel scroll\r\n    cancelAnimationByKey(this.scrollable.container);\r\n\r\n    // do not wait ending of previous scale animation\r\n    interruptHeavyAnimation();\r\n\r\n    if(TEST_SCROLL !== undefined) {\r\n      TEST_SCROLL = TEST_SCROLL_TIMES;\r\n    }\r\n\r\n    this.skippedMids.clear();\r\n    this.dateMessages = {};\r\n    this.bubbleGroups.cleanup();\r\n    this.unreadOut.clear();\r\n    this.needUpdate.length = 0;\r\n    this.lazyLoadQueue.clear();\r\n    this.renderNewPromises.clear();\r\n    \r\n    // clear messages\r\n    if(bubblesToo) {\r\n      this.scrollable.container.textContent = '';\r\n      this.cleanupPlaceholders();\r\n    }\r\n    \r\n    this.firstUnreadBubble = null;\r\n    this.attachedUnreadBubble = false;\r\n    \r\n    this.messagesQueue.length = 0;\r\n    this.messagesQueuePromise = null;\r\n    \r\n    this.getHistoryTopPromise = this.getHistoryBottomPromise = undefined;\r\n    this.fetchNewPromise = undefined;\r\n    this.getSponsoredMessagePromise = undefined;\r\n    \r\n    if(this.stickyIntersector) {\r\n      this.stickyIntersector.disconnect();\r\n    }\r\n    \r\n    if(this.observer) {\r\n      this.observer.disconnect();\r\n\r\n      this.unreaded.clear();\r\n      this.unreadedSeen.clear();\r\n      this.readPromise = undefined;\r\n\r\n      this.viewsMids.clear();\r\n    }\r\n\r\n    this.middleware.clean();\r\n    \r\n    this.onAnimateLadder = undefined;\r\n    this.resolveLadderAnimation = undefined;\r\n    this.attachPlaceholderOnRender = undefined;\r\n    this.emptyPlaceholderBubble = undefined;\r\n    this.sponsoredMessage = undefined;\r\n    this.previousStickyDate = undefined;\r\n\r\n    this.scrollingToBubble = undefined;\r\n    ////console.timeEnd('appImManager cleanup');\r\n\r\n    this.isTopPaddingSet = false;\r\n\r\n    this.renderingMessages.clear();\r\n    this.bubblesToEject.clear();\r\n    this.bubblesToReplace.clear();\r\n\r\n    // this.reactions.clear();\r\n\r\n    if(this.isScrollingTimeout) {\r\n      clearTimeout(this.isScrollingTimeout);\r\n      this.isScrollingTimeout = 0;\r\n    }\r\n\r\n    this.container.classList.remove('has-sticky-dates');\r\n    this.scrollable.cancelMeasure();\r\n  }\r\n\r\n  private cleanupPlaceholders(bubble = this.emptyPlaceholderBubble) {\r\n    if(bubble) {\r\n      bubble.remove();\r\n\r\n      if(this.emptyPlaceholderBubble === bubble) {\r\n        this.emptyPlaceholderBubble = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  public async setPeer(samePeer: boolean, peerId: PeerId, lastMsgId?: number, startParam?: string): Promise<{cached?: boolean, promise: Chat['setPeerPromise']}> {\r\n    const tempId = ++this.setPeerTempId;\r\n\r\n    if(!peerId) {\r\n      this.cleanup(true);\r\n      this.preloader.detach();\r\n      return null;\r\n    }\r\n\r\n    const perf = performance.now();\r\n    const log = this.log.bindPrefix('setPeer');\r\n    log.warn('start');\r\n\r\n    const middleware = () => {\r\n      return this.setPeerTempId === tempId;\r\n    };\r\n\r\n    const m = middlewarePromise(middleware, PEER_CHANGED_ERROR);\r\n\r\n    if(!samePeer) {\r\n      await m(this.chat.onChangePeer(m));\r\n    }\r\n\r\n    /* if(samePeer && this.chat.setPeerPromise) {\r\n      return {cached: true, promise: this.chat.setPeerPromise};\r\n    } */\r\n\r\n    const chatType = this.chat.type;\r\n\r\n    if(chatType === 'scheduled' || this.chat.isRestricted) {\r\n      lastMsgId = 0;\r\n    }\r\n\r\n    const historyStorage = await m(this.chat.getHistoryStorage());\r\n    let topMessage = chatType === 'pinned' ? await m(this.managers.appMessagesManager.getPinnedMessagesMaxId(peerId)) : historyStorage.maxId ?? 0;\r\n    const isTarget = lastMsgId !== undefined;\r\n\r\n    // * this one will fix topMessage for null message in history (e.g. channel comments with only 1 comment and it is a topMessage)\r\n    /* if(chatType !== 'pinned' && topMessage && !historyStorage.history.slice.includes(topMessage)) {\r\n      topMessage = 0;\r\n    } */\r\n\r\n    let followingUnread: boolean;\r\n    let readMaxId = 0, savedPosition: ReturnType<AppImManager['getChatSavedPosition']>, overrideAdditionMsgId: number;\r\n    if(!isTarget) {\r\n      if(!samePeer) {\r\n        savedPosition = this.chat.appImManager.getChatSavedPosition(this.chat);\r\n      }\r\n\r\n      if(savedPosition) {\r\n        \r\n      } else if(topMessage) {\r\n        readMaxId = await m(this.managers.appMessagesManager.getReadMaxIdIfUnread(peerId, this.chat.threadId));\r\n        const dialog = await m(this.managers.appMessagesManager.getDialogOnly(peerId));\r\n        if(/* dialog.unread_count */readMaxId && !samePeer && (!dialog || dialog.unread_count !== 1)) {\r\n          const foundSlice = historyStorage.history.findSliceOffset(readMaxId);\r\n          if(foundSlice && foundSlice.slice.isEnd(SliceEnd.Bottom)) {\r\n            overrideAdditionMsgId = foundSlice.slice[foundSlice.offset - 25] || foundSlice.slice[0] || readMaxId;\r\n          }\r\n\r\n          followingUnread = !isTarget;\r\n          lastMsgId = readMaxId;\r\n        } else {\r\n          lastMsgId = topMessage;\r\n          //lastMsgID = topMessage;\r\n        }\r\n      }\r\n    }\r\n\r\n    const isJump = lastMsgId !== topMessage/*  && overrideAdditionMsgId === undefined */;\r\n\r\n    if(startParam === undefined && await m(this.chat.isStartButtonNeeded())) {\r\n      startParam = BOT_START_PARAM;\r\n    }\r\n\r\n    if(samePeer) {\r\n      const mounted = await m(this.getMountedBubble(lastMsgId));\r\n      if(mounted) {\r\n        if(isTarget) {\r\n          this.scrollToBubble(mounted.bubble, 'center');\r\n          this.highlightBubble(mounted.bubble);\r\n          this.chat.dispatchEvent('setPeer', lastMsgId, false);\r\n        } else if(topMessage && !isJump) {\r\n          //log('will scroll down', this.scroll.scrollTop, this.scroll.scrollHeight);\r\n          // scrollable.setScrollTopSilently(scrollable.scrollHeight);\r\n          this.scrollToEnd();\r\n          this.chat.dispatchEvent('setPeer', lastMsgId, true);\r\n        }\r\n\r\n        if(startParam !== undefined) {\r\n          this.chat.input.setStartParam(startParam);\r\n        }\r\n        \r\n        return null;\r\n      }\r\n    } else {\r\n      if(this.peerId) { // * set new queue id if new peer (setting not from 0)\r\n        this.lazyLoadQueue.queueId = ++queueId;\r\n        this.managers.apiFileManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId);\r\n      }\r\n\r\n      this.replyFollowHistory.length = 0;\r\n\r\n      this.passEntities = {\r\n        messageEntityBotCommand: await m(this.managers.appPeersManager.isAnyGroup(peerId)) || await m(this.managers.appUsersManager.isBot(peerId))\r\n      };\r\n    }\r\n\r\n    if(DEBUG) {\r\n      log('setPeer peerId:', peerId, historyStorage, lastMsgId, topMessage);\r\n    }\r\n\r\n    // add last message, bc in getHistory will load < max_id\r\n    const additionMsgId = overrideAdditionMsgId ?? (isJump || chatType === 'scheduled' || this.chat.isRestricted ? 0 : topMessage);\r\n\r\n    let maxBubbleId = 0;\r\n    if(samePeer) {\r\n      let el = this.getBubbleByPoint('bottom'); // ! this may not work if being called when chat is hidden\r\n      //this.chat.log('[PM]: setCorrectIndex: get last element perf:', performance.now() - perf, el);\r\n      if(el) {\r\n        maxBubbleId = +el.dataset.mid;\r\n      }\r\n\r\n      if(maxBubbleId <= 0) {\r\n        maxBubbleId = Math.max(...Object.keys(this.bubbles).map((mid) => +mid));\r\n      }\r\n    } else {\r\n      this.isFirstLoad = true;\r\n      this.destroyResizeObserver();\r\n    }\r\n\r\n    const oldChatInner = this.chatInner;\r\n    const oldPlaceholderBubble = this.emptyPlaceholderBubble;\r\n    this.cleanup();\r\n    const chatInner = this.chatInner = document.createElement('div');\r\n    if(samePeer) {\r\n      chatInner.className = oldChatInner.className;\r\n      chatInner.classList.remove('disable-hover', 'is-scrolling');\r\n    } else {\r\n      chatInner.classList.add('bubbles-inner');\r\n    }\r\n\r\n    this.lazyLoadQueue.lock();\r\n\r\n    // const haveToScrollToBubble = (topMessage && (isJump || samePeer)) || isTarget;\r\n    const haveToScrollToBubble = samePeer || (topMessage && isJump) || isTarget;\r\n    const fromUp = maxBubbleId > 0 && (!lastMsgId || maxBubbleId < lastMsgId || lastMsgId < 0);\r\n    const scrollFromDown = !fromUp && samePeer;\r\n    const scrollFromUp = !scrollFromDown && fromUp/*  && (samePeer || forwardingUnread) */;\r\n    this.willScrollOnLoad = scrollFromDown || scrollFromUp;\r\n\r\n    this.setPeerOptions = {\r\n      lastMsgId,\r\n      topMessage\r\n    };\r\n\r\n    let result: Awaited<ReturnType<ChatBubbles['getHistory']>>;\r\n    if(!savedPosition) {\r\n      result = await m(this.getHistory1(lastMsgId, true, isJump, additionMsgId));\r\n    } else {\r\n      result = {\r\n        promise: getHeavyAnimationPromise().then(() => {\r\n          return this.performHistoryResult({history: savedPosition.mids}, true);\r\n        }) as any,\r\n        cached: true,\r\n        waitPromise: Promise.resolve()\r\n      };\r\n    }\r\n\r\n    this.setPeerCached = result.cached;\r\n\r\n    log.warn('got history');// warning\r\n\r\n    const {promise, cached} = result;\r\n\r\n    if(!cached && !samePeer) {\r\n      await m(this.chat.finishPeerChange(isTarget, isJump, lastMsgId, startParam));\r\n      this.scrollable.container.textContent = '';\r\n      // oldContainer.textContent = '';\r\n      //oldChatInner.remove();\r\n      this.preloader.attach(this.container);\r\n    }\r\n\r\n    /* this.ladderDeferred && this.ladderDeferred.resolve();\r\n    this.ladderDeferred = deferredPromise<void>(); */\r\n\r\n    animationIntersector.lockGroup(CHAT_ANIMATION_GROUP);\r\n    const setPeerPromise = m(promise).then(async() => {\r\n      log.warn('promise fulfilled');\r\n\r\n      let mountedByLastMsgId = haveToScrollToBubble ? await m(lastMsgId ? this.getMountedBubble(lastMsgId) : {bubble: this.getLastBubble()}) : undefined;\r\n      if(cached && !samePeer) {\r\n        log.warn('finishing peer change');\r\n        await m(this.chat.finishPeerChange(isTarget, isJump, lastMsgId, startParam)); // * костыль\r\n        log.warn('finished peer change');\r\n      }\r\n\r\n      this.preloader.detach();\r\n\r\n      if(this.resolveLadderAnimation) {\r\n        this.resolveLadderAnimation();\r\n        this.resolveLadderAnimation = undefined;\r\n      }\r\n\r\n      this.setPeerCached = undefined;\r\n\r\n      // this.ladderDeferred.resolve();\r\n\r\n      const scrollable = this.scrollable;\r\n      scrollable.lastScrollDirection = 0;\r\n      scrollable.lastScrollPosition = 0;\r\n      replaceContent(scrollable.container, chatInner);\r\n      // this.chat.topbar.container.nextElementSibling.replaceWith(container);\r\n\r\n      if(oldPlaceholderBubble) {\r\n        this.cleanupPlaceholders(oldPlaceholderBubble);\r\n      }\r\n\r\n      if(this.attachPlaceholderOnRender) {\r\n        this.attachPlaceholderOnRender();\r\n      }\r\n\r\n      if(!isTarget && this.chat.type === 'chat') {\r\n        this.chat.topbar.pinnedMessage.setCorrectIndex(0);\r\n      }\r\n\r\n      this.container.classList.toggle('has-groups', !!Object.keys(this.dateMessages).length);\r\n\r\n      log.warn('mounted chat', this.chatInner === chatInner, this.chatInner.parentElement, performance.now() - perf);\r\n\r\n      animationIntersector.unlockGroup(CHAT_ANIMATION_GROUP);\r\n      animationIntersector.checkAnimations(false, CHAT_ANIMATION_GROUP/* , true */);\r\n\r\n      //fastRaf(() => {\r\n        this.lazyLoadQueue.unlock();\r\n      //});\r\n\r\n      //if(dialog && lastMsgID && lastMsgID !== topMessage && (this.bubbles[lastMsgID] || this.firstUnreadBubble)) {\r\n      if(savedPosition) {\r\n        scrollable.setScrollTopSilently(savedPosition.top);\r\n        /* const mountedByLastMsgId = this.getMountedBubble(lastMsgId);\r\n        let bubble: HTMLElement = mountedByLastMsgId?.bubble;\r\n        if(!bubble?.parentElement) {\r\n          bubble = this.findNextMountedBubbleByMsgId(lastMsgId);\r\n        }\r\n\r\n        if(bubble) {\r\n          const top = bubble.getBoundingClientRect().top;\r\n          const distance = savedPosition.top - top;\r\n          scrollable.scrollTop += distance;\r\n        } */\r\n      } else if(haveToScrollToBubble) {\r\n        let unsetPadding: () => void;\r\n        if(scrollFromDown) {\r\n          scrollable.setScrollTopSilently(99999);\r\n        } else if(scrollFromUp) {\r\n          const set = this.setTopPadding();\r\n          if(set.isPaddingNeeded) {\r\n            unsetPadding = set.unsetPadding;\r\n          }\r\n\r\n          scrollable.setScrollTopSilently(0);\r\n        }\r\n\r\n        // const mountedByLastMsgId = lastMsgId ? this.getMountedBubble(lastMsgId) : {bubble: this.getLastBubble()};\r\n        let bubble: HTMLElement = (followingUnread && this.firstUnreadBubble) || mountedByLastMsgId?.bubble;\r\n        if(!bubble?.parentElement) {\r\n          bubble = this.findNextMountedBubbleByMsgId(lastMsgId, false) || this.findNextMountedBubbleByMsgId(lastMsgId, true);\r\n        }\r\n        \r\n        let promise: Promise<void>;\r\n        // ! sometimes there can be no bubble\r\n        if(bubble) {\r\n          const lastBubble = this.getLastBubble();\r\n          const position: ScrollLogicalPosition = followingUnread ? 'start' : (!isJump && !isTarget && lastBubble === bubble ? 'end' : 'center');\r\n\r\n          if(position === 'end' && lastBubble === bubble && samePeer) {\r\n            promise = this.scrollToEnd();\r\n          } else {\r\n            promise = this.scrollToBubble(bubble, position, !samePeer ? FocusDirection.Static : undefined);\r\n          }\r\n\r\n          if(!followingUnread && isTarget) {\r\n            this.highlightBubble(bubble);\r\n          }\r\n        }\r\n\r\n        if(unsetPadding) {\r\n          (promise || Promise.resolve()).then(() => {\r\n            unsetPadding();\r\n          });\r\n        }\r\n      } else {\r\n        scrollable.setScrollTopSilently(99999);\r\n      }\r\n\r\n      // if(!cached) {\r\n        this.onRenderScrollSet();\r\n      // }\r\n\r\n      this.onScroll();\r\n\r\n      const afterSetPromise = Promise.all([setPeerPromise, getHeavyAnimationPromise()]);\r\n      afterSetPromise.then(() => { // check whether list isn't full\r\n        scrollable.checkForTriggers();\r\n\r\n        // if(cached) {\r\n          // this.onRenderScrollSet();\r\n        // }\r\n      });\r\n\r\n      this.chat.dispatchEvent('setPeer', lastMsgId, !isJump);\r\n\r\n      Promise.all([\r\n        this.setFetchReactionsInterval(afterSetPromise),\r\n        this.setFetchHistoryInterval({\r\n          afterSetPromise,\r\n          lastMsgId,\r\n          samePeer,\r\n          savedPosition,\r\n          topMessage\r\n        }),\r\n      ]).then(() => {\r\n        log('scrolledAllDown:', scrollable.loadedAll.bottom);\r\n        //if(!this.unreaded.length && dialog) { // lol\r\n        if(scrollable.loadedAll.bottom && topMessage && !this.unreaded.size) { // lol\r\n          this.onScrolledAllDown();\r\n        }\r\n      });\r\n\r\n      if(chatType === 'chat') {\r\n        const dialog = await m(this.managers.appMessagesManager.getDialogOnly(peerId));\r\n        if(dialog?.pFlags.unread_mark) {\r\n          this.managers.appMessagesManager.markDialogUnread(peerId, true);\r\n        }\r\n      }\r\n\r\n      //this.chatInner.classList.remove('disable-hover', 'is-scrolling'); // warning, performance!\r\n    }).catch((err) => {\r\n      log.error('getHistory promise error:', err);\r\n      if(!middleware()) {\r\n        this.preloader.detach();\r\n      }\r\n\r\n      throw err;\r\n    });\r\n\r\n    return {cached, promise: setPeerPromise};\r\n  }\r\n\r\n  private async setFetchReactionsInterval(afterSetPromise: Promise<any>) {\r\n    const middleware = this.getMiddleware();\r\n    const needReactionsInterval = await this.managers.appPeersManager.isChannel(this.peerId);\r\n    if(needReactionsInterval) {\r\n      const fetchReactions = async() => {\r\n        if(!middleware()) return;\r\n\r\n        const mids: number[] = [];\r\n        for(const mid in this.bubbles) {\r\n          let message = await this.chat.getMessage(+mid);\r\n          if(message?._ !== 'message') {\r\n            continue;\r\n          }\r\n\r\n          message = await this.managers.appMessagesManager.getGroupsFirstMessage(message);\r\n          mids.push(message.mid);\r\n        }\r\n\r\n        const promise = mids.length ? this.managers.appReactionsManager.getMessagesReactions(this.peerId, mids) : Promise.resolve();\r\n        promise.then(() => {\r\n          setTimeout(fetchReactions, 10e3);\r\n        });\r\n      };\r\n\r\n      Promise.all([afterSetPromise, getHeavyAnimationPromise(), pause(500)]).then(() => {\r\n        fetchReactions();\r\n      });\r\n    }\r\n  }\r\n\r\n  private async setFetchHistoryInterval({\r\n    lastMsgId,\r\n    topMessage,\r\n    afterSetPromise,\r\n    savedPosition,\r\n    samePeer\r\n  }: {\r\n    lastMsgId: number,\r\n    topMessage: number,\r\n    afterSetPromise: Promise<any>,\r\n    savedPosition: ChatSavedPosition,\r\n    samePeer: boolean\r\n  }) {\r\n    const middleware = this.getMiddleware();\r\n    const peerId = this.peerId;\r\n\r\n    const needFetchInterval = await this.managers.appMessagesManager.isFetchIntervalNeeded(peerId);\r\n    const needFetchNew = savedPosition || needFetchInterval;\r\n    if(!needFetchNew) {\r\n      return;\r\n    }\r\n\r\n    await afterSetPromise;\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    this.setLoaded('bottom', false);\r\n    this.scrollable.checkForTriggers();\r\n\r\n    if(!needFetchInterval) {\r\n      return;\r\n    }\r\n\r\n    const f = () => {\r\n      this.fetchNewPromise = new Promise<void>(async(resolve) => {\r\n        if(!middleware() || !(await this.managers.appMessagesManager.isFetchIntervalNeeded(peerId))) {\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        this.managers.appMessagesManager.getNewHistory(peerId, this.chat.threadId).then((result) => {\r\n          if(!middleware() || !result) {\r\n            resolve();\r\n            return;\r\n          }\r\n\r\n          const {isBottomEnd} = result;\r\n          if(this.scrollable.loadedAll.bottom && this.scrollable.loadedAll.bottom !== isBottomEnd) {\r\n            this.setLoaded('bottom', isBottomEnd);\r\n            this.onScroll();\r\n          }\r\n\r\n          setTimeout(f, 30e3);\r\n          resolve();\r\n        });\r\n      }).finally(() => {\r\n        this.fetchNewPromise = undefined;\r\n      });\r\n    };\r\n    \r\n    if(samePeer) {\r\n      setTimeout(f, 30e3);\r\n    } else {\r\n      f();\r\n    }\r\n  }\r\n\r\n  public async onScrolledAllDown() {\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      const historyMaxId = await this.chat.getHistoryMaxId();\r\n      this.managers.appMessagesManager.readHistory(this.peerId, historyMaxId, this.chat.threadId, true);\r\n    }\r\n  }\r\n\r\n  public async finishPeerChange() {\r\n    const [isChannel, canWrite, isAnyGroup] = await Promise.all([\r\n      this.managers.appPeersManager.isChannel(this.peerId),\r\n      this.chat.canSend(),\r\n      this.chat.isAnyGroup\r\n    ]);\r\n\r\n    return () => {\r\n      this.chatInner.classList.toggle('has-rights', canWrite);\r\n      this.container.classList.toggle('is-chat-input-hidden', !canWrite);\r\n  \r\n      this.chatInner.classList.toggle('is-chat', isAnyGroup);\r\n      this.chatInner.classList.toggle('is-channel', isChannel);\r\n  \r\n      this.createResizeObserver();\r\n    };\r\n  }\r\n\r\n  public renderMessagesQueue(options: ChatBubbles['messagesQueue'][0]) {\r\n    this.messagesQueue.push(options);\r\n    return this.setMessagesQueuePromise();    \r\n  }\r\n\r\n  public setMessagesQueuePromise() {\r\n    if(!this.messagesQueue.length) return Promise.resolve();\r\n\r\n    if(this.messagesQueuePromise) {\r\n      return this.messagesQueuePromise;\r\n    }\r\n    \r\n    const middleware = this.getMiddleware();\r\n    const log = this.log.bindPrefix('queue');\r\n    const possibleError = PEER_CHANGED_ERROR;\r\n    const m = middlewarePromise(middleware, possibleError);\r\n\r\n    const processQueue = async(): Promise<void> => {\r\n      log('start');\r\n\r\n      const renderQueue = this.messagesQueue.slice();\r\n      this.messagesQueue.length = 0;\r\n\r\n      const renderQueuePromises = renderQueue.map((promise) => {\r\n        const perf = performance.now();\r\n        promise.then((details) => {\r\n          log('render message time', performance.now() - perf, details);\r\n        });\r\n\r\n        return promise;\r\n      });\r\n\r\n      let loadQueue = await m(Promise.all(renderQueuePromises));\r\n      const filterQueue = (queue: typeof loadQueue) => {\r\n        return queue.filter((details) => {\r\n          // message can be deleted during rendering\r\n          return details && this.bubbles[details.bubble.dataset.mid] === details.bubble;\r\n        });\r\n      };\r\n\r\n      loadQueue = filterQueue(loadQueue);\r\n\r\n      log('messages rendered');\r\n\r\n      const reverse = loadQueue[0]?.reverse;\r\n\r\n      const {groups, avatarPromises} = this.groupBubbles(loadQueue.filter((details) => details.updatePosition));\r\n\r\n      // if(groups.length > 2 && loadQueue.length === 1) {\r\n      //   debugger;\r\n      // }\r\n      \r\n      const promises = loadQueue.reduce((acc, details) => {\r\n        const perf = performance.now();\r\n\r\n        const promises = details.promises.slice();\r\n        const timePromises = promises.map(async(promise) => (await promise, performance.now() - perf));\r\n        Promise.all(timePromises).then((times) => {\r\n          log.groupCollapsed('media message time', performance.now() - perf, details, times);\r\n          times.forEach((time, idx) => {\r\n            log('media message time', time, idx, promises[idx]);\r\n          });\r\n          log.groupEnd();\r\n        });\r\n\r\n        // if(details.updatePosition) {\r\n        //   if(res) {\r\n        //     groups.add(res.group);\r\n        //     if(details.needAvatar) {\r\n        //       details.promises.push(res.group.createAvatar(details.message));\r\n        //     }\r\n        //   }\r\n        // }\r\n\r\n        acc.push(...details.promises);\r\n        return acc;\r\n      }, [] as Promise<any>[]);\r\n\r\n      promises.push(...avatarPromises);\r\n      // promises.push(pause(200));\r\n\r\n      // * это нужно для того, чтобы если захочет подгрузить reply или какое-либо сообщение, то скролл не прервался\r\n      // * если добавить этот промис - в таком случае нужно сделать, чтобы скроллило к последнему сообщению после рендера\r\n      // promises.push(getHeavyAnimationPromise());\r\n\r\n      log('media promises to call', promises, loadQueue, this.isHeavyAnimationInProgress);\r\n      await m(Promise.all([...promises, this.setUnreadDelimiter()])); // не нашёл места лучше\r\n      await m(fastRafPromise()); // have to be the last\r\n      log('media promises end');\r\n\r\n      loadQueue = filterQueue(loadQueue);\r\n\r\n      const {restoreScroll, scrollSaver} = this.prepareToSaveScroll(reverse);\r\n      // if(this.messagesQueueOnRender) {\r\n        // this.messagesQueueOnRender();\r\n      // }\r\n\r\n      if(this.messagesQueueOnRenderAdditional) {\r\n        this.messagesQueueOnRenderAdditional();\r\n      }\r\n\r\n      this.ejectBubbles();\r\n      for(const [bubble, oldBubble] of this.bubblesToReplace) {\r\n        if(scrollSaver) {\r\n          scrollSaver.replaceSaved(oldBubble, bubble);\r\n        }\r\n        \r\n        if(!loadQueue.find((details) => details.bubble === bubble)) {\r\n          continue;\r\n        }\r\n\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        item.mounted = false;\r\n        if(!groups.includes(item.group)) {\r\n          groups.push(item.group);\r\n        }\r\n\r\n        this.bubblesToReplace.delete(bubble);\r\n      }\r\n      \r\n      if(this.chat.selection.isSelecting) {\r\n        loadQueue.forEach(({bubble}) => {\r\n          this.chat.selection.toggleElementCheckbox(bubble, true);\r\n        });\r\n      }\r\n\r\n      loadQueue.forEach(({message, bubble, updatePosition}) => {\r\n        if(message.pFlags.local && updatePosition) {\r\n          this.chatInner[(message as Message.message).pFlags.sponsored ? 'append' : 'prepend'](bubble);\r\n          return;\r\n        }\r\n      });\r\n\r\n      this.bubbleGroups.mountUnmountGroups(groups);\r\n      // this.bubbleGroups.findIncorrentPositions();\r\n\r\n      if(this.updatePlaceholderPosition) {\r\n        this.updatePlaceholderPosition();\r\n      }\r\n\r\n      if(restoreScroll) {\r\n        restoreScroll();\r\n      }\r\n\r\n      // this.setStickyDateManually();\r\n      \r\n      if(this.messagesQueue.length) {\r\n        log('have new messages to render');\r\n        return processQueue();\r\n      } else {\r\n        log('end');\r\n      }\r\n    };\r\n\r\n    log('setting pause');\r\n    const promise = this.messagesQueuePromise = m(pause(0)).then(processQueue).finally(() => {\r\n      if(this.messagesQueuePromise === promise) {\r\n        this.messagesQueuePromise = null;\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private ejectBubbles() {\r\n    for(const bubble of this.bubblesToEject) {\r\n      bubble.remove();\r\n      // this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n    }\r\n\r\n    this.bubblesToEject.clear();\r\n  }\r\n\r\n  public groupBubbles(items: Array<{\r\n    // Awaited<ReturnType<ChatBubbles['safeRenderMessage']>> & \r\n    bubble: HTMLElement, \r\n    message: Message.message | Message.messageService\r\n  }/*  & {\r\n    unmountIfFound?: boolean\r\n  } */>) {\r\n    let modifiedGroups: typeof groups;\r\n\r\n    if(this.chat.type === 'scheduled') {\r\n      modifiedGroups = new Set();\r\n      items.forEach(({bubble, message}) => {\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        const group = item?.group;\r\n        if(group && item.message.date !== message.date) {\r\n          this.bubbleGroups.removeItem(item);\r\n          modifiedGroups.add(group);\r\n        }\r\n      });\r\n    }\r\n    \r\n    items.forEach(({bubble, message}) => {\r\n      this.bubbleGroups.prepareForGrouping(bubble, message);\r\n    });\r\n\r\n    const groups = this.bubbleGroups.groupUngrouped();\r\n\r\n    const avatarPromises = Array.from(groups).map((group) => {\r\n      if(group.avatar) return;\r\n      const firstItem = group.firstItem;\r\n      if(firstItem && this.chat.isAvatarNeeded(firstItem.message)) {\r\n        return group.createAvatar(firstItem.message);\r\n      }\r\n    }).filter(Boolean);\r\n\r\n    if(modifiedGroups) {\r\n      for(const group of modifiedGroups) {\r\n        groups.add(group);\r\n      }\r\n    }\r\n\r\n    return {\r\n      groups: [...groups], \r\n      avatarPromises\r\n    };\r\n  }\r\n\r\n  public getMiddleware(additionalCallback?: () => boolean) {\r\n    return this.middleware.get(additionalCallback);\r\n  }\r\n\r\n  private async safeRenderMessage(\r\n    message: Message.message | Message.messageService, \r\n    reverse?: boolean, \r\n    bubble?: HTMLElement, \r\n    updatePosition = true,\r\n    processResult?: (result: ReturnType<ChatBubbles['renderMessage']>, bubble: HTMLElement) => typeof result\r\n  ) {\r\n    if(!message || this.renderingMessages.has(message.mid) || (this.bubbles[message.mid] && !bubble)) {\r\n      return;\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n\r\n    let result: Awaited<ReturnType<ChatBubbles['renderMessage']>> & {updatePosition: typeof updatePosition};\r\n    try {\r\n      this.renderingMessages.add(message.mid);\r\n\r\n      // const groupedId = (message as Message.message).grouped_id;\r\n      const newBubble = document.createElement('div');\r\n      newBubble.dataset.mid = '' + message.mid;\r\n      newBubble.dataset.peerId = '' + message.peerId;\r\n      newBubble.dataset.timestamp = '' + message.date;\r\n\r\n      // const bubbleNew: Bubble = this.bubblesNew[message.mid] ??= {\r\n      //   bubble: newBubble, \r\n      //   mids: new Set(), \r\n      //   groupedId\r\n      // };\r\n\r\n      // bubbleNew.mids.add(message.mid);\r\n\r\n      if(bubble) {\r\n        this.skippedMids.delete(message.mid);\r\n\r\n        this.bubblesToEject.add(bubble);\r\n        this.bubblesToReplace.delete(bubble);\r\n        this.bubblesToReplace.set(newBubble, bubble);\r\n        this.bubbleGroups.changeBubbleByBubble(bubble, newBubble);\r\n      }\r\n\r\n      bubble = this.bubbles[message.mid] = newBubble;\r\n      let originalPromise = this.renderMessage(message, reverse, bubble);\r\n      if(processResult) {\r\n        originalPromise = processResult(originalPromise, bubble);\r\n      }\r\n      \r\n      const promise = originalPromise.then((r) => ((r && middleware() ? {...r, updatePosition} : undefined) as typeof result));\r\n\r\n      this.renderMessagesQueue(promise.catch(() => undefined));\r\n\r\n      result = await promise;\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(!result) {\r\n        this.skippedMids.add(+message.mid);\r\n      }\r\n    } catch(err) {\r\n      this.log.error('renderMessage error:', err);\r\n    }\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    this.renderingMessages.delete(message.mid);\r\n    return result;\r\n  }\r\n  \r\n  // reverse means top\r\n  private async renderMessage(\r\n    message: Message.message | Message.messageService, \r\n    reverse = false, \r\n    bubble: HTMLElement\r\n  ) {\r\n    // if(DEBUG) {\r\n    //   this.log('message to render:', message);\r\n    // }\r\n\r\n    // if(!bubble && this.bubbles[message.mid]) {\r\n    //   return;\r\n    // }\r\n\r\n    // await pause(1000);\r\n\r\n    const isMessage = message._ === 'message';\r\n    const groupedId = isMessage && message.grouped_id;\r\n    let albumMids: number[], reactionsMessage: Message.message;\r\n    const albumMessages = groupedId ? await this.managers.appMessagesManager.getMessagesByAlbum(groupedId) : undefined;\r\n\r\n    const albumMustBeRenderedFull = this.chat.type !== 'pinned';\r\n\r\n    if(groupedId && albumMustBeRenderedFull) { // will render only last album's message\r\n      albumMids = albumMessages.map((message) => message.mid);\r\n      const mainMid = getMainMidForGrouped(albumMids);\r\n      if(message.mid !== mainMid) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(isMessage) {\r\n      reactionsMessage = groupedId ? albumMessages[0] : message;\r\n    }\r\n    \r\n    // * can't use 'message.pFlags.out' here because this check will be used to define side of message (left-right)\r\n    const our = this.chat.isOurMessage(message);\r\n    \r\n    const messageDiv = document.createElement('div');\r\n    messageDiv.classList.add('message');\r\n    \r\n    let bubbleContainer: HTMLDivElement;\r\n    let contentWrapper: HTMLElement;\r\n    \r\n    contentWrapper = document.createElement('div');\r\n    contentWrapper.classList.add('bubble-content-wrapper');\r\n    \r\n    bubbleContainer = document.createElement('div');\r\n    bubbleContainer.classList.add('bubble-content');\r\n    \r\n    bubble.classList.add('bubble');\r\n    contentWrapper.append(bubbleContainer);\r\n    bubble.append(contentWrapper);\r\n\r\n    if(!our && !message.pFlags.out && this.observer) {\r\n      //this.log('not our message', message, message.pFlags.unread);\r\n      const isUnread = message.pFlags.unread || \r\n        isMentionUnread(message)/*  || \r\n        (this.historyStorage.readMaxId !== undefined && this.historyStorage.readMaxId < message.mid) */;\r\n      if(isUnread) {\r\n        this.observer.observe(bubble, this.unreadedObserverCallback);\r\n        this.unreaded.set(bubble, message.mid);\r\n      }\r\n    }\r\n\r\n    const loadPromises: Promise<any>[] = [];\r\n    const ret = {\r\n      bubble,\r\n      promises: loadPromises,\r\n      message,\r\n      reverse\r\n    };\r\n\r\n    if(message._ === 'messageService' && (!message.action || !SERVICE_AS_REGULAR.has(message.action._))) {\r\n      const action = message.action;\r\n      if(action) {\r\n        const _ = action._;\r\n        if(IGNORE_ACTIONS.has(_) || (langPack.hasOwnProperty(_) && !langPack[_])) {\r\n          return;\r\n        }\r\n      }\r\n\r\n      bubble.className = 'bubble service';\r\n\r\n      bubbleContainer.innerHTML = '';\r\n      const s = document.createElement('div');\r\n      s.classList.add('service-msg');\r\n      if(action) {\r\n        let promise: Promise<any>;\r\n        if(action._ === 'messageActionChannelMigrateFrom') {\r\n          const peerTitle = new PeerTitle();\r\n          promise = peerTitle.update({peerId: action.chat_id.toPeerId(true)});\r\n          s.append(i18n('ChatMigration.From', [peerTitle.element]));\r\n        } else if(action._ === 'messageActionChatMigrateTo') {\r\n          const peerTitle = new PeerTitle();\r\n          promise = peerTitle.update({peerId: action.channel_id.toPeerId(true)});\r\n          s.append(i18n('ChatMigration.To', [peerTitle.element]));\r\n        } else {\r\n          s.append(await wrapMessageActionTextNew(message));\r\n        }\r\n      }\r\n      bubbleContainer.append(s);\r\n\r\n      if(message.pFlags.is_single) { // * Ignore 'Discussion started'\r\n        bubble.classList.add('is-group-last');\r\n      }\r\n\r\n      return ret;\r\n    }\r\n\r\n    let messageMedia: MessageMedia = isMessage && message.media;\r\n\r\n    let messageMessage: string, totalEntities: MessageEntity[];\r\n    if(isMessage) {\r\n      if((messageMedia as MessageMedia.messageMediaDocument)?.document && \r\n        !['video', 'gif'].includes(((messageMedia as MessageMedia.messageMediaDocument).document as MyDocument).type)) {\r\n        // * just filter these cases for documents caption\r\n      } else if(groupedId && albumMustBeRenderedFull) {\r\n        const t = getAlbumText(albumMessages);\r\n        messageMessage = t.message;\r\n        //totalEntities = t.entities;\r\n        totalEntities = t.totalEntities;\r\n      } else if(((messageMedia as MessageMedia.messageMediaDocument)?.document as MyDocument)?.type !== 'sticker') {\r\n        messageMessage = message.message;\r\n        //totalEntities = message.entities;\r\n        totalEntities = message.totalEntities;\r\n      }\r\n    } else {\r\n      if(message.action._ === 'messageActionPhoneCall') {\r\n        messageMedia = {\r\n          _: 'messageMediaCall',\r\n          action: message.action\r\n        };\r\n      }\r\n    }\r\n    \r\n    /* let richText = wrapRichText(messageMessage, {\r\n      entities: totalEntities\r\n    }); */\r\n    let richText = wrapRichText(messageMessage, {\r\n      entities: totalEntities,\r\n      passEntities: this.passEntities\r\n    });\r\n\r\n    let canHaveTail = true;\r\n    let isStandaloneMedia = false;\r\n    let needToSetHTML = true;\r\n    if(totalEntities && !messageMedia) {\r\n      let emojiEntities = totalEntities.filter((e) => e._ === 'messageEntityEmoji');\r\n      let strLength = messageMessage.length;\r\n      let emojiStrLength = emojiEntities.reduce((acc, curr) => acc + curr.length, 0);\r\n      \r\n      if(emojiStrLength === strLength && emojiEntities.length <= 3 && totalEntities.length === emojiEntities.length) {\r\n        if(rootScope.settings.emoji.big) {\r\n          let sticker = await this.managers.appStickersManager.getAnimatedEmojiSticker(messageMessage);\r\n          if(emojiEntities.length === 1 && !messageMedia && sticker) {\r\n            messageMedia = {\r\n              _: 'messageMediaDocument',\r\n              document: sticker\r\n            };\r\n          } else {\r\n            let attachmentDiv = document.createElement('div');\r\n            attachmentDiv.classList.add('attachment');\r\n            \r\n            setInnerHTML(attachmentDiv, richText);\r\n            \r\n            bubble.classList.add('emoji-' + emojiEntities.length + 'x');\r\n            \r\n            bubbleContainer.append(attachmentDiv);\r\n          }\r\n\r\n          bubble.classList.add('is-message-empty', 'emoji-big');\r\n          isStandaloneMedia = true;\r\n          canHaveTail = false;\r\n          needToSetHTML = false;\r\n        }\r\n        \r\n        bubble.classList.add('can-have-big-emoji');\r\n      }\r\n      \r\n      /* if(strLength === emojiStrLength) {\r\n        messageDiv.classList.add('emoji-only');\r\n        messageDiv.classList.add('message-empty');\r\n      } */\r\n    }\r\n\r\n    if(needToSetHTML) {\r\n      setInnerHTML(messageDiv, richText);\r\n    }\r\n\r\n    const timeSpan = MessageRender.setTime({\r\n      chatType: this.chat.type, \r\n      message,\r\n      reactionsMessage\r\n    });\r\n    messageDiv.append(timeSpan);\r\n    bubbleContainer.prepend(messageDiv);\r\n    //bubble.prepend(timeSpan, messageDiv); // that's bad\r\n\r\n    if(isMessage && message.views) {\r\n      bubble.classList.add('channel-post');\r\n\r\n      if(!message.fwd_from?.saved_from_msg_id && this.chat.type !== 'pinned') {\r\n        const forward = document.createElement('div');\r\n        forward.classList.add('bubble-beside-button', 'forward', 'tgico-forward_filled');\r\n        bubbleContainer.prepend(forward);\r\n        bubble.classList.add('with-beside-button');\r\n      }\r\n  \r\n      if(!message.pFlags.is_outgoing && this.observer) {\r\n        this.observer.observe(bubble, this.viewsObserverCallback);\r\n      }\r\n    }\r\n\r\n    const replyMarkup = isMessage && message.reply_markup;\r\n    if(replyMarkup && replyMarkup._ === 'replyInlineMarkup' && replyMarkup.rows && replyMarkup.rows.length) {\r\n      const rows = replyMarkup.rows;\r\n\r\n      const containerDiv = document.createElement('div');\r\n      containerDiv.classList.add('reply-markup');\r\n      rows.forEach((row) => {\r\n        const buttons = row.buttons;\r\n        if(!buttons || !buttons.length) return;\r\n\r\n        const rowDiv = document.createElement('div');\r\n        rowDiv.classList.add('reply-markup-row');\r\n\r\n        buttons.forEach((button) => {\r\n          const text = wrapRichText(button.text, {noLinks: true, noLinebreaks: true});\r\n\r\n          let buttonEl: HTMLButtonElement | HTMLAnchorElement;\r\n          \r\n          switch(button._) {\r\n            case 'keyboardButtonUrl': {\r\n              const r = wrapRichText(' ', {\r\n                entities: [{\r\n                  _: 'messageEntityTextUrl',\r\n                  length: 1,\r\n                  offset: 0,\r\n                  url: button.url\r\n                }]\r\n              });\r\n\r\n              buttonEl = htmlToDocumentFragment(r).firstElementChild as HTMLAnchorElement;\r\n              buttonEl.classList.add('is-link', 'tgico');\r\n\r\n              break;\r\n            }\r\n\r\n            case 'keyboardButtonSwitchInline': {\r\n              buttonEl = document.createElement('button');\r\n              buttonEl.classList.add('is-switch-inline', 'tgico');\r\n              attachClickEvent(buttonEl, (e) => {\r\n                cancelEvent(e);\r\n\r\n                const botId = message.viaBotId || message.fromId;\r\n                let promise: Promise<PeerId>;\r\n                if(button.pFlags.same_peer) promise = Promise.resolve(this.peerId);\r\n                else promise = this.managers.appInlineBotsManager.checkSwitchReturn(botId).then((peerId) => {\r\n                  if(peerId) {\r\n                    return peerId;\r\n                  }\r\n                  \r\n                  return new Promise<PeerId>((resolve, reject) => {\r\n                    const popup = new PopupForward({\r\n                      [this.peerId]: []\r\n                    }, (peerId) => {\r\n                      resolve(peerId);\r\n                    }, true);\r\n\r\n                    popup.addEventListener('close', () => {\r\n                      reject();\r\n                    });\r\n                  });\r\n                });\r\n                \r\n                promise.then((peerId) => {\r\n                  const threadId = this.peerId === peerId ? this.chat.threadId : undefined;\r\n                  this.chat.appImManager.setInnerPeer({peerId});\r\n                  this.managers.appInlineBotsManager.switchInlineQuery(peerId, threadId, botId, button.query);\r\n                });\r\n              });\r\n              break;\r\n            }\r\n\r\n            default: {\r\n              buttonEl = document.createElement('button');\r\n              break;\r\n            }\r\n          }\r\n          \r\n          buttonEl.classList.add('reply-markup-button', 'rp');\r\n          if(typeof(text) === 'string') {\r\n            buttonEl.insertAdjacentHTML('beforeend', text);\r\n          } else {\r\n            buttonEl.append(text);\r\n          }\r\n\r\n          ripple(buttonEl);\r\n\r\n          rowDiv.append(buttonEl);\r\n        });\r\n\r\n        containerDiv.append(rowDiv);\r\n      });\r\n\r\n      attachClickEvent(containerDiv, (e) => {\r\n        let target = e.target as HTMLElement;\r\n        \r\n        if(!target.classList.contains('reply-markup-button')) target = findUpClassName(target, 'reply-markup-button');\r\n        if(!target || target.classList.contains('is-link') || target.classList.contains('is-switch-inline')) return;\r\n\r\n        cancelEvent(e);\r\n\r\n        const column = whichChild(target);\r\n        const row = rows[whichChild(target.parentElement)];\r\n\r\n        if(!row.buttons || !row.buttons[column]) {\r\n          this.log.warn('no such button', row, column, message);\r\n          return;\r\n        }\r\n\r\n        const button = row.buttons[column];\r\n        this.managers.appInlineBotsManager.callbackButtonClick(this.peerId, message.mid, button).then((callbackAnswer) => {\r\n          if(typeof callbackAnswer.message === 'string' && callbackAnswer.message.length) {\r\n            toast(wrapRichText(callbackAnswer.message, {noLinks: true, noLinebreaks: true}));\r\n          }\r\n          \r\n          //console.log('callbackButtonClick callbackAnswer:', callbackAnswer);\r\n        });\r\n      });\r\n\r\n      canHaveTail = false;\r\n      bubble.classList.add('with-reply-markup');\r\n      contentWrapper.append(containerDiv);\r\n    }\r\n    \r\n    const isOutgoing = message.pFlags.is_outgoing/*  && this.peerId !== rootScope.myId */;\r\n    if(our) {\r\n      if(message.pFlags.unread || isOutgoing) this.unreadOut.add(message.mid);\r\n      let status = '';\r\n      if(isOutgoing) status = 'is-sending';\r\n      else status = message.pFlags.unread || (message as Message.message).pFlags.is_scheduled ? 'is-sent' : 'is-read';\r\n      bubble.classList.add(status);\r\n    }\r\n\r\n    if(isOutgoing) {\r\n      bubble.classList.add('is-outgoing');\r\n    }\r\n\r\n    const messageWithReplies = isMessage && await this.managers.appMessagesManager.getMessageWithCommentReplies(message);\r\n    const withReplies = !!messageWithReplies && message.mid > 0;\r\n\r\n    if(withReplies) {\r\n      bubble.classList.add('with-replies');\r\n    }\r\n\r\n    const fwdFrom = isMessage && message.fwd_from;\r\n    const fwdFromId = isMessage && message.fwdFromId;\r\n\r\n    const isOut = this.chat.isOutMessage(message);\r\n    let nameContainer: HTMLElement = bubbleContainer;\r\n\r\n    const canHideNameIfMedia = !message.viaBotId && (message.fromId === rootScope.myId || !message.pFlags.out);\r\n\r\n    // media\r\n    if(messageMedia/*  && messageMedia._ === 'messageMediaPhoto' */) {\r\n      let attachmentDiv = document.createElement('div');\r\n      attachmentDiv.classList.add('attachment');\r\n      \r\n      if(!messageMessage) {\r\n        bubble.classList.add('is-message-empty');\r\n      }\r\n      \r\n      let processingWebPage = false;\r\n      \r\n      /* if(isMessage)  */switch(messageMedia._) {\r\n        case 'messageMediaPhoto': {\r\n          const photo = messageMedia.photo;\r\n          ////////this.log('messageMediaPhoto', photo);\r\n\r\n          if(!messageMessage) {\r\n            canHaveTail = false;\r\n          }\r\n          \r\n          if(canHideNameIfMedia) {\r\n            bubble.classList.add('hide-name');  \r\n          }\r\n\r\n          bubble.classList.add('photo');\r\n          \r\n          if(albumMustBeRenderedFull && groupedId && albumMids.length !== 1) {\r\n            bubble.classList.add('is-album', 'is-grouped');\r\n            wrapAlbum({\r\n              messages: albumMessages,\r\n              attachmentDiv,\r\n              middleware: this.getMiddleware(),\r\n              isOut: our,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              chat: this.chat,\r\n              loadPromises,\r\n              autoDownload: this.chat.autoDownload,\r\n            });\r\n\r\n            break;\r\n          }\r\n          \r\n          const withTail = !IS_ANDROID && canHaveTail && !withReplies && USE_MEDIA_TAILS;\r\n          if(withTail) bubble.classList.add('with-media-tail');\r\n          wrapPhoto({\r\n            photo: photo as Photo.photo, \r\n            message,\r\n            container: attachmentDiv,\r\n            withTail, \r\n            isOut, \r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            middleware: this.getMiddleware(),\r\n            loadPromises,\r\n            autoDownloadSize: this.chat.autoDownload.photo,\r\n          });\r\n\r\n          break;\r\n        }\r\n        \r\n        case 'messageMediaWebPage': {\r\n          processingWebPage = true;\r\n          \r\n          let webPage: WebPage = messageMedia.webpage;\r\n          ////////this.log('messageMediaWebPage', webpage);\r\n          if(webPage._ !== 'webPage') {\r\n            break;\r\n          } \r\n          \r\n          bubble.classList.add('webpage');\r\n          \r\n          let box = document.createElement('div');\r\n          box.classList.add('web');\r\n          \r\n          let quote = document.createElement('div');\r\n          quote.classList.add('quote');\r\n\r\n          let previewResizer: HTMLDivElement, preview: HTMLDivElement;\r\n          const photo: Photo.photo = webPage.photo as any;\r\n          if(photo || webPage.document) {\r\n            previewResizer = document.createElement('div');\r\n            previewResizer.classList.add('preview-resizer');\r\n            preview = document.createElement('div');\r\n            preview.classList.add('preview');\r\n            previewResizer.append(preview);\r\n          }\r\n\r\n          let quoteTextDiv = document.createElement('div');\r\n          quoteTextDiv.classList.add('quote-text');\r\n          \r\n          const doc = webPage.document as MyDocument;\r\n          if(doc) {\r\n            if(doc.type === 'gif' || doc.type === 'video' || doc.type === 'round') {\r\n              //if(doc.size <= 20e6) {\r\n              const mediaSize = doc.type === 'round' ? mediaSizes.active.round : mediaSizes.active.webpage;\r\n              if(doc.type === 'round') {\r\n                bubble.classList.add('round');\r\n                preview.classList.add('is-round');\r\n              } else {\r\n                bubble.classList.add('video');\r\n              }\r\n              wrapVideo({\r\n                doc, \r\n                container: preview, \r\n                message: message as Message.message, \r\n                boxWidth: mediaSize.width,\r\n                boxHeight: mediaSize.height,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                middleware: this.getMiddleware(),\r\n                isOut,\r\n                group: CHAT_ANIMATION_GROUP,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n              });\r\n              //}\r\n            } else {\r\n              const docDiv = await wrapDocument({\r\n                message: message as Message.message,\r\n                autoDownloadSize: this.chat.autoDownload.file,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                loadPromises,\r\n                sizeType: 'documentName',\r\n                searchContext: {\r\n                  useSearch: false,\r\n                  peerId: this.peerId,\r\n                  inputFilter: {\r\n                    _: 'inputMessagesFilterEmpty'\r\n                  }\r\n                }\r\n              });\r\n              preview.append(docDiv);\r\n              preview.classList.add('preview-with-document');\r\n              quoteTextDiv.classList.add('has-document');\r\n              //messageDiv.classList.add((webpage.type || 'document') + '-message');\r\n              //doc = null;\r\n            }\r\n          }\r\n          \r\n          if(previewResizer) {\r\n            quoteTextDiv.append(previewResizer);\r\n          }\r\n\r\n          let t: HTMLElement;\r\n          if(webPage.site_name) {\r\n            const html = wrapRichText(webPage.url);\r\n            const a: HTMLAnchorElement = htmlToDocumentFragment(html).firstElementChild as any;\r\n            a.classList.add('webpage-name');\r\n            const strong = document.createElement('strong');\r\n            setInnerHTML(strong, wrapEmojiText(webPage.site_name));\r\n            a.textContent = '';\r\n            a.append(strong);\r\n            quoteTextDiv.append(a);\r\n            t = a;\r\n          }\r\n\r\n          const title = wrapWebPageTitle(webPage);\r\n          if(title.textContent) {\r\n            let titleDiv = document.createElement('div');\r\n            titleDiv.classList.add('title');\r\n            const strong = document.createElement('strong');\r\n            setInnerHTML(strong, title);\r\n            titleDiv.append(strong);\r\n            quoteTextDiv.append(titleDiv);\r\n            t = titleDiv;\r\n          }\r\n\r\n          const description = wrapWebPageDescription(webPage);\r\n          if(description.textContent) {\r\n            let textDiv = document.createElement('div');\r\n            textDiv.classList.add('text');\r\n            setInnerHTML(textDiv, description);\r\n            quoteTextDiv.append(textDiv);\r\n            t = textDiv;\r\n          }\r\n\r\n          /* if(t) {\r\n            t.append(timeSpan);\r\n          } else {\r\n            box.classList.add('no-text');\r\n          } */\r\n\r\n          quote.append(quoteTextDiv);\r\n\r\n          if(photo && !doc) {\r\n            bubble.classList.add('photo');\r\n\r\n            const size: PhotoSize.photoSize = photo.sizes[photo.sizes.length - 1] as any;\r\n            let isSquare = false;\r\n            if(size.w === size.h && t) {\r\n              bubble.classList.add('is-square-photo');\r\n              isSquare = true;\r\n              setAttachmentSize(photo, preview, 48, 48, false);\r\n\r\n              /* if(t) {\r\n                t.append(timeSpan);\r\n              } */\r\n            } else if(size.h > size.w) {\r\n              bubble.classList.add('is-vertical-photo');\r\n            }\r\n\r\n            wrapPhoto({\r\n              photo, \r\n              message, \r\n              container: preview, \r\n              boxWidth: isSquare ? 0 : mediaSizes.active.webpage.width, \r\n              boxHeight: isSquare ? 0 : mediaSizes.active.webpage.height, \r\n              isOut, \r\n              lazyLoadQueue: this.lazyLoadQueue, \r\n              middleware: this.getMiddleware(),\r\n              loadPromises,\r\n              withoutPreloader: isSquare,\r\n              autoDownloadSize: this.chat.autoDownload.photo,\r\n            });\r\n          }\r\n          \r\n          box.append(quote);\r\n          \r\n          //bubble.prepend(box);\r\n          // if(timeSpan.parentElement === messageDiv) {\r\n            messageDiv.insertBefore(box, timeSpan);\r\n          // } else {\r\n          //   messageDiv.append(box);\r\n          // }\r\n          \r\n          //this.log('night running', bubble.scrollHeight);\r\n          \r\n          break;\r\n        }\r\n        \r\n        case 'messageMediaDocument': {\r\n          const doc = messageMedia.document as MyDocument;\r\n\r\n          //this.log('messageMediaDocument', doc, bubble);\r\n          \r\n          if(doc.sticker/*  && doc.size <= 1e6 */) {\r\n            bubble.classList.add('sticker');\r\n            canHaveTail = false;\r\n            isStandaloneMedia = true;\r\n            \r\n            if(doc.animated) {\r\n              bubble.classList.add('sticker-animated');\r\n            }\r\n            \r\n            const sizes = mediaSizes.active;\r\n            const size = bubble.classList.contains('emoji-big') ? sizes.emojiSticker : (doc.animated ? sizes.animatedSticker : sizes.staticSticker);\r\n            setAttachmentSize(doc, attachmentDiv, size.width, size.height);\r\n            //let preloader = new ProgressivePreloader(attachmentDiv, false);\r\n            bubbleContainer.style.minWidth = attachmentDiv.style.width;\r\n            bubbleContainer.style.minHeight = attachmentDiv.style.height;\r\n            //appPhotosManager.setAttachmentSize(doc, bubble);\r\n            wrapSticker({\r\n              doc, \r\n              div: attachmentDiv,\r\n              middleware: this.getMiddleware(),\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              group: CHAT_ANIMATION_GROUP,\r\n              //play: !!message.pending || !multipleRender,\r\n              play: true,\r\n              loop: true,\r\n              emoji: bubble.classList.contains('emoji-big') ? messageMessage : undefined,\r\n              withThumb: true,\r\n              loadPromises\r\n            });\r\n          } else if(doc.type === 'video' || doc.type === 'gif' || doc.type === 'round'/*  && doc.size <= 20e6 */) {\r\n            //this.log('never get free 2', doc);\r\n\r\n            const isRound = doc.type === 'round';\r\n            if(isRound) {\r\n              isStandaloneMedia = true;\r\n            }\r\n\r\n            if(isRound || !messageMessage) {\r\n              canHaveTail = false;\r\n            }\r\n\r\n            if(canHideNameIfMedia) {\r\n              bubble.classList.add('hide-name');\r\n            }\r\n            \r\n            bubble.classList.add(isRound ? 'round' : 'video');\r\n            if(albumMustBeRenderedFull && groupedId && albumMids.length !== 1) {\r\n              bubble.classList.add('is-album', 'is-grouped');\r\n  \r\n              wrapAlbum({\r\n                messages: albumMessages,\r\n                attachmentDiv,\r\n                middleware: this.getMiddleware(),\r\n                isOut: our,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                chat: this.chat,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n              });\r\n            } else {\r\n              const withTail = !IS_ANDROID && !IS_APPLE && !isRound && canHaveTail && !withReplies && USE_MEDIA_TAILS;\r\n              if(withTail) bubble.classList.add('with-media-tail');\r\n              wrapVideo({\r\n                doc, \r\n                container: attachmentDiv, \r\n                message: message as Message.message, \r\n                boxWidth: mediaSizes.active.regular.width,\r\n                boxHeight: mediaSizes.active.regular.height, \r\n                withTail, \r\n                isOut,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                middleware: this.getMiddleware(),\r\n                group: CHAT_ANIMATION_GROUP,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n                searchContext: isRound ? {\r\n                  peerId: this.peerId,\r\n                  inputFilter: {_: 'inputMessagesFilterRoundVoice'},\r\n                  threadId: this.chat.threadId,\r\n                  useSearch: !(message as Message.message).pFlags.is_scheduled,\r\n                  isScheduled: (message as Message.message).pFlags.is_scheduled\r\n                } : undefined,\r\n              });\r\n            }\r\n          } else {\r\n            const newNameContainer = await wrapGroupedDocuments({\r\n              albumMustBeRenderedFull,\r\n              message,\r\n              bubble,\r\n              messageDiv,\r\n              chat: this.chat,\r\n              loadPromises,\r\n              autoDownloadSize: this.chat.autoDownload.file,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              searchContext: doc.type === 'voice' || doc.type === 'audio' ? {\r\n                peerId: this.peerId,\r\n                inputFilter: {_: doc.type === 'voice' ? 'inputMessagesFilterRoundVoice' : 'inputMessagesFilterMusic'},\r\n                threadId: this.chat.threadId,\r\n                useSearch: !(message as Message.message).pFlags.is_scheduled,\r\n                isScheduled: (message as Message.message).pFlags.is_scheduled\r\n              } : undefined,\r\n              sizeType: 'documentName'\r\n            });\r\n\r\n            if(newNameContainer) {\r\n              nameContainer = newNameContainer;\r\n            }\r\n\r\n            const lastContainer = messageDiv.lastElementChild.querySelector('.document-message, .document-size, .audio');\r\n            // lastContainer && lastContainer.append(timeSpan.cloneNode(true));\r\n            lastContainer && lastContainer.append(timeSpan);\r\n\r\n            bubble.classList.remove('is-message-empty');\r\n            messageDiv.classList.add((!(['photo', 'pdf'] as MyDocument['type'][]).includes(doc.type) ? doc.type || 'document' : 'document') + '-message');\r\n            processingWebPage = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaCall': {\r\n          const action = messageMedia.action;\r\n          const div = document.createElement('div');\r\n          div.classList.add('bubble-call', action.pFlags.video ? 'tgico-videocamera' : 'tgico-phone');\r\n\r\n          const type: CallType = action.pFlags.video ? 'video' : 'voice';\r\n          div.dataset.type = type;\r\n\r\n          const title = document.createElement('div');\r\n          title.classList.add('bubble-call-title');\r\n\r\n          _i18n(title, isOut ? \r\n            (action.pFlags.video ? 'CallMessageVideoOutgoing' : 'CallMessageOutgoing') : \r\n            (action.pFlags.video ? 'CallMessageVideoIncoming' : 'CallMessageIncoming'));\r\n\r\n          const subtitle = document.createElement('div');\r\n          subtitle.classList.add('bubble-call-subtitle');\r\n\r\n          if(action.duration !== undefined) {\r\n            subtitle.append(formatCallDuration(action.duration));\r\n          } else {\r\n            let langPackKey: LangPackKey;\r\n            switch(action.reason._) {\r\n              case 'phoneCallDiscardReasonBusy':\r\n                langPackKey = 'Call.StatusBusy';\r\n                break;\r\n              case 'phoneCallDiscardReasonMissed':\r\n                langPackKey = 'Chat.Service.Call.Missed';\r\n                break;\r\n              // case 'phoneCallDiscardReasonHangup':\r\n              default:\r\n                langPackKey = 'Chat.Service.Call.Cancelled';\r\n                break;\r\n            }\r\n\r\n            subtitle.classList.add('is-reason');\r\n            _i18n(subtitle, langPackKey);\r\n          }\r\n\r\n          subtitle.classList.add('tgico', 'arrow-' + (action.duration !== undefined ? 'green' : 'red'));\r\n\r\n          div.append(title, subtitle);\r\n\r\n          processingWebPage = true;\r\n\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.classList.add('call-message');\r\n          messageDiv.append(div);\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaContact': {\r\n          //this.log('wrapping contact', message);\r\n\r\n          const contact = messageMedia;\r\n          const contactDiv = document.createElement('div');\r\n          contactDiv.classList.add('contact');\r\n          contactDiv.dataset.peerId = '' + contact.user_id;\r\n\r\n          processingWebPage = true;\r\n\r\n          const contactDetails = document.createElement('div');\r\n          contactDetails.className = 'contact-details';\r\n          const contactNameDiv = document.createElement('div');\r\n          contactNameDiv.className = 'contact-name';\r\n          contactNameDiv.append(\r\n            wrapEmojiText([\r\n              contact.first_name,\r\n              contact.last_name\r\n            ].filter(Boolean).join(' '))\r\n          );\r\n\r\n          const contactNumberDiv = document.createElement('div');\r\n          contactNumberDiv.className = 'contact-number';\r\n          contactNumberDiv.textContent = contact.phone_number ? '+' + formatPhoneNumber(contact.phone_number).formatted : 'Unknown phone number';\r\n\r\n          contactDiv.append(contactDetails);\r\n          contactDetails.append(contactNameDiv, contactNumberDiv);\r\n\r\n          const avatarElem = new AvatarElement();\r\n          avatarElem.updateWithOptions({\r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            peerId: contact.user_id.toPeerId()\r\n          });\r\n          avatarElem.classList.add('contact-avatar', 'avatar-54');\r\n\r\n          contactDiv.prepend(avatarElem);\r\n\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.classList.add('contact-message');\r\n          messageDiv.append(contactDiv);\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaPoll': {\r\n          bubble.classList.remove('is-message-empty');\r\n          \r\n          const pollElement = wrapPoll(message);\r\n          messageDiv.prepend(pollElement);\r\n          messageDiv.classList.add('poll-message');\r\n\r\n          break;\r\n        }\r\n        \r\n        default:\r\n          attachmentDiv = undefined;\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.append(i18n(UNSUPPORTED_LANG_PACK_KEY), timeSpan);\r\n          this.log.warn('unrecognized media type:', messageMedia._, message);\r\n          break;\r\n      }\r\n      \r\n      if(!processingWebPage && attachmentDiv) {\r\n        bubbleContainer.append(attachmentDiv);\r\n      }\r\n\r\n      /* if(bubble.classList.contains('is-message-empty') && (bubble.classList.contains('photo') || bubble.classList.contains('video'))) {\r\n        bubble.classList.add('no-tail');\r\n\r\n        if(!bubble.classList.contains('with-media-tail')) {\r\n          bubble.classList.add('use-border-radius');\r\n        }\r\n      } */\r\n    }\r\n\r\n    if(isStandaloneMedia) {\r\n      bubble.classList.add('just-media');\r\n    }\r\n\r\n    let savedFrom = '';\r\n    \r\n    // const needName = ((peerId.isAnyChat() && (peerId !== message.fromId || our)) && message.fromId !== rootScope.myId) || message.viaBotId;\r\n    const needName = (message.fromId !== rootScope.myId && this.chat.isAnyGroup) || message.viaBotId || (message as Message.message).pFlags.sponsored;\r\n    if(needName || fwdFrom || message.reply_to_mid) { // chat\r\n      let title: HTMLElement | DocumentFragment;\r\n      let titleVia: typeof title;\r\n\r\n      const isForwardFromChannel = message.from_id && message.from_id._ === 'peerChannel' && message.fromId === fwdFromId;\r\n      \r\n      let isHidden = fwdFrom && !fwdFrom.from_id;\r\n      if(message.viaBotId) {\r\n        titleVia = document.createElement('span');\r\n        titleVia.innerText = '@' + (await this.managers.appUsersManager.getUser(message.viaBotId)).username;\r\n        titleVia.classList.add('peer-title');\r\n        bubble.classList.add('must-have-name');\r\n      }\r\n      \r\n      if(isHidden) {\r\n        ///////this.log('message to render hidden', message);\r\n        title = document.createElement('span');\r\n        setInnerHTML(title, wrapEmojiText(fwdFrom.from_name));\r\n        title.classList.add('peer-title');\r\n        //title = fwdFrom.from_name;\r\n        bubble.classList.add('hidden-profile');\r\n      } else {\r\n        title = new PeerTitle({peerId: fwdFromId || message.fromId}).element;\r\n      }\r\n\r\n      if(message.reply_to_mid && message.reply_to_mid !== this.chat.threadId && isMessage) {\r\n        await MessageRender.setReply({\r\n          chat: this.chat,\r\n          bubble,\r\n          bubbleContainer,\r\n          message\r\n        });\r\n      }\r\n      \r\n      //this.log(title);\r\n      \r\n      let nameDiv: HTMLElement;\r\n      if((fwdFromId || fwdFrom)) {\r\n        if(this.peerId !== rootScope.myId && !isForwardFromChannel) {\r\n          bubble.classList.add('forwarded');\r\n        }\r\n        \r\n        if(message.savedFrom) {\r\n          savedFrom = message.savedFrom;\r\n          title.dataset.savedFrom = savedFrom;\r\n        }\r\n        \r\n        nameDiv = document.createElement('div');\r\n        title.dataset.peerId = '' + fwdFromId;\r\n\r\n        if((this.peerId === rootScope.myId || this.peerId === REPLIES_PEER_ID || isForwardFromChannel) && !isStandaloneMedia) {\r\n          nameDiv.style.color = getPeerColorById(fwdFromId, false);\r\n          nameDiv.append(title);\r\n        } else {\r\n          /* const fromTitle = message.fromId === this.myID || appPeersManager.isBroadcast(fwdFromId || message.fromId) ? '' : `<div class=\"name\" data-peer-id=\"${message.fromId}\" style=\"color: ${appPeersManager.getPeerColorByID(message.fromId, false)};\">${appPeersManager.getPeerTitle(message.fromId)}</div>`;\r\n          nameDiv.innerHTML = fromTitle + 'Forwarded from ' + title; */\r\n          const args: FormatterArguments = [title];\r\n          if(isStandaloneMedia) {\r\n            args.unshift(document.createElement('br'));\r\n          }\r\n          nameDiv.append(i18n('ForwardedFrom', [args]));\r\n        }\r\n      } else if(!message.viaBotId) {\r\n        if(!isStandaloneMedia && needName) {\r\n          nameDiv = document.createElement('div');\r\n          nameDiv.append(title);\r\n\r\n          const peer = await this.managers.appPeersManager.getPeer(message.fromId);\r\n          const pFlags = (peer as User.user)?.pFlags;\r\n          if(pFlags && (pFlags.scam || pFlags.fake)) {\r\n            nameDiv.append(generateFakeIcon(pFlags.scam));\r\n          }\r\n\r\n          if(!our) {\r\n            nameDiv.style.color = getPeerColorById(message.fromId, false);\r\n          }\r\n\r\n          nameDiv.dataset.peerId = '' + message.fromId;\r\n        } else /* if(!message.reply_to_mid) */ {\r\n          bubble.classList.add('hide-name');\r\n        }\r\n      }\r\n\r\n      if(message.viaBotId) {\r\n        if(!nameDiv) {\r\n          nameDiv = document.createElement('div');\r\n        } else {\r\n          nameDiv.append(' ');\r\n        }\r\n\r\n        const span = document.createElement('span');\r\n        span.append(i18n('ViaBot'), ' ', titleVia);\r\n        span.classList.add('is-via');\r\n\r\n        nameDiv.append(span);\r\n      }\r\n\r\n      if(nameDiv) {\r\n        nameDiv.classList.add('name');\r\n        nameContainer.append(nameDiv);\r\n      }\r\n    } else {\r\n      bubble.classList.add('hide-name');\r\n    }\r\n\r\n    if(this.chat.type === 'pinned') {\r\n      savedFrom = `${this.chat.peerId}_${message.mid}`;\r\n    }\r\n\r\n    const isThreadStarter = messageWithReplies && messageWithReplies.mid === this.chat.threadId;\r\n    if(isThreadStarter) {\r\n      bubble.classList.add('is-thread-starter', 'is-group-last');\r\n    }\r\n\r\n    if(savedFrom && (this.chat.type === 'pinned' || fwdFrom.saved_from_msg_id) && this.peerId !== REPLIES_PEER_ID) {\r\n      const goto = document.createElement('div');\r\n      goto.classList.add('bubble-beside-button', 'goto-original', 'tgico-arrow_next');\r\n      bubbleContainer.append(goto);\r\n      bubble.dataset.savedFrom = savedFrom;\r\n      bubble.classList.add('with-beside-button');\r\n    }\r\n    \r\n    bubble.classList.add(isOut ? 'is-out' : 'is-in');\r\n\r\n    if(withReplies) {\r\n      const isFooter = MessageRender.renderReplies({\r\n        bubble,\r\n        bubbleContainer,\r\n        message: messageWithReplies,\r\n        messageDiv,\r\n        loadPromises,\r\n        lazyLoadQueue: this.lazyLoadQueue\r\n      });\r\n\r\n      if(isFooter) {\r\n        canHaveTail = true;\r\n      }\r\n    }\r\n\r\n    if(isMessage) {\r\n      this.appendReactionsElementToBubble(bubble, message, reactionsMessage);\r\n    }\r\n\r\n    /* if(isMessage) {\r\n      const reactionHover = document.createElement('div');\r\n      reactionHover.classList.add('bubble-reaction-hover');\r\n      contentWrapper.append(reactionHover);\r\n    } */\r\n\r\n    if(canHaveTail) {\r\n      bubble.classList.add('can-have-tail');\r\n\r\n      bubbleContainer.append(generateTail());\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  private appendReactionsElementToBubble(bubble: HTMLElement, message: Message.message, reactionsMessage: Message.message, changedResults?: ReactionCount[]) {\r\n    if(this.peerId.isUser()/*  || true */) {\r\n      return;\r\n    }\r\n\r\n    if(!reactionsMessage?.reactions || !reactionsMessage.reactions.results.length) {\r\n      return;\r\n    }\r\n\r\n    // message = this.appMessagesManager.getMessageWithReactions(message);\r\n\r\n    const reactionsElement = new ReactionsElement();\r\n    reactionsElement.init(reactionsMessage, 'block');\r\n    reactionsElement.render(changedResults);\r\n\r\n    if(bubble.classList.contains('is-message-empty')) {\r\n      bubble.querySelector('.bubble-content-wrapper').append(reactionsElement);\r\n    } else {\r\n      const messageDiv = bubble.querySelector('.message');\r\n      if(bubble.classList.contains('is-multiple-documents')) {\r\n        const documentContainer = messageDiv.lastElementChild as HTMLElement;\r\n        let documentMessageDiv = documentContainer.querySelector('.document-message');\r\n\r\n        let timeSpan: HTMLElement = documentMessageDiv && documentMessageDiv.querySelector('.time');\r\n        if(!timeSpan) {\r\n          timeSpan = MessageRender.setTime({\r\n            chatType: this.chat.type,\r\n            message,\r\n            reactionsMessage\r\n          });\r\n        }\r\n        \r\n        reactionsElement.append(timeSpan);\r\n\r\n        if(!documentMessageDiv) {\r\n          documentMessageDiv = document.createElement('div');\r\n          documentMessageDiv.classList.add('document-message');\r\n          documentContainer.querySelector('.document-wrapper').prepend(documentMessageDiv);\r\n        }\r\n\r\n        documentMessageDiv.append(reactionsElement);\r\n      } else {\r\n        const timeSpan = Array.from(bubble.querySelectorAll('.time')).pop();\r\n        reactionsElement.append(timeSpan);\r\n        \r\n        messageDiv.append(reactionsElement);\r\n      }\r\n    }\r\n  }\r\n\r\n  private prepareToSaveScroll(reverse?: boolean) {\r\n    const isMounted = !!this.chatInner.parentElement;\r\n    if(!isMounted) {\r\n      return {};\r\n    }\r\n\r\n    const log = this.log.bindPrefix('prepareToSaveScroll');\r\n    log('save');\r\n    const scrollSaver = this.createScrollSaver(reverse);\r\n    scrollSaver.save(); // * let's save scroll position by point before the slicing, not after\r\n    \r\n    if(this.getRenderedLength() && !this.chat.setPeerPromise) {\r\n      const viewportSlice = this.getViewportSlice();\r\n      this.deleteViewportSlice(viewportSlice, true);\r\n    }\r\n    \r\n    // scrollSaver.save(); // ! slicing will corrupt scroll position\r\n    // const saved = scrollSaver.getSaved();\r\n    // const hadScroll = saved.scrollHeight !== saved.clientHeight;\r\n\r\n    return {\r\n      restoreScroll: () => {\r\n        log('restore');\r\n        // scrollSaver.restore(_history.length === 1 && !reverse ? false : true);\r\n        scrollSaver.restore(reverse);\r\n        this.onRenderScrollSet(scrollSaver.getSaved());\r\n      },\r\n      scrollSaver\r\n    };\r\n  }\r\n\r\n  public async performHistoryResult(historyResult: HistoryResult | {history: (Message.message | Message.messageService | number)[]}, reverse: boolean) {\r\n    const log = false ? this.log.bindPrefix('perform-' + (Math.random() * 1000 | 0)) : undefined;\r\n    log && log('start', this.chatInner.parentElement);\r\n\r\n    let history = historyResult.history;\r\n    history = history.slice(); // need\r\n\r\n    if(this.needReflowScroll) {\r\n      reflowScrollableElement(this.scrollable.container);\r\n      this.needReflowScroll = false;\r\n    }\r\n\r\n    const cb = (message: Message.message | Message.messageService) => {\r\n      if(!message) {\r\n        return;\r\n      } else if(message.pFlags.local) {\r\n        return this.processLocalMessageRender(message);\r\n      } else {\r\n        return this.safeRenderMessage(message, reverse);\r\n      }\r\n    };\r\n\r\n    const messages = await Promise.all(history.map((mid) => {\r\n      return typeof(mid) === 'number' ? this.chat.getMessage(mid) : mid;\r\n    }));\r\n\r\n    const setLoadedPromises: Promise<any>[] = [];\r\n    if(!this.scrollable.loadedAll['bottom'] || !this.scrollable.loadedAll['top']) {\r\n      let isEnd = (historyResult as HistoryResult).isEnd;\r\n      if(!isEnd) {\r\n        const historyStorage = await this.chat.getHistoryStorage();\r\n        const firstSlice = historyStorage.history.first;\r\n        const lastSlice = historyStorage.history.last;\r\n        isEnd = {top: false, bottom: false, both: false};\r\n        if(firstSlice.isEnd(SliceEnd.Bottom) && (!firstSlice.length || history.includes(firstSlice[0]))) {\r\n          isEnd.bottom = true;\r\n        }\r\n        \r\n        if(lastSlice.isEnd(SliceEnd.Top) && (!lastSlice.length || history.includes(lastSlice[lastSlice.length - 1]))) {\r\n          isEnd.top = true;\r\n        }\r\n      }\r\n\r\n      if(!isEnd.bottom && this.setPeerOptions) {\r\n        const {lastMsgId, topMessage} = this.setPeerOptions;\r\n        this.setPeerOptions = undefined;\r\n        if(!lastMsgId || this.bubbles[topMessage] || lastMsgId === topMessage) {\r\n          isEnd.bottom = true;\r\n        }\r\n      }\r\n\r\n      if(isEnd.top) setLoadedPromises.push(this.setLoaded('top', true));\r\n      if(isEnd.bottom) setLoadedPromises.push(this.setLoaded('bottom', true));\r\n    }\r\n\r\n    await Promise.all(setLoadedPromises);\r\n\r\n    // ! it is important to insert bubbles to group reversed way\r\n    // const length = history.length, promises: Promise<any>[] = [];\r\n    // if(reverse) for(let i = 0; i < length; ++i) promises.push(cb(messages[i]));\r\n    // else for(let i = length - 1; i >= 0; --i) promises.push(cb(messages[i]));\r\n    const promises = messages.map(cb);\r\n\r\n    // cannot combine them into one promise\r\n    await Promise.all(promises);\r\n    await this.messagesQueuePromise;\r\n\r\n    if(this.scrollable.loadedAll.top && this.messagesQueueOnRenderAdditional) {\r\n      this.messagesQueueOnRenderAdditional();\r\n\r\n      if(this.messagesQueueOnRenderAdditional) {\r\n        this.messagesQueueOnRenderAdditional();\r\n      }\r\n    }\r\n\r\n    log && log('performHistoryResult end');\r\n  }\r\n\r\n  private onRenderScrollSet(state?: {scrollHeight: number, clientHeight: number}) {\r\n    const className = 'has-sticky-dates';\r\n    if(!this.container.classList.contains(className)) {\r\n      const isLoading = !this.preloader.detached;\r\n\r\n      if(isLoading || \r\n        (\r\n          state ??= {\r\n            scrollHeight: this.scrollable.scrollHeight,\r\n            clientHeight: this.scrollable.container.clientHeight\r\n          }, \r\n          state.scrollHeight !== state.clientHeight\r\n        )\r\n      ) {\r\n        /* for(const timestamp in this.dateMessages) {\r\n          const dateMessage = this.dateMessages[timestamp];\r\n          dateMessage.div.classList.add('is-sticky');\r\n        } */\r\n        \r\n        const middleware = this.getMiddleware();\r\n        const callback = () => {\r\n          if(!middleware()) return;\r\n          this.container.classList.add(className);\r\n        };\r\n\r\n        if(this.willScrollOnLoad) {\r\n          callback();\r\n        } else {\r\n          setTimeout(callback, 600);\r\n        }\r\n\r\n        return;\r\n      }\r\n    }\r\n    \r\n    this.willScrollOnLoad = undefined;\r\n  }\r\n\r\n  public onDatePick = (timestamp: number) => {\r\n    const peerId = this.peerId;\r\n    this.managers.appMessagesManager.requestHistory(peerId, 0, 2, -1, timestamp, this.chat.threadId).then((history) => {\r\n      if(!history?.messages?.length) {\r\n        this.log.error('no history!');\r\n        return;\r\n      } else if(this.peerId !== peerId) {\r\n        return;\r\n      }\r\n\r\n      this.chat.setMessageId((history.messages[0] as MyMessage).mid);\r\n      //console.log('got history date:', history);\r\n    });\r\n  };\r\n\r\n  public requestHistory(maxId: number, loadCount: number, backLimit: number) {\r\n    //const middleware = this.getMiddleware();\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      return this.managers.acknowledged.appMessagesManager.getHistory(this.peerId, maxId, loadCount, backLimit, this.chat.threadId);\r\n    } else if(this.chat.type === 'pinned') {\r\n      return this.managers.acknowledged.appMessagesManager.getSearch({\r\n        peerId: this.peerId, \r\n        inputFilter: {_: 'inputMessagesFilterPinned'}, \r\n        maxId, \r\n        limit: loadCount, \r\n        backLimit\r\n      }).then((ackedResult) => {\r\n        return {\r\n          cached: ackedResult.cached,\r\n          result: Promise.resolve(ackedResult.result).then((value) => {\r\n            return {history: value.history.map((m) => m.mid)};\r\n          })\r\n        };\r\n      });\r\n    } else if(this.chat.type === 'scheduled') {\r\n      return this.managers.acknowledged.appMessagesManager.getScheduledMessages(this.peerId).then((ackedResult) => {\r\n        // this.setLoaded('top', true);\r\n        // this.setLoaded('bottom', true);\r\n        return {\r\n          cached: ackedResult.cached,\r\n          result: Promise.resolve(ackedResult.result).then((mids) => ({history: mids.slice().reverse()}))\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  private async animateAsLadder(additionMsgId: number, additionMsgIds: number[], isAdditionRender: boolean, backLimit: number, maxId: number) {\r\n    /* const middleware = this.getMiddleware();\r\n    await this.ladderDeferred; */\r\n\r\n    const log = this.log.bindPrefix('ladder');\r\n    if(this.chat.setPeerPromise && !this.resolveLadderAnimation) {\r\n      log.warn('will be delayed');\r\n      // @ts-ignore\r\n      this.resolveLadderAnimation = this.animateAsLadder.bind(this, additionMsgId, additionMsgIds, isAdditionRender, backLimit, maxId);\r\n      return;\r\n    }\r\n\r\n    /* if(!middleware()) {\r\n      return;\r\n    } */\r\n\r\n    if(!Object.keys(this.bubbles).length) {\r\n      log.warn('no bubbles');\r\n      return;\r\n    }\r\n\r\n    let sortedMids = getObjectKeysAndSort(this.bubbles, 'desc');\r\n\r\n    if(isAdditionRender && additionMsgIds.length) {\r\n      sortedMids = sortedMids.filter((mid) => !additionMsgIds.includes(mid));\r\n    }\r\n\r\n    let targetMid: number;\r\n    if(backLimit) {\r\n      targetMid = maxId || Math.max(...sortedMids); // * on discussion enter\r\n    } else {\r\n      if(additionMsgId) {\r\n        targetMid = additionMsgId;\r\n      } else { // * if maxId === 0\r\n        targetMid = Math.max(...sortedMids);\r\n      }\r\n    }\r\n\r\n    const topIds = sortedMids.slice(sortedMids.findIndex((mid) => targetMid > mid));\r\n    const middleIds = isAdditionRender ? [] : [targetMid];\r\n    const bottomIds = isAdditionRender ? [] : sortedMids.slice(0, sortedMids.findIndex((mid) => targetMid >= mid)).reverse();\r\n    \r\n    if(DEBUG) {\r\n      log('targeting mid:', targetMid, maxId, additionMsgId, \r\n        topIds.map((m) => getServerMessageId(m)), \r\n        bottomIds.map((m) => getServerMessageId(m)));\r\n    }\r\n\r\n    const setBubbles: HTMLElement[] = [];\r\n\r\n    this.chatInner.classList.add('zoom-fading');\r\n    const delay = isAdditionRender ? 10 : 40;\r\n    const offsetIndex = isAdditionRender ? 0 : 1;\r\n    const animateAsLadder = (mids: number[], offsetIndex = 0) => {\r\n      const animationPromise = deferredPromise<void>();\r\n      let lastMsDelay = 0;\r\n      mids.forEach((mid, idx) => {\r\n        const bubble = this.bubbles[mid];\r\n        if(!bubble || this.skippedMids.has(mid)) {\r\n          log.warn('no bubble by mid:', mid);\r\n          return;\r\n        }\r\n\r\n        lastMsDelay = ((idx + offsetIndex) || 0.1) * delay;\r\n        //lastMsDelay = (idx + offsetIndex) * delay;\r\n        //lastMsDelay = (idx || 0.1) * 1000;\r\n\r\n        const contentWrapper = bubble.lastElementChild as HTMLElement;\r\n        const elementsToAnimate: HTMLElement[] = [contentWrapper];\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        if(item && item.group.avatar && item.group.lastItem === item) {\r\n          elementsToAnimate.push(item.group.avatar);\r\n        }\r\n\r\n        elementsToAnimate.forEach((element) => {\r\n          element.classList.add('zoom-fade', 'can-zoom-fade');\r\n          element.style.transitionDelay = lastMsDelay + 'ms';\r\n        });\r\n        \r\n        if(idx === (mids.length - 1)) {\r\n          const onTransitionEnd = (e: TransitionEvent) => {\r\n            if(e.target !== contentWrapper) {\r\n              return;\r\n            }\r\n\r\n            animationPromise.resolve();\r\n            contentWrapper.removeEventListener('transitionend', onTransitionEnd);\r\n          };\r\n\r\n          contentWrapper.addEventListener('transitionend', onTransitionEnd);\r\n        }\r\n\r\n        setBubbles.push(...elementsToAnimate);\r\n      });\r\n\r\n      if(!mids.length) {\r\n        animationPromise.resolve();\r\n      }\r\n\r\n      return {lastMsDelay, animationPromise};\r\n    };\r\n\r\n    const topRes = animateAsLadder(topIds, offsetIndex);\r\n    const middleRes = animateAsLadder(middleIds);\r\n    const bottomRes = animateAsLadder(bottomIds, offsetIndex);\r\n    const promises = [topRes.animationPromise, middleRes.animationPromise, bottomRes.animationPromise];\r\n    const delays: number[] = [topRes.lastMsDelay, middleRes.lastMsDelay, bottomRes.lastMsDelay];\r\n\r\n    if(this.onAnimateLadder) {\r\n      await this.onAnimateLadder();\r\n    }\r\n\r\n    fastRaf(() => {\r\n      this.setStickyDateManually(); // ! maybe it's not efficient\r\n\r\n      setBubbles.forEach((element) => {\r\n        element.classList.remove('zoom-fade');\r\n      });\r\n    });\r\n\r\n    let promise: Promise<any>;\r\n    if(topIds.length || middleIds.length || bottomIds.length) {\r\n      promise = Promise.all(promises);\r\n\r\n      dispatchHeavyAnimationEvent(promise, Math.max(...delays) + 200) // * 200 - transition time\r\n      .then(() => { \r\n        fastRaf(() => {\r\n          setBubbles.forEach((element) => {\r\n            element.style.transitionDelay = '';\r\n            element.classList.remove('can-zoom-fade');\r\n          });\r\n\r\n          this.chatInner.classList.remove('zoom-fading');\r\n        });\r\n\r\n        // ! в хроме, каким-то образом из-за zoom-fade класса начинает прыгать скролл при подгрузке сообщений вверх, \r\n        // ! т.е. скролл не ставится, так же, как в сафари при translateZ на блок выше scrollable\r\n        // if(!IS_SAFARI) {\r\n        //   this.needReflowScroll = true;\r\n        // }\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async renderEmptyPlaceholder(\r\n    type: 'group' | 'saved' | 'noMessages' | 'noScheduledMessages' | 'greeting' | 'restricted', \r\n    bubble: HTMLElement, \r\n    message: any, \r\n    elements: (Node | string)[]\r\n  ) {\r\n    const BASE_CLASS = 'empty-bubble-placeholder';\r\n    bubble.classList.add(BASE_CLASS, BASE_CLASS + '-' + type);\r\n\r\n    let title: HTMLElement; \r\n    if(type === 'group') title = i18n('GroupEmptyTitle1');\r\n    else if(type === 'saved') title = i18n('ChatYourSelfTitle');\r\n    else if(type === 'noMessages' || type === 'greeting') title = i18n('NoMessages');\r\n    else if(type === 'noScheduledMessages') title = i18n('NoScheduledMessages');\r\n    else if(type === 'restricted') {\r\n      title = document.createElement('span');\r\n      title.innerText = await this.managers.appPeersManager.getRestrictionReasonText(this.peerId);\r\n    }\r\n    title.classList.add('center', BASE_CLASS + '-title');\r\n\r\n    elements.push(title);\r\n\r\n    let listElements: HTMLElement[];\r\n    if(type === 'group') {\r\n      elements.push(i18n('GroupEmptyTitle2'));\r\n      listElements = [\r\n        i18n('GroupDescription1'),\r\n        i18n('GroupDescription2'),\r\n        i18n('GroupDescription3'),\r\n        i18n('GroupDescription4')\r\n      ];\r\n    } else if(type === 'saved') {\r\n      listElements = [\r\n        i18n('ChatYourSelfDescription1'),\r\n        i18n('ChatYourSelfDescription2'),\r\n        i18n('ChatYourSelfDescription3'),\r\n        i18n('ChatYourSelfDescription4')\r\n      ];\r\n    } else if(type === 'greeting') {\r\n      const subtitle = i18n('NoMessagesGreetingsDescription');\r\n      subtitle.classList.add('center', BASE_CLASS + '-subtitle');\r\n\r\n      // findAndSplice(this.messagesQueue, q => q.bubble === bubble);\r\n\r\n      const stickerDiv = document.createElement('div');\r\n      stickerDiv.classList.add(BASE_CLASS + '-sticker');\r\n\r\n      const middleware = this.getMiddleware();\r\n      \r\n      await this.managers.appStickersManager.getGreetingSticker().then(async(doc) => {\r\n        if(!middleware()) return;\r\n\r\n        const loadPromises: Promise<any>[] = [];\r\n        await wrapSticker({\r\n          doc, \r\n          // doc: appDocsManager.getDoc(\"5431607541660389336\"), // cubigator mockup\r\n          div: stickerDiv,\r\n          middleware,\r\n          lazyLoadQueue: this.lazyLoadQueue,\r\n          group: CHAT_ANIMATION_GROUP,\r\n          //play: !!message.pending || !multipleRender,\r\n          play: true,\r\n          loop: true,\r\n          withThumb: true,\r\n          loadPromises\r\n        });\r\n\r\n        attachClickEvent(stickerDiv, (e) => {\r\n          cancelEvent(e);\r\n          EmoticonsDropdown.onMediaClick({target: e.target});\r\n        });\r\n\r\n        return Promise.all(loadPromises);\r\n      });\r\n\r\n      // this.renderMessagesQueue({\r\n      //   message, \r\n      //   bubble, \r\n      //   reverse: false, \r\n      //   promises: [loadPromise]\r\n      // });\r\n\r\n      elements.push(subtitle, stickerDiv);\r\n    }\r\n\r\n    if(listElements) {\r\n      elements.push(\r\n        ...listElements.map((elem) => {\r\n          const span = document.createElement('span');\r\n          span.classList.add(BASE_CLASS + '-list-item');\r\n          span.append(elem);\r\n          return span;\r\n        })\r\n      );\r\n  \r\n      if(type === 'group') {\r\n        listElements.forEach((elem) => {\r\n          const i = document.createElement('span');\r\n          i.classList.add('tgico-check');\r\n          elem.prepend(i);\r\n        });\r\n      } else if(type === 'saved') {\r\n        listElements.forEach((elem) => {\r\n          const i = document.createElement('span');\r\n          i.classList.add(BASE_CLASS + '-list-bullet');\r\n          i.innerText = '•';\r\n          elem.prepend(i);\r\n        });\r\n      }\r\n    }\r\n\r\n    if(elements.length > 1) {\r\n      bubble.classList.add('has-description');\r\n    }\r\n\r\n    elements.forEach((element: any) => element.classList.add(BASE_CLASS + '-line'));\r\n  }\r\n\r\n  private async processLocalMessageRender(message: Message.message | Message.messageService, animate?: boolean) {\r\n    const isSponsored = !!(message as Message.message).pFlags.sponsored;\r\n    const middleware = this.getMiddleware();\r\n    const m = middlewarePromise(middleware);\r\n    return this.safeRenderMessage(message, isSponsored ? false : true, undefined, false, async(result) => {\r\n      const {bubble} = await m(result);\r\n      if(!bubble) {\r\n        return result;\r\n      }\r\n\r\n      bubble.classList.add('is-group-last', 'is-group-first');\r\n\r\n      const updatePosition = () => {\r\n        if(this.updatePlaceholderPosition === updatePosition) {\r\n          this.updatePlaceholderPosition = undefined;\r\n        }\r\n\r\n        appendTo[method](bubble);\r\n      };\r\n\r\n      if(!isSponsored) {\r\n        bubble.classList.add('bubble-first');\r\n        bubble.classList.remove('can-have-tail', 'is-in');\r\n      }\r\n\r\n      const elements: (Node | string)[] = [];\r\n      const isBot = await m(this.managers.appPeersManager.isBot(this.peerId));\r\n      let renderPromise: Promise<any>, appendTo = this.container, method: 'append' | 'prepend' = 'append';\r\n      if(this.chat.isRestricted) {\r\n        renderPromise = this.renderEmptyPlaceholder('restricted', bubble, message, elements);\r\n      } else if(isSponsored) {\r\n        let text: LangPackKey, mid: number, startParam: string, callback: () => void;\r\n\r\n        bubble.classList.add('avoid-selection');\r\n\r\n        const sponsoredMessage = this.sponsoredMessage = (message as Message.message).sponsoredMessage;\r\n        const peerId = getPeerId(sponsoredMessage.from_id);\r\n        // const peer = this.appPeersManager.getPeer(peerId);\r\n        if(sponsoredMessage.channel_post) {\r\n          text = 'OpenChannelPost';\r\n          mid = generateMessageId(sponsoredMessage.channel_post);\r\n        } else if(sponsoredMessage.start_param || isBot) {\r\n          text = 'Chat.Message.ViewBot';\r\n          startParam = sponsoredMessage.start_param;\r\n        } else {\r\n          text = await this.managers.appPeersManager.isAnyGroup(peerId) ? 'Chat.Message.ViewGroup' : 'Chat.Message.ViewChannel';\r\n        }\r\n\r\n        if(sponsoredMessage.chat_invite) {\r\n          callback = () => {\r\n            new PopupJoinChatInvite(sponsoredMessage.chat_invite_hash, sponsoredMessage.chat_invite as ChatInvite.chatInvite);\r\n          };\r\n        } else if(sponsoredMessage.chat_invite_hash) {\r\n          callback = () => {\r\n            const link: InternalLink = {\r\n              _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n              invite: sponsoredMessage.chat_invite_hash\r\n            };\r\n            \r\n            this.chat.appImManager.processInternalLink(link);\r\n          };\r\n        } else {\r\n          callback = () => {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId,\r\n              lastMsgId: mid,\r\n              startParam\r\n            });\r\n          };\r\n        }\r\n\r\n        const button = Button('btn-primary btn-primary-transparent bubble-view-button', {\r\n          text\r\n        });\r\n\r\n        this.observer.observe(button, this.viewsObserverCallback);\r\n\r\n        if(callback) {\r\n          attachClickEvent(button, callback);\r\n        }\r\n\r\n        bubble.querySelector('.bubble-content').prepend(button);\r\n\r\n        return result;\r\n      } else if(isBot && message._ === 'message') {\r\n        const b = document.createElement('b');\r\n        b.append(i18n('BotInfoTitle'));\r\n        elements.push(b, '\\n\\n');\r\n        appendTo = this.chatInner;\r\n        method = 'prepend';\r\n      } else if(await m(this.managers.appPeersManager.isAnyGroup(this.peerId)) && (await m(this.managers.appPeersManager.getPeer(this.peerId))).pFlags.creator) {\r\n        renderPromise = this.renderEmptyPlaceholder('group', bubble, message, elements);\r\n      } else if(this.chat.type === 'scheduled') {\r\n        renderPromise = this.renderEmptyPlaceholder('noScheduledMessages', bubble, message, elements);\r\n      } else if(rootScope.myId === this.peerId) {\r\n        renderPromise = this.renderEmptyPlaceholder('saved', bubble, message, elements);\r\n      } else if(this.peerId.isUser() && !isBot && await m(this.chat.canSend()) && this.chat.type === 'chat') {\r\n        renderPromise = this.renderEmptyPlaceholder('greeting', bubble, message, elements);\r\n      } else {\r\n        renderPromise = this.renderEmptyPlaceholder('noMessages', bubble, message, elements);\r\n      }\r\n\r\n      if(renderPromise) {\r\n        await renderPromise;\r\n      }\r\n\r\n      if(elements.length) {\r\n        const messageDiv = bubble.querySelector('.message, .service-msg');\r\n        messageDiv.prepend(...elements);\r\n      }\r\n\r\n      const isWaitingForAnimation = !!this.messagesQueueOnRenderAdditional;\r\n      const noTransition = this.setPeerCached && !isWaitingForAnimation;\r\n      if(noTransition) {\r\n        const setOn = bubble.firstElementChild;\r\n        setOn.classList.add('no-transition');\r\n        \r\n        if(this.chat.setPeerPromise) {\r\n          this.chat.setPeerPromise.catch(noop).finally(() => {\r\n            setOn.classList.remove('no-transition');\r\n          });\r\n        }\r\n      }\r\n\r\n      if(animate === undefined && !noTransition) {\r\n        animate = true;\r\n      }\r\n\r\n      if(isWaitingForAnimation || animate) {\r\n        this.updatePlaceholderPosition = updatePosition;\r\n\r\n        this.onAnimateLadder = () => {\r\n          // appendTo[method](bubble);\r\n          this.onAnimateLadder = undefined;\r\n\r\n          // need raf here because animation won't fire if this message is single\r\n          if(!this.messagesQueuePromise) {\r\n            return fastRafPromise();\r\n          }\r\n        };\r\n      } else if(this.chat.setPeerPromise) {\r\n        this.attachPlaceholderOnRender = () => {\r\n          this.attachPlaceholderOnRender = undefined;\r\n          updatePosition();\r\n          // appendTo[method](bubble);\r\n        };\r\n      } else {\r\n        this.updatePlaceholderPosition = updatePosition;\r\n        // appendTo[method](bubble);\r\n      }\r\n\r\n      if(!isWaitingForAnimation && animate) {\r\n        await m(getHeavyAnimationPromise());\r\n        const additionMsgIds = getObjectKeysAndSort(this.bubbles);\r\n        indexOfAndSplice(additionMsgIds, message.mid);\r\n        this.animateAsLadder(message.mid, additionMsgIds, false, 0, 0);\r\n      }\r\n\r\n      // if(!isSponsored) {\r\n        this.emptyPlaceholderBubble = bubble;\r\n      // }\r\n\r\n      return result;\r\n    });\r\n  }\r\n\r\n  private generateLocalMessageId(addOffset = 0) {\r\n    // const INCREMENT = 0x10;\r\n    let offset = (this.chat.type === 'scheduled' ? -1 : 0) + addOffset;\r\n    // offset = generateMessageId(offset);\r\n    // id: -Math.abs(+this.peerId * INCREMENT + offset),\r\n    const id = -Math.abs(offset);\r\n    const mid = -Math.abs(generateMessageId(id));\r\n    return {id, mid};\r\n  }\r\n\r\n  private async generateLocalFirstMessage<T extends boolean>(service?: T, fill?: (message: GenerateLocalMessageType<T>) => void, addOffset = 0): Promise<GenerateLocalMessageType<T>> {\r\n    const {id, mid} = this.generateLocalMessageId(addOffset);\r\n    let message: Omit<Message.message | Message.messageService, 'message'> & {message?: string} = {\r\n      _: service ? 'messageService' : 'message',\r\n      date: 0,\r\n      id,\r\n      mid,\r\n      peer_id: await this.managers.appPeersManager.getOutputPeer(this.peerId),\r\n      pFlags: {\r\n        local: true\r\n      }\r\n    };\r\n\r\n    if(!service) {\r\n      message.message = '';\r\n    }/*  else {\r\n      (message as Message.messageService).action = {} as any;\r\n    } */\r\n\r\n    assumeType<GenerateLocalMessageType<T>>(message);\r\n\r\n    fill && fill(message);\r\n\r\n    const savedMessages = await this.managers.appMessagesManager.saveMessages([message], {storage: new Map() as any});\r\n    message = savedMessages[0];\r\n    message.mid = mid;\r\n    return message as any;\r\n  }\r\n\r\n  public getViewportSlice() {\r\n    // this.log.trace('viewport slice');\r\n    return getViewportSlice({\r\n      overflowElement: this.scrollable.container, \r\n      selector: '.bubbles-date-group .bubble:not(.is-date)',\r\n      extraSize: Math.max(700, windowSize.height) * 2\r\n    });\r\n  }\r\n\r\n  public deleteViewportSlice(slice: ReturnType<ChatBubbles['getViewportSlice']>, ignoreScrollSaving?: boolean) {\r\n    if(DO_NOT_SLICE_VIEWPORT_ON_RENDER) {\r\n      return;\r\n    }\r\n\r\n    const {invisibleTop, invisibleBottom} = slice;\r\n    const invisible = invisibleTop.concat(invisibleBottom);\r\n    if(!invisible.length) {\r\n      return;\r\n    }\r\n\r\n    if(invisibleTop.length) {\r\n      this.setLoaded('top', false);\r\n      this.getHistoryTopPromise = undefined;\r\n    }\r\n\r\n    if(invisibleBottom.length) {\r\n      this.setLoaded('bottom', false);\r\n      this.getHistoryBottomPromise = undefined;\r\n    }\r\n\r\n    const mids = invisible.map(({element}) => +element.dataset.mid);\r\n\r\n    let scrollSaver: ScrollSaver;\r\n    if(!!invisibleTop.length !== !!invisibleBottom.length && !ignoreScrollSaving) {\r\n      scrollSaver = this.createScrollSaver(!!invisibleTop.length);\r\n      scrollSaver.save();\r\n    }\r\n    \r\n    this.deleteMessagesByIds(mids, false, true);\r\n\r\n    if(scrollSaver) {\r\n      scrollSaver.restore();\r\n    } else if(invisibleTop.length) {\r\n      this.scrollable.lastScrollPosition = this.scrollable.scrollTop;\r\n    }\r\n  }\r\n\r\n  public sliceViewport(ignoreHeavyAnimation?: boolean) {\r\n    // Safari cannot reset the scroll.\r\n    if(IS_SAFARI || (this.isHeavyAnimationInProgress && !ignoreHeavyAnimation) || DO_NOT_SLICE_VIEWPORT) {\r\n      return;\r\n    }\r\n\r\n    // const scrollSaver = new ScrollSaver(this.scrollable, true);\r\n    // scrollSaver.save();\r\n    const slice = this.getViewportSlice();\r\n    // if(IS_SAFARI) slice.invisibleTop = [];\r\n    this.deleteViewportSlice(slice);\r\n    // scrollSaver.restore();\r\n  }\r\n\r\n  private async setLoaded(side: SliceSides, value: boolean, checkPlaceholders = true) {\r\n    const willChange = this.scrollable.loadedAll[side] !== value;\r\n    if(!willChange) {\r\n      return;\r\n    }\r\n\r\n    const log = this.log.bindPrefix('setLoaded');\r\n    log('change', side, value);\r\n\r\n    this.scrollable.loadedAll[side] = value;\r\n\r\n    // return;\r\n\r\n    if(!checkPlaceholders) {\r\n      return;\r\n    }\r\n\r\n    if(!this.chat.isRestricted) {\r\n      if(side === 'bottom' && await this.managers.appPeersManager.isBroadcast(this.peerId)/*  && false */) {\r\n        this.toggleSponsoredMessage(value);\r\n      }\r\n  \r\n      if(side === 'top' && value && await this.managers.appPeersManager.isBot(this.peerId)) {\r\n        return this.renderBotPlaceholder();\r\n      }\r\n    }\r\n\r\n    return this.checkIfEmptyPlaceholderNeeded();\r\n  }\r\n\r\n  private async toggleSponsoredMessage(value: boolean) {\r\n    const _log = this.log.bindPrefix('sponsored');\r\n    _log('checking');\r\n    const {mid} = this.generateLocalMessageId(SPONSORED_MESSAGE_ID_OFFSET);\r\n    if(value) {\r\n      const middleware = this.getMiddleware(() => {\r\n        return this.scrollable.loadedAll.bottom && !this.bubbles[mid] && this.getSponsoredMessagePromise === promise;\r\n      });\r\n\r\n      const promise = this.getSponsoredMessagePromise = this.managers.appChatsManager.getSponsoredMessage(this.peerId.toChatId())\r\n      .then(async(sponsoredMessages) => {\r\n        const sponsoredMessage = sponsoredMessages.messages[0];\r\n        if(!sponsoredMessage) {\r\n          _log('no message');\r\n          return;\r\n        }\r\n\r\n        const messagePromise = this.generateLocalFirstMessage(false, (message) => {\r\n          message.message = sponsoredMessage.message;\r\n          message.from_id = sponsoredMessage.from_id;\r\n          message.entities = sponsoredMessage.entities;\r\n          message.pFlags.sponsored = true;\r\n          message.sponsoredMessage = sponsoredMessage;\r\n        }, SPONSORED_MESSAGE_ID_OFFSET);\r\n  \r\n        return Promise.all([\r\n          messagePromise,\r\n          this.getHistoryTopPromise, // wait for top load and execute rendering after or with it\r\n          this.messagesQueuePromise\r\n        ]).then(([message]) => {\r\n          if(!middleware()) return;\r\n          // this.processLocalMessageRender(message);\r\n          _log('rendering', message);\r\n          const promise = this.performHistoryResult({history: [message]}, false);\r\n        });\r\n      }).finally(() => {\r\n        this.getSponsoredMessagePromise = undefined;\r\n      });\r\n    } else {\r\n      _log('clearing rendered', mid);\r\n      this.deleteMessagesByIds([mid]);\r\n      this.getSponsoredMessagePromise = undefined;\r\n    }\r\n  }\r\n\r\n  private async renderBotPlaceholder() {\r\n    const _log = this.log.bindPrefix('bot placeholder');\r\n      \r\n    const middleware = this.getMiddleware();\r\n    const result = await this.managers.acknowledged.appProfileManager.getProfile(this.peerId.toUserId());\r\n    _log('getting profile, cached:', result.cached);\r\n    const processPromise = result.result.then(async(userFull) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(!userFull.bot_info?.description) {\r\n        _log.warn('no description');\r\n        return this.checkIfEmptyPlaceholderNeeded();\r\n      }\r\n\r\n      const message = await this.generateLocalFirstMessage(false, (message) => {\r\n        message.message = userFull.bot_info.description;\r\n      });\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      _log('rendering');\r\n      const renderPromise = this.processLocalMessageRender(message, !result.cached).then(() => {\r\n        _log('done');\r\n      });\r\n\r\n      return {renderPromise};\r\n    });\r\n\r\n    if(!result.cached) {\r\n      return;\r\n    }\r\n\r\n    return processPromise;\r\n  }\r\n\r\n  public async checkIfEmptyPlaceholderNeeded() {\r\n    if(this.scrollable.loadedAll.top && \r\n      this.scrollable.loadedAll.bottom && \r\n      this.emptyPlaceholderBubble === undefined && \r\n      (\r\n        this.chat.isRestricted || \r\n        !(await this.chat.getHistoryStorage()).count || \r\n        (\r\n          !Object.keys(this.bubbles).length || \r\n          // ! WARNING ! ! ! ! ! ! REPLACE LINE ABOVE WITH THESE\r\n          Object.keys(this.bubbles).length && \r\n          !this.getRenderedLength()\r\n        ) ||\r\n        (this.chat.type === 'scheduled' && !Object.keys(this.bubbles).length)\r\n      )\r\n    ) {\r\n      this.log('inject empty peer placeholder');\r\n\r\n      const message = await this.generateLocalFirstMessage(true);\r\n      return {renderPromise: this.processLocalMessageRender(message)};\r\n    }\r\n  }\r\n\r\n  public getHistory1(maxId?: number, reverse?: boolean, isBackLimit?: boolean, additionMsgId?: number, justLoad?: boolean) {\r\n    const middleware = this.getMiddleware(justLoad ? undefined : () => {\r\n      return (reverse ? this.getHistoryTopPromise : this.getHistoryBottomPromise) === waitPromise;\r\n    });\r\n\r\n    const result = this.getHistory(maxId, reverse, isBackLimit, additionMsgId, justLoad, middleware);\r\n    const waitPromise = result.then((res) => res && (res.waitPromise || res.promise));\r\n\r\n    (reverse ? this.getHistoryTopPromise = waitPromise : this.getHistoryBottomPromise = waitPromise);\r\n    waitPromise.then(() => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      (reverse ? this.getHistoryTopPromise = undefined : this.getHistoryBottomPromise = undefined);\r\n\r\n      if(!justLoad) {\r\n        // preload more\r\n        //if(!isFirstMessageRender) {\r\n          if(this.chat.type === 'chat'/*  || this.chat.type === 'discussion' */) {\r\n            /* const storage = this.appMessagesManager.getHistoryStorage(peerId, this.chat.threadId);\r\n            const isMaxIdInHistory = storage.history.indexOf(maxId) !== -1;\r\n            if(isMaxIdInHistory || true) { // * otherwise it is a search or jump */\r\n              setTimeout(() => {\r\n                if(reverse) {\r\n                  this.loadMoreHistory(true, true);\r\n                } else {\r\n                  this.loadMoreHistory(false, true);\r\n                }\r\n              }, 0);\r\n            //}\r\n          }\r\n        //}\r\n      }\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Load and render history\r\n   * @param maxId max message id\r\n   * @param reverse 'true' means up\r\n   * @param isBackLimit is search\r\n   * @param additionMsgId for the last message\r\n   * @param justLoad do not render\r\n   */\r\n  public async getHistory(\r\n    maxId = 0, \r\n    reverse = false, \r\n    isBackLimit = false, \r\n    additionMsgId = 0, \r\n    justLoad = false,\r\n    middleware?: () => boolean\r\n  ): Promise<{cached: boolean, promise: Promise<void>, waitPromise: Promise<any>}> {\r\n    const peerId = this.peerId;\r\n\r\n    const isBroadcast = await this.managers.appPeersManager.isBroadcast(peerId);\r\n    //console.time('appImManager call getHistory');\r\n    const pageCount = Math.min(30, windowSize.height / 40/*  * 1.25 */ | 0);\r\n    //const loadCount = Object.keys(this.bubbles).length > 0 ? 50 : pageCount;\r\n    const realLoadCount = isBroadcast ? 20 : (Object.keys(this.bubbles).length > 0 ? Math.max(35, pageCount) : pageCount);\r\n    //const realLoadCount = pageCount;//const realLoadCount = 50;\r\n    let loadCount = realLoadCount;\r\n    \r\n    /* if(TEST_SCROLL) {\r\n      //loadCount = 1;\r\n      if(Object.keys(this.bubbles).length > 0)\r\n      return {cached: false, promise: Promise.resolve(true)};\r\n    } */\r\n    if(TEST_SCROLL !== undefined) {\r\n      if(TEST_SCROLL) {\r\n        if(Object.keys(this.bubbles).length > 0) {\r\n          --TEST_SCROLL;\r\n        }\r\n      } else {\r\n        return {cached: false, promise: Promise.resolve(), waitPromise: Promise.resolve()};\r\n      }\r\n    }\r\n    \r\n    ////console.time('render history total');\r\n    \r\n    let backLimit = 0;\r\n    if(isBackLimit) {\r\n      backLimit = loadCount;\r\n\r\n      if(!reverse) { // if not jump\r\n        loadCount = 0;\r\n        //maxId = this.appMessagesManager.incrementMessageId(maxId, 1);\r\n      }\r\n    }\r\n\r\n    let additionMsgIds: number[];\r\n    if(additionMsgId && !isBackLimit) {\r\n      if(this.chat.type === 'pinned') {\r\n        additionMsgIds = [additionMsgId];\r\n      } else {\r\n        const historyStorage = await this.chat.getHistoryStorage();\r\n        const slice = historyStorage.history.slice;\r\n        if(slice.length < loadCount && !slice.isEnd(SliceEnd.Both)) {\r\n          additionMsgIds = slice.slice();\r\n\r\n          // * filter last album, because we don't know is it the last item\r\n          for(let i = additionMsgIds.length - 1; i >= 0; --i) {\r\n            const message = await this.chat.getMessage(additionMsgIds[i]);\r\n            if((message as Message.message)?.grouped_id) additionMsgIds.splice(i, 1);\r\n            else break;\r\n          }\r\n\r\n          maxId = additionMsgIds[additionMsgIds.length - 1] || maxId;\r\n        }\r\n      }\r\n    }\r\n\r\n    /* const result = additionMsgID ? \r\n      {history: [additionMsgID]} : \r\n      appMessagesManager.getHistory(this.peerId, maxId, loadCount, backLimit); */\r\n    let result: AckedResult<MyHistoryResult> = await this.requestHistory(maxId, loadCount, backLimit) as any;\r\n    let resultPromise: typeof result['result'];\r\n\r\n    //const isFirstMessageRender = !!additionMsgID && result.cached && !appMessagesManager.getMessage(additionMsgID).grouped_id;\r\n    const isAdditionRender = additionMsgIds?.length && !result.cached;\r\n    const isFirstMessageRender = (this.isFirstLoad && backLimit && !result.cached) || isAdditionRender;\r\n    if(isAdditionRender) {\r\n      resultPromise = result.result;\r\n\r\n      result = {\r\n        cached: true,\r\n        result: Promise.resolve({history: additionMsgIds})\r\n      };\r\n\r\n      //additionMsgID = 0;\r\n    }\r\n\r\n    this.isFirstLoad = false;\r\n\r\n    const processResult = async(historyResult: Awaited<typeof result['result']>) => {\r\n      if((historyResult as HistoryResult).isEnd?.top) {\r\n        if(this.chat.type === 'discussion') { // * inject discussion start\r\n          const serviceStartMessageId = await this.managers.appMessagesManager.getThreadServiceMessageId(this.peerId, this.chat.threadId);\r\n          if(serviceStartMessageId) historyResult.history.push(serviceStartMessageId);\r\n          const mids = await this.chat.getMidsByMid(this.chat.threadId);\r\n          historyResult.history.push(...mids.reverse());\r\n        }\r\n\r\n        // synchronize bot placeholder appearance\r\n        await this.managers.appProfileManager.getProfileByPeerId(peerId);\r\n\r\n        // await this.setLoaded('top', true);\r\n      }\r\n    };\r\n\r\n    const sup = (historyResult: Awaited<typeof result['result']>) => {\r\n      return getHeavyAnimationPromise().then(() => {\r\n        return processResult(historyResult);\r\n      }).then(() => {\r\n        if(!isAdditionRender && additionMsgId) {\r\n          historyResult.history.unshift(additionMsgId);\r\n        }\r\n\r\n        return this.performHistoryResult(historyResult, reverse);\r\n      });\r\n    };\r\n\r\n    const processPromise = (_promise: typeof result['result']) => {\r\n      const promise = Promise.resolve(_promise).then((result) => {\r\n        if(middleware && !middleware()) {\r\n          throw PEER_CHANGED_ERROR;\r\n        }\r\n\r\n        if(justLoad) {\r\n          // нужно делать из-за ранней прогрузки\r\n          this.scrollable.onScroll();\r\n          // fastRaf(() => {\r\n          //   this.scrollable.checkForTriggers();\r\n          // });\r\n          return;\r\n        }\r\n\r\n        return sup(result);\r\n      }, (err) => {\r\n        this.log.error('getHistory error:', err);\r\n        throw err;\r\n      });\r\n      \r\n      return promise;\r\n    };\r\n\r\n    let promise: Promise<void>, cached: boolean;\r\n    if(!result.cached) {\r\n      cached = false;\r\n      promise = processPromise(result.result);\r\n    } else if(justLoad) {\r\n      // нужно делать из-за ранней прогрузки\r\n      this.scrollable.onScroll();\r\n      return null;\r\n    } else {\r\n      cached = true;\r\n      promise = sup(await result.result);\r\n    }\r\n\r\n    const waitPromise = isAdditionRender ? processPromise(resultPromise) : promise;\r\n\r\n    if(isFirstMessageRender && rootScope.settings.animationsEnabled/*  && false */) {\r\n      let times = isAdditionRender ? 2 : 1;\r\n      this.messagesQueueOnRenderAdditional = () => {\r\n        this.log('messagesQueueOnRenderAdditional');\r\n\r\n        if(--times) return;\r\n\r\n        this.messagesQueueOnRenderAdditional = undefined;\r\n        \r\n        const promise = this.animateAsLadder(additionMsgId, additionMsgIds, isAdditionRender, backLimit, maxId);\r\n        promise.then(() => {\r\n          setTimeout(() => { // preload messages\r\n            this.loadMoreHistory(reverse, true);\r\n          }, 0);\r\n        });\r\n      };\r\n    } else {\r\n      this.messagesQueueOnRenderAdditional = undefined;\r\n    }\r\n\r\n    if(justLoad) {\r\n      return null;\r\n    }\r\n\r\n    return {cached, promise, waitPromise};\r\n  }\r\n\r\n  public async setUnreadDelimiter() {\r\n    if(!(this.chat.type === 'chat' || this.chat.type === 'discussion')) {\r\n      return;\r\n    }\r\n\r\n    if(this.attachedUnreadBubble) {\r\n      return;\r\n    }\r\n\r\n    const historyMaxId = await this.chat.getHistoryMaxId();\r\n    let readMaxId = await this.managers.appMessagesManager.getReadMaxIdIfUnread(this.peerId, this.chat.threadId);\r\n    if(!readMaxId) return;\r\n\r\n    readMaxId = Object.keys(this.bubbles)\r\n    .filter((mid) => !this.bubbles[mid].classList.contains('is-out'))\r\n    .map((i) => +i)\r\n    .sort((a, b) => a - b)\r\n    .find((i) => i > readMaxId);\r\n\r\n    if(readMaxId && this.bubbles[readMaxId]) {\r\n      let bubble = this.bubbles[readMaxId];\r\n      if(this.firstUnreadBubble && this.firstUnreadBubble !== bubble) {\r\n        this.firstUnreadBubble.classList.remove('is-first-unread');\r\n        this.firstUnreadBubble = null;\r\n      }\r\n\r\n      if(readMaxId !== historyMaxId) {\r\n        bubble.classList.add('is-first-unread');\r\n      }\r\n\r\n      this.firstUnreadBubble = bubble;\r\n      this.attachedUnreadBubble = true;\r\n    }\r\n  }\r\n\r\n  public deleteEmptyDateGroups() {\r\n    const mustBeCount = this.stickyIntersector ? STICKY_OFFSET : 1;\r\n    let deleted = false;\r\n    for(const i in this.dateMessages) {\r\n      const dateMessage = this.dateMessages[i];\r\n\r\n      if(dateMessage.container.childElementCount === mustBeCount) { // only date div + sentinel div\r\n        dateMessage.container.remove();\r\n        if(this.stickyIntersector) {\r\n          this.stickyIntersector.unobserve(dateMessage.container, dateMessage.div);\r\n        }\r\n        delete this.dateMessages[i];\r\n        deleted = true;\r\n\r\n        // * no sense in it\r\n        /* if(dateMessage.div === this.previousStickyDate) {\r\n          this.previousStickyDate = undefined;\r\n        } */\r\n      }\r\n    }\r\n\r\n    if(!deleted) {\r\n      return;\r\n    }\r\n\r\n    if(!Object.keys(this.dateMessages).length) {\r\n      this.container.classList.remove('has-groups');\r\n    }\r\n\r\n    this.checkIfEmptyPlaceholderNeeded();\r\n    this.setStickyDateManually();\r\n  }\r\n}\r\n\r\nexport function generateTail() {\r\n  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n  svg.setAttributeNS(null, 'viewBox', '0 0 11 20');\r\n  svg.setAttributeNS(null, 'width', '11');\r\n  svg.setAttributeNS(null, 'height', '20');\r\n  svg.classList.add('bubble-tail');\r\n\r\n  const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use.setAttributeNS(null, 'href', '#message-tail-filled');\r\n\r\n  svg.append(use);\r\n\r\n  return svg;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { copyTextToClipboard } from \"../clipboard\";\r\n// import SelectionSaver from \"../selectionSaver\";\r\n// import selectElementContents from \"./selectElementContents\";\r\n\r\nexport default function copyFromElement(element: HTMLElement) {\r\n  copyTextToClipboard(element.textContent);\r\n  // const saver = new SelectionSaver();\r\n  // saver.save();\r\n  // selectElementContents(element);\r\n  // document.execCommand('copy');\r\n  // saver.restore();\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { MediaSizeType } from \"../../helpers/mediaSizes\";\r\nimport { Message } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport Chat from \"../chat/chat\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapDocument from \"./document\";\r\n\r\nexport default async function wrapGroupedDocuments({albumMustBeRenderedFull, message, bubble, messageDiv, chat, loadPromises, autoDownloadSize, lazyLoadQueue, searchContext, useSearch, sizeType, managers}: {\r\n  albumMustBeRenderedFull: boolean,\r\n  message: any,\r\n  messageDiv: HTMLElement,\r\n  bubble: HTMLElement,\r\n  uploading?: boolean,\r\n  chat: Chat,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  searchContext?: MediaSearchContext,\r\n  useSearch?: boolean,\r\n  sizeType?: MediaSizeType,\r\n  managers?: AppManagers\r\n}) {\r\n  let nameContainer: HTMLElement;\r\n  const mids = albumMustBeRenderedFull ? await chat.getMidsByMid(message.mid) : [message.mid];\r\n  /* if(isPending) {\r\n    mids.reverse();\r\n  } */\r\n\r\n  const promises = mids.map(async(mid, idx) => {\r\n    const message = (await chat.getMessage(mid)) as Message.message;\r\n    const div = await wrapDocument({\r\n      message,\r\n      loadPromises,\r\n      autoDownloadSize,\r\n      lazyLoadQueue,\r\n      searchContext,\r\n      sizeType,\r\n      managers\r\n    });\r\n\r\n    const container = document.createElement('div');\r\n    container.classList.add('document-container');\r\n    container.dataset.mid = '' + mid;\r\n    container.dataset.peerId = '' + message.peerId;\r\n\r\n    const wrapper = document.createElement('div');\r\n    wrapper.classList.add('document-wrapper');\r\n    \r\n    if(message.message) {\r\n      const messageDiv = document.createElement('div');\r\n      messageDiv.classList.add('document-message');\r\n\r\n      const richText = wrapRichText(message.message, {\r\n        entities: message.totalEntities\r\n      });\r\n\r\n      setInnerHTML(messageDiv, richText);\r\n      wrapper.append(messageDiv);\r\n    }\r\n\r\n    if(mids.length > 1) {\r\n      const selection = document.createElement('div');\r\n      selection.classList.add('document-selection');\r\n      container.append(selection);\r\n      \r\n      container.classList.add('grouped-item');\r\n\r\n      if(idx === 0) {\r\n        nameContainer = wrapper;\r\n      }\r\n    }\r\n\r\n    wrapper.append(div);\r\n    container.append(wrapper);\r\n    return container;\r\n  });\r\n\r\n  const containers = await Promise.all(promises);\r\n  messageDiv.append(...containers);\r\n\r\n  if(mids.length > 1) {\r\n    bubble.classList.add('is-multiple-documents', 'is-grouped');\r\n  }\r\n\r\n  return nameContainer;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PollElement from \"../poll\";\r\n\r\nexport default function wrapPoll(message: any, managers: AppManagers = rootScope.managers) {\r\n  const elem = new PollElement();\r\n  elem.message = message;\r\n  elem.managers = managers;\r\n  elem.setAttribute('peer-id', '' + message.peerId);\r\n  elem.setAttribute('poll-id', message.media.poll.id);\r\n  elem.setAttribute('message-id', '' + message.mid);\r\n  elem.render();\r\n  return elem;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getVisibleRect from \"./getVisibleRect\";\r\n\r\nexport type ViewportSlicePart = {element: HTMLElement, rect: DOMRect, visibleRect: ReturnType<typeof getVisibleRect>}[];\r\n\r\nexport default function getViewportSlice({overflowElement, selector, extraSize}: {\r\n  overflowElement: HTMLElement,\r\n  selector: string,\r\n  extraSize?: number\r\n}) {\r\n  // const perf = performance.now();\r\n  const overflowRect = overflowElement.getBoundingClientRect();\r\n  const elements = Array.from(overflowElement.querySelectorAll<HTMLElement>(selector));\r\n\r\n  const invisibleTop: ViewportSlicePart = [], \r\n    visible: typeof invisibleTop = [], \r\n    invisibleBottom: typeof invisibleTop = [];\r\n  let foundVisible = false;\r\n  for(const element of elements) {\r\n    const rect = element.getBoundingClientRect();\r\n    const visibleRect = getVisibleRect(element, overflowElement, false, rect, overflowRect);\r\n    \r\n    const isVisible = !!visibleRect;\r\n    let array: typeof invisibleTop;\r\n    if(isVisible) {\r\n      foundVisible = true;\r\n      array = visible;\r\n    } else if(foundVisible) {\r\n      array = invisibleBottom; \r\n    } else {\r\n      array = invisibleTop;\r\n    }\r\n\r\n    array.push({\r\n      element,\r\n      rect,\r\n      visibleRect\r\n    });\r\n  }\r\n\r\n  if(extraSize && visible.length) {\r\n    const maxTop = visible[0].rect.top;\r\n    const minTop = maxTop - extraSize;\r\n    const minBottom = visible[visible.length - 1].rect.bottom;\r\n    const maxBottom = minBottom + extraSize;\r\n    \r\n    for(let length = invisibleTop.length, i = length - 1; i >= 0; --i) {\r\n      const element = invisibleTop[i];\r\n      if(element.rect.top >= minTop) {\r\n        invisibleTop.splice(i, 1);\r\n        visible.unshift(element);\r\n      }\r\n    }\r\n\r\n    for(let i = 0, length = invisibleBottom.length; i < length; ++i) {\r\n      const element = invisibleBottom[i];\r\n      if(element.rect.bottom <= maxBottom) {\r\n        invisibleBottom.splice(i--, 1);\r\n        --length;\r\n        visible.push(element);\r\n      }\r\n    }\r\n  }\r\n\r\n  // console.log('getViewportSlice time:', performance.now() - perf);\r\n\r\n  return {invisibleTop, visible, invisibleBottom};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { FormatterArguments, LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default class PopupPinMessage {\r\n  constructor(private peerId: PeerId, private mid: number, private unpin?: true, private onConfirm?: () => void) {\r\n    this.construct();\r\n  }\r\n  \r\n  private async construct() {\r\n    const {peerId, mid, unpin, onConfirm} = this;\r\n    let title: LangPackKey, description: LangPackKey, descriptionArgs: FormatterArguments, \r\n      buttons: PopupPeerOptions['buttons'] = [], checkboxes: PopupPeerOptions['checkboxes'] = [];\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n\r\n    const canUnpin = await managers.appPeersManager.canPinMessage(peerId);\r\n\r\n    const callback = (checked: PopupPeerButtonCallbackCheckboxes, oneSide?: boolean, silent?: boolean) => {\r\n      setTimeout(() => { // * костыль, потому что document.elementFromPoint вернёт popup-peer пока он будет закрываться\r\n        let promise: Promise<any>;\r\n        if(unpin && !mid) {\r\n          if(canUnpin) {\r\n            promise = managers.appMessagesManager.unpinAllMessages(peerId);\r\n          } else {\r\n            promise = managers.appMessagesManager.hidePinnedMessages(peerId);\r\n          }\r\n        } else {\r\n          promise = managers.appMessagesManager.updatePinnedMessage(peerId, mid, unpin, silent, oneSide);\r\n        }\r\n\r\n        if(onConfirm) {\r\n          promise.then(onConfirm);\r\n        }\r\n      }, 300);\r\n    };\r\n\r\n    if(unpin) {\r\n      let buttonText: LangPackKey = 'UnpinMessage';\r\n      if(!mid) {\r\n        if(canUnpin) {\r\n          title = 'Popup.Unpin.AllTitle';\r\n          description = 'Chat.UnpinAllMessagesConfirmation';\r\n          descriptionArgs = ['' + ((await managers.appMessagesManager.getPinnedMessagesCount(peerId)) || 1)];\r\n        } else {\r\n          title = 'Popup.Unpin.HideTitle';\r\n          description = 'Popup.Unpin.HideDescription';\r\n          buttonText = 'Popup.Unpin.Hide';\r\n        }\r\n      } else {\r\n        title = 'UnpinMessageAlertTitle';\r\n        description = 'Chat.Confirm.Unpin';\r\n      }\r\n      \r\n      buttons.push({\r\n        langKey: buttonText,\r\n        isDanger: true,\r\n        callback\r\n      });\r\n    } else {\r\n      title = 'PinMessageAlertTitle';\r\n      const pinButtonText: LangPackKey = 'PinMessage';\r\n      \r\n      if(peerId.isAnyChat()) {\r\n        buttons.push({\r\n          langKey: pinButtonText,\r\n          callback: (checked) => callback(checked, false, !checked.size)\r\n        });\r\n\r\n        if(await managers.appChatsManager.isBroadcast(peerId.toChatId())) {\r\n          description = 'PinMessageAlertChannel';\r\n        } else {\r\n          description = 'PinMessageAlert';\r\n  \r\n          checkboxes.push({\r\n            text: 'PinNotify',\r\n            checked: true\r\n          });\r\n        }\r\n      } else {\r\n        description = 'PinMessageAlertChat';\r\n\r\n        if(peerId === rootScope.myId) {\r\n          buttons.push({\r\n            langKey: pinButtonText,\r\n            callback\r\n          });\r\n        } else {\r\n          buttons.push({\r\n            langKey: pinButtonText,\r\n            callback: (checked) => callback(checked, !checked.size)\r\n          });\r\n\r\n          checkboxes.push({\r\n            text: 'PinAlsoFor',\r\n            textArgs: [new PeerTitle({peerId}).element],\r\n            checked: true\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    addCancelButton(buttons);\r\n\r\n    const popup = new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    });\r\n\r\n    popup.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function isSelectionEmpty(selection = window.getSelection()) {\r\n  if(!selection || !selection.rangeCount) {\r\n    return true;\r\n  }\r\n\r\n  const selectionRange = selection.getRangeAt(0);\r\n  if(!selectionRange.toString() || !selectionRange.START_TO_END) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport lottieLoader from \"../lib/rlottie/lottieLoader\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { getEmojiToneIndex } from \"../vendor/emoji\";\r\nimport mediaSizes from \"./mediaSizes\";\r\nimport { saveLottiePreview } from \"./saveLottiePreview\";\r\n\r\nexport default function preloadAnimatedEmojiSticker(emoji: string, width?: number, height?: number) {\r\n  return rootScope.managers.appStickersManager.preloadAnimatedEmojiSticker(emoji).then(({doc}) => {\r\n    if(!doc) {\r\n      return;\r\n    }\r\n\r\n    return appDownloadManager.downloadMedia({media: doc})\r\n    .then(async(blob) => {\r\n      const mediaSize = mediaSizes.active.emojiSticker;\r\n      const toneIndex = getEmojiToneIndex(emoji);\r\n      const animation = await lottieLoader.loadAnimationWorker({\r\n        container: undefined,\r\n        animationData: blob,\r\n        width: width ?? mediaSize.width,\r\n        height: height ?? mediaSize.height,\r\n        name: 'doc' + doc.id,\r\n        autoplay: false,\r\n        loop: false,\r\n        toneIndex\r\n      }, 'none');\r\n\r\n      animation.addEventListener('firstFrame', () => {\r\n        saveLottiePreview(doc, animation.canvas, toneIndex);\r\n        animation.remove();\r\n      }, {once: true});\r\n    });\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { ReportReason } from \"../../layer\";\r\nimport InputField from \"../inputField\";\r\nimport { toastNew } from \"../toast\";\r\nimport wrapStickerEmoji from \"../wrappers/stickerEmoji\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupReportMessagesConfirm extends PopupPeer {\r\n  public static STICKER_EMOJI = '👮‍♀️';\r\n  constructor(peerId: PeerId, mids: number[], reason: ReportReason['_'], onConfirm?: () => void) {\r\n    super('popup-report-messages-confirm', {\r\n      noTitle: true, \r\n      descriptionLangKey: 'ReportInfo', \r\n      buttons: [{\r\n        langKey: 'ReportChat',\r\n        callback: () => {\r\n          if(!inputField.isValid()) {\r\n            return;\r\n          }\r\n\r\n          onConfirm && onConfirm();\r\n          this.managers.appMessagesManager.reportMessages(peerId, mids, reason, inputField.value).then((bool) => {\r\n            if(!bool) return;\r\n\r\n            toastNew({\r\n              langPackKey: 'ReportSentInfo'\r\n            });\r\n          });\r\n        }\r\n      }], \r\n      body: true\r\n    });\r\n\r\n    const div = document.createElement('div');\r\n    const size = 100;\r\n    wrapStickerEmoji({\r\n      div,\r\n      emoji: PopupReportMessagesConfirm.STICKER_EMOJI,\r\n      width: size,\r\n      height: size,\r\n    }).then(({render}) => render).finally(() => {\r\n      this.show();\r\n    });\r\n\r\n    this.header.append(div);\r\n\r\n    const inputField = new InputField({\r\n      label: 'ReportHint',\r\n      maxLength: 512,\r\n      placeholder: 'ReportChatDescription'\r\n    });\r\n\r\n    inputField.input.addEventListener('input', () => {\r\n      this.buttons[0].element.toggleAttribute('disabled', !inputField.isValid());\r\n    });\r\n\r\n    this.body.append(inputField.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport preloadAnimatedEmojiSticker from \"../../helpers/preloadAnimatedEmojiSticker\";\r\nimport { ReportReason } from \"../../layer\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport Button from \"../button\";\r\nimport PopupPeer from \"./peer\";\r\nimport PopupReportMessagesConfirm from \"./reportMessagesConfirm\";\r\n\r\nexport default class PopupReportMessages extends PopupPeer {\r\n  constructor(peerId: PeerId, mids: number[], onConfirm?: () => void) {\r\n    super('popup-report-messages', {titleLangKey: 'ChatTitle.ReportMessages', buttons: [], body: true});\r\n\r\n    mids = mids.slice();\r\n\r\n    const buttons: [LangPackKey, ReportReason['_']][] = [\r\n      ['ReportChatSpam', 'inputReportReasonSpam'],\r\n      ['ReportChatViolence', 'inputReportReasonViolence'],\r\n      ['ReportChatChild', 'inputReportReasonChildAbuse'],\r\n      ['ReportChatPornography', 'inputReportReasonPornography'],\r\n      ['ReportChatOther', 'inputReportReasonOther'],\r\n      ['ReportChatPersonalDetails', 'inputReportReasonPersonalDetails'],\r\n      ['ReportChatIllegalDrugs', 'inputReportReasonIllegalDrugs']\r\n    ];\r\n\r\n    const className = 'btn-primary btn-transparent';\r\n    buttons.forEach((b) => {\r\n      const button = Button(className, {/* icon: 'edit',  */text: b[0]});\r\n      this.body.append(button);\r\n    });\r\n\r\n    const preloadStickerPromise = preloadAnimatedEmojiSticker(PopupReportMessagesConfirm.STICKER_EMOJI);\r\n\r\n    attachClickEvent(this.body, (e) => {\r\n      const target = findUpClassName(e.target, 'btn-primary');\r\n      const reason = buttons[whichChild(target)][1];\r\n\r\n      preloadStickerPromise.then(() => {\r\n        this.hide();\r\n\r\n        new PopupReportMessagesConfirm(peerId, mids, reason, onConfirm);\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.body.style.margin = '0 -1rem';\r\n    this.buttonsEl.style.marginTop = '.5rem';\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport I18n, { i18n } from \"../../lib/langPack\";\r\nimport Scrollable from \"../scrollable\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupSponsored extends PopupPeer {\r\n  constructor() {\r\n    super('popup-sponsored', {\r\n      titleLangKey: 'Chat.Message.Sponsored.What',\r\n      descriptionLangKey: 'Chat.Message.Ad.Text',\r\n      descriptionLangArgs: [i18n('Chat.Message.Sponsored.Link')],\r\n      buttons: [{\r\n        langKey: 'OK',\r\n        isCancel: true\r\n      }, {\r\n        langKey: 'Chat.Message.Ad.ReadMore',\r\n        callback: () => {\r\n          window.open(I18n.format('Chat.Message.Sponsored.Link', true));\r\n        },\r\n        isCancel: true\r\n      }]\r\n    });\r\n\r\n    const scrollable = new Scrollable(undefined);\r\n    scrollable.onAdditionalScroll = () => {\r\n      scrollable.container.classList.toggle('scrolled-top', !scrollable.scrollTop);\r\n      scrollable.container.classList.toggle('scrolled-bottom', scrollable.isScrolledDown);\r\n    };\r\n\r\n    this.description.replaceWith(scrollable.container);\r\n\r\n    scrollable.container.append(this.description);\r\n    scrollable.container.classList.add('scrolled-top');\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport { Message } from \"../../layer\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport ReactionsElement from \"../chat/reactions\";\r\nimport { horizontalMenu } from \"../horizontalMenu\";\r\nimport Scrollable from \"../scrollable\";\r\nimport ScrollableLoader from \"../../helpers/scrollableLoader\";\r\nimport appDialogsManager from \"../../lib/appManagers/appDialogsManager\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { wrapSticker } from \"../wrappers\";\r\nimport ReactionElement from \"../chat/reaction\";\r\nimport getUserStatusString from \"../wrappers/getUserStatusString\";\r\n\r\nexport default class PopupReactedList extends PopupElement {\r\n  constructor(\r\n    private message: Message.message\r\n  ) {\r\n    super('popup-reacted-list', /* [{\r\n      langKey: 'Close',\r\n      isCancel: true\r\n    }] */null, {closable: true, overlayClosable: true, body: true});\r\n\r\n    this.init();\r\n  }\r\n\r\n  private async init() {\r\n    const message = await this.managers.appMessagesManager.getGroupsFirstMessage(this.message);\r\n\r\n    const canViewReadParticipants = await this.managers.appMessagesManager.canViewMessageReadParticipants(message);\r\n\r\n    // this.body.append(generateDelimiter());\r\n\r\n    const reactionsElement = new ReactionsElement();\r\n    const newMessage: Message.message = {\r\n      ...message,\r\n      mid: 0,\r\n      id: 0,\r\n      reactions: {\r\n        _: 'messageReactions',\r\n        results: [],\r\n\r\n        ...message.reactions,\r\n\r\n        pFlags: {},\r\n        recent_reactions: []\r\n      }\r\n    };\r\n\r\n    newMessage.reactions.results = newMessage.reactions.results.map((reactionCount) => {\r\n      return {\r\n        ...reactionCount,\r\n        pFlags: {}\r\n      };\r\n    });\r\n\r\n    reactionsElement.init(newMessage, 'block');\r\n    reactionsElement.render();\r\n    reactionsElement.classList.add('no-stripe');\r\n    reactionsElement.classList.remove('has-no-reactions');\r\n    \r\n    reactionsElement.append(this.btnClose);\r\n\r\n    this.header.append(reactionsElement);\r\n\r\n    const tabsContainer = document.createElement('div');\r\n    tabsContainer.classList.add('tabs-container');\r\n    tabsContainer.dataset.animation = 'tabs';\r\n\r\n    const loaders: Map<HTMLElement, ScrollableLoader> = new Map();\r\n\r\n    let hasAllReactions = false;\r\n    if(newMessage.reactions.results.length) {\r\n      const reaction = this.createFakeReaction('reactions', newMessage.reactions.results.reduce((acc, r) => acc + r.count, 0));\r\n\r\n      reactionsElement.prepend(reaction);\r\n      newMessage.reactions.results.unshift(reaction.reactionCount);\r\n      hasAllReactions = true;\r\n    }\r\n\r\n    let hasReadParticipants = false;\r\n    if(canViewReadParticipants) {\r\n      try {\r\n        const readUserIds = await this.managers.appMessagesManager.getMessageReadParticipants(message.peerId, message.mid);\r\n        if(!readUserIds.length) {\r\n          throw '';\r\n        }\r\n\r\n        const reaction = this.createFakeReaction('checks', readUserIds.length);\r\n\r\n        reactionsElement.prepend(reaction);\r\n        newMessage.reactions.results.unshift(reaction.reactionCount);\r\n        hasReadParticipants = true;\r\n      } catch(err) {\r\n\r\n      }\r\n    }\r\n    \r\n    newMessage.reactions.results.forEach((reactionCount) => {\r\n      const scrollable = new Scrollable(undefined);\r\n      scrollable.container.classList.add('tabs-tab');\r\n\r\n      const section = new SettingSection({\r\n        noShadow: true,\r\n        noDelimiter: true\r\n      });\r\n\r\n      const chatlist = appDialogsManager.createChatList({\r\n        dialogSize: 72\r\n      });\r\n\r\n      appDialogsManager.setListClickListener(chatlist, () => {\r\n        this.hide();\r\n      }, undefined, false, true);\r\n\r\n      section.content.append(chatlist);\r\n      scrollable.container.append(section.container);\r\n\r\n      const skipReadParticipants = reactionCount.reaction !== 'checks';\r\n      const skipReactionsList = reactionCount.reaction === 'checks';\r\n      if(['checks', 'reactions'].includes(reactionCount.reaction)) {\r\n        reactionCount.reaction = undefined;\r\n      }\r\n\r\n      let nextOffset: string;\r\n      const loader = new ScrollableLoader({\r\n        scrollable,\r\n        getPromise: async() => {\r\n          const result = await this.managers.appMessagesManager.getMessageReactionsListAndReadParticipants(message, undefined, reactionCount.reaction, nextOffset, skipReadParticipants, skipReactionsList);\r\n          nextOffset = result.nextOffset;\r\n\r\n          await Promise.all(result.combined.map(async({peerId, reaction}) => {\r\n            const {dom} = appDialogsManager.addDialogNew({\r\n              peerId: peerId,\r\n              autonomous: true,\r\n              container: chatlist,\r\n              avatarSize: 54,\r\n              rippleEnabled: false,\r\n              meAsSaved: false,\r\n            });\r\n\r\n            if(reaction) {\r\n              const stickerContainer = document.createElement('div');\r\n              stickerContainer.classList.add('reacted-list-reaction-icon');\r\n              const availableReaction = await this.managers.appReactionsManager.getReactionCached(reaction);\r\n\r\n              wrapSticker({\r\n                doc: availableReaction.static_icon,\r\n                div: stickerContainer,\r\n                width: 24,\r\n                height: 24\r\n              });\r\n  \r\n              dom.listEl.append(stickerContainer);\r\n            }\r\n\r\n            replaceContent(dom.lastMessageSpan, getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId())));\r\n          }));\r\n\r\n          return !nextOffset;\r\n        }\r\n      });\r\n\r\n      loaders.set(scrollable.container, loader);\r\n\r\n      tabsContainer.append(scrollable.container);\r\n    });\r\n\r\n    this.body.append(tabsContainer);\r\n\r\n    const selectTab = horizontalMenu(reactionsElement, tabsContainer, (id, tabContent) => {\r\n      if(id === (reactionsElement.childElementCount - 1)) {\r\n        return false;\r\n      }\r\n\r\n      const reaction = reactionsElement.children[id] as ReactionElement;\r\n      const prevId = selectTab.prevId();\r\n      if(prevId !== -1) {\r\n        (reactionsElement.children[prevId] as ReactionElement).setIsChosen(false);\r\n      }\r\n      \r\n      reaction.setIsChosen(true);\r\n\r\n      const loader = loaders.get(tabContent);\r\n      loader.load();\r\n    });\r\n\r\n    // selectTab(hasAllReactions && hasReadParticipants ? 1 : 0, false);\r\n    selectTab(0, false);\r\n\r\n    this.show();\r\n  }\r\n\r\n  private createFakeReaction(icon: string, count: number) {\r\n    const reaction = new ReactionElement();\r\n    reaction.init('block');\r\n    reaction.reactionCount = {\r\n      _: 'reactionCount',\r\n      count: count,\r\n      reaction: icon\r\n    };\r\n    reaction.setCanRenderAvatars(false);\r\n    reaction.renderCounter();\r\n\r\n    const allReactionsSticker = document.createElement('div');\r\n    allReactionsSticker.classList.add('reaction-counter', 'reaction-sticker-icon', 'tgico-' + icon);\r\n    reaction.prepend(allReactionsSticker);\r\n\r\n    return reaction;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_MOBILE, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport { Message, AvailableReaction } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport Scrollable, { ScrollableBase, ScrollableX } from \"../scrollable\";\r\nimport { wrapSticker } from \"../wrappers\";\r\n\r\nconst REACTIONS_CLASS_NAME = 'btn-menu-reactions';\r\nconst REACTION_CLASS_NAME = REACTIONS_CLASS_NAME + '-reaction';\r\n\r\nconst REACTION_SIZE = 26;\r\nconst PADDING = 4;\r\nexport const REACTION_CONTAINER_SIZE = REACTION_SIZE + PADDING * 2;\r\n\r\nconst CAN_USE_TRANSFORM = !IS_SAFARI;\r\n\r\ntype ChatReactionsMenuPlayers = {\r\n  select?: RLottiePlayer,\r\n  appear?: RLottiePlayer,\r\n  selectWrapper: HTMLElement,\r\n  appearWrapper: HTMLElement,\r\n  reaction: string\r\n};\r\nexport class ChatReactionsMenu {\r\n  public widthContainer: HTMLElement;\r\n  public container: HTMLElement;\r\n  private reactionsMap: Map<HTMLElement, ChatReactionsMenuPlayers>;\r\n  public scrollable: ScrollableBase;\r\n  private animationGroup: string;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private message: Message.message;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    private type: 'horizontal' | 'vertical',\r\n    middleware: ChatReactionsMenu['middleware']\r\n  ) {\r\n    const widthContainer = this.widthContainer = document.createElement('div');\r\n    widthContainer.classList.add(REACTIONS_CLASS_NAME + '-container');\r\n    widthContainer.classList.add(REACTIONS_CLASS_NAME + '-container-' + type);\r\n\r\n    const reactionsContainer = this.container = document.createElement('div');\r\n    reactionsContainer.classList.add(REACTIONS_CLASS_NAME);\r\n\r\n    const reactionsScrollable = this.scrollable = type === 'vertical' ? new Scrollable(undefined) : new ScrollableX(undefined);\r\n    reactionsContainer.append(reactionsScrollable.container);\r\n    reactionsScrollable.onAdditionalScroll = this.onScroll;\r\n    reactionsScrollable.setListeners();\r\n\r\n    reactionsScrollable.container.classList.add('no-scrollbar');\r\n\r\n    // ['big'].forEach((type) => {\r\n    //   const bubble = document.createElement('div');\r\n    //   bubble.classList.add(REACTIONS_CLASS_NAME + '-bubble', REACTIONS_CLASS_NAME + '-bubble-' + type);\r\n    //   reactionsContainer.append(bubble);\r\n    // });\r\n\r\n    this.reactionsMap = new Map();\r\n    this.animationGroup = 'CHAT-MENU-REACTIONS-' + Date.now();\r\n    animationIntersector.setOverrideIdleGroup(this.animationGroup, true);\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      reactionsContainer.addEventListener('mousemove', this.onMouseMove);\r\n    }\r\n\r\n    attachClickEvent(reactionsContainer, (e) => {\r\n      const reactionDiv = findUpClassName(e.target, REACTION_CLASS_NAME);\r\n      if(!reactionDiv) return;\r\n\r\n      const players = this.reactionsMap.get(reactionDiv);\r\n      if(!players) return;\r\n\r\n      this.managers.appReactionsManager.sendReaction(this.message, players.reaction);\r\n    });\r\n\r\n    widthContainer.append(reactionsContainer);\r\n\r\n    this.middleware = middleware ?? getMiddleware();\r\n  }\r\n\r\n  public init(message: Message.message) {\r\n    this.message = message;\r\n\r\n    const middleware = this.middleware.get();\r\n    // const result = Promise.resolve(this.appReactionsManager.getAvailableReactionsForPeer(message.peerId)).then((res) => pause(1000).then(() => res));\r\n    const result = this.managers.appReactionsManager.getAvailableReactionsByMessage(message);\r\n    callbackify(result, (reactions) => {\r\n      if(!middleware() || !reactions.length) return;\r\n      reactions.forEach((reaction) => {\r\n        this.renderReaction(reaction);\r\n      });\r\n\r\n      const setVisible = () => {\r\n        this.container.classList.add('is-visible');\r\n      };\r\n\r\n      if(result instanceof Promise) {\r\n        fastRaf(setVisible);\r\n      } else {\r\n        setVisible();\r\n      }\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.middleware.clean();\r\n    this.scrollable.removeListeners();\r\n    this.reactionsMap.clear();\r\n    animationIntersector.setOverrideIdleGroup(this.animationGroup, false);\r\n    animationIntersector.checkAnimations(true, this.animationGroup, true);\r\n  }\r\n\r\n  private onScroll = () => {\r\n    this.reactionsMap.forEach((players, div) => {\r\n      this.onScrollProcessItem(div, players);\r\n    });\r\n  };\r\n\r\n  private canUseAnimations() {\r\n    return rootScope.settings.animationsEnabled && !IS_MOBILE;\r\n  }\r\n\r\n  private renderReaction(reaction: AvailableReaction) {\r\n    const reactionDiv = document.createElement('div');\r\n    reactionDiv.classList.add(REACTION_CLASS_NAME);\r\n\r\n    const scaleContainer = document.createElement('div');\r\n    scaleContainer.classList.add(REACTION_CLASS_NAME + '-scale');\r\n\r\n    const appearWrapper = document.createElement('div');\r\n    let selectWrapper: HTMLElement;;\r\n    appearWrapper.classList.add(REACTION_CLASS_NAME + '-appear');\r\n\r\n    if(this.canUseAnimations()) {\r\n      selectWrapper = document.createElement('div');\r\n      selectWrapper.classList.add(REACTION_CLASS_NAME + '-select', 'hide');\r\n    }\r\n\r\n    const players: ChatReactionsMenuPlayers = {\r\n      selectWrapper,\r\n      appearWrapper,\r\n      reaction: reaction.reaction\r\n    };\r\n    this.reactionsMap.set(reactionDiv, players);\r\n\r\n    const middleware = this.middleware.get();\r\n\r\n    const hoverScale = IS_TOUCH_SUPPORTED ? 1 : 1.25;\r\n    const size = REACTION_SIZE * hoverScale;\r\n\r\n    const options = {\r\n      width: size,\r\n      height: size,\r\n      skipRatio: 1,\r\n      needFadeIn: false,\r\n      withThumb: false,\r\n      group: this.animationGroup,\r\n      middleware\r\n    };\r\n\r\n    if(!this.canUseAnimations()) {\r\n      delete options.needFadeIn;\r\n      delete options.withThumb;\r\n\r\n      wrapSticker({\r\n        doc: reaction.static_icon,\r\n        div: appearWrapper,\r\n        ...options\r\n      });\r\n    } else {\r\n      let isFirst = true;\r\n      wrapSticker({\r\n        doc: reaction.appear_animation,\r\n        div: appearWrapper,\r\n        play: true,\r\n        ...options\r\n      }).then(({render}) => render).then((player) => {\r\n        assumeType<RLottiePlayer>(player);\r\n  \r\n        players.appear = player;\r\n  \r\n        player.addEventListener('enterFrame', (frameNo) => {\r\n          if(player.maxFrame === frameNo) {\r\n            selectLoadPromise.then((selectPlayer) => {\r\n              assumeType<RLottiePlayer>(selectPlayer);\r\n              appearWrapper.classList.add('hide');\r\n              selectWrapper.classList.remove('hide');\r\n  \r\n              if(isFirst) {\r\n                players.select = selectPlayer;\r\n                isFirst = false;\r\n              }\r\n            }, noop);\r\n          }\r\n        });\r\n      }, noop);\r\n  \r\n      const selectLoadPromise = wrapSticker({\r\n        doc: reaction.select_animation,\r\n        div: selectWrapper,\r\n        ...options\r\n      }).then(({render}) => render).then((player) => {\r\n        assumeType<RLottiePlayer>(player);\r\n\r\n        return lottieLoader.waitForFirstFrame(player);\r\n      }).catch(noop);\r\n    }\r\n    \r\n    scaleContainer.append(appearWrapper);\r\n    selectWrapper && scaleContainer.append(selectWrapper);\r\n    reactionDiv.append(scaleContainer);\r\n    this.scrollable.append(reactionDiv);\r\n  }\r\n\r\n  private onScrollProcessItem(div: HTMLElement, players: ChatReactionsMenuPlayers) {\r\n    // return;\r\n\r\n    const scaleContainer = div.firstElementChild as HTMLElement;\r\n    const visibleRect = getVisibleRect(div, this.scrollable.container);\r\n    let transform: string;\r\n    if(!visibleRect) {\r\n      if(!players.appearWrapper.classList.contains('hide') || !players.appear) {\r\n        return;\r\n      }\r\n\r\n      if(players.select) {\r\n        players.select.stop();\r\n      }\r\n\r\n      players.appear.stop();\r\n      players.appear.autoplay = true;\r\n      players.appearWrapper.classList.remove('hide');\r\n      players.selectWrapper.classList.add('hide');\r\n\r\n      transform = '';\r\n    } else if(visibleRect.overflow.left || visibleRect.overflow.right) {\r\n      const diff = Math.abs(visibleRect.rect.left - visibleRect.rect.right);\r\n      const scale = Math.min(diff ** 2 / REACTION_CONTAINER_SIZE ** 2, 1);\r\n\r\n      transform = 'scale(' + scale + ')';\r\n    } else {\r\n      transform = '';\r\n    }\r\n\r\n    if(CAN_USE_TRANSFORM) {\r\n      scaleContainer.style.transform = transform;\r\n    }\r\n  }\r\n\r\n  private onMouseMove = (e: MouseEvent) => {\r\n    const reactionDiv = findUpClassName(e.target, REACTION_CLASS_NAME);\r\n    if(!reactionDiv) {\r\n      return;\r\n    }\r\n    \r\n    const players = this.reactionsMap.get(reactionDiv);\r\n    if(!players) {\r\n      return;\r\n    }\r\n\r\n    // do not play select animation when appearing\r\n    if(!players.appear?.paused) {\r\n      return;\r\n    }\r\n\r\n    const player = players.select;\r\n    if(!player) {\r\n      return;\r\n    }\r\n\r\n    if(player.paused) {\r\n      player.autoplay = true;\r\n      player.restart();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type Chat from \"./chat\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport PopupDeleteMessages from \"../popups/deleteMessages\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport PopupPinMessage from \"../popups/unpinMessage\";\r\nimport { copyTextToClipboard } from \"../../helpers/clipboard\";\r\nimport PopupSendNow from \"../popups/sendNow\";\r\nimport { toast } from \"../toast\";\r\nimport I18n, { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport isSelectionEmpty from \"../../helpers/dom/isSelectionEmpty\";\r\nimport { Message, Poll, Chat as MTChat, MessageMedia, AvailableReaction } from \"../../layer\";\r\nimport PopupReportMessages from \"../popups/reportMessages\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport PopupSponsored from \"../popups/sponsored\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport { IS_APPLE } from \"../../environment/userAgent\";\r\nimport PopupReactedList from \"../popups/reactedList\";\r\nimport { ChatReactionsMenu, REACTION_CONTAINER_SIZE } from \"./reactionsMenu\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport positionMenu, { MenuPositionPadding } from \"../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport { SERVICE_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\n\r\nexport default class ChatContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify: () => boolean | Promise<boolean>, notDirect?: () => boolean, withSelection?: true, isSponsored?: true})[];\r\n  private element: HTMLElement;\r\n\r\n  private isSelectable: boolean;\r\n  private isSelected: boolean;\r\n  private target: HTMLElement;\r\n  private isTargetAGroupedItem: boolean;\r\n  private isTextSelected: boolean;\r\n  private isAnchorTarget: boolean;\r\n  private isUsernameTarget: boolean;\r\n  private isSponsored: boolean;\r\n  private isOverBubble: boolean;\r\n  private peerId: PeerId;\r\n  private mid: number;\r\n  private message: Message.message | Message.messageService;\r\n  private noForwards: boolean;\r\n\r\n  private reactionsMenu: ChatReactionsMenu;\r\n  private listenerSetter: ListenerSetter;\r\n  private attachListenerSetter: ListenerSetter;\r\n\r\n  private viewerPeerId: PeerId;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private canOpenReactedList: boolean;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.attachListenerSetter = new ListenerSetter();\r\n    this.middleware = getMiddleware();\r\n  }\r\n\r\n  public attachTo(element: HTMLElement) {\r\n    this.attachListenerSetter.removeAll();\r\n    \r\n    if(IS_TOUCH_SUPPORTED/*  && false */) {\r\n      attachClickEvent(element, (e) => {\r\n        if(this.chat.selection.isSelecting) {\r\n          return;\r\n        }\r\n\r\n        this.chat.log('touchend', e);\r\n\r\n        const badSelectors = [\r\n          '.name',\r\n          '.peer-title',\r\n          '.reply',\r\n          '.document',\r\n          'audio-element',\r\n          'avatar-element',\r\n          'a',\r\n          '.bubble-beside-button',\r\n          'replies-element',\r\n          '[data-saved-from]:not(.bubble)',\r\n          'poll-element',\r\n          'attachment'\r\n        ];\r\n        let good = !(e.target as HTMLElement).closest(badSelectors.join(', '));\r\n        if(good) {\r\n          cancelEvent(e);\r\n          //onContextMenu((e as TouchEvent).changedTouches[0]);\r\n          // onContextMenu((e as TouchEvent).changedTouches ? (e as TouchEvent).changedTouches[0] : e as MouseEvent);\r\n          this.onContextMenu(e);\r\n        }\r\n      }, {listenerSetter: this.attachListenerSetter});\r\n    } else attachContextMenuListener(element, this.onContextMenu, this.attachListenerSetter);\r\n  }\r\n\r\n  private onContextMenu = (e: MouseEvent | Touch | TouchEvent) => {\r\n    let bubble: HTMLElement, contentWrapper: HTMLElement;\r\n\r\n    try {\r\n      contentWrapper = findUpClassName(e.target, 'bubble-content-wrapper');\r\n      bubble = contentWrapper ? contentWrapper.parentElement : findUpClassName(e.target, 'bubble');\r\n    } catch(e) {}\r\n\r\n    // ! context menu click by date bubble (there is no pointer-events)\r\n    if(!bubble || bubble.classList.contains('bubble-first')) return;\r\n\r\n    let element = this.element;\r\n    if(e instanceof MouseEvent || e.hasOwnProperty('preventDefault')) (e as any).preventDefault();\r\n    if(element && element.classList.contains('active')) {\r\n      return false;\r\n    }\r\n    if(e instanceof MouseEvent || e.hasOwnProperty('cancelBubble')) (e as any).cancelBubble = true;\r\n\r\n    let mid = +bubble.dataset.mid;\r\n    if(!mid) return;\r\n    \r\n    const r = async() => {\r\n      const isSponsored = this.isSponsored = mid < 0;\r\n      this.isSelectable = this.chat.selection.canSelectBubble(bubble);\r\n      this.peerId = this.chat.peerId;\r\n      //this.msgID = msgID;\r\n      this.target = e.target as HTMLElement;\r\n      this.isTextSelected = !isSelectionEmpty();\r\n      this.isAnchorTarget = this.target.tagName === 'A' && (\r\n        (this.target as HTMLAnchorElement).target === '_blank' || \r\n        this.target.classList.contains('anchor-url')\r\n      );\r\n      this.isUsernameTarget = this.target.tagName === 'A' && this.target.classList.contains('mention');\r\n\r\n      // * если открыть контекстное меню для альбома не по бабблу, и последний элемент не выбран, чтобы показать остальные пункты\r\n      if(this.chat.selection.isSelecting && !contentWrapper) {\r\n        if(isSponsored) {\r\n          return;\r\n        }\r\n\r\n        const mids = await this.chat.getMidsByMid(mid);\r\n        if(mids.length > 1) {\r\n          const selectedMid = this.chat.selection.isMidSelected(this.peerId, mid) ? \r\n            mid : \r\n            mids.find((mid) => this.chat.selection.isMidSelected(this.peerId, mid));\r\n          if(selectedMid) {\r\n            mid = selectedMid;\r\n          }\r\n        }\r\n      }\r\n\r\n      this.isOverBubble = !!contentWrapper;\r\n\r\n      const groupedItem = findUpClassName(this.target, 'grouped-item');\r\n      this.isTargetAGroupedItem = !!groupedItem;\r\n      if(groupedItem) {\r\n        this.mid = +groupedItem.dataset.mid;\r\n      } else {\r\n        this.mid = mid;\r\n      }\r\n\r\n      this.isSelected = this.chat.selection.isMidSelected(this.peerId, this.mid);\r\n      this.message = await this.chat.getMessage(this.mid);\r\n      this.noForwards = !isSponsored && !(await this.managers.appMessagesManager.canForward(this.message));\r\n      this.viewerPeerId = undefined;\r\n      this.canOpenReactedList = undefined;\r\n\r\n      const initResult = await this.init();\r\n      if(!initResult) {\r\n        return;\r\n      }\r\n      \r\n      element = initResult.element;\r\n      const {cleanup, destroy, menuPadding, reactionsMenu, reactionsMenuPosition} = initResult;\r\n      let isReactionsMenuVisible = false;\r\n      if(reactionsMenu) {\r\n        const className = 'is-visible';\r\n        isReactionsMenuVisible = reactionsMenu.container.classList.contains(className);\r\n        if(isReactionsMenuVisible) reactionsMenu.container.classList.remove(className);\r\n\r\n        if(reactionsMenuPosition === 'horizontal') {\r\n          const offsetSize = element[/* reactionsMenuPosition === 'vertical' ? 'offsetHeight' :  */'offsetWidth'];\r\n          // if(reactionsMenu.scrollable.container.scrollWidth > offsetWidth) {\r\n            const INNER_CONTAINER_PADDING = 8;\r\n            const visibleLength = (offsetSize - INNER_CONTAINER_PADDING) / REACTION_CONTAINER_SIZE;\r\n            const nextVisiblePart = visibleLength % 1;\r\n            const MIN_NEXT_VISIBLE_PART = 0.65;\r\n            if(nextVisiblePart < MIN_NEXT_VISIBLE_PART) {\r\n              const minSize = (offsetSize + (MIN_NEXT_VISIBLE_PART - nextVisiblePart) * REACTION_CONTAINER_SIZE) | 0;\r\n              element.style[/* reactionsMenuPosition === 'vertical' ? 'minHeight' :  */'minWidth'] = minSize + 'px';\r\n            }\r\n          // }\r\n        }\r\n      }\r\n      \r\n      const side: 'left' | 'right' = bubble.classList.contains('is-in') ? 'left' : 'right';\r\n      //bubble.parentElement.append(element);\r\n      //appImManager.log('contextmenu', e, bubble, side);\r\n      positionMenu((e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent, element, side, menuPadding);\r\n\r\n      if(reactionsMenu) {\r\n        reactionsMenu.widthContainer.style.top = element.style.top;\r\n        reactionsMenu.widthContainer.style.left = element.style.left;\r\n        reactionsMenu.widthContainer.style.setProperty('--menu-width', element[reactionsMenuPosition === 'vertical' ? 'offsetHeight' : 'offsetWidth'] + 'px');\r\n        element.parentElement.append(reactionsMenu.widthContainer);\r\n        if(isReactionsMenuVisible) void reactionsMenu.container.offsetLeft; // reflow\r\n      }\r\n\r\n      contextMenuController.openBtnMenu(element, () => {\r\n        if(reactionsMenu) {\r\n          reactionsMenu.container.classList.remove('is-visible');\r\n        }\r\n\r\n        this.mid = 0;\r\n        this.peerId = undefined;\r\n        this.target = null;\r\n        this.viewerPeerId = undefined;\r\n        this.canOpenReactedList = undefined;\r\n        cleanup();\r\n\r\n        setTimeout(() => {\r\n          destroy();\r\n        }, 300);\r\n      });\r\n\r\n      if(isReactionsMenuVisible) {\r\n        reactionsMenu.container.classList.add('is-visible');\r\n      }\r\n    };\r\n    \r\n    r();\r\n  };\r\n\r\n  public cleanup() {\r\n    this.listenerSetter.removeAll();\r\n    this.reactionsMenu && this.reactionsMenu.cleanup();\r\n    this.middleware.clean();\r\n  }\r\n\r\n  public destroy() {\r\n    this.cleanup();\r\n    this.attachListenerSetter.removeAll();\r\n  }\r\n\r\n  private async filterButtons(buttons: ChatContextMenu['buttons']) {\r\n    if(this.isSponsored) {\r\n      return buttons.filter((button) => {\r\n        return button.isSponsored;\r\n      });\r\n    } else {\r\n      return filterAsync(buttons, async(button) => {\r\n        let good: boolean;\r\n\r\n        //if((appImManager.chatSelection.isSelecting && !button.withSelection) || (button.withSelection && !appImManager.chatSelection.isSelecting)) {\r\n        if(this.chat.selection.isSelecting && !button.withSelection) {\r\n          good = false;\r\n        } else {\r\n          good = this.isOverBubble || IS_TOUCH_SUPPORTED || true ? \r\n            await button.verify() : \r\n            button.notDirect && await button.verify() && button.notDirect();\r\n        }\r\n\r\n        return !!good;\r\n      });\r\n    }\r\n  }\r\n\r\n  private setButtons() {\r\n    this.buttons = [{\r\n      icon: 'send2',\r\n      text: 'MessageScheduleSend',\r\n      onClick: this.onSendScheduledClick,\r\n      verify: () => this.chat.type === 'scheduled' && !this.message.pFlags.is_outgoing\r\n    }, {\r\n      icon: 'send2',\r\n      text: 'Message.Context.Selection.SendNow',\r\n      onClick: this.onSendScheduledClick,\r\n      verify: () => this.chat.type === 'scheduled' && this.isSelected && !this.chat.selection.selectionSendNowBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'MessageScheduleEditTime',\r\n      onClick: () => {\r\n        this.chat.input.scheduleSending(() => {\r\n          assumeType<Message.message>(this.message);\r\n          this.managers.appMessagesManager.editMessage(this.message, this.message.message, {\r\n            scheduleDate: this.chat.input.scheduleDate,\r\n            entities: this.message.entities\r\n          });\r\n\r\n          this.chat.input.onMessageSent(false, false);\r\n        }, new Date(this.message.date * 1000));\r\n      },\r\n      verify: () => this.chat.type === 'scheduled'\r\n    }, {\r\n      icon: 'reply',\r\n      text: 'Reply',\r\n      onClick: this.onReplyClick,\r\n      verify: async() => await this.chat.canSend() && \r\n        !this.message.pFlags.is_outgoing && \r\n        !!this.chat.input.messageInput && \r\n        this.chat.type !== 'scheduled'/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'edit',\r\n      text: 'Edit',\r\n      onClick: this.onEditClick,\r\n      verify: async() => (await this.managers.appMessagesManager.canEditMessage(this.message, 'text')) && !!this.chat.input.messageInput\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Copy',\r\n      onClick: this.onCopyClick,\r\n      verify: () => !this.noForwards && !!(this.message as Message.message).message && !this.isTextSelected && (!this.isAnchorTarget || (this.message as Message.message).message !== this.target.innerText)\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Chat.CopySelectedText',\r\n      onClick: this.onCopyClick,\r\n      verify: () => !this.noForwards && !!(this.message as Message.message).message && this.isTextSelected\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Message.Context.Selection.Copy',\r\n      onClick: this.onCopyClick,\r\n      verify: async() => {\r\n        if(!this.isSelected || this.noForwards) {\r\n          return false;\r\n        }\r\n\r\n        for(const [peerId, mids] of this.chat.selection.selectedMids) {\r\n          const storageKey: MessagesStorageKey = `${peerId}_${this.chat.type === 'scheduled' ? 'scheduled' : 'history'}`;\r\n          for(const mid of mids) {\r\n            const message = (await this.managers.appMessagesManager.getMessageFromStorage(storageKey, mid)) as Message.message;\r\n            if(!!message.message) {\r\n              return true;\r\n            }\r\n          }\r\n        }\r\n\r\n        return false;\r\n      },\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'CopyLink',\r\n      onClick: this.onCopyAnchorLinkClick,\r\n      verify: () => this.isAnchorTarget,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Text.Context.Copy.Username',\r\n      onClick: () => {\r\n        copyTextToClipboard(this.target.innerHTML);\r\n      },\r\n      verify: () => this.isUsernameTarget,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Text.Context.Copy.Hashtag',\r\n      onClick: () => {\r\n        copyTextToClipboard(this.target.innerHTML);\r\n      },\r\n      verify: () => this.target.classList.contains('anchor-hashtag'),\r\n      withSelection: true\r\n    }, {\r\n      icon: 'link',\r\n      text: 'MessageContext.CopyMessageLink1',\r\n      onClick: this.onCopyLinkClick,\r\n      verify: async() => await this.managers.appPeersManager.isChannel(this.peerId) && !this.message.pFlags.is_outgoing\r\n    }, {\r\n      icon: 'pin',\r\n      text: 'Message.Context.Pin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => !this.message.pFlags.is_outgoing && \r\n        this.message._ !== 'messageService' && \r\n        !this.message.pFlags.pinned && \r\n        await this.managers.appPeersManager.canPinMessage(this.peerId) && \r\n        this.chat.type !== 'scheduled',\r\n    }, {\r\n      icon: 'unpin',\r\n      text: 'Message.Context.Unpin',\r\n      onClick: this.onUnpinClick,\r\n      verify: async() => (this.message as Message.message).pFlags.pinned && await this.managers.appPeersManager.canPinMessage(this.peerId),\r\n    }, {\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: () => {\r\n        appDownloadManager.downloadToDisc({media: (this.message as any).media.document});\r\n      },\r\n      verify: () => {\r\n        if(this.message.pFlags.is_outgoing) {\r\n          return false;\r\n        }\r\n        \r\n        const doc: MyDocument = ((this.message as Message.message).media as MessageMedia.messageMediaDocument)?.document as any;\r\n        if(!doc) return false;\r\n        \r\n        let hasTarget = !!IS_TOUCH_SUPPORTED;\r\n        const isGoodType = !doc.type || !(['gif', 'video', 'sticker'] as MyDocument['type'][]).includes(doc.type);\r\n        if(isGoodType) hasTarget = hasTarget || !!findUpClassName(this.target, 'document') || !!findUpClassName(this.target, 'audio');\r\n        return isGoodType && hasTarget;\r\n      }\r\n    }, {\r\n      icon: 'checkretract',\r\n      text: 'Chat.Poll.Unvote',\r\n      onClick: this.onRetractVote,\r\n      verify: () => {\r\n        const poll = (this.message as any).media?.poll as Poll;\r\n        return poll && poll.chosenIndexes.length && !poll.pFlags.closed && !poll.pFlags.quiz;\r\n      }/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'stop',\r\n      text: 'Chat.Poll.Stop',\r\n      onClick: this.onStopPoll,\r\n      verify: async() => {\r\n        const poll = (this.message as any).media?.poll;\r\n        return await this.managers.appMessagesManager.canEditMessage(this.message, 'poll') && poll && !poll.pFlags.closed && !this.message.pFlags.is_outgoing;\r\n      }/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick, // let forward the message if it's outgoing but not ours (like a changelog)\r\n      verify: () => !this.noForwards && this.chat.type !== 'scheduled' && (!this.message.pFlags.is_outgoing || this.message.fromId === SERVICE_PEER_ID) && this.message._ !== 'messageService'\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Message.Context.Selection.Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: () => this.chat.selection.selectionForwardBtn && \r\n        this.isSelected && \r\n        !this.chat.selection.selectionForwardBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'flag',\r\n      text: 'ReportChat',\r\n      onClick: () => {\r\n        new PopupReportMessages(this.peerId, [this.mid]);\r\n      },\r\n      verify: async() => !this.message.pFlags.out && this.message._ === 'message' && !this.message.pFlags.is_outgoing && await this.managers.appPeersManager.isChannel(this.peerId),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Select',\r\n      onClick: this.onSelectClick,\r\n      verify: () => !(this.message as Message.messageService).action && !this.isSelected && this.isSelectable,\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Selection.Clear',\r\n      onClick: this.onClearSelectionClick,\r\n      verify: () => this.isSelected,\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      onClick: () => {\r\n        if(this.viewerPeerId) {\r\n          this.chat.appImManager.setInnerPeer({\r\n            peerId: this.viewerPeerId\r\n          });\r\n        } else if(this.canOpenReactedList) {\r\n          new PopupReactedList(this.message as Message.message);\r\n        } else {\r\n          return false;\r\n        }\r\n      },\r\n      verify: async() => !this.peerId.isUser() && (!!(this.message as Message.message).reactions?.recent_reactions?.length || await this.managers.appMessagesManager.canViewMessageReadParticipants(this.message)),\r\n      notDirect: () => true\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: async() => this.managers.appMessagesManager.canDeleteMessage(this.message)\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Message.Context.Selection.Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => this.isSelected && !this.chat.selection.selectionDeleteBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'info',\r\n      text: 'Chat.Message.Sponsored.What',\r\n      onClick: () => {\r\n        new PopupSponsored();\r\n      },\r\n      verify: () => false,\r\n      isSponsored: true\r\n    }];\r\n  }\r\n\r\n  private async init() {\r\n    this.cleanup();\r\n    this.setButtons();\r\n    \r\n    const filteredButtons = await this.filterButtons(this.buttons);\r\n    if(!filteredButtons.length) {\r\n      return;\r\n    }\r\n\r\n    const element = this.element = ButtonMenu(filteredButtons, this.listenerSetter);\r\n    element.id = 'bubble-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    const viewsButton = filteredButtons.find((button) => !button.icon);\r\n    if(viewsButton) {\r\n      const reactions = (this.message as Message.message).reactions;\r\n      const recentReactions = reactions?.recent_reactions;\r\n      const isViewingReactions = !!recentReactions?.length;\r\n      const participantsCount = await this.managers.appMessagesManager.canViewMessageReadParticipants(this.message) ? ((await this.managers.appPeersManager.getPeer(this.peerId)) as MTChat.chat).participants_count : undefined;\r\n      const reactedLength = reactions ? reactions.results.reduce((acc, r) => acc + r.count, 0) : undefined;\r\n\r\n      viewsButton.element.classList.add('tgico-' + (isViewingReactions ? 'reactions' : 'checks'));\r\n      const i18nElem = new I18n.IntlElement({\r\n        key: isViewingReactions ? (\r\n          participantsCount === undefined ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted'\r\n        ) : 'NobodyViewed',\r\n        args: isViewingReactions ? (\r\n          participantsCount === undefined ? [reactedLength] : [participantsCount, participantsCount]\r\n        ) : undefined,\r\n        element: viewsButton.textElement\r\n      });\r\n\r\n      let fakeText: HTMLElement;\r\n      if(isViewingReactions) {\r\n        if(participantsCount === undefined) {\r\n          fakeText = i18n('Chat.Context.ReactedFast', [reactedLength]);\r\n        } else {\r\n          fakeText = i18n(\r\n            recentReactions.length === participantsCount ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted', \r\n            [recentReactions.length, participantsCount]\r\n          );\r\n        }\r\n      } else {\r\n        fakeText = i18n('Loading');\r\n      }\r\n\r\n      fakeText.classList.add('btn-menu-item-text-fake');\r\n      viewsButton.element.append(fakeText);\r\n\r\n      const AVATAR_SIZE = 22;\r\n      const MAX_AVATARS = 3;\r\n      const PADDING_PER_AVATAR = 1.125;\r\n      i18nElem.element.style.visibility = 'hidden';\r\n      i18nElem.element.style.paddingRight = isViewingReactions ? PADDING_PER_AVATAR * Math.min(MAX_AVATARS, recentReactions.length) + 'rem' : '1rem';\r\n      const middleware = this.middleware.get();\r\n      this.managers.appMessagesManager.getMessageReactionsListAndReadParticipants(this.message as Message.message).then((result) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        if(fakeText) {\r\n          fakeText.remove();\r\n        }\r\n\r\n        const reactions = result.combined;\r\n        const reactedLength = participantsCount === undefined ? \r\n          result.reactionsCount : \r\n          (\r\n            isViewingReactions ? \r\n              reactions.filter((reaction) => reaction.reaction).length : \r\n              reactions.length\r\n          );\r\n\r\n        let fakeElem: HTMLElement;\r\n        if(reactions.length === 1) {\r\n          fakeElem = new PeerTitle({\r\n            peerId: reactions[0].peerId,\r\n            onlyFirstName: true,\r\n            dialog: false,\r\n          }).element;\r\n\r\n          if(!isViewingReactions || result.readParticipants.length <= 1) {\r\n            this.viewerPeerId = reactions[0].peerId;\r\n          }\r\n        } else if(isViewingReactions) {\r\n          const isFull = reactedLength === reactions.length || participantsCount === undefined;\r\n          fakeElem = i18n(\r\n            isFull ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted', \r\n            isFull ? [reactedLength] : [reactedLength, reactions.length]\r\n          );\r\n        } else {\r\n          if(!reactions.length) {\r\n            i18nElem.element.style.visibility = '';\r\n          } else {\r\n            fakeElem = i18n('MessageSeen', [reactions.length]);\r\n          }\r\n        }\r\n\r\n        if(fakeElem) {\r\n          fakeElem.style.paddingRight = PADDING_PER_AVATAR * Math.min(MAX_AVATARS, reactedLength) + 'rem';\r\n          fakeElem.classList.add('btn-menu-item-text-fake');\r\n          viewsButton.element.append(fakeElem);\r\n        }\r\n\r\n        if(reactions.length) {\r\n          const avatars = new StackedAvatars({avatarSize: AVATAR_SIZE});\r\n          avatars.render(recentReactions ? recentReactions.map((r) => getPeerId(r.peer_id)) : reactions.map((reaction) => reaction.peerId));\r\n          viewsButton.element.append(avatars.container);\r\n\r\n          // if(reactions.length > 1) {\r\n          // if(isViewingReactions) {\r\n            this.canOpenReactedList = true;\r\n          // }\r\n        }\r\n      });\r\n    }\r\n\r\n    let menuPadding: MenuPositionPadding;\r\n    let reactionsMenu: ChatReactionsMenu;\r\n    let reactionsMenuPosition: 'horizontal' | 'vertical';\r\n    if(this.message._ === 'message' && !this.chat.selection.isSelecting && !this.message.pFlags.is_outgoing && !this.message.pFlags.is_scheduled) {\r\n      reactionsMenuPosition = (IS_APPLE || IS_TOUCH_SUPPORTED)/*  && false */ ? 'horizontal' : 'vertical';\r\n      reactionsMenu = this.reactionsMenu = new ChatReactionsMenu(this.managers, reactionsMenuPosition, this.middleware);\r\n      reactionsMenu.init(await this.managers.appMessagesManager.getGroupsFirstMessage(this.message));\r\n      // element.prepend(reactionsMenu.widthContainer);\r\n\r\n      const size = 36;\r\n      const margin = 8;\r\n      const totalSize = size + margin;\r\n      const paddingLeft = 0, paddingRight = 0;\r\n      if(reactionsMenuPosition === 'vertical') {\r\n        menuPadding = {\r\n          top: paddingLeft,\r\n          // bottom: 36, // positionMenu will detect it itself somehow\r\n          left: totalSize\r\n        };\r\n      } else {\r\n        menuPadding = {\r\n          top: totalSize,\r\n          right: paddingRight,\r\n          left: paddingLeft\r\n        };\r\n      }\r\n    }\r\n\r\n    this.chat.container.append(element);\r\n\r\n    return {\r\n      element, \r\n      cleanup: () => {\r\n        this.cleanup();\r\n        reactionsMenu && reactionsMenu.cleanup();\r\n      },\r\n      destroy: () => {\r\n        element.remove();\r\n        reactionsMenu && reactionsMenu.widthContainer.remove();\r\n      },\r\n      menuPadding,\r\n      reactionsMenu,\r\n      reactionsMenuPosition\r\n    };\r\n  }\r\n\r\n  private onSendScheduledClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionSendNowBtn);\r\n    } else {\r\n      new PopupSendNow(this.peerId, await this.chat.getMidsByMid(this.mid));\r\n    }\r\n  };\r\n\r\n  private onReplyClick = () => {\r\n    this.chat.input.initMessageReply(this.mid);\r\n  };\r\n\r\n  private onEditClick = () => {\r\n    this.chat.input.initMessageEditing(this.mid);\r\n  };\r\n\r\n  private onCopyClick = async() => {\r\n    if(isSelectionEmpty()) {\r\n      const mids = this.chat.selection.isSelecting ? \r\n        [...this.chat.selection.selectedMids.get(this.peerId)].sort((a, b) => a - b) : \r\n        [this.mid];\r\n\r\n      const parts: string[] = await Promise.all(mids.map(async(mid) => {\r\n        const message = (await this.chat.getMessage(mid)) as Message.message;\r\n        return message?.message ? message.message + '\\n' : '';\r\n      }));\r\n\r\n      const str = parts.join('');\r\n\r\n      copyTextToClipboard(str);\r\n    } else {\r\n      document.execCommand('copy');\r\n      //cancelSelection();\r\n    }\r\n  };\r\n\r\n  private onCopyAnchorLinkClick = () => {\r\n    copyTextToClipboard((this.target as HTMLAnchorElement).href);\r\n  };\r\n\r\n  private onCopyLinkClick = async() => {\r\n    let threadMessage: Message.message;\r\n    const {peerId, mid} = this;\r\n    const threadId = this.chat.threadId;\r\n    if(this.chat.type === 'discussion') {\r\n      threadMessage = (await this.managers.appMessagesManager.getMessageByPeer(peerId, threadId)) as Message.message;\r\n    }\r\n\r\n    const username = await this.managers.appPeersManager.getPeerUsername(threadMessage ? threadMessage.fromId : peerId);\r\n    const msgId = getServerMessageId(mid);\r\n    let url = 'https://t.me/';\r\n    let key: LangPackKey;\r\n    if(username) {\r\n      url += username + '/' + (threadMessage ? getServerMessageId(threadMessage.fwd_from.channel_post) : msgId);\r\n      if(threadMessage) url += '?comment=' + msgId;\r\n      key = 'LinkCopied';\r\n    } else {\r\n      url += 'c/' + peerId.toChatId() + '/' + msgId;\r\n      if(threadMessage) url += '?thread=' + getServerMessageId(threadMessage.mid);\r\n      key = 'LinkCopiedPrivateInfo';\r\n    }\r\n\r\n    toast(I18n.format(key, true));\r\n\r\n    copyTextToClipboard(url);\r\n  };\r\n\r\n  private onPinClick = () => {\r\n    new PopupPinMessage(this.peerId, this.mid);\r\n  };\r\n\r\n  private onUnpinClick = () => {\r\n    new PopupPinMessage(this.peerId, this.mid, true);\r\n  };\r\n\r\n  private onRetractVote = () => {\r\n    this.managers.appPollsManager.sendVote(this.message, []);\r\n  };\r\n\r\n  private onStopPoll = () => {\r\n    this.managers.appPollsManager.stopPoll(this.message);\r\n  };\r\n\r\n  private onForwardClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionForwardBtn);\r\n    } else {\r\n      const peerId = this.peerId;\r\n      const mids = this.isTargetAGroupedItem ? [this.mid] : await this.chat.getMidsByMid(this.mid);\r\n      new PopupForward({\r\n        [peerId]: mids\r\n      });\r\n    }\r\n  };\r\n\r\n  private onSelectClick = () => {\r\n    this.chat.selection.toggleByElement(findUpClassName(this.target, 'grouped-item') || findUpClassName(this.target, 'bubble'));\r\n  };\r\n\r\n  private onClearSelectionClick = () => {\r\n    this.chat.selection.cancelSelection();\r\n  };\r\n\r\n  private onDeleteClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionDeleteBtn);\r\n    } else {\r\n      new PopupDeleteMessages(this.peerId, this.isTargetAGroupedItem ? [this.mid] : await this.chat.getMidsByMid(this.mid), this.chat.type);\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\n\r\nexport default class SendMenu {\r\n  public sendMenu: HTMLDivElement;\r\n  private sendMenuButtons: (ButtonMenuItemOptions & {verify: () => boolean})[];\r\n  private type: 'schedule' | 'reminder';\r\n  \r\n  constructor(options: {\r\n    onSilentClick: () => void,\r\n    onScheduleClick: () => void,\r\n    listenerSetter?: ListenerSetter,\r\n    openSide: string,\r\n    onContextElement: HTMLElement,\r\n    onOpen?: () => boolean\r\n  }) {\r\n    this.sendMenuButtons = [{\r\n      icon: 'mute',\r\n      text: 'Chat.Send.WithoutSound',\r\n      onClick: options.onSilentClick,\r\n      verify: () => this.type === 'schedule'\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'Chat.Send.ScheduledMessage',\r\n      onClick: options.onScheduleClick,\r\n      verify: () => this.type === 'schedule'\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'Chat.Send.SetReminder',\r\n      onClick: options.onScheduleClick,\r\n      verify: () => this.type === 'reminder'\r\n    }];\r\n  \r\n    this.sendMenu = ButtonMenu(this.sendMenuButtons, options.listenerSetter);\r\n    this.sendMenu.classList.add('menu-send', options.openSide);\r\n\r\n    attachContextMenuListener(options.onContextElement, (e: any) => {\r\n      if(options.onOpen && !options.onOpen()) {\r\n        return;\r\n      }\r\n\r\n      this.sendMenuButtons.forEach((button) => {\r\n        button.element.classList.toggle('hide', !button.verify());\r\n      });\r\n      \r\n      cancelEvent(e);\r\n      contextMenuController.openBtnMenu(this.sendMenu);\r\n    }, options.listenerSetter);\r\n  }\r\n\r\n  public setPeerId(peerId: PeerId) {\r\n    this.type = peerId === rootScope.myId ? 'reminder' : 'schedule';\r\n  }\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"../chat/chat\";\r\nimport PopupElement from \".\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport InputField from \"../inputField\";\r\nimport RadioField from \"../radioField\";\r\nimport Scrollable from \"../scrollable\";\r\nimport SendContextMenu from \"../chat/sendContextMenu\";\r\nimport I18n, { _i18n } from \"../../lib/langPack\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport getRichValue from \"../../helpers/dom/getRichValue\";\r\nimport isInputEmpty from \"../../helpers/dom/isInputEmpty\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { Poll } from \"../../layer\";\r\n\r\nconst MAX_LENGTH_QUESTION = 255;\r\nconst MAX_LENGTH_OPTION = 100;\r\nconst MAX_LENGTH_SOLUTION = 200;\r\n\r\nexport default class PopupCreatePoll extends PopupElement {\r\n  private questionInputField: InputField;\r\n  private questions: HTMLElement;\r\n  private scrollable: Scrollable;\r\n  private tempId = 0;\r\n\r\n  private anonymousCheckboxField: CheckboxField;\r\n  private multipleCheckboxField: PopupCreatePoll['anonymousCheckboxField'];\r\n  private quizCheckboxField: PopupCreatePoll['anonymousCheckboxField'];\r\n\r\n  private correctAnswers: Uint8Array[];\r\n  private quizSolutionField: InputField;\r\n  private optionInputFields: InputField[];\r\n\r\n  constructor(private chat: Chat) {\r\n    super('popup-create-poll popup-new-media', null, {closable: true, withConfirm: 'Create', body: true});\r\n    this.construct();\r\n  }\r\n  \r\n  private async construct() {\r\n    _i18n(this.title, 'NewPoll');\r\n\r\n    this.questionInputField = new InputField({\r\n      placeholder: 'AskAQuestion',\r\n      label: 'AskAQuestion', \r\n      name: 'question', \r\n      maxLength: MAX_LENGTH_QUESTION\r\n    });\r\n\r\n    this.listenerSetter.add(this.questionInputField.input)('input', () => {\r\n      this.handleChange();\r\n    });\r\n\r\n    this.optionInputFields = [];\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      const sendMenu = new SendContextMenu({\r\n        onSilentClick: () => {\r\n          this.chat.input.sendSilent = true;\r\n          this.send();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.chat.input.scheduleSending(() => {\r\n            this.send();\r\n          });\r\n        },\r\n        openSide: 'bottom-left',\r\n        onContextElement: this.btnConfirm,\r\n      });\r\n  \r\n      sendMenu.setPeerId(this.chat.peerId);\r\n\r\n      this.header.append(sendMenu.sendMenu);\r\n    }\r\n\r\n    this.header.append(this.questionInputField.container);\r\n\r\n    const hr = document.createElement('hr');\r\n    const d = document.createElement('div');\r\n    d.classList.add('caption');\r\n    _i18n(d, 'PollOptions');\r\n\r\n    this.questions = document.createElement('form');\r\n    this.questions.classList.add('poll-create-questions');\r\n\r\n    const dd = document.createElement('div');\r\n    dd.classList.add('poll-create-settings');\r\n    \r\n    const settingsCaption = document.createElement('div');\r\n    settingsCaption.classList.add('caption');\r\n    _i18n(settingsCaption, 'Settings');\r\n\r\n    if(!(await this.chat.managers.appPeersManager.isBroadcast(this.chat.peerId))) {\r\n      this.anonymousCheckboxField = new CheckboxField({\r\n        text: 'NewPoll.Anonymous', \r\n        name: 'anonymous'\r\n      });\r\n      this.anonymousCheckboxField.input.checked = true;\r\n      dd.append(this.anonymousCheckboxField.label);\r\n    }\r\n    \r\n    this.multipleCheckboxField = new CheckboxField({\r\n      text: 'NewPoll.MultipleChoice', \r\n      name: 'multiple'\r\n    });\r\n    this.quizCheckboxField = new CheckboxField({\r\n      text: 'NewPoll.Quiz', \r\n      name: 'quiz'\r\n    });\r\n\r\n    this.listenerSetter.add(this.multipleCheckboxField.input)('change', () => {\r\n      const checked = this.multipleCheckboxField.input.checked;\r\n      this.quizCheckboxField.input.toggleAttribute('disabled', checked);\r\n    });\r\n\r\n    this.listenerSetter.add(this.quizCheckboxField.input)('change', () => {\r\n      const checked = this.quizCheckboxField.input.checked;\r\n\r\n      (Array.from(this.questions.children) as HTMLElement[]).map((el) => {\r\n        el.classList.toggle('radio-field', checked);\r\n      });\r\n\r\n      if(!checked) {\r\n        this.correctAnswers = undefined;\r\n        this.quizSolutionField.setValueSilently('');\r\n      }\r\n\r\n      quizElements.forEach((el) => el.classList.toggle('hide', !checked));\r\n\r\n      this.multipleCheckboxField.input.toggleAttribute('disabled', checked);\r\n      this.handleChange();\r\n    });\r\n\r\n    dd.append(this.multipleCheckboxField.label, this.quizCheckboxField.label);\r\n\r\n    const quizElements: HTMLElement[] = [];\r\n\r\n    const quizSolutionCaption = document.createElement('div');\r\n    quizSolutionCaption.classList.add('caption');\r\n    _i18n(quizSolutionCaption, 'AccDescrQuizExplanation');\r\n\r\n    const quizHr = document.createElement('hr');\r\n\r\n    const quizSolutionContainer = document.createElement('div');\r\n    quizSolutionContainer.classList.add('poll-create-questions');\r\n\r\n    this.quizSolutionField = new InputField({\r\n      placeholder: 'NewPoll.Explanation.Placeholder', \r\n      label: 'NewPoll.Explanation.Placeholder',\r\n      name: 'solution',\r\n      maxLength: MAX_LENGTH_SOLUTION\r\n    });\r\n\r\n    this.listenerSetter.add(this.questionInputField.input)('input', () => {\r\n      this.handleChange();\r\n    });\r\n\r\n    const quizSolutionSubtitle = document.createElement('div');\r\n    quizSolutionSubtitle.classList.add('subtitle');\r\n    _i18n(quizSolutionSubtitle, 'AddAnExplanationInfo');\r\n\r\n    quizSolutionContainer.append(this.quizSolutionField.container, quizSolutionSubtitle);\r\n\r\n    quizElements.push(quizHr, quizSolutionCaption, quizSolutionContainer);\r\n    quizElements.forEach((el) => el.classList.add('hide'));\r\n\r\n    this.body.parentElement.insertBefore(hr, this.body);\r\n    this.body.append(d, this.questions, document.createElement('hr'), settingsCaption, dd, ...quizElements);\r\n\r\n    attachClickEvent(this.btnConfirm, this.onSubmitClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.scrollable = new Scrollable(this.body);\r\n    this.appendMoreField();\r\n\r\n    this.onEscape = () => {\r\n      return !this.getFilledAnswers().length;\r\n    };\r\n\r\n    this.handleChange();\r\n  }\r\n\r\n  private getFilledAnswers() {\r\n    const answers = Array.from(this.questions.children).map((el, idx) => {\r\n      const input = el.querySelector('.input-field-input') as HTMLElement;\r\n      return input instanceof HTMLInputElement ? input.value : getRichValue(input, false).value;\r\n    }).filter((v) => !!v.trim());\r\n\r\n    return answers;\r\n  }\r\n\r\n  private onSubmitClick = () => {\r\n    this.send();\r\n  };\r\n\r\n  private validate() {\r\n    const question = this.questionInputField.value;\r\n    if(!question) {\r\n      return false;\r\n    }\r\n\r\n    if(question.length > MAX_LENGTH_QUESTION) {\r\n      return false;\r\n    }\r\n\r\n    if(this.quizCheckboxField.input.checked && !this.correctAnswers?.length) {\r\n      return false;\r\n    }\r\n\r\n    const answers = this.getFilledAnswers();\r\n    if(answers.length < 2) {\r\n      return false;\r\n    }\r\n    \r\n    const tooLongOption = answers.find((a) => a.length > MAX_LENGTH_OPTION);\r\n    if(tooLongOption) {\r\n      return false;\r\n    }\r\n\r\n    const {value: quizSolution} = getRichValue(this.quizSolutionField.input, false);\r\n    if(quizSolution.length > MAX_LENGTH_SOLUTION) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private handleChange() {\r\n    const valid = this.validate();\r\n    this.btnConfirm.toggleAttribute('disabled', !valid);\r\n  }\r\n\r\n  public async send(force = false) {\r\n    const question = this.questionInputField.value;\r\n\r\n    const answers = this.getFilledAnswers();\r\n\r\n    const {value: quizSolution, entities: quizSolutionEntities} = getRichValue(this.quizSolutionField.input);\r\n\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.chat.input.scheduleSending(() => {\r\n        this.send(true);\r\n      });\r\n      \r\n      return;\r\n    }\r\n\r\n    this.hide();\r\n\r\n    //const randomID = [nextRandomInt(0xFFFFFFFF), nextRandomInt(0xFFFFFFFF)];\r\n    //const randomIDS = bigint(randomID[0]).shiftLeft(32).add(bigint(randomID[1])).toString();\r\n\r\n    const pFlags: Poll['pFlags'] = {};\r\n\r\n    if(this.anonymousCheckboxField && !this.anonymousCheckboxField.input.checked) {\r\n      pFlags.public_voters = true;\r\n    }\r\n\r\n    if(this.multipleCheckboxField.input.checked) {\r\n      pFlags.multiple_choice = true;\r\n    }\r\n\r\n    if(this.quizCheckboxField.input.checked) {\r\n      pFlags.quiz = true;\r\n    }\r\n\r\n    const poll: Poll = {\r\n      _: 'poll',\r\n      pFlags,\r\n      question,\r\n      answers: answers.map((value, idx) => {\r\n        return {\r\n          _: 'pollAnswer',\r\n          text: value,\r\n          option: new Uint8Array([idx])\r\n        };\r\n      }),\r\n      id: undefined\r\n    };\r\n    //poll.id = randomIDS;\r\n\r\n    const inputMediaPoll = await this.chat.managers.appPollsManager.getInputMediaPoll(poll, this.correctAnswers, quizSolution, quizSolutionEntities);\r\n\r\n    //console.log('Will try to create poll:', inputMediaPoll);\r\n\r\n    this.chat.managers.appMessagesManager.sendOther(this.chat.peerId, inputMediaPoll, {\r\n      ...this.chat.getMessageSendingParams()\r\n    });\r\n\r\n    if(this.chat.input.helperType === 'reply') {\r\n      this.chat.input.clearHelper();\r\n    }\r\n\r\n    this.chat.input.onMessageSent(false, false);\r\n  }\r\n\r\n  onInput = (e: Event) => {\r\n    const target = e.target as HTMLInputElement;\r\n\r\n    const radioLabel = findUpTag(target, 'LABEL');\r\n    const isEmpty = isInputEmpty(target);\r\n    if(!isEmpty) {\r\n      target.parentElement.classList.add('is-filled');\r\n      radioLabel.classList.remove('hidden-widget');\r\n      radioLabel.firstElementChild.removeAttribute('disabled');\r\n    }\r\n\r\n    const isLast = !radioLabel.nextElementSibling;\r\n    if(isLast && !isEmpty && this.questions.childElementCount < 10) {\r\n      this.appendMoreField();\r\n    }\r\n\r\n    this.handleChange();\r\n  };\r\n\r\n  onDeleteClick = (e: MouseEvent) => {\r\n    const target = e.target as HTMLSpanElement;\r\n    const label = findUpTag(target, 'LABEL');\r\n    const idx = whichChild(label);\r\n\r\n    if(this.correctAnswers && this.correctAnswers[0][0] === idx) {\r\n      this.correctAnswers = undefined;\r\n    }\r\n\r\n    label.remove();\r\n    this.optionInputFields.splice(idx, 1);\r\n\r\n    this.optionInputFields.forEach((inputField, idx) => {\r\n      inputField.options.labelOptions.length = 0;\r\n      inputField.options.labelOptions.push(idx + 1);\r\n      const i18nElement = I18n.weakMap.get(inputField.label.firstElementChild as HTMLElement);\r\n      i18nElement.update();\r\n    });\r\n\r\n    this.handleChange();\r\n  };\r\n\r\n  private appendMoreField() {\r\n    const tempId = this.tempId++;\r\n    const idx = this.questions.childElementCount + 1;\r\n    const questionField = new InputField({\r\n      placeholder: 'NewPoll.OptionsAddOption', \r\n      label: 'NewPoll.OptionLabel',\r\n      labelOptions: [idx],\r\n      name: 'question-' + tempId, \r\n      maxLength: MAX_LENGTH_OPTION\r\n    });\r\n    this.listenerSetter.add(questionField.input)('input', this.onInput);\r\n\r\n    const radioField = new RadioField({\r\n      text: '', \r\n      name: 'question'\r\n    });\r\n    radioField.main.append(questionField.container);\r\n    attachClickEvent(questionField.input, cancelEvent, {listenerSetter: this.listenerSetter});\r\n    radioField.label.classList.add('hidden-widget');\r\n    radioField.input.disabled = true;\r\n    if(!this.quizCheckboxField.input.checked) {\r\n      radioField.label.classList.remove('radio-field');\r\n    }\r\n    this.listenerSetter.add(radioField.input)('change', () => {\r\n      const checked = radioField.input.checked;\r\n      if(checked) {\r\n        const idx = whichChild(radioField.label);\r\n        this.correctAnswers = [new Uint8Array([idx])];\r\n        this.handleChange();\r\n      }\r\n    });\r\n\r\n    const deleteBtn = document.createElement('span');\r\n    deleteBtn.classList.add('btn-icon', 'tgico-close');\r\n    questionField.container.append(deleteBtn);\r\n  \r\n    attachClickEvent(deleteBtn, this.onDeleteClick, {listenerSetter: this.listenerSetter, once: true});\r\n\r\n    this.questions.append(radioField.label);\r\n\r\n    this.scrollable.scrollIntoViewNew({\r\n      element: this.questions.lastElementChild as HTMLElement, \r\n      position: 'center'\r\n    });\r\n    //this.scrollable.scrollTo(this.scrollable.scrollHeight, 'top', true, true);\r\n\r\n    this.optionInputFields.push(questionField);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport pause from \"./schedulers/pause\";\r\nimport { makeMediaSize } from \"./mediaSize\";\r\nimport scaleMediaElement from \"./canvas/scaleMediaElement\";\r\nimport preloadVideo from \"./preloadVideo\";\r\n\r\nexport function createPosterFromMedia(media: HTMLVideoElement | HTMLImageElement) {\r\n  let width: number, height: number;\r\n  if(media instanceof HTMLVideoElement) {\r\n    width = media.videoWidth;\r\n    height = media.videoHeight;\r\n  } else {\r\n    width = media.naturalWidth;\r\n    height = media.naturalHeight;\r\n  }\r\n\r\n  return scaleMediaElement({\r\n    media, \r\n    mediaSize: makeMediaSize(width, height), \r\n    boxSize: makeMediaSize(320, 240),\r\n    quality: .9\r\n  });\r\n}\r\n\r\nexport function createPosterFromVideo(video: HTMLVideoElement): ReturnType<typeof scaleMediaElement> {\r\n  return new Promise((resolve, reject) => {\r\n    video.onseeked = () => {\r\n      video.onseeked = () => {\r\n        createPosterFromMedia(video).then(resolve);\r\n\r\n        video.onseeked = undefined;\r\n      };\r\n\r\n      video.currentTime = 0;\r\n    };\r\n    \r\n    video.onerror = reject;\r\n    video.currentTime = Math.min(video.duration, 1);\r\n  });\r\n}\r\n\r\nexport async function createPosterForVideo(url: string) {\r\n  const video = await preloadVideo(url);\r\n\r\n  return Promise.race([\r\n    pause(2000) as Promise<undefined>,\r\n    createPosterFromVideo(video),\r\n  ]);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * @returns duration in ms\r\n */\r\nexport default function getGifDuration(image: HTMLImageElement) {\r\n  const src = image.src;\r\n\r\n  return fetch(src)\r\n  .then((response) => response.arrayBuffer())\r\n  .then((arrayBuffer) => {\r\n    const d = new Uint8Array(arrayBuffer);\r\n    // Thanks to http://justinsomnia.org/2006/10/gif-animation-duration-calculation/\r\n    // And http://www.w3.org/Graphics/GIF/spec-gif89a.txt\r\n    let duration = 0;\r\n    for(let i = 0, length = d.length; i < length; ++i) {\r\n      // Find a Graphic Control Extension hex(21F904__ ____ __00)\r\n      if(d[i] == 0x21 \r\n       && d[i + 1] == 0xF9 \r\n       && d[i + 2] == 0x04 \r\n       && d[i + 7] == 0x00) {\r\n        // Swap 5th and 6th bytes to get the delay per frame\r\n        const delay = (d[i + 5] << 8) | (d[i + 4] & 0xFF);\r\n        \r\n        // Should be aware browsers have a minimum frame delay \r\n        // e.g. 6ms for IE, 2ms modern browsers (50fps)\r\n        duration += delay < 2 ? 10 : delay;\r\n      }\r\n    }\r\n\r\n    return duration / 1000;\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"../chat/chat\";\r\nimport InputField from \"../inputField\";\r\nimport PopupElement from \".\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { toast } from \"../toast\";\r\nimport { wrapDocument } from \"../wrappers\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport SendContextMenu from \"../chat/sendContextMenu\";\r\nimport { createPosterFromMedia, createPosterFromVideo } from \"../../helpers/createPoster\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport I18n, { FormatterArguments, i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport calcImageInBox from \"../../helpers/calcImageInBox\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport getGifDuration from \"../../helpers/getGifDuration\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport prepareAlbum from \"../prepareAlbum\";\r\nimport { MediaSize } from \"../../helpers/mediaSize\";\r\nimport { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\ntype SendFileParams = Partial<{\r\n  file: File,\r\n  objectURL: string,\r\n  thumb: {\r\n    blob: Blob,\r\n    url: string,\r\n    size: MediaSize\r\n  },\r\n  width: number,\r\n  height: number,\r\n  duration: number,\r\n  noSound: boolean,\r\n  itemDiv: HTMLElement\r\n}>;\r\n\r\nlet currentPopup: PopupNewMedia;\r\n\r\nexport function getCurrentNewMediaPopup() {\r\n  return currentPopup;\r\n}\r\n\r\nexport default class PopupNewMedia extends PopupElement {\r\n  private input: HTMLElement;\r\n  private mediaContainer: HTMLElement;\r\n  private groupCheckboxField: CheckboxField;\r\n  private mediaCheckboxField: CheckboxField;\r\n  private wasInputValue: string;\r\n\r\n  private willAttach: Partial<{\r\n    type: 'media' | 'document',\r\n    isMedia: true,\r\n    group: boolean,\r\n    sendFileDetails: SendFileParams[]\r\n  }>;\r\n  private inputField: InputField;\r\n  private captionLengthMax: number;\r\n\r\n  constructor(private chat: Chat, private files: File[], willAttachType: PopupNewMedia['willAttach']['type']) {\r\n    super('popup-send-photo popup-new-media', null, {closable: true, withConfirm: 'Modal.Send', confirmShortcutIsSendShortcut: true, body: true});\r\n    this.construct(willAttachType);\r\n  }\r\n\r\n  private async construct(willAttachType: PopupNewMedia['willAttach']['type']) {\r\n    this.willAttach = {\r\n      type: willAttachType,\r\n      sendFileDetails: [],\r\n      group: false\r\n    };\r\n\r\n    const config = await this.managers.apiManager.getConfig();\r\n    this.captionLengthMax = config.caption_length_max;\r\n\r\n    attachClickEvent(this.btnConfirm, () => this.send(), {listenerSetter: this.listenerSetter});\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      const sendMenu = new SendContextMenu({\r\n        onSilentClick: () => {\r\n          this.chat.input.sendSilent = true;\r\n          this.send();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.chat.input.scheduleSending(() => {\r\n            this.send();\r\n          });\r\n        },\r\n        openSide: 'bottom-left',\r\n        onContextElement: this.btnConfirm,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      sendMenu.setPeerId(this.chat.peerId);\r\n\r\n      this.header.append(sendMenu.sendMenu);\r\n    }\r\n\r\n    this.mediaContainer = document.createElement('div');\r\n    this.mediaContainer.classList.add('popup-photo');\r\n    const scrollable = new Scrollable(null);\r\n    scrollable.container.append(this.mediaContainer);\r\n    \r\n    this.inputField = new InputField({\r\n      placeholder: 'PreviewSender.CaptionPlaceholder',\r\n      label: 'Caption',\r\n      name: 'photo-caption',\r\n      maxLength: this.captionLengthMax\r\n    });\r\n    this.input = this.inputField.input;\r\n\r\n    this.inputField.value = this.wasInputValue = this.chat.input.messageInputField.input.innerHTML;\r\n    this.chat.input.messageInputField.value = '';\r\n\r\n    this.body.append(scrollable.container);\r\n    this.container.append(this.inputField.container);\r\n\r\n    this.attachFiles();\r\n\r\n    this.addEventListener('close', () => {\r\n      this.files = [];\r\n      currentPopup = undefined;\r\n    });\r\n\r\n    currentPopup = this;\r\n  }\r\n\r\n  public appendDrops(element: HTMLElement) {\r\n    this.body.append(element);\r\n  }\r\n\r\n  get type() {\r\n    return this.willAttach.type;\r\n  }\r\n\r\n  set type(type: PopupNewMedia['willAttach']['type']) {\r\n    this.willAttach.type = type;\r\n  }\r\n\r\n  private appendGroupCheckboxField() {\r\n    const good = this.files.length > 1;\r\n    if(good && !this.groupCheckboxField) {\r\n      this.groupCheckboxField = new CheckboxField({\r\n        text: 'PreviewSender.GroupItems', \r\n        name: 'group-items'\r\n      });\r\n      this.container.append(...[this.groupCheckboxField.label, this.mediaCheckboxField?.label, this.inputField.container].filter(Boolean));\r\n  \r\n      this.willAttach.group = true;\r\n      this.groupCheckboxField.setValueSilently(this.willAttach.group);\r\n\r\n      this.listenerSetter.add(this.groupCheckboxField.input)('change', () => {\r\n        const checked = this.groupCheckboxField.checked;\r\n  \r\n        this.willAttach.group = checked;\r\n\r\n        this.attachFiles();\r\n      });\r\n    } else if(this.groupCheckboxField) {\r\n      this.groupCheckboxField.label.classList.toggle('hide', !good);\r\n    }\r\n  }\r\n\r\n  private appendMediaCheckboxField() {\r\n    const good = !!this.files.find((file) => MEDIA_MIME_TYPES_SUPPORTED.has(file.type));\r\n    if(good && !this.mediaCheckboxField) {\r\n      this.mediaCheckboxField = new CheckboxField({\r\n        text: 'PreviewSender.CompressFile',\r\n        name: 'compress-items'\r\n      });\r\n      this.container.append(...[this.groupCheckboxField?.label, this.mediaCheckboxField.label, this.inputField.container].filter(Boolean));\r\n\r\n      this.mediaCheckboxField.setValueSilently(this.willAttach.type === 'media');\r\n\r\n      this.listenerSetter.add(this.mediaCheckboxField.input)('change', () => {\r\n        const checked = this.mediaCheckboxField.checked;\r\n  \r\n        this.willAttach.type = checked ? 'media' : 'document';\r\n\r\n        this.attachFiles();\r\n      });\r\n    } else if(this.mediaCheckboxField) {\r\n      this.mediaCheckboxField.label.classList.toggle('hide', !good);\r\n    }\r\n  }\r\n\r\n  public addFiles(files: File[]) {\r\n    const toPush = files.filter((file) => {\r\n      const found = this.files.find((_file) => {\r\n        return _file.lastModified === file.lastModified && _file.name === file.name && _file.size === file.size;\r\n      });\r\n      \r\n      return !found;\r\n    });\r\n\r\n    if(toPush.length) {\r\n      this.files.push(...toPush);\r\n      this.attachFiles();\r\n    }\r\n  }\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    const target = e.target as HTMLElement;\r\n    if(target !== this.input) {\r\n      if(target.tagName === 'INPUT' || target.hasAttribute('contenteditable')) {\r\n        return;\r\n      }\r\n\r\n      this.input.focus();\r\n      placeCaretAtEnd(this.input);\r\n    }\r\n  };\r\n\r\n  private send(force = false) {\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.chat.input.scheduleSending(() => {\r\n        this.send(true);\r\n      });\r\n      \r\n      return;\r\n    }\r\n\r\n    let caption = this.inputField.value;\r\n    if(caption.length > this.captionLengthMax) {\r\n      toast(I18n.format('Error.PreviewSender.CaptionTooLong', true));\r\n      return;\r\n    }\r\n\r\n    this.hide();\r\n    const willAttach = this.willAttach;\r\n    willAttach.isMedia = willAttach.type === 'media' ? true : undefined;\r\n    const {sendFileDetails, isMedia} = willAttach;\r\n\r\n    //console.log('will send files with options:', willAttach);\r\n\r\n    const {peerId, input} = this.chat;\r\n\r\n    sendFileDetails.forEach((d) => {\r\n      d.itemDiv = undefined;\r\n    });\r\n\r\n    const {length} = sendFileDetails;\r\n    const sendingParams = this.chat.getMessageSendingParams();\r\n    this.iterate((sendFileDetails) => {\r\n      if(caption && sendFileDetails.length !== length) {\r\n        this.managers.appMessagesManager.sendText(peerId, caption, {\r\n          ...sendingParams,\r\n          clearDraft: true\r\n        });\r\n\r\n        caption = undefined;\r\n      }\r\n\r\n      const w = {\r\n        ...willAttach,\r\n        sendFileDetails\r\n      };\r\n\r\n      this.managers.appMessagesManager.sendAlbum(peerId, w.sendFileDetails.map((d) => d.file), Object.assign({\r\n        ...sendingParams,\r\n        caption,\r\n        isMedia: isMedia,\r\n        clearDraft: true as true\r\n      }, w));\r\n\r\n      caption = undefined;\r\n    });\r\n    \r\n    input.replyToMsgId = this.chat.threadId;\r\n    input.onMessageSent();\r\n  }\r\n\r\n  private async attachMedia(params: SendFileParams, itemDiv: HTMLElement) {\r\n    itemDiv.classList.add('popup-item-media');\r\n\r\n    const file = params.file;\r\n    const isVideo = file.type.startsWith('video/');\r\n\r\n    let promise: Promise<void>;\r\n    if(isVideo) {\r\n      const video = createVideo();\r\n      const source = document.createElement('source');\r\n      source.src = params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n      video.autoplay = true;\r\n      video.controls = false;\r\n      video.muted = true;\r\n\r\n      video.addEventListener('timeupdate', () => {\r\n        video.pause();\r\n      }, {once: true});\r\n\r\n      promise = onMediaLoad(video).then(async() => {\r\n        params.width = video.videoWidth;\r\n        params.height = video.videoHeight;\r\n        params.duration = Math.floor(video.duration);\r\n        \r\n        const audioDecodedByteCount = (video as any).webkitAudioDecodedByteCount;\r\n        if(audioDecodedByteCount !== undefined) {\r\n          params.noSound = !audioDecodedByteCount;\r\n        }\r\n\r\n        itemDiv.append(video);\r\n        const thumb = await createPosterFromVideo(video);\r\n        params.thumb = {\r\n          url: await apiManagerProxy.invoke('createObjectURL', thumb.blob),\r\n          ...thumb\r\n        };\r\n      });\r\n\r\n      video.append(source);\r\n    } else {\r\n      const img = new Image();\r\n      promise = new Promise<void>((resolve) => {\r\n        img.onload = () => {\r\n          params.width = img.naturalWidth;\r\n          params.height = img.naturalHeight;\r\n          \r\n          itemDiv.append(img);\r\n          \r\n          if(file.type === 'image/gif') {\r\n            params.noSound = true;\r\n            \r\n            Promise.all([\r\n              getGifDuration(img).then((duration) => {\r\n                params.duration = Math.ceil(duration);\r\n              }),\r\n              \r\n              createPosterFromMedia(img).then(async(thumb) => {\r\n                params.thumb = {\r\n                  url: await apiManagerProxy.invoke('createObjectURL', thumb.blob),\r\n                  ...thumb\r\n                };\r\n              })\r\n            ]).then(() => {\r\n              resolve();\r\n            });\r\n          } else {\r\n            resolve();\r\n          }\r\n        };\r\n      });\r\n      \r\n      img.src = params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async attachDocument(params: SendFileParams, itemDiv: HTMLElement): ReturnType<PopupNewMedia['attachMedia']> {\r\n    itemDiv.classList.add('popup-item-document');\r\n    const file = params.file;\r\n\r\n    const isPhoto = file.type.startsWith('image/');\r\n    const isAudio = file.type.startsWith('audio/');\r\n    if(isPhoto || isAudio || file.size < 20e6) {\r\n      params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n    }\r\n\r\n    const doc = {\r\n      _: 'document',\r\n      file: file,\r\n      file_name: file.name || '',\r\n      size: file.size,\r\n      type: isPhoto ? 'photo' : 'doc'\r\n    } as MyDocument;\r\n\r\n    let cacheContext: ThumbCache;\r\n    if(params.objectURL) {\r\n      cacheContext = {\r\n        url: params.objectURL,\r\n        downloaded: file.size,\r\n        type: 'full'\r\n      };\r\n    }\r\n\r\n    const docDiv = await wrapDocument({\r\n      message: {\r\n        _: 'message',\r\n        pFlags: {\r\n          is_outgoing: true\r\n        },\r\n        mid: 0,\r\n        peerId: 0,\r\n        media: {\r\n          _: 'messageMediaDocument',\r\n          document: doc\r\n        }\r\n      } as any,\r\n      cacheContext\r\n    });\r\n\r\n    const promise = new Promise<void>((resolve) => {\r\n      const finish = () => {\r\n        itemDiv.append(docDiv);\r\n        resolve();\r\n      };\r\n  \r\n      if(isPhoto) {\r\n        const img = new Image();\r\n        img.src = params.objectURL;\r\n        img.onload = () => {\r\n          params.width = img.naturalWidth;\r\n          params.height = img.naturalHeight;\r\n  \r\n          finish();\r\n        };\r\n  \r\n        img.onerror = finish;\r\n      } else {\r\n        finish();\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private attachFile = (file: File) => {\r\n    const willAttach = this.willAttach;\r\n    const shouldCompress = this.shouldCompress(file.type);\r\n\r\n    const params: SendFileParams = {};\r\n    params.file = file;\r\n\r\n    const itemDiv = document.createElement('div');\r\n    itemDiv.classList.add('popup-item');\r\n\r\n    params.itemDiv = itemDiv;\r\n\r\n    const promise = shouldCompress ? this.attachMedia(params, itemDiv) : this.attachDocument(params, itemDiv);\r\n    willAttach.sendFileDetails.push(params);\r\n    return promise;\r\n  };\r\n  \r\n  private shouldCompress(mimeType: string) {\r\n    return this.willAttach.type === 'media' && MEDIA_MIME_TYPES_SUPPORTED.has(mimeType);\r\n  }\r\n\r\n  private onRender() {\r\n    // show now\r\n    if(!this.element.classList.contains('active')) {\r\n      this.listenerSetter.add(document.body)('keydown', this.onKeyDown);\r\n      this.addEventListener('close', () => {\r\n        if(this.wasInputValue) {\r\n          this.chat.input.messageInputField.value = this.wasInputValue;\r\n        }\r\n      });\r\n      this.show();\r\n    }\r\n  }\r\n\r\n  private setTitle() {\r\n    const {willAttach, title, files} = this;\r\n    let key: LangPackKey;\r\n    const args: FormatterArguments = [];\r\n    if(willAttach.type === 'document') {\r\n      key = 'PreviewSender.SendFile';\r\n      args.push(files.length);\r\n    } else {\r\n      let foundPhotos = 0, foundVideos = 0, foundFiles = 0;\r\n      files.forEach((file) => {\r\n        if(file.type.startsWith('image/')) ++foundPhotos;\r\n        else if(file.type.startsWith('video/')) ++foundVideos;\r\n        else ++foundFiles;\r\n      });\r\n\r\n      if([foundPhotos, foundVideos, foundFiles].filter((n) => n > 0).length > 1) {\r\n        key = 'PreviewSender.SendFile';\r\n        args.push(files.length);\r\n      } else \r\n      \r\n      /* const sum = foundPhotos + foundVideos;\r\n      if(sum > 1 && willAttach.group) {\r\n        key = 'PreviewSender.SendAlbum';\r\n        const albumsLength = Math.ceil(sum / 10);\r\n        args.push(albumsLength);\r\n      } else  */if(foundPhotos) {\r\n        key = 'PreviewSender.SendPhoto';\r\n        args.push(foundPhotos);\r\n      } else if(foundVideos) {\r\n        key = 'PreviewSender.SendVideo';\r\n        args.push(foundVideos);\r\n      }\r\n    }\r\n\r\n    replaceContent(title, i18n(key, args));\r\n  }\r\n\r\n  private appendMediaToContainer(div: HTMLElement, params: SendFileParams) {\r\n    if(this.shouldCompress(params.file.type)) {\r\n      const size = calcImageInBox(params.width, params.height, 380, 320);\r\n      div.style.width = size.width + 'px';\r\n      div.style.height = size.height + 'px';\r\n    }\r\n\r\n    this.mediaContainer.append(div);\r\n  }\r\n\r\n  private iterate(cb: (sendFileDetails: SendFileParams[]) => void) {\r\n    const {sendFileDetails} = this.willAttach;\r\n    if(!this.willAttach.group) {\r\n      sendFileDetails.forEach((p) => cb([p]));\r\n      return;\r\n    }\r\n\r\n    const length = sendFileDetails.length;\r\n    for(let i = 0; i < length;) {\r\n      const firstType = sendFileDetails[i].file.type;\r\n      let k = 0;\r\n      for(; k < 10 && i < length; ++i, ++k) {\r\n        const type = sendFileDetails[i].file.type;\r\n        if(this.shouldCompress(firstType) !== this.shouldCompress(type)) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      cb(sendFileDetails.slice(i - k, i));\r\n    }\r\n  }\r\n\r\n  private attachFiles() {\r\n    const {files, willAttach, mediaContainer} = this;\r\n    willAttach.sendFileDetails.length = 0;\r\n\r\n    this.appendGroupCheckboxField();\r\n    this.appendMediaCheckboxField();\r\n\r\n    Promise.all(files.map(this.attachFile)).then(() => {\r\n      mediaContainer.innerHTML = '';\r\n\r\n      if(!files.length) {\r\n        return;\r\n      }\r\n\r\n      this.setTitle();\r\n\r\n      this.iterate((sendFileDetails) => {\r\n        if(this.shouldCompress(sendFileDetails[0].file.type) && sendFileDetails.length > 1) {\r\n          const albumContainer = document.createElement('div');\r\n          albumContainer.classList.add('popup-item-album', 'popup-item');\r\n          albumContainer.append(...sendFileDetails.map((s) => s.itemDiv));\r\n\r\n          prepareAlbum({\r\n            container: albumContainer,\r\n            items: sendFileDetails.map((o) => ({w: o.width, h: o.height})),\r\n            maxWidth: 380,\r\n            minWidth: 100,\r\n            spacing: 4\r\n          });\r\n\r\n          mediaContainer.append(albumContainer);\r\n        } else {\r\n          sendFileDetails.forEach((params) => {\r\n            this.appendMediaToContainer(params.itemDiv, params);\r\n          });\r\n        }\r\n      });\r\n    }).then(() => {\r\n      this.onRender();\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport fastSmoothScroll from \"../fastSmoothScroll\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent } from \"./clickEvent\";\r\nimport findUpAsChild from \"./findUpAsChild\";\r\nimport findUpClassName from \"./findUpClassName\";\r\n\r\ntype ArrowKey = 'ArrowUp' | 'ArrowDown' | 'ArrowLeft' | 'ArrowRight';\r\nconst HANDLE_EVENT = 'keydown';\r\nconst ACTIVE_CLASS_NAME = 'active';\r\n\r\nconst AXIS_Y_KEYS: ArrowKey[] = ['ArrowUp', 'ArrowDown'];\r\nconst AXIS_X_KEYS: ArrowKey[] = ['ArrowLeft', 'ArrowRight'];\r\n\r\nexport default function attachListNavigation({list, type, onSelect, once, waitForKey}: {\r\n  list: HTMLElement, \r\n  type: 'xy' | 'x' | 'y',\r\n  onSelect: (target: Element) => void | boolean,\r\n  once: boolean,\r\n  waitForKey?: string[]\r\n}) {\r\n  let waitForKeySet = waitForKey?.length ? new Set(waitForKey) : undefined;\r\n  const keyNames = new Set(type === 'xy' ? AXIS_Y_KEYS.concat(AXIS_X_KEYS) : (type === 'x' ? AXIS_X_KEYS : AXIS_Y_KEYS)); \r\n\r\n  let target: Element;\r\n  const getCurrentTarget = () => {\r\n    return target || list.querySelector('.' + ACTIVE_CLASS_NAME) || list.firstElementChild;\r\n  };\r\n\r\n  const setCurrentTarget = (_target: Element, scrollTo: boolean) => {\r\n    if(target === _target) {\r\n      return;\r\n    }\r\n\r\n    let hadTarget = false;\r\n    if(target) {\r\n      hadTarget = true;\r\n      target.classList.remove(ACTIVE_CLASS_NAME);\r\n    }\r\n\r\n    target = _target;\r\n    if(!target) return;\r\n    target.classList.add(ACTIVE_CLASS_NAME);\r\n\r\n    if(hadTarget && scrollable && scrollTo) {\r\n      fastSmoothScroll({\r\n        container: scrollable, \r\n        element: target as HTMLElement, \r\n        position: 'center', \r\n        forceDuration: 100, \r\n        axis: type === 'x' ? 'x' : 'y'\r\n      });\r\n    }\r\n  };\r\n\r\n  const getNextTargetX = (currentTarget: Element, isNext: boolean) => {\r\n    let nextTarget: Element;\r\n    if(isNext) nextTarget = currentTarget.nextElementSibling || list.firstElementChild;\r\n    else nextTarget = currentTarget.previousElementSibling || list.lastElementChild;\r\n\r\n    return nextTarget;\r\n  };\r\n\r\n  const getNextTargetY = (currentTarget: Element, isNext: boolean) => {\r\n    const property = isNext ? 'nextElementSibling' : 'previousElementSibling';\r\n    const endProperty = isNext ? 'firstElementChild' : 'lastElementChild';\r\n    const currentRect = currentTarget.getBoundingClientRect();\r\n\r\n    let nextTarget = currentTarget[property] || list[endProperty];\r\n    while(nextTarget !== currentTarget) {\r\n      const targetRect = nextTarget.getBoundingClientRect();\r\n      if(targetRect.x === currentRect.x && targetRect.y !== currentRect.y) {\r\n        break;\r\n      }\r\n\r\n      nextTarget = nextTarget[property] || list[endProperty];\r\n    }\r\n\r\n    return nextTarget;\r\n  };\r\n\r\n  let handleArrowKey: (currentTarget: Element, key: ArrowKey) => Element;\r\n  if(type === 'xy') { // flex-direction: row; flex-wrap: wrap;\r\n    handleArrowKey = (currentTarget, key) => {\r\n      if(key === 'ArrowUp' || key === 'ArrowDown') return getNextTargetY(currentTarget, key === 'ArrowDown');\r\n      else return getNextTargetX(currentTarget, key === 'ArrowRight');\r\n    };\r\n  } else { // flex-direction: row | column;\r\n    handleArrowKey = (currentTarget, key) => getNextTargetX(currentTarget, key === 'ArrowRight' || key === 'ArrowDown');\r\n  }\r\n\r\n  let onKeyDown = (e: KeyboardEvent) => {\r\n    const key = e.key;\r\n    if(!keyNames.has(key as any)) {\r\n      if(key === 'Enter' || (type !== 'xy' && key === 'Tab')) {\r\n        cancelEvent(e);\r\n        fireSelect(getCurrentTarget());\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    cancelEvent(e);\r\n\r\n    if(list.childElementCount > 1) {\r\n      let currentTarget = getCurrentTarget();\r\n      currentTarget = handleArrowKey(currentTarget, key as any);\r\n      setCurrentTarget(currentTarget, true);\r\n    }\r\n  };\r\n\r\n  const scrollable = findUpClassName(list, 'scrollable');\r\n  list.classList.add('navigable-list');\r\n\r\n  const onMouseMove = (e: MouseEvent) => {\r\n    const target = findUpAsChild(e.target, list) as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n\r\n    setCurrentTarget(target, false);\r\n  };\r\n\r\n  const onClick = (e: Event) => {\r\n    cancelEvent(e); // cancel keyboard closening\r\n\r\n    const target = findUpAsChild(e.target, list) as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n\r\n    setCurrentTarget(target, false);\r\n    fireSelect(getCurrentTarget());\r\n  };\r\n\r\n  const fireSelect = (target: Element) => {\r\n    const canContinue = onSelect(target);\r\n    if(canContinue !== undefined ? !canContinue : once) {\r\n      detach();\r\n    }\r\n  };\r\n\r\n  let attached = false;\r\n  const attach = () => {\r\n    if(attached) return;\r\n    attached = true;\r\n    // const input = document.activeElement as HTMLElement;\r\n    // input.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n    document.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n    list.addEventListener('mousemove', onMouseMove, {passive: true});\r\n    attachClickEvent(list, onClick);\r\n  };\r\n\r\n  const detach = () => {\r\n    if(!attached) return;\r\n    attached = false;\r\n    // input.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n    document.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n    list.removeEventListener('mousemove', onMouseMove);\r\n    detachClickEvent(list, onClick);\r\n  };\r\n\r\n  const resetTarget = () => {\r\n    if(waitForKeySet) return;\r\n    setCurrentTarget(list.firstElementChild, false);\r\n  };\r\n\r\n  if(waitForKeySet) {\r\n    const _onKeyDown = onKeyDown;\r\n    onKeyDown = (e) => {\r\n      if(waitForKeySet.has(e.key)) {\r\n        cancelEvent(e);\r\n\r\n        document.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n        onKeyDown = _onKeyDown;\r\n        document.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n\r\n        waitForKeySet = undefined;\r\n        resetTarget();\r\n      }\r\n    };\r\n  } else {\r\n    resetTarget();\r\n  }\r\n\r\n  attach();\r\n\r\n  return {\r\n    attach,\r\n    detach,\r\n    resetTarget\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport attachListNavigation from \"../../helpers/dom/attachListNavigation\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\n\r\nexport default class AutocompleteHelper extends EventListenerBase<{\r\n  hidden: () => void,\r\n  visible: () => void,\r\n  hiding: () => void\r\n}> {\r\n  protected hidden = true;\r\n  protected container: HTMLElement;\r\n  protected list: HTMLElement;\r\n  protected resetTarget: () => void;\r\n  protected attach: () => void;\r\n  protected detach: () => void;\r\n  protected init?(): void;\r\n\r\n  protected controller: AutocompleteHelperController;\r\n  protected listType: 'xy' | 'x' | 'y';\r\n  protected onSelect: (target: Element) => boolean | void;\r\n  protected waitForKey?: string[];\r\n\r\n  protected navigationItem: NavigationItem;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    controller?: AutocompleteHelper['controller'],\r\n    listType: AutocompleteHelper['listType'],\r\n    onSelect: AutocompleteHelper['onSelect'],\r\n    waitForKey?: AutocompleteHelper['waitForKey']\r\n  }) {\r\n    super(false);\r\n\r\n    safeAssign(this, options);\r\n    \r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('autocomplete-helper', 'z-depth-1');\r\n    \r\n    options.appendTo.append(this.container);\r\n    \r\n    this.attachNavigation();\r\n\r\n    this.controller && this.controller.addHelper(this);\r\n  }\r\n\r\n  public toggleListNavigation(enabled: boolean) {\r\n    if(enabled) {\r\n      this.attach && this.attach();\r\n    } else {\r\n      this.detach && this.detach();\r\n    }\r\n  }\r\n\r\n  protected onVisible = () => {\r\n    if(this.detach) { // it can be so because 'visible' calls before animation's end\r\n      this.detach();\r\n    }\r\n\r\n    const list = this.list;\r\n    const {attach, detach, resetTarget} = attachListNavigation({\r\n      list, \r\n      type: this.listType,\r\n      onSelect: this.onSelect,\r\n      once: true,\r\n      waitForKey: this.waitForKey\r\n    });\r\n\r\n    this.attach = attach;\r\n    this.detach = detach;\r\n    this.resetTarget = resetTarget;\r\n    if(!IS_MOBILE && !this.navigationItem) {\r\n      this.navigationItem = {\r\n        type: 'autocomplete-helper',\r\n        onPop: () => {\r\n          this.navigationItem = undefined;\r\n          this.toggle(true);\r\n        },\r\n        noBlurOnPop: true\r\n      };\r\n\r\n      appNavigationController.pushItem(this.navigationItem);\r\n    }\r\n\r\n    this.addEventListener('hidden', () => {\r\n      this.resetTarget = undefined;\r\n      this.attach = undefined;\r\n      this.detach = undefined;\r\n\r\n      list.innerHTML = '';\r\n      detach();\r\n\r\n      if(this.navigationItem) {\r\n        appNavigationController.removeItem(this.navigationItem);\r\n        this.navigationItem = undefined;\r\n      }\r\n    }, {once: true});\r\n  };\r\n\r\n  protected attachNavigation() {\r\n    this.addEventListener('visible', this.onVisible);\r\n  }\r\n\r\n  public toggle(hide?: boolean, fromController = false, skipAnimation?: boolean) {\r\n    if(this.init) {\r\n      return;\r\n    }\r\n    \r\n    if(hide === undefined) {\r\n      hide = this.container.classList.contains('is-visible') && !this.container.classList.contains('backwards');\r\n    }\r\n\r\n    if(this.hidden === hide) {\r\n      if(!hide) {\r\n        this.dispatchEvent('visible'); // reset target and listener\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    this.hidden = hide;\r\n\r\n    if(!hide) {\r\n      this.controller && this.controller.hideOtherHelpers(this);\r\n      this.dispatchEvent('visible'); // fire it before so target will be set\r\n    } else {\r\n      if(this.navigationItem) {\r\n        appNavigationController.removeItem(this.navigationItem);\r\n        this.navigationItem = undefined;\r\n      }\r\n\r\n      if(!fromController && this.controller) {\r\n        this.controller.hideOtherHelpers();\r\n      }\r\n\r\n      if(this.detach) { // force detach here\r\n        this.detach();\r\n      }\r\n    }\r\n\r\n    const useRafs = this.controller || hide ? 0 : 2;\r\n\r\n    if(hide) {\r\n      this.dispatchEvent('hiding');\r\n    }\r\n\r\n    SetTransition(\r\n      this.container, \r\n      'is-visible', \r\n      !hide, \r\n      rootScope.settings.animationsEnabled && !skipAnimation ? 300 : 0, \r\n      () => {\r\n        this.hidden && this.dispatchEvent('hidden');\r\n      }, \r\n      useRafs\r\n    );\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport preloadAnimatedEmojiSticker from \"../../helpers/preloadAnimatedEmojiSticker\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { EmoticonsDropdown } from \"../emoticonsDropdown\";\r\nimport { SuperStickerRenderer } from \"../emoticonsDropdown/tabs/stickers\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\n\r\nexport default class StickersHelper extends AutocompleteHelper {\r\n  private scrollable: Scrollable;\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private onChangeScreen: () => void;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController,\r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'xy', \r\n      onSelect: (target) => {\r\n        return !EmoticonsDropdown.onMediaClick({target}, true);\r\n      }, \r\n      waitForKey: ['ArrowUp', 'ArrowDown']\r\n    });\r\n\r\n    this.container.classList.add('stickers-helper');\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0);\r\n\r\n      rootScope.dispatchEvent('choosing_sticker', true);\r\n    });\r\n\r\n    this.addEventListener('hidden', () => {\r\n      if(this.onChangeScreen) {\r\n        mediaSizes.removeEventListener('changeScreen', this.onChangeScreen);\r\n        this.onChangeScreen = undefined;\r\n      }\r\n\r\n      rootScope.dispatchEvent('choosing_sticker', false);\r\n    });\r\n  }\r\n\r\n  public checkEmoticon(emoticon: string) {\r\n    const middleware = this.controller.getMiddleware();\r\n\r\n    if(this.lazyLoadQueue) {\r\n      this.lazyLoadQueue.clear();\r\n    }\r\n\r\n    preloadAnimatedEmojiSticker(emoticon);\r\n    this.managers.appStickersManager.getStickersByEmoticon(emoticon)\r\n    .then((stickers) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      const container = this.list.cloneNode() as HTMLElement;\r\n\r\n      let ready: Promise<void>;\r\n\r\n      this.lazyLoadQueue.clear();\r\n      if(stickers.length) {\r\n        ready = new Promise<void>((resolve) => {\r\n          const promises: Promise<any>[] = [];\r\n          stickers.forEach((sticker) => {\r\n            container.append(this.superStickerRenderer.renderSticker(sticker as MyDocument, undefined, promises));\r\n          });\r\n\r\n          (Promise.all(promises) as Promise<any>).finally(resolve);\r\n        });\r\n      } else {\r\n        ready = Promise.resolve();\r\n      }\r\n\r\n      ready.then(() => {\r\n        this.list.replaceWith(container);\r\n        this.list = container;\r\n\r\n        if(!this.onChangeScreen) {\r\n          this.onChangeScreen = () => {\r\n            const width = (this.list.childElementCount * mediaSizes.active.esgSticker.width) + (this.list.childElementCount - 1 * 1);\r\n            this.list.style.width = width + 'px';\r\n          };\r\n          mediaSizes.addEventListener('changeScreen', this.onChangeScreen);\r\n        }\r\n\r\n        this.onChangeScreen();\r\n\r\n        this.toggle(!stickers.length);\r\n        this.scrollable.scrollTop = 0;\r\n      });\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('stickers-helper-stickers', 'super-stickers');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.superStickerRenderer = new SuperStickerRenderer(this.lazyLoadQueue, CHAT_ANIMATION_GROUP, this.managers);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { SEND_WHEN_ONLINE_TIMESTAMP } from \"../../lib/mtproto/constants\";\r\nimport Button from \"../button\";\r\nimport PopupDatePicker from \"./datePicker\";\r\n\r\nconst getMinDate = () => {\r\n  const date = new Date();\r\n  //date.setDate(date.getDate() - 1);\r\n  date.setHours(0, 0, 0, 0);\r\n  return date;\r\n};\r\n\r\nconst getMaxDate = () => {\r\n  const date = new Date();\r\n  date.setFullYear(date.getFullYear() + 1);\r\n  date.setDate(date.getDate() - 1);\r\n  return date;\r\n};\r\n\r\nconst checkDate = (date: Date) => {\r\n  return date.getTime() > getMaxDate().getTime() ? new Date() : date;\r\n};\r\n\r\nexport default class PopupSchedule extends PopupDatePicker {\r\n  constructor(initDate: Date, onPick: (timestamp: number) => void, canSendWhenOnline: boolean) {\r\n    super(checkDate(initDate), onPick, {\r\n      noButtons: true,\r\n      noTitle: true,\r\n      closable: true,\r\n      withConfirm: true,\r\n      minDate: getMinDate(),\r\n      maxDate: getMaxDate(),\r\n      withTime: true,\r\n      showOverflowMonths: true,\r\n      confirmShortcutIsSendShortcut: true\r\n    });\r\n\r\n    this.element.classList.add('popup-schedule');\r\n    this.header.append(this.controlsDiv);\r\n    this.title.replaceWith(this.monthTitle);\r\n    this.body.append(this.btnConfirm);\r\n\r\n    if(canSendWhenOnline) {\r\n      const btnSendWhenOnline = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'Schedule.SendWhenOnline'});\r\n      this.body.append(btnSendWhenOnline);\r\n\r\n      attachClickEvent(btnSendWhenOnline, () => {\r\n        onPick(SEND_WHEN_ONLINE_TIMESTAMP);\r\n        this.hide();\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { MessageEntity } from \"../../layer\";\r\nimport combineSameEntities from \"../../lib/richTextProcessor/combineSameEntities\";\r\nimport getRichElementValue from \"./getRichElementValue\";\r\n\r\nexport default function getRichValueWithCaret(field: HTMLElement, withEntities = true) {\r\n  const lines: string[] = [];\r\n  const line: string[] = [];\r\n\r\n  const sel = window.getSelection();\r\n  let selNode: Node;\r\n  let selOffset: number;\r\n  if(sel && sel.rangeCount) {\r\n    const range = sel.getRangeAt(0);\r\n    const startOffset = range.startOffset;\r\n    if(\r\n      range.startContainer &&\r\n      range.startContainer == range.endContainer &&\r\n      startOffset == range.endOffset\r\n    ) {\r\n      // * if focused on img, or caret has been set via placeCaretAtEnd\r\n      const possibleChildrenFocusOffset = startOffset - 1;\r\n      const childNodes = field.childNodes;\r\n      if(range.startContainer === field && childNodes[possibleChildrenFocusOffset]) {\r\n        selNode = childNodes[possibleChildrenFocusOffset];\r\n        selOffset = 0;\r\n\r\n        for(let i = 0; i < range.endOffset; ++i) {\r\n          const node = childNodes[i];\r\n          const value = node.nodeValue || (node as HTMLImageElement).alt;\r\n\r\n          if(value) {\r\n            selOffset += value.length;\r\n          }\r\n        }\r\n      } else {\r\n        selNode = range.startContainer;\r\n        selOffset = startOffset;\r\n      }\r\n    }\r\n  }\r\n\r\n  const entities: MessageEntity[] = withEntities ? [] : undefined;\r\n  getRichElementValue(field, lines, line, selNode, selOffset, entities);\r\n\r\n  if(line.length) {\r\n    lines.push(line.join(''));\r\n  }\r\n\r\n  let value = lines.join('\\n');\r\n  const caretPos = value.indexOf('\\x01');\r\n  if(caretPos != -1) {\r\n    value = value.substr(0, caretPos) + value.substr(caretPos + 1);\r\n  }\r\n  value = value.replace(/\\u00A0/g, ' ');\r\n\r\n  if(entities) {\r\n    combineSameEntities(entities);\r\n  }\r\n\r\n  return {value, entities, caretPos};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport { appendEmoji, getEmojiFromElement } from \"../emoticonsDropdown/tabs/emoji\";\r\nimport { ScrollableX } from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class EmojiHelper extends AutocompleteHelper {\r\n  private scrollable: ScrollableX;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo,\r\n      controller, \r\n      listType: 'x', \r\n      onSelect: (target) => {\r\n        chatInput.onEmojiSelected(getEmojiFromElement(target as any), true);\r\n      }\r\n    });\r\n\r\n    this.container.classList.add('emoji-helper');\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('emoji-helper-emojis', 'super-emojis');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new ScrollableX(this.container);\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollLeft = 0;\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public render(emojis: string[], waitForKey: boolean) {\r\n    if(this.init) {\r\n      if(!emojis.length) {\r\n        return;\r\n      }\r\n\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n    \r\n    emojis = emojis.slice(0, 80);\r\n\r\n    if(emojis.length) {\r\n      this.list.innerHTML = '';\r\n      emojis.forEach((emoji) => {\r\n        appendEmoji(emoji, this.list, false, true);\r\n      });\r\n    }\r\n\r\n    this.waitForKey = waitForKey ? ['ArrowUp', 'ArrowDown'] : undefined;\r\n    this.toggle(!emojis.length);\r\n\r\n    /* window.requestAnimationFrame(() => {\r\n      this.container.style.width = (3 * 2) + (emojis.length * 44) + 'px';\r\n    }); */\r\n  }\r\n\r\n  public checkQuery(query: string, firstChar: string) {\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appEmojiManager.getBothEmojiKeywords().then(async() => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const q = query.replace(/^:/, '');\r\n      const emojis = await this.managers.appEmojiManager.searchEmojis(q);\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n      \r\n      this.render(emojis, firstChar !== ':');\r\n      //console.log(emojis);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport AvatarElement from \"../avatar\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport Scrollable from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\n\r\nexport default class AutocompletePeerHelper extends AutocompleteHelper {\r\n  protected static BASE_CLASS = 'autocomplete-peer-helper';\r\n  protected static BASE_CLASS_LIST_ELEMENT = AutocompletePeerHelper.BASE_CLASS + '-list-element';\r\n  private scrollable: Scrollable;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    protected className: string, \r\n    onSelect: (target: Element) => boolean | void\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'y', \r\n      onSelect\r\n    });\r\n\r\n    this.container.classList.add(AutocompletePeerHelper.BASE_CLASS, className);\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add(AutocompletePeerHelper.BASE_CLASS + '-list', this.className + '-list');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public render(data: {peerId: PeerId, name?: string, description?: string}[], doNotShow?: boolean) {\r\n    if(this.init) {\r\n      if(!data.length) {\r\n        return;\r\n      }\r\n\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    if(data.length) {\r\n      this.list.innerHTML = '';\r\n      data.forEach((d) => {\r\n        const div = AutocompletePeerHelper.listElement({\r\n          className: this.className,\r\n          peerId: d.peerId,\r\n          name: d.name,\r\n          description: d.description\r\n        });\r\n\r\n        this.list.append(div);\r\n      });\r\n    }\r\n\r\n    if(!doNotShow) {\r\n      this.toggle(!data.length);\r\n    }\r\n  }\r\n\r\n  public static listElement(options: {\r\n    className: string,\r\n    peerId: PeerId,\r\n    name?: string,\r\n    description?: string\r\n  }) {\r\n    const BASE = AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT;\r\n    options.className += '-list-element';\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add(BASE, options.className);\r\n    div.dataset.peerId = '' + options.peerId;\r\n  \r\n    const avatar = new AvatarElement();\r\n    avatar.classList.add('avatar-30', BASE + '-avatar', options.className + '-avatar');\r\n    avatar.updateWithOptions({\r\n      isDialog: false,\r\n      peerId: options.peerId\r\n    });\r\n  \r\n    const name = document.createElement('div');\r\n    name.classList.add(BASE + '-name', options.className + '-name');\r\n    if(!options.name) {\r\n      name.append(new PeerTitle({\r\n        peerId: options.peerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      }).element);\r\n    } else {\r\n      setInnerHTML(name, wrapEmojiText(options.name));\r\n    }\r\n  \r\n    div.append(avatar, name);\r\n\r\n    if(options.description) {\r\n      const description = document.createElement('div');\r\n      description.classList.add(BASE + '-description', options.className + '-description');\r\n      setInnerHTML(description, wrapEmojiText(options.description));\r\n      div.append(description);\r\n    }\r\n  \r\n    return div;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport type { BotInfo, ChatFull, UserFull } from \"../../layer\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport SearchIndex from \"../../lib/searchIndex\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport function processPeerFullForCommands(peerId: PeerId, full: ChatFull.chatFull | ChatFull.channelFull | UserFull.userFull, query?: string) {\r\n  const botInfos: BotInfo.botInfo[] = [].concat(full.bot_info);\r\n  let index: SearchIndex<string>; \r\n  \r\n  if(query !== undefined) {\r\n    index = new SearchIndex<string>({\r\n      ignoreCase: true\r\n    });\r\n  }\r\n  \r\n  type T = {peerId: PeerId, name: string, description: string, index: number, command: string};\r\n  const commands: Map<string, T> = new Map();\r\n  botInfos.forEach((botInfo) => {\r\n    botInfo.commands.forEach(({command, description}, idx) => {\r\n      const c = '/' + command;\r\n      commands.set(command, {\r\n        peerId: botInfo.user_id ? botInfo.user_id.toPeerId(false) : peerId, \r\n        command: command, \r\n        name: c, \r\n        description: description,\r\n        index: idx\r\n      });\r\n\r\n      if(index) {\r\n        index.indexObject(command, c);\r\n      }\r\n    });\r\n  });\r\n\r\n  let out: T[];\r\n  if(!index) {\r\n    out = [...commands.values()];\r\n  } else {\r\n    const found = index.search(query);\r\n    out = Array.from(found).map((command) => commands.get(command));\r\n  }\r\n\r\n  out = out.sort((a, b) => commands.get(a.command).index - commands.get(b.command).index);\r\n  \r\n  return out;\r\n}\r\n\r\nexport default class CommandsHelper extends AutocompletePeerHelper {\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super(appendTo, \r\n      controller,\r\n      'commands-helper',\r\n      (target) => {\r\n        const innerHTML = target.querySelector(`.${AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;\r\n        return chatInput.getReadyToSend(() => {\r\n          chatInput.messageInput.innerHTML = innerHTML;\r\n          chatInput.sendMessage(true);\r\n        });\r\n      }\r\n    );\r\n  }\r\n\r\n  public async checkQuery(query: string, peerId: PeerId) {\r\n    if(!(await this.managers.appUsersManager.isBot(peerId))) {\r\n      return false;\r\n    }\r\n\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appProfileManager.getProfileByPeerId(peerId).then((full) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const filtered = processPeerFullForCommands(peerId, full, query);\r\n      this.render(filtered);\r\n      // console.log('found commands', found, filtered);\r\n    });\r\n\r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\n\r\nexport default class AutocompleteHelperController {\r\n  private helpers: Set<AutocompleteHelper> = new Set();\r\n  private middleware = getMiddleware();\r\n  /* private tempId = 0;\r\n\r\n  public incrementToggleCount() {\r\n    return ++this.tempId;\r\n  }\r\n\r\n  public getToggleCount() {\r\n    return this.tempId;\r\n  } */\r\n\r\n  public toggleListNavigation(enabled: boolean) {\r\n    for(const helper of this.helpers) {\r\n      helper.toggleListNavigation(enabled);\r\n    }\r\n  }\r\n\r\n  public getMiddleware() {\r\n    this.middleware.clean();\r\n    return this.middleware.get();\r\n  }\r\n\r\n  public addHelper(helper: AutocompleteHelper) {\r\n    this.helpers.add(helper);\r\n  }\r\n\r\n  public hideOtherHelpers(preserveHelper?: AutocompleteHelper) {\r\n    this.helpers.forEach((helper) => {\r\n      if(helper !== preserveHelper) {\r\n        helper.toggle(true, true);\r\n      }\r\n    });\r\n\r\n    if(!preserveHelper) {\r\n      this.middleware.clean();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport type { MessageEntity } from \"../../layer\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class MentionsHelper extends AutocompletePeerHelper {\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super(\r\n      appendTo, \r\n      controller,\r\n      'mentions-helper',\r\n      (target) => {\r\n        const userId = (target as HTMLElement).dataset.peerId.toUserId();\r\n        const user = Promise.resolve(managers.appUsersManager.getUser(userId)).then((user) => {\r\n          let str = '', entity: MessageEntity;\r\n          if(user.username) {\r\n            str = '@' + user.username;\r\n          } else {\r\n            str = user.first_name || user.last_name;\r\n            entity = {\r\n              _: 'messageEntityMentionName',\r\n              length: str.length,\r\n              offset: 0,\r\n              user_id: user.id\r\n            };\r\n          }\r\n  \r\n          str += ' ';\r\n          chatInput.insertAtCaret(str, entity);\r\n        });\r\n      }\r\n    );\r\n  }\r\n\r\n  public checkQuery(query: string, peerId: PeerId, topMsgId: number) {\r\n    const trimmed = query.trim(); // check that there is no whitespace\r\n    if(query.length !== trimmed.length) return false;\r\n\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appProfileManager.getMentions(peerId && peerId.toChatId(), trimmed, topMsgId).then(async(peerIds) => {\r\n      if(!middleware()) return;\r\n      \r\n      const username = trimmed.slice(1).toLowerCase();\r\n\r\n      const p = peerIds.map(async(peerId) => {\r\n        const user = await this.managers.appUsersManager.getUser(peerId);\r\n        if(user.username && user.username.toLowerCase() === username) { // hide full matched suggestion\r\n          return;\r\n        }\r\n\r\n        return {\r\n          peerId,\r\n          description: user.username ? '@' + user.username : undefined\r\n        };\r\n      });\r\n\r\n      this.render((await Promise.all(p)).filter(Boolean));\r\n    });\r\n\r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport DropdownHover from \"../../helpers/dropdownHover\";\r\nimport { KeyboardButton, ReplyMarkup } from \"../../layer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ListenerSetter, { Listener } from \"../../helpers/listenerSetter\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class ReplyKeyboard extends DropdownHover {\r\n  private static BASE_CLASS = 'reply-keyboard';\r\n  private appendTo: HTMLElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private managers: AppManagers;\r\n  private btnHover: HTMLElement;\r\n  private peerId: PeerId;\r\n  private touchListener: Listener;\r\n  private chatInput: ChatInput;\r\n\r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    managers: AppManagers,\r\n    appendTo: HTMLElement,\r\n    btnHover: HTMLElement,\r\n    chatInput: ChatInput\r\n  }) {\r\n    super({\r\n      element: document.createElement('div')\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.element.classList.add(ReplyKeyboard.BASE_CLASS);\r\n    this.element.style.display = 'none';\r\n\r\n    this.attachButtonListener(this.btnHover, this.listenerSetter);\r\n    this.listenerSetter.add(rootScope)('history_reply_markup', async({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        if(this.checkAvailability() && this.isActive()) {\r\n          await this.render();\r\n        }\r\n\r\n        getHeavyAnimationPromise().then(() => {\r\n          this.checkForceReply();\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.appendTo.append(this.element);\r\n\r\n    this.listenerSetter.add(this)('open', async() => {\r\n      await this.render();\r\n\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        this.touchListener = this.listenerSetter.add(document.body)('touchstart', this.onBodyTouchStart, {passive: false, capture: true}) as any as Listener;\r\n        this.listenerSetter.add(this)('close', () => {\r\n          this.listenerSetter.remove(this.touchListener);\r\n        }, {once: true});\r\n      }\r\n    });\r\n    \r\n    this.listenerSetter.add(this.element)('click', (e) => {\r\n      const target = findUpClassName(e.target, 'btn');\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const type = target.dataset.type as KeyboardButton['_'];\r\n      const {peerId} = this;\r\n      switch(type) {\r\n        case 'keyboardButtonRequestPhone': {\r\n          confirmationPopup({\r\n            titleLangKey: 'ShareYouPhoneNumberTitle',\r\n            button: {\r\n              langKey: 'OK'\r\n            },\r\n            descriptionLangKey: 'AreYouSureShareMyContactInfoBot'\r\n          }).then(() => {\r\n            this.managers.appMessagesManager.sendContact(peerId, rootScope.myId);\r\n          });\r\n          break;\r\n        }\r\n\r\n        default: {\r\n          this.managers.appMessagesManager.sendText(peerId, target.dataset.text);\r\n          break;\r\n        }\r\n      }\r\n\r\n      this.toggle(false);\r\n    });\r\n\r\n    return super.init();\r\n  }\r\n\r\n  private onBodyTouchStart = (e: TouchEvent) => {\r\n    const target = e.touches[0].target as HTMLElement;\r\n    if(!findUpAsChild(target, this.element) && target !== this.btnHover) {\r\n      cancelEvent(e);\r\n      this.toggle(false);\r\n    }\r\n  };\r\n\r\n  public async checkForceReply() {\r\n    const replyMarkup = await this.getReplyMarkup();\r\n    if(replyMarkup._ === 'replyKeyboardForceReply' &&\r\n      !replyMarkup.pFlags.hidden && \r\n      !replyMarkup.pFlags.used) {\r\n      replyMarkup.pFlags.used = true;\r\n      this.chatInput.initMessageReply(replyMarkup.mid);\r\n    }\r\n  }\r\n\r\n  private async getReplyMarkup() {\r\n    return (await this.managers.appMessagesManager.getHistoryStorageTransferable(this.peerId)).replyMarkup ?? {\r\n      _: 'replyKeyboardHide'\r\n    };\r\n  }\r\n\r\n  public async render(replyMarkup?: ReplyMarkup.replyKeyboardMarkup) {\r\n    if(replyMarkup === undefined) {\r\n      replyMarkup = await this.getReplyMarkup() as any;\r\n    }\r\n\r\n    this.element.textContent = '';\r\n\r\n    for(const row of replyMarkup.rows) {\r\n      const div = document.createElement('div');\r\n      div.classList.add(ReplyKeyboard.BASE_CLASS + '-row');\r\n\r\n      for(const button of row.buttons) {\r\n        const btn = document.createElement('button');\r\n        btn.classList.add(ReplyKeyboard.BASE_CLASS + '-button', 'btn');\r\n        setInnerHTML(btn, wrapEmojiText(button.text));\r\n        btn.dataset.text = button.text;\r\n        btn.dataset.type = button._;\r\n        div.append(btn);\r\n      }\r\n\r\n      this.element.append(div);\r\n    }\r\n  }\r\n\r\n  public async checkAvailability(replyMarkup?: ReplyMarkup) {\r\n    if(replyMarkup === undefined) {\r\n      replyMarkup = await this.getReplyMarkup();\r\n    }\r\n\r\n    const hide = replyMarkup._ === 'replyKeyboardHide' || !(replyMarkup as ReplyMarkup.replyInlineMarkup).rows?.length;\r\n    this.btnHover.classList.toggle('hide', hide);\r\n\r\n    if(hide) {\r\n      this.toggle(false);\r\n    }\r\n\r\n    return !hide;\r\n  }\r\n\r\n  public setPeer(peerId: PeerId) {\r\n    this.peerId = peerId;\r\n\r\n    this.checkAvailability();\r\n    this.checkForceReply();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"./chat\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { WebDocument } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { wrapPhoto } from \"../wrappers\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport Button from \"../button\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { MyPhoto } from \"../../lib/appManagers/appPhotosManager\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport GifsMasonry from \"../gifsMasonry\";\r\nimport { SuperStickerRenderer } from \"../emoticonsDropdown/tabs/stickers\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport readBlobAsDataURL from \"../../helpers/blob/readBlobAsDataURL\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport renderImageWithFadeIn from \"../../helpers/dom/renderImageWithFadeIn\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport generateQId from \"../../lib/appManagers/utils/inlineBots/generateQId\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\n\r\nconst ANIMATION_GROUP = 'INLINE-HELPER';\r\n// const GRID_ITEMS = 5;\r\n\r\nexport default class InlineHelper extends AutocompleteHelper {\r\n  private scrollable: Scrollable;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private gifsMasonry: GifsMasonry;\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n  private onChangeScreen: () => void;\r\n  public checkQuery: (peerId: PeerId, username: string, query: string) => ReturnType<InlineHelper['_checkQuery']>;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController,\r\n    private chat: Chat,\r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'xy', \r\n      waitForKey: ['ArrowUp', 'ArrowDown'],\r\n      onSelect: (target) => {\r\n        if(!target) return false; // can happen when there is only button\r\n        const {peerId, botId, queryId} = this.list.dataset;\r\n        return this.chat.input.getReadyToSend(() => {\r\n          const queryAndResultIds = generateQId(queryId, (target as HTMLElement).dataset.resultId);\r\n          this.managers.appInlineBotsManager.sendInlineResult(peerId.toPeerId(), botId, queryAndResultIds, {\r\n            ...this.chat.getMessageSendingParams(),\r\n            clearDraft: true,\r\n          });\r\n\r\n          this.chat.input.onMessageSent(true, true);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.container.classList.add('inline-helper');\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0); \r\n    });\r\n\r\n    this.checkQuery = debounce(this._checkQuery, 200, true, true);\r\n\r\n    this.addEventListener('hidden', () => {\r\n      if(this.onChangeScreen) {\r\n        mediaSizes.removeEventListener('changeScreen', this.onChangeScreen);\r\n        this.onChangeScreen = undefined;\r\n      }\r\n    });\r\n  }\r\n\r\n  public _checkQuery = async(peerId: PeerId, username: string, query: string) => {\r\n    const middleware = this.controller.getMiddleware();\r\n\r\n    const peer = await this.managers.appUsersManager.resolveUsername(username);\r\n    if(!middleware()) {\r\n      throw 'PEER_CHANGED';\r\n    }\r\n\r\n    if(peer._ !== 'user') {\r\n      throw 'NOT_A_BOT';\r\n    }\r\n\r\n    const renderPromise = this.managers.appInlineBotsManager.getInlineResults(peerId, peer.id, query).then((botResults) => {\r\n      if(!middleware()) {\r\n        throw 'PEER_CHANGED';\r\n      }\r\n\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      const list = this.list.cloneNode() as HTMLElement;\r\n      list.dataset.peerId = '' + peerId;\r\n      list.dataset.botId = '' + peer.id;\r\n      list.dataset.queryId = '' + botResults.query_id;\r\n\r\n      const gifsMasonry = new GifsMasonry(null, ANIMATION_GROUP, this.scrollable, false);\r\n\r\n      this.lazyLoadQueue.clear();\r\n      this.superStickerRenderer.clear();\r\n      \r\n      const loadPromises: Promise<any>[] = [];\r\n      const isGallery = !!botResults.pFlags.gallery;\r\n      // botResults.results.length = 3;\r\n      for(const item of botResults.results) {\r\n        const container = document.createElement('div');\r\n        container.classList.add('inline-helper-result');\r\n        container.dataset.resultId = item.id;\r\n  \r\n        const preview = isGallery ? undefined : document.createElement('div');\r\n        if(preview) {\r\n          preview.classList.add('inline-helper-result-preview');\r\n\r\n          container.append(preview);\r\n        }\r\n\r\n        list.append(container);\r\n\r\n        if(!isGallery) {\r\n          preview.classList.add('empty');\r\n          setInnerHTML(preview, wrapEmojiText([...item.title.trim()][0]));\r\n\r\n          const title = document.createElement('div');\r\n          title.classList.add('inline-helper-result-title');\r\n          setInnerHTML(title, wrapEmojiText(item.title));\r\n    \r\n          const description = document.createElement('div');\r\n          description.classList.add('inline-helper-result-description');\r\n          setInnerHTML(description, wrapRichText(item.description, {\r\n            noCommands: true,\r\n            noLinks: true\r\n          }));\r\n    \r\n          container.append(title, description);\r\n  \r\n          const separator = document.createElement('div');\r\n          separator.classList.add('inline-helper-separator');\r\n    \r\n          list.append(separator);\r\n        } else {\r\n          container.classList.add('grid-item');\r\n        }\r\n        \r\n        if(item._ === 'botInlineResult') {\r\n          if(item.thumb && item.thumb.mime_type.indexOf('image/') === 0) {\r\n            let mediaContainer: HTMLElement;\r\n            if(preview) {\r\n              mediaContainer = document.createElement('div');\r\n              preview.append(mediaContainer);\r\n            } else {\r\n              mediaContainer = container;\r\n            }\r\n\r\n            mediaContainer.classList.add('media-container'); \r\n            isGallery && mediaContainer.classList.add('no-border-radius');\r\n\r\n            this.lazyLoadQueue.push({\r\n              div: container,\r\n              load: () => {\r\n                return appDownloadManager.download({\r\n                  dcId: 4,\r\n                  location: {\r\n                    _: 'inputWebFileLocation',\r\n                    access_hash: (item.thumb as WebDocument.webDocument).access_hash,\r\n                    url: item.thumb.url\r\n                  },\r\n                  size: item.thumb.size,\r\n                  mimeType: item.thumb.mime_type\r\n                }).then((blob) => {\r\n                  const image = new Image();\r\n                  image.classList.add('media-photo');\r\n                  readBlobAsDataURL(blob).then((dataURL) => {\r\n                    renderImageWithFadeIn(mediaContainer, image, dataURL, true);\r\n                  });\r\n                });\r\n              }\r\n            });\r\n          }\r\n        } else {\r\n          const media = item.document as MyDocument || item.photo as MyPhoto;\r\n          if((['sticker', 'gif'] as MyDocument['type'][]).includes((media as MyDocument)?.type) && isGallery) {\r\n            assumeType<MyDocument>(media);\r\n\r\n            if(media.type === 'gif') {\r\n              gifsMasonry.add(media, container);\r\n            } else if(media.type === 'sticker') {\r\n              container.classList.add('super-sticker');\r\n              this.superStickerRenderer.renderSticker(media, container, loadPromises);\r\n              if(media.sticker === 2) {\r\n                this.superStickerRenderer.observeAnimatedDiv(container);\r\n              }\r\n            }\r\n          } else if(media) {\r\n            const size = isGallery ? 48 : undefined;\r\n            isGallery && container.classList.add('no-border-radius');\r\n            wrapPhoto({\r\n              photo: media,\r\n              container: isGallery ? container : preview,\r\n              boxWidth: size,\r\n              boxHeight: size,\r\n              middleware,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              loadPromises\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      return Promise.all(loadPromises).then(() => {\r\n        if(!middleware()) {\r\n          gifsMasonry.clear();\r\n          return;\r\n        }\r\n\r\n        list.classList.toggle('is-gallery', isGallery);\r\n        list.classList.toggle('super-stickers', isGallery);\r\n        this.container.classList.toggle('is-gallery', isGallery);\r\n\r\n        /* if(isGallery) {\r\n          list.style.gridTemplateColumns = `repeat(${Math.min(botResults.results.length, 4)}, 1fr)`;\r\n        }\r\n\r\n        this.container.style.setProperty('width', isGallery ? `${Math.min(botResults.results.length, 4) * 25}%` : '', 'important'); */\r\n\r\n        const parent = this.list.parentElement;\r\n        parent.textContent = '';\r\n        if(botResults.switch_pm) {\r\n          const btnSwitchToPM = Button('btn-primary btn-secondary btn-primary-transparent primary');\r\n          setInnerHTML(btnSwitchToPM, wrapEmojiText(botResults.switch_pm.text));\r\n          attachClickEvent(btnSwitchToPM, (e) => {\r\n            this.chat.appImManager.setInnerPeer({peerId});\r\n            this.managers.appInlineBotsManager.switchToPM(peerId, peer.id, botResults.switch_pm.start_param);\r\n          });\r\n          parent.append(btnSwitchToPM);\r\n        }\r\n        parent.append(this.list = list);\r\n\r\n        if(this.gifsMasonry) {\r\n          this.gifsMasonry.detach();\r\n        }\r\n        this.gifsMasonry = gifsMasonry;\r\n        gifsMasonry.attach();\r\n\r\n        if(!this.onChangeScreen) {\r\n          this.onChangeScreen = () => {\r\n            if(this.list.classList.contains('is-gallery')) {\r\n              const width = (this.list.childElementCount * mediaSizes.active.esgSticker.width) + (this.list.childElementCount - 1 * 1);\r\n              this.list.style.width = width + 'px';\r\n            } else {\r\n              this.list.style.width = '';\r\n            }\r\n          };\r\n          mediaSizes.addEventListener('changeScreen', this.onChangeScreen);\r\n        }\r\n\r\n        this.onChangeScreen();\r\n  \r\n        this.toggle(!botResults.results.length && !botResults.switch_pm);\r\n        this.scrollable.scrollTop = 0;\r\n      });\r\n    });\r\n\r\n    return {user: peer, renderPromise};\r\n  };\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('inline-helper-results');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.superStickerRenderer = new SuperStickerRenderer(this.lazyLoadQueue, ANIMATION_GROUP, this.managers);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport { processPeerFullForCommands } from \"./commandsHelper\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nconst CLASS_NAME = 'bot-commands';\r\nexport default class ChatBotCommands extends AutocompletePeerHelper {\r\n  private userId: UserId;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement,\r\n    chatInput: ChatInput,\r\n    private managers: AppManagers\r\n  ) {\r\n    super(appendTo, undefined, CLASS_NAME, (target) => {\r\n      const innerHTML = target.querySelector(`.${AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;\r\n      return chatInput.getReadyToSend(() => {\r\n        chatInput.messageInput.innerHTML = innerHTML;\r\n        chatInput.sendMessage(true);\r\n        this.toggle(true);\r\n      });\r\n    });\r\n  }\r\n\r\n  public setUserId(userId: UserId, middleware: () => boolean) {\r\n    if(this.userId === userId && this.list?.childElementCount) {\r\n      this.toggle(false);\r\n      return;\r\n    }\r\n\r\n    this.userId = userId;\r\n    return callbackify(this.managers.appProfileManager.getProfile(userId), (full) => {\r\n      if(!middleware()) return;\r\n      const filtered = processPeerFullForCommands(userId.toPeerId(false), full);\r\n      \r\n      const PADDING_TOP = 8;\r\n      // const PADDING_BOTTOM = 8;\r\n      const PADDING_BOTTOM = 24;\r\n      const height = filtered.length * 50 + PADDING_TOP + PADDING_BOTTOM;\r\n      this.container.style.setProperty('--height', height + 'px');\r\n\r\n      this.render(filtered);\r\n      \r\n      // this.container.style.top = \r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AckedResult } from \"../lib/mtproto/superMessagePort\";\r\nimport { Modify } from \"../types\";\r\n\r\nexport default async function modifyAckedResult<T>(acked: AckedResult<T>): Promise<Modify<AckedResult<T>, {result: T | Promise<T>}>> {\r\n  return {\r\n    cached: acked.cached,\r\n    result: acked.cached ? await acked.result : acked.result\r\n  };\r\n}\r\n\r\nexport function modifyAckedPromise<T>(promise: Promise<AckedResult<T>>) {\r\n  return promise.then(modifyAckedResult);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport { modifyAckedPromise } from \"../../helpers/modifyAckedResult\";\r\nimport { ChatFull } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { AckedResult } from \"../../lib/mtproto/superMessagePort\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport getChatMembersString from \"../wrappers/getChatMembersString\";\r\n\r\nconst SEND_AS_ANIMATION_DURATION = 300;\r\n\r\nexport default class ChatSendAs {\r\n  private avatar: AvatarElement;\r\n  private container: HTMLElement;\r\n  private closeBtn: HTMLElement;\r\n  private btnMenu: HTMLElement;\r\n  private sendAsPeerIds: PeerId[];\r\n  private sendAsPeerId: PeerId;\r\n  private updatingPromise: ReturnType<ChatSendAs['updateManual']>;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private listenerSetter: ListenerSetter;\r\n  private peerId: PeerId;\r\n  private addedListener: boolean;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    private onReady: (container: HTMLElement, skipAnimation?: boolean) => void,\r\n    private onChange: (sendAsPeerId: PeerId) => void\r\n  ) {\r\n    this.middleware = getMiddleware();\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.construct();\r\n  }\r\n  \r\n  private construct() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('new-message-send-as-container');\r\n\r\n    this.closeBtn = document.createElement('div');\r\n    this.closeBtn.classList.add('new-message-send-as-close', 'new-message-send-as-avatar', 'tgico-close');\r\n\r\n    const sendAsButtons: ButtonMenuItemOptions[] = [{\r\n      text: 'SendMessageAsTitle',\r\n      onClick: undefined\r\n    }];\r\n\r\n    let previousAvatar: HTMLElement;\r\n    const onSendAsMenuToggle = (visible: boolean) => {\r\n      if(visible) {\r\n        previousAvatar = this.avatar;\r\n      }\r\n\r\n      const isChanged = this.avatar !== previousAvatar;\r\n      const useRafs = !visible && isChanged ? 2 : 0;\r\n\r\n      SetTransition(this.closeBtn, 'is-visible', visible, SEND_AS_ANIMATION_DURATION, undefined, useRafs);\r\n      if(!isChanged) {\r\n        SetTransition(previousAvatar, 'is-visible', !visible, SEND_AS_ANIMATION_DURATION, undefined, useRafs);\r\n      }\r\n    };\r\n\r\n    ButtonMenuToggle({\r\n      noRipple: true, \r\n      listenerSetter: this.listenerSetter, \r\n      container: this.container\r\n    }, 'top-right', sendAsButtons, () => {\r\n      onSendAsMenuToggle(true);\r\n    }, () => {\r\n      onSendAsMenuToggle(false);\r\n    });\r\n\r\n    sendAsButtons[0].element.classList.add('btn-menu-item-header');\r\n    this.btnMenu = this.container.firstElementChild as any;\r\n    this.btnMenu.classList.add('scrollable', 'scrollable-y');\r\n    this.container.append(this.closeBtn);\r\n  }\r\n\r\n  private async updateButtons(peerIds: PeerId[]) {\r\n    const promises: Promise<ButtonMenuItemOptions>[] = peerIds.map(async(sendAsPeerId, idx) => {\r\n      const textElement = document.createElement('div');\r\n\r\n      const subtitle = document.createElement('div');\r\n      subtitle.classList.add('btn-menu-item-subtitle');\r\n      if(sendAsPeerId.isUser()) {\r\n        subtitle.append(i18n('Chat.SendAs.PersonalAccount'));\r\n      } else if(sendAsPeerId === this.peerId) {\r\n        subtitle.append(i18n('VoiceChat.DiscussionGroup'));\r\n      } else {\r\n        subtitle.append(await getChatMembersString(sendAsPeerId.toChatId()));\r\n      }\r\n\r\n      textElement.append(\r\n        new PeerTitle({peerId: sendAsPeerId}).element,\r\n        subtitle\r\n      );\r\n\r\n      return {\r\n        onClick: idx ? async() => {\r\n          const currentPeerId = this.peerId;\r\n          this.changeSendAsPeerId(sendAsPeerId);\r\n\r\n          const middleware = this.middleware.get();\r\n          const executeButtonsUpdate = () => {\r\n            if(this.sendAsPeerId !== sendAsPeerId || !middleware()) return;\r\n            const peerIds = this.sendAsPeerIds.slice();\r\n            indexOfAndSplice(peerIds, sendAsPeerId);\r\n            peerIds.unshift(sendAsPeerId);\r\n            this.updateButtons(peerIds);\r\n          };\r\n          \r\n          if(rootScope.settings.animationsEnabled) {\r\n            setTimeout(executeButtonsUpdate, 250);\r\n          } else {\r\n            executeButtonsUpdate();\r\n          }\r\n\r\n          // return;\r\n          this.managers.appMessagesManager.saveDefaultSendAs(currentPeerId, sendAsPeerId);\r\n        } : undefined,\r\n        textElement\r\n      };\r\n    });\r\n\r\n    const buttons = await Promise.all(promises);\r\n    const btnMenu = ButtonMenu(buttons/* , this.listenerSetter */);\r\n    buttons.forEach((button, idx) => {\r\n      const peerId = peerIds[idx];\r\n      const avatar = new AvatarElement();\r\n      avatar.classList.add('avatar-26', 'btn-menu-item-icon');\r\n      avatar.updateWithOptions({peerId});\r\n\r\n      if(!idx) {\r\n        avatar.classList.add('active');\r\n      }\r\n      \r\n      button.element.prepend(avatar);\r\n    });\r\n\r\n    Array.from(this.btnMenu.children).slice(1).forEach((node) => node.remove());\r\n    this.btnMenu.append(...Array.from(btnMenu.children));\r\n  }\r\n\r\n  private async updateAvatar(sendAsPeerId: PeerId, skipAnimation?: boolean) {\r\n    const previousAvatar = this.avatar;\r\n    if(previousAvatar) {\r\n      if(previousAvatar.peerId === sendAsPeerId) {\r\n        return;\r\n      }\r\n    }\r\n    \r\n    if(!previousAvatar) {\r\n      skipAnimation = true;\r\n    }\r\n    \r\n    let useRafs = skipAnimation ? 0 : 2;\r\n    const duration = skipAnimation ? 0 : SEND_AS_ANIMATION_DURATION;\r\n    const avatar = this.avatar = new AvatarElement();\r\n    avatar.classList.add('new-message-send-as-avatar', 'avatar-30');\r\n    await avatar.updateWithOptions({\r\n      isDialog: false,\r\n      peerId: sendAsPeerId\r\n    });\r\n\r\n    SetTransition(avatar, 'is-visible', true, duration, undefined, useRafs);    \r\n    if(previousAvatar) {\r\n      SetTransition(previousAvatar, 'is-visible', false, duration, () => {\r\n        previousAvatar.remove();\r\n      }, useRafs);\r\n    }\r\n    \r\n    this.container.append(avatar);\r\n  }\r\n\r\n  private changeSendAsPeerId(sendAsPeerId: PeerId, skipAnimation?: boolean) {\r\n    this.sendAsPeerId = sendAsPeerId;\r\n    this.onChange(sendAsPeerId);\r\n    return this.updateAvatar(sendAsPeerId, skipAnimation);\r\n  }\r\n\r\n  private getDefaultSendAs(): Promise<AckedResult<PeerId>> {\r\n    // return rootScope.myId;\r\n    return this.managers.acknowledged.appProfileManager.getChannelFull(this.peerId.toChatId()).then((acked) => {\r\n      return {\r\n        cached: acked.cached,\r\n        result: acked.result.then((channelFull) => {\r\n          return channelFull.default_send_as ? getPeerId(channelFull.default_send_as) : undefined\r\n        })\r\n      };\r\n    });\r\n  }\r\n  \r\n  public async updateManual(skipAnimation?: boolean): Promise<() => void> {\r\n    const peerId = this.peerId;\r\n    if(this.updatingPromise || !(await this.managers.appPeersManager.isChannel(peerId))) {\r\n      return;\r\n    }\r\n\r\n    const middleware = this.middleware.get(() => {\r\n      return !this.updatingPromise || this.updatingPromise === updatingPromise;\r\n    });\r\n\r\n    const {container} = this;\r\n    const chatId = peerId.toChatId();\r\n    const result = (await modifyAckedPromise(this.getDefaultSendAs())).result;\r\n    // const result = Promise.resolve(this.getDefaultSendAs());\r\n\r\n    const wasSkippingAnimation = skipAnimation;\r\n    if(result instanceof Promise) {\r\n      skipAnimation = undefined;\r\n    }\r\n\r\n    const auto = wasSkippingAnimation && !skipAnimation;\r\n\r\n    const updatingPromise = this.updatingPromise = callbackify(result, async(sendAsPeerId) => {\r\n      if(!middleware() || sendAsPeerId === undefined) return;\r\n      \r\n      await this.changeSendAsPeerId(sendAsPeerId, skipAnimation);\r\n      if(!middleware()) return;\r\n\r\n      this.managers.appChatsManager.getSendAs(chatId).then((peers) => {\r\n        if(!middleware()) return;\r\n\r\n        const peerIds = peers.map((peer) => getPeerId(peer));\r\n        this.sendAsPeerIds = peerIds.slice();\r\n\r\n        indexOfAndSplice(peerIds, sendAsPeerId);\r\n        peerIds.unshift(sendAsPeerId);\r\n        this.updateButtons(peerIds);\r\n      });\r\n\r\n      const callback = () => {\r\n        this.onReady(container, skipAnimation);\r\n\r\n        if(!this.addedListener) {\r\n          this.listenerSetter.add(rootScope)('peer_full_update', (peerId) => {\r\n            if(this.peerId === peerId) {\r\n              this.update();\r\n            }\r\n          });\r\n\r\n          this.addedListener = true;\r\n        }\r\n      };\r\n\r\n      if(auto) {\r\n        callback();\r\n        return;\r\n      }\r\n\r\n      return callback;\r\n    });\r\n\r\n    updatingPromise.finally(() => {\r\n      if(this.updatingPromise === updatingPromise) {\r\n        this.updatingPromise = undefined;\r\n      }\r\n    });\r\n\r\n    if(!auto) {\r\n      return updatingPromise;\r\n    }\r\n  }\r\n\r\n  public update(skipAnimation?: boolean) {\r\n    return this.updateManual(skipAnimation).then((callback) => callback && callback());\r\n  }\r\n\r\n  public setPeerId(peerId?: PeerId) {\r\n    /* if(this.avatar) {\r\n      this.avatar.remove();\r\n      this.avatar = undefined;\r\n    } */\r\n\r\n    this.middleware.clean();\r\n    this.updatingPromise = undefined;\r\n    this.peerId = peerId;\r\n  }\r\n\r\n  public destroy() {\r\n    this.container.remove();\r\n    this.setPeerId();\r\n    this.listenerSetter.removeAll();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type { AppImManager } from '../../lib/appManagers/appImManager';\r\nimport type { MyDraftMessage } from '../../lib/appManagers/appDraftsManager';\r\nimport type Chat from './chat';\r\nimport Recorder from '../../../public/recorder.min';\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\n//import Recorder from '../opus-recorder/dist/recorder.min';\r\nimport opusDecodeController from \"../../lib/opusDecodeController\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from '../buttonMenu';\r\nimport emoticonsDropdown from \"../emoticonsDropdown\";\r\nimport PopupCreatePoll from \"../popups/createPoll\";\r\nimport PopupForward from '../popups/forward';\r\nimport PopupNewMedia from '../popups/newMedia';\r\nimport { toast } from \"../toast\";\r\nimport { wrapReply } from \"../wrappers\";\r\nimport InputField from '../inputField';\r\nimport { MessageEntity, DraftMessage, WebPage, Message, ChatFull, UserFull } from '../../layer';\r\nimport StickersHelper from './stickersHelper';\r\nimport ButtonIcon from '../buttonIcon';\r\nimport ButtonMenuToggle from '../buttonMenuToggle';\r\nimport ListenerSetter, { Listener } from '../../helpers/listenerSetter';\r\nimport Button from '../button';\r\nimport PopupSchedule from '../popups/schedule';\r\nimport SendMenu from './sendContextMenu';\r\nimport rootScope from '../../lib/rootScope';\r\nimport PopupPinMessage from '../popups/unpinMessage';\r\nimport tsNow from '../../helpers/tsNow';\r\nimport appNavigationController, { NavigationItem } from '../appNavigationController';\r\nimport { IS_MOBILE, IS_MOBILE_SAFARI } from '../../environment/userAgent';\r\nimport I18n, { i18n, join, LangPackKey } from '../../lib/langPack';\r\nimport { generateTail } from './bubbles';\r\nimport findUpClassName from '../../helpers/dom/findUpClassName';\r\nimport ButtonCorner from '../buttonCorner';\r\nimport blurActiveElement from '../../helpers/dom/blurActiveElement';\r\nimport cancelEvent from '../../helpers/dom/cancelEvent';\r\nimport cancelSelection from '../../helpers/dom/cancelSelection';\r\nimport { attachClickEvent, simulateClickEvent } from '../../helpers/dom/clickEvent';\r\nimport getRichValue from '../../helpers/dom/getRichValue';\r\nimport isInputEmpty from '../../helpers/dom/isInputEmpty';\r\nimport isSendShortcutPressed from '../../helpers/dom/isSendShortcutPressed';\r\nimport placeCaretAtEnd from '../../helpers/dom/placeCaretAtEnd';\r\nimport { MarkdownType, markdownTags } from '../../helpers/dom/getRichElementValue';\r\nimport getRichValueWithCaret from '../../helpers/dom/getRichValueWithCaret';\r\nimport EmojiHelper from './emojiHelper';\r\nimport CommandsHelper from './commandsHelper';\r\nimport AutocompleteHelperController from './autocompleteHelperController';\r\nimport AutocompleteHelper from './autocompleteHelper';\r\nimport MentionsHelper from './mentionsHelper';\r\nimport fixSafariStickyInput from '../../helpers/dom/fixSafariStickyInput';\r\nimport ReplyKeyboard from './replyKeyboard';\r\nimport InlineHelper from './inlineHelper';\r\nimport debounce from '../../helpers/schedulers/debounce';\r\nimport noop from '../../helpers/noop';\r\nimport { putPreloader } from '../putPreloader';\r\nimport SetTransition from '../singleTransition';\r\nimport PeerTitle from '../peerTitle';\r\nimport { fastRaf } from '../../helpers/schedulers';\r\nimport PopupDeleteMessages from '../popups/deleteMessages';\r\nimport fixSafariStickyInputFocusing, { IS_STICKY_INPUT_BUGGED } from '../../helpers/dom/fixSafariStickyInputFocusing';\r\nimport PopupPeer from '../popups/peer';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport appMediaPlaybackController from '../appMediaPlaybackController';\r\nimport { BOT_START_PARAM, NULL_PEER_ID } from '../../lib/mtproto/mtproto_config';\r\nimport setCaretAt from '../../helpers/dom/setCaretAt';\r\nimport CheckboxField from '../checkboxField';\r\nimport DropdownHover from '../../helpers/dropdownHover';\r\nimport RadioForm from '../radioForm';\r\nimport findUpTag from '../../helpers/dom/findUpTag';\r\nimport toggleDisability from '../../helpers/dom/toggleDisability';\r\nimport callbackify from '../../helpers/callbackify';\r\nimport ChatBotCommands from './botCommands';\r\nimport copy from '../../helpers/object/copy';\r\nimport toHHMMSS from '../../helpers/string/toHHMMSS';\r\nimport documentFragmentToHTML from '../../helpers/dom/documentFragmentToHTML';\r\nimport PopupElement from '../popups';\r\nimport getEmojiEntityFromEmoji from '../../lib/richTextProcessor/getEmojiEntityFromEmoji';\r\nimport mergeEntities from '../../lib/richTextProcessor/mergeEntities';\r\nimport parseEntities from '../../lib/richTextProcessor/parseEntities';\r\nimport parseMarkdown from '../../lib/richTextProcessor/parseMarkdown';\r\nimport wrapDraftText from '../../lib/richTextProcessor/wrapDraftText';\r\nimport wrapDraft from '../wrappers/draft';\r\nimport wrapMessageForReply from '../wrappers/messageForReply';\r\nimport getServerMessageId from '../../lib/appManagers/utils/messageId/getServerMessageId';\r\nimport { AppManagers } from '../../lib/appManagers/managers';\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { emojiFromCodePoints } from \"../../vendor/emoji\";\r\nimport { modifyAckedPromise } from \"../../helpers/modifyAckedResult\";\r\nimport ChatSendAs from \"./sendAs\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\n\r\nconst RECORD_MIN_TIME = 500;\r\nconst POSTING_MEDIA_NOT_ALLOWED = 'Posting media content isn\\'t allowed in this group.';\r\n\r\ntype ChatInputHelperType = 'edit' | 'webpage' | 'forward' | 'reply';\r\n\r\nexport default class ChatInput {\r\n  // private static AUTO_COMPLETE_REG_EXP = /(\\s|^)((?::|.)(?!.*[:@]).*|(?:[@\\/]\\S*))$/;\r\n  private static AUTO_COMPLETE_REG_EXP = /(\\s|^)((?:(?:@|^\\/)\\S*)|(?::|^[^:@\\/])(?!.*[:@\\/]).*)$/;\r\n  public messageInput: HTMLElement;\r\n  public messageInputField: InputField;\r\n  private fileInput: HTMLInputElement;\r\n  private inputMessageContainer: HTMLDivElement;\r\n  private btnSend: HTMLButtonElement;\r\n  private btnCancelRecord: HTMLButtonElement;\r\n  private lastUrl = '';\r\n  private lastTimeType = 0;\r\n\r\n  public chatInput: HTMLElement;\r\n  public inputContainer: HTMLElement;\r\n  public rowsWrapper: HTMLDivElement;\r\n  private newMessageWrapper: HTMLDivElement;\r\n  private btnToggleEmoticons: HTMLButtonElement;\r\n  private btnToggleReplyMarkup: HTMLButtonElement;\r\n  private btnSendContainer: HTMLDivElement;\r\n\r\n  private replyKeyboard: ReplyKeyboard;\r\n\r\n  private attachMenu: HTMLElement;\r\n  private attachMenuButtons: (ButtonMenuItemOptions & {verify: (peerId: PeerId, threadId: number) => boolean | Promise<boolean>})[];\r\n\r\n  private sendMenu: SendMenu;\r\n\r\n  private replyElements: {\r\n    container: HTMLElement,\r\n    cancelBtn: HTMLButtonElement,\r\n    iconBtn: HTMLButtonElement\r\n  } = {} as any;\r\n\r\n  private forwardElements: {\r\n    changePeer: ButtonMenuItemOptions,\r\n    showSender: ButtonMenuItemOptions,\r\n    hideSender: ButtonMenuItemOptions,\r\n    showCaption: ButtonMenuItemOptions,\r\n    hideCaption: ButtonMenuItemOptions,\r\n    container: HTMLElement,\r\n    modifyArgs?: ButtonMenuItemOptions[]\r\n  };  \r\n  private forwardHover: DropdownHover;\r\n  private forwardWasDroppingAuthor: boolean;\r\n\r\n  private getWebPagePromise: Promise<void>;\r\n  private willSendWebPage: WebPage = null;\r\n  private forwarding: {[fromPeerId: PeerId]: number[]};\r\n  public replyToMsgId: number;\r\n  public editMsgId: number;\r\n  public editMessage: Message.message;\r\n  private noWebPage: true;\r\n  public scheduleDate: number;\r\n  public sendSilent: true;\r\n  public startParam: string;\r\n\r\n  private recorder: any;\r\n  public recording = false;\r\n  private recordCanceled = false;\r\n  private recordTimeEl: HTMLElement;\r\n  private recordRippleEl: HTMLElement;\r\n  private recordStartTime = 0;\r\n  private recordingOverlayListener: Listener;\r\n  private recordingNavigationItem: NavigationItem;\r\n\r\n  // private scrollTop = 0;\r\n  // private scrollOffsetTop = 0;\r\n  // private scrollDiff = 0;\r\n\r\n  public helperType: Exclude<ChatInputHelperType, 'webpage'>;\r\n  private helperFunc: () => void | Promise<void>;\r\n  private helperWaitingForward: boolean;\r\n\r\n  public willAttachType: 'document' | 'media';\r\n\r\n  private lockRedo = false;\r\n  private canRedoFromHTML = '';\r\n  private readonly undoHistory: string[] = [];\r\n  private readonly executedHistory: string[] = [];\r\n  private canUndoFromHTML = '';\r\n\r\n  private autocompleteHelperController: AutocompleteHelperController;\r\n  private stickersHelper: StickersHelper;\r\n  private emojiHelper: EmojiHelper;\r\n  private commandsHelper: CommandsHelper;\r\n  private mentionsHelper: MentionsHelper;\r\n  private inlineHelper: InlineHelper;\r\n  private listenerSetter: ListenerSetter;\r\n\r\n  private pinnedControlBtn: HTMLButtonElement;\r\n\r\n  private goDownBtn: HTMLButtonElement;\r\n  private goDownUnreadBadge: HTMLElement;\r\n  private goMentionBtn: HTMLButtonElement;\r\n  private goMentionUnreadBadge: HTMLSpanElement;\r\n  private btnScheduled: HTMLButtonElement;\r\n\r\n  private btnPreloader: HTMLButtonElement;\r\n\r\n  private saveDraftDebounced: () => void;\r\n\r\n  private fakeRowsWrapper: HTMLDivElement;\r\n\r\n  private previousQuery: string;\r\n  \r\n  private releaseMediaPlayback: () => void;\r\n\r\n  private botStartBtn: HTMLButtonElement;\r\n  private rowsWrapperWrapper: HTMLDivElement;\r\n  private controlContainer: HTMLElement;\r\n  private fakeSelectionWrapper: HTMLDivElement;\r\n\r\n  private fakeWrapperTo: HTMLElement;\r\n  private toggleBotStartBtnDisability: () => void;\r\n\r\n  private botCommandsToggle: HTMLElement;\r\n  private botCommands: ChatBotCommands;\r\n  private botCommandsIcon: HTMLDivElement;\r\n  private hasBotCommands: boolean;\r\n\r\n  // private activeContainer: HTMLElement;\r\n\r\n  private sendAs: ChatSendAs;\r\n  public sendAsPeerId: PeerId;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private appImManager: AppImManager, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n  }\r\n\r\n  public construct() {\r\n    this.chatInput = document.createElement('div');\r\n    this.chatInput.classList.add('chat-input', 'hide');\r\n\r\n    this.inputContainer = document.createElement('div');\r\n    this.inputContainer.classList.add('chat-input-container');\r\n\r\n    this.rowsWrapperWrapper = document.createElement('div');\r\n    this.rowsWrapperWrapper.classList.add('rows-wrapper-wrapper');\r\n\r\n    this.rowsWrapper = document.createElement('div');\r\n    this.rowsWrapper.classList.add('rows-wrapper', 'chat-input-wrapper');\r\n\r\n    this.rowsWrapperWrapper.append(this.rowsWrapper);\r\n\r\n    const tail = generateTail();\r\n    this.rowsWrapper.append(tail);\r\n\r\n    const fakeRowsWrapper = this.fakeRowsWrapper = document.createElement('div');\r\n    fakeRowsWrapper.classList.add('fake-wrapper', 'fake-rows-wrapper');\r\n\r\n    const fakeSelectionWrapper = this.fakeSelectionWrapper = document.createElement('div');\r\n    fakeSelectionWrapper.classList.add('fake-wrapper', 'fake-selection-wrapper');\r\n\r\n    this.inputContainer.append(this.rowsWrapperWrapper, fakeRowsWrapper, fakeSelectionWrapper);\r\n    this.chatInput.append(this.inputContainer);\r\n\r\n    this.goDownBtn = ButtonCorner({icon: 'arrow_down', className: 'bubbles-corner-button bubbles-go-down hide'});\r\n    this.inputContainer.append(this.goDownBtn);\r\n\r\n    attachClickEvent(this.goDownBtn, (e) => {\r\n      cancelEvent(e);\r\n      this.chat.bubbles.onGoDownClick();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    // * constructor end\r\n\r\n    /* let setScrollTopTimeout: number;\r\n    // @ts-ignore\r\n    let height = window.visualViewport.height; */\r\n    // @ts-ignore\r\n    // this.listenerSetter.add(window.visualViewport)('resize', () => {\r\n    //   const scrollable = this.chat.bubbles.scrollable;\r\n    //   const wasScrolledDown = scrollable.isScrolledDown;\r\n      \r\n    //   /* if(wasScrolledDown) {\r\n    //     this.saveScroll();\r\n    //   } */\r\n      \r\n    //   // @ts-ignore\r\n    //   let newHeight = window.visualViewport.height;\r\n    //   const diff = height - newHeight;\r\n    //   const scrollTop = scrollable.scrollTop;\r\n    //   const needScrollTop = wasScrolledDown ? scrollable.scrollHeight : scrollTop + diff; // * wasScrolledDown это проверка для десктоп хрома, когда пропадает панель загрузок снизу\r\n\r\n    //   console.log('resize before', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, wasScrolledDown, scrollable.lastScrollTop, diff, needScrollTop);\r\n\r\n    //   scrollable.scrollTop = needScrollTop;\r\n\r\n    //   if(setScrollTopTimeout) clearTimeout(setScrollTopTimeout);\r\n    //   setScrollTopTimeout = window.setTimeout(() => {\r\n    //     const diff = height - newHeight;\r\n    //     const isScrolledDown = scrollable.scrollHeight - Math.round(scrollable.scrollTop + scrollable.container.offsetHeight + diff) <= 1;\r\n    //     height = newHeight;\r\n\r\n    //     scrollable.scrollTop = needScrollTop;\r\n        \r\n    //     console.log('resize after', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, scrollable.isScrolledDown, scrollable.lastScrollTop, isScrolledDown);\r\n\r\n    //     /* if(isScrolledDown) {\r\n    //       scrollable.scrollTop = scrollable.scrollHeight;\r\n    //     } */\r\n\r\n    //     //scrollable.scrollTop += diff;\r\n    //     setScrollTopTimeout = 0;\r\n    //   }, 0);\r\n    // });\r\n\r\n    // ! Can't use it with resizeObserver\r\n    /* this.listenerSetter.add(window.visualViewport)('resize', () => {\r\n      const scrollable = this.chat.bubbles.scrollable;\r\n      const wasScrolledDown = scrollable.isScrolledDown;\r\n\r\n      // @ts-ignore\r\n      let newHeight = window.visualViewport.height;\r\n      const diff = height - newHeight;\r\n      const needScrollTop = wasScrolledDown ? scrollable.scrollHeight : scrollable.scrollTop + diff; // * wasScrolledDown это проверка для десктоп хрома, когда пропадает панель загрузок снизу\r\n\r\n      //console.log('resize before', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, wasScrolledDown, scrollable.lastScrollTop, diff, needScrollTop);\r\n\r\n      scrollable.scrollTop = needScrollTop;\r\n      height = newHeight;\r\n\r\n      if(setScrollTopTimeout) clearTimeout(setScrollTopTimeout);\r\n      setScrollTopTimeout = window.setTimeout(() => { // * try again for scrolled down Android Chrome\r\n        scrollable.scrollTop = needScrollTop;\r\n        \r\n        //console.log('resize after', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, scrollable.isScrolledDown, scrollable.lastScrollTop, isScrolledDown);\r\n        setScrollTopTimeout = 0;\r\n      }, 0);\r\n    }); */\r\n\r\n    const c = this.controlContainer = document.createElement('div');\r\n    c.classList.add('chat-input-control', 'chat-input-wrapper');\r\n    this.inputContainer.append(c);\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    this.replyElements.container = document.createElement('div');\r\n    this.replyElements.container.classList.add('reply-wrapper');\r\n\r\n    this.replyElements.iconBtn = ButtonIcon('');\r\n    this.replyElements.cancelBtn = ButtonIcon('close reply-cancel', {noRipple: true});\r\n\r\n    this.replyElements.container.append(this.replyElements.iconBtn, this.replyElements.cancelBtn);\r\n\r\n    //\r\n\r\n    const onHideAuthorClick = () => {\r\n      isChangingAuthor = true;\r\n      return this.canToggleHideAuthor();\r\n    };\r\n\r\n    const onHideCaptionClick = () => {\r\n      isChangingAuthor = false;\r\n    };\r\n\r\n    const forwardElements: ChatInput['forwardElements'] = this.forwardElements = {} as any;\r\n    let isChangingAuthor = false;\r\n    const forwardButtons: ButtonMenuItemOptions[] = [\r\n      forwardElements.showSender = {\r\n        text: 'Chat.Alert.Forward.Action.Show1',\r\n        onClick: onHideAuthorClick,\r\n        checkboxField: new CheckboxField({checked: true})\r\n      },\r\n      forwardElements.hideSender = {\r\n        text: 'Chat.Alert.Forward.Action.Hide1',\r\n        onClick: onHideAuthorClick,\r\n        checkboxField: new CheckboxField({checked: false})\r\n      },\r\n      forwardElements.showCaption = {\r\n        text: 'Chat.Alert.Forward.Action.ShowCaption',\r\n        onClick: onHideCaptionClick,\r\n        checkboxField: new CheckboxField({checked: true})\r\n      },\r\n      forwardElements.hideCaption = {\r\n        text: 'Chat.Alert.Forward.Action.HideCaption',\r\n        onClick: onHideCaptionClick,\r\n        checkboxField: new CheckboxField({checked: false})\r\n      },\r\n      forwardElements.changePeer = {\r\n        text: 'Chat.Alert.Forward.Action.Another',\r\n        onClick: () => {\r\n          this.changeForwardRecipient();\r\n        },\r\n        icon: 'replace'\r\n      }\r\n    ];\r\n    const forwardBtnMenu = forwardElements.container = ButtonMenu(forwardButtons, this.listenerSetter);\r\n    // forwardBtnMenu.classList.add('top-center');\r\n\r\n    const children = Array.from(forwardBtnMenu.children) as HTMLElement[];\r\n    const groups: {\r\n      elements: HTMLElement[],\r\n      onChange: (value: string, event: Event) => void\r\n    }[] = [{\r\n      elements: children.slice(0, 2),\r\n      onChange: (value, e) => {\r\n        const checked = !!+value;\r\n        if(isChangingAuthor) {\r\n          this.forwardWasDroppingAuthor = !checked;\r\n        }\r\n\r\n        const replyTitle = this.replyElements.container.querySelector('.reply-title');\r\n        if(replyTitle) {\r\n          const el = replyTitle.firstElementChild as HTMLElement;\r\n          const i = I18n.weakMap.get(el) as I18n.IntlElement;\r\n          const langPackKey: LangPackKey = forwardElements.showSender.checkboxField.checked ? 'Chat.Accessory.Forward' : 'Chat.Accessory.Hidden';\r\n          i.key = langPackKey;\r\n          i.update();\r\n        }\r\n      }\r\n    }, {\r\n      elements: children.slice(2, 4),\r\n      onChange: (value) => {\r\n        const checked = !!+value;\r\n        let b: ButtonMenuItemOptions;\r\n        if(checked && this.forwardWasDroppingAuthor !== undefined) {\r\n          b = this.forwardWasDroppingAuthor ? forwardElements.hideSender : forwardElements.showSender;\r\n        } else {\r\n          b = checked ? forwardElements.showSender : forwardElements.hideSender;\r\n        }\r\n\r\n        b.checkboxField.checked = true;\r\n      }\r\n    }];\r\n    groups.forEach((group) => {\r\n      const container = RadioForm(group.elements.map((e) => {\r\n        return {\r\n          container: e, \r\n          input: e.querySelector('input')\r\n        };\r\n      }), group.onChange);\r\n\r\n      const hr = document.createElement('hr');\r\n      container.append(hr);\r\n      forwardBtnMenu.append(container);\r\n    });\r\n\r\n    forwardBtnMenu.append(forwardElements.changePeer.element);\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      const forwardHover = this.forwardHover = new DropdownHover({\r\n        element: forwardBtnMenu\r\n      });\r\n    }\r\n\r\n    forwardElements.modifyArgs = forwardButtons.slice(0, -1);\r\n    this.replyElements.container.append(forwardBtnMenu);\r\n\r\n    forwardElements.modifyArgs.forEach((b, idx) => {\r\n      const {input} = b.checkboxField;\r\n      input.type = 'radio';\r\n      input.name = idx < 2 ? 'author' : 'caption';\r\n      input.value = '' + +!(idx % 2);\r\n    });\r\n\r\n    //\r\n\r\n    this.newMessageWrapper = document.createElement('div');\r\n    this.newMessageWrapper.classList.add('new-message-wrapper');\r\n\r\n    this.btnToggleEmoticons = ButtonIcon('none toggle-emoticons', {noRipple: true});\r\n\r\n    this.inputMessageContainer = document.createElement('div');\r\n    this.inputMessageContainer.classList.add('input-message-container');\r\n\r\n    if(this.chat.type === 'chat') {\r\n      this.goDownUnreadBadge = document.createElement('span');\r\n      this.goDownUnreadBadge.classList.add('badge', 'badge-24', 'badge-primary');\r\n      this.goDownBtn.append(this.goDownUnreadBadge);\r\n\r\n      this.goMentionBtn = ButtonCorner({icon: 'mention', className: 'bubbles-corner-button bubbles-go-mention'});\r\n      this.goMentionUnreadBadge = document.createElement('span');\r\n      this.goMentionUnreadBadge.classList.add('badge', 'badge-24', 'badge-primary');\r\n      this.goMentionBtn.append(this.goMentionUnreadBadge);\r\n      this.inputContainer.append(this.goMentionBtn);\r\n\r\n      attachClickEvent(this.goMentionBtn, (e) => {\r\n        cancelEvent(e);\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        this.managers.appMessagesManager.goToNextMention(this.chat.peerId).then((mid) => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n          \r\n          if(mid) {\r\n            this.chat.setMessageId(mid);\r\n          }\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.btnScheduled = ButtonIcon('scheduled btn-scheduled float hide', {noRipple: true});\r\n\r\n      attachClickEvent(this.btnScheduled, (e) => {\r\n        this.appImManager.openScheduled(this.chat.peerId);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.listenerSetter.add(rootScope)('scheduled_new', ({peerId}) => {\r\n        if(this.chat.peerId !== peerId) {\r\n          return;\r\n        }\r\n\r\n        this.btnScheduled.classList.remove('hide');\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId}) => {\r\n        if(this.chat.peerId !== peerId) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appMessagesManager.getScheduledMessages(this.chat.peerId).then((value) => {\r\n          this.btnScheduled.classList.toggle('hide', !value.length);\r\n        });\r\n      });\r\n\r\n      this.btnToggleReplyMarkup = ButtonIcon('botcom toggle-reply-markup float hide', {noRipple: true});\r\n      this.replyKeyboard = new ReplyKeyboard({\r\n        appendTo: this.rowsWrapper,\r\n        listenerSetter: this.listenerSetter,\r\n        managers: this.managers,\r\n        btnHover: this.btnToggleReplyMarkup,\r\n        chatInput: this\r\n      });\r\n      this.listenerSetter.add(this.replyKeyboard)('open', () => this.btnToggleReplyMarkup.classList.add('active'));\r\n      this.listenerSetter.add(this.replyKeyboard)('close', () => this.btnToggleReplyMarkup.classList.remove('active'));\r\n\r\n      this.botCommands = new ChatBotCommands(this.rowsWrapper, this, this.managers);\r\n      this.botCommandsToggle = document.createElement('div');\r\n      this.botCommandsToggle.classList.add('new-message-bot-commands');\r\n\r\n      const scaler = document.createElement('div');\r\n      scaler.classList.add('new-message-bot-commands-icon-scale');\r\n\r\n      const icon = this.botCommandsIcon = document.createElement('div');\r\n      icon.classList.add('animated-menu-icon', 'animated-menu-close-icon');\r\n      scaler.append(icon);\r\n      this.botCommandsToggle.append(scaler);\r\n\r\n      attachClickEvent(this.botCommandsToggle, (e) => {\r\n        cancelEvent(e);\r\n        const isShown = icon.classList.contains('state-back');\r\n        if(isShown) {\r\n          this.botCommands.toggle(true);\r\n          icon.classList.remove('state-back');\r\n        } else {\r\n          this.botCommands.setUserId(this.chat.peerId.toUserId(), this.chat.bubbles.getMiddleware());\r\n          icon.classList.add('state-back');\r\n        }\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.botCommands.addEventListener('visible', () => {\r\n        icon.classList.add('state-back');\r\n      });\r\n\r\n      this.botCommands.addEventListener('hiding', () => {\r\n        icon.classList.remove('state-back');\r\n      });\r\n    }\r\n\r\n    this.attachMenuButtons = [{\r\n      icon: 'image',\r\n      text: 'Chat.Input.Attach.PhotoOrVideo',\r\n      onClick: () => {\r\n        this.fileInput.value = '';\r\n        const accept = [...MEDIA_MIME_TYPES_SUPPORTED].join(', ');\r\n        this.fileInput.setAttribute('accept', accept);\r\n        this.willAttachType = 'media';\r\n        this.fileInput.click();\r\n      },\r\n      verify: () => this.chat.canSend('send_media')\r\n    }, {\r\n      icon: 'document',\r\n      text: 'Chat.Input.Attach.Document',\r\n      onClick: () => {\r\n        this.fileInput.value = '';\r\n        this.fileInput.removeAttribute('accept');\r\n        this.willAttachType = 'document';\r\n        this.fileInput.click();\r\n      },\r\n      verify: () => this.chat.canSend('send_media')\r\n    }, {\r\n      icon: 'poll',\r\n      text: 'Poll',\r\n      onClick: () => {\r\n        PopupElement.createPopup(PopupCreatePoll, this.chat).show();\r\n      },\r\n      verify: (peerId) => peerId.isAnyChat() && this.chat.canSend('send_polls')\r\n    }];\r\n\r\n    this.attachMenu = ButtonMenuToggle({noRipple: true, listenerSetter: this.listenerSetter}, 'top-left', this.attachMenuButtons);\r\n    this.attachMenu.classList.add('attach-file', 'tgico-attach');\r\n    this.attachMenu.classList.remove('tgico-more');\r\n\r\n    //this.inputContainer.append(this.sendMenu);\r\n\r\n    this.recordTimeEl = document.createElement('div');\r\n    this.recordTimeEl.classList.add('record-time');\r\n\r\n    this.fileInput = document.createElement('input');\r\n    this.fileInput.type = 'file';\r\n    this.fileInput.multiple = true;\r\n    this.fileInput.style.display = 'none';\r\n\r\n    this.newMessageWrapper.append(...[this.botCommandsToggle, this.btnToggleEmoticons, this.inputMessageContainer, this.btnScheduled, this.btnToggleReplyMarkup, this.attachMenu, this.recordTimeEl, this.fileInput].filter(Boolean));\r\n\r\n    this.rowsWrapper.append(this.replyElements.container);\r\n    this.autocompleteHelperController = new AutocompleteHelperController();\r\n    this.stickersHelper = new StickersHelper(this.rowsWrapper, this.autocompleteHelperController, this.managers);\r\n    this.emojiHelper = new EmojiHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.commandsHelper = new CommandsHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.mentionsHelper = new MentionsHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.inlineHelper = new InlineHelper(this.rowsWrapper, this.autocompleteHelperController, this.chat, this.managers);\r\n    this.rowsWrapper.append(this.newMessageWrapper);\r\n\r\n    this.btnCancelRecord = ButtonIcon('delete btn-circle z-depth-1 btn-record-cancel');\r\n\r\n    this.btnSendContainer = document.createElement('div');\r\n    this.btnSendContainer.classList.add('btn-send-container');\r\n\r\n    this.recordRippleEl = document.createElement('div');\r\n    this.recordRippleEl.classList.add('record-ripple');\r\n\r\n    this.btnSend = ButtonIcon('none btn-circle z-depth-1 btn-send animated-button-icon');\r\n    this.btnSend.insertAdjacentHTML('afterbegin', `\r\n    <span class=\"tgico tgico-send\"></span>\r\n    <span class=\"tgico tgico-schedule\"></span>\r\n    <span class=\"tgico tgico-check\"></span>\r\n    <span class=\"tgico tgico-microphone_filled\"></span>\r\n    `);\r\n\r\n    this.btnSendContainer.append(this.recordRippleEl, this.btnSend);\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      this.sendMenu = new SendMenu({\r\n        onSilentClick: () => {\r\n          this.sendSilent = true;\r\n          this.sendMessage();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.scheduleSending(undefined);\r\n        },\r\n        listenerSetter: this.listenerSetter,\r\n        openSide: 'top-left',\r\n        onContextElement: this.btnSend,\r\n        onOpen: () => {\r\n          return !this.isInputEmpty() || !!Object.keys(this.forwarding).length;\r\n        }\r\n      });\r\n      \r\n      this.btnSendContainer.append(this.sendMenu.sendMenu);\r\n    }\r\n\r\n    this.inputContainer.append(this.btnCancelRecord, this.btnSendContainer);\r\n\r\n    emoticonsDropdown.attachButtonListener(this.btnToggleEmoticons, this.listenerSetter);\r\n    this.listenerSetter.add(emoticonsDropdown)('open', this.onEmoticonsOpen);\r\n    this.listenerSetter.add(emoticonsDropdown)('close', this.onEmoticonsClose);\r\n\r\n    this.attachMessageInputField();\r\n\r\n    /* this.attachMenu.addEventListener('mousedown', (e) => {\r\n      const hidden = this.attachMenu.querySelectorAll('.hide');\r\n      if(hidden.length === this.attachMenuButtons.length) {\r\n        toast(POSTING_MEDIA_NOT_ALLOWED);\r\n        cancelEvent(e);\r\n        return false;\r\n      }\r\n    }, {passive: false, capture: true}); */\r\n\r\n    this.listenerSetter.add(rootScope)('settings_updated', () => {\r\n      if(this.stickersHelper || this.emojiHelper) {\r\n        // this.previousQuery = undefined;\r\n        this.previousQuery = '';\r\n        this.checkAutocomplete();\r\n        /* if(!rootScope.settings.stickers.suggest) {\r\n          this.stickersHelper.checkEmoticon('');\r\n        } else {\r\n          this.onMessageInput();\r\n        } */\r\n      }\r\n\r\n      if(this.messageInputField) {\r\n        this.messageInputField.onFakeInput();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('draft_updated', ({peerId, threadId, draft, force}) => {\r\n      if(this.chat.threadId !== threadId || this.chat.peerId !== peerId) return;\r\n      this.setDraft(draft, true, force);\r\n    });\r\n\r\n    this.listenerSetter.add(this.appImManager)('peer_changing', (chat) => {\r\n      if(this.chat === chat) {\r\n        this.saveDraft();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(this.appImManager)('chat_changing', ({from, to}) => {\r\n      if(this.chat === from) {\r\n        this.autocompleteHelperController.toggleListNavigation(false);\r\n      } else if(this.chat === to) {\r\n        this.autocompleteHelperController.toggleListNavigation(true);\r\n      }\r\n    });\r\n\r\n    if(this.chat.type === 'scheduled') {\r\n      this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId, mids}) => {\r\n        if(this.chat.peerId === peerId && mids.includes(this.editMsgId)) {\r\n          this.onMessageSent();\r\n        }\r\n      });\r\n    } else {\r\n      this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n        if(this.chat.peerId === peerId) {\r\n          if(msgs.has(this.editMsgId)) {\r\n            this.onMessageSent();\r\n          }\r\n\r\n          if(this.replyToMsgId && msgs.has(this.replyToMsgId)) {\r\n            this.clearHelper('reply');\r\n          }\r\n\r\n          /* if(this.chat.isStartButtonNeeded()) {\r\n            this.setStartParam(BOT_START_PARAM);\r\n          } */\r\n        }\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('dialogs_multiupdate', (dialogs) => {\r\n        if(dialogs[this.chat.peerId]) {\r\n          if(this.startParam === BOT_START_PARAM) {\r\n            this.setStartParam();\r\n          } else { // updateNewMessage comes earlier than dialog appers\r\n            this.center(true);\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    try {\r\n      this.recorder = new Recorder({\r\n        //encoderBitRate: 32,\r\n        //encoderPath: \"../dist/encoderWorker.min.js\",\r\n        encoderSampleRate: 48000,\r\n        monitorGain: 0,\r\n        numberOfChannels: 1,\r\n        recordingGain: 1,\r\n        reuseWorker: true\r\n      });\r\n    } catch(err) {\r\n      console.error('Recorder constructor error:', err);\r\n    }\r\n\r\n    this.updateSendBtn();\r\n\r\n    this.listenerSetter.add(this.fileInput)('change', (e) => {\r\n      let files = (e.target as HTMLInputElement & EventTarget).files;\r\n      if(!files.length) {\r\n        return;\r\n      }\r\n      \r\n      PopupElement.createPopup(PopupNewMedia, this.chat, Array.from(files).slice(), this.willAttachType);\r\n      this.fileInput.value = '';\r\n    }, false);\r\n\r\n    /* let time = Date.now();\r\n    this.btnSend.addEventListener('touchstart', (e) => {\r\n      time = Date.now();\r\n    });\r\n\r\n    let eventName1 = 'touchend';\r\n    this.btnSend.addEventListener(eventName1, (e: Event) => {\r\n      //cancelEvent(e);\r\n      console.log(eventName1 + ', time: ' + (Date.now() - time));\r\n    });\r\n\r\n    let eventName = 'mousedown';\r\n    this.btnSend.addEventListener(eventName, (e: Event) => {\r\n      cancelEvent(e);\r\n      console.log(eventName + ', time: ' + (Date.now() - time));\r\n    }); */\r\n    attachClickEvent(this.btnSend, this.onBtnSendClick, {listenerSetter: this.listenerSetter, touchMouseDown: true});\r\n\r\n    if(this.recorder) {\r\n      attachClickEvent(this.btnCancelRecord, this.onCancelRecordClick, {listenerSetter: this.listenerSetter});\r\n\r\n      this.recorder.onstop = () => {\r\n        this.setRecording(false);\r\n        this.chatInput.classList.remove('is-locked');\r\n        this.recordRippleEl.style.transform = '';\r\n      };\r\n  \r\n      this.recorder.ondataavailable = (typedArray: Uint8Array) => {\r\n        if(this.releaseMediaPlayback) {\r\n          this.releaseMediaPlayback();\r\n          this.releaseMediaPlayback = undefined;\r\n        }\r\n\r\n        if(this.recordingOverlayListener) {\r\n          this.listenerSetter.remove(this.recordingOverlayListener);\r\n          this.recordingOverlayListener = undefined;\r\n        }\r\n\r\n        if(this.recordingNavigationItem) {\r\n          appNavigationController.removeItem(this.recordingNavigationItem);\r\n          this.recordingNavigationItem = undefined;\r\n        }\r\n\r\n        if(this.recordCanceled) {\r\n          return;\r\n        }\r\n\r\n        const {peerId, threadId} = this.chat;\r\n        const replyToMsgId = this.replyToMsgId;\r\n  \r\n        const duration = (Date.now() - this.recordStartTime) / 1000 | 0;\r\n        const dataBlob = new Blob([typedArray], {type: 'audio/ogg'});\r\n        /* const fileName = new Date().toISOString() + \".opus\";\r\n        console.log('Recorder data received', typedArray, dataBlob); */\r\n\r\n        //let perf = performance.now();\r\n        opusDecodeController.decode(typedArray, true).then((result) => {\r\n          //console.log('WAVEFORM!:', /* waveform,  */performance.now() - perf);\r\n  \r\n          opusDecodeController.setKeepAlive(false);\r\n  \r\n          // тут objectURL ставится уже с audio/wav\r\n          this.managers.appMessagesManager.sendFile(peerId, dataBlob, {\r\n            isVoiceMessage: true,\r\n            isMedia: true,\r\n            duration,\r\n            waveform: result.waveform,\r\n            objectURL: result.url,\r\n            replyToMsgId,\r\n            threadId,\r\n            clearDraft: true\r\n          });\r\n\r\n          this.onMessageSent(false, true);\r\n        });\r\n      };\r\n    }\r\n\r\n    attachClickEvent(this.replyElements.cancelBtn, this.onHelperCancel, {listenerSetter: this.listenerSetter});\r\n    attachClickEvent(this.replyElements.container, this.onHelperClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.saveDraftDebounced = debounce(() => this.saveDraft(), 2500, false, true);\r\n\r\n    this.botStartBtn = Button('btn-primary btn-transparent text-bold chat-input-control-button');\r\n    this.botStartBtn.append(i18n('BotStart'));\r\n\r\n    attachClickEvent(this.botStartBtn, () => {\r\n      const {startParam} = this;\r\n      if(startParam === undefined) {\r\n        return;\r\n      }\r\n\r\n      const toggle = this.toggleBotStartBtnDisability = toggleDisability([this.botStartBtn], true);\r\n      const peerId = this.chat.peerId;\r\n      const middleware = this.chat.bubbles.getMiddleware(() => {\r\n        return this.chat.peerId === peerId && this.startParam === startParam && this.toggleBotStartBtnDisability === toggle;\r\n      });\r\n\r\n      this.managers.appMessagesManager.startBot(peerId.toUserId(), undefined, startParam).then(() => {\r\n        if(middleware()) {\r\n          toggle();\r\n          this.toggleBotStartBtnDisability = undefined;\r\n          this.setStartParam();\r\n        }\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.controlContainer.append(this.botStartBtn);\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.pinnedControlBtn = Button('btn-primary btn-transparent text-bold chat-input-control-button', {icon: 'unpin'});\r\n    this.controlContainer.append(this.pinnedControlBtn);\r\n\r\n    this.listenerSetter.add(this.pinnedControlBtn)('click', () => {\r\n      const peerId = this.chat.peerId;\r\n\r\n      new PopupPinMessage(peerId, 0, true, () => {\r\n        this.chat.appImManager.setPeer(); // * close tab\r\n\r\n        // ! костыль, это скроет закреплённые сообщения сразу, вместо того, чтобы ждать пока анимация перехода закончится\r\n        const originalChat = this.chat.appImManager.chat;\r\n        if(originalChat.topbar.pinnedMessage) {\r\n          originalChat.topbar.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.chatInput.classList.add('type-pinned');\r\n  }\r\n\r\n  public _center(neededFakeContainer: HTMLElement, animate?: boolean) {\r\n    if(!neededFakeContainer && !this.inputContainer.classList.contains('is-centering')) {\r\n      return;\r\n    }\r\n\r\n    if(neededFakeContainer === this.fakeWrapperTo) {\r\n      return;\r\n    }\r\n\r\n    /* if(neededFakeContainer === this.botStartContainer && this.fakeWrapperTo === this.fakeSelectionWrapper) {\r\n      this.inputContainer.classList.remove('is-centering');\r\n      void this.rowsWrapper.offsetLeft; // reflow\r\n      // this.inputContainer.classList.add('is-centering');\r\n      // void this.rowsWrapper.offsetLeft; // reflow\r\n    } */\r\n\r\n    const fakeSelectionWrapper = neededFakeContainer || this.fakeWrapperTo;\r\n    const forwards = !!neededFakeContainer;\r\n    const oldFakeWrapperTo = this.fakeWrapperTo;\r\n    let transform = '', borderRadius = '', needTranslateX: number;\r\n    // if(forwards) {]\r\n      const fakeSelectionRect = fakeSelectionWrapper.getBoundingClientRect();\r\n      const fakeRowsRect = this.fakeRowsWrapper.getBoundingClientRect();\r\n      const widthFrom = fakeRowsRect.width;\r\n      const widthTo = fakeSelectionRect.width;\r\n\r\n      if(widthFrom !== widthTo) {\r\n        const scale = (widthTo/*  - 8 */) / widthFrom;\r\n        const initTranslateX = (widthFrom - widthTo) / 2;\r\n        needTranslateX = fakeSelectionRect.left - fakeRowsRect.left - initTranslateX;\r\n\r\n        if(forwards) {\r\n          transform = `translateX(${needTranslateX}px) scaleX(${scale})`;\r\n          // transform = `translateX(0px) scaleX(${scale})`;\r\n  \r\n          if(scale < 1) {\r\n            const br = 12;\r\n            borderRadius = '' + (br + br * (1 - scale)) + 'px';\r\n          }\r\n        }\r\n        //scale = widthTo / widthFrom;\r\n      }\r\n    // }\r\n\r\n    this.fakeWrapperTo = neededFakeContainer;\r\n\r\n    const duration = animate ? 200 : 0;\r\n    SetTransition(this.inputContainer, 'is-centering', forwards, duration);\r\n    SetTransition(this.rowsWrapperWrapper, 'is-centering-to-control', !!(forwards && neededFakeContainer && neededFakeContainer.classList.contains('chat-input-control')), duration);\r\n    this.rowsWrapper.style.transform = transform;\r\n    this.rowsWrapper.style.borderRadius = borderRadius;\r\n\r\n    return {\r\n      transform, \r\n      borderRadius, \r\n      needTranslateX: oldFakeWrapperTo && (\r\n          (\r\n            neededFakeContainer && \r\n            neededFakeContainer.classList.contains('chat-input-control') && \r\n            oldFakeWrapperTo === this.fakeSelectionWrapper\r\n          ) || oldFakeWrapperTo.classList.contains('chat-input-control')\r\n        ) ? needTranslateX * -.5 : needTranslateX,\r\n      widthFrom, \r\n      widthTo\r\n    };\r\n  }\r\n\r\n  public async center(animate = false) {\r\n    return this._center(await this.getNeededFakeContainer(), animate);\r\n  }\r\n\r\n  public setStartParam(startParam?: string) {\r\n    if(this.startParam === startParam) {\r\n      return;\r\n    }\r\n\r\n    this.startParam = startParam;\r\n    this.center(true);\r\n  }\r\n\r\n  public async getNeededFakeContainer(startParam = this.startParam) {\r\n    if(this.chat.selection.isSelecting) {\r\n      return this.fakeSelectionWrapper;\r\n    } else if(\r\n      startParam !== undefined || \r\n      !(await this.chat.canSend()) || \r\n      this.chat.type === 'pinned' || \r\n      await this.chat.isStartButtonNeeded()\r\n    ) {\r\n      return this.controlContainer;\r\n    }\r\n  }\r\n\r\n  // public getActiveContainer() {\r\n  //   if(this.chat.selection.isSelecting) {\r\n  //     return this.chat\r\n  //   }\r\n  //   return this.startParam !== undefined ? this.botStartContainer : this.rowsWrapper;\r\n  // }\r\n\r\n  // public setActiveContainer() {\r\n  //   const container = this.activeContainer;\r\n  //   const newContainer = this.getActiveContainer();\r\n  //   if(newContainer === container) {\r\n  //     return;\r\n  //   }\r\n\r\n\r\n  // }\r\n\r\n  private onCancelRecordClick = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n    \r\n    this.recordCanceled = true;\r\n    this.recorder.stop();\r\n    opusDecodeController.setKeepAlive(false);\r\n  };\r\n\r\n  private onEmoticonsOpen = () => {\r\n    const toggleClass = IS_TOUCH_SUPPORTED ? 'flip-icon' : 'active';\r\n    this.btnToggleEmoticons.classList.toggle(toggleClass, true);\r\n  };\r\n\r\n  private onEmoticonsClose = () => {\r\n    const toggleClass = IS_TOUCH_SUPPORTED ? 'flip-icon' : 'active';\r\n    this.btnToggleEmoticons.classList.toggle(toggleClass, false);\r\n  };\r\n\r\n  public getReadyToSend(callback: () => void) {\r\n    return this.chat.type === 'scheduled' ? (this.scheduleSending(callback), true) : (callback(), false);\r\n  }\r\n\r\n  public scheduleSending = async(callback: () => void = this.sendMessage.bind(this, true), initDate = new Date()) => {\r\n    const {peerId} = this.chat;\r\n    const middleware = this.chat.bubbles.getMiddleware();\r\n    const canSendWhenOnline = rootScope.myId !== peerId && peerId.isUser() && await this.managers.appUsersManager.isUserOnlineVisible(peerId);\r\n\r\n    new PopupSchedule(initDate, (timestamp) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const minTimestamp = (Date.now() / 1000 | 0) + 10;\r\n      if(timestamp <= minTimestamp) {\r\n        timestamp = undefined;\r\n      }\r\n\r\n      this.scheduleDate = timestamp;\r\n      callback();\r\n\r\n      if(this.chat.type !== 'scheduled' && timestamp) {\r\n        setTimeout(() => { // ! need timeout here because .forwardMessages will be called after timeout\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n\r\n          this.appImManager.openScheduled(peerId);\r\n        }, 0);\r\n      }\r\n    }, canSendWhenOnline).show();\r\n  };\r\n\r\n  public async setUnreadCount() {\r\n    if(!this.goDownUnreadBadge) {\r\n      return;\r\n    }\r\n    \r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(this.chat.peerId);\r\n    const count = dialog?.unread_count;\r\n    this.goDownUnreadBadge.innerText = '' + (count || '');\r\n    this.goDownUnreadBadge.classList.toggle('badge-gray', await this.managers.appNotificationsManager.isPeerLocalMuted(this.chat.peerId, true));\r\n\r\n    if(this.goMentionUnreadBadge && this.chat.type === 'chat') {\r\n      const hasMentions = !!(dialog?.unread_mentions_count && dialog.unread_count);\r\n      this.goMentionUnreadBadge.innerText = hasMentions ? '' + (dialog.unread_mentions_count) : '';\r\n      this.goMentionBtn.classList.toggle('is-visible', hasMentions);\r\n    }\r\n  }\r\n\r\n  public saveDraft() {\r\n    if(!this.chat.peerId || this.editMsgId || this.chat.type === 'scheduled') return;\r\n    \r\n    const {value, entities} = getRichValue(this.messageInputField.input);\r\n\r\n    let draft: DraftMessage.draftMessage;\r\n    if(value.length || this.replyToMsgId) {\r\n      draft = {\r\n        _: 'draftMessage',\r\n        date: tsNow(true),\r\n        message: value,\r\n        entities: entities.length ? entities : undefined,\r\n        pFlags: {\r\n          no_webpage: this.noWebPage\r\n        },\r\n        reply_to_msg_id: this.replyToMsgId\r\n      };\r\n    }\r\n\r\n    this.managers.appDraftsManager.syncDraft(this.chat.peerId, this.chat.threadId, draft);\r\n  }\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Input destroying');\r\n\r\n    this.listenerSetter.removeAll();\r\n  }\r\n\r\n  public cleanup(helperToo = true) {\r\n    if(!this.chat.peerId) {\r\n      this.chatInput.classList.add('hide');\r\n      this.goDownBtn.classList.add('hide');\r\n    }\r\n\r\n    cancelSelection();\r\n\r\n    this.lastTimeType = 0;\r\n    this.startParam = undefined;\r\n\r\n    if(this.toggleBotStartBtnDisability) {\r\n      this.toggleBotStartBtnDisability();\r\n      this.toggleBotStartBtnDisability = undefined;\r\n    }\r\n\r\n    if(this.messageInput) {\r\n      this.clearInput();\r\n      helperToo && this.clearHelper();\r\n    }\r\n  }\r\n\r\n  public async setDraft(draft?: MyDraftMessage, fromUpdate = true, force = false) {\r\n    if((!force && !isInputEmpty(this.messageInput)) || this.chat.type === 'scheduled') return false;\r\n    \r\n    if(!draft) {\r\n      draft = await this.managers.appDraftsManager.getDraft(this.chat.peerId, this.chat.threadId);\r\n\r\n      if(!draft) {\r\n        if(force) { // this situation can only happen when sending message with clearDraft\r\n          /* const height = this.chatInput.getBoundingClientRect().height;\r\n          const willChangeHeight = 78 - height;\r\n          this.willChangeHeight = willChangeHeight; */\r\n          if(this.chat.container.classList.contains('is-helper-active')) {\r\n            this.t();\r\n          }\r\n\r\n          this.messageInputField.inputFake.textContent = '';\r\n          this.messageInputField.onFakeInput(false);\r\n\r\n          ((this.chat.bubbles.messagesQueuePromise || Promise.resolve()) as Promise<any>).then(() => {\r\n            fastRaf(() => {\r\n              this.onMessageSent();\r\n            });\r\n          });\r\n        }\r\n        \r\n        return false;\r\n      }\r\n    }\r\n\r\n    const wrappedDraft = wrapDraft(draft);\r\n\r\n    if(this.messageInputField.value === wrappedDraft && this.replyToMsgId === draft.reply_to_msg_id) return false;\r\n\r\n    if(fromUpdate) {\r\n      this.clearHelper();\r\n    }\r\n\r\n    this.noWebPage = draft.pFlags.no_webpage;\r\n    if(draft.reply_to_msg_id) {\r\n      this.initMessageReply(draft.reply_to_msg_id);\r\n    }\r\n\r\n    this.setInputValue(wrappedDraft, fromUpdate, fromUpdate);\r\n    return true;\r\n  }\r\n\r\n  private createSendAs() {\r\n    this.sendAsPeerId = undefined;\r\n\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      let firstChange = true;\r\n      this.sendAs = new ChatSendAs(\r\n        this.managers,\r\n        (container, skipAnimation) => {\r\n          let useRafs = 0;\r\n          if(!container.parentElement) {\r\n            this.newMessageWrapper.prepend(container);\r\n            useRafs = 2;\r\n          }\r\n\r\n          this.updateOffset('as', true, skipAnimation, useRafs);\r\n        },\r\n        (sendAsPeerId) => {\r\n          this.sendAsPeerId = sendAsPeerId;\r\n\r\n          // do not change placeholder earlier than finishPeerChange does\r\n          if(firstChange) {\r\n            firstChange = false;\r\n            return;\r\n          }\r\n\r\n          this.getPlaceholderKey().then((key) => {\r\n            this.updateMessageInputPlaceholder(key);\r\n          });\r\n        }\r\n      );\r\n    } else {\r\n      this.sendAs = undefined;\r\n    }\r\n\r\n    return this.sendAs;\r\n  }\r\n\r\n  public async finishPeerChange(startParam?: string) {\r\n    const peerId = this.chat.peerId;\r\n\r\n    const {forwardElements, btnScheduled, replyKeyboard, sendMenu, goDownBtn, chatInput, botCommandsToggle} = this;\r\n    \r\n    const previousSendAs = this.sendAs;\r\n    const sendAs = this.createSendAs();\r\n\r\n    const [\r\n      isBroadcast, \r\n      canPinMessage, \r\n      isBot, \r\n      canSend, \r\n      neededFakeContainer, \r\n      ackedPeerFull, \r\n      ackedScheduledMids, \r\n      setSendAsCallback,\r\n      filteredAttachMenuButtons\r\n    ] = await Promise.all([\r\n      this.managers.appPeersManager.isBroadcast(peerId),\r\n      this.managers.appPeersManager.canPinMessage(peerId),\r\n      this.managers.appPeersManager.isBot(peerId),\r\n      this.chat.canSend(),\r\n      this.getNeededFakeContainer(startParam),\r\n      modifyAckedPromise(this.managers.acknowledged.appProfileManager.getProfileByPeerId(peerId)),\r\n      btnScheduled ? modifyAckedPromise(this.managers.acknowledged.appMessagesManager.getScheduledMessages(peerId)) : undefined,\r\n      sendAs ? (sendAs.setPeerId(this.chat.peerId), sendAs.updateManual(true)) : undefined,\r\n      this.filterAttachMenuButtons()\r\n    ]);\r\n\r\n    const placeholderKey = this.messageInput ? await this.getPlaceholderKey() : undefined;\r\n\r\n    return () => {\r\n      // console.warn('[input] finishpeerchange start');\r\n      \r\n      chatInput.classList.remove('hide');\r\n      goDownBtn.classList.toggle('is-broadcast', isBroadcast);\r\n      goDownBtn.classList.remove('hide');\r\n  \r\n      if(this.goDownUnreadBadge) {\r\n        this.setUnreadCount();\r\n      }\r\n  \r\n      if(this.chat.type === 'pinned') {\r\n        chatInput.classList.toggle('can-pin', canPinMessage);\r\n      }/*  else if(this.chat.type === 'chat') {\r\n      } */\r\n  \r\n      if(forwardElements) {\r\n        this.forwardWasDroppingAuthor = false;\r\n        forwardElements.showCaption.checkboxField.setValueSilently(true);\r\n        forwardElements.showSender.checkboxField.setValueSilently(true);\r\n      }\r\n  \r\n      if(btnScheduled && ackedScheduledMids) {\r\n        btnScheduled.classList.add('hide');\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        callbackify(ackedScheduledMids.result, (mids) => {\r\n          if(!middleware() || !mids) return;\r\n          btnScheduled.classList.toggle('hide', !mids.length);\r\n        });\r\n      }\r\n  \r\n      if(this.newMessageWrapper) {\r\n        this.updateOffset(null, false, true);\r\n      }\r\n  \r\n      if(botCommandsToggle) {\r\n        this.hasBotCommands = undefined;\r\n        this.botCommands.toggle(true, undefined, true);\r\n        this.updateBotCommandsToggle(true);\r\n        botCommandsToggle.remove();\r\n        if(isBot) {\r\n          const middleware = this.chat.bubbles.getMiddleware();\r\n          const result = ackedPeerFull.result;\r\n          callbackify(result, (userFull) => {\r\n            if(!middleware()) return;\r\n            this.updateBotCommands(userFull as UserFull.userFull, !(result instanceof Promise));\r\n          });\r\n        }\r\n      }\r\n\r\n      if(previousSendAs) {\r\n        previousSendAs.destroy();\r\n      }\r\n\r\n      if(setSendAsCallback) {\r\n        setSendAsCallback();\r\n      }\r\n  \r\n      if(replyKeyboard) {\r\n        replyKeyboard.setPeer(peerId);\r\n      }\r\n  \r\n      if(sendMenu) {\r\n        sendMenu.setPeerId(peerId);\r\n      }\r\n      \r\n      if(this.messageInput) {\r\n        this.updateMessageInput(canSend, placeholderKey, filteredAttachMenuButtons);\r\n      } else if(this.pinnedControlBtn) {\r\n        this.pinnedControlBtn.append(i18n(canPinMessage ? 'Chat.Input.UnpinAll' : 'Chat.Pinned.DontShow'));\r\n      }\r\n  \r\n      // * testing\r\n      // this.startParam = this.appPeersManager.isBot(peerId) ? '123' : undefined;\r\n      \r\n      this.startParam = startParam;\r\n  \r\n      this._center(neededFakeContainer, false);\r\n\r\n      // console.warn('[input] finishpeerchange ends');\r\n    };\r\n  }\r\n\r\n  private updateOffset(type: 'commands' | 'as', forwards: boolean, skipAnimation?: boolean, useRafs?: number) {\r\n    if(type) {\r\n      this.newMessageWrapper.dataset.offset = type;\r\n    } else {\r\n      delete this.newMessageWrapper.dataset.offset;\r\n    }\r\n\r\n    SetTransition(this.newMessageWrapper, 'has-offset', forwards, skipAnimation ? 0 : 300, undefined, useRafs);\r\n  }\r\n\r\n  private updateBotCommands(userFull: UserFull.userFull, skipAnimation?: boolean) {\r\n    this.hasBotCommands = !!userFull.bot_info?.commands?.length;\r\n    this.updateBotCommandsToggle(skipAnimation);\r\n  }\r\n\r\n  private updateBotCommandsToggle(skipAnimation?: boolean) {\r\n    const {botCommandsToggle, hasBotCommands} = this;\r\n\r\n    const show = !!hasBotCommands && this.isInputEmpty();\r\n    if(!hasBotCommands) {\r\n      if(!botCommandsToggle.parentElement) {\r\n        return;\r\n      }\r\n      \r\n      botCommandsToggle.remove();\r\n    }\r\n    \r\n    const forwards = show;\r\n    const useRafs = botCommandsToggle.parentElement ? 0 : 2;\r\n\r\n    if(!botCommandsToggle.parentElement) {\r\n      this.newMessageWrapper.prepend(botCommandsToggle);\r\n    }\r\n\r\n    this.updateOffset('commands', forwards, skipAnimation, useRafs);\r\n  }\r\n\r\n  private async getPlaceholderKey() {\r\n    const {peerId, threadId} = this.chat;\r\n    let key: LangPackKey;\r\n    if(threadId) {\r\n      key = 'Comment';\r\n    } else if(await this.managers.appPeersManager.isBroadcast(peerId)) {\r\n      key = 'ChannelBroadcast';\r\n    } else if(\r\n      (this.sendAsPeerId !== undefined && this.sendAsPeerId !== rootScope.myId) || \r\n      await this.managers.appMessagesManager.isAnonymousSending(peerId)\r\n    ) {\r\n      key = 'SendAnonymously';\r\n    } else {\r\n      key = 'Message';\r\n    }\r\n\r\n    return key;\r\n  }\r\n\r\n  private updateMessageInputPlaceholder(key: LangPackKey) {\r\n    // console.warn('[input] update placeholder');\r\n    const i = I18n.weakMap.get(this.messageInput) as I18n.IntlElement;\r\n    if(!i) {\r\n      return;\r\n    }\r\n\r\n    i.compareAndUpdate({key});\r\n  }\r\n\r\n  private filterAttachMenuButtons() {\r\n    if(!this.attachMenuButtons) return;\r\n    const {peerId, threadId} = this.chat;\r\n    return filterAsync(this.attachMenuButtons, (button) => {\r\n      return button.verify(peerId, threadId);\r\n    });\r\n  }\r\n\r\n  public updateMessageInput(canSend: boolean, placeholderKey: LangPackKey, visible: ChatInput['attachMenuButtons']) {\r\n    const {chatInput, attachMenu, messageInput} = this;\r\n    const {peerId, threadId} = this.chat;\r\n    const isHidden = chatInput.classList.contains('is-hidden');\r\n    const willBeHidden = !canSend;\r\n    if(isHidden !== willBeHidden) {\r\n      chatInput.classList.add('no-transition');\r\n      chatInput.classList.toggle('is-hidden', !canSend);\r\n      void chatInput.offsetLeft; // reflow\r\n      chatInput.classList.remove('no-transition');\r\n    }\r\n\r\n    this.updateMessageInputPlaceholder(placeholderKey);\r\n\r\n    this.attachMenuButtons && this.attachMenuButtons.forEach((button) => {\r\n      button.element.classList.toggle('hide', !visible.includes(button));\r\n    });\r\n\r\n    if(!canSend) {\r\n      messageInput.removeAttribute('contenteditable');\r\n    } else {\r\n      messageInput.setAttribute('contenteditable', 'true');\r\n      this.setDraft(undefined, false);\r\n\r\n      if(!messageInput.innerHTML) {\r\n        this.messageInputField.onFakeInput();\r\n      }\r\n    }\r\n    \r\n    if(attachMenu) {\r\n      attachMenu.toggleAttribute('disabled', !visible.length);\r\n      attachMenu.classList.toggle('btn-disabled', !visible.length);\r\n    }\r\n    \r\n    this.updateSendBtn();\r\n  }\r\n\r\n  private attachMessageInputField() {\r\n    const oldInputField = this.messageInputField;\r\n    this.messageInputField = new InputField({\r\n      placeholder: 'Message',\r\n      name: 'message',\r\n      animate: true\r\n    });\r\n\r\n    this.messageInputField.input.classList.replace('input-field-input', 'input-message-input');\r\n    this.messageInputField.inputFake.classList.replace('input-field-input', 'input-message-input');\r\n    this.messageInput = this.messageInputField.input;\r\n    this.messageInput.classList.add('no-scrollbar');\r\n    this.attachMessageInputListeners();\r\n    \r\n    if(IS_STICKY_INPUT_BUGGED) {\r\n      fixSafariStickyInputFocusing(this.messageInput);\r\n    }\r\n\r\n    if(oldInputField) {\r\n      oldInputField.input.replaceWith(this.messageInputField.input);\r\n      oldInputField.inputFake.replaceWith(this.messageInputField.inputFake);\r\n    } else {\r\n      this.inputMessageContainer.append(this.messageInputField.input, this.messageInputField.inputFake);\r\n    }\r\n  }\r\n\r\n  private attachMessageInputListeners() {\r\n    this.listenerSetter.add(this.messageInput)('keydown', (e: KeyboardEvent) => {\r\n      const key = e.key;\r\n      if(isSendShortcutPressed(e)) {\r\n        cancelEvent(e);\r\n        this.sendMessage();\r\n      } else if(e.ctrlKey || e.metaKey) {\r\n        this.handleMarkdownShortcut(e);\r\n      } else if((key === 'PageUp' || key === 'PageDown') && !e.shiftKey) { // * fix pushing page to left (Chrome Windows)\r\n        e.preventDefault();\r\n\r\n        if(key === 'PageUp') {\r\n          const range = document.createRange();\r\n          const sel = window.getSelection();\r\n          \r\n          range.setStart(this.messageInput.childNodes[0] || this.messageInput, 0);\r\n          range.collapse(true);\r\n          \r\n          sel.removeAllRanges();\r\n          sel.addRange(range);\r\n        } else {\r\n          placeCaretAtEnd(this.messageInput);\r\n        }\r\n      }\r\n    });\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachClickEvent(this.messageInput, (e) => {\r\n        this.appImManager.selectTab(1); // * set chat tab for album orientation\r\n        //this.saveScroll();\r\n        emoticonsDropdown.toggle(false);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      /* this.listenerSetter.add(window)('resize', () => {\r\n        this.restoreScroll();\r\n      }); */\r\n\r\n      /* if(isSafari) {  \r\n        this.listenerSetter.add(this.messageInput)('mousedown', () => {\r\n          window.requestAnimationFrame(() => {\r\n            window.requestAnimationFrame(() => {\r\n              emoticonsDropdown.toggle(false);\r\n            });\r\n          });\r\n        });\r\n      } */\r\n    }\r\n\r\n    /* this.listenerSetter.add(this.messageInput)('beforeinput', (e: Event) => {\r\n      // * validate due to manual formatting through browser's context menu\r\n      const inputType = (e as InputEvent).inputType;\r\n      //console.log('message beforeinput event', e);\r\n\r\n      if(inputType.indexOf('format') === 0) {\r\n        //console.log('message beforeinput format', e, inputType, this.messageInput.innerHTML);\r\n        const markdownType = inputType.split('format')[1].toLowerCase() as MarkdownType;\r\n        if(this.applyMarkdown(markdownType)) {\r\n          cancelEvent(e); // * cancel legacy markdown event\r\n        }\r\n      }\r\n    }); */\r\n    this.listenerSetter.add(this.messageInput)('input', this.onMessageInput);\r\n    this.listenerSetter.add(this.messageInput)('keyup', () => {\r\n      this.checkAutocomplete();\r\n    });\r\n\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      this.listenerSetter.add(this.messageInput)('focusin', () => {\r\n        if(this.chat.bubbles.scrollable.loadedAll.bottom) {\r\n          this.managers.appMessagesManager.readAllHistory(this.chat.peerId, this.chat.threadId);\r\n        }\r\n      }); \r\n    }\r\n  }\r\n\r\n  private prepareDocumentExecute = () => {\r\n    this.executedHistory.push(this.messageInput.innerHTML);\r\n    return () => this.canUndoFromHTML = this.messageInput.innerHTML;\r\n  };\r\n\r\n  private undoRedo = (e: Event, type: 'undo' | 'redo', needHTML: string) => {\r\n    cancelEvent(e); // cancel legacy event\r\n\r\n    let html = this.messageInput.innerHTML;\r\n    if(html && html !== needHTML) {\r\n      this.lockRedo = true;\r\n\r\n      let sameHTMLTimes = 0;\r\n      do {\r\n        document.execCommand(type, false, null);\r\n        const currentHTML = this.messageInput.innerHTML;\r\n        if(html === currentHTML) {\r\n          if(++sameHTMLTimes > 2) { // * unlink, removeFormat (а может и нет, случай: заболдить подчёркнутый текст (выделить ровно его), попробовать отменить)\r\n            break;\r\n          }\r\n        } else {\r\n          sameHTMLTimes = 0;\r\n        }\r\n\r\n        html = currentHTML;\r\n      } while(html !== needHTML);\r\n\r\n      this.lockRedo = false;\r\n    }\r\n  };\r\n\r\n  public applyMarkdown(type: MarkdownType, href?: string) {\r\n    const MONOSPACE_FONT = 'var(--font-monospace)';\r\n    const SPOILER_FONT = 'spoiler';\r\n    const commandsMap: Partial<{[key in typeof type]: string | (() => void)}> = {\r\n      bold: 'Bold',\r\n      italic: 'Italic',\r\n      underline: 'Underline',\r\n      strikethrough: 'Strikethrough',\r\n      monospace: () => document.execCommand('fontName', false, MONOSPACE_FONT),\r\n      link: href ? () => document.execCommand('createLink', false, href) : () => document.execCommand('unlink', false, null),\r\n      spoiler: () => document.execCommand('fontName', false, SPOILER_FONT)\r\n    };\r\n\r\n    if(!commandsMap[type]) {\r\n      return false;\r\n    }\r\n\r\n    const command = commandsMap[type];\r\n\r\n    //type = 'monospace';\r\n\r\n    const saveExecuted = this.prepareDocumentExecute();\r\n    const executed: any[] = [];\r\n    /**\r\n     * * clear previous formatting, due to Telegram's inability to handle several entities\r\n     */\r\n    /* const checkForSingle = () => {\r\n      const nodes = getSelectedNodes();\r\n      //console.log('Using formatting:', commandsMap[type], nodes, this.executedHistory);\r\n\r\n      const parents = [...new Set(nodes.map((node) => node.parentNode))];\r\n      //const differentParents = !!nodes.find((node) => node.parentNode !== firstParent);\r\n      const differentParents = parents.length > 1;\r\n\r\n      let notSingle = false;\r\n      if(differentParents) {\r\n        notSingle = true;\r\n      } else {\r\n        const node = nodes[0];\r\n        if(node && (node.parentNode as HTMLElement) !== this.messageInput && (node.parentNode.parentNode as HTMLElement) !== this.messageInput) {\r\n          notSingle = true;\r\n        }\r\n      }\r\n\r\n      if(notSingle) {\r\n        //if(type === 'monospace') {\r\n          executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n        //}\r\n\r\n        executed.push(document.execCommand('unlink', false, null));\r\n        executed.push(document.execCommand('removeFormat', false, null));\r\n        executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n\r\n        //if(type === 'monospace') {\r\n          executed.push(document.execCommand('styleWithCSS', false, 'false'));\r\n        //}\r\n      }\r\n    }; */\r\n\r\n    executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n    \r\n    if(type === 'monospace' || type === 'spoiler') {\r\n      let haveThisType = false;\r\n      //executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n\r\n      const selection = window.getSelection();\r\n      if(!selection.isCollapsed) {\r\n        const range = selection.getRangeAt(0);\r\n        const tag = markdownTags[type];\r\n\r\n        const node = range.commonAncestorContainer;\r\n        if((node.parentNode as HTMLElement).matches(tag.match) || (node instanceof HTMLElement && node.matches(tag.match))) {\r\n          haveThisType = true;\r\n        }\r\n      }\r\n\r\n      //executed.push(document.execCommand('removeFormat', false, null));\r\n\r\n      if(haveThisType) {\r\n        executed.push(this.resetCurrentFormatting());\r\n      } else {\r\n        executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n      }\r\n    } else {\r\n      executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n    }\r\n\r\n    executed.push(document.execCommand('styleWithCSS', false, 'false'));\r\n\r\n    //checkForSingle();\r\n    saveExecuted();\r\n    if(this.appImManager.markupTooltip) {\r\n      this.appImManager.markupTooltip.setActiveMarkupButton();\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private resetCurrentFormatting() {\r\n    return document.execCommand('fontName', false, 'Roboto');\r\n  }\r\n\r\n  private handleMarkdownShortcut = (e: KeyboardEvent) => {\r\n    // console.log('handleMarkdownShortcut', e);\r\n    const formatKeys: {[key: string]: MarkdownType} = {\r\n      'KeyB': 'bold',\r\n      'KeyI': 'italic',\r\n      'KeyU': 'underline',\r\n      'KeyS': 'strikethrough',\r\n      'KeyM': 'monospace',\r\n      'KeyP': 'spoiler'\r\n    };\r\n\r\n    if(this.appImManager.markupTooltip) {\r\n      formatKeys['KeyK'] = 'link';\r\n    }\r\n\r\n    const code = e.code;\r\n    const applyMarkdown = formatKeys[code];\r\n\r\n    const selection = document.getSelection();\r\n    if(selection.toString().trim().length && applyMarkdown) {\r\n      // * костыльчик\r\n      if(code === 'KeyK') {\r\n        this.appImManager.markupTooltip.showLinkEditor();\r\n      } else {\r\n        this.applyMarkdown(applyMarkdown);\r\n      }\r\n  \r\n      cancelEvent(e); // cancel legacy event\r\n    }\r\n\r\n    //return;\r\n    if(code === 'KeyZ') {\r\n      let html = this.messageInput.innerHTML;\r\n\r\n      if(e.shiftKey) {\r\n        if(this.undoHistory.length) {\r\n          this.executedHistory.push(html);\r\n          html = this.undoHistory.pop();\r\n          this.undoRedo(e, 'redo', html);\r\n          html = this.messageInput.innerHTML;\r\n          this.canRedoFromHTML = this.undoHistory.length ? html : '';\r\n          this.canUndoFromHTML = html;\r\n        }\r\n      } else {\r\n        // * подождём, когда пользователь сам восстановит поле до нужного состояния, которое стало сразу после saveExecuted\r\n        if(this.executedHistory.length && (!this.canUndoFromHTML || html === this.canUndoFromHTML)) {\r\n          this.undoHistory.push(html);\r\n          html = this.executedHistory.pop();\r\n          this.undoRedo(e, 'undo', html);\r\n\r\n          // * поставим новое состояние чтобы снова подождать, если пользователь изменит что-то, и потом попробует откатить до предыдущего состояния\r\n          this.canUndoFromHTML = this.canRedoFromHTML = this.messageInput.innerHTML;\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private onMessageInput = (e?: Event) => {\r\n    // * validate due to manual formatting through browser's context menu\r\n    /* const inputType = (e as InputEvent).inputType;\r\n    console.log('message input event', e);\r\n    if(inputType === 'formatBold') {\r\n      console.log('message input format', this.messageInput.innerHTML);\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(!isSelectionSingle()) {\r\n      alert('not single');\r\n    } */\r\n\r\n    //console.log('messageInput input', this.messageInput.innerText);\r\n    //const value = this.messageInput.innerText;\r\n    const {value: richValue, entities: markdownEntities, caretPos} = getRichValueWithCaret(this.messageInputField.input);\r\n      \r\n    //const entities = parseEntities(value);\r\n    const value = parseMarkdown(richValue, markdownEntities, true);\r\n    const entities = mergeEntities(markdownEntities, parseEntities(value));\r\n\r\n    //this.chat.log('messageInput entities', richValue, value, markdownEntities, caretPos);\r\n\r\n    if(this.canRedoFromHTML && !this.lockRedo && this.messageInput.innerHTML !== this.canRedoFromHTML) {\r\n      this.canRedoFromHTML = '';\r\n      this.undoHistory.length = 0;\r\n    }\r\n\r\n    const urlEntities: Array<MessageEntity.messageEntityUrl | MessageEntity.messageEntityTextUrl> = (!this.editMessage?.media || this.editMessage.media._ === 'messageMediaWebPage') && entities.filter((e) => e._ === 'messageEntityUrl' || e._ === 'messageEntityTextUrl') as any;\r\n    if(urlEntities.length) {\r\n      for(const entity of urlEntities) {\r\n        let url: string;\r\n        if(entity._ === 'messageEntityTextUrl') {\r\n          url = entity.url;\r\n        } else {\r\n          url = richValue.slice(entity.offset, entity.offset + entity.length);\r\n\r\n          if(!(url.includes('http://') || url.includes('https://'))) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        //console.log('messageInput url:', url);\r\n\r\n        if(this.lastUrl !== url) {\r\n          this.lastUrl = url;\r\n          // this.willSendWebPage = null;\r\n          const promise = this.getWebPagePromise = this.managers.appWebPagesManager.getWebPage(url).then((webpage) => {\r\n            if(this.getWebPagePromise === promise) this.getWebPagePromise = undefined;\r\n            if(this.lastUrl !== url) return;\r\n            if(webpage._  === 'webPage') {\r\n              //console.log('got webpage: ', webpage);\r\n\r\n              this.setTopInfo('webpage', () => {}, webpage.site_name || webpage.title || 'Webpage', webpage.description || webpage.url || '');\r\n              delete this.noWebPage;\r\n              this.willSendWebPage = webpage;\r\n            } else if(this.willSendWebPage) {\r\n              this.onHelperCancel();\r\n            }\r\n          });\r\n        }\r\n\r\n        break;\r\n      }\r\n    } else if(this.lastUrl) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n      \r\n      if(this.helperType) {\r\n        this.helperFunc();\r\n      } else {\r\n        this.clearHelper();\r\n      }\r\n    }\r\n\r\n    const isEmpty = !richValue.trim();\r\n    if(isEmpty) {\r\n      if(this.lastTimeType) {\r\n        this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: 'sendMessageCancelAction'});\r\n      }\r\n\r\n      if(this.appImManager.markupTooltip) {\r\n        this.appImManager.markupTooltip.hide();\r\n      }\r\n\r\n      // * Chrome has a bug - it will preserve the formatting if the input with monospace text is cleared\r\n      // * so have to reset formatting\r\n      if(document.activeElement === this.messageInput) {\r\n        // document.execCommand('styleWithCSS', false, 'true');\r\n        setTimeout(() => {\r\n          if(document.activeElement === this.messageInput) {\r\n            this.resetCurrentFormatting();\r\n          }\r\n        }, 0);\r\n        // document.execCommand('styleWithCSS', false, 'false');\r\n      }\r\n    } else {\r\n      const time = Date.now();\r\n      if(time - this.lastTimeType >= 6000) {\r\n        this.lastTimeType = time;\r\n        this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: 'sendMessageTypingAction'});\r\n      }\r\n\r\n      if(this.botCommands) {\r\n        this.botCommands.toggle(true);\r\n      }\r\n    }\r\n\r\n    if(this.botCommands) {\r\n      this.updateBotCommandsToggle();\r\n    }\r\n\r\n    if(!this.editMsgId) {\r\n      this.saveDraftDebounced();\r\n    }\r\n\r\n    this.checkAutocomplete(richValue, caretPos, entities);\r\n\r\n    this.updateSendBtn();\r\n  };\r\n\r\n  public insertAtCaret(insertText: string, insertEntity?: MessageEntity, isHelper = true) {\r\n    const {value: fullValue, caretPos, entities} = getRichValueWithCaret(this.messageInput);\r\n    const pos = caretPos >= 0 ? caretPos : fullValue.length;\r\n    const prefix = fullValue.substr(0, pos);\r\n    const suffix = fullValue.substr(pos);\r\n\r\n    const matches = isHelper ? prefix.match(ChatInput.AUTO_COMPLETE_REG_EXP) : null;\r\n\r\n    const matchIndex = matches ? matches.index + (matches[0].length - matches[2].length) : prefix.length;\r\n    const newPrefix = prefix.slice(0, matchIndex);\r\n    const newValue = newPrefix + insertText + suffix;\r\n\r\n    // merge emojis\r\n    const hadEntities = parseEntities(fullValue);\r\n    mergeEntities(entities, hadEntities);\r\n\r\n    // max for additional whitespace\r\n    const insertLength = insertEntity ? Math.max(insertEntity.length, insertText.length) : insertText.length;\r\n    const addEntities: MessageEntity[] = [];\r\n    if(insertEntity) {\r\n      addEntities.push(insertEntity);\r\n      insertEntity.offset = matchIndex;\r\n    }\r\n\r\n    // add offset to entities next to emoji\r\n    const diff = matches ? insertLength - matches[2].length : insertLength;\r\n    entities.forEach((entity) => {\r\n      if(entity.offset >= matchIndex) {\r\n        entity.offset += diff;\r\n      }\r\n    });\r\n\r\n    mergeEntities(entities, addEntities);\r\n\r\n    if(/* caretPos !== -1 && caretPos !== fullValue.length */true) {\r\n      const caretEntity: MessageEntity.messageEntityCaret = {\r\n        _: 'messageEntityCaret',\r\n        offset: matchIndex + insertLength,\r\n        length: 0\r\n      };\r\n\r\n      let insertCaretAtIndex = 0;\r\n      for(let length = entities.length; insertCaretAtIndex < length; ++insertCaretAtIndex) {\r\n        const entity = entities[insertCaretAtIndex];\r\n        if(entity.offset > caretEntity.offset) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      entities.splice(insertCaretAtIndex, 0, caretEntity);\r\n    }\r\n\r\n    //const saveExecuted = this.prepareDocumentExecute();\r\n    // can't exec .value here because it will instantly check for autocomplete\r\n    const value = documentFragmentToHTML(wrapDraftText(newValue, {entities}));\r\n    this.messageInputField.setValueSilently(value, true);\r\n\r\n    const caret = this.messageInput.querySelector('.composer-sel');\r\n    if(caret) {\r\n      setCaretAt(caret);\r\n      caret.remove();\r\n    }\r\n\r\n    // but it's needed to be checked only here\r\n    this.onMessageInput();\r\n\r\n    //saveExecuted();\r\n\r\n    //document.execCommand('insertHTML', true, wrapEmojiText(emoji));\r\n  }\r\n\r\n  public onEmojiSelected = (emoji: string, autocomplete: boolean) => {\r\n    this.insertAtCaret(emoji, getEmojiEntityFromEmoji(emoji), autocomplete);\r\n  };\r\n\r\n  private async checkAutocomplete(value?: string, caretPos?: number, entities?: MessageEntity[]) {\r\n    //return;\r\n\r\n    if(value === undefined) {\r\n      const r = getRichValueWithCaret(this.messageInputField.input, true);\r\n      value = r.value;\r\n      caretPos = r.caretPos;\r\n      entities = r.entities;\r\n    }\r\n\r\n    if(caretPos === -1) {\r\n      caretPos = value.length;\r\n    }\r\n\r\n    if(entities === undefined) {\r\n      const _value = parseMarkdown(value, entities, true);\r\n      entities = mergeEntities(entities, parseEntities(_value));\r\n    }\r\n\r\n    value = value.slice(0, caretPos);\r\n\r\n    if(this.previousQuery === value) {\r\n      return;\r\n    }\r\n\r\n    this.previousQuery = value;\r\n    \r\n    const matches = value.match(ChatInput.AUTO_COMPLETE_REG_EXP);\r\n    let foundHelper: AutocompleteHelper;\r\n    if(matches) {\r\n      const entity = entities[0];\r\n\r\n      let query = matches[2];\r\n      const firstChar = query[0];\r\n\r\n      if(this.stickersHelper && \r\n        rootScope.settings.stickers.suggest && \r\n        await this.chat.canSend('send_stickers') &&\r\n        entity?._ === 'messageEntityEmoji' && entity.length === value.length && !entity.offset) {\r\n        foundHelper = this.stickersHelper;\r\n        this.stickersHelper.checkEmoticon(value);\r\n      } else if(firstChar === '@') { // mentions\r\n        const topMsgId = this.chat.threadId ? getServerMessageId(this.chat.threadId) : undefined;\r\n        if(await this.mentionsHelper.checkQuery(query, this.chat.peerId.isUser() ? NULL_PEER_ID : this.chat.peerId, topMsgId)) {\r\n          foundHelper = this.mentionsHelper;\r\n        }\r\n      } else if(!matches[1] && firstChar === '/') { // commands\r\n        if(await this.commandsHelper.checkQuery(query, this.chat.peerId)) {\r\n          foundHelper = this.commandsHelper;\r\n        }\r\n      } else if(rootScope.settings.emoji.suggest) { // emoji\r\n        query = query.replace(/^\\s*/, '');\r\n        if(!value.match(/^\\s*:(.+):\\s*$/) && !value.match(/:[;!@#$%^&*()-=|]/) && query) {\r\n          foundHelper = this.emojiHelper;\r\n          this.emojiHelper.checkQuery(query, firstChar);\r\n        }\r\n      }\r\n    }\r\n    \r\n    foundHelper = this.checkInlineAutocomplete(value, foundHelper);\r\n\r\n    this.autocompleteHelperController.hideOtherHelpers(foundHelper);\r\n  }\r\n\r\n  private checkInlineAutocomplete(value: string, foundHelper?: AutocompleteHelper): AutocompleteHelper {\r\n    let needPlaceholder = false;\r\n\r\n    if(!foundHelper) {\r\n      const inlineMatch = value.match(/^@([a-zA-Z\\\\d_]{3,32})\\s/);\r\n      if(inlineMatch) {\r\n        const username = inlineMatch[1];\r\n        const query = value.slice(inlineMatch[0].length);\r\n        needPlaceholder = inlineMatch[0].length === value.length;\r\n  \r\n        foundHelper = this.inlineHelper;\r\n\r\n        if(!this.btnPreloader) {\r\n          this.btnPreloader = ButtonIcon('none btn-preloader float show disable-hover', {noRipple: true});\r\n          putPreloader(this.btnPreloader, true);\r\n          this.inputMessageContainer.parentElement.insertBefore(this.btnPreloader, this.inputMessageContainer.nextSibling);\r\n        } else {\r\n          SetTransition(this.btnPreloader, 'show', true, 400);\r\n        }\r\n        \r\n        this.inlineHelper.checkQuery(this.chat.peerId, username, query).then(({user, renderPromise}) => {\r\n          if(needPlaceholder && user.bot_inline_placeholder) {\r\n            this.messageInput.dataset.inlinePlaceholder = user.bot_inline_placeholder;\r\n          }\r\n\r\n          renderPromise.then(() => {\r\n            SetTransition(this.btnPreloader, 'show', false, 400);\r\n          });\r\n        }).catch(noop);\r\n      }\r\n    }\r\n    \r\n    if(!needPlaceholder) {\r\n      delete this.messageInput.dataset.inlinePlaceholder;\r\n    }\r\n\r\n    if(foundHelper !== this.inlineHelper) {\r\n      if(this.btnPreloader) {\r\n        SetTransition(this.btnPreloader, 'show', false, 400);\r\n      }\r\n    }\r\n\r\n    return foundHelper;\r\n  }\r\n\r\n  private setRecording(value: boolean) {\r\n    if(this.recording === value) {\r\n      return;\r\n    }\r\n\r\n    SetTransition(this.chatInput, 'is-recording', value, 200);\r\n    this.recording = value;\r\n    this.updateSendBtn();\r\n  }\r\n\r\n  private onBtnSendClick = async(e: Event) => {\r\n    cancelEvent(e);\r\n\r\n    if(!this.recorder || this.recording || !this.isInputEmpty() || this.forwarding || this.editMsgId) {\r\n      if(this.recording) {\r\n        if((Date.now() - this.recordStartTime) < RECORD_MIN_TIME) {\r\n          this.onCancelRecordClick();\r\n        } else {\r\n          this.recorder.stop();\r\n        }\r\n      } else {\r\n        this.sendMessage();\r\n      }\r\n    } else {\r\n      if(this.chat.peerId.isAnyChat() && !(await this.chat.canSend('send_media'))) {\r\n        toast(POSTING_MEDIA_NOT_ALLOWED);\r\n        return;\r\n      }\r\n\r\n      this.chatInput.classList.add('is-locked');\r\n      blurActiveElement();\r\n\r\n      this.recorder.start().then(() => {\r\n        this.releaseMediaPlayback = appMediaPlaybackController.setSingleMedia();\r\n        this.recordCanceled = false;\r\n        \r\n        this.setRecording(true);\r\n        opusDecodeController.setKeepAlive(true);\r\n        \r\n        const showDiscardPopup = () => {\r\n          new PopupPeer('popup-cancel-record', {\r\n            titleLangKey: 'DiscardVoiceMessageTitle',\r\n            descriptionLangKey: 'DiscardVoiceMessageDescription',\r\n            buttons: [{\r\n              langKey: 'DiscardVoiceMessageAction',\r\n              callback: () => {\r\n                simulateClickEvent(this.btnCancelRecord);\r\n              }\r\n            }, {\r\n              langKey: 'Continue',\r\n              isCancel: true\r\n            }]\r\n          }).show();\r\n        };\r\n\r\n        this.recordingOverlayListener = this.listenerSetter.add(document.body)('mousedown', (e) => {\r\n          if(!findUpClassName(e.target, 'chat-input') && !findUpClassName(e.target, 'popup-cancel-record')) {\r\n            cancelEvent(e);\r\n            showDiscardPopup();\r\n          }\r\n        }, {capture: true, passive: false}) as any;\r\n\r\n        appNavigationController.pushItem(this.recordingNavigationItem = {\r\n          type: 'voice',\r\n          onPop: () => {\r\n            setTimeout(() => {\r\n              showDiscardPopup();\r\n            }, 0);\r\n\r\n            return false;\r\n          }\r\n        });\r\n\r\n        this.recordStartTime = Date.now();\r\n\r\n        const sourceNode: MediaStreamAudioSourceNode = this.recorder.sourceNode;\r\n        const context = sourceNode.context;\r\n\r\n        const analyser = context.createAnalyser();\r\n        sourceNode.connect(analyser);\r\n        //analyser.connect(context.destination);\r\n        analyser.fftSize = 32;\r\n\r\n        const frequencyData = new Uint8Array(analyser.frequencyBinCount);\r\n        const max = frequencyData.length * 255;\r\n        const min = 54 / 150;\r\n        let r = () => {\r\n          if(!this.recording) return;\r\n\r\n          analyser.getByteFrequencyData(frequencyData);\r\n\r\n          let sum = 0;\r\n          frequencyData.forEach((value) => {\r\n            sum += value;\r\n          });\r\n          \r\n          let percents = Math.min(1, (sum / max) + min);\r\n          //console.log('frequencyData', frequencyData, percents);\r\n\r\n          this.recordRippleEl.style.transform = `scale(${percents})`;\r\n\r\n          let diff = Date.now() - this.recordStartTime;\r\n          let ms = diff % 1000;\r\n\r\n          let formatted = toHHMMSS(diff / 1000) + ',' + ('00' + Math.round(ms / 10)).slice(-2);\r\n\r\n          this.recordTimeEl.innerText = formatted;\r\n\r\n          fastRaf(r);\r\n        };\r\n\r\n        r();\r\n      }).catch((e: Error) => {\r\n        switch(e.name as string) {\r\n          case 'NotAllowedError': {\r\n            toast('Please allow access to your microphone');\r\n            break;\r\n          }\r\n\r\n          case 'NotReadableError': {\r\n            toast(e.message);\r\n            break;\r\n          }\r\n\r\n          default:\r\n            console.error('Recorder start error:', e, e.name, e.message);\r\n            toast(e.message);\r\n            break;\r\n        }\r\n\r\n        this.setRecording(false);\r\n        this.chatInput.classList.remove('is-locked');\r\n      });\r\n    }\r\n  };\r\n\r\n  private onHelperCancel = async(e?: Event, force?: boolean) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.willSendWebPage) {\r\n      const lastUrl = this.lastUrl;\r\n      let needReturn = false;\r\n      if(this.helperType) {\r\n        //if(this.helperFunc) {\r\n          await this.helperFunc();\r\n        //}\r\n\r\n        needReturn = true;\r\n      }\r\n\r\n      // * restore values\r\n      this.lastUrl = lastUrl;\r\n      this.noWebPage = true;\r\n      this.willSendWebPage = null;\r\n\r\n      if(needReturn) return;\r\n    }\r\n\r\n    if(this.helperType === 'edit' && !force) {\r\n      const message = this.editMessage\r\n      const value = parseMarkdown(this.messageInputField.value, []);\r\n      if(message.message !== value) {\r\n        new PopupPeer('discard-editing', {\r\n          buttons: [{\r\n            langKey: 'Alert.Confirm.Discard',\r\n            callback: () => {\r\n              this.onHelperCancel(undefined, true);\r\n            }\r\n          }],\r\n          descriptionLangKey: 'Chat.Edit.Cancel.Text'\r\n        }).show();\r\n\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.clearHelper();\r\n    this.updateSendBtn();\r\n  };\r\n\r\n  private onHelperClick = (e: Event) => {\r\n    cancelEvent(e);\r\n      \r\n    if(!findUpClassName(e.target, 'reply')) return;\r\n    if(this.helperType === 'forward') {\r\n      const {forwardElements} = this;\r\n      if(forwardElements && IS_TOUCH_SUPPORTED && !forwardElements.container.classList.contains('active')) {\r\n        contextMenuController.openBtnMenu(forwardElements.container);\r\n      }\r\n    } else if(this.helperType === 'reply') {\r\n      this.chat.setMessageId(this.replyToMsgId);\r\n    } else if(this.helperType === 'edit') {\r\n      this.chat.setMessageId(this.editMsgId);\r\n    }\r\n  };\r\n\r\n  private changeForwardRecipient() {\r\n    if(this.helperWaitingForward) return;\r\n    this.helperWaitingForward = true;\r\n\r\n    const forwarding = copy(this.forwarding);\r\n    const helperFunc = this.helperFunc;\r\n    this.clearHelper();\r\n    this.updateSendBtn();\r\n    let selected = false;\r\n    const popup = new PopupForward(forwarding, () => {\r\n      selected = true;\r\n    });\r\n\r\n    popup.addEventListener('close', () => {\r\n      this.helperWaitingForward = false;\r\n\r\n      if(!selected) {\r\n        helperFunc();\r\n      }\r\n    });\r\n  }\r\n\r\n  public async clearInput(canSetDraft = true, fireEvent = true, clearValue = '') {\r\n    if(document.activeElement === this.messageInput && IS_MOBILE_SAFARI) { // fix first char uppercase\r\n      const i = document.createElement('input');\r\n      document.body.append(i);\r\n      fixSafariStickyInput(i);\r\n      this.messageInputField.setValueSilently(clearValue);\r\n      fixSafariStickyInput(this.messageInput);\r\n      i.remove();\r\n    } else {\r\n      this.messageInputField.setValueSilently(clearValue);\r\n    }\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      //this.messageInput.innerText = '';\r\n    } else {\r\n      //this.attachMessageInputField();\r\n      //this.messageInput.innerText = '';\r\n\r\n      // clear executions\r\n      this.canRedoFromHTML = '';\r\n      this.undoHistory.length = 0;\r\n      this.executedHistory.length = 0;\r\n      this.canUndoFromHTML = '';\r\n    }\r\n\r\n    let set = false;\r\n    if(canSetDraft) {\r\n      set = await this.setDraft(undefined, false);\r\n    }\r\n\r\n    if(!set && fireEvent) {\r\n      this.onMessageInput();\r\n    }\r\n  }\r\n\r\n  public isInputEmpty() {\r\n    return isInputEmpty(this.messageInput);\r\n  }\r\n\r\n  public updateSendBtn() {\r\n    let icon: 'send' | 'record' | 'edit' | 'schedule';\r\n\r\n    const isInputEmpty = this.isInputEmpty();\r\n\r\n    if(this.editMsgId) icon = 'edit';\r\n    else if(!this.recorder || this.recording || !isInputEmpty || this.forwarding) icon = this.chat.type === 'scheduled' ? 'schedule' : 'send';\r\n    else icon = 'record';\r\n\r\n    ['send', 'record', 'edit', 'schedule'].forEach((i) => {\r\n      this.btnSend.classList.toggle(i, icon === i);\r\n    });\r\n\r\n    if(this.btnScheduled) {\r\n      this.btnScheduled.classList.toggle('show', isInputEmpty);\r\n    }\r\n\r\n    if(this.btnToggleReplyMarkup) {\r\n      this.btnToggleReplyMarkup.classList.toggle('show', isInputEmpty);\r\n    }\r\n  }\r\n\r\n  public onMessageSent(clearInput = true, clearReply?: boolean) {\r\n    if(this.chat.type !== 'scheduled') {\r\n      this.managers.appMessagesManager.readAllHistory(this.chat.peerId, this.chat.threadId, true);\r\n    }\r\n\r\n    this.scheduleDate = undefined;\r\n    this.sendSilent = undefined;\r\n\r\n    const value = this.messageInputField.value;\r\n    const entities = parseEntities(value);\r\n    const emojiEntities: MessageEntity.messageEntityEmoji[] = entities.filter((entity) => entity._ === 'messageEntityEmoji') as any;\r\n    emojiEntities.forEach((entity) => {\r\n      const emoji = emojiFromCodePoints(entity.unicode);\r\n      this.managers.appEmojiManager.pushRecentEmoji(emoji);\r\n    });\r\n\r\n    if(clearInput) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n      this.clearInput();\r\n    }\r\n\r\n    if(clearReply || clearInput) {\r\n      this.clearHelper();\r\n    }\r\n\r\n    this.updateSendBtn();\r\n  }\r\n\r\n  public sendMessage(force = false) {\r\n    const {editMsgId, chat} = this;\r\n    if(chat.type === 'scheduled' && !force && !editMsgId) {\r\n      this.scheduleSending();\r\n      return;\r\n    }\r\n\r\n    const {peerId} = chat;\r\n    const {noWebPage} = this;\r\n    const sendingParams = this.chat.getMessageSendingParams();\r\n\r\n    const {value, entities} = getRichValue(this.messageInputField.input);\r\n\r\n    //return;\r\n    if(editMsgId) {\r\n      const message = this.editMessage;\r\n      if(value.trim() || message.media) {\r\n        this.managers.appMessagesManager.editMessage(message, value, {\r\n          entities,\r\n          noWebPage: noWebPage\r\n        });\r\n\r\n        this.onMessageSent();\r\n      } else {\r\n        new PopupDeleteMessages(peerId, [editMsgId], chat.type);\r\n\r\n        return;\r\n      }\r\n    } else if(value.trim()) {\r\n      this.managers.appMessagesManager.sendText(peerId, value, {\r\n        entities,\r\n        ...sendingParams,\r\n        noWebPage: noWebPage,\r\n        webPage: this.getWebPagePromise ? undefined : this.willSendWebPage,\r\n        clearDraft: true\r\n      });\r\n\r\n      if(this.chat.type === 'scheduled') {\r\n        this.onMessageSent(true);\r\n      } else {\r\n        this.onMessageSent(false, false);\r\n      }\r\n      // this.onMessageSent();\r\n    }\r\n\r\n    // * wait for sendText set messageId for invokeAfterMsg\r\n    if(this.forwarding) {\r\n      const forwarding = copy(this.forwarding);\r\n      // setTimeout(() => {\r\n        for(const fromPeerId in forwarding) {\r\n          this.managers.appMessagesManager.forwardMessages(peerId, fromPeerId.toPeerId(), forwarding[fromPeerId], {\r\n            ...sendingParams,\r\n            dropAuthor: this.forwardElements && this.forwardElements.hideSender.checkboxField.checked,\r\n            dropCaptions: this.isDroppingCaptions()\r\n          });\r\n        }\r\n\r\n        if(!value) {\r\n          this.onMessageSent();\r\n        }\r\n      // }, 0);\r\n    }\r\n\r\n    // this.onMessageSent();\r\n  }\r\n\r\n  public async sendMessageWithDocument(document: MyDocument | string, force = false, clearDraft = false) {\r\n    document = await this.managers.appDocsManager.getDoc(document);\r\n\r\n    const flag = document.type === 'sticker' ? 'send_stickers' : (document.type === 'gif' ? 'send_gifs' : 'send_media');\r\n    if(this.chat.peerId.isAnyChat() && !(await this.chat.canSend(flag))) {\r\n      toast(POSTING_MEDIA_NOT_ALLOWED);\r\n      return false;\r\n    }\r\n\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.scheduleSending(() => this.sendMessageWithDocument(document, true, clearDraft));\r\n      return false;\r\n    }\r\n\r\n    if(document) {\r\n      this.managers.appMessagesManager.sendFile(this.chat.peerId, document, {\r\n        ...this.chat.getMessageSendingParams(),\r\n        isMedia: true, \r\n        clearDraft: clearDraft || undefined\r\n      });\r\n      this.onMessageSent(clearDraft, true);\r\n\r\n      if(document.type === 'sticker') {\r\n        emoticonsDropdown.stickersTab?.pushRecentSticker(document);\r\n      }\r\n\r\n      return true;\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  private canToggleHideAuthor() {\r\n    const {forwardElements} = this;\r\n    if(!forwardElements) return false;\r\n    const hideCaptionCheckboxField = forwardElements.hideCaption.checkboxField;\r\n    return !hideCaptionCheckboxField.checked ||\r\n      findUpTag(hideCaptionCheckboxField.label, 'FORM').classList.contains('hide');\r\n  }\r\n\r\n  private isDroppingCaptions() {\r\n    return !this.canToggleHideAuthor();\r\n  }\r\n\r\n  /* public sendSomething(callback: () => void, force = false) {\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.scheduleSending(() => this.sendSomething(callback, true));\r\n      return false;\r\n    }\r\n\r\n    callback();\r\n    this.onMessageSent(false, true);\r\n\r\n    return true;\r\n  } */\r\n\r\n  public async initMessageEditing(mid: number) {\r\n    const message = (await this.chat.getMessage(mid)) as Message.message;\r\n\r\n    let input = documentFragmentToHTML(wrapDraftText(message.message, {entities: message.totalEntities}));\r\n    const f = async() => {\r\n      const replyFragment = await wrapMessageForReply(message, undefined, [message.mid]);\r\n      this.setTopInfo('edit', f, i18n('AccDescrEditing'), replyFragment, input, message);\r\n\r\n      this.editMsgId = mid;\r\n      this.editMessage = message;\r\n      input = undefined;\r\n    };\r\n    f();\r\n  }\r\n\r\n  public initMessagesForward(fromPeerIdsMids: {[fromPeerId: PeerId]: number[]}) {\r\n    const f = async() => {\r\n      //const peerTitles: string[]\r\n      const fromPeerIds = Object.keys(fromPeerIdsMids).map((fromPeerId) => fromPeerId.toPeerId());\r\n      const smth: Set<string> = new Set();\r\n      let length = 0, messagesWithCaptionsLength = 0;\r\n\r\n      const p = fromPeerIds.map(async(fromPeerId) => {\r\n        const mids = fromPeerIdsMids[fromPeerId];\r\n        const promises = mids.map(async(mid) => {\r\n          const message = (await this.managers.appMessagesManager.getMessageByPeer(fromPeerId, mid)) as Message.message;\r\n          if(message.fwd_from?.from_name && !message.fromId && !message.fwdFromId) {\r\n            smth.add('N' + message.fwd_from.from_name);\r\n          } else {\r\n            smth.add('P' + message.fromId);\r\n          }\r\n\r\n          if(message.media && message.message) {\r\n            ++messagesWithCaptionsLength;\r\n          }\r\n        });\r\n\r\n        await Promise.all(promises);\r\n\r\n        length += mids.length;\r\n      });\r\n\r\n      await Promise.all(p);\r\n\r\n      const onlyFirstName = smth.size > 2;\r\n      const peerTitles = [...smth].map((smth) => {\r\n        const type = smth[0];\r\n        smth = smth.slice(1);\r\n        if(type === 'P') {\r\n          const peerId = smth.toPeerId();\r\n          return peerId === rootScope.myId ? i18n('Chat.Accessory.Forward.You') : new PeerTitle({peerId, dialog: false, onlyFirstName}).element;\r\n        } else {\r\n          return onlyFirstName ? smth.split(' ')[0] : smth;\r\n        }\r\n      });\r\n\r\n      const {forwardElements} = this;\r\n      const form = findUpTag(forwardElements.showCaption.checkboxField.label, 'FORM');\r\n      form.classList.toggle('hide', !messagesWithCaptionsLength);\r\n      const hideCaption = forwardElements.hideCaption.checkboxField.checked;\r\n      if(messagesWithCaptionsLength && hideCaption) {\r\n        forwardElements.hideSender.checkboxField.setValueSilently(true);\r\n      } else if(this.forwardWasDroppingAuthor !== undefined) {\r\n        (this.forwardWasDroppingAuthor ? forwardElements.hideSender : forwardElements.showSender).checkboxField.setValueSilently(true);\r\n      }\r\n\r\n      const titleKey: LangPackKey = forwardElements.showSender.checkboxField.checked ? 'Chat.Accessory.Forward' : 'Chat.Accessory.Hidden';\r\n      const title = i18n(titleKey, [length]);\r\n\r\n      const senderTitles = document.createDocumentFragment();\r\n      if(peerTitles.length < 3) {\r\n        senderTitles.append(...join(peerTitles, false));\r\n      } else {\r\n        senderTitles.append(peerTitles[0], i18n('AndOther', [peerTitles.length - 1]));\r\n      }\r\n\r\n      let firstMessage: Message.message, usingFullAlbum: boolean;\r\n      if(fromPeerIds.length === 1) {\r\n        const fromPeerId = fromPeerIds[0];\r\n        const mids = fromPeerIdsMids[fromPeerId];\r\n        firstMessage = (await this.managers.appMessagesManager.getMessageByPeer(fromPeerId, mids[0])) as Message.message;\r\n  \r\n        usingFullAlbum = !!firstMessage.grouped_id;\r\n        if(usingFullAlbum) {\r\n          const albumMids = await this.managers.appMessagesManager.getMidsByMessage(firstMessage);\r\n          if(albumMids.length !== length || albumMids.find((mid) => !mids.includes(mid))) {\r\n            usingFullAlbum = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      const subtitleFragment = document.createDocumentFragment();\r\n      const delimiter = ': ';\r\n      if(usingFullAlbum || length === 1) {\r\n        const mids = fromPeerIdsMids[fromPeerIds[0]];\r\n        const replyFragment = await wrapMessageForReply(firstMessage, undefined, mids);\r\n        subtitleFragment.append(\r\n          senderTitles, \r\n          delimiter, \r\n          replyFragment\r\n        );\r\n      } else {\r\n        subtitleFragment.append(\r\n          i18n('Chat.Accessory.Forward.From'), \r\n          delimiter, \r\n          senderTitles\r\n        );\r\n      }\r\n  \r\n      let newReply = this.setTopInfo('forward', f, title, subtitleFragment);\r\n\r\n      forwardElements.modifyArgs.forEach((b, idx) => {\r\n        const text = b.textElement;\r\n        const intl: I18n.IntlElement = I18n.weakMap.get(text) as any;\r\n        intl.args = [idx < 2 ? fromPeerIds.length : messagesWithCaptionsLength];\r\n        intl.update();\r\n      });\r\n\r\n      if(this.forwardHover) {\r\n        this.forwardHover.attachButtonListener(newReply, this.listenerSetter);\r\n      }\r\n\r\n      this.forwarding = fromPeerIdsMids;\r\n    };\r\n    \r\n    f();\r\n  }\r\n\r\n  public async initMessageReply(mid: number) {\r\n    if(this.replyToMsgId === mid) {\r\n      return;\r\n    }\r\n    \r\n    let message = await this.chat.getMessage(mid);\r\n    const f = () => {\r\n      let peerTitleEl: HTMLElement;\r\n      if(!message) { // load missing replying message\r\n        peerTitleEl = i18n('Loading');\r\n\r\n        this.managers.appMessagesManager.wrapSingleMessage(this.chat.peerId, mid).then((_message) => {\r\n          if(this.replyToMsgId !== mid) {\r\n            return;\r\n          }\r\n\r\n          message = _message;\r\n          if(!message) {\r\n            this.clearHelper('reply');\r\n          } else {\r\n            f();\r\n          }\r\n        });\r\n      } else {\r\n        peerTitleEl = new PeerTitle({\r\n          peerId: message.fromId,\r\n          dialog: false\r\n        }).element;\r\n      }\r\n\r\n      this.setTopInfo('reply', f, peerTitleEl, message && (message as Message.message).message, undefined, message);\r\n      this.replyToMsgId = mid;\r\n    };\r\n    f();\r\n  }\r\n\r\n  public clearHelper(type?: ChatInputHelperType) {\r\n    if(this.helperType === 'edit' && type !== 'edit') {\r\n      this.clearInput();\r\n    }\r\n\r\n    if(type) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n    }\r\n    \r\n    if(type !== 'reply') {\r\n      this.replyToMsgId = undefined;\r\n      this.forwarding = undefined;\r\n    }\r\n\r\n    this.editMsgId = this.editMessage = undefined;\r\n    this.helperType = this.helperFunc = undefined;\r\n\r\n    if(this.chat.container.classList.contains('is-helper-active')) {\r\n      appNavigationController.removeByType('input-helper');\r\n      this.chat.container.classList.remove('is-helper-active');\r\n      this.t();\r\n    }\r\n  }\r\n\r\n  private t() {\r\n    const className = 'is-toggling-helper';\r\n    SetTransition(this.chat.container, className, true, 150, () => {\r\n      this.chat.container.classList.remove(className);\r\n    });\r\n  }\r\n\r\n  public setInputValue(value: string, clear = true, focus = true) {\r\n    if(!value) value = '';\r\n\r\n    if(clear) this.clearInput(false, false, value);\r\n    else this.messageInputField.setValueSilently(value);\r\n\r\n    fastRaf(() => {\r\n      focus && placeCaretAtEnd(this.messageInput);\r\n      this.onMessageInput();\r\n      this.messageInput.scrollTop = this.messageInput.scrollHeight;\r\n    });\r\n  }\r\n\r\n  public setTopInfo(\r\n    type: ChatInputHelperType, \r\n    callerFunc: () => void, \r\n    title: Parameters<typeof wrapReply>[0] = '', \r\n    subtitle: Parameters<typeof wrapReply>[1] = '', \r\n    input?: string, \r\n    message?: any\r\n  ) {\r\n    if(this.willSendWebPage && type === 'reply') {\r\n      return;\r\n    }\r\n\r\n    if(type !== 'webpage') {\r\n      this.clearHelper(type);\r\n      this.helperType = type;\r\n      this.helperFunc = callerFunc;\r\n    }\r\n    \r\n    const replyParent = this.replyElements.container;\r\n    const oldReply = replyParent.lastElementChild.previousElementSibling;\r\n    const haveReply = oldReply.classList.contains('reply');\r\n\r\n    this.replyElements.iconBtn.replaceWith(this.replyElements.iconBtn = ButtonIcon((type === 'webpage' ? 'link' : type) + ' active reply-icon', {noRipple: true}));\r\n    const {container} = wrapReply(title, subtitle, message);\r\n    if(haveReply) {\r\n      oldReply.replaceWith(container);\r\n    } else {\r\n      replyParent.insertBefore(container, replyParent.lastElementChild);\r\n    }\r\n\r\n    if(type === 'webpage') {\r\n      container.style.cursor = 'default';\r\n    }\r\n\r\n    if(!this.chat.container.classList.contains('is-helper-active')) {\r\n      this.chat.container.classList.add('is-helper-active');\r\n      this.t();\r\n    }\r\n\r\n    /* const scroll = appImManager.scrollable;\r\n    if(scroll.isScrolledDown && !scroll.scrollLocked && !appImManager.messagesQueuePromise && !appImManager.setPeerPromise) {\r\n      scroll.scrollTo(scroll.scrollHeight, 'top', true, true, 200);\r\n    } */\r\n\r\n    if(!IS_MOBILE) {\r\n      appNavigationController.pushItem({\r\n        type: 'input-helper',\r\n        onPop: () => {\r\n          this.onHelperCancel();\r\n        }\r\n      });\r\n    }\r\n\r\n    if(input !== undefined) {\r\n      this.setInputValue(input);\r\n    }\r\n\r\n    setTimeout(() => {\r\n      this.updateSendBtn();\r\n    }, 0);\r\n\r\n    return container;\r\n  }\r\n\r\n  // public saveScroll() {\r\n  //   this.scrollTop = this.chat.bubbles.scrollable.container.scrollTop;\r\n  //   this.scrollOffsetTop = this.chatInput.offsetTop;\r\n  // }\r\n\r\n  // public restoreScroll() {\r\n  //   if(this.chatInput.style.display) return;\r\n  //   //console.log('input resize', offsetTop, this.chatInput.offsetTop);\r\n  //   let newOffsetTop = this.chatInput.offsetTop;\r\n  //   let container = this.chat.bubbles.scrollable.container;\r\n  //   let scrollTop = container.scrollTop;\r\n  //   let clientHeight = container.clientHeight;\r\n  //   let maxScrollTop = container.scrollHeight;\r\n\r\n  //   if(newOffsetTop < this.scrollOffsetTop) {\r\n  //     this.scrollDiff = this.scrollOffsetTop - newOffsetTop;\r\n  //     container.scrollTop += this.scrollDiff;\r\n  //   } else if(scrollTop !== this.scrollTop) {\r\n  //     let endDiff = maxScrollTop - (scrollTop + clientHeight);\r\n  //     if(endDiff < this.scrollDiff/*  && false */) {\r\n  //       //container.scrollTop -= endDiff;\r\n  //     } else {\r\n  //       container.scrollTop -= this.scrollDiff;\r\n  //     }\r\n  //   }\r\n  // }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport documentFragmentToHTML from \"../../helpers/dom/documentFragmentToHTML\";\r\nimport { DraftMessage } from \"../../layer\";\r\nimport mergeEntities from \"../../lib/richTextProcessor/mergeEntities\";\r\nimport parseEntities from \"../../lib/richTextProcessor/parseEntities\";\r\nimport wrapDraftText from \"../../lib/richTextProcessor/wrapDraftText\";\r\n\r\nexport default function wrapDraft(draft: DraftMessage.draftMessage) {\r\n  const myEntities = parseEntities(draft.message);\r\n  const apiEntities = draft.entities || [];\r\n  const totalEntities = mergeEntities(apiEntities.slice(), myEntities); // ! only in this order, otherwise bold and emoji formatting won't work\r\n\r\n  return documentFragmentToHTML(wrapDraftText(draft.message, {entities: totalEntities}));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function setCaretAt(node: Node) {\r\n  // node.appendChild(document.createTextNode(''));\r\n\r\n  const originalNode = node;\r\n  node = node.previousSibling;\r\n\r\n  if(node.nodeType === 1) {\r\n    const newNode = document.createTextNode('');\r\n    node.parentNode.insertBefore(newNode, !originalNode.nextSibling || originalNode.nextSibling.nodeType === node.nodeType ? originalNode : originalNode.nextSibling);\r\n    node = newNode;\r\n  }\r\n\r\n  if(window.getSelection && document.createRange) {\r\n    const range = document.createRange();\r\n    if(node) {\r\n      range.setStartAfter(node);\r\n      range.insertNode(node);\r\n      range.setStart(node, node.nodeValue.length);\r\n    }\r\n\r\n    range.collapse(true);\r\n\r\n    const sel = window.getSelection();\r\n    sel.removeAllRanges();\r\n    sel.addRange(range);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"./chat\";\r\nimport type ChatTopbar from \"./topbar\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport ripple from \"../ripple\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { Message } from \"../../layer\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\n\r\nconst classNames: string[] = ['is-pinned-message-shown', 'is-pinned-audio-shown'];\r\nconst CLASSNAME_BASE = 'pinned-container';\r\nconst HEIGHT = 52;\r\n\r\nexport default class PinnedContainer {\r\n  public wrapperUtils: HTMLElement;\r\n  public btnClose: HTMLElement;\r\n  protected wrapper: HTMLElement;\r\n\r\n  protected topbar: ChatTopbar;\r\n  protected chat: Chat;\r\n  protected listenerSetter: ListenerSetter;\r\n  public className: string;\r\n  public divAndCaption: DivAndCaption<(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message?: any) => void>;\r\n  \r\n  protected floating = false;\r\n\r\n  public onClose?: () => void | Promise<boolean>;\r\n\r\n  constructor(options: {\r\n    topbar: PinnedContainer['topbar'],\r\n    chat: PinnedContainer['chat'],\r\n    listenerSetter: PinnedContainer['listenerSetter'],\r\n    className: PinnedContainer['className'],\r\n    divAndCaption: PinnedContainer['divAndCaption'],\r\n    onClose?: PinnedContainer['onClose'],\r\n    floating?: PinnedContainer['floating']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const {divAndCaption, className} = this;\r\n    divAndCaption.container.classList.add(CLASSNAME_BASE, 'hide');\r\n    divAndCaption.title.classList.add(CLASSNAME_BASE + '-title');\r\n    divAndCaption.subtitle.classList.add(CLASSNAME_BASE + '-subtitle');\r\n    divAndCaption.content.classList.add(CLASSNAME_BASE + '-content');\r\n    \r\n    this.btnClose = document.createElement('button');\r\n    this.btnClose.classList.add(CLASSNAME_BASE + '-close', `pinned-${className}-close`, 'btn-icon', 'tgico-close');\r\n    \r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add(CLASSNAME_BASE + '-wrapper');\r\n    ripple(this.wrapper);\r\n\r\n    this.wrapperUtils = document.createElement('div');\r\n    this.wrapperUtils.classList.add(CLASSNAME_BASE + '-wrapper-utils');\r\n    this.wrapperUtils.append(this.btnClose);\r\n\r\n    this.wrapper.append(...Array.from(divAndCaption.container.children), this.wrapperUtils);\r\n\r\n    divAndCaption.container.append(this.wrapper/* , this.close */);\r\n\r\n    this.attachOnCloseEvent(this.btnClose);\r\n  }\r\n\r\n  public attachOnCloseEvent(elem: HTMLElement) {\r\n    attachClickEvent(elem, (e) => {\r\n      cancelEvent(e);\r\n\r\n      ((this.onClose ? this.onClose() : null) || Promise.resolve(true)).then((needClose) => {\r\n        if(needClose) {\r\n          this.toggle(true);\r\n        }\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  public toggle(hide?: boolean) {\r\n    const isHidden = this.divAndCaption.container.classList.contains('hide');\r\n    if(hide === undefined) {\r\n      hide = !isHidden;\r\n    } else if(hide === isHidden) {\r\n      return;\r\n    }\r\n\r\n    // const scrollable = this.chat.bubbles.scrollable;\r\n    \r\n    const isFloating = (this.floating || mediaSizes.isMobile) && !hide;\r\n    // const scrollTop = isFloating || this.divAndCaption.container.classList.contains('is-floating') ? scrollable.scrollTop : undefined;\r\n\r\n    this.divAndCaption.container.classList.toggle('is-floating', isFloating);\r\n    this.divAndCaption.container.classList.toggle('hide', hide);\r\n    \r\n    this.topbar.container.classList.toggle('is-pinned-floating', isFloating);\r\n    this.topbar.container.classList.toggle(`is-pinned-${this.className}-shown`, !hide);\r\n    \r\n    // const active = classNames.filter((className) => this.topbar.container.classList.contains(className));\r\n    // const maxActive = hide ? 0 : 1;\r\n    \r\n    // * not sure when it became unneeded\r\n    // if(scrollTop !== undefined && active.length <= maxActive/*  && !scrollable.isScrolledDown */) {\r\n    //   scrollable.scrollTop = scrollTop + ((hide ? -1 : 1) * HEIGHT);\r\n    // }\r\n    \r\n    this.topbar.setFloating();\r\n    this.topbar.setUtilsWidth();\r\n  }\r\n\r\n  public isVisible() {\r\n    return !this.divAndCaption.container.classList.contains('hide');\r\n  }\r\n\r\n  public isFloating() {\r\n    return this.divAndCaption.container.classList.contains('is-floating');\r\n  }\r\n\r\n  public fill(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message: Message.message) {\r\n    this.divAndCaption.container.dataset.peerId = '' + message.peerId;\r\n    this.divAndCaption.container.dataset.mid = '' + message.mid;\r\n    this.divAndCaption.fill(title, subtitle, message);\r\n    this.topbar.setUtilsWidth();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport appMediaPlaybackController from \"./appMediaPlaybackController\";\r\nimport RangeSelector from \"./rangeSelector\";\r\n\r\nexport default class VolumeSelector extends RangeSelector {\r\n  private static ICONS = ['volume_off', 'volume_mute', 'volume_down', 'volume_up'];\r\n  public btn: HTMLElement;\r\n  protected icon: HTMLSpanElement;\r\n\r\n  constructor(protected listenerSetter: ListenerSetter, protected vertical = false) {\r\n    super({\r\n      step: 0.01, \r\n      min: 0, \r\n      max: 1,\r\n      vertical\r\n    }, 1);\r\n\r\n    this.setListeners();\r\n    this.setHandlers({\r\n      onScrub: currentTime => {\r\n        const value = Math.max(Math.min(currentTime, 1), 0);\r\n\r\n        //console.log('volume scrub:', currentTime, value);\r\n\r\n        appMediaPlaybackController.muted = false;\r\n        appMediaPlaybackController.volume = value;\r\n      },\r\n\r\n      /* onMouseUp: (e) => {\r\n        cancelEvent(e.event);\r\n      } */\r\n    });\r\n\r\n    const className = 'player-volume';\r\n    const btn = this.btn = document.createElement('div');\r\n    btn.classList.add('btn-icon', className);\r\n    const icon = this.icon = document.createElement('span');\r\n    icon.classList.add(className + '__icon');\r\n\r\n    btn.append(icon, this.container);\r\n\r\n    attachClickEvent(icon, this.onMuteClick, {listenerSetter: this.listenerSetter});\r\n    this.listenerSetter.add(appMediaPlaybackController)('playbackParams', this.setVolume);\r\n\r\n    this.setVolume();\r\n  }\r\n\r\n  private onMuteClick = (e?: Event) => {\r\n    e && cancelEvent(e);\r\n    appMediaPlaybackController.muted = !appMediaPlaybackController.muted;\r\n  };\r\n\r\n  public setVolume = () => {\r\n    // const volume = video.volume;\r\n    const {volume, muted} = appMediaPlaybackController;\r\n    let d: string;\r\n    let iconIndex: number;\r\n    if(!volume || muted) {\r\n      iconIndex = 0;\r\n    } else if(volume > .5) {\r\n      iconIndex = 3;\r\n    } else if(volume > 0 && volume < .25) {\r\n      iconIndex = 1;\r\n    } else {\r\n      iconIndex = 2;\r\n    }\r\n\r\n    VolumeSelector.ICONS.forEach((icon) => this.icon.classList.remove('tgico-' + icon));\r\n    this.icon.classList.add('tgico-' + VolumeSelector.ICONS[iconIndex]);\r\n\r\n    if(!this.mousedown) {\r\n      this.setProgress(muted ? 0 : volume);\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppMessagesManager } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type ChatTopbar from \"./topbar\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appMediaPlaybackController, { AppMediaPlaybackController } from \"../appMediaPlaybackController\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport PinnedContainer from \"./pinnedContainer\";\r\nimport Chat from \"./chat\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { formatFullSentTime } from \"../../helpers/date\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport { DocumentAttribute } from \"../../layer\";\r\nimport MediaProgressLine from \"../mediaProgressLine\";\r\nimport VolumeSelector from \"../volumeSelector\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class ChatAudio extends PinnedContainer {\r\n  private toggleEl: HTMLElement;\r\n  private progressLine: MediaProgressLine;\r\n  private volumeSelector: VolumeSelector;\r\n  private fasterEl: HTMLElement;\r\n  private repeatEl: HTMLButtonElement;\r\n\r\n  constructor(protected topbar: ChatTopbar, protected chat: Chat, protected managers: AppManagers) {\r\n    super({\r\n      topbar, \r\n      chat, \r\n      listenerSetter: topbar.listenerSetter, \r\n      className: 'audio', \r\n      divAndCaption: new DivAndCaption(\r\n        'pinned-audio', \r\n        (title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment) => {\r\n          replaceContent(this.divAndCaption.title, title);\r\n          replaceContent(this.divAndCaption.subtitle, subtitle);\r\n        }\r\n      ), \r\n      onClose: () => {\r\n        appMediaPlaybackController.stop();\r\n      },\r\n      floating: true\r\n    });\r\n\r\n    this.divAndCaption.border.remove();\r\n\r\n    const prevEl = ButtonIcon('fast_rewind active', {noRipple: true});\r\n    const nextEl = ButtonIcon('fast_forward active', {noRipple: true});\r\n\r\n    const attachClick = (elem: HTMLElement, callback: () => void) => {\r\n      attachClickEvent(elem, (e) => {\r\n        cancelEvent(e);\r\n        callback();\r\n      }, {listenerSetter: this.topbar.listenerSetter});\r\n    };\r\n\r\n    attachClick(prevEl, () => {\r\n      appMediaPlaybackController.previous();\r\n    });\r\n\r\n    attachClick(nextEl, () => {\r\n      appMediaPlaybackController.next();\r\n    });\r\n\r\n    this.toggleEl = ButtonIcon('', {noRipple: true});\r\n    this.toggleEl.classList.add('active', 'pinned-audio-ico', 'tgico');\r\n    attachClick(this.toggleEl, () => {\r\n      appMediaPlaybackController.toggle();\r\n    });\r\n    this.wrapper.prepend(this.wrapper.firstElementChild, prevEl, this.toggleEl, nextEl);\r\n\r\n    this.volumeSelector = new VolumeSelector(this.listenerSetter, true);\r\n    const volumeProgressLineContainer = document.createElement('div');\r\n    volumeProgressLineContainer.classList.add('progress-line-container');\r\n    volumeProgressLineContainer.append(this.volumeSelector.container);\r\n    const tunnel = document.createElement('div');\r\n    tunnel.classList.add('pinned-audio-volume-tunnel');\r\n    this.volumeSelector.btn.classList.add('pinned-audio-volume', 'active');\r\n    this.volumeSelector.btn.prepend(tunnel);\r\n    this.volumeSelector.btn.append(volumeProgressLineContainer);\r\n\r\n    this.repeatEl = ButtonIcon('audio_repeat', {noRipple: true});\r\n    attachClick(this.repeatEl, () => {\r\n      const params = appMediaPlaybackController.getPlaybackParams();\r\n      if(!params.round) {\r\n        appMediaPlaybackController.round = true;\r\n      } else if(params.loop) {\r\n        appMediaPlaybackController.round = false;\r\n        appMediaPlaybackController.loop = false;\r\n      } else {\r\n        appMediaPlaybackController.loop = !appMediaPlaybackController.loop;\r\n      }\r\n    });\r\n\r\n    const fasterEl = this.fasterEl = ButtonIcon('playback_2x', {noRipple: true});\r\n    attachClick(fasterEl, () => {\r\n      appMediaPlaybackController.playbackRate = fasterEl.classList.contains('active') ? 1 : 1.75;\r\n    });\r\n\r\n    this.wrapperUtils.prepend(this.volumeSelector.btn, fasterEl, this.repeatEl);\r\n\r\n    const progressWrapper = document.createElement('div');\r\n    progressWrapper.classList.add('pinned-audio-progress-wrapper');\r\n\r\n    this.progressLine = new MediaProgressLine(undefined, undefined, true, true);\r\n    this.progressLine.container.classList.add('pinned-audio-progress');\r\n    progressWrapper.append(this.progressLine.container);\r\n    this.wrapper.insertBefore(progressWrapper, this.wrapperUtils);\r\n\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('play', this.onMediaPlay);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('pause', this.onPause);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('stop', this.onStop);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('playbackParams', this.onPlaybackParams);\r\n\r\n    const playingDetails = appMediaPlaybackController.getPlayingDetails();\r\n    if(playingDetails) {\r\n      this.onMediaPlay(playingDetails);\r\n      this.onPlaybackParams(playingDetails.playbackParams);\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    if(this.progressLine) {\r\n      this.progressLine.removeListeners();\r\n    }\r\n  }\r\n\r\n  private onPlaybackParams = (playbackParams: ReturnType<AppMediaPlaybackController['getPlaybackParams']>) => {\r\n    this.fasterEl.classList.toggle('active', playbackParams.playbackRate > 1);\r\n\r\n    this.repeatEl.classList.remove('tgico-audio_repeat', 'tgico-audio_repeat_single');\r\n    this.repeatEl.classList.add(playbackParams.loop ? 'tgico-audio_repeat_single' : 'tgico-audio_repeat');\r\n    this.repeatEl.classList.toggle('active', playbackParams.loop || playbackParams.round);\r\n  };\r\n\r\n  private onPause = () => {\r\n    this.toggleEl.classList.remove('flip-icon');\r\n  };\r\n\r\n  private onStop = () => {\r\n    this.toggle(true);\r\n  };\r\n  \r\n  private onMediaPlay = ({doc, message, media, playbackParams}: ReturnType<AppMediaPlaybackController['getPlayingDetails']>) => {\r\n    let title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment;\r\n    const isMusic = doc.type !== 'voice' && doc.type !== 'round';\r\n    if(!isMusic) {\r\n      title = new PeerTitle({peerId: message.fromId, fromName: message.fwd_from?.from_name}).element;\r\n\r\n      //subtitle = 'Voice message';\r\n      subtitle = formatFullSentTime(message.date);\r\n    } else {\r\n      const audioAttribute = doc.attributes.find((attr) => attr._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio;\r\n      title = wrapEmojiText(audioAttribute?.title ?? doc.file_name);\r\n      subtitle = audioAttribute?.performer ? wrapEmojiText(audioAttribute.performer) : i18n('AudioUnknownArtist');\r\n    }\r\n\r\n    this.fasterEl.classList.toggle('hide', isMusic);\r\n    this.repeatEl.classList.toggle('hide', !isMusic);\r\n\r\n    this.onPlaybackParams(playbackParams);\r\n    this.volumeSelector.setVolume();\r\n\r\n    this.progressLine.setMedia(media);\r\n\r\n    this.fill(title, subtitle, message);\r\n    // this.toggleEl.classList.add('flip-icon');\r\n    this.toggleEl.classList.toggle('flip-icon', !media.paused);\r\n    this.toggle(false);\r\n  };\r\n}\r\n","// https://github.com/evgeny-nadymov/telegram-react/blob/master/src/Components/ColumnMiddle/PinnedMessageBorder.js\r\n\r\nenum BAR_HEIGHTS {\r\n  ONE = 32,\r\n  TWO = 15,\r\n  THREE = 10,\r\n  FOUR = 8,\r\n  MORE = 8\r\n};\r\n\r\nconst GAP = 1;\r\nconst WIDTH = 2;\r\nconst BASE_CLASS = 'pinned-message-border';\r\n\r\nexport default class PinnedMessageBorder {\r\n  private border: HTMLElement;\r\n  private wrapper: HTMLElement;\r\n  private svg: SVGSVGElement;\r\n  private defs: SVGDefsElement;\r\n  private clipPath: SVGClipPathElement;\r\n  private path: SVGPathElement;\r\n  private mark: HTMLElement;\r\n\r\n  private count: number;\r\n  private index: number;\r\n\r\n  private drawRect = (x: number, y: number, width: number, height: number, radius: number) => {\r\n    return `M${x},${y + radius}a${radius},${radius},0,0,1,${width},0v${height - 2 * radius}a${radius},${radius},0,0,1,${-width},0Z`;\r\n  };\r\n\r\n  private getClipPath = (id: string, barHeight: number, count: number) => {\r\n    const radius = 1;\r\n\r\n    let d = '';\r\n    /* if(count === 3) {\r\n      d = this.drawRect(0, 0, WIDTH, barHeight, radius)\r\n        + this.drawRect(0, barHeight + GAP, WIDTH, barHeight + 1, radius)\r\n        + this.drawRect(0, barHeight * 2 + GAP * 2 + 1, WIDTH, barHeight, radius);\r\n    } */if(count === 2) {\r\n      d = this.drawRect(0, 0, WIDTH, barHeight, radius) + this.drawRect(0, barHeight + GAP * 2, WIDTH, barHeight, radius);\r\n    } else {\r\n      for(let i = 0; i < count; ++i) {\r\n        d += this.drawRect(0, (barHeight + GAP) * i, WIDTH, barHeight, radius);\r\n      }\r\n    }\r\n\r\n    if(!this.clipPath) {\r\n      this.clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');\r\n      this.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n\r\n      this.clipPath.append(this.path);\r\n    }\r\n\r\n    this.clipPath.id = id;\r\n    this.path.setAttributeNS(null, 'd', d);\r\n\r\n    return this.clipPath;\r\n  };\r\n\r\n  private getBarHeight = (count: number, index: number) => {\r\n    let barHeight: number;\r\n    if(count <= 1) {\r\n      barHeight = BAR_HEIGHTS.ONE;\r\n    } else if(count === 2) {\r\n      barHeight = BAR_HEIGHTS.TWO;\r\n    } else if(count === 3) {\r\n      barHeight = BAR_HEIGHTS.THREE;\r\n    } else if(count === 4) {\r\n      barHeight = BAR_HEIGHTS.FOUR;\r\n    } else if(count > 3) {\r\n      barHeight = BAR_HEIGHTS.MORE;\r\n    }\r\n\r\n    return barHeight;\r\n  };\r\n\r\n  private getMarkHeight = (count: number, index: number) => {\r\n    let markHeight: number;\r\n    if(count <= 1) {\r\n      markHeight = BAR_HEIGHTS.ONE;\r\n    } else if(count === 2) {\r\n      markHeight = BAR_HEIGHTS.TWO;\r\n    } else if(count === 3) {\r\n      markHeight = BAR_HEIGHTS.THREE;\r\n    } else if(count === 4) {\r\n      markHeight = BAR_HEIGHTS.FOUR;\r\n    } else if(count > 3) {\r\n      markHeight = BAR_HEIGHTS.MORE;\r\n    }\r\n\r\n    return markHeight;\r\n  };\r\n\r\n  private getMarkTranslateY = (index: number, barHeight: number, count: number) => {\r\n    if(count === 1) {\r\n      return 0;\r\n    } else if(count === 2) {\r\n      return !index ? 0 : barHeight + GAP;\r\n    }\r\n\r\n    if(count === 3) {\r\n      if(!index) {\r\n        return 0;\r\n      } else if(index === 1) {\r\n        return barHeight + GAP;\r\n      }\r\n\r\n      return barHeight * 2 + GAP * 2 + 1;\r\n    } else {\r\n      return (barHeight + GAP) * index;\r\n    }\r\n  };\r\n\r\n  private getTrackTranslateY = (index: number, count: number, barHeight: number, trackHeight: number) => {\r\n    if(count <= 4) {\r\n      return 0;\r\n    }\r\n\r\n    if(index <= 1) {\r\n      return 0;\r\n    } else if(index >= (count - 2)) {\r\n      return trackHeight - BAR_HEIGHTS.ONE - barHeight;\r\n    }\r\n\r\n    // return (index + 1) * barHeight + index * GAP;\r\n    return (index - 2) * barHeight + index * GAP;\r\n    //return (barHeight + GAP * 2) / 2 + (index - 2) * (barHeight + GAP);\r\n  };\r\n\r\n  private getTrackHeight = (count: number, barHeight: number) => {\r\n    return count <= 3 ? BAR_HEIGHTS.ONE : barHeight * count + GAP * (count - 1);\r\n  };\r\n\r\n  public render(count: number, index: number) {\r\n    if(!this.border) {\r\n      this.border = document.createElement('div');\r\n      this.border.classList.add(BASE_CLASS);\r\n\r\n      this.wrapper = document.createElement('div');\r\n      this.border.append(this.wrapper);\r\n    }\r\n    \r\n    if(count === 1) {\r\n      if(this.count !== count) {\r\n        this.wrapper.className = BASE_CLASS + '-wrapper-1';\r\n        this.border.classList.remove(BASE_CLASS + '-mask');\r\n        this.wrapper.innerHTML = this.wrapper.style.cssText = '';\r\n      }\r\n\r\n      return this.border;\r\n    }\r\n\r\n    const barHeight = this.getBarHeight(count, index);\r\n    const markHeight = this.getMarkHeight(count, index);\r\n    const trackHeight = this.getTrackHeight(count, barHeight);\r\n\r\n    const clipPathId = `clipPath_${count}`;\r\n    const clipPath = this.getClipPath(clipPathId, barHeight, count);\r\n\r\n    const markTranslateY = this.getMarkTranslateY(index, barHeight, count);\r\n    const trackTranslateY = this.getTrackTranslateY(index, count, barHeight, trackHeight);\r\n\r\n    this.border.classList.toggle(BASE_CLASS + '-mask', count > 4);\r\n\r\n    if(index <= 1) {\r\n      this.border.classList.add('mask-bottom');\r\n      this.border.classList.remove('mask-top');\r\n    } else if(index >= (count - 2)) {\r\n      this.border.classList.add('mask-top');\r\n      this.border.classList.remove('mask-bottom');\r\n    } else {\r\n      this.border.classList.add('mask-top', 'mask-bottom');\r\n    }\r\n\r\n    this.wrapper.className = BASE_CLASS + '-wrapper';\r\n    this.wrapper.style.cssText = `clip-path: url(#${clipPathId}); width: 2px; height: ${trackHeight}px; transform: translateY(-${trackTranslateY}px);`;\r\n    \r\n    if(!this.svg) {\r\n      this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n      this.svg.setAttributeNS(null, 'height', '0');\r\n      this.svg.setAttributeNS(null, 'width', '0');\r\n  \r\n      this.defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\r\n      this.defs.append(clipPath);\r\n\r\n      this.svg.append(this.defs);\r\n\r\n      this.mark = document.createElement('div');\r\n      this.mark.classList.add(BASE_CLASS + '-mark');\r\n    }\r\n\r\n    if(!this.svg.parentElement) {\r\n      this.wrapper.append(this.svg, this.mark);\r\n    }\r\n\r\n    this.mark.style.cssText = `height: ${markHeight}px; transform: translateY(${markTranslateY}px);`;\r\n    \r\n    this.count = count;\r\n    this.index = index;\r\n\r\n    return this.border;\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatTopbar from \"./topbar\";\r\nimport PopupPinMessage from \"../popups/unpinMessage\";\r\nimport PinnedContainer from \"./pinnedContainer\";\r\nimport PinnedMessageBorder from \"./pinnedMessageBorder\";\r\nimport ReplyContainer, { wrapReplyDivAndCaption } from \"./replyContainer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport Chat from \"./chat\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport handleScrollSideEvent from \"../../helpers/dom/handleScrollSideEvent\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { Message } from \"../../layer\";\r\nimport { logger } from \"../../lib/logger\";\r\n\r\nclass AnimatedSuper {\r\n  static DURATION = 200;\r\n  static BASE_CLASS = 'animated-super';\r\n  container: HTMLDivElement;\r\n  rows: {[index: string]: {element: HTMLElement, timeout?: number, new?: true}} = {};\r\n  clearTimeout: number;\r\n\r\n  constructor() {\r\n    this.container = document.createElement('div');\r\n    this.container.className = AnimatedSuper.BASE_CLASS;\r\n  }\r\n\r\n  public getRow(index: number, animateFirst = false) {\r\n    if(this.rows[index]) return this.rows[index].element;\r\n    const row = document.createElement('div');\r\n    const isFirst = !Object.keys(this.rows).length && !animateFirst;\r\n    row.className = AnimatedSuper.BASE_CLASS + '-row' + (isFirst ? '' : ' is-hiding hide');\r\n    this.rows[index] = {element: row, new: true};\r\n    this.container.append(row);\r\n    return row;\r\n  }\r\n\r\n  public clearRow(index: number) {\r\n    if(!this.rows[index]) return;\r\n    this.rows[index].element.remove();\r\n    delete this.rows[index];\r\n  }\r\n\r\n  public clearRows(currentIndex?: number) {\r\n    if(this.clearTimeout) clearTimeout(this.clearTimeout);\r\n    this.clearTimeout = window.setTimeout(() => {\r\n      for(const i in this.rows) {\r\n        if(+i === currentIndex) continue;\r\n        this.clearRow(+i);\r\n      }\r\n    }, AnimatedSuper.DURATION);\r\n  }\r\n\r\n  public setNewRow(index: number, reflow = false) {\r\n    const row = this.rows[index];\r\n    if(row.new) {\r\n      if(reflow) {\r\n        row.element.classList.remove('hide');\r\n        void row.element.offsetLeft; // reflow\r\n      } else {\r\n        row.element.classList.remove('is-hiding', 'hide');\r\n      }\r\n\r\n      delete row.new;\r\n    }\r\n\r\n    this.clearRows(index);\r\n  }\r\n\r\n  public animate(index: number, previousIndex: number, fromTop = index > previousIndex, ignorePrevious = false) {\r\n    if(index === previousIndex) { // * handle if set index 0 and previousIndex 0\r\n      return this.setNewRow(index);\r\n    }\r\n\r\n    const row = this.rows[index];\r\n    const previousRow = this.rows[previousIndex];\r\n    if(!previousRow && !ignorePrevious) {\r\n      return this.setNewRow(index);\r\n    }\r\n\r\n    const sides = ['from-top', 'from-bottom'];\r\n    if(!fromTop) sides.reverse();\r\n\r\n    row.element.classList.add(sides[0]);\r\n    row.element.classList.remove(sides[1]);\r\n    if(previousRow) {\r\n      previousRow.element.classList.add(sides[1]);\r\n      previousRow.element.classList.remove(sides[0]);\r\n    }\r\n\r\n    if(row.new) {\r\n      this.setNewRow(index, true);\r\n    }\r\n\r\n    row.element.classList.toggle('is-hiding', false);\r\n    previousRow && previousRow.element.classList.toggle('is-hiding', true);\r\n\r\n    /* const height = row.element.getBoundingClientRect().height;\r\n    row.element.style.transform = `translateY(${fromTop ? height * -1 : height}px)`;\r\n    if(previousRow) {\r\n      previousRow.element.style.transform = `translateY(${fromTop ? height : height * -1}px)`;\r\n    } */\r\n\r\n    /* row.element.style.setProperty('--height', row.element.getBoundingClientRect().height + 'px');\r\n    if(previousRow) {\r\n      previousRow.element.style.setProperty('--height', previousRow.element.getBoundingClientRect().height + 'px');\r\n    } */\r\n    \r\n    this.clearRows(index);\r\n  }\r\n}\r\n\r\nclass AnimatedCounter {\r\n  static EMPTY_INDEX = -1;\r\n  static BASE_CLASS = 'animated-counter';\r\n  container: HTMLElement;\r\n  decimals: {\r\n    container: HTMLElement,\r\n    placeholder: HTMLElement,\r\n    animatedSuper: AnimatedSuper\r\n  }[] = [];\r\n  previousNumber = 0;\r\n  clearTimeout: number;\r\n\r\n  constructor(private reverse = false) {\r\n    this.container = document.createElement('div');\r\n    this.container.className = AnimatedCounter.BASE_CLASS;\r\n  }\r\n\r\n  getDecimal(index: number) {\r\n    if(this.decimals[index]) return this.decimals[index];\r\n    const item = document.createElement('div');\r\n    item.className = AnimatedCounter.BASE_CLASS + '-decimal';\r\n\r\n    const placeholder = document.createElement('div');\r\n    placeholder.className = AnimatedCounter.BASE_CLASS + '-decimal-placeholder';\r\n\r\n    const animatedSuper = new AnimatedSuper();\r\n    animatedSuper.container.className = AnimatedCounter.BASE_CLASS + '-decimal-wrapper';\r\n\r\n    item.append(placeholder, animatedSuper.container);\r\n\r\n    this.container.append(item);\r\n\r\n    return this.decimals[index] = {container: item, placeholder, animatedSuper};\r\n  }\r\n\r\n  clear(number: number) {\r\n    if(this.clearTimeout) clearTimeout(this.clearTimeout);\r\n\r\n    const decimals = ('' + number).length;\r\n    if(decimals >= this.decimals.length) {\r\n      return;\r\n    }\r\n\r\n    this.clearTimeout = window.setTimeout(() => {\r\n      const byDecimal = this.decimals.splice(decimals, this.decimals.length - decimals);\r\n      byDecimal.forEach((decimal) => {\r\n        decimal.container.remove();\r\n      });\r\n    }, AnimatedSuper.DURATION);\r\n  }\r\n\r\n  /* prepareNumber(number: number) {\r\n    const decimals = ('' + number).length;\r\n    if(this.decimals.length < decimals) {\r\n      for(let i = this.decimals.length; i < decimals; ++i) {\r\n        this.getDecimal(i);\r\n      }\r\n    }\r\n  } */\r\n\r\n  hideLeft(number: number) {\r\n    const decimals = ('' + number).length;\r\n    const byDecimal = this.decimals.slice(decimals);//this.decimals.splice(deleteCount, this.decimals.length - deleteCount);\r\n    byDecimal.forEach((decimal) => {\r\n      const previousDecimalNumber = +decimal.placeholder.innerText || 0;\r\n      const row = decimal.animatedSuper.getRow(AnimatedCounter.EMPTY_INDEX, true);\r\n      decimal.animatedSuper.animate(AnimatedCounter.EMPTY_INDEX, previousDecimalNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n    });\r\n\r\n    this.clear(number);\r\n  }\r\n\r\n  setCount(number: number) {\r\n    //this.prepareNumber(number);\r\n\r\n    const previousByDecimal = Array.from('' + this.previousNumber).map((n) => +n);\r\n    const byDecimal = Array.from('' + number).map((n) => +n);\r\n    byDecimal.forEach((decimalNumber, idx) => {\r\n      const decimal = this.getDecimal(idx);\r\n      //const row = decimal.animatedSuper.getRow(number, true);\r\n      const row = decimal.animatedSuper.getRow(decimalNumber, true);\r\n      const previousDecimalNumber = previousByDecimal[idx] ?? AnimatedCounter.EMPTY_INDEX;\r\n      row.innerText = decimal.placeholder.innerText = '' + decimalNumber;\r\n      //decimal.animatedSuper.animate(number, this.previousNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n      decimal.animatedSuper.animate(decimalNumber, previousDecimalNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n    });\r\n\r\n    this.hideLeft(number);\r\n    //this.clear(number);\r\n    this.previousNumber = number;\r\n  }\r\n}\r\n\r\nexport default class ChatPinnedMessage {\r\n  private static LOAD_COUNT = 50;\r\n  private static LOAD_OFFSET = 5;\r\n\r\n  public pinnedMessageContainer: PinnedContainer;\r\n  private pinnedMessageBorder: PinnedMessageBorder;\r\n\r\n  private pinnedMaxMid = 0;\r\n  public pinnedMid = 0;\r\n  public pinnedIndex = -1;\r\n  private wasPinnedIndex = 0;\r\n  private wasPinnedMediaIndex = 0;\r\n  \r\n  public locked = false;\r\n  private waitForScrollBottom = false;\r\n\r\n  public count = 0;\r\n  private mids: number[] = [];\r\n  private offsetIndex = 0;\r\n\r\n  private loading = false;\r\n  private loadedBottom = false;\r\n  private loadedTop = false;\r\n\r\n  private animatedSubtitle: AnimatedSuper;\r\n  private animatedMedia: AnimatedSuper;\r\n  private animatedCounter: AnimatedCounter;\r\n\r\n  private listenerSetter: ListenerSetter;\r\n  private scrollDownListenerSetter: ListenerSetter = null;\r\n\r\n  public hidden = false;\r\n\r\n  private getCurrentIndexPromise: Promise<any> = null;\r\n  private btnOpen: HTMLButtonElement;\r\n  \r\n  private setPinnedMessage: () => void;\r\n\r\n  private isStatic: boolean;\r\n\r\n  private debug: boolean;\r\n  \r\n  public setCorrectIndexThrottled: (lastScrollDirection?: number) => void;\r\n\r\n  private log: ReturnType<typeof logger>;\r\n  \r\n  constructor(private topbar: ChatTopbar, private chat: Chat, private managers: AppManagers) {\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.log = logger('PM');\r\n    this.debug = true;\r\n    this.isStatic = false;\r\n\r\n    const dAC = new ReplyContainer('pinned-message');\r\n    this.pinnedMessageContainer = new PinnedContainer({\r\n      topbar, \r\n      chat, \r\n      listenerSetter: this.listenerSetter, \r\n      className: 'message', \r\n      divAndCaption: dAC, \r\n      onClose: async() => {\r\n        if(await managers.appPeersManager.canPinMessage(this.chat.peerId)) {\r\n          new PopupPinMessage(this.chat.peerId, this.pinnedMid, true);\r\n        } else {\r\n          new PopupPinMessage(this.chat.peerId, 0, true);\r\n        }\r\n\r\n        return false;\r\n      }\r\n    });\r\n\r\n    this.pinnedMessageBorder = new PinnedMessageBorder();\r\n    dAC.border.replaceWith(this.pinnedMessageBorder.render(1, 0));\r\n\r\n    this.animatedSubtitle = new AnimatedSuper();\r\n    dAC.subtitle.append(this.animatedSubtitle.container);\r\n\r\n    this.animatedMedia = new AnimatedSuper();\r\n    this.animatedMedia.container.classList.add('pinned-message-media-container');\r\n    dAC.content.prepend(this.animatedMedia.container);\r\n\r\n    this.animatedCounter = new AnimatedCounter(true);\r\n    dAC.title.append(i18n('PinnedMessage'), ' ', this.animatedCounter.container);\r\n\r\n    const btnClose = this.pinnedMessageContainer.btnClose.cloneNode(true) as HTMLElement;\r\n    this.pinnedMessageContainer.attachOnCloseEvent(btnClose);\r\n    dAC.container.prepend(btnClose);\r\n\r\n    this.btnOpen = ButtonIcon('pinlist pinned-container-close pinned-message-pinlist', {noRipple: true});\r\n\r\n    this.pinnedMessageContainer.wrapperUtils.prepend(this.btnOpen);\r\n\r\n    attachClickEvent(this.btnOpen, (e) => {\r\n      cancelEvent(e);\r\n      this.topbar.openPinned(true);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', ({peerId}) => {\r\n      if(peerId === this.chat.peerId) {\r\n        //this.wasPinnedIndex = 0;\r\n        //setTimeout(() => {\r\n          if(this.hidden) {\r\n            this.pinnedMessageContainer.toggle(this.hidden = false);\r\n          }\r\n\r\n          this.loadedTop = this.loadedBottom = false;\r\n          this.pinnedIndex = -1;\r\n          this.pinnedMid = 0;\r\n          this.count = 0;\r\n          this.mids = [];\r\n          this.offsetIndex = 0;\r\n          this.pinnedMaxMid = 0;\r\n          this.setCorrectIndex(0);\r\n        //}, 300);\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_pinned_hidden', ({peerId}) => {\r\n      if(peerId === this.chat.peerId) {\r\n        this.pinnedMessageContainer.toggle(this.hidden = true);\r\n      }\r\n    });\r\n\r\n    // * 200 - no lags\r\n    // * 100 - need test\r\n    this.setPinnedMessage = debounce(() => this._setPinnedMessage(), 100, true, true);\r\n    this.setCorrectIndexThrottled = throttle(this.setCorrectIndex.bind(this), 100, false);\r\n\r\n    this.isStatic = this.chat.type === 'discussion';\r\n  }\r\n\r\n  public destroy() {\r\n    this.pinnedMessageContainer.divAndCaption.container.remove();\r\n    this.pinnedMessageContainer.toggle(true);\r\n    this.listenerSetter.removeAll();\r\n    this.unsetScrollDownListener(false);\r\n  }\r\n\r\n  public setCorrectIndex(lastScrollDirection?: number) {\r\n    if(this.isStatic) return;\r\n    // return;\r\n\r\n    if(this.locked || this.hidden/*  || this.chat.setPeerPromise || this.chat.bubbles.messagesQueuePromise */) {\r\n      return;\r\n    }\r\n\r\n    if((this.loadedBottom || this.loadedTop) && !this.count) {\r\n      return;\r\n    }\r\n\r\n    //const perf = performance.now();\r\n    let el = this.chat.bubbles.getBubbleByPoint('bottom');\r\n    //this.log('setCorrectIndex: get last element perf:', performance.now() - perf, el);\r\n    if(!el) return;\r\n\r\n    //return;\r\n\r\n    const mid = el.dataset.mid;\r\n    if(el && mid !== undefined) {\r\n      //this.log('setCorrectIndex will test mid:', mid);\r\n      this.testMid(+mid, lastScrollDirection);\r\n    }\r\n  }\r\n\r\n  public testMid(mid: number, lastScrollDirection?: number) {\r\n    if(this.isStatic) return;\r\n    \r\n    //if(lastScrollDirection !== undefined) return;\r\n    if(this.hidden) return;\r\n\r\n    //this.log('testMid', mid);\r\n\r\n    let currentIndex: number = this.mids.findIndex((_mid) => _mid <= mid);\r\n    if(currentIndex !== -1 && !this.isNeededMore(currentIndex)) {\r\n      currentIndex += this.offsetIndex;\r\n    } else if(this.loadedTop && mid < this.mids[this.mids.length - 1]) {\r\n      //currentIndex = 0;\r\n      currentIndex = this.mids.length - 1 + this.offsetIndex;\r\n    } else {\r\n      if(!this.getCurrentIndexPromise) {\r\n        this.getCurrentIndexPromise = this.getCurrentIndex(mid, lastScrollDirection !== undefined);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    //const idx = Math.max(0, this.mids.indexOf(mid));\r\n\r\n    /* if(currentIndex === this.count) {\r\n      currentIndex = 0;\r\n    } */\r\n\r\n    //this.log('testMid: pinned currentIndex', currentIndex, mid);\r\n\r\n    const changed = this.pinnedIndex !== currentIndex;\r\n    if(changed) {\r\n      if(this.waitForScrollBottom && lastScrollDirection !== undefined) {\r\n        if(this.pinnedIndex === 0 || this.pinnedIndex > currentIndex) { // если не скроллил вниз и пытается поставить нижний пиннед - выйти\r\n          return;\r\n        }\r\n      }\r\n\r\n      this.pinnedIndex = currentIndex;\r\n      this.pinnedMid = this.mids.find((_mid) => _mid <= mid) || this.mids[this.mids.length - 1];\r\n      this.setPinnedMessage();\r\n    }\r\n  }\r\n\r\n  private isNeededMore(currentIndex: number) {\r\n    return (this.count > ChatPinnedMessage.LOAD_COUNT && \r\n      (\r\n        (!this.loadedBottom && currentIndex <= ChatPinnedMessage.LOAD_OFFSET) || \r\n        (!this.loadedTop && (this.count - 1 - currentIndex) <= ChatPinnedMessage.LOAD_OFFSET)\r\n      )\r\n    );\r\n  }\r\n\r\n  private async getCurrentIndex(mid: number, correctAfter = true) {\r\n    if(this.loading) return;\r\n    this.loading = true;\r\n\r\n    try {\r\n      const log = this.debug ? this.log.bindPrefix('getCurrentIndex') : undefined;\r\n      log && log('start', mid, correctAfter);\r\n\r\n      let gotRest = false;\r\n      const promises = [\r\n        this.managers.appMessagesManager.getSearch({\r\n          peerId: this.chat.peerId, \r\n          inputFilter: {_: 'inputMessagesFilterPinned'}, \r\n          maxId: mid, \r\n          limit: ChatPinnedMessage.LOAD_COUNT, \r\n          backLimit: ChatPinnedMessage.LOAD_COUNT\r\n        })\r\n        .then((r) => {\r\n          gotRest = true;\r\n          return r;\r\n        })\r\n      ];\r\n  \r\n      if(!this.pinnedMaxMid) {\r\n        const promise = this.managers.appMessagesManager.getPinnedMessage(this.chat.peerId).then((p) => {\r\n          if(!p.maxId) return;\r\n          this.pinnedMaxMid = p.maxId;\r\n\r\n          if(!gotRest && correctAfter) {\r\n            this.mids = [this.pinnedMaxMid];\r\n            this.count = p.count;\r\n            this.pinnedIndex = 0;\r\n            this.pinnedMid = this.mids[0];\r\n            this.setPinnedMessage();\r\n            //this.pinnedMessageContainer.toggle(false);\r\n          }\r\n        });\r\n  \r\n        promises.push(promise as any);\r\n      }\r\n      \r\n      const result = (await Promise.all(promises))[0];\r\n  \r\n      let backLimited = result.history.findIndex((message) => message.mid <= mid);\r\n      if(backLimited === -1) {\r\n        backLimited = result.history.length;\r\n      }/*  else {\r\n        backLimited -= 1;\r\n      } */\r\n      \r\n      this.offsetIndex = result.offset_id_offset ? result.offset_id_offset - backLimited : 0;\r\n      this.mids = result.history.map((message) => message.mid).slice();\r\n      this.count = result.count;\r\n\r\n      if(!this.count) {\r\n        this.pinnedMessageContainer.toggle(true);\r\n      }\r\n  \r\n      this.loadedTop = (this.offsetIndex + this.mids.length) === this.count;\r\n      this.loadedBottom = !this.offsetIndex;\r\n  \r\n      log && log('result', mid, result, backLimited, this.offsetIndex, this.loadedTop, this.loadedBottom);\r\n    } catch(err) {\r\n      this.log.error('getCurrentIndex error', err);\r\n    }\r\n    \r\n    this.loading = false;\r\n\r\n    if(this.locked) {\r\n      this.testMid(mid);\r\n    } else if(correctAfter) {\r\n      this.setCorrectIndex(0);\r\n    }\r\n\r\n    this.getCurrentIndexPromise = null;\r\n    //return result.offset_id_offset || 0;\r\n  }\r\n\r\n  public setScrollDownListener() {\r\n    this.waitForScrollBottom = true;\r\n\r\n    if(!this.scrollDownListenerSetter) {\r\n      this.scrollDownListenerSetter = new ListenerSetter();\r\n      handleScrollSideEvent(this.chat.bubbles.scrollable.container, 'bottom', () => {\r\n        this.unsetScrollDownListener();\r\n      }, this.scrollDownListenerSetter);\r\n    }\r\n  }\r\n\r\n  public unsetScrollDownListener(refreshPosition = true) {\r\n    this.waitForScrollBottom = false;\r\n\r\n    if(this.scrollDownListenerSetter) {\r\n      this.scrollDownListenerSetter.removeAll();\r\n      this.scrollDownListenerSetter = null;\r\n    }\r\n\r\n    if(refreshPosition) {\r\n      this.setCorrectIndex(0);\r\n    }\r\n  }\r\n\r\n  public async handleFollowingPinnedMessage() {\r\n    this.locked = true;\r\n\r\n    this.debug && this.log('handleFollowingPinnedMessage');\r\n    try {\r\n      this.setScrollDownListener();\r\n\r\n      const setPeerPromise = this.chat.setPeerPromise;\r\n      if(setPeerPromise instanceof Promise) {\r\n        await setPeerPromise;\r\n      }\r\n  \r\n      //await this.chat.bubbles.scrollable.scrollLockedPromise;\r\n      await getHeavyAnimationPromise();\r\n\r\n      if(this.getCurrentIndexPromise) {\r\n        await this.getCurrentIndexPromise;\r\n      }\r\n\r\n      this.debug && this.log('handleFollowingPinnedMessage: unlock');\r\n      this.locked = false;\r\n\r\n      /* // подождём, пока скролл остановится\r\n      setTimeout(() => {\r\n        this.log('handleFollowingPinnedMessage: unlock');\r\n        this.locked = false;\r\n      }, 50); */\r\n    } catch(err) {\r\n      this.log.error('handleFollowingPinnedMessage error:', err);\r\n\r\n      this.locked = false;\r\n      this.waitForScrollBottom = false;\r\n      this.setCorrectIndex(0);\r\n    }\r\n  }\r\n\r\n  public async followPinnedMessage(mid: number) {\r\n    const message = await this.chat.getMessage(mid);\r\n    if(!message) {\r\n      return;\r\n    }\r\n    \r\n    this.chat.setMessageId(mid);\r\n    (this.chat.setPeerPromise || Promise.resolve()).then(() => { // * debounce fast clicker\r\n      this.handleFollowingPinnedMessage();\r\n      this.testMid(this.pinnedIndex >= (this.count - 1) ? this.pinnedMaxMid : mid - 1);\r\n    });\r\n  }\r\n\r\n  public async _setPinnedMessage() {\r\n    /////this.log('setting pinned message', message);\r\n    //return;\r\n    /* const promise: Promise<any> = this.chat.setPeerPromise || this.chat.bubbles.messagesQueuePromise || Promise.resolve();\r\n    Promise.all([\r\n      promise\r\n    ]).then(() => { */\r\n      //const mids = results[0];\r\n      const count = this.count;\r\n      if(count) {\r\n        const pinnedIndex = this.pinnedIndex;\r\n        const message = await this.chat.getMessage(this.pinnedMid);\r\n\r\n        //this.animatedCounter.prepareNumber(count);\r\n\r\n        //setTimeout(() => {\r\n          const isLast = pinnedIndex === 0;\r\n          this.animatedCounter.container.classList.toggle('is-last', isLast);\r\n          //SetTransition(this.animatedCounter.container, 'is-last', isLast, AnimatedSuper.DURATION);\r\n          if(!isLast) {\r\n            this.animatedCounter.setCount(count - pinnedIndex);\r\n          }\r\n        //}, 100);\r\n\r\n        //this.pinnedMessageContainer.fill(undefined, message.message, message);\r\n        this.pinnedMessageContainer.toggle(false);\r\n\r\n        const fromTop = pinnedIndex > this.wasPinnedIndex;\r\n\r\n        this.debug && this.log('setPinnedMessage: fromTop', fromTop, pinnedIndex, this.wasPinnedIndex);\r\n\r\n        const writeTo = this.animatedSubtitle.getRow(pinnedIndex);\r\n        const writeMediaTo = this.animatedMedia.getRow(pinnedIndex);\r\n        writeMediaTo.classList.add('pinned-message-media');\r\n        //writeMediaTo.innerHTML = writeMediaTo.style.cssText = writeMediaTo.dataset.docId = '';\r\n        const loadPromises: Promise<any>[] = [];\r\n        const isMediaSet = await wrapReplyDivAndCaption({\r\n          title: undefined,\r\n          titleEl: null,\r\n          subtitle: (message as Message.message).message,\r\n          subtitleEl: writeTo,\r\n          message,\r\n          mediaEl: writeMediaTo,\r\n          loadPromises\r\n        });\r\n\r\n        await Promise.all(loadPromises);\r\n\r\n        this.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-media', isMediaSet);\r\n\r\n        //if(this.wasPinnedIndex !== this.pinnedIndex) {\r\n          this.animatedSubtitle.animate(pinnedIndex, this.wasPinnedIndex);\r\n          if(isMediaSet) {\r\n            this.animatedMedia.animate(pinnedIndex, this.wasPinnedMediaIndex); // * wasPinnedMediaIndex из-за того, что блок меняется с другим алгоритмом\r\n            this.wasPinnedMediaIndex = pinnedIndex;\r\n          } else {\r\n            this.animatedMedia.clearRows();\r\n          }\r\n        //}\r\n\r\n        this.pinnedMessageBorder.render(count, count - pinnedIndex - 1);\r\n        this.wasPinnedIndex = pinnedIndex;\r\n        this.pinnedMessageContainer.divAndCaption.container.dataset.mid = '' + message.mid;\r\n      } else {\r\n        this.pinnedMessageContainer.toggle(true);\r\n        this.wasPinnedIndex = 0;\r\n      }\r\n\r\n      this.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-many', this.count > 1);\r\n    //});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ListenerSetter from \"../listenerSetter\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\n\r\nexport default function handleScrollSideEvent(elem: HTMLElement, side: 'top' | 'bottom', callback: () => void, listenerSetter: ListenerSetter) {\r\n  if(IS_TOUCH_SUPPORTED) {\r\n    let lastY: number;\r\n    const options = {passive: true};\r\n    listenerSetter.add(elem)('touchstart', (e) => {\r\n      if(e.touches.length > 1) {\r\n        onTouchEnd();\r\n        return;\r\n      }\r\n\r\n      lastY = e.touches[0].clientY;\r\n\r\n      listenerSetter.add(elem)('touchmove', onTouchMove, options);\r\n      listenerSetter.add(elem)('touchend', onTouchEnd, options);\r\n    }, options);\r\n\r\n    const onTouchMove = (e: TouchEvent) => {\r\n      const clientY = e.touches[0].clientY;\r\n\r\n      const isDown = clientY < lastY;\r\n      if(side === 'bottom' && isDown) callback();\r\n      else if(side === 'top' && !isDown) callback();\r\n      lastY = clientY;\r\n      //alert('isDown: ' + !!isDown);\r\n    };\r\n    \r\n    const onTouchEnd = () => {\r\n      listenerSetter.removeManual(elem, 'touchmove', onTouchMove, options);\r\n      listenerSetter.removeManual(elem, 'touchend', onTouchEnd, options);\r\n    };\r\n  } else {\r\n    listenerSetter.add(elem)('wheel', (e) => {\r\n      const isDown = e.deltaY > 0;\r\n      //this.log('wheel', e, isDown);\r\n      if(side === 'bottom' && isDown) callback();\r\n      else if(side === 'top' && !isDown) callback();\r\n    }, {passive: true});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport { MUTE_UNTIL } from \"../../lib/mtproto/mtproto_config\";\r\nimport RadioField from \"../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../row\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupMute extends PopupPeer {\r\n  constructor(peerId: PeerId) {\r\n    super('popup-mute', {\r\n      peerId,\r\n      titleLangKey: 'Notifications',\r\n      buttons: [{\r\n        langKey: 'ChatList.Context.Mute',\r\n        callback: () => {\r\n          this.managers.appMessagesManager.mutePeer(peerId, time === -1 ? MUTE_UNTIL : tsNow(true) + time);\r\n        }\r\n      }],\r\n      body: true\r\n    });\r\n\r\n    const ONE_HOUR = 3600;\r\n    const times: {time: number, langKey: LangPackKey}[] = [{\r\n      time: ONE_HOUR, \r\n      langKey: 'ChatList.Mute.1Hour'\r\n    }, {\r\n      time: ONE_HOUR * 4, \r\n      langKey: 'ChatList.Mute.4Hours'\r\n    }, {\r\n      time: ONE_HOUR * 8, \r\n      langKey: 'ChatList.Mute.8Hours'\r\n    }, {\r\n      time: ONE_HOUR * 24, \r\n      langKey: 'ChatList.Mute.1Day'\r\n    }, {\r\n      time: ONE_HOUR * 24 * 3,\r\n      langKey: 'ChatList.Mute.3Days'\r\n    }, {\r\n      time: -1,\r\n      langKey: 'ChatList.Mute.Forever'\r\n    }];\r\n  \r\n    const name = 'mute-time';\r\n    const rows = times.map((time) => {\r\n      const row = new Row({\r\n        radioField: new RadioField({\r\n          langKey: time.langKey, \r\n          name, \r\n          value: '' + time.time\r\n        })\r\n      });\r\n\r\n      return row;\r\n    });\r\n\r\n    let time: number;\r\n    const radioForm = RadioFormFromRows(rows, (value) => {\r\n      time = +value;\r\n    });\r\n\r\n    rows[rows.length - 1].radioField.checked = true;\r\n\r\n    const section = new SettingSection({noShadow: true, noDelimiter: true});\r\n    section.content.append(radioForm);\r\n    this.body.append(section.container);\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nconst ASSETS_PATH = 'assets/audio/';\r\n\r\nexport default class AudioAssetPlayer<AssetName extends string> {\r\n  private audio: HTMLAudioElement;\r\n  private tempId: number;\r\n  private assetName: AssetName;\r\n\r\n  constructor(private assets: AssetName[]) {\r\n    this.tempId = 0;\r\n  }\r\n\r\n  public playSound(name: AssetName, loop = false) {\r\n    ++this.tempId;\r\n    this.assetName = name;\r\n\r\n    try {\r\n      const audio = this.createAudio();\r\n      audio.autoplay = true;\r\n      audio.src = ASSETS_PATH + name;\r\n      audio.loop = loop;\r\n      audio.play();\r\n    } catch(e) {\r\n      console.error('playSound', name, e);\r\n    }\r\n  }\r\n\r\n  public playSoundIfDifferent(name: AssetName, loop?: boolean) {\r\n    if(this.assetName !== name) {\r\n      this.playSound(name, loop);\r\n    }\r\n  }\r\n\r\n  public createAudio() {\r\n    let {audio} = this;\r\n    if(audio) {\r\n      return audio;\r\n    }\r\n\r\n    audio = this.audio = new Audio();\r\n    audio.play();\r\n    return audio;\r\n  }\r\n\r\n  public stopSound() {\r\n    if(!this.audio) {\r\n      return;\r\n    }\r\n    \r\n    this.audio.pause();\r\n  }\r\n\r\n  public cancelDelayedPlay() {\r\n    ++this.tempId;\r\n  }\r\n\r\n  public playSoundWithTimeout(name: AssetName, loop: boolean, timeout: number) {\r\n    // timeout = 0;\r\n    const tempId = ++this.tempId;\r\n    setTimeout(() => {\r\n      if(this.tempId !== tempId) {\r\n        return;\r\n      }\r\n\r\n      this.playSound(name, loop);\r\n    }, timeout);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\n\r\nexport type GroupCallAudioAssetName = \"group_call_connect.mp3\" | \"group_call_end.mp3\" | \"group_call_start.mp3\" | \"voip_onallowtalk.mp3\";\r\n\r\nlet audioAsset: AudioAssetPlayer<GroupCallAudioAssetName>;\r\nexport default function getGroupCallAudioAsset() {\r\n  return audioAsset ??= new AudioAssetPlayer([\r\n    'group_call_connect.mp3',\r\n    'group_call_end.mp3',\r\n    'group_call_start.mp3',\r\n    'voip_onallowtalk.mp3'\r\n  ]);\r\n}\r\n","import constraintSupported, { MyMediaTrackSupportedConstraints } from \"../../../environment/constraintSupport\";\r\n\r\nexport default function getAudioConstraints(): MediaTrackConstraints {\r\n  const constraints: MediaTrackConstraints = {\r\n    channelCount: 2\r\n  };\r\n\r\n  const desirable: (keyof MyMediaTrackSupportedConstraints)[] = [\r\n    'noiseSuppression',\r\n    'echoCancellation',\r\n    'autoGainControl'\r\n  ];\r\n\r\n  desirable.forEach((constraint) => {\r\n    if(constraintSupported(constraint)) {\r\n      // @ts-ignore\r\n      constraints[constraint] = true;\r\n    }\r\n  });\r\n\r\n  return constraints;\r\n}\r\n","export type MyMediaTrackSupportedConstraints = MediaTrackSupportedConstraints & {\r\n  noiseSuppression?: boolean, \r\n  autoGainControl?: boolean\r\n};\r\n\r\nexport default function constraintSupported(constraint: keyof MyMediaTrackSupportedConstraints) {\r\n  return (!!navigator?.mediaDevices?.getSupportedConstraints() as any as MyMediaTrackSupportedConstraints)[constraint];\r\n}\r\n","export default function getScreenConstraints(skipAudio?: boolean) {\r\n  const constraints: DisplayMediaStreamConstraints = {\r\n   video: {\r\n      // @ts-ignore\r\n      // cursor: 'always',\r\n      width: {max: 1920},\r\n      height: {max: 1080},\r\n      frameRate: {max: 30}\r\n    }\r\n  };\r\n\r\n  if(!skipAudio) {\r\n    constraints.audio = true;\r\n  }\r\n\r\n  return constraints;\r\n}\r\n","export default async function getScreenStream(constraints: DisplayMediaStreamConstraints) {\r\n  const screenStream = await navigator.mediaDevices.getDisplayMedia(constraints);\r\n  const track = screenStream.getVideoTracks()[0];\r\n  track.contentHint = 'text';\r\n  return screenStream;\r\n}\r\n","export default async function getStream(constraints: MediaStreamConstraints, muted: boolean) {\r\n  // console.log('getStream', constraints);\r\n  \r\n\tconst stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n\tstream.getTracks().forEach((x) => {\r\n\t\t/* x.onmute = x => {\r\n\t\t\tconsole.log('track.onmute', x);\r\n\t\t};\r\n\t\tx.onunmute = x => {\r\n\t\t\tconsole.log('track.onunmute', x);\r\n\t\t}; */\r\n\r\n\t\tx.enabled = !muted;\r\n\t});\r\n\r\n\t// console.log('getStream result', stream);\r\n\treturn stream;\r\n}\r\n\r\n(window as any).getStream = getStream;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getScreenStream from \"./getScreenStream\";\r\nimport getStream from \"./getStream\";\r\n\r\n/**\r\n * ! Use multiple constraints together only with first invoke\r\n */\r\nexport default function getStreamCached() {\r\n  const _cache: {\r\n    main: Partial<{\r\n      audio: Promise<MediaStream>,\r\n      video: Promise<MediaStream>\r\n    }>,\r\n    screen: Partial<{\r\n      audio: Promise<MediaStream>,\r\n      video: Promise<MediaStream>\r\n    }>\r\n  } = {\r\n    main: {},\r\n    screen: {}\r\n  };\r\n\r\n  return async(options: {\r\n    isScreen: true, \r\n    constraints: DisplayMediaStreamConstraints,\r\n  } | {\r\n    isScreen?: false,\r\n    constraints: MediaStreamConstraints, \r\n    muted: boolean\r\n  }) => {\r\n    const {isScreen, constraints} = options;\r\n    const cache = _cache[isScreen ? 'screen' : 'main'];\r\n    let promise: Promise<MediaStream> = cache[constraints.audio ? 'audio' : 'video'];\r\n\r\n    if(!promise) {\r\n      promise = (isScreen ? getScreenStream : getStream)(constraints, (options as any).muted);\r\n      if(constraints.audio && !cache.audio) cache.audio = promise.finally(() => cache.audio = undefined);\r\n      if(constraints.video && !cache.video) cache.video = promise.finally(() => cache.video = undefined);\r\n    }\r\n\r\n    try {\r\n      return await promise;\r\n      /* let out: Partial<{\r\n        audio: MediaStream,\r\n        video: MediaStream\r\n      }> = {};\r\n\r\n      await Promise.all([\r\n        constraints.audio && cache.audio.then((stream) => out.audio = stream),\r\n        constraints.video && cache.video.then((stream) => out.video = stream)\r\n      ].filter(Boolean));\r\n\r\n      return out; */\r\n    } catch(err) {\r\n      throw err;\r\n    }\r\n  };\r\n}\r\n\r\n(window as any).getStreamCached = getStreamCached;\r\n","import simulateEvent from \"../../../helpers/dom/dispatchEvent\";\r\n\r\nexport default function stopTrack(track: MediaStreamTrack) {\r\n  track.stop();\r\n  simulateEvent(track, 'ended');\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nexport default class StringFromLineBuilder {\r\n  private lines: string[];\r\n  private newLine: string[];\r\n\r\n  constructor(private joiner = '\\r\\n') {\r\n    this.lines = [];\r\n    this.newLine = [];\r\n  }\r\n\r\n  public add(...strs: string[]) {\r\n    this.lines.push(...strs);\r\n    return this;\r\n  }\r\n\r\n  public push(word: string) {\r\n    this.newLine.push(word);\r\n    return this;\r\n  }\r\n  \r\n  public addJoined(separator = '') {\r\n    this.add(this.newLine.join(separator));\r\n    this.newLine = [];\r\n    return this;\r\n  }\r\n\r\n  public join() {\r\n    return this.lines.join(this.joiner);\r\n  }\r\n\r\n  public finalize() {\r\n    return this.join() + this.joiner;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\n/// NOTE: telegram returns sign source, while webrtc uses unsign source internally\r\n/// unsign => sign\r\nexport function toTelegramSource(source: number) {\r\n\treturn source << 0;\r\n}\r\n\r\n/// NOTE: telegram returns sign source, while webrtc uses unsign source internally\r\n/// sign => unsign\r\nexport function fromTelegramSource(source: number) {\r\n\treturn source >>> 0;\r\n}\r\n\r\nexport function getAmplitude(array: Uint8Array, scale = 3) {\r\n\tif(!array) return 0;\r\n\r\n\tconst {length} = array;\r\n\tlet total = 0;\r\n\tfor(let i = 0; i < length; ++i) {\r\n\t\ttotal += array[i] * array[i];\r\n\t}\r\n\tconst rms = Math.sqrt(total / length) / 255;\r\n\r\n\treturn Math.min(1, rms * scale);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_FIREFOX } from '../../environment/userAgent';\r\nimport LocalConferenceDescription, { ConferenceEntry } from './localConferenceDescription';\r\nimport StringFromLineBuilder from './stringFromLineBuilder';\r\nimport { GroupCallConnectionTransport, PayloadType, UpdateGroupCallConnectionData } from './types';\r\nimport { fromTelegramSource } from './utils';\r\n\r\n// screencast is for Peer-to-Peer only\r\nexport type WebRTCLineTypeTrue = 'video' | 'audio' | 'application';\r\nexport type WebRTCLineType = WebRTCLineTypeTrue | 'screencast';\r\n\r\nexport const WEBRTC_MEDIA_PORT = '9';\r\n\r\nexport function fixMediaLineType(mediaType: WebRTCLineType) {\r\n  return mediaType === 'screencast' ? 'video' : mediaType;\r\n}\r\n\r\nexport function performCandidate(c: GroupCallConnectionTransport['candidates'][0]) {\r\n  const arr: string[] = [];\r\n  arr.push('a=candidate:');\r\n  arr.push(`${c.foundation} ${c.component} ${c.protocol.toUpperCase()} ${c.priority} ${c.ip} ${c.port} typ ${c.type}`);\r\n  if(c['rel-addr'] !== undefined) {\r\n    arr.push(` raddr ${c['rel-addr']} rport ${c['rel-port']}`);\r\n  }\r\n  arr.push(` generation ${c.generation}`);\r\n  return arr.join('');\r\n}\r\n\r\nexport function getConnectionTypeForMediaType(mediaType: WebRTCLineType) {\r\n  // return mediaType === 'application' ? 'DTLS/SCTP' : 'RTP/SAVPF';\r\n  return mediaType === 'application' ? 'DTLS/SCTP' : 'UDP/TLS/RTP/SAVPF';\r\n}\r\n\r\nexport function generateMediaFirstLine(mediaType: WebRTCLineType, port = WEBRTC_MEDIA_PORT, payloadIds: (string | number)[]) {\r\n  const connectionType = getConnectionTypeForMediaType(mediaType);\r\n  return `m=${fixMediaLineType(mediaType)} ${port} ${connectionType} ${payloadIds.join(' ')}`;\r\n}\r\n\r\ntype ConferenceData = UpdateGroupCallConnectionData | LocalConferenceDescription;\r\n\r\n// https://tools.ietf.org/id/draft-ietf-rtcweb-sdp-08.html\r\n// https://datatracker.ietf.org/doc/html/draft-roach-mmusic-unified-plan-00\r\nexport class SDPBuilder extends StringFromLineBuilder {\r\n  public addCandidate(c: GroupCallConnectionTransport['candidates'][0]) {\r\n    return this.add(performCandidate(c));\r\n  }\r\n\r\n  /* public addDataChannel(mid: string, transport: GroupCallConnectionTransport, isAnswer?: boolean) {\r\n    this.add(\r\n      'm=application 9 UDP/DTLS/SCTP webrtc-datachannel',\r\n      'c=IN IP4 0.0.0.0',\r\n      'a=ice-options:trickle',\r\n      `a=mid:${mid}`\r\n    );\r\n\r\n    // if(!isAnswer) {\r\n      this.add('a=sendrecv');\r\n    // }\r\n\r\n    this.addTransport(transport, isAnswer);\r\n\r\n    return this.add(\r\n      'a=sctp-port:5000',\r\n      'a=max-message-size:262144'\r\n    );\r\n  } */\r\n  \r\n  public addHeader(sId: string, bundleMids: string[]) {\r\n    const bundle = bundleMids.join(' ');\r\n    return this.add(\r\n      'v=0',                          // version\r\n      `o=- ${sId} 2 IN IP4 0.0.0.0`,  // sessionId, 2=sessionVersion\r\n      's=-',                          // name of the session\r\n      't=0 0',                        // time when session is valid\r\n      'a=extmap-allow-mixed',\r\n      `a=group:BUNDLE ${bundle}`,\r\n      'a=ice-options:trickle',\r\n      // 'a=ice-lite',                   // ice-lite: is a minimal version of the ICE specification, intended for servers running on a public IP address.\r\n      'a=msid-semantic:WMS *'\r\n    );\r\n  }\r\n  \r\n  public addTransport(transport: GroupCallConnectionTransport, skipCandidates?: boolean) {\r\n    this.add(\r\n      `a=ice-ufrag:${transport.ufrag}`,\r\n      `a=ice-pwd:${transport.pwd}`,\r\n      'a=ice-options:trickle'           // ! test\r\n    );\r\n\r\n    for(const fingerprint of transport.fingerprints) {\r\n      this.add(\r\n        `a=fingerprint:${fingerprint.hash} ${fingerprint.fingerprint}`,\r\n        `a=setup:${fingerprint.setup}`\r\n      );\r\n    }\r\n\r\n    if(!skipCandidates && transport.candidates) {\r\n      for(const candidate of transport.candidates) {\r\n        this.addCandidate(candidate);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  public addSsrc(entry: ConferenceEntry) {\r\n    let streamName = 'stream';\r\n    let {type, sourceGroups} = entry;\r\n\r\n    // let source = ssrc.source ?? ssrc.sourceGroups[0].sources[0];\r\n    // source = fromTelegramSource(source);\r\n    const source = fromTelegramSource(entry.source);\r\n\r\n    streamName += source;\r\n    type += source as any;\r\n\r\n    // streamName += mid;\r\n    // type += mid as any;\r\n\r\n    // streamName = type = entry.transceiver.receiver.track.id as any;\r\n\r\n    const addMsid = () => {\r\n      this.add(`a=msid:${streamName} ${type}`);\r\n    };\r\n\r\n    const addSource = (ssrc: number) => {\r\n      this.add(\r\n        `a=ssrc:${ssrc} cname:${streamName}`,\r\n        `a=ssrc:${ssrc} msid:${streamName} ${type}`,\r\n        `a=ssrc:${ssrc} mslabel:${streamName}`,\r\n        `a=ssrc:${ssrc} label:${type}`\r\n      );\r\n    };\r\n\r\n    addMsid();\r\n    if(sourceGroups?.length) {\r\n      sourceGroups.forEach((ssrcGroup) => {\r\n        if(ssrcGroup.sources.length) {\r\n          const sources = ssrcGroup.sources.map(fromTelegramSource);\r\n          this.add(`a=ssrc-group:${ssrcGroup.semantics} ${sources.join(' ')}`);\r\n          sources.forEach(addSource);\r\n        }\r\n      });\r\n    } else {\r\n      addSource(source);\r\n    }\r\n  \r\n    return this;\r\n  }\r\n\r\n  public addSsrcEntry(entry: ConferenceEntry, data: ConferenceData, isAnswer?: boolean) {\r\n    const add = (...x: string[]) => this.add(...x);\r\n    \r\n    const {type, mid, direction, port} = entry;\r\n    const transport = data.transport;\r\n\r\n    /* if(type === 'application') {\r\n      return this.addDataChannel(mid, transport, isAnswer);\r\n    } */\r\n\r\n    const isApplication = type === 'application';\r\n    const codec = isApplication ? undefined : data[type];\r\n\r\n    const isInactive = direction === 'inactive';\r\n    if(entry.shouldBeSkipped(isAnswer)) {\r\n      return add(\r\n        `m=${fixMediaLineType(type)} 0 ${getConnectionTypeForMediaType(type)} 0`,\r\n        `c=IN IP4 0.0.0.0`,\r\n        `a=inactive`,\r\n        `a=mid:${mid}`\r\n      );\r\n    }\r\n    \r\n    const payloadTypes = !isApplication ? codec['payload-types'] : [{id: 5000} as PayloadType];\r\n    const ids = payloadTypes.map((type) => type.id);\r\n    add(\r\n      generateMediaFirstLine(type, port, ids),\r\n      'c=IN IP4 0.0.0.0',\r\n      `a=rtcp:${port} IN IP4 0.0.0.0`,\r\n    );\r\n\r\n    if(transport['rtcp-mux']) {\r\n      add('a=rtcp-mux');\r\n    }\r\n\r\n    add(`a=mid:${mid}`);\r\n    /* if(type === 'video') {\r\n      add('b=AS:2500');\r\n    } */\r\n\r\n    let setDirection = direction;\r\n    if(direction !== 'sendrecv' && isAnswer && !(isInactive || isApplication)) {\r\n      setDirection = direction === 'sendonly' ? 'recvonly' : 'sendonly';\r\n    }\r\n\r\n    // a=bundle-only\r\n    add(`a=${setDirection}`);\r\n    \r\n    // this.addTransport(transport, isAnswer);\r\n    this.addTransport(transport);\r\n\r\n    if(!isApplication) {\r\n      const hdrexts = codec['rtp-hdrexts'];\r\n      if(hdrexts?.length) {\r\n        hdrexts.forEach((hdrext) => {\r\n          add(`a=extmap:${hdrext.id} ${hdrext.uri}`);\r\n        });\r\n      }\r\n  \r\n      payloadTypes.forEach((type) => {\r\n        add(`a=rtpmap:${type.id} ${type.name}/${type.clockrate}${type.channels && type.channels > 1 ? `/${type.channels}` : ''}`);\r\n  \r\n        const parameters = type.parameters;\r\n        if(Array.isArray(parameters)) {\r\n          if(parameters.length) {\r\n            console.error('parameters is array???', parameters);\r\n          }\r\n        } else if(parameters && Object.keys(parameters).length) {\r\n          const p: string[] = [];\r\n          for(const i in parameters) {\r\n            p.push(`${i}=${parameters[i]}`);\r\n          }\r\n          add(`a=fmtp:${type.id} ${p.join(';')}`);\r\n        }\r\n  \r\n        const fbs = type['rtcp-fbs'];\r\n        if(fbs?.length) {\r\n          fbs.forEach((fb) => {\r\n            add(`a=rtcp-fb:${type.id} ${fb.type}${fb.subtype ? ' ' + fb.subtype : ''}`);\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n      add(`a=sctpmap:${payloadTypes[0].id} webrtc-datachannel 256`);\r\n    }\r\n\r\n    if(entry.source && (setDirection === 'sendonly' || setDirection === 'sendrecv')) {\r\n      this.addSsrc(entry);\r\n    }\r\n\r\n    return this;\r\n  }\r\n  \r\n  public addConference(options: {\r\n    conference: LocalConferenceDescription, \r\n    bundle: string[],\r\n    entries: ConferenceEntry[],\r\n    isAnswer?: boolean, \r\n  }) {\r\n    const {conference, entries, bundle, isAnswer} = options;\r\n    this.addHeader(conference.sessionId, bundle);\r\n\r\n    if(IS_FIREFOX) {\r\n      this.addTransport(conference.transport); // support Firefox\r\n    }\r\n\r\n    for(const entry of entries) {\r\n      // this.addSsrcEntry(entry, conference, isAnswer);\r\n      this.addSsrcEntry((isAnswer ? entry.recvEntry || entry.sendEntry : entry.sendEntry || entry.recvEntry) || entry, conference, isAnswer);\r\n    }\r\n\r\n    return this;\r\n  }\r\n  \r\n  public static fromConference(options: Parameters<SDPBuilder['addConference']>[0]) {\r\n    return new SDPBuilder().addConference(options).finalize();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport { logger } from '../logger';\r\nimport rootScope from '../rootScope';\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX } from './constants';\r\nimport stopTrack from './helpers/stopTrack';\r\nimport LocalConferenceDescription from './localConferenceDescription';\r\nimport { fixMediaLineType, WebRTCLineType } from './sdpBuilder';\r\nimport { getAmplitude, toTelegramSource } from './utils';\r\n\r\nexport type StreamItemBase = {\r\n  type: 'input' | 'output',\r\n  track: MediaStreamTrack,\r\n  source: string,\r\n  stream: MediaStream\r\n};\r\n\r\nexport type StreamItem = StreamAudioItem | StreamVideoItem;\r\n\r\nexport type StreamAudioItem = StreamItemBase & {kind: 'audio', streamAnalyser: AudioStreamAnalyser};\r\nexport type StreamVideoItem = StreamItemBase & {kind: 'video'};\r\n\r\nexport type StreamAmplitude = {\r\n  type: \"input\" | \"output\";\r\n  source: string;\r\n  stream: MediaStream;\r\n  track: MediaStreamTrack;\r\n  value: number;\r\n};\r\n\r\nclass AudioStreamAnalyser {\r\n  public analyser: AnalyserNode;\r\n  public gain: GainNode;\r\n  public streamSource: MediaStreamAudioSourceNode;\r\n\r\n  constructor(context: AudioContext, stream: MediaStream) {\r\n    const streamSource = this.streamSource = context.createMediaStreamSource(stream);\r\n    const analyser = this.analyser = context.createAnalyser();\r\n    const gain = this.gain = context.createGain();\r\n    // const streamDestination = context.createMediaStreamDestination();\r\n    \r\n    analyser.minDecibels = -100;\r\n    analyser.maxDecibels = -30;\r\n    analyser.smoothingTimeConstant = 0.05;\r\n    analyser.fftSize = 1024;\r\n    \r\n    // connect Web Audio API\r\n    streamSource.connect(analyser);\r\n    // analyser.connect(context.destination);\r\n  }\r\n}\r\n\r\nexport default class StreamManager {\r\n  public static ANALYSER_LISTENER = new EventListenerBase<{amplitude: (details: {amplitudes: StreamAmplitude[], type: 'all' | 'input'}) => void}>();\r\n  private context: AudioContext;\r\n  public outputStream: MediaStream;\r\n  public inputStream: MediaStream;\r\n\r\n  private timer: number;\r\n  private counter: number;\r\n\r\n  private items: StreamItem[];\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  public direction: RTCRtpTransceiver['direction'];\r\n  public canCreateConferenceEntry: boolean;\r\n  public locked: boolean;\r\n  public types: WebRTCLineType[];\r\n  \r\n  constructor(private interval?: number) {\r\n    this.context = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n    this.items = [];\r\n    this.outputStream = new MediaStream();\r\n    this.inputStream = new MediaStream();\r\n    this.counter = 0;\r\n    this.log = logger('SM');\r\n    this.direction = 'sendonly';\r\n    this.canCreateConferenceEntry = true;\r\n    // this.lol = true;\r\n    this.types = ['audio', 'video'];\r\n  }\r\n\r\n  public addStream(stream: MediaStream, type: StreamItem['type']) {\r\n    stream.getTracks().forEach((track) => {\r\n      this.addTrack(stream, track, type);\r\n    });\r\n  }\r\n\r\n  public addTrack(stream: MediaStream, track: MediaStreamTrack, type: StreamItem['type']) {\r\n    this.log('addTrack', type, track, stream);\r\n\r\n    const {context, items, inputStream, outputStream} = this;\r\n    const kind: StreamItem['kind'] = track.kind as any;\r\n    const source = StreamManager.getSource(stream, type);\r\n    \r\n    // this.removeTrack(track);\r\n    switch(type) {\r\n      case 'input': {\r\n        if(!inputStream) {\r\n          this.inputStream = stream;\r\n        } else {\r\n          inputStream.addTrack(track);\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'output': {\r\n        for(let i = 0; i < items.length; ++i) {\r\n          const {track: t, type, source: itemSource} = items[i];\r\n          if(itemSource === source && type === 'input') {\r\n            items.splice(i, 1);\r\n            outputStream.removeTrack(t);\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if(kind !== 'video') {\r\n          outputStream.addTrack(track);\r\n        }\r\n        \r\n        break;\r\n      }\r\n    }\r\n\r\n    this.finalizeAddingTrack({\r\n      type,\r\n      source,\r\n      stream,\r\n      track,\r\n      kind,\r\n      streamAnalyser: kind === 'audio' ? new AudioStreamAnalyser(context, stream) : undefined\r\n    });\r\n\r\n    if(kind === 'audio' && this.interval) {\r\n      this.changeTimer();\r\n    }\r\n  }\r\n\r\n  private finalizeAddingTrack(item: StreamItem) {\r\n    const {track} = item;\r\n    track.addEventListener('ended', () => {\r\n      this.removeTrack(track);\r\n    }, {once: true});\r\n\r\n    this.items.push(item);\r\n  }\r\n\r\n  public hasInputTrackKind(kind: StreamItem['kind']) {\r\n    return this.items.find((item) => item.type === 'input' && item.kind === kind);\r\n  }\r\n\r\n  public static getSource(stream: MediaStream, type: StreamItem['type']) {\r\n    return type === 'input' ? (stream.source || stream.id) : '' + toTelegramSource(+stream.id.substring(6));\r\n  }\r\n  \r\n  public removeTrack(track: MediaStreamTrack) {\r\n    this.log('removeTrack', track);\r\n\r\n    const {items} = this;\r\n    \r\n    let handled = false;\r\n    for(let i = 0, length = items.length; !handled && i < length; ++i) {\r\n      const {track: t, type} = items[i];\r\n      switch(type) {\r\n        case 'output': {\r\n          if(t === track) {\r\n            items.splice(i, 1);\r\n            this.outputStream.removeTrack(track);\r\n            handled = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'input': {\r\n          if(t === track) {\r\n            items.splice(i, 1);\r\n            this.inputStream.removeTrack(track);\r\n            handled = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(track.kind === 'audio' && this.interval) {\r\n      this.changeTimer();\r\n    }\r\n  }\r\n  \r\n  public replaceInputAudio(stream: MediaStream, oldTrack: MediaStreamTrack) {\r\n    this.removeTrack(oldTrack);\r\n    this.addStream(stream, 'input');\r\n  }\r\n  \r\n  private changeTimer() {\r\n    if(this.timer !== undefined) {\r\n      clearInterval(this.timer);\r\n    }\r\n    \r\n    if(this.items.length) {\r\n      this.timer = window.setInterval(this.analyse, this.interval);\r\n    }\r\n  }\r\n  \r\n  public getAmplitude = (item: StreamAudioItem): StreamAmplitude => {\r\n    const {streamAnalyser, stream, track, source, type} = item;\r\n    const analyser = streamAnalyser.analyser;\r\n    if(!analyser) return;\r\n    \r\n    const array = new Uint8Array(analyser.frequencyBinCount);\r\n    analyser.getByteFrequencyData(array);\r\n    const value = getAmplitude(array);\r\n    \r\n    return {\r\n      type,\r\n      source,\r\n      stream,\r\n      track,\r\n      value\r\n    };\r\n  };\r\n  \r\n  public analyse = () => {\r\n    const all = this.counter % 3 === 0;\r\n    const filteredItems = all ? this.items : this.items.filter((x) => x.type === 'input');\r\n    const audioItems = filteredItems.filter((x) => x.kind === 'audio') as StreamAudioItem[];\r\n    const amplitudes = audioItems.slice(0, GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX).map(this.getAmplitude);\r\n    if(++this.counter >= 1000) {\r\n      this.counter = 0;\r\n    }\r\n    \r\n    StreamManager.ANALYSER_LISTENER.dispatchEvent('amplitude', {\r\n      amplitudes,\r\n      type: all ? 'all' : 'input'\r\n    });\r\n  };\r\n\r\n  /* public appendToConnection(connection: RTCPeerConnection) {\r\n    if(this.inputStream) {\r\n      this.inputStream.getTracks().forEach((track) => {\r\n        connection.log('addTrack', track);\r\n        connection.addTrack(track, this.inputStream);\r\n\r\n        if(track.kind === 'video') {\r\n          track.enabled = true;\r\n        }\r\n      });\r\n    }\r\n  } */\r\n\r\n  public appendToConference(conference: LocalConferenceDescription) {\r\n    if(this.locked) {\r\n      return;\r\n    }\r\n    \r\n    const {inputStream, direction, canCreateConferenceEntry} = this;\r\n    const transceiverInit: RTCRtpTransceiverInit = {direction, streams: [inputStream]};\r\n    const types = this.types.map((type) => {\r\n      return [\r\n        type, \r\n        /* type === 'video' || type === 'screencast' ? \r\n          {sendEncodings: [{maxBitrate: 2500000}], ...transceiverInit} :  */\r\n          transceiverInit\r\n      ] as const;\r\n    });\r\n\r\n    const tracks = inputStream.getTracks();\r\n    // const transceivers = conference.connection.getTransceivers();\r\n    for(const [type, transceiverInit] of types) {\r\n      let entry = conference.findEntry((entry) => entry.direction === direction && entry.type === type);\r\n      if(!entry) {\r\n        if(!canCreateConferenceEntry) {\r\n          continue;\r\n        }\r\n\r\n        entry = conference.createEntry(type);\r\n      }\r\n      /* const entry = conference.findFreeSendRecvEntry(type, true);\r\n      if(!entry.transceiver) {\r\n        entry.transceiver = transceivers.find((transceiver) => transceiver.mid === entry.mid);\r\n      } */\r\n\r\n      let {transceiver} = entry;\r\n      if(!transceiver) {\r\n        transceiver = entry.createTransceiver(conference.connection, transceiverInit);\r\n\r\n        /* if(this.isScreenSharingManager) {\r\n          transceiver.sender.setParameters({\r\n            ...transceiver.sender.getParameters(),\r\n            degradationPreference: 'maintain-resolution'\r\n          });\r\n        } */\r\n      }\r\n\r\n      if(entry.direction !== transceiver.direction) {\r\n        transceiver.direction = entry.direction;\r\n      }\r\n\r\n      const mediaTrackType = fixMediaLineType(type);\r\n      const trackIdx = tracks.findIndex((track) => track.kind === mediaTrackType);\r\n      const track = trackIdx !== -1 ? tracks.splice(trackIdx, 1)[0] : undefined;\r\n      const sender = transceiver.sender;\r\n      if(sender.track === track) {\r\n        continue;\r\n      }\r\n\r\n      // try { // ! don't use await here. it will wait for adding track and fake one won't be visible in startNegotiation.\r\n        /* await  */sender.replaceTrack(track).catch((err) => {\r\n          this.log.error(err);\r\n        });\r\n      // } catch(err) {\r\n\r\n      // }\r\n    }\r\n  }\r\n\r\n  public stop() {\r\n    try {\r\n      const tracks = this.inputStream.getTracks().concat(this.outputStream.getTracks());\r\n      tracks.forEach((track) => {\r\n        stopTrack(track);\r\n      });\r\n    } catch(e) {\r\n      this.log.error(e);\r\n    }\r\n  }\r\n}\r\n","export const GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX = 50;\r\nexport const GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS = 100;\r\nexport const GROUP_CALL_PARTICIPANTS_LOAD_LIMIT = 100;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase, { EventListenerListeners } from \"../../helpers/eventListenerBase\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { logger } from \"../logger\";\r\nimport getAudioConstraints from \"./helpers/getAudioConstraints\";\r\nimport getScreenConstraints from \"./helpers/getScreenConstraints\";\r\nimport getStreamCached from \"./helpers/getStreamCached\";\r\nimport getVideoConstraints from \"./helpers/getVideoConstraints\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport LocalConferenceDescription from \"./localConferenceDescription\";\r\nimport StreamManager, { StreamItem } from \"./streamManager\";\r\n\r\nexport type TryAddTrackOptions = {\r\n  stream: MediaStream, \r\n  track: MediaStreamTrack, \r\n  type: StreamItem['type'], \r\n  source?: string\r\n};\r\n\r\nexport default abstract class CallInstanceBase<E extends EventListenerListeners> extends EventListenerBase<E> {\r\n  protected log: ReturnType<typeof logger>;\r\n  protected outputDeviceId: string;\r\n\r\n  protected player: HTMLElement;\r\n  protected elements: Map<string, HTMLMediaElement>;\r\n\r\n  protected audio: HTMLAudioElement;\r\n  // protected fixedSafariAudio: boolean;\r\n\r\n  protected getStream: ReturnType<typeof getStreamCached>;\r\n\r\n  constructor() {\r\n    super(false);\r\n\r\n    const player = this.player = document.createElement('div');\r\n    player.classList.add('call-player');\r\n    player.style.display = 'none';\r\n    document.body.append(player);\r\n\r\n    this.elements = new Map();\r\n\r\n    // possible Safari fix\r\n    const audio = this.audio = new Audio();\r\n    audio.autoplay = true;\r\n    audio.volume = 1.0;\r\n    this.player.append(audio);\r\n    this.elements.set('audio', audio);\r\n\r\n    this.fixSafariAudio();\r\n\r\n    this.getStream = getStreamCached();\r\n  }\r\n\r\n  public get isSharingAudio() {\r\n    return !!this.streamManager.hasInputTrackKind('audio');\r\n  }\r\n\r\n  public get isSharingVideo() {\r\n    return !!this.streamManager.hasInputTrackKind('video');\r\n  }\r\n\r\n  public abstract get isMuted(): boolean;\r\n  public abstract get isClosing(): boolean;\r\n\r\n  public fixSafariAudio() {\r\n    // if(this.fixedSafariAudio) return;\r\n    this.audio.play().catch(noop);\r\n    // this.fixedSafariAudio = true;\r\n  }\r\n\r\n  public requestAudioSource(muted: boolean) {\r\n    return this.requestInputSource(true, false, muted);\r\n  }\r\n\r\n  public requestInputSource(audio: boolean, video: boolean, muted: boolean) {\r\n    const {streamManager} = this;\r\n    if(streamManager) {\r\n      const isAudioGood = !audio || this.isSharingAudio;\r\n      const isVideoGood = !video || this.isSharingVideo;\r\n      if(isAudioGood && isVideoGood) {\r\n        return Promise.resolve();\r\n      }\r\n    }\r\n\r\n    const constraints: MediaStreamConstraints = {\r\n      audio: audio && getAudioConstraints(),\r\n      video: video && getVideoConstraints()\r\n    };\r\n    \r\n    return this.getStream({\r\n      constraints, \r\n      muted\r\n    }).then((stream) => {\r\n      this.onInputStream(stream);\r\n    });\r\n  }\r\n\r\n  public requestScreen() {\r\n    return this.getStream({\r\n      isScreen: true,\r\n      constraints: getScreenConstraints(true)\r\n    }).then((stream) => {\r\n      this.onInputStream(stream);\r\n    });\r\n  }\r\n\r\n  public getElement(endpoint: number | string) {\r\n    return this.elements.get('' + endpoint);\r\n  }\r\n\r\n  public abstract get streamManager(): StreamManager;\r\n  public abstract get description(): LocalConferenceDescription;\r\n  public abstract toggleMuted(): Promise<void>;\r\n\r\n  public cleanup() {\r\n    this.player.textContent = '';\r\n    this.player.remove();\r\n    this.elements.clear();\r\n\r\n    // can have no connectionInstance but streamManager with input stream\r\n    this.streamManager.stop();\r\n\r\n    super.cleanup();\r\n  }\r\n\r\n  public onTrack(event: RTCTrackEvent) {\r\n    this.tryAddTrack({\r\n      stream: event.streams[0], \r\n      track: event.track, \r\n      type: 'output'\r\n    });\r\n  }\r\n\r\n  public saveInputVideoStream(stream: MediaStream, type?: string) {\r\n    const track = stream.getVideoTracks()[0];\r\n    this.tryAddTrack({\r\n      stream, \r\n      track, \r\n      type: 'input', \r\n      source: type || 'main'\r\n    });\r\n  }\r\n  \r\n  public tryAddTrack({stream, track, type, source}: TryAddTrackOptions) {\r\n    if(!source) {\r\n      source = StreamManager.getSource(stream, type);\r\n    }\r\n\r\n    this.log('tryAddTrack', stream, track, type, source);\r\n\r\n    const isOutput = type === 'output';\r\n\r\n    const {player, elements, streamManager} = this;\r\n    \r\n    const tagName = track.kind as StreamItem['kind'];\r\n    const isVideo = tagName === 'video';\r\n\r\n    const elementEndpoint = isVideo ? source : tagName;\r\n    let element = elements.get(elementEndpoint);\r\n\r\n    if(isVideo) {\r\n      track.addEventListener('ended', () => {\r\n        this.log('[track] onended');\r\n        elements.delete(elementEndpoint);\r\n        // element.remove();\r\n      }, {once: true});\r\n    }\r\n    \r\n    if(isOutput) {\r\n      streamManager.addTrack(stream, track, type);\r\n    }\r\n\r\n    const useStream = isVideo ? stream : streamManager.outputStream;\r\n    if(!element) {\r\n      element = document.createElement(tagName);\r\n      element.autoplay = true;\r\n      element.srcObject = useStream;\r\n      element.volume = 1.0;\r\n\r\n      if((element as any).sinkId !== 'undefined') {\r\n        const {outputDeviceId} = this;\r\n        if(outputDeviceId) {\r\n          (element as any).setSinkId(outputDeviceId);\r\n        }\r\n      }\r\n      \r\n      if(!isVideo) {\r\n        player.appendChild(element);\r\n      } else {\r\n        element.setAttribute('playsinline', 'true');\r\n        element.muted = true;\r\n      }\r\n      // audio.play();\r\n\r\n      elements.set(elementEndpoint, element);\r\n    } else {\r\n      if(element.paused) {\r\n        element.play().catch(noop);\r\n      }\r\n\r\n      // ! EVEN IF MEDIASTREAM IS THE SAME NEW TRACK WON'T PLAY WITHOUT REPLACING IT WHEN NEW PARTICIPANT IS ENTERING !\r\n      // if(element.srcObject !== useStream) {\r\n        element.srcObject = useStream;\r\n      // }\r\n    }\r\n\r\n    return source;\r\n  }\r\n\r\n  public setMuted(muted?: boolean) {\r\n    this.streamManager.inputStream.getAudioTracks().forEach((track) => {\r\n      if(track?.kind === 'audio') {\r\n        track.enabled = muted === undefined ? !track.enabled : !muted;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected onInputStream(stream: MediaStream): void {\r\n    if(!this.isClosing) {\r\n      const videoTracks = stream.getVideoTracks();\r\n      if(videoTracks.length) {\r\n        this.saveInputVideoStream(stream, 'main');\r\n      }\r\n\r\n      const {streamManager, description} = this;\r\n      streamManager.addStream(stream, 'input');\r\n      \r\n      if(description) {\r\n        streamManager.appendToConference(description);\r\n      }\r\n    } else { // if call is declined earlier than stream appears\r\n      stream.getTracks().forEach((track) => {\r\n        stopTrack(track);\r\n      });\r\n    }\r\n  }\r\n}\r\n","export default function getVideoConstraints(): MediaTrackConstraints {\r\n  return {\r\n    width: {min: 1280, max: 1920/* , ideal: 1920 */},\r\n    height: {min: 720, max: 1080/* , ideal: 1080 */},\r\n    frameRate: {min: 24, max: 30}\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from '../../helpers/array/indexOfAndSplice';\r\nimport safeAssign from '../../helpers/object/safeAssign';\r\nimport { GroupCallParticipantVideoSourceGroup } from '../../layer';\r\nimport { fixMediaLineType, SDPBuilder, WebRTCLineType, WEBRTC_MEDIA_PORT } from './sdpBuilder';\r\nimport { AudioCodec, GroupCallConnectionTransport, Ssrc, UpdateGroupCallConnectionData, VideoCodec } from './types';\r\n\r\nexport class ConferenceEntry {\r\n  public source: number;\r\n  public sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n  public transceiver: RTCRtpTransceiver;\r\n  public originalDirection: RTCRtpTransceiverDirection;\r\n  public direction: RTCRtpTransceiverDirection;\r\n  public port: string;\r\n  public endpoint: string;\r\n  public peerId: PeerId;\r\n  \r\n  public sendEntry: ConferenceEntry;\r\n  public recvEntry: ConferenceEntry;\r\n\r\n  constructor(public mid: string, public type: WebRTCLineType) {\r\n    this.port = WEBRTC_MEDIA_PORT;\r\n  }\r\n\r\n  public setDirection(direction: RTCRtpTransceiverDirection) {\r\n    if(!this.originalDirection) {\r\n      this.originalDirection = direction;\r\n    }\r\n\r\n    return this.direction = direction;\r\n  }\r\n\r\n  public setPort(port: string) {\r\n    return this.port = port;\r\n  }\r\n\r\n  public setEndpoint(endpoint: string) {\r\n    return this.endpoint = endpoint;\r\n  }\r\n\r\n  public setPeerId(peerId: PeerId) {\r\n    return this.peerId = peerId;\r\n  }\r\n\r\n  public createTransceiver(connection: RTCPeerConnection, init?: RTCRtpTransceiverInit) {\r\n    if(init?.direction) {\r\n      this.setDirection(init.direction);\r\n    }\r\n\r\n    return this.transceiver = connection.addTransceiver(fixMediaLineType(this.type), init);\r\n  }\r\n\r\n  public setSource(source: number | GroupCallParticipantVideoSourceGroup[]) {\r\n    let sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n    if(Array.isArray(source)) {\r\n      if(!source[0]) return;\r\n      sourceGroups = source;\r\n      source = sourceGroups[0].sources[0];\r\n    }\r\n\r\n    this.sourceGroups = sourceGroups;\r\n    return this.source = source;\r\n  }\r\n\r\n  public shouldBeSkipped(isAnswer?: boolean) {\r\n    return isAnswer && this.direction === 'inactive';\r\n  }\r\n}\r\n\r\nexport function generateSsrc(type: WebRTCLineType, source: number | GroupCallParticipantVideoSourceGroup[], endpoint?: string): Ssrc {\r\n  let sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n  if(Array.isArray(source)) {\r\n    if(!source[0]) return;\r\n    sourceGroups = source;\r\n    source = sourceGroups[0].sources[0];\r\n  }\r\n  \r\n  return {\r\n    endpoint,\r\n    type,\r\n    source,\r\n    sourceGroups,\r\n  };\r\n}\r\n\r\nexport default class LocalConferenceDescription implements UpdateGroupCallConnectionData {\r\n  public readonly sessionId: string;\r\n  // public ssrcs: Ssrc[];\r\n  public readonly transport: GroupCallConnectionTransport;\r\n  public readonly audio?: AudioCodec;\r\n  public readonly video: VideoCodec;\r\n  public readonly screencast?: VideoCodec;\r\n  \r\n  private maxSeenId: number;\r\n  public readonly entries: ConferenceEntry[];\r\n  private entriesByMid: Map<ConferenceEntry['mid'], ConferenceEntry>;\r\n  private entriesBySource: Map<ConferenceEntry['source'], ConferenceEntry>;\r\n  private entriesByPeerId: Map<ConferenceEntry['peerId'], Set<ConferenceEntry>>;\r\n  \r\n  constructor(public connection: RTCPeerConnection) {\r\n    this.sessionId = '' + Date.now();\r\n    // this.ssrcs = [];\r\n    this.maxSeenId = -1;\r\n    this.entries = [];\r\n    this.entriesByMid = new Map();\r\n    this.entriesBySource = new Map();\r\n    this.entriesByPeerId = new Map();\r\n  }\r\n\r\n  public setData(data: UpdateGroupCallConnectionData) {\r\n    return safeAssign(this, data);\r\n  }\r\n\r\n  public createEntry(type: WebRTCLineType) {\r\n    const mid = '' + ++this.maxSeenId;\r\n    const entry = new ConferenceEntry(mid, type);\r\n    this.entries.push(entry);\r\n    this.entriesByMid.set(mid, entry);\r\n    return entry;\r\n  }\r\n\r\n  public deleteEntry(entry: ConferenceEntry) {\r\n    indexOfAndSplice(this.entries, entry);\r\n    this.entriesByMid.delete(entry.mid);\r\n    this.entriesBySource.delete(entry.source);\r\n\r\n    const set = this.entriesByPeerId.get(entry.peerId);\r\n    if(set) {\r\n      set.delete(entry);\r\n      if(!set.size) {\r\n        this.entriesByPeerId.delete(entry.peerId);\r\n      }\r\n    }\r\n  }\r\n\r\n  public setEntrySource(entry: ConferenceEntry, source: Parameters<ConferenceEntry['setSource']>[0]) {\r\n    entry.setSource(source);\r\n    this.entriesBySource.set(entry.source, entry);\r\n  }\r\n\r\n  public setEntryPeerId(entry: ConferenceEntry, peerId: ConferenceEntry['peerId']) {\r\n    entry.setPeerId(peerId);\r\n    let set = this.entriesByPeerId.get(peerId);\r\n    if(!set) {\r\n      this.entriesByPeerId.set(peerId, set = new Set());\r\n    }\r\n\r\n    set.add(entry);\r\n  }\r\n  \r\n  public findEntry(verify: Parameters<LocalConferenceDescription['entries']['find']>[0]) {\r\n    return this.entries.find(verify);\r\n  }\r\n\r\n  public findFreeSendRecvEntry(type: WebRTCLineType, isSending: boolean) {\r\n    let entry = this.entries.find((entry) => {\r\n      return entry.direction === 'sendrecv' && entry.type === type && !(isSending ? entry.sendEntry : entry.recvEntry);\r\n    });\r\n\r\n    if(!entry) {\r\n      entry = this.createEntry(type);\r\n      entry.setDirection('sendrecv');\r\n    }\r\n\r\n    return entry;\r\n  }\r\n  \r\n  public getEntryByMid(mid: ConferenceEntry['mid']) {\r\n    return this.entriesByMid.get(mid);\r\n  }\r\n\r\n  public getEntryBySource(source: ConferenceEntry['source']) {\r\n    return this.entriesBySource.get(source);\r\n  }\r\n\r\n  public getEntriesByPeerId(peerId: ConferenceEntry['peerId']) {\r\n    return this.entriesByPeerId.get(peerId);\r\n  }\r\n\r\n  public generateSdp(options: Omit<Parameters<SDPBuilder['addConference']>[0], 'conference'>) {\r\n    return SDPBuilder.fromConference({\r\n      conference: this,\r\n      ...options\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { logger } from \"../logger\";\r\nimport createDataChannel from \"./helpers/createDataChannel\";\r\nimport createPeerConnection from \"./helpers/createPeerConnection\";\r\nimport LocalConferenceDescription from \"./localConferenceDescription\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\n\r\nexport type CallConnectionInstanceOptions = {\r\n  streamManager: StreamManager,\r\n  connection?: RTCPeerConnection,\r\n  log?: ReturnType<typeof logger>\r\n};\r\n\r\nexport default abstract class CallConnectionInstanceBase {\r\n  public connection: RTCPeerConnection;\r\n  public streamManager: StreamManager;\r\n  public dataChannel: RTCDataChannel;\r\n  public description: LocalConferenceDescription;\r\n  public sources: {\r\n    audio: Ssrc,\r\n    video?: Ssrc,\r\n  };\r\n  protected negotiating: Promise<void>;\r\n  protected log: ReturnType<typeof logger>;\r\n\r\n  constructor(options: CallConnectionInstanceOptions) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.log) {\r\n      this.log = this.connection?.log || logger('CALL-CONNECTION-BASE');\r\n    }\r\n\r\n    this.sources = {} as any;\r\n  }\r\n\r\n  public createPeerConnection(config?: RTCConfiguration) {\r\n    return this.connection || (this.connection = createPeerConnection(config, this.log.bindPrefix('connection')).connection);\r\n  }\r\n\r\n  public createDataChannel(dict?: RTCDataChannelInit) {\r\n    return this.dataChannel || (this.dataChannel = createDataChannel(this.connection, dict, this.log.bindPrefix('data')));\r\n  }\r\n\r\n  public createDescription() {\r\n    return this.description || (this.description = new LocalConferenceDescription(this.connection));\r\n  }\r\n\r\n  public appendStreamToConference() {\r\n    return this.streamManager.appendToConference(this.description);\r\n  }\r\n\r\n  public closeConnection() {\r\n    const {connection} = this;\r\n    if(!connection) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      connection.log('close');\r\n      connection.close();\r\n    } catch(e) {\r\n      this.log.error(e);\r\n    }\r\n  }\r\n\r\n  public closeConnectionAndStream(stopStream: boolean) {\r\n    this.closeConnection();\r\n    stopStream && this.streamManager.stop();\r\n  }\r\n\r\n  protected abstract negotiateInternal(): CallConnectionInstanceBase['negotiating'];\r\n\r\n  public negotiate() {\r\n    let promise = this.negotiating;\r\n    if(promise) {\r\n      return promise;\r\n    }\r\n\r\n    return this.negotiating = this.negotiateInternal().finally(() => {\r\n      this.negotiating = undefined;\r\n    });\r\n  }\r\n\r\n  public sendDataChannelData(data: any) {\r\n    if(this.dataChannel.readyState !== 'open') {\r\n      return;\r\n    }\r\n\r\n    this.dataChannel.send(JSON.stringify(data));\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Logger, logger } from \"../../logger\";\r\n\r\nexport default function createPeerConnection(config: RTCConfiguration, log?: Logger) {\r\n  if(!log) {\r\n    log = logger('RTCPeerConnection');\r\n  }\r\n\r\n  log('constructor');\r\n\r\n  // @ts-ignore\r\n  const connection = new RTCPeerConnection(config);\r\n  connection.addEventListener('track', (event) => {\r\n    log('ontrack', event);\r\n  });\r\n  connection.addEventListener('signalingstatechange', () => {\r\n    log('onsignalingstatechange', connection.signalingState);\r\n  });\r\n  connection.addEventListener('connectionstatechange', () => {\r\n    log('onconnectionstatechange', connection.connectionState);\r\n  });\r\n  connection.addEventListener('negotiationneeded', () => { // * will be fired every time input device changes\r\n    log('onnegotiationneeded', connection.signalingState);\r\n  });\r\n  connection.addEventListener('icecandidate', (event) => {\r\n    log('onicecandidate', event);\r\n  });\r\n  connection.addEventListener('iceconnectionstatechange', () => {\r\n    log('oniceconnectionstatechange', connection.iceConnectionState);\r\n  });\r\n  connection.addEventListener('datachannel', () => {\r\n    log('ondatachannel');\r\n  });\r\n\r\n  connection.log = log;\r\n\r\n  return {connection};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Logger, logger } from \"../../logger\";\r\n\r\nexport default function createDataChannel(connection: RTCPeerConnection, dict?: RTCDataChannelInit, log?: Logger) {\r\n  // return;\r\n\r\n  if(!log) {\r\n    log = logger('RTCDataChannel');\r\n  }\r\n\r\n  const channel = connection.createDataChannel('data', dict);\r\n\r\n  channel.addEventListener('message', (e) => {\r\n    log('onmessage', e);\r\n  });\r\n  channel.addEventListener('open', () => {\r\n    log('onopen');\r\n  });\r\n  channel.addEventListener('close', () => {\r\n    log('onclose');\r\n  });\r\n\r\n  channel.log = log;\r\n\r\n  return channel;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPMediaSection from \"./mediaSection\";\r\nimport SDPSessionSection from \"./sessionSection\";\r\n\r\nexport type AttributeKey = 'group' | 'rtcp' | 'ice-ufrag' | \r\n  'ice-pwd' | 'ice-options' | 'fingerprint' | 'setup' | \r\n  'mid' | 'extmap' | 'sendonly' | 'msid' | 'rtcp-mux' | \r\n  'rtpmap' | 'rtcp-fb' | 'fmtp' | 'ssrc' | 'ssrc-group' |\r\n  'extmap-allow-mixed' | 'msid-semantic';\r\n\r\nexport type AttributeMap = {[k in AttributeKey]?: boolean};\r\n\r\nexport default class SDP {\r\n  #session: SDPSessionSection;\r\n  #media: SDPMediaSection[];\r\n\r\n  constructor(session: SDP['session'], mediaSections: SDP['media']) {\r\n    this.#session = session;\r\n    this.#media = mediaSections;\r\n  }\r\n\r\n  public get session() {\r\n    return this.#session;\r\n  }\r\n\r\n  public get media() {\r\n    return this.#media;\r\n  }\r\n\r\n  public get bundle() {\r\n    const bundleLine = this.session.lines.find((line) => line.parsed?.key === 'group');\r\n    return bundleLine.value.split(' ').slice(1);\r\n  }\r\n\r\n  toString() {\r\n    return this.session.lines\r\n    .concat(...this.media.map((section) => section.lines))\r\n    .map((line) => line.toString()).join('\\r\\n') + '\\r\\n';\r\n  }\r\n\r\n  /* get buggedMedia() {\r\n    const bundle = this.bundle;\r\n    type A = {\r\n      mid: SDPMediaSection['mid'],\r\n      mediaType: SDPMediaSection['mediaType'],\r\n      direction: SDPMediaSection['direction']\r\n    };\r\n    const out: A[] = [];\r\n    for(let i = 0, length = this.media.length; i < length; ++i) {\r\n      const section = this.media[i];\r\n      const mid = section.mid;\r\n      if(!bundle.includes(mid)) {\r\n        out.push(section);\r\n      }\r\n    }\r\n\r\n    return out;\r\n  } */\r\n\r\n  /* get mediaTypes() {\r\n    return this.media.map((section) => {\r\n      return {mid: section.oa.get('mid').oa, type: section.mediaType, direction: section.direction};\r\n    });\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function splitStringByLimitWithRest(str: string, separator: string, limit: number) {\r\n  const splitted = str.split(separator);\r\n  const out: string[] = [];\r\n\r\n  while(limit > 0 && splitted.length) {\r\n    out.push(splitted.shift());\r\n    --limit;\r\n  }\r\n\r\n  if(splitted.length) {\r\n    out.push(splitted.join(separator));\r\n  }\r\n\r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class UniqueNumberGenerator {\r\n  #set: Set<number>;\r\n  #min: number;\r\n  #max: number;\r\n\r\n  constructor(min: number, max: number) {\r\n    this.#set = new Set();\r\n    this.#min = min;\r\n    this.#max = max;\r\n  }\r\n\r\n  public generate() {\r\n    const min = this.#min;\r\n    const max = this.#max;\r\n    const set = this.#set;\r\n\r\n    const maxTries = max - min + 1;\r\n    let value = Math.floor(min + maxTries * Math.random()), _try = 0;\r\n    while(set.has(value)) {\r\n      if(value < max) {\r\n        ++value;\r\n      } else {\r\n        value = min;\r\n      }\r\n\r\n      if(++_try >= maxTries) {\r\n        return null;\r\n      }\r\n    }\r\n\r\n    set.add(value);\r\n    return value;\r\n  }\r\n\r\n  public add(value: number) {\r\n    this.#set.add(value);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AttributeKey } from \".\";\r\n\r\nexport default class SDPAttributeSplitted {\r\n  #key: AttributeKey;\r\n  #value: string;\r\n\r\n  // key = 'ssrc-group', value = 'SIM 1 2 3'\r\n  constructor(key: AttributeKey, value: string) {\r\n    this.#key = key;\r\n    this.#value = value;\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#value;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class SDPMediaLineParts {\r\n  #type: 'audio' | 'video' | 'application';\r\n  #port: string;\r\n  #protocol: string;\r\n  #ids: string[];\r\n\r\n  constructor(\r\n    type: SDPMediaLineParts['type'], \r\n    port: SDPMediaLineParts['port'], \r\n    protocol: SDPMediaLineParts['protocol'], \r\n    ids: SDPMediaLineParts['ids']\r\n  ) {\r\n    this.#type = type;\r\n    this.#port = port;\r\n    this.#protocol = protocol;\r\n    this.#ids = ids;\r\n  }\r\n\r\n  public get type() {\r\n    return this.#type;\r\n  }\r\n  \r\n  public get port() {\r\n    return this.#port;\r\n  }\r\n\r\n  public get protocol() {\r\n    return this.#protocol;\r\n  }\r\n\r\n  public get ids() {\r\n    return this.#ids;\r\n  }\r\n\r\n  toString() {\r\n    return this.type + ' ' + this.port + ' ' + this.protocol + ' ' + this.ids.join(' ');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\nimport SDPAttributeSplitted from \"./attributeSplitted\";\r\nimport SDPMediaLineParts from \"./mediaLineParts\";\r\n\r\nexport default class SDPLine {\r\n  #key: 'm' | 'a' | 'o' | 'v' | 's' | 't' | 'c';\r\n  #value: string;\r\n  #mediaLineParts: SDPMediaLineParts;\r\n  #parsed?: SDPAttributeSplitted;\r\n\r\n  // key = 'a', value = 'ssrc-group:SIM 1 2 3'\r\n  constructor(key: SDPLine['key'], value: string | SDPMediaLineParts | SDPAttributeSplitted) {\r\n    this.#key = key;\r\n\r\n    if(typeof(value) === 'string') {\r\n      this.#value = value;\r\n\r\n      if(key === 'm') {\r\n        const splitted = value.split(' ');\r\n        this.#mediaLineParts = new SDPMediaLineParts(splitted[0] as any, splitted[1], splitted[2], splitted.slice(3));\r\n      } else {\r\n        if(key === 'a') {\r\n          const result = splitStringByLimitWithRest(value, ':', 1);\r\n          value = result[0];\r\n          this.#parsed = result.length === 1 ? new SDPAttributeSplitted(value as any, null) : new SDPAttributeSplitted(value as any, result[1]);\r\n        }\r\n      }\r\n    } else {\r\n      if(value instanceof SDPMediaLineParts) {\r\n        this.#mediaLineParts = value;\r\n        this.#value = value.toString();\r\n      } else if(value instanceof SDPAttributeSplitted) {\r\n        this.#parsed = value;\r\n        this.#value = value.value ? `${value.key}:${value.value}` : value.key;\r\n      }\r\n    }\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#value;\r\n  }\r\n\r\n  public get parsed() {\r\n    return this.#parsed;\r\n  }\r\n\r\n  public get mediaLineParts() {\r\n    return this.#mediaLineParts;\r\n  }\r\n\r\n  toString() {\r\n    return `${this.key}=${this.value}`;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\n\r\nexport default class SDPAttributeInner {\r\n  #key: string;\r\n  #lines: Array<string>;\r\n  #prefix: string;\r\n  #nestedMap: Map<string, SDPAttributeInner>;\r\n  #missed: boolean;\r\n  #keys: Array<string>;\r\n\r\n  constructor(key: SDPAttributeInner['key'], lines: SDPAttributeInner['lines'], prefix: string = ':', missed = false) {\r\n    this.#key = key;\r\n    this.#lines = lines;\r\n    this.#prefix = prefix;\r\n    this.#missed = missed;\r\n    this.#nestedMap = missed ? new Map() : null;\r\n    this.#keys = missed ? [] : null;\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#missed || !this.lines.length ? null : this.lines[0];\r\n  }\r\n\r\n  public get exists() {\r\n    return !this.#missed;\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get keys() {\r\n    SDPAttributeInner.fill(this);\r\n    return this.#keys;\r\n  }\r\n\r\n  public forEach(callback: Parameters<Map<string, SDPAttributeInner>['forEach']>[0]) {\r\n    SDPAttributeInner.fill(this);\r\n    this.#nestedMap.forEach(callback);\r\n  }\r\n\r\n  public get(key: string) {\r\n    SDPAttributeInner.fill(this);\r\n    return this.#nestedMap.get(key) || new SDPAttributeInner(key, [], ':', true);\r\n  }\r\n  \r\n  private static fill(attribute: SDPAttributeInner) {\r\n    if(attribute.#nestedMap !== null) {\r\n      return;\r\n    }\r\n\r\n    const map: Map<string, Array<string>> = new Map();\r\n    attribute.lines.forEach((str) => {\r\n      const [key, rest] = splitStringByLimitWithRest(str, attribute.#prefix, 1);\r\n      const values = map.get(key) || [];\r\n      map.set(key, [...values, rest || '']);\r\n    });\r\n  \r\n    const nestedMap = attribute.#nestedMap = SDPAttributeInner.makeAttributes(map);\r\n    attribute.#keys = Array.from(nestedMap.keys());\r\n  }\r\n\r\n  private static makeAttributes(innerParts: Map<string, Array<string>>) {\r\n    const out: Map<string, SDPAttributeInner> = new Map();\r\n  \r\n    innerParts.forEach((lines, key) => {\r\n      out.set(key, new SDPAttributeInner(key, lines));\r\n    });\r\n  \r\n    return out;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPAttributeInner from \"./attributeInner\";\r\nimport SDPLine from \"./line\";\r\n\r\nexport default class SDPAttributes {\r\n  #lines: SDPLine[];\r\n  #attributes: Map<string, SDPAttributeInner>;\r\n\r\n  constructor(lines: SDPLine[]) {\r\n    this.#lines = lines;\r\n    this.#attributes = new Map();\r\n    SDPAttributes.fillAttributes(this);\r\n  }\r\n\r\n  public get(key: string) {\r\n    return this.#attributes.get(key) || new SDPAttributeInner(key, [], ' ', true);\r\n  }\r\n\r\n  private static fillAttributes(attributes: SDPAttributes) {\r\n    const attributesMap: Map<string, Array<string>> = new Map();\r\n    attributes.#lines.forEach((line) => {\r\n      if(line.key === 'a') {\r\n        const {key, value} = line.parsed;\r\n\r\n        let linesArray = attributesMap.get(key);\r\n        if(!linesArray) {\r\n          linesArray = [];\r\n          attributesMap.set(key, linesArray);\r\n        }\r\n        \r\n        linesArray.push(value || '');\r\n      }\r\n    });\r\n\r\n    attributesMap.forEach((linesArray, key) => {\r\n      attributes.#attributes.set(key, new SDPAttributeInner(key, linesArray, ' ', false));\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AttributeMap } from \".\";\r\nimport { NoExtraProperties } from \"../../../types\";\r\nimport SDPAttributes from \"./attributes\";\r\nimport SDPLine from \"./line\";\r\n\r\nexport type SDPMediaDirection = 'sendonly' | 'recvonly' | 'inactive' | 'sendrecv';\r\nexport default class SDPMediaSection {\r\n  #lines: Array<SDPLine>;\r\n  #mediaLine: SDPLine;\r\n  #attributes: SDPAttributes;\r\n  #direction: SDPMediaDirection;\r\n\r\n  constructor(lines: Array<SDPLine>) {\r\n    this.#lines = lines;\r\n    this.#mediaLine = lines[0];\r\n    this.#attributes = this.#direction = null;\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get mediaLine() {\r\n    return this.#mediaLine;\r\n  }\r\n\r\n  public get mediaLineParts() {\r\n    return this.#mediaLine.mediaLineParts;\r\n  }\r\n\r\n  public get mediaType() {\r\n    return this.mediaLineParts.type;\r\n  }\r\n\r\n  public get direction() {\r\n    if(!this.#direction) {\r\n      const attributes = this.attributes;\r\n\r\n      let direction: SDPMediaDirection;\r\n      if(attributes.get('sendonly').exists) direction = 'sendonly';\r\n      else if(attributes.get('recvonly').exists) direction = 'recvonly';\r\n      else if(attributes.get('inactive').exists) direction = 'inactive';\r\n      else direction = 'sendrecv';\r\n\r\n      this.#direction = direction;\r\n    }\r\n\r\n    return this.#direction;\r\n  }\r\n\r\n  public get isSending() {\r\n    return this.direction === 'sendrecv' || this.direction === 'sendonly';\r\n  }\r\n\r\n  public get isReceiving() {\r\n    return this.direction === 'sendrecv' || this.direction === 'recvonly';\r\n  }\r\n\r\n  public get attributes() {\r\n    this.#attributes || (this.#attributes = new SDPAttributes(this.lines));\r\n    return this.#attributes;\r\n  }\r\n\r\n  public get mid() {\r\n    return this.attributes.get('mid').value;\r\n  }\r\n\r\n  public lookupAttributeKeys<T extends AttributeMap>(keys: NoExtraProperties<AttributeMap, T>): {[k in keyof T]: T[k] extends true ? string : string[]} {\r\n    const out: any = {};\r\n\r\n    for(const key in keys) {\r\n      const result = this.attributes.get(key);\r\n      // @ts-ignore\r\n      const resultShouldBeArray = !keys[key];\r\n      if(!result) {\r\n        out[key] = resultShouldBeArray ? [] : undefined;\r\n      } else {\r\n        out[key] = resultShouldBeArray ? result.lines : result.value;\r\n      }\r\n    }\r\n\r\n    return out;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPLine from \"./line\";\r\n\r\nexport default class SDPSessionSection {\r\n  #lines: SDPLine[];\r\n  #sessionId: string;\r\n\r\n  constructor(lines: SDPLine[]) {\r\n    this.#lines = lines;\r\n    this.#sessionId = lines.filter((line) => line.key === 'o').map((line) => line.value.split(' ')[1])[0];\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get sessionId() {\r\n    return this.#sessionId;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \".\";\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\nimport UniqueNumberGenerator from \"../../../helpers/uniqueNumberGenerator\";\r\nimport SDPLine from \"./line\";\r\nimport SDPMediaSection from \"./mediaSection\";\r\nimport SDPSessionSection from \"./sessionSection\";\r\n\r\nexport function parseSdp(str: string) {\r\n  function createSection() {\r\n    if(sessionSection) {\r\n      mediaSections.push(new SDPMediaSection(lines));\r\n    } else {\r\n      sessionSection = new SDPSessionSection(lines);\r\n    }\r\n  }\r\n\r\n  let sessionSection: SDPSessionSection = null, mediaSections: SDPMediaSection[] = [], lines: SDPLine[] = [];\r\n  str.split(/\\r?\\n/).forEach((lineStr) => {\r\n    if(!isIncorrectSdpLine(lineStr)) {\r\n      const line = parseSdpLine(lineStr);\r\n      if(line.key === 'm') {\r\n        createSection();\r\n        lines = [];\r\n      }\r\n\r\n      lines.push(line);\r\n    }\r\n  });\r\n\r\n  createSection();\r\n  return new SDP(sessionSection, mediaSections);\r\n}\r\n\r\nexport function isIncorrectSdpLine(str: string) {\r\n  return /^[\\s\\xa0]*$/.test(str);\r\n}\r\n\r\nexport function parseSdpLine(str: string) {\r\n  const splitted = splitStringByLimitWithRest(str, '=', 1);\r\n  return new SDPLine(splitted[0] as any, splitted[1]);\r\n}\r\n\r\nexport function addSimulcast(sdp: SDP) {\r\n  let generator: UniqueNumberGenerator;\r\n  sdp.media.forEach((section, idx) => {\r\n    if(section.mediaType === 'video' && section.isSending && !section.attributes.get('ssrc-group').get('SIM').exists) {\r\n      if(!generator) {\r\n        generator = new UniqueNumberGenerator(2, 4294967295);\r\n      }\r\n\r\n      const originalSsrcs = section.attributes.get('ssrc-group').get('FID').value.split(' ');\r\n      const lines = section.lines;\r\n      originalSsrcs.forEach((ssrc) => generator.add(+ssrc)); // fix possible duplicates\r\n      const ssrcs = [originalSsrcs[0], generator.generate(), generator.generate()];\r\n      const ssrcs2 = [originalSsrcs[1], generator.generate(), generator.generate()];\r\n\r\n      lines.push(parseSdpLine('a=ssrc-group:SIM ' + ssrcs.join(' ')));\r\n\r\n      const ssrcsStrLines = section.attributes.get('ssrc').get(originalSsrcs[0]).lines;\r\n\r\n      ssrcs.forEach((ssrc, idx) => {\r\n        const ssrc2 = ssrcs2[idx];\r\n        if(idx > 0) {\r\n          lines.push(parseSdpLine('a=ssrc-group:FID ' + ssrc + ' ' + ssrc2));\r\n\r\n          ssrcsStrLines.forEach((v) => {\r\n            lines.push(parseSdpLine('a=ssrc:' + ssrc + ' ' + v));\r\n          });\r\n\r\n          ssrcsStrLines.forEach((v) => {\r\n            lines.push(parseSdpLine('a=ssrc:' + ssrc2 + ' ' + v));\r\n          });\r\n        }\r\n      });\r\n\r\n      sdp.media[idx] = new SDPMediaSection(lines);\r\n    }\r\n  });\r\n\r\n  return !!generator;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \"../sdp\";\r\nimport SDPMediaSection from \"../sdp/mediaSection\";\r\nimport { toTelegramSource } from \"../utils\";\r\nimport { parseSourceGroups } from \"./parseSourceGroups\";\r\n\r\nexport default function parseMediaSectionInfo(sdp: SDP, channel: SDPMediaSection) {\r\n  const clientInfo = channel.lookupAttributeKeys({\r\n    'ice-ufrag': true,\r\n    'ice-pwd': true,\r\n    fingerprint: true,\r\n    setup: true,\r\n    ssrc: true,\r\n    mid: true,\r\n    'ssrc-group': false\r\n  });\r\n\r\n  if(!clientInfo.fingerprint) { // support Firefox\r\n    const line = sdp.session.lines.find((line) => line.parsed?.key === 'fingerprint');\r\n    clientInfo.fingerprint = line.parsed.value;\r\n  }\r\n\r\n  const telegramSourceGroups = parseSourceGroups(clientInfo['ssrc-group']);\r\n  const [hash, fingerprint] = clientInfo.fingerprint.split(' ', 2);\r\n  const ssrc = clientInfo.ssrc && toTelegramSource(+clientInfo.ssrc.split(' ', 1)[0]);\r\n  // ssrc = telegramSourceGroups ? telegramSourceGroups[0].sources[0] : ssrc;\r\n\r\n  return {\r\n    raw: clientInfo,\r\n    ufrag: clientInfo['ice-ufrag'],\r\n    pwd: clientInfo['ice-pwd'],\r\n    fingerprint: {\r\n      fingerprint,\r\n      setup: clientInfo.setup,\r\n      hash\r\n    },\r\n    source: ssrc,\r\n    sourceGroups: telegramSourceGroups,\r\n    mid: clientInfo.mid\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCallParticipantVideoSourceGroup } from \"../../../layer\";\r\nimport { toTelegramSource } from \"../utils\";\r\n\r\nexport function parseSourceGroups(sdpLines: string[]) {\r\n  const telegramSourceGroups = sdpLines.map((str) => {\r\n    const [semantics, ...rest] = str.split(' ');\r\n\r\n    const sourceGroup: GroupCallParticipantVideoSourceGroup = {\r\n      _: 'groupCallParticipantVideoSourceGroup',\r\n      semantics,\r\n      // sources: rest.map((ssrc) => +ssrc)\r\n      sources: rest.map((ssrc) => toTelegramSource(+ssrc))\r\n    };\r\n\r\n    return sourceGroup;\r\n  });\r\n\r\n  /* const simIndex = telegramSourceGroups.findIndex((g) => g.semantics === 'SIM');\r\n  if(simIndex !== -1) {\r\n    const sourceGroup = telegramSourceGroups.splice(simIndex, 1)[0];\r\n    telegramSourceGroups.unshift(sourceGroup);\r\n  } */\r\n\r\n  return telegramSourceGroups.length ? telegramSourceGroups : undefined;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nenum GROUP_CALL_STATE {\r\n  UNMUTED,\r\n  MUTED,\r\n  MUTED_BY_ADMIN,\r\n  CONNECTING,\r\n  CLOSED\r\n}\r\n\r\nexport default GROUP_CALL_STATE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { GroupCallConnectionType, JoinGroupCallJsonPayload } from \"../appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallConnectionInstanceBase, { CallConnectionInstanceOptions } from \"./callConnectionInstanceBase\";\r\nimport GroupCallInstance from \"./groupCallInstance\";\r\nimport filterServerCodecs from \"./helpers/filterServerCodecs\";\r\nimport fixLocalOffer from \"./helpers/fixLocalOffer\";\r\nimport processMediaSection from \"./helpers/processMediaSection\";\r\nimport { ConferenceEntry } from \"./localConferenceDescription\";\r\nimport SDP from \"./sdp\";\r\nimport SDPMediaSection from \"./sdp/mediaSection\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport { UpdateGroupCallConnectionData } from \"./types\";\r\n\r\nexport default class GroupCallConnectionInstance extends CallConnectionInstanceBase {\r\n  private groupCall: GroupCallInstance;\r\n  public updateConstraints?: boolean;\r\n  private type: GroupCallConnectionType;\r\n  private options: {\r\n    type: Extract<GroupCallConnectionType, 'main'>, \r\n    isMuted?: boolean, \r\n    joinVideo?: boolean, \r\n    rejoin?: boolean\r\n  } | {\r\n    type: Extract<GroupCallConnectionType, 'presentation'>,\r\n  };\r\n\r\n  private updateConstraintsInterval: number;\r\n  public negotiateThrottled: () => void;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: CallConnectionInstanceOptions & {\r\n    groupCall: GroupCallConnectionInstance['groupCall'],\r\n    type: GroupCallConnectionInstance['type'],\r\n    options: GroupCallConnectionInstance['options'],\r\n    managers: AppManagers\r\n  }) {\r\n    super(options);\r\n\r\n    this.negotiateThrottled = throttle(this.negotiate.bind(this), 0, false);\r\n  }\r\n\r\n  public createPeerConnection() {\r\n    return this.connection || super.createPeerConnection({ \r\n      iceServers: [], \r\n      iceTransportPolicy: 'all', \r\n      bundlePolicy: 'max-bundle', \r\n      rtcpMuxPolicy: 'require', \r\n      iceCandidatePoolSize: 0, \r\n      // sdpSemantics: \"unified-plan\", \r\n      // extmapAllowMixed: true,\r\n    });\r\n  }\r\n\r\n  public createDataChannel() {\r\n    if(this.dataChannel) {\r\n      return this.dataChannel;\r\n    }\r\n\r\n    const dataChannel = super.createDataChannel();\r\n\r\n    dataChannel.addEventListener('open', () => {\r\n      this.maybeUpdateRemoteVideoConstraints();\r\n    });\r\n\r\n    dataChannel.addEventListener('close', () => {\r\n      if(this.updateConstraintsInterval) {\r\n        clearInterval(this.updateConstraintsInterval);\r\n        this.updateConstraintsInterval = undefined;\r\n      }\r\n    });\r\n\r\n    return dataChannel;\r\n  }\r\n\r\n  public createDescription() {\r\n    if(this.description) {\r\n      return this.description;\r\n    }\r\n\r\n    const description = super.createDescription();\r\n\r\n    /* const perType = 0;\r\n    const types = ['audio' as const, 'video' as const];\r\n    const count = types.length * perType;\r\n    const init: RTCRtpTransceiverInit = {direction: 'recvonly'};\r\n    types.forEach((type) => {\r\n      for(let i = 0; i < perType; ++i) {\r\n        description.createEntry(type).createTransceiver(connection, init);\r\n      }\r\n    }); */\r\n\r\n    return description;\r\n  }\r\n\r\n  public appendStreamToConference() {\r\n    super.appendStreamToConference();/* .then(() => {\r\n      currentGroupCall.connections.main.negotiating = false;\r\n      this.startNegotiation({\r\n        type: type,\r\n        isMuted: muted,\r\n        rejoin\r\n      });\r\n    }); */\r\n  }\r\n\r\n  private async invokeJoinGroupCall(localSdp: SDP, mainChannels: SDPMediaSection[], options: GroupCallConnectionInstance['options']) {\r\n    const {groupCall, description} = this;\r\n    const groupCallId = groupCall.id;\r\n\r\n    const processedChannels = mainChannels.map((section) => {\r\n      const processed = processMediaSection(localSdp, section);\r\n\r\n      this.sources[processed.entry.type as 'video' | 'audio'] = processed.entry;\r\n      \r\n      return processed;\r\n    });\r\n\r\n    const audioChannel = processedChannels.find((channel) => channel.media.mediaType === 'audio');\r\n    const videoChannel = processedChannels.find((channel) => channel.media.mediaType === 'video');\r\n    let {source, params} = audioChannel || {};\r\n    const useChannel = videoChannel || audioChannel;\r\n\r\n    const channels: {[type in WebRTCLineType]?: typeof audioChannel} = {\r\n      audio: audioChannel,\r\n      video: videoChannel\r\n    };\r\n\r\n    description.entries.forEach((entry) => {\r\n      if(entry.direction === 'sendonly') {\r\n        const channel = channels[entry.type];\r\n        if(!channel) return;\r\n\r\n        description.setEntrySource(entry, channel.sourceGroups || channel.source);\r\n        description.setEntryPeerId(entry, rootScope.myId);\r\n      }\r\n    });\r\n\r\n    // overwrite ssrc with audio in video params\r\n    if(params !== useChannel.params) {\r\n      const data: JoinGroupCallJsonPayload = JSON.parse(useChannel.params.data);\r\n      // data.ssrc = source || data.ssrc - 1; // audio channel can be missed in screensharing\r\n      if(source) data.ssrc = source;\r\n      else delete data.ssrc;\r\n      params = {\r\n        _: 'dataJSON',\r\n        data: JSON.stringify(data)\r\n      };\r\n    }\r\n\r\n    const update = await this.managers.appGroupCallsManager.joinGroupCall(groupCallId, params, options);\r\n\r\n    const data: UpdateGroupCallConnectionData = JSON.parse(update.params.data);\r\n\r\n    data.audio = data.audio || groupCall.connections.main.description.audio;\r\n    description.setData(data);\r\n    filterServerCodecs(mainChannels, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  protected async negotiateInternal() {\r\n    const {connection, description} = this;\r\n    const isNewConnection = connection.iceConnectionState === 'new' && !description.getEntryByMid('0').source;\r\n    const log = this.log.bindPrefix('startNegotiation');\r\n    log('start');\r\n    \r\n    const originalOffer = await connection.createOffer({iceRestart: false});\r\n\r\n    if(isNewConnection && this.dataChannel) {\r\n      const dataChannelEntry = description.createEntry('application');\r\n      dataChannelEntry.setDirection('sendrecv');\r\n    }\r\n\r\n    const {sdp: localSdp, offer} = fixLocalOffer({\r\n      offer: originalOffer, \r\n      data: description\r\n    });\r\n\r\n    log('[sdp] setLocalDescription', offer.sdp);\r\n    await connection.setLocalDescription(offer);\r\n\r\n    const mainChannels = localSdp.media.filter((media) => {\r\n      return media.mediaType !== 'application' && media.isSending;\r\n    });\r\n\r\n    if(isNewConnection) {\r\n      try {\r\n        await this.invokeJoinGroupCall(localSdp, mainChannels, this.options);\r\n      } catch(e) {\r\n        this.log.error('[tdweb] joinGroupCall error', e);\r\n      }\r\n    }\r\n    \r\n    /* if(!data) {\r\n      log('abort 0');\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n\r\n    /* if(connection.iceConnectionState !== 'new') {\r\n      log(`abort 1 connectionState=${connection.iceConnectionState}`);\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n    /* if(this.currentGroupCall !== currentGroupCall || connectionHandler.connection !== connection) {\r\n      log('abort', this.currentGroupCall, currentGroupCall);\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n    \r\n    const isAnswer = true;\r\n    // const _bundleMids = bundleMids.slice();\r\n    const entriesToDelete: ConferenceEntry[] = [];\r\n    const bundle = localSdp.bundle;\r\n    forEachReverse(bundle, (mid, idx, arr) => {\r\n      const entry = description.getEntryByMid(mid);\r\n      if(entry.shouldBeSkipped(isAnswer)) {\r\n        arr.splice(idx, 1);\r\n        entriesToDelete.push(entry);\r\n      }\r\n    });\r\n\r\n    /* forEachReverse(description.entries, (entry, idx, arr) => {\r\n      const mediaSection = _parsedSdp.media.find((section) => section.oa.get('mid').oa === entry.mid);\r\n      const deleted = !mediaSection;\r\n      // const deleted = !_bundleMids.includes(entry.mid); // ! can't use it because certain mid can be missed in bundle\r\n      if(deleted) {\r\n        arr.splice(idx, 1);\r\n      }\r\n    }); */\r\n\r\n    const entries = localSdp.media.map((section) => {\r\n      const mid = section.mid;\r\n      let entry = description.getEntryByMid(mid);\r\n      if(!entry) {\r\n        entry = new ConferenceEntry(mid, section.mediaType);\r\n        entry.setDirection('inactive');\r\n      }\r\n\r\n      return entry;\r\n    });\r\n\r\n    const answerDescription: RTCSessionDescriptionInit = {\r\n      type: 'answer',\r\n      sdp: description.generateSdp({\r\n        bundle, \r\n        entries, \r\n        isAnswer\r\n      })\r\n    };\r\n\r\n    entriesToDelete.forEach((entry) => {\r\n      description.deleteEntry(entry);\r\n    });\r\n\r\n    log(`[sdp] setRemoteDescription signaling=${connection.signalingState} ice=${connection.iceConnectionState} gathering=${connection.iceGatheringState} connection=${connection.connectionState}`, answerDescription.sdp);\r\n    await connection.setRemoteDescription(answerDescription);\r\n\r\n    log('end');\r\n  }\r\n\r\n  public negotiate() {\r\n    let promise = this.negotiating;\r\n    if(promise) {\r\n      return promise;\r\n    }\r\n\r\n    promise = super.negotiate();\r\n\r\n    if(this.updateConstraints) {\r\n      promise.then(() => {\r\n        this.maybeUpdateRemoteVideoConstraints();\r\n        this.updateConstraints = false;\r\n      });\r\n    }\r\n\r\n    if(this.options.type === 'presentation') {\r\n      promise.then(() => {\r\n        this.connection.getTransceivers().find((transceiver) => {\r\n          if(transceiver.sender?.track?.kind === 'video') {\r\n            transceiver.sender.setParameters({\r\n              ...transceiver.sender.getParameters(),\r\n              degradationPreference: 'maintain-resolution'\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public maybeUpdateRemoteVideoConstraints() {\r\n    if(this.dataChannel.readyState !== 'open') {\r\n      return;\r\n    }\r\n\r\n    this.log('maybeUpdateRemoteVideoConstraints');\r\n    \r\n    // * https://github.com/TelegramMessenger/tgcalls/blob/6f2746e04c9b040f8c8dfc64d916a1853d09c4ce/tgcalls/group/GroupInstanceCustomImpl.cpp#L2549\r\n    type VideoConstraints = {minHeight?: number, maxHeight: number};\r\n    const obj: {\r\n      colibriClass: 'ReceiverVideoConstraints',\r\n      constraints: {[endpoint: string]: VideoConstraints},\r\n      defaultConstraints: VideoConstraints,\r\n      onStageEndpoints: string[]\r\n    } = {\r\n      colibriClass: 'ReceiverVideoConstraints',\r\n      constraints: {},\r\n      defaultConstraints: {maxHeight: 0},\r\n      onStageEndpoints: []\r\n    };\r\n\r\n    for(const entry of this.description.entries) {\r\n      if(entry.direction !== 'recvonly' || entry.type !== 'video') {\r\n        continue;\r\n      }\r\n\r\n      const {endpoint} = entry;\r\n      obj.onStageEndpoints.push(endpoint);\r\n      obj.constraints[endpoint] = {\r\n        minHeight: 180,\r\n        maxHeight: 720\r\n      };\r\n    }\r\n\r\n    this.sendDataChannelData(obj);\r\n\r\n    if(!obj.onStageEndpoints.length) {\r\n      if(this.updateConstraintsInterval) {\r\n        clearInterval(this.updateConstraintsInterval);\r\n        this.updateConstraintsInterval = undefined;\r\n      }\r\n    } else if(!this.updateConstraintsInterval) {\r\n      this.updateConstraintsInterval = window.setInterval(this.maybeUpdateRemoteVideoConstraints.bind(this), 5000);\r\n    }\r\n  }\r\n  \r\n  public addInputVideoStream(stream: MediaStream) {\r\n    // const {sources} = this;\r\n    // if(sources?.video) {\r\n      // const source = this.sources.video.source;\r\n      // stream.source = '' + source;\r\n      this.groupCall.saveInputVideoStream(stream, this.type);\r\n    // }\r\n\r\n    this.streamManager.addStream(stream, 'input');\r\n    this.appendStreamToConference(); // replace sender track\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { DataJSON } from \"../../../layer\";\r\nimport { JoinGroupCallJsonPayload } from \"../../appManagers/appGroupCallsManager\";\r\nimport SDP from \"../sdp\";\r\nimport { Ssrc } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function processMediaSection(sdp: SDP, media: SDP['media'][0]) {\r\n  const sectionInfo = parseMediaSectionInfo(sdp, media);\r\n\r\n  const mediaType: Exclude<typeof media['mediaType'], 'application'> = media.mediaType as any;\r\n  const entry: Ssrc = {\r\n    source: sectionInfo.source,\r\n    sourceGroups: sectionInfo.sourceGroups,\r\n    type: mediaType\r\n  };\r\n\r\n  // do not change this value, otherwise onconnectionstatechange won't fire\r\n  sectionInfo.fingerprint.setup = 'active';\r\n  const payload: JoinGroupCallJsonPayload = {\r\n    fingerprints: [sectionInfo.fingerprint],\r\n    pwd: sectionInfo.pwd,\r\n    ssrc: sectionInfo.source,\r\n    'ssrc-groups': sectionInfo.sourceGroups || [],\r\n    ufrag: sectionInfo.ufrag\r\n  };\r\n  const paramsDataJson = JSON.stringify(payload);\r\n\r\n  const params: DataJSON = {\r\n    _: 'dataJSON',\r\n    data: paramsDataJson\r\n  };\r\n\r\n  return {\r\n    params, \r\n    source: sectionInfo.source, \r\n    media, \r\n    sourceGroups: sectionInfo.sourceGroups, \r\n    entry\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport SDPMediaSection from \"../sdp/mediaSection\";\r\nimport { UpdateGroupCallConnectionData, Codec } from \"../types\";\r\n\r\nexport default function filterServerCodecs(mainChannels: SDPMediaSection[], data: UpdateGroupCallConnectionData) {\r\n  // ! Need to filter server's extmap for Firefox\r\n  const performExtmap = (channel: typeof mainChannels[0]) => {\r\n    const out: {[id: string]: string} = {};\r\n    const extmap = channel.attributes.get('extmap');\r\n    extmap.forEach((extmap) => {\r\n      const id = extmap.key.split('/', 1)[0];\r\n      out[id] = extmap.value;\r\n    });\r\n\r\n    return out;\r\n  };\r\n\r\n  const codecsToPerform: [Codec, 'audio' | 'video'][] = /* flatten([data, dataPresentation].filter(Boolean).map((data) => {\r\n    return  */['audio' as const, 'video' as const].filter((type) => data[type]).map((type) => ([data[type], type]));\r\n  // }));\r\n\r\n  codecsToPerform.forEach(([codec, type]) => {\r\n    const channel = mainChannels.find((line) => line.mediaType === type);\r\n    if(!channel) {\r\n      return;\r\n    }\r\n\r\n    const extmap = performExtmap(channel);\r\n    forEachReverse(codec[\"rtp-hdrexts\"], (value, index, arr) => {\r\n      if(extmap[value.id] !== value.uri) {\r\n        arr.splice(index, 1);\r\n        console.log(`[sdp] filtered extmap:`, value, index, type);\r\n      }\r\n    });\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport { ConferenceEntry } from \"../localConferenceDescription\";\r\nimport { parseSdp, addSimulcast } from \"../sdp/utils\";\r\nimport { generateMediaFirstLine, SDPBuilder } from \"../sdpBuilder\";\r\nimport { UpdateGroupCallConnectionData } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function fixLocalOffer(options: {\r\n  offer: RTCSessionDescriptionInit, \r\n  data: UpdateGroupCallConnectionData,\r\n  skipAddingMulticast?: boolean\r\n  // mids?: string[]\r\n}) {\r\n  const {offer, data} = options;\r\n  const sdp = parseSdp(offer.sdp);\r\n  let hasMunged = false;\r\n\r\n  if(!options.skipAddingMulticast) {\r\n    hasMunged = addSimulcast(sdp) || hasMunged;\r\n  }\r\n\r\n  // const bundleLine = parsedSdp.session.lines.find((line) => line.Ha?.key === 'group');\r\n  // const bundleMids = bundleLine.value.split(' ').slice(1);\r\n\r\n  forEachReverse(sdp.media, (section, idx, arr) => {\r\n    // const mid = section.oa.get('mid').oa;\r\n\r\n    // это может случиться при выключении и включении видео. почему-то появится секция уже удалённая\r\n    // ! нельзя тут модифицировать локальное описание, будет критовать\r\n    /* if(mids && !mids.includes(mid) && !bundleMids.includes(mid)) {\r\n      console.error('wtf');\r\n      hasMunged = true;\r\n      arr.splice(idx, 1);\r\n      return;\r\n    } */\r\n\r\n    if(/* section.mediaType !== 'video' ||  */section.isSending) {\r\n      return;\r\n    }\r\n\r\n    if(section.mediaType === 'application') {\r\n      return;\r\n    }\r\n\r\n    const mediaLine = section.mediaLine;\r\n    const mediaLineParts = mediaLine.mediaLineParts;\r\n    const mediaCodecIds = mediaLineParts.ids;\r\n    const localMLine = mediaLine.toString();\r\n\r\n    const codec = data[section.mediaType];\r\n    const payloadTypes = codec['payload-types'];\r\n\r\n    /* forEachReverse(payloadTypes, (payloadType, idx, arr) => {\r\n      if(!mediaCodecIds.includes('' + payloadType.id) && section.mediaType === 'video') {\r\n      // if(payloadType.name === 'H265') {\r\n        console.warn('[sdp] filtered unsupported codec', payloadType, mediaCodecIds, section.mediaType);\r\n        arr.splice(idx, 1);\r\n      }\r\n    }); */\r\n\r\n    const codecIds = payloadTypes.map((payload) => '' + payload.id);\r\n    const correctMLine = generateMediaFirstLine(section.mediaType, undefined, codecIds);\r\n    \r\n    if(localMLine !== correctMLine) {\r\n      const sectionInfo = parseMediaSectionInfo(sdp, section);\r\n\r\n      let newData = {...data};\r\n      newData.transport = copy(newData.transport);\r\n      newData.transport.ufrag = sectionInfo.ufrag;\r\n      newData.transport.pwd = sectionInfo.pwd;\r\n      newData.transport.fingerprints = [sectionInfo.fingerprint];\r\n      newData.transport.candidates = [];\r\n\r\n      const entry = new ConferenceEntry(sectionInfo.mid, mediaLineParts.type);\r\n      entry.setPort(mediaLineParts.port);\r\n      sectionInfo.source && entry.setSource(sectionInfo.sourceGroups || sectionInfo.source);\r\n      entry.setDirection(section.direction);\r\n\r\n      const newSdp = new SDPBuilder().addSsrcEntry(entry, newData).finalize();\r\n\r\n      const newChannel = parseSdp(newSdp).media[0];\r\n      arr[idx] = newChannel;\r\n\r\n      hasMunged = true;\r\n    }\r\n  });\r\n\r\n  if(hasMunged) {\r\n    const mungedSdp = sdp.toString();\r\n    offer.sdp = mungedSdp;\r\n  }\r\n\r\n  return {offer, sdp/* , bundleMids */};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { GroupCallConnectionType, GroupCallId, GroupCallOutputSource } from \"../appManagers/appGroupCallsManager\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { GroupCall, GroupCallParticipant } from \"../../layer\";\r\nimport { logger } from \"../logger\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallInstanceBase, { TryAddTrackOptions } from \"./callInstanceBase\";\r\nimport GroupCallConnectionInstance from \"./groupCallConnectionInstance\";\r\nimport GROUP_CALL_STATE from \"./groupCallState\";\r\nimport getScreenConstraints from \"./helpers/getScreenConstraints\";\r\nimport getScreenStream from \"./helpers/getScreenStream\";\r\nimport getStream from \"./helpers/getStream\";\r\nimport getVideoConstraints from \"./helpers/getVideoConstraints\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport localConferenceDescription from \"./localConferenceDescription\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\nimport getPeerId from \"../appManagers/utils/peers/getPeerId\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { generateSelfVideo, makeSsrcFromParticipant, makeSsrcsFromParticipant } from \"./groupCallsController\";\r\n\r\nexport default class GroupCallInstance extends CallInstanceBase<{\r\n  state: (state: GROUP_CALL_STATE) => void,\r\n  pinned: (source?: GroupCallOutputSource) => void,\r\n}> {\r\n  public id: GroupCallId;\r\n  public chatId: ChatId;\r\n  public handleUpdateGroupCallParticipants: boolean;\r\n  public updatingSdp: boolean;\r\n  public isSpeakingMap: Map<any, any>;\r\n  public connections: {[k in GroupCallConnectionType]?: GroupCallConnectionInstance};\r\n  public groupCall: GroupCall;\r\n  public participant: GroupCallParticipant;\r\n  \r\n  // will be set with negotiation\r\n  public joined: boolean;\r\n  \r\n  private pinnedSources: Array<GroupCallOutputSource>;\r\n  private participantsSsrcs: Map<PeerId, Ssrc[]>;\r\n  private hadAutoPinnedSources: Set<GroupCallOutputSource>;\r\n  private dispatchPinnedThrottled: () => void;\r\n  private startVideoSharingPromise: Promise<void>;\r\n  private startScreenSharingPromise: Promise<void>;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    id: GroupCallInstance['id'],\r\n    chatId: GroupCallInstance['chatId'],\r\n    isSpeakingMap?: GroupCallInstance['isSpeakingMap'],\r\n    connections?: GroupCallInstance['connections'],\r\n    managers: AppManagers\r\n  }) {\r\n    super();\r\n\r\n    safeAssign(this, options);\r\n\r\n    if(!this.log) {\r\n      this.log = logger('GROUP-CALL');\r\n    }\r\n\r\n    if(!this.connections) {\r\n      this.connections = {};\r\n    }\r\n\r\n    if(!this.isSpeakingMap) {\r\n      this.isSpeakingMap = new Map();\r\n    }\r\n\r\n    this.pinnedSources = [];\r\n    this.participantsSsrcs = new Map();\r\n    this.hadAutoPinnedSources = new Set();\r\n    this.dispatchPinnedThrottled = throttle(() => {\r\n      this.dispatchEvent('pinned', this.pinnedSource);\r\n    }, 0, false);\r\n\r\n    this.addEventListener('state', (state) => {\r\n      if(state === GROUP_CALL_STATE.CLOSED) {\r\n        this.cleanup();\r\n      }\r\n    });\r\n  }\r\n\r\n  get connectionState() {\r\n    return this.connections.main.connection.iceConnectionState;\r\n  }\r\n\r\n  get state() {\r\n    const {connectionState} = this;\r\n    if(connectionState === 'closed') {\r\n      return GROUP_CALL_STATE.CLOSED;\r\n    } else if(connectionState !== 'connected' && (!IS_SAFARI || connectionState !== 'completed')) {\r\n      return GROUP_CALL_STATE.CONNECTING;\r\n    } else {\r\n      const {participant} = this;\r\n      if(!participant.pFlags.can_self_unmute) {\r\n        return GROUP_CALL_STATE.MUTED_BY_ADMIN;\r\n      } else if(participant.pFlags.muted) {\r\n        return GROUP_CALL_STATE.MUTED;\r\n      } else {\r\n        return GROUP_CALL_STATE.UNMUTED;\r\n      }\r\n    }\r\n  }\r\n\r\n  get participants() {\r\n    return this.managers.appGroupCallsManager.getCachedParticipants(this.id);\r\n  }\r\n\r\n  get isSharingScreen() {\r\n    return !!this.connections.presentation;\r\n  }\r\n\r\n  get pinnedSource() {\r\n    return this.pinnedSources[this.pinnedSources.length - 1];\r\n  }\r\n\r\n  public get isMuted() {\r\n    return this.state !== GROUP_CALL_STATE.UNMUTED;\r\n  }\r\n\r\n  public get isClosing() {\r\n    const {state} = this;\r\n    return state === GROUP_CALL_STATE.CLOSED;\r\n  }\r\n\r\n  public get streamManager(): StreamManager {\r\n    return this.connections.main.streamManager;\r\n  }\r\n\r\n  public get description(): localConferenceDescription {\r\n    return this.connections.main.description;\r\n  }\r\n\r\n  public pinSource(source: GroupCallOutputSource) {\r\n    indexOfAndSplice(this.pinnedSources, source);\r\n    this.pinnedSources.push(source);\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public unpinSource(source: GroupCallOutputSource) {\r\n    this.hadAutoPinnedSources.delete(source);\r\n    indexOfAndSplice(this.pinnedSources, source);\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public unpinAll() {\r\n    this.pinnedSources.length = 0;\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public async getParticipantByPeerId(peerId: PeerId) {\r\n    return NULL_PEER_ID === peerId ? this.participant : (await this.participants).get(peerId);\r\n  }\r\n\r\n  public toggleMuted() {\r\n    return this.requestAudioSource(true).then(() => this.changeUserMuted(NULL_PEER_ID));\r\n  }\r\n\r\n  public async changeUserMuted(peerId: PeerId, muted?: boolean) {\r\n    const participant = await this.getParticipantByPeerId(peerId);\r\n    if(NULL_PEER_ID === peerId && participant.pFlags.can_self_unmute) {\r\n      muted = muted === undefined ? !participant.pFlags.muted : muted;\r\n    }\r\n\r\n    return this.editParticipant(participant, {muted});\r\n  }\r\n\r\n  public getElement(endpoint: GroupCallOutputSource) {\r\n    return super.getElement(endpoint);\r\n  }\r\n\r\n  public getVideoElementFromParticipantByType(participant: GroupCallParticipant, type: 'video' | 'presentation') {\r\n    let source: GroupCallOutputSource;\r\n    if(participant.pFlags.self) {\r\n      const connectionType: GroupCallConnectionType = type === 'video' ? 'main' : 'presentation';\r\n      source = connectionType;\r\n    } else {\r\n      const codec = participant[type];\r\n      source = codec.source_groups[0].sources[0];\r\n    }\r\n\r\n    const element = this.getElement(source) as HTMLVideoElement;\r\n    if(!element) return;\r\n\r\n    const clone = element.cloneNode() as typeof element;\r\n    clone.srcObject = element.srcObject;\r\n    return {video: clone, source};\r\n  }\r\n\r\n  public createConnectionInstance(options: {\r\n    streamManager: StreamManager,\r\n    type: GroupCallConnectionType,\r\n    options: GroupCallConnectionInstance['options'],\r\n  }) {\r\n    return this.connections[options.type] = new GroupCallConnectionInstance({\r\n      groupCall: this,\r\n      log: this.log.bindPrefix(options.type),\r\n      managers: this.managers,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  public changeRaiseHand(raise: boolean) {\r\n    return this.editParticipant(this.participant, {raiseHand: raise});\r\n  }\r\n\r\n  public async startScreenSharingInternal() {\r\n    try {\r\n      const type: GroupCallConnectionType = 'presentation';\r\n\r\n      const stream = await getScreenStream(getScreenConstraints());\r\n      const streamManager = new StreamManager();\r\n      \r\n      const connectionInstance = this.createConnectionInstance({\r\n        streamManager,\r\n        type,\r\n        options: {\r\n          type\r\n        }\r\n      });\r\n      \r\n      const connection = connectionInstance.createPeerConnection();\r\n      connection.addEventListener('negotiationneeded', () => {\r\n        connectionInstance.negotiate();\r\n      });\r\n\r\n      stream.getVideoTracks()[0].addEventListener('ended', () => {\r\n        if(this.connections.presentation) { // maybe user has stopped screensharing through browser's ui\r\n          this.stopScreenSharing();\r\n        }\r\n      }, {once: true});\r\n      \r\n      connectionInstance.createDescription();\r\n      connectionInstance.addInputVideoStream(stream);\r\n    } catch(err) {\r\n      this.log.error('start screen sharing error', err);\r\n    }\r\n  }\r\n\r\n  public startScreenSharing() {\r\n    return this.startScreenSharingPromise ??= this.startScreenSharingInternal().finally(() => {\r\n      this.startScreenSharingPromise = undefined;\r\n    });\r\n  }\r\n\r\n  public stopScreenSharing() {\r\n    const connectionInstance = this.connections.presentation;\r\n    if(!connectionInstance) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    delete this.connections.presentation;\r\n    this.unpinSource('presentation');\r\n    connectionInstance.closeConnectionAndStream(true);\r\n\r\n    delete this.participant.presentation;\r\n    this.managers.appGroupCallsManager.saveApiParticipant(this.id, this.participant);\r\n\r\n    return this.managers.appGroupCallsManager.leaveGroupCallPresentation(this.id);\r\n  }\r\n\r\n  public toggleScreenSharing() {\r\n    if(this.isSharingScreen) {\r\n      return this.stopScreenSharing();\r\n    } else {\r\n      return this.startScreenSharing();\r\n    }\r\n  }\r\n\r\n  public async startVideoSharingInternal() {\r\n    const constraints: MediaStreamConstraints = {\r\n      video: getVideoConstraints()\r\n    };\r\n\r\n    try {\r\n      const stream = await getStream(constraints, false);\r\n      const connectionInstance = this.connections.main;\r\n      connectionInstance.addInputVideoStream(stream);\r\n\r\n      await this.editParticipant(this.participant, {\r\n        videoPaused: false,\r\n        videoStopped: false\r\n      });\r\n    } catch(err) {\r\n      this.log.error('startVideoSharing error', err, constraints);\r\n    }\r\n  }\r\n\r\n  public startVideoSharing() {\r\n    return this.startVideoSharingPromise ??= this.startVideoSharingInternal().finally(() => {\r\n      this.startVideoSharingPromise = undefined;\r\n    });\r\n  }\r\n\r\n  public async stopVideoSharing() {\r\n    const connectionInstance = this.connections.main;\r\n    const track = connectionInstance.streamManager.inputStream.getVideoTracks()[0];\r\n    if(!track) {\r\n      return;\r\n    }\r\n\r\n    stopTrack(track);\r\n    connectionInstance.streamManager.appendToConference(connectionInstance.description); // clear sender track\r\n\r\n    await this.editParticipant(this.participant, {\r\n      videoStopped: true\r\n    });\r\n  }\r\n\r\n  public toggleVideoSharing() {\r\n    if(this.isSharingVideo) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startVideoSharing();\r\n    }\r\n  }\r\n\r\n  public async hangUp(discard = false, rejoin = false, isDiscarded = false) {\r\n    for(const type in this.connections) {\r\n      const connection = this.connections[type as GroupCallConnectionType];\r\n      connection.closeConnectionAndStream(!rejoin);\r\n    }\r\n\r\n    this.dispatchEvent('state', this.state);\r\n\r\n    if(isDiscarded) {\r\n      return;\r\n    }\r\n    \r\n    if(!rejoin) {\r\n      let d = discard || (this.joined ? this.connections.main.sources.audio.source : undefined);\r\n      this.managers.appGroupCallsManager.hangUp(this.id, d);\r\n    }\r\n  }\r\n\r\n  public tryAddTrack(options: Omit<TryAddTrackOptions, 'streamManager'>) {\r\n    const {description} = this;\r\n    const source = super.tryAddTrack(options);\r\n    \r\n    if(options.type === 'output') {\r\n      const entry = description.getEntryBySource(+source);\r\n      this.getParticipantByPeerId(entry.peerId).then((participant) => {\r\n        if(participant) {\r\n          rootScope.dispatchEvent('group_call_participant', {groupCallId: this.id, participant});\r\n        }\r\n      });\r\n    }\r\n\r\n    return source;\r\n  }\r\n\r\n  public async editParticipant(participant: GroupCallParticipant, options: Partial<{\r\n    muted: boolean,\r\n    volume: number,\r\n    raiseHand: boolean,\r\n    videoStopped: boolean,\r\n    videoPaused: boolean,\r\n    presentationPaused: boolean\r\n  }>) {\r\n    if(!Object.keys(options).length) {\r\n      return;\r\n    }\r\n\r\n    // let processUpdate = true;\r\n    if(participant) {\r\n      // const {currentGroupCall} = this;\r\n      // const isCurrentCall = currentGroupCall?.id === groupCallId;\r\n      const isCurrentCall = true;\r\n      const isUpdatingMeInCurrentCall = isCurrentCall && participant.pFlags.self;\r\n\r\n      if(isUpdatingMeInCurrentCall) {\r\n        if(options.muted !== undefined && !this.isSharingAudio) {\r\n          delete options.muted;\r\n\r\n          if(!Object.keys(options).length) {\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // if(isCurrentCall) {\r\n        const muted = options.muted;\r\n        if(muted !== undefined) {\r\n          /* const isAdmin = appChatsManager.hasRights(currentGroupCall.chatId, 'manage_call');\r\n          if(isAdmin) {\r\n            if(muted) {\r\n              participant.pFlags.muted = true;\r\n              delete participant.pFlags.can_self_unmute;\r\n            } else {\r\n              participant.pFlags.can_self_unmute = true;\r\n            }\r\n          } else  */if(participant.pFlags.self) {\r\n            if(muted) {\r\n              participant.pFlags.muted = true;\r\n            } else if(participant.pFlags.can_self_unmute) {\r\n              delete participant.pFlags.muted;\r\n            }\r\n          }/*  else {\r\n            if(muted) {\r\n              participant.pFlags.muted_by_you = true;\r\n            } else {\r\n              delete participant.pFlags.muted_by_you;\r\n            }\r\n          } */\r\n        }\r\n      // }\r\n\r\n      /* const a: [keyof GroupCallParticipant['pFlags'], keyof typeof options][] = [\r\n        ['muted', 'muted']\r\n      ];\r\n\r\n      a.forEach(([key, optionKey]) => {\r\n        const value = options[optionKey];\r\n        if(value === undefined) {\r\n          return;\r\n        }\r\n\r\n        if(value) {\r\n          participant.pFlags[key] = true;\r\n        } else {\r\n          delete participant.pFlags[key];\r\n        }\r\n      }); */\r\n\r\n      if(options.raiseHand !== undefined) {\r\n        if(options.raiseHand) participant.raise_hand_rating = '1';\r\n        else delete participant.raise_hand_rating;\r\n      }\r\n\r\n      if(isUpdatingMeInCurrentCall) {\r\n        if(options.videoStopped !== undefined) {\r\n          if(options.videoStopped) delete participant.video;\r\n          else participant.video = generateSelfVideo(this.connections.main.sources.video);\r\n        }\r\n\r\n        if(!participant.pFlags.muted && participant.pFlags.can_self_unmute) {\r\n          this.setMuted(false);\r\n        }\r\n\r\n        this.dispatchEvent('state', this.state);\r\n      }\r\n\r\n      // rootScope.dispatchEvent('group_call_participant', {groupCallId, participant});\r\n\r\n      /* if(participant.pFlags.self) {\r\n        processUpdate = false;\r\n      } */\r\n    }\r\n\r\n    return this.managers.appGroupCallsManager.editParticipant(this.id, participant, options);\r\n  }\r\n\r\n  public onParticipantUpdate(participant: GroupCallParticipant, doNotDispatchParticipantUpdate?: PeerId) {\r\n    const connectionInstance = this.connections.main;\r\n    const {connection, description} = connectionInstance;\r\n\r\n    const peerId = getPeerId(participant.peer);\r\n    const hasLeft = !!participant.pFlags.left;\r\n    const oldSsrcs = this.participantsSsrcs.get(peerId) || [];\r\n\r\n    if(participant.presentation && !hasLeft) {\r\n      const {source} = makeSsrcFromParticipant(participant, 'video', participant.presentation.source_groups, participant.presentation.endpoint);\r\n      if(!this.hadAutoPinnedSources.has(source)) {\r\n        this.hadAutoPinnedSources.add(source);\r\n        this.pinSource(participant.pFlags.self ? 'presentation' : source);\r\n      }\r\n    }\r\n\r\n    if(participant.pFlags.self) {\r\n      this.participant = participant;\r\n\r\n      if(connectionInstance.sources.audio.source !== participant.source) {\r\n        this.hangUp();\r\n      }\r\n\r\n      let mute = false;\r\n      if(!participant.pFlags.can_self_unmute) {\r\n        this.stopScreenSharing();\r\n        this.stopVideoSharing();\r\n        mute = true;\r\n      } else if(participant.pFlags.muted) {\r\n        mute = true;\r\n      }\r\n\r\n      if(mute) {\r\n        this.setMuted(true);\r\n      }\r\n\r\n      if(doNotDispatchParticipantUpdate !== peerId) {\r\n        this.dispatchEvent('state', this.state);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const ssrcs = hasLeft ? [] : makeSsrcsFromParticipant(participant);\r\n\r\n    if(!hasLeft) {\r\n      this.participantsSsrcs.set(peerId, ssrcs);\r\n    } else {\r\n      this.participantsSsrcs.delete(peerId);\r\n    }\r\n\r\n    // const TEST_OLD = false;\r\n\r\n    const modifiedTypes: Set<WebRTCLineType> = new Set();\r\n    oldSsrcs.forEach((oldSsrc) => {\r\n      const oldSource = oldSsrc.source;\r\n      const newSsrc = ssrcs.find((ssrc) => ssrc.source === oldSource);\r\n      if(!newSsrc) {\r\n        this.unpinSource(oldSource);\r\n\r\n        const oldEntry = description.getEntryBySource(oldSource);\r\n        if(oldEntry && oldEntry.direction !== 'inactive') {\r\n          oldEntry.setDirection('inactive');\r\n          modifiedTypes.add(oldEntry.type);\r\n        }\r\n      }\r\n    });\r\n\r\n    ssrcs.forEach((ssrc) => {\r\n      let entry = description.getEntryBySource(ssrc.source);\r\n      if(entry) {\r\n        if(entry.direction === 'inactive') {\r\n          entry.setDirection(entry.originalDirection);\r\n          modifiedTypes.add(entry.type);\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      entry = description.createEntry(ssrc.type);\r\n      description.setEntrySource(entry, ssrc.sourceGroups || ssrc.source);\r\n      description.setEntryPeerId(entry, peerId);\r\n\r\n      // if(TEST_OLD) {\r\n      //   description.bundleMids.push(entry.mid);\r\n      //   entry.setDirection('recvonly');\r\n      // } else {\r\n        ssrc.type === 'video' && entry.setEndpoint(ssrc.endpoint);\r\n        entry.createTransceiver(connection, {direction: 'recvonly'});\r\n      // }\r\n\r\n      modifiedTypes.add(entry.type);\r\n    });\r\n\r\n    /* if(TEST_OLD) {\r\n      this.setRemoteOffer({\r\n        connection,\r\n        description,\r\n        ssrcs\r\n      });\r\n    } else  */if(modifiedTypes.size) {\r\n      if(modifiedTypes.has('video')) {\r\n        connectionInstance.updateConstraints = true;\r\n      }\r\n\r\n      connectionInstance.negotiateThrottled();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getGroupCallAudioAsset from \"../../components/groupCall/getAudioAsset\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { GroupCallParticipant, GroupCallParticipantVideo, GroupCallParticipantVideoSourceGroup } from \"../../layer\";\r\nimport { GroupCallId, GroupCallConnectionType } from \"../appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport GroupCallInstance from \"./groupCallInstance\";\r\nimport GROUP_CALL_STATE from \"./groupCallState\";\r\nimport createMainStreamManager from \"./helpers/createMainStreamManager\";\r\nimport { generateSsrc } from \"./localConferenceDescription\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\n\r\nlet IS_MUTED = true;\r\n\r\nexport function makeSsrcsFromParticipant(participant: GroupCallParticipant) {\r\n  return [\r\n    makeSsrcFromParticipant(participant, 'audio', participant.source),\r\n    participant.video?.audio_source && makeSsrcFromParticipant(participant, 'audio', participant.video.audio_source),\r\n    participant.video && makeSsrcFromParticipant(participant, 'video', participant.video.source_groups, participant.video.endpoint),\r\n    participant.presentation?.audio_source && makeSsrcFromParticipant(participant, 'audio', participant.presentation.audio_source),\r\n    participant.presentation && makeSsrcFromParticipant(participant, 'video', participant.presentation.source_groups, participant.presentation.endpoint)\r\n  ].filter(Boolean);\r\n};\r\n\r\nexport function makeSsrcFromParticipant(participant: GroupCallParticipant, type: WebRTCLineType, source?: number | GroupCallParticipantVideoSourceGroup[], endpoint?: string): Ssrc {\r\n  return generateSsrc(type, source, endpoint);\r\n}\r\n\r\nexport function generateSelfVideo(source: Ssrc, audioSource?: number): GroupCallParticipantVideo {\r\n  return source && {\r\n    _: 'groupCallParticipantVideo',\r\n    pFlags: {},\r\n    endpoint: '',\r\n    source_groups: source.sourceGroups,\r\n    audio_source: audioSource\r\n  };\r\n}\r\n\r\nexport class GroupCallsController extends EventListenerBase<{\r\n  instance: (instance: GroupCallInstance) => void\r\n}> {\r\n  private audioAsset: ReturnType<typeof getGroupCallAudioAsset>;\r\n  private log: ReturnType<typeof logger>;\r\n  private currentGroupCall: GroupCallInstance;\r\n  private managers: AppManagers;\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    this.audioAsset = getGroupCallAudioAsset();\r\n    this.log = logger('GCC');\r\n\r\n    rootScope.addEventListener('group_call_update', (groupCall) => {\r\n      const {currentGroupCall} = this;\r\n      if(currentGroupCall?.id === groupCall.id) {\r\n        currentGroupCall.groupCall = groupCall;\r\n        \r\n        if(groupCall._ === 'groupCallDiscarded') {\r\n          currentGroupCall.hangUp(false, false, true);\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('group_call_participant', ({groupCallId, participant}) => {\r\n      const {currentGroupCall} = this;\r\n      if(currentGroupCall?.id === groupCallId) {\r\n        currentGroupCall.onParticipantUpdate(participant/* , this.doNotDispatchParticipantUpdate */);\r\n      }\r\n    });\r\n  }\r\n\r\n  get groupCall() {\r\n    return this.currentGroupCall;\r\n  }\r\n\r\n  public setCurrentGroupCall(groupCall: GroupCallInstance) {\r\n    this.currentGroupCall = groupCall;\r\n\r\n    if(groupCall) {\r\n      this.dispatchEvent('instance', groupCall);\r\n    }\r\n  }\r\n\r\n  public startConnectingSound() {\r\n    this.stopConnectingSound();\r\n    this.audioAsset.playSoundWithTimeout('group_call_connect.mp3', true, 2500);\r\n  }\r\n  \r\n  public stopConnectingSound() {\r\n    this.audioAsset.stopSound();\r\n    this.audioAsset.cancelDelayedPlay();\r\n  }\r\n\r\n  public async joinGroupCall(chatId: ChatId, groupCallId: GroupCallId, muted = IS_MUTED, rejoin?: boolean, joinVideo?: boolean) {\r\n    this.audioAsset.createAudio();\r\n\r\n    this.log(`joinGroupCall chatId=${chatId} id=${groupCallId} muted=${muted} rejoin=${rejoin}`);\r\n    \r\n    let streamManager: StreamManager;\r\n    if(rejoin) {\r\n      streamManager = this.currentGroupCall.connections.main.streamManager;\r\n    } else {\r\n      streamManager = await createMainStreamManager(muted, joinVideo);\r\n    }\r\n\r\n    return this.joinGroupCallInternal(chatId, groupCallId, streamManager, muted, rejoin, joinVideo);\r\n  }\r\n\r\n  public async joinGroupCallInternal(chatId: ChatId, groupCallId: GroupCallId, streamManager: StreamManager, muted: boolean, rejoin = false, joinVideo?: boolean) {\r\n    const log = this.log.bindPrefix('joinGroupCallInternal');\r\n    log('start', groupCallId);\r\n\r\n    const type: GroupCallConnectionType = 'main';\r\n\r\n    let {currentGroupCall} = this;\r\n    if(currentGroupCall && rejoin) {\r\n      // currentGroupCall.connections.main.connection = connection;\r\n      currentGroupCall.handleUpdateGroupCallParticipants = false;\r\n      currentGroupCall.updatingSdp = false;\r\n      log('update currentGroupCall', groupCallId, currentGroupCall);\r\n    } else {\r\n      currentGroupCall = new GroupCallInstance({\r\n        chatId,\r\n        id: groupCallId,\r\n        managers: this.managers\r\n      });\r\n\r\n      currentGroupCall.fixSafariAudio();\r\n\r\n      currentGroupCall.addEventListener('state', (state) => {\r\n        if(this.currentGroupCall === currentGroupCall && state === GROUP_CALL_STATE.CLOSED) {\r\n          this.setCurrentGroupCall(null);\r\n          this.stopConnectingSound();\r\n          this.audioAsset.playSound('group_call_end.mp3');\r\n          rootScope.dispatchEvent('chat_update', currentGroupCall.chatId);\r\n        }\r\n      });\r\n\r\n      currentGroupCall.groupCall = await this.managers.appGroupCallsManager.getGroupCallFull(groupCallId);\r\n\r\n      const connectionInstance = currentGroupCall.createConnectionInstance({\r\n        streamManager,\r\n        type,\r\n        options: {\r\n          type,\r\n          isMuted: muted,\r\n          joinVideo,\r\n          rejoin\r\n        }\r\n      });\r\n\r\n      const connection = connectionInstance.createPeerConnection();\r\n      connection.addEventListener('negotiationneeded', () => {\r\n        connectionInstance.negotiate();\r\n      });\r\n\r\n      connection.addEventListener('track', (event) => {\r\n        log('ontrack', event);\r\n        currentGroupCall.onTrack(event);\r\n      });\r\n  \r\n      connection.addEventListener('iceconnectionstatechange', () => {\r\n        currentGroupCall.dispatchEvent('state', currentGroupCall.state);\r\n        \r\n        const {iceConnectionState} = connection;\r\n        if(iceConnectionState === 'disconnected' || iceConnectionState === 'checking' || iceConnectionState === 'new') {\r\n          this.startConnectingSound();\r\n        } else {\r\n          this.stopConnectingSound();\r\n        }\r\n        \r\n        switch(iceConnectionState) {\r\n          case 'checking': {\r\n            break;\r\n          }\r\n          \r\n          case 'closed': {\r\n            currentGroupCall.hangUp();\r\n            break;\r\n          }\r\n          \r\n          case 'completed': {\r\n            break;\r\n          }\r\n          \r\n          case 'connected': {\r\n            if(!currentGroupCall.joined) {\r\n              currentGroupCall.joined = true;\r\n              this.audioAsset.playSound('group_call_start.mp3');\r\n              this.managers.appGroupCallsManager.getGroupCallParticipants(groupCallId);\r\n            }\r\n            \r\n            break;\r\n          }\r\n          \r\n          case 'disconnected': {\r\n            break;\r\n          }\r\n          \r\n          case 'failed': {\r\n            //TODO: replace with ICE restart\r\n            currentGroupCall.hangUp();\r\n            // connection.restartIce();\r\n            break;\r\n          }\r\n          \r\n          case 'new': {\r\n            break;\r\n          }\r\n        }\r\n      });\r\n\r\n      connectionInstance.createDescription();\r\n      connectionInstance.createDataChannel();\r\n\r\n      connectionInstance.appendStreamToConference();\r\n\r\n      this.setCurrentGroupCall(currentGroupCall);\r\n      log('set currentGroupCall', groupCallId, currentGroupCall);\r\n\r\n      this.startConnectingSound();\r\n\r\n      return connectionInstance.negotiate();\r\n    }\r\n  }\r\n}\r\n\r\nconst groupCallsController = new GroupCallsController();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.groupCallController = groupCallsController);\r\nexport default groupCallsController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS } from \"../constants\";\r\nimport StreamManager from \"../streamManager\";\r\nimport getAudioConstraints from \"./getAudioConstraints\";\r\nimport getStream from \"./getStream\";\r\nimport getVideoConstraints from \"./getVideoConstraints\";\r\n\r\nexport default async function createMainStreamManager(muted?: boolean, joinVideo?: boolean) {\r\n  const constraints: MediaStreamConstraints = {\r\n    audio: getAudioConstraints(),\r\n    video: joinVideo && getVideoConstraints()\r\n  };\r\n\r\n  const streamManager = new StreamManager(GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS);\r\n  \r\n  try {\r\n    const stream = await getStream(constraints, muted);\r\n    streamManager.addStream(stream, 'input');\r\n  } catch(err) {\r\n    console.error('joinGroupCall getStream error', err, constraints);\r\n    streamManager.inputStream = new MediaStream();\r\n  }\r\n\r\n  return streamManager;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { Channel } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppSidebarRight } from \"../sidebarRight\";\r\nimport type Chat from \"./chat\";\r\nimport { RIGHT_COLUMN_ACTIVE_CLASSNAME } from \"../sidebarRight\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport AvatarElement from \"../avatar\";\r\nimport Button from \"../button\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport ChatAudio from \"./audio\";\r\nimport ChatPinnedMessage from \"./pinnedMessage\";\r\nimport { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PopupDeleteDialog from \"../popups/deleteDialog\";\r\nimport appNavigationController from \"../appNavigationController\";\r\nimport { LEFT_COLUMN_ACTIVE_CLASSNAME } from \"../sidebarLeft\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport { toast, toastNew } from \"../toast\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { ChatFull, Chat as MTChat, GroupCall } from \"../../layer\";\r\nimport PopupPickUser from \"../popups/pickUser\";\r\nimport PopupPeer from \"../popups/peer\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport AppEditContactTab from \"../sidebarRight/tabs/editContact\";\r\nimport appMediaPlaybackController from \"../appMediaPlaybackController\";\r\nimport IS_GROUP_CALL_SUPPORTED from \"../../environment/groupCallSupport\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport { CallType } from \"../../lib/calls/types\";\r\nimport PopupMute from \"../popups/mute\";\r\nimport generateTitleIcons from \"../generateTitleIcons\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport hasRights from \"../../lib/appManagers/utils/chats/hasRights\";\r\nimport wrapPeerTitle from \"../wrappers/peerTitle\";\r\nimport groupCallsController from \"../../lib/calls/groupCallsController\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\ntype ButtonToVerify = {element?: HTMLElement, verify: () => boolean | Promise<boolean>};\r\n\r\nexport default class ChatTopbar {\r\n  public container: HTMLDivElement;\r\n  private btnBack: HTMLButtonElement;\r\n  private chatInfo: HTMLDivElement;\r\n  private avatarElement: AvatarElement;\r\n  private title: HTMLDivElement;\r\n  private subtitle: HTMLDivElement;\r\n  private chatUtils: HTMLDivElement;\r\n  private btnJoin: HTMLButtonElement;\r\n  private btnPinned: HTMLButtonElement;\r\n  private btnCall: HTMLButtonElement;\r\n  private btnGroupCall: HTMLButtonElement;\r\n  private btnMute: HTMLButtonElement;\r\n  private btnSearch: HTMLButtonElement;\r\n  private btnMore: HTMLElement;\r\n  \r\n  private chatAudio: ChatAudio;\r\n  public pinnedMessage: ChatPinnedMessage;\r\n\r\n  private setUtilsRAF: number;\r\n  private setPeerStatusInterval: number;\r\n\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  private menuButtons: (ButtonMenuItemOptions & {verify: ButtonToVerify['verify']})[];\r\n  private buttonsToVerify: ButtonToVerify[];\r\n  private chatInfoContainer: HTMLDivElement;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private appSidebarRight: AppSidebarRight, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.menuButtons = [];\r\n    this.buttonsToVerify = [];\r\n  }\r\n\r\n  public construct() {\r\n    //this.chat.log.error('Topbar construction');\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('sidebar-header', 'topbar', 'hide');\r\n    this.container.dataset.floating = '0';\r\n\r\n    this.btnBack = ButtonIcon('left sidebar-close-button', {noRipple: true});\r\n\r\n    // * chat info section\r\n    this.chatInfoContainer = document.createElement('div');\r\n    this.chatInfoContainer.classList.add('chat-info-container');\r\n\r\n    this.chatInfo = document.createElement('div');\r\n    this.chatInfo.classList.add('chat-info');\r\n\r\n    const person = document.createElement('div');\r\n    person.classList.add('person');\r\n\r\n    const content = document.createElement('div');\r\n    content.classList.add('content');\r\n\r\n    const top = document.createElement('div');\r\n    top.classList.add('top');\r\n\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add('user-title');\r\n\r\n    top.append(this.title);\r\n\r\n    const bottom = document.createElement('div');\r\n    bottom.classList.add('bottom');\r\n\r\n    if(this.subtitle) {\r\n      bottom.append(this.subtitle);\r\n    }\r\n\r\n    content.append(top, bottom);\r\n    if(this.avatarElement) {\r\n      person.append(this.avatarElement);\r\n    }\r\n\r\n    person.append(content);\r\n    this.chatInfo.append(person);\r\n\r\n    // * chat utils section\r\n    this.chatUtils = document.createElement('div');\r\n    this.chatUtils.classList.add('chat-utils');\r\n\r\n    this.chatAudio = new ChatAudio(this, this.chat, this.managers);\r\n\r\n    if(this.menuButtons.length) {\r\n      this.btnMore = ButtonMenuToggle({listenerSetter: this.listenerSetter}, 'bottom-left', this.menuButtons, this.verifyButtons);\r\n    }\r\n\r\n    this.chatUtils.append(...[\r\n      // this.chatAudio ? this.chatAudio.divAndCaption.container : null, \r\n      this.pinnedMessage ? this.pinnedMessage.pinnedMessageContainer.divAndCaption.container : null, \r\n      this.btnJoin, \r\n      this.btnPinned, \r\n      this.btnCall, \r\n      this.btnGroupCall, \r\n      this.btnMute, \r\n      this.btnSearch, \r\n      this.btnMore\r\n    ].filter(Boolean));\r\n\r\n    this.pushButtonToVerify(this.btnCall, this.verifyCallButton.bind(this, 'voice'));\r\n    this.pushButtonToVerify(this.btnGroupCall, this.verifyVideoChatButton);\r\n\r\n    this.chatInfoContainer.append(this.btnBack, this.chatInfo, this.chatUtils);\r\n    this.container.append(this.chatInfoContainer);\r\n\r\n    if(this.chatAudio) {\r\n      // this.container.append(this.chatAudio.divAndCaption.container, this.chatUtils);\r\n      this.container.append(this.chatAudio.divAndCaption.container);\r\n    }\r\n\r\n    // * construction end\r\n\r\n    // * fix topbar overflow section\r\n\r\n    this.listenerSetter.add(window)('resize', this.onResize);\r\n    this.listenerSetter.add(mediaSizes)('changeScreen', this.onChangeScreen);\r\n\r\n    attachClickEvent(this.container, (e) => {\r\n      const container = findUpClassName(e.target, 'pinned-container');\r\n      blurActiveElement();\r\n      if(container) {\r\n        cancelEvent(e);\r\n\r\n        if(findUpClassName(e.target, 'progress-line')) {\r\n          return;\r\n        }\r\n        \r\n        const mid = +container.dataset.mid;\r\n        if(container.classList.contains('pinned-message')) {\r\n          //if(!this.pinnedMessage.locked) {\r\n            this.pinnedMessage.followPinnedMessage(mid);\r\n          //}\r\n        } else {\r\n          const peerId = container.dataset.peerId.toPeerId();\r\n          const searchContext = appMediaPlaybackController.getSearchContext();\r\n          this.chat.appImManager.setInnerPeer({\r\n            peerId, \r\n            lastMsgId: mid, \r\n            type: searchContext.isScheduled ? 'scheduled' : (searchContext.threadId ? 'discussion' : undefined), \r\n            threadId: searchContext.threadId\r\n          });\r\n        }\r\n      } else {\r\n        if(mediaSizes.activeScreen === ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n          onBtnBackClick();\r\n        } else if(findUpTag(e.target, 'AVATAR-ELEMENT')) {\r\n          this.appSidebarRight.toggleSidebar(!document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME));\r\n        } else {\r\n          this.appSidebarRight.toggleSidebar(true);\r\n        }\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const onBtnBackClick = (e?: Event) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n\r\n      //const item = appNavigationController.findItemByType('chat');\r\n      // * return manually to chat by arrow, since can't get back to\r\n      if(mediaSizes.activeScreen === ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n        this.chat.appImManager.setPeer({peerId: this.peerId});\r\n      } else {\r\n        const isFirstChat = this.chat.appImManager.chats.indexOf(this.chat) === 0;\r\n        appNavigationController.back(isFirstChat ? 'im' : 'chat');\r\n        /* return;\r\n\r\n        if(mediaSizes.activeScreen === ScreenSize.medium && !appNavigationController.findItemByType('chat')) {\r\n          this.chat.appImManager.setPeer(0);\r\n          blurActiveElement();\r\n        } else {\r\n          appNavigationController.back('chat');\r\n        } */\r\n      }\r\n    };\r\n\r\n    attachClickEvent(this.btnBack, onBtnBackClick, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  private pushButtonToVerify(element: HTMLElement, verify: ButtonToVerify['verify']) {\r\n    if(!element) {\r\n      return;\r\n    }\r\n    \r\n    this.buttonsToVerify.push({element, verify});\r\n  }\r\n\r\n  private verifyButtons = (e?: Event) => {\r\n    const isMenuOpen = !!e || !!(this.btnMore && this.btnMore.classList.contains('menu-open'));\r\n\r\n    e && cancelEvent(e);\r\n\r\n    const r = async() => {\r\n      const deleteButtonText = await this.managers.appPeersManager.getDeleteButtonText(this.peerId);\r\n      if(isMenuOpen) {\r\n        // delete button\r\n        this.menuButtons[this.menuButtons.length - 1].element.lastChild.replaceWith(i18n(deleteButtonText));\r\n      }\r\n  \r\n      const buttons = this.buttonsToVerify.concat(isMenuOpen ? this.menuButtons : []);\r\n      const results = await Promise.all(buttons.map(async(button) => {\r\n        return {\r\n          result: await button.verify(),\r\n          button\r\n        }\r\n      }));\r\n\r\n      results.forEach(({button, result}) => {\r\n        button.element.classList.toggle('hide', !result);\r\n      });\r\n    };\r\n\r\n    r();\r\n  };\r\n\r\n  private verifyVideoChatButton = async(type?: 'group' | 'broadcast') => {\r\n    if(!IS_GROUP_CALL_SUPPORTED || this.peerId.isUser()) return false;\r\n\r\n    const currentGroupCall = groupCallsController.groupCall;\r\n    const chatId = this.peerId.toChatId();\r\n    if(currentGroupCall?.chatId === chatId) {\r\n      return false;\r\n    }\r\n\r\n    if(type) {\r\n      if(((await this.managers.appPeersManager.isBroadcast(this.peerId)) && type === 'group') || \r\n        ((await this.managers.appPeersManager.isAnyGroup(this.peerId)) && type === 'broadcast')) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const chat = await this.managers.appChatsManager.getChatTyped(chatId);\r\n    return (chat as MTChat.chat).pFlags?.call_active || hasRights(chat, 'manage_call');\r\n  };\r\n\r\n  private verifyCallButton = async(type?: CallType) => {\r\n    if(!IS_CALL_SUPPORTED || !this.peerId.isUser()) return false;\r\n    const userId = this.peerId.toUserId();\r\n    const userFull = await this.managers.appProfileManager.getCachedFullUser(userId);\r\n\r\n    return !!userFull && !!(type === 'voice' ? userFull.pFlags.phone_calls_available : userFull.pFlags.video_calls_available);\r\n  };\r\n\r\n  public constructUtils() {\r\n    this.menuButtons = [{\r\n      icon: 'search',\r\n      text: 'Search',\r\n      onClick: () => {\r\n        this.chat.initSearch();\r\n      },\r\n      verify: () => mediaSizes.isMobile\r\n    }, /* {\r\n      icon: 'pinlist',\r\n      text: 'Pinned Messages',\r\n      onClick: () => this.openPinned(false),\r\n      verify: () => mediaSizes.isMobile\r\n    }, */{\r\n      icon: 'mute',\r\n      text: 'ChatList.Context.Mute',\r\n      onClick: this.onMuteClick,\r\n      verify: async() => this.chat.type === 'chat' && rootScope.myId !== this.peerId && !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false))\r\n    }, {\r\n      icon: 'unmute',\r\n      text: 'ChatList.Context.Unmute',\r\n      onClick: () => {\r\n        this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n      },\r\n      verify: async() => this.chat.type === 'chat' && rootScope.myId !== this.peerId && (await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false))\r\n    }, {\r\n      icon: 'comments',\r\n      text: 'ViewDiscussion',\r\n      onClick: () => {\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        Promise.resolve(this.managers.appProfileManager.getChannelFull(this.peerId.toChatId())).then((channelFull) => {\r\n          if(middleware() && channelFull.linked_chat_id) {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId: channelFull.linked_chat_id.toPeerId(true)\r\n            });\r\n          }\r\n        });\r\n      },\r\n      verify: async() => {\r\n        const chatFull = await this.managers.appProfileManager.getCachedFullChat(this.peerId.toChatId());\r\n        return this.chat.type === 'chat' && !!(chatFull as ChatFull.channelFull)?.linked_chat_id;\r\n      }\r\n    }, {\r\n      icon: 'phone',\r\n      text: 'Call',\r\n      onClick: this.onCallClick.bind(this, 'voice'),\r\n      verify: this.verifyCallButton.bind(this, 'voice')\r\n    }, {\r\n      icon: 'videocamera',\r\n      text: 'VideoCall',\r\n      onClick: this.onCallClick.bind(this, 'video'),\r\n      verify: this.verifyCallButton.bind(this, 'video')\r\n    }, {\r\n      icon: 'videochat',\r\n      text: 'PeerInfo.Action.LiveStream',\r\n      onClick: this.onJoinGroupCallClick,\r\n      verify: this.verifyVideoChatButton.bind(this, 'broadcast')\r\n    }, {\r\n      icon: 'videochat',\r\n      text: 'PeerInfo.Action.VoiceChat',\r\n      onClick: this.onJoinGroupCallClick,\r\n      verify: this.verifyVideoChatButton.bind(this, 'group')\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Chat.Menu.SelectMessages',\r\n      onClick: () => {\r\n        const selection = this.chat.selection;\r\n        selection.toggleSelection(true, true);\r\n        apiManagerProxy.getState().then((state) => {\r\n          if(state.chatContextMenuHintWasShown) {\r\n            return;\r\n          }\r\n\r\n          const original = selection.toggleByElement.bind(selection);\r\n          selection.toggleByElement = async(bubble) => {\r\n            this.managers.appStateManager.pushToState('chatContextMenuHintWasShown', true);\r\n            toast(i18n('Chat.Menu.Hint'));\r\n\r\n            selection.toggleByElement = original;\r\n            selection.toggleByElement(bubble);\r\n          };\r\n        });\r\n      },\r\n      verify: () => !this.chat.selection.isSelecting && !!this.chat.bubbles.getRenderedLength()\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Chat.Menu.ClearSelection',\r\n      onClick: () => {\r\n        this.chat.selection.cancelSelection();\r\n      },\r\n      verify: () => this.chat.selection.isSelecting\r\n    }, {\r\n      icon: 'adduser',\r\n      text: 'AddContact',\r\n      onClick: () => {\r\n        if(!this.appSidebarRight.isTabExists(AppEditContactTab)) {\r\n          const tab = this.appSidebarRight.createTab(AppEditContactTab);\r\n          tab.peerId = this.peerId;\r\n          tab.open();\r\n\r\n          this.appSidebarRight.toggleSidebar(true);\r\n        }\r\n      },\r\n      verify: async() => this.peerId.isUser() && !(await this.managers.appPeersManager.isContact(this.peerId))\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'ShareContact',\r\n      onClick: () => {\r\n        const contactPeerId = this.peerId;\r\n        new PopupPickUser({\r\n          peerTypes: ['dialogs', 'contacts'],\r\n          onSelect: (peerId) => {\r\n            return new Promise((resolve, reject) => {\r\n              new PopupPeer('', {\r\n                titleLangKey: 'SendMessageTitle',\r\n                descriptionLangKey: 'SendContactToGroupText',\r\n                descriptionLangArgs: [new PeerTitle({peerId, dialog: true}).element],\r\n                buttons: [{\r\n                  langKey: 'Send',\r\n                  callback: () => {\r\n                    resolve();\r\n\r\n                    this.managers.appMessagesManager.sendContact(peerId, contactPeerId);\r\n                    this.chat.appImManager.setInnerPeer({peerId});\r\n                  }\r\n                }, {\r\n                  langKey: 'Cancel',\r\n                  callback: () => {\r\n                    reject();\r\n                  },\r\n                  isCancel: true,\r\n                }],\r\n                peerId,\r\n                overlayClosable: true\r\n              }).show();\r\n            });\r\n          },\r\n          placeholder: 'ShareModal.Search.Placeholder',\r\n          chatRightsAction: 'send_messages',\r\n          selfPresence: 'ChatYourSelf'\r\n        });\r\n      },\r\n      verify: async() => rootScope.myId !== this.peerId && this.peerId.isUser() && (await this.managers.appPeersManager.isContact(this.peerId)) && !!(await this.managers.appUsersManager.getUser(this.peerId.toUserId())).phone\r\n    }, {\r\n      icon: 'lock',\r\n      text: 'BlockUser',\r\n      onClick: () => {\r\n        new PopupPeer('', {\r\n          peerId: this.peerId,\r\n          titleLangKey: 'BlockUser',\r\n          descriptionLangKey: 'AreYouSureBlockContact2',\r\n          descriptionLangArgs: [new PeerTitle({peerId: this.peerId}).element],\r\n          buttons: [{\r\n            langKey: 'BlockUser',\r\n            isDanger: true,\r\n            callback: () => {\r\n              this.managers.appUsersManager.toggleBlock(this.peerId, true).then((value) => {\r\n                if(value) {\r\n                  toastNew({langPackKey: 'UserBlocked'});\r\n                }\r\n              });\r\n            }\r\n          }]\r\n        }).show();\r\n      },\r\n      verify: async() => {\r\n        if(!this.peerId.isUser()) return false;\r\n        const userFull = await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId());\r\n        return this.peerId !== rootScope.myId && userFull && !userFull.pFlags?.blocked;\r\n      }\r\n    }, {\r\n      icon: 'lockoff',\r\n      text: 'Unblock',\r\n      onClick: () => {\r\n        this.managers.appUsersManager.toggleBlock(this.peerId, false).then((value) => {\r\n          if(value) {\r\n            toastNew({langPackKey: 'UserUnblocked'});\r\n          }\r\n        });\r\n      },\r\n      verify: async() => {\r\n        const userFull = await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId());\r\n        return !!userFull?.pFlags?.blocked;\r\n      }\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: () => {\r\n        new PopupDeleteDialog(this.peerId/* , 'leave' */);\r\n      },\r\n      verify: async() => this.chat.type === 'chat' && !!(await this.managers.appMessagesManager.getDialogOnly(this.peerId))\r\n    }];\r\n\r\n    this.btnSearch = ButtonIcon('search');\r\n    this.attachClickEvent(this.btnSearch, (e) => {\r\n      this.chat.initSearch();\r\n    }, true);\r\n  }\r\n\r\n  public attachClickEvent(el: HTMLElement, cb: (e: MouseEvent) => void, noBlur?: boolean) {\r\n    attachClickEvent(el, (e) => {\r\n      cancelEvent(e);\r\n      !noBlur && blurActiveElement();\r\n      cb(e);\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  private onCallClick(type: CallType) {\r\n    this.chat.appImManager.callUser(this.peerId.toUserId(), type);\r\n  }\r\n\r\n  private onJoinGroupCallClick = () => {\r\n    this.chat.appImManager.joinGroupCall(this.peerId);\r\n  };\r\n\r\n  private constructAvatar() {\r\n    const avatarElement = new AvatarElement();\r\n    avatarElement.isDialog = true;\r\n    avatarElement.classList.add('avatar-42', 'person-avatar');\r\n    return avatarElement;\r\n  }\r\n\r\n  private get peerId() {\r\n    return this.chat.peerId;\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    this.avatarElement = this.constructAvatar();\r\n    \r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('info');\r\n\r\n    this.pinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n\r\n    this.btnJoin = Button('btn-primary btn-color-primary chat-join hide');\r\n    this.btnCall = ButtonIcon('phone');\r\n    this.btnGroupCall = ButtonIcon('videochat');\r\n    this.btnPinned = ButtonIcon('pinlist');\r\n    this.btnMute = ButtonIcon('mute');\r\n\r\n    this.attachClickEvent(this.btnCall, this.onCallClick.bind(this, 'voice'));\r\n    this.attachClickEvent(this.btnGroupCall, this.onJoinGroupCallClick);\r\n\r\n    this.attachClickEvent(this.btnPinned, () => {\r\n      this.openPinned(true);\r\n    });\r\n\r\n    this.attachClickEvent(this.btnMute, this.onMuteClick);\r\n\r\n    this.attachClickEvent(this.btnJoin, async() => {\r\n      const middleware = this.chat.bubbles.getMiddleware();\r\n      this.btnJoin.setAttribute('disabled', 'true');\r\n\r\n      const chatId = this.peerId.toChatId();\r\n      let promise: Promise<any>;\r\n      if(await this.managers.appChatsManager.isChannel(chatId)) {\r\n        promise = this.managers.appChatsManager.joinChannel(chatId);\r\n      } else {\r\n        promise = this.managers.appChatsManager.addChatUser(chatId, rootScope.myId);\r\n      }\r\n\r\n      promise.finally(() => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        this.btnJoin.removeAttribute('disabled');\r\n      });\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', async(chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        const chat = await this.managers.appChatsManager.getChat(chatId) as Channel/*  | Chat */;\r\n        \r\n        this.btnJoin.classList.toggle('hide', !(chat as Channel)?.pFlags?.left);\r\n        this.setUtilsWidth();\r\n        this.verifyButtons();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_notify_settings', (dialog) => {\r\n      if(dialog.peerId === this.peerId) {\r\n        this.setMutedState();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_typings', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('user_update', (userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_full_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        this.verifyButtons();\r\n      }\r\n    });\r\n\r\n    if(this.pinnedMessage) {\r\n      this.chat.addEventListener('setPeer', (mid, isTopMessage) => {\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        apiManagerProxy.getState().then((state) => {\r\n          if(!middleware()) return;\r\n  \r\n          this.pinnedMessage.hidden = !!state.hiddenPinnedMessages[this.chat.peerId];\r\n  \r\n          if(isTopMessage) {\r\n            this.pinnedMessage.unsetScrollDownListener();\r\n            this.pinnedMessage.testMid(mid, 0); // * because slider will not let get bubble by document.elementFromPoint\r\n          } else if(!this.pinnedMessage.locked) {\r\n            this.pinnedMessage.handleFollowingPinnedMessage();\r\n            this.pinnedMessage.testMid(mid);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    this.setPeerStatusInterval = window.setInterval(this.setPeerStatus, 60e3);\r\n\r\n    return this;\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', ({peerId, mids}) => {\r\n      if(peerId !== this.peerId) return;\r\n\r\n      if(mids) {\r\n        this.setTitle();\r\n      }\r\n    });\r\n  }\r\n  \r\n  public constructDiscussionHelpers() {\r\n    this.pinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n  }\r\n\r\n  public openPinned(byCurrent: boolean) {\r\n    this.chat.appImManager.setInnerPeer({\r\n      peerId: this.peerId, \r\n      lastMsgId: byCurrent ? +this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.dataset.mid : 0, \r\n      type: 'pinned'\r\n    });\r\n  }\r\n\r\n  private onMuteClick = () => {\r\n    new PopupMute(this.peerId);\r\n  };\r\n\r\n  private onResize = () => {\r\n    this.setUtilsWidth(true);\r\n    this.setFloating();\r\n  };\r\n\r\n  private onChangeScreen = (from: ScreenSize, to: ScreenSize) => {\r\n    this.container.classList.toggle('is-pinned-floating', mediaSizes.isMobile);\r\n    // this.chatAudio && this.chatAudio.divAndCaption.container.classList.toggle('is-floating', to === ScreenSize.mobile);\r\n    this.pinnedMessage && this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-floating', to === ScreenSize.mobile);\r\n    this.onResize();\r\n  };\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Topbar destroying');\r\n    this.listenerSetter.removeAll();\r\n    window.clearInterval(this.setPeerStatusInterval);\r\n    \r\n    if(this.pinnedMessage) {\r\n      this.pinnedMessage.destroy(); // * возможно это можно не делать\r\n    }\r\n\r\n    if(this.chatAudio) {\r\n      this.chatAudio.destroy();\r\n    }\r\n\r\n    delete this.chatAudio;\r\n    delete this.pinnedMessage;\r\n  }\r\n\r\n  public cleanup() {\r\n    if(!this.chat.peerId) {\r\n      this.container.classList.add('hide');\r\n    }\r\n  }\r\n\r\n  public async finishPeerChange(isTarget: boolean) {\r\n    const peerId = this.peerId;\r\n\r\n    let newAvatar: AvatarElement;\r\n    if(this.avatarElement) {\r\n      newAvatar = this.constructAvatar();\r\n    }\r\n\r\n    const [isBroadcast, isAnyChat, chat, _, setTitleCallback, setStatusCallback, state] = await Promise.all([\r\n      this.managers.appPeersManager.isBroadcast(peerId),\r\n      this.managers.appPeersManager.isAnyChat(peerId),\r\n      peerId.isAnyChat() ? this.managers.appChatsManager.getChat(peerId.toChatId()) : undefined,\r\n      newAvatar ? newAvatar.updateWithOptions({peerId}) : undefined,\r\n      this.setTitleManual(),\r\n      this.setPeerStatusManual(true),\r\n      apiManagerProxy.getState()\r\n    ]);\r\n\r\n    return () => {\r\n      this.btnMute && this.btnMute.classList.toggle('hide', !isBroadcast);\r\n      if(this.btnJoin) {\r\n        if(isAnyChat) {\r\n          replaceContent(this.btnJoin, i18n(isBroadcast ? 'Chat.Subscribe' : 'ChannelJoin'));\r\n          this.btnJoin.classList.toggle('hide', !chat?.pFlags?.left);\r\n        } else {\r\n          this.btnJoin.classList.add('hide');\r\n        }\r\n      }\r\n\r\n      if(newAvatar) {\r\n        this.avatarElement.replaceWith(newAvatar);\r\n        this.avatarElement = newAvatar;\r\n      }\r\n  \r\n      this.setUtilsWidth();\r\n  \r\n      this.verifyButtons();\r\n  \r\n      if(this.pinnedMessage) { // * replace with new one\r\n        if(this.chat.type === 'chat') {\r\n          if(this.chat.wasAlreadyUsed) { // * change\r\n            const newPinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n            this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.replaceWith(newPinnedMessage.pinnedMessageContainer.divAndCaption.container);\r\n            this.pinnedMessage.destroy();\r\n            //this.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n            this.pinnedMessage = newPinnedMessage;\r\n          }\r\n          \r\n          this.pinnedMessage.hidden = !!state.hiddenPinnedMessages[peerId];\r\n        } else if(this.chat.type === 'discussion') {\r\n          this.pinnedMessage.pinnedMid = this.chat.threadId;\r\n          this.pinnedMessage.count = 1;\r\n          this.pinnedMessage.pinnedIndex = 0;\r\n          this.pinnedMessage._setPinnedMessage();\r\n        }\r\n      }\r\n  \r\n      setTitleCallback();\r\n      setStatusCallback && setStatusCallback();\r\n      this.setMutedState();\r\n\r\n      this.container.classList.remove('hide');\r\n    };\r\n  }\r\n\r\n  public async setTitleManual(count?: number) {\r\n    const peerId = this.peerId;\r\n    const middleware = () => this.peerId === peerId;\r\n    let titleEl: HTMLElement, icons: Element[];\r\n    if(this.chat.type === 'pinned') {\r\n      if(count === undefined) titleEl = i18n('Loading');\r\n      else titleEl = i18n('PinnedMessagesCount', [count]);\r\n\r\n      if(count === undefined) {\r\n        this.managers.appMessagesManager.getSearchCounters(peerId, [{_: 'inputMessagesFilterPinned'}], false).then((result) => {\r\n          if(!middleware()) return;\r\n          const count = result[0].count;\r\n          this.setTitle(count);\r\n\r\n          // ! костыль х2, это нужно делать в другом месте\r\n          if(!count) {\r\n            this.chat.appImManager.setPeer(); // * close tab\r\n\r\n            // ! костыль, это скроет закреплённые сообщения сразу, вместо того, чтобы ждать пока анимация перехода закончится\r\n            const originalChat = this.chat.appImManager.chat;\r\n            if(originalChat.topbar.pinnedMessage) {\r\n              originalChat.topbar.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n            }\r\n          }\r\n        });\r\n      }\r\n    } else if(this.chat.type === 'scheduled') {\r\n      titleEl = i18n(peerId === rootScope.myId ? 'Reminders' : 'ScheduledMessages');\r\n    } else if(this.chat.type === 'discussion') {\r\n      if(count === undefined) {\r\n        const result = await this.managers.acknowledged.appMessagesManager.getHistory(peerId, 0, 1, 0, this.chat.threadId);\r\n        if(result.cached) {\r\n          const historyResult = await result.result;\r\n          count = historyResult.count;\r\n        } else result.result.then((historyResult) => this.setTitle(historyResult.count));\r\n      }\r\n\r\n      if(count === undefined) titleEl = i18n('Loading');\r\n      else titleEl = i18n('Chat.Title.Comments', [count]);\r\n    } else if(this.chat.type === 'chat') {\r\n      [titleEl, icons] = await Promise.all([\r\n        wrapPeerTitle({\r\n          peerId,\r\n          dialog: true\r\n        }),\r\n        generateTitleIcons(peerId)\r\n      ]);\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    return () => {\r\n      replaceContent(this.title, titleEl);\r\n      if(icons) {\r\n        this.title.append(...icons);\r\n      }\r\n    };\r\n  }\r\n\r\n  public setTitle(count?: number) {\r\n    this.setTitleManual(count).then((setTitleCallback) => setTitleCallback());\r\n  }\r\n\r\n  public async setMutedState() {\r\n    if(!this.btnMute) return;\r\n\r\n    const peerId = this.peerId;\r\n    let muted = await this.managers.appNotificationsManager.isPeerLocalMuted(peerId, false);\r\n    if(await this.managers.appPeersManager.isBroadcast(peerId)) { // not human\r\n      this.btnMute.classList.remove('tgico-mute', 'tgico-unmute');\r\n      this.btnMute.classList.add(muted ? 'tgico-unmute' : 'tgico-mute');\r\n      this.btnMute.style.display = '';\r\n    } else {\r\n      this.btnMute.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  // ! У МЕНЯ ПРОСТО СГОРЕЛО, САФАРИ КОНЧЕННЫЙ БРАУЗЕР - ЕСЛИ НЕ СКРЫВАТЬ БЛОК, ТО ПРИ ПЕРЕВОРОТЕ ЭКРАНА НА АЙФОНЕ БЛОК БУДЕТ НЕПРАВИЛЬНО ШИРИНЫ, ДАЖЕ БЕЗ ЭТОЙ ФУНКЦИИ!\r\n  public setUtilsWidth = (resize = false) => {\r\n    //return;\r\n    if(this.setUtilsRAF) window.cancelAnimationFrame(this.setUtilsRAF);\r\n\r\n    if(IS_SAFARI && resize) {\r\n      this.chatUtils.classList.add('hide');\r\n    }\r\n\r\n    //mutationObserver.disconnect();\r\n    this.setUtilsRAF = window.requestAnimationFrame(() => {\r\n      \r\n      //mutationRAF = window.requestAnimationFrame(() => {\r\n        \r\n        //setTimeout(() => {\r\n          if(IS_SAFARI && resize) {\r\n            this.chatUtils.classList.remove('hide');\r\n          }\r\n          /* this.chatInfo.style.removeProperty('--utils-width');\r\n          void this.chatInfo.offsetLeft; // reflow */\r\n          const width = /* chatUtils.scrollWidth */this.chatUtils.getBoundingClientRect().width;\r\n          this.chat.log('utils width:', width);\r\n          this.container.style.setProperty('--utils-width', width + 'px');\r\n          //this.chatInfo.classList.toggle('have-utils-width', !!width);\r\n        //}, 0);\r\n        \r\n        this.setUtilsRAF = 0;\r\n\r\n        //mutationObserver.observe(chatUtils, observeOptions);\r\n      //});\r\n    });\r\n  };\r\n\r\n  public setFloating = () => {\r\n    const containers = [this.chatAudio, this.pinnedMessage && this.pinnedMessage.pinnedMessageContainer].filter(Boolean);\r\n    const count = containers.reduce((acc, container) => {\r\n      const isFloating = container.isFloating();\r\n      this.container.classList.toggle(`is-pinned-${container.className}-floating`, isFloating);\r\n\r\n      if(!container.isVisible()) {\r\n        return acc;\r\n      }\r\n\r\n      return acc + +isFloating;\r\n    }, 0);\r\n    this.container.dataset.floating = '' + count;\r\n  };\r\n\r\n  public setPeerStatusManual = async(needClear = false) => {\r\n    if(!this.subtitle) return;\r\n\r\n    const peerId = this.peerId;\r\n    return this.chat.appImManager.setPeerStatus(\r\n      peerId, \r\n      this.subtitle, \r\n      needClear, \r\n      false, \r\n      () => peerId === this.peerId\r\n    );\r\n  };\r\n\r\n  public setPeerStatus = (needClear?: boolean) => {\r\n    return this.setPeerStatusManual(needClear).then((callback) => {\r\n      if(callback) {\r\n        callback();\r\n      }\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarRight from \"..\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport AppSearch, { SearchGroup } from \"../../appSearch\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport PopupElement from \"../../popups\";\r\nimport PopupDatePicker from \"../../popups/datePicker\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppPrivateSearchTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private appSearch: AppSearch;\r\n  private btnPickDate: HTMLElement;\r\n\r\n  private peerId: PeerId;\r\n  private threadId = 0;\r\n  private query = '';\r\n  private onDatePick: (timestamp: number) => void;\r\n\r\n  onOpenAfterTimeout() {\r\n    this.appSearch.beginSearch(this.peerId, this.threadId, this.query);\r\n  }\r\n\r\n  protected init() {\r\n    this.container.id = 'search-private-container';\r\n    this.container.classList.add('chatlist-container');\r\n    this.inputSearch = new InputSearch('Search');\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.btnPickDate = ButtonIcon('calendar sidebar-header-right');\r\n    this.header.append(this.btnPickDate);\r\n\r\n    const c = document.createElement('div');\r\n    c.classList.add('chatlist-container');\r\n    this.scrollable.container.replaceWith(c);\r\n    this.appSearch = new AppSearch(c, this.inputSearch, {\r\n      messages: new SearchGroup('Chat.Search.PrivateSearch', 'messages')\r\n    });\r\n  }\r\n\r\n  open(peerId: PeerId, threadId?: number, onDatePick?: AppPrivateSearchTab['onDatePick'], query?: string) {\r\n    const ret = super.open();\r\n\r\n    if(!this.peerId) {\r\n      this.query = query;\r\n      this.peerId = peerId;\r\n      this.threadId = threadId;\r\n      this.onDatePick = onDatePick;\r\n  \r\n      this.btnPickDate.classList.toggle('hide', !this.onDatePick);\r\n      if(this.onDatePick) {\r\n        attachClickEvent(this.btnPickDate, () => {\r\n          PopupElement.createPopup(PopupDatePicker, new Date(), this.onDatePick).show();\r\n        });\r\n      }\r\n\r\n      query && this.appSearch.searchInput.inputField.setValueSilently(query);\r\n  \r\n      appSidebarRight.toggleSidebar(true);\r\n    } else {\r\n      this.appSearch.beginSearch(this.peerId, this.threadId, query);\r\n    }\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatTopbar from \"./topbar\";\r\nimport AppSearch, { SearchGroup } from \"../appSearch\";\r\nimport PopupDatePicker from \"../popups/datePicker\";\r\nimport ripple from \"../ripple\";\r\nimport InputSearch from \"../inputSearch\";\r\nimport type Chat from \"./chat\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport PopupElement from \"../popups\";\r\nimport { DIALOG_LIST_ELEMENT_TAG } from \"../../lib/appManagers/appDialogsManager\";\r\n\r\nexport default class ChatSearch {\r\n  private element: HTMLElement;\r\n  private backBtn: HTMLElement;\r\n  private inputSearch: InputSearch;\r\n\r\n  private results: HTMLElement;\r\n\r\n  private footer: HTMLElement;\r\n  private dateBtn: HTMLElement;\r\n  private foundCountEl: HTMLElement;\r\n  private controls: HTMLElement;\r\n  private downBtn: HTMLElement;\r\n  private upBtn: HTMLElement;\r\n\r\n  private appSearch: AppSearch;\r\n  private searchGroup: SearchGroup;\r\n\r\n  private foundCount = 0;\r\n  private selectedIndex = 0;\r\n  private setPeerPromise: Promise<any>;\r\n  private listenerSetter: ListenerSetter;\r\n  private navigationItem: NavigationItem;\r\n\r\n  constructor(private topbar: ChatTopbar, private chat: Chat, query?: string) {\r\n    this.element = document.createElement('div');\r\n    this.element.classList.add('sidebar-header', 'chat-search', 'chatlist-container');\r\n\r\n    this.backBtn = document.createElement('button');\r\n    this.backBtn.classList.add('btn-icon', 'tgico-left', 'sidebar-close-button');\r\n    ripple(this.backBtn);\r\n\r\n    const listenerSetter = this.listenerSetter = new ListenerSetter();\r\n\r\n    const attachClick = (element: HTMLElement, callback: (e: MouseEvent) => void) => {\r\n      attachClickEvent(element, callback, {listenerSetter});\r\n    };\r\n    \r\n    attachClick(this.backBtn, () => {\r\n      this.destroy();\r\n    });\r\n\r\n    this.inputSearch = new InputSearch('Search');\r\n    \r\n    // Results\r\n    this.results = document.createElement('div');\r\n    this.results.classList.add('chat-search-results', 'chatlist-container');\r\n\r\n    this.searchGroup = new SearchGroup(false, 'messages', undefined, '', false);\r\n    attachClick(this.searchGroup.list, this.onResultsClick);\r\n\r\n    this.appSearch = new AppSearch(this.results, this.inputSearch, {\r\n      messages: this.searchGroup\r\n    }, (count) => {\r\n      this.foundCount = count;\r\n\r\n      if(!this.foundCount) {\r\n        replaceContent(this.foundCountEl, this.inputSearch.value ? i18n('NoResult') : '');\r\n        this.results.classList.remove('active');\r\n        this.chat.bubbles.container.classList.remove('search-results-active');\r\n        this.upBtn.setAttribute('disabled', 'true');\r\n        this.downBtn.setAttribute('disabled', 'true');\r\n      } else {\r\n        this.selectResult(this.searchGroup.list.children[0] as HTMLElement);\r\n      }\r\n    });\r\n    this.appSearch.beginSearch(this.chat.peerId, this.chat.threadId);\r\n\r\n    //appImManager.topbar.parentElement.insertBefore(this.results, appImManager.bubblesContainer);\r\n    this.chat.bubbles.container.append(this.results);\r\n\r\n    // Footer\r\n    this.footer = document.createElement('div');\r\n    this.footer.classList.add('chat-search-footer');\r\n\r\n    attachClick(this.footer, this.onFooterClick);\r\n    ripple(this.footer);\r\n\r\n    this.foundCountEl = document.createElement('span');\r\n    this.foundCountEl.classList.add('chat-search-count');\r\n\r\n    this.dateBtn = document.createElement('button');\r\n    this.dateBtn.classList.add('btn-icon', 'tgico-calendar');\r\n\r\n    this.controls = document.createElement('div');\r\n    this.controls.classList.add('chat-search-controls');\r\n\r\n    this.upBtn = document.createElement('button');\r\n    this.upBtn.classList.add('btn-icon', 'tgico-up');\r\n    this.downBtn = document.createElement('button');\r\n    this.downBtn.classList.add('btn-icon', 'tgico-down');\r\n\r\n    this.upBtn.setAttribute('disabled', 'true');\r\n    this.downBtn.setAttribute('disabled', 'true');\r\n\r\n    attachClick(this.dateBtn, this.onDateClick);\r\n    attachClick(this.upBtn, this.onUpClick);\r\n    attachClick(this.downBtn, this.onDownClick);\r\n    this.controls.append(this.upBtn, this.downBtn);\r\n\r\n    this.footer.append(this.foundCountEl, this.dateBtn, this.controls);\r\n    \r\n    this.topbar.container.parentElement.insertBefore(this.footer, chat.input.chatInput);\r\n\r\n    // Append container\r\n    this.element.append(this.backBtn, this.inputSearch.container);\r\n\r\n    this.topbar.container.classList.add('hide-pinned');\r\n    this.topbar.container.parentElement.append(this.element);\r\n\r\n    this.inputSearch.input.focus();\r\n\r\n    if(query) {\r\n      this.setQuery(query);\r\n    }\r\n\r\n    if(!IS_MOBILE_SAFARI) {\r\n      this.navigationItem = {\r\n        type: 'mobile-search',\r\n        onPop: () => {\r\n          this.destroy();\r\n        }\r\n      };\r\n  \r\n      appNavigationController.pushItem(this.navigationItem);\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    this.topbar.container.classList.remove('hide-pinned');\r\n    this.element.remove();\r\n    this.inputSearch.remove();\r\n    this.results.remove();\r\n    this.footer.remove();\r\n    this.listenerSetter.removeAll();\r\n    this.chat.bubbles.container.classList.remove('search-results-active');\r\n    this.chat.search = undefined;\r\n    appNavigationController.removeItem(this.navigationItem);\r\n  }\r\n\r\n  public setQuery(query: string) {\r\n    this.inputSearch.inputField.value = query;\r\n  }\r\n\r\n  private onDateClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    PopupElement.createPopup(PopupDatePicker, new Date(), this.chat.bubbles.onDatePick).show();\r\n  };\r\n\r\n  private selectResult(elem: HTMLElement) {\r\n    if(this.setPeerPromise) return this.setPeerPromise;\r\n\r\n    const peerId = elem.dataset.peerId.toPeerId();\r\n    const lastMsgId = +elem.dataset.mid || undefined;\r\n\r\n    const index = whichChild(elem);\r\n\r\n    if(index === (this.foundCount - 1)) {\r\n      this.upBtn.setAttribute('disabled', 'true');\r\n    } else {\r\n      this.upBtn.removeAttribute('disabled');\r\n    }\r\n\r\n    if(!index) {\r\n      this.downBtn.setAttribute('disabled', 'true');\r\n    } else {\r\n      this.downBtn.removeAttribute('disabled');\r\n    }\r\n\r\n    this.results.classList.remove('active');\r\n    this.chat.bubbles.container.classList.remove('search-results-active');\r\n\r\n    const res = this.chat.setPeer(peerId, lastMsgId);\r\n    this.setPeerPromise = ((res instanceof Promise ? res : Promise.resolve(res)) as Promise<any>).then(() => {\r\n      this.selectedIndex = index;\r\n      replaceContent(this.foundCountEl, i18n('Of', [index + 1, this.foundCount]));\r\n\r\n      const renderedCount = this.searchGroup.list.childElementCount;\r\n      if(this.selectedIndex >= (renderedCount - 6)) {\r\n        this.appSearch.searchMore();\r\n      }\r\n    }).finally(() => {\r\n      this.setPeerPromise = null;\r\n    });\r\n  }\r\n\r\n  private onResultsClick = (e: MouseEvent) => {\r\n    const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n    if(target) {\r\n      this.selectResult(target);\r\n    }\r\n  };\r\n\r\n  private onFooterClick = (e: MouseEvent) => {\r\n    if(this.foundCount) {\r\n      this.chat.bubbles.container.classList.toggle('search-results-active');\r\n      this.results.classList.toggle('active');\r\n    }\r\n  };\r\n\r\n  private onUpClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    this.selectResult(this.searchGroup.list.children[this.selectedIndex + 1] as HTMLElement);\r\n  };\r\n\r\n  private onDownClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    this.selectResult(this.searchGroup.list.children[this.selectedIndex - 1] as HTMLElement);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport deepEqual from \"../../helpers/object/deepEqual\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\n\r\ntype ChatBackgroundPatternRendererInitOptions = {\r\n  url: string,\r\n  width: number,\r\n  height: number,\r\n  mask?: boolean\r\n};\r\n\r\nexport default class ChatBackgroundPatternRenderer {\r\n  private static INSTANCES: ChatBackgroundPatternRenderer[] = [];\r\n\r\n  // private pattern: CanvasPattern;\r\n  private objectUrl: string;\r\n  private options: ChatBackgroundPatternRendererInitOptions;\r\n  private canvases: Set<HTMLCanvasElement>;\r\n  // private createCanvasPatternPromise: Promise<CanvasPattern>;\r\n  // private exportCanvasPatternToImagePromise: Promise<string>;\r\n  private renderImageFromUrlPromise: Promise<HTMLImageElement>;\r\n  private img: HTMLImageElement;\r\n\r\n  constructor() {\r\n    this.canvases = new Set();\r\n  }\r\n\r\n  public static getInstance(options: ChatBackgroundPatternRendererInitOptions) {\r\n    let instance = this.INSTANCES.find((instance) => {\r\n      return deepEqual(instance.options, options);\r\n    });\r\n\r\n    if(!instance) {\r\n      instance = new ChatBackgroundPatternRenderer();\r\n      instance.init(options);\r\n      this.INSTANCES.push(instance);\r\n    }\r\n\r\n    return instance;\r\n  }\r\n\r\n  public init(options: ChatBackgroundPatternRendererInitOptions) {\r\n    // if(this.options) {\r\n    //   if(this.options.width !== options.width || this.options.height !== options.height) {\r\n    //     this.createCanvasPatternPromise = \r\n    //       this.pattern = \r\n    //       this.exportCanvasPatternToImagePromise = \r\n    //       undefined;\r\n    //   }\r\n    // }\r\n\r\n    this.options = options;\r\n  }\r\n\r\n  public renderToCanvas(canvas: HTMLCanvasElement) {\r\n    // return this.createCanvasPattern(canvas).then(() => {\r\n      // return this.fillCanvas(canvas);\r\n    // });\r\n\r\n    return this.renderImageFromUrl(this.options.url).then(() => {\r\n      return this.fillCanvas(canvas);\r\n    });\r\n  }\r\n\r\n  private renderImageFromUrl(url: string) {\r\n    if(this.renderImageFromUrlPromise) return this.renderImageFromUrlPromise;\r\n    const img = this.img = document.createElement('img');\r\n    img.crossOrigin = 'anonymous';\r\n    return this.renderImageFromUrlPromise = renderImageFromUrlPromise(img, url, false).then(() => img);\r\n  }\r\n\r\n  /* private createCanvasPattern(canvas: HTMLCanvasElement) {\r\n    if(this.createCanvasPatternPromise) return this.createCanvasPatternPromise;\r\n    return this.createCanvasPatternPromise = this.renderImageFromUrl(this.options.url).then((img) => {\r\n      let createPatternFrom: HTMLImageElement | HTMLCanvasElement;\r\n      if(IS_SAFARI) {\r\n        const canvas = createPatternFrom = document.createElement('canvas');\r\n        canvas.width = img.naturalWidth;\r\n        canvas.height = img.naturalHeight;\r\n        const ctx = canvas.getContext('2d');\r\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n      } else {\r\n        createPatternFrom = img;\r\n      }\r\n      \r\n      const perf = performance.now();\r\n      this.pattern = canvas.getContext('2d').createPattern(createPatternFrom, 'repeat-x');\r\n      console.warn('creating pattern time:', performance.now() - perf);\r\n\r\n      return this.pattern;\r\n    });\r\n  }\r\n\r\n  public exportCanvasPatternToImage(canvas: HTMLCanvasElement) {\r\n    if(this.exportCanvasPatternToImagePromise) return this.exportCanvasPatternToImagePromise;\r\n    return this.exportCanvasPatternToImagePromise = new Promise<string>((resolve) => {\r\n      canvas.toBlob((blob) => {\r\n        const newUrl = this.objectUrl = URL.createObjectURL(blob);\r\n        resolve(newUrl);\r\n      }, 'image/png');\r\n    });\r\n  } */\r\n\r\n  public cleanup(canvas: HTMLCanvasElement) {\r\n    this.canvases.delete(canvas);\r\n\r\n    if(!this.canvases.size) {\r\n      indexOfAndSplice(ChatBackgroundPatternRenderer.INSTANCES, this);\r\n\r\n      if(this.objectUrl) {\r\n        URL.revokeObjectURL(this.objectUrl);\r\n      }\r\n    }\r\n  }\r\n\r\n  public fillCanvas(canvas: HTMLCanvasElement) {\r\n    const context = canvas.getContext('2d');\r\n    const {width, height} = canvas;\r\n    // const perf = performance.now();\r\n    // if(context.fillStyle instanceof CanvasPattern) {\r\n    //   context.clearRect(0, 0, width, height);\r\n    // }\r\n\r\n    const img = this.img;\r\n\r\n    let imageWidth = img.width, imageHeight = img.height;\r\n    // if(imageHeight < height) {\r\n      let patternHeight = 1480 * canvas.dpr;\r\n      // * correct\r\n      // if(+canvas.dataset.originalHeight !== height) hhh *= 2 / 3;\r\n      // * but have to make it good\r\n      if(+canvas.dataset.originalHeight !== height) patternHeight *= .875;\r\n      const ratio = patternHeight / imageHeight;\r\n      imageWidth *= ratio;\r\n      imageHeight = patternHeight;\r\n    // }\r\n\r\n    if(this.options.mask) {\r\n      context.fillStyle = '#000';\r\n      context.fillRect(0, 0, width, height);\r\n      context.globalCompositeOperation = 'destination-out';\r\n    } else {\r\n      context.globalCompositeOperation = 'source-over';\r\n    }\r\n\r\n    const d = (y: number) => {\r\n      for(let x = 0; x < width; x += imageWidth) {\r\n        context.drawImage(img, x, y, imageWidth, imageHeight);\r\n      }\r\n    };\r\n\r\n    const centerY = height / 2 - imageHeight / 2;\r\n    d(centerY);\r\n\r\n    if(centerY > 0) {\r\n      let topY = centerY;\r\n      do {\r\n        d(topY -= imageHeight);\r\n      } while(topY >= 0);\r\n    }\r\n\r\n    const endY = height - 1;\r\n    for(let bottomY = centerY + imageHeight; bottomY < endY; bottomY += imageHeight) {\r\n      d(bottomY);\r\n    }\r\n\r\n    // for(let x = 0; x < width; x += imageWidth) {\r\n    //   for(let y = 0; y < height; y += imageHeight) {\r\n    //     context.drawImage(img, x, y, imageWidth, imageHeight);\r\n    //   }\r\n    // }\r\n    // context.fillStyle = this.pattern;\r\n    // context.fillRect(0, 0, width, height);\r\n    // console.warn('fill canvas time', performance.now() - perf);\r\n  }\r\n\r\n  public setCanvasDimensions(canvas: HTMLCanvasElement) {\r\n    const devicePixelRatio = Math.min(2, window.devicePixelRatio);\r\n    let width = this.options.width * devicePixelRatio, \r\n      height = this.options.height * devicePixelRatio;\r\n\r\n    canvas.dpr = devicePixelRatio;\r\n    canvas.dataset.originalHeight = '' + height;\r\n    if(mediaSizes.activeScreen === ScreenSize.large) height *= 1.5;\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n\r\n  }\r\n\r\n  public createCanvas() {\r\n    const canvas = document.createElement('canvas');\r\n    this.canvases.add(canvas);\r\n    this.setCanvasDimensions(canvas);\r\n    return canvas;\r\n  }\r\n\r\n  public resize(width: number, height: number) {\r\n    this.init({\r\n      ...this.options,\r\n      width,\r\n      height\r\n    });\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(const canvas of this.canvases) {\r\n      this.setCanvasDimensions(canvas);\r\n      promises.push(this.renderToCanvas(canvas));\r\n    }\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  public static resizeInstances(width: number, height: number) {\r\n    return Promise.all(this.INSTANCES.map((instance) => instance.resize(width, height)));\r\n  }\r\n\r\n  /* public setResizeMode(resizing: boolean) {\r\n    const canvases = Array.from(this.canvases);\r\n    const canvas = canvases[canvases.length - 1];\r\n    canvas.style.display = resizing ? 'none' : '';\r\n    const img = this.img;\r\n    img.style.display = resizing ? '' : 'none';\r\n\r\n    return {img, canvas};\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { ChatRights } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppImManager } from \"../../lib/appManagers/appImManager\";\r\nimport type { MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { logger, LogTypes } from \"../../lib/logger\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appSidebarRight from \"../sidebarRight\";\r\nimport ChatBubbles from \"./bubbles\";\r\nimport ChatContextMenu from \"./contextMenu\";\r\nimport ChatInput from \"./input\";\r\nimport ChatSelection from \"./selection\";\r\nimport ChatTopbar from \"./topbar\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport AppPrivateSearchTab from \"../sidebarRight/tabs/search\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport ChatSearch from \"./search\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport getAutoDownloadSettingsByPeerId, { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport ChatBackgroundGradientRenderer from \"./gradientRenderer\";\r\nimport ChatBackgroundPatternRenderer from \"./patternRenderer\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport SlicedArray from \"../../helpers/slicedArray\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport AppSharedMediaTab from \"../sidebarRight/tabs/sharedMedia\";\r\nimport noop from \"../../helpers/noop\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport { Message } from \"../../layer\";\r\n\r\nexport type ChatType = 'chat' | 'pinned' | 'replies' | 'discussion' | 'scheduled';\r\n\r\nexport default class Chat extends EventListenerBase<{\r\n  setPeer: (mid: number, isTopMessage: boolean) => void\r\n}> {\r\n  public container: HTMLElement;\r\n  public backgroundEl: HTMLElement;\r\n\r\n  public topbar: ChatTopbar;\r\n  public bubbles: ChatBubbles;\r\n  public input: ChatInput;\r\n  public selection: ChatSelection;\r\n  public contextMenu: ChatContextMenu;\r\n  public search: ChatSearch;\r\n\r\n  public wasAlreadyUsed: boolean;\r\n  // public initPeerId = 0;\r\n  public peerId: PeerId;\r\n  public threadId: number;\r\n  public setPeerPromise: Promise<void>;\r\n  public peerChanged: boolean;\r\n\r\n  public log: ReturnType<typeof logger>;\r\n\r\n  public type: ChatType;\r\n  public messagesStorageKey: MessagesStorageKey;\r\n\r\n  public noForwards: boolean;\r\n\r\n  public inited: boolean;\r\n\r\n  public isRestricted: boolean;\r\n  public autoDownload: ChatAutoDownloadSettings;\r\n\r\n  public gradientRenderer: ChatBackgroundGradientRenderer;\r\n  public patternRenderer: ChatBackgroundPatternRenderer;\r\n  public gradientCanvas: HTMLCanvasElement;\r\n  public patternCanvas: HTMLCanvasElement;\r\n  public backgroundTempId: number;\r\n  public setBackgroundPromise: Promise<void>;\r\n  public sharedMediaTab: AppSharedMediaTab;\r\n  public sharedMediaTabs: AppSharedMediaTab[];\r\n  // public renderDarkPattern: () => Promise<void>;\r\n\r\n  public isAnyGroup: boolean;\r\n  public isMegagroup: boolean;\r\n  \r\n  constructor(\r\n    public appImManager: AppImManager,\r\n    public managers: AppManagers\r\n  ) {\r\n    super();\r\n\r\n    this.type = 'chat';\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('chat', 'tabs-tab');\r\n\r\n    this.backgroundEl = document.createElement('div');\r\n    this.backgroundEl.classList.add('chat-background');\r\n\r\n    // * constructor end\r\n\r\n    this.log = logger('CHAT', LogTypes.Log | LogTypes.Warn | LogTypes.Debug | LogTypes.Error);\r\n    //this.log.error('Chat construction');\r\n\r\n    this.peerId = NULL_PEER_ID;\r\n\r\n    this.container.append(this.backgroundEl);\r\n    this.appImManager.chatsContainer.append(this.container);\r\n\r\n    this.backgroundTempId = 0;\r\n    this.sharedMediaTabs = [];\r\n  }\r\n\r\n  public setBackground(url: string, skipAnimation?: boolean): Promise<void> {\r\n    const theme = themeController.getTheme();\r\n\r\n    let item: HTMLElement;\r\n    const isColorBackground = !!theme.background.color && !theme.background.slug && !theme.background.intensity;\r\n    if(\r\n      isColorBackground && \r\n      document.documentElement.style.cursor === 'grabbing' && \r\n      this.gradientRenderer && \r\n      !this.patternRenderer\r\n    ) {\r\n      this.gradientCanvas.dataset.colors = theme.background.color;\r\n      this.gradientRenderer.init(this.gradientCanvas);\r\n      return Promise.resolve();\r\n    }\r\n\r\n    const tempId = ++this.backgroundTempId;\r\n\r\n    const previousGradientRenderer = this.gradientRenderer;\r\n    const previousPatternRenderer = this.patternRenderer;\r\n    const previousGradientCanvas = this.gradientCanvas;\r\n    const previousPatternCanvas = this.patternCanvas;\r\n\r\n    this.gradientRenderer = \r\n      this.patternRenderer = \r\n      this.gradientCanvas = \r\n      this.patternCanvas = \r\n      // this.renderDarkPattern = \r\n      undefined;\r\n\r\n    const intensity = theme.background.intensity && theme.background.intensity / 100;\r\n    const isDarkPattern = !!intensity && intensity < 0;\r\n    \r\n    let patternRenderer: ChatBackgroundPatternRenderer;\r\n    let patternCanvas = item?.firstElementChild as HTMLCanvasElement;\r\n    let gradientCanvas: HTMLCanvasElement;\r\n    if(!item) {\r\n      item = document.createElement('div');\r\n      item.classList.add('chat-background-item');\r\n\r\n      if(url) {\r\n        if(intensity) {\r\n          item.classList.add('is-pattern');\r\n\r\n          const rect = this.appImManager.chatsContainer.getBoundingClientRect();\r\n          patternRenderer = this.patternRenderer = ChatBackgroundPatternRenderer.getInstance({\r\n            url,\r\n            width: rect.width,\r\n            height: rect.height,\r\n            mask: isDarkPattern\r\n          });\r\n\r\n          patternCanvas = this.patternCanvas = patternRenderer.createCanvas();\r\n          patternCanvas.classList.add('chat-background-item-canvas', 'chat-background-item-pattern-canvas');\r\n\r\n          if(isDarkPattern) {\r\n            item.classList.add('is-dark');\r\n          }\r\n\r\n          // if(isDarkPattern) {\r\n          //   this.renderDarkPattern = () => {\r\n          //     return patternRenderer.exportCanvasPatternToImage(patternCanvas).then((url) => {\r\n          //       if(this.backgroundTempId !== tempId) {\r\n          //         return;\r\n          //       }\r\n                \r\n          //       gradientCanvas.style.webkitMaskImage = `url(${url})`;\r\n          //     });\r\n          //   };\r\n          // }\r\n        } else if(theme.background.slug) {\r\n          item.classList.add('is-image');\r\n        }\r\n      } else if(theme.background.color) {\r\n        item.classList.add('is-color');\r\n      }\r\n    }\r\n\r\n    let gradientRenderer: ChatBackgroundGradientRenderer;\r\n    const color = theme.background.color;\r\n    if(color) {\r\n      // if(color.includes(',')) {\r\n      const {canvas, gradientRenderer: _gradientRenderer} = ChatBackgroundGradientRenderer.create(color);\r\n      gradientRenderer = this.gradientRenderer = _gradientRenderer;\r\n      gradientCanvas = this.gradientCanvas = canvas;\r\n      gradientCanvas.classList.add('chat-background-item-canvas', 'chat-background-item-color-canvas');\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        gradientRenderer.scrollAnimate(true);\r\n      }\r\n      // } else {\r\n      //   item.style.backgroundColor = color;\r\n      //   item.style.backgroundImage = 'none';\r\n      // }\r\n    }\r\n\r\n    if(patternRenderer) {\r\n      const setOpacityTo = isDarkPattern ? gradientCanvas : patternCanvas;\r\n      setOpacityTo.style.setProperty('--opacity-max', '' + Math.abs(intensity));\r\n    }\r\n\r\n    const promise = new Promise<void>((resolve) => {\r\n      const cb = () => {\r\n        if(this.backgroundTempId !== tempId) {\r\n          if(patternRenderer) {\r\n            patternRenderer.cleanup(patternCanvas);\r\n          }\r\n\r\n          if(gradientRenderer) {\r\n            gradientRenderer.cleanup();\r\n          }\r\n\r\n          return;\r\n        }\r\n\r\n        const prev = this.backgroundEl.lastElementChild as HTMLElement;\r\n\r\n        if(prev === item) {\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        const append = [\r\n          gradientCanvas, \r\n          // isDarkPattern && this.renderDarkPattern ? undefined : patternCanvas\r\n          patternCanvas\r\n        ].filter(Boolean);\r\n        if(append.length) {\r\n          item.append(...append);\r\n        }\r\n\r\n        this.backgroundEl.append(item);\r\n\r\n        SetTransition(item, 'is-visible', true, !skipAnimation ? 200 : 0, prev ? () => {\r\n          if(previousPatternRenderer) {\r\n            previousPatternRenderer.cleanup(previousPatternCanvas);\r\n          }\r\n\r\n          if(previousGradientRenderer) {\r\n            previousGradientRenderer.cleanup();\r\n          }\r\n\r\n          prev.remove();\r\n        } : null, 2);\r\n\r\n        resolve();\r\n      };\r\n\r\n      if(patternRenderer) {\r\n        const renderPatternPromise = patternRenderer.renderToCanvas(patternCanvas);\r\n        renderPatternPromise.then(() => {\r\n          if(this.backgroundTempId !== tempId) {\r\n            return;\r\n          }\r\n\r\n          let promise: Promise<any>;\r\n          // if(isDarkPattern && this.renderDarkPattern) {\r\n          //   promise = this.renderDarkPattern();\r\n          // } else {\r\n            promise = Promise.resolve();\r\n          // }\r\n          \r\n          promise.then(cb);\r\n        });\r\n      } else if(url) {\r\n        renderImageFromUrl(item, url, cb);\r\n      } else {\r\n        cb();\r\n      }\r\n    });\r\n\r\n    return this.setBackgroundPromise = Promise.race([\r\n      pause(500),\r\n      promise\r\n    ]);\r\n  }\r\n\r\n  public setType(type: ChatType) {\r\n    this.type = type;\r\n  }\r\n\r\n  public init(/* peerId: PeerId */) {\r\n    // this.initPeerId = peerId;\r\n\r\n    this.topbar = new ChatTopbar(this, appSidebarRight, this.managers);\r\n    this.bubbles = new ChatBubbles(this, this.managers);\r\n    this.input = new ChatInput(this, this.appImManager, this.managers);\r\n    this.contextMenu = new ChatContextMenu(this, this.managers);\r\n    this.selection = new ChatSelection(this, this.bubbles, this.input, this.managers);\r\n\r\n    if(this.type === 'chat') {\r\n      this.topbar.constructUtils();\r\n      this.topbar.constructPeerHelpers();\r\n    } else if(this.type === 'pinned') {\r\n      this.topbar.constructPinnedHelpers();\r\n    } else if(this.type === 'discussion') {\r\n      this.topbar.constructUtils();\r\n      this.topbar.constructDiscussionHelpers();\r\n    }\r\n\r\n    this.topbar.construct();\r\n    this.input.construct();\r\n\r\n    if(this.type === 'chat') { // * гений в деле, разный порядок из-за разной последовательности действий\r\n      this.bubbles.constructPeerHelpers();\r\n      this.input.constructPeerHelpers();\r\n    } else if(this.type === 'pinned') {\r\n      this.bubbles.constructPinnedHelpers();\r\n      this.input.constructPinnedHelpers();\r\n    } else if(this.type === 'scheduled') {\r\n      this.bubbles.constructScheduledHelpers();\r\n      this.input.constructPeerHelpers();\r\n    } else if(this.type === 'discussion') {\r\n      this.bubbles.constructPeerHelpers();\r\n      this.input.constructPeerHelpers();\r\n    }\r\n\r\n    if(this.type !== 'scheduled' && !IS_TOUCH_SUPPORTED) {\r\n      this.bubbles.setReactionsHoverListeners();\r\n    }\r\n\r\n    this.bubbles.attachContainerListeners();\r\n\r\n    this.container.classList.add('type-' + this.type);\r\n    this.container.append(this.topbar.container, this.bubbles.container, this.input.chatInput);\r\n\r\n    this.bubbles.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n      if(this.peerId === migrateFrom) {\r\n        this.setPeer(migrateTo);\r\n      }\r\n    });\r\n\r\n    this.bubbles.listenerSetter.add(rootScope)('dialog_drop', (e) => {\r\n      if(e.peerId === this.peerId) {\r\n        this.appImManager.setPeer();\r\n      }\r\n    });\r\n  }\r\n\r\n  public beforeDestroy() {\r\n    this.bubbles.cleanup();\r\n  }\r\n\r\n  private cleanupBackground() {\r\n    ++this.backgroundTempId;\r\n    if(this.patternRenderer) {\r\n      this.patternRenderer.cleanup(this.patternCanvas);\r\n      this.patternRenderer = undefined;\r\n    }\r\n\r\n    if(this.gradientRenderer) {\r\n      this.gradientRenderer.cleanup();\r\n      this.gradientRenderer = undefined;\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    //const perf = performance.now();\r\n\r\n    this.topbar.destroy();\r\n    this.bubbles.destroy();\r\n    this.input.destroy();\r\n    this.contextMenu && this.contextMenu.destroy();\r\n    this.selection && this.selection.attachListeners(undefined, undefined);\r\n\r\n    this.cleanupBackground();\r\n\r\n    delete this.topbar;\r\n    delete this.bubbles;\r\n    delete this.input;\r\n    delete this.selection;\r\n    delete this.contextMenu;\r\n\r\n    this.container.remove();\r\n\r\n    //this.log.error('Chat destroy time:', performance.now() - perf);\r\n  }\r\n\r\n  public cleanup(helperToo = true) {\r\n    this.input.cleanup(helperToo);\r\n    this.topbar.cleanup();\r\n    this.selection.cleanup();\r\n  }\r\n  \r\n  public async onChangePeer(m: ReturnType<typeof middlewarePromise>) {\r\n    const {peerId} = this;\r\n\r\n    const searchTab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n    if(searchTab) {\r\n      searchTab.close();\r\n    }\r\n\r\n    const [noForwards, isRestricted, isAnyGroup, _, isMegagroup] = await m(Promise.all([\r\n      this.managers.appPeersManager.noForwards(peerId),\r\n      this.managers.appPeersManager.isRestricted(peerId),\r\n      this._isAnyGroup(peerId),\r\n      this.setAutoDownloadMedia(),\r\n      this.managers.appPeersManager.isMegagroup(peerId)\r\n    ]));\r\n\r\n    this.noForwards = noForwards;\r\n    this.isRestricted = isRestricted;\r\n    this.isAnyGroup = isAnyGroup;\r\n    this.isMegagroup = isMegagroup;\r\n\r\n    this.container.classList.toggle('no-forwards', this.noForwards);\r\n\r\n    this.sharedMediaTab = appSidebarRight.createSharedMediaTab();\r\n    this.sharedMediaTabs.push(this.sharedMediaTab);\r\n\r\n    this.sharedMediaTab.setPeer(peerId, this.threadId);\r\n    this.input.clearHelper(); // костыль\r\n    this.selection.cleanup(); // TODO: REFACTOR !!!!!!\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, lastMsgId?: number, startParam?: string) {\r\n    if(!peerId) {\r\n      this.inited = undefined;\r\n    } else if(!this.inited) {\r\n      if(this.init) {\r\n        this.init(/* peerId */);\r\n        this.init = null;\r\n      }\r\n\r\n      this.inited = true;\r\n    }\r\n\r\n    const samePeer = this.peerId === peerId;\r\n    if(!samePeer) {\r\n      this.appImManager.dispatchEvent('peer_changing', this);\r\n      this.peerId = peerId || NULL_PEER_ID;\r\n      this.messagesStorageKey = `${this.peerId}_${this.type === 'scheduled' ? 'scheduled' : 'history'}`;\r\n    } else if(this.setPeerPromise) {\r\n      return;\r\n    }\r\n\r\n    if(!peerId) {\r\n      appSidebarRight.toggleSidebar(false);\r\n      this.cleanup(true);\r\n      this.bubbles.setPeer(false, peerId);\r\n      this.appImManager.dispatchEvent('peer_changed', peerId);\r\n      return;\r\n    }\r\n\r\n    this.peerChanged = samePeer;\r\n\r\n    const bubblesSetPeerPromise = this.bubbles.setPeer(samePeer, peerId, lastMsgId, startParam);\r\n    const setPeerPromise = this.setPeerPromise = bubblesSetPeerPromise.then((result) => {\r\n      return result.promise;\r\n    }).catch(noop).finally(() => {\r\n      if(this.setPeerPromise === setPeerPromise) {\r\n        this.setPeerPromise = null;\r\n      }\r\n    });\r\n\r\n    return bubblesSetPeerPromise;\r\n  }\r\n\r\n  public destroySharedMediaTab(tab = this.sharedMediaTab) {\r\n    indexOfAndSplice(this.sharedMediaTabs, tab);\r\n    tab.destroy();\r\n  }\r\n\r\n  public async setAutoDownloadMedia() {\r\n    this.autoDownload = await getAutoDownloadSettingsByPeerId(this.peerId);\r\n  }\r\n\r\n  public setMessageId(messageId?: number) {\r\n    return this.setPeer(this.peerId, messageId);\r\n  }\r\n\r\n  public async finishPeerChange(isTarget: boolean, isJump: boolean, lastMsgId: number, startParam?: string) {\r\n    if(this.peerChanged) return;\r\n\r\n    const peerId = this.peerId;\r\n    this.peerChanged = true;\r\n    this.wasAlreadyUsed = true;\r\n\r\n    const middleware = this.bubbles.getMiddleware();\r\n\r\n    this.cleanup(false);\r\n\r\n    const sharedMediaTab = this.sharedMediaTab;\r\n    sharedMediaTab.loadSidebarMedia(true);\r\n\r\n    const callbacksPromise = Promise.all([\r\n      this.topbar.finishPeerChange(isTarget),\r\n      this.bubbles.finishPeerChange(),\r\n      this.input.finishPeerChange(startParam),\r\n    ]);\r\n\r\n    const [callbacks] = await Promise.all([\r\n      callbacksPromise,\r\n      sharedMediaTab.fillProfileElements()\r\n    ]);\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    callbacks.forEach((callback) => {\r\n      callback();\r\n    });\r\n\r\n    appSidebarRight.replaceSharedMediaTab(sharedMediaTab);\r\n\r\n    this.sharedMediaTabs.filter((tab) => tab !== sharedMediaTab).forEach((tab) => this.destroySharedMediaTab(tab));\r\n\r\n    this.log.setPrefix('CHAT-' + peerId + '-' + this.type);\r\n\r\n    this.appImManager.dispatchEvent('peer_changed', peerId);\r\n  }\r\n\r\n  public getMessage(mid: number) {\r\n    return this.managers.appMessagesManager.getMessageFromStorage(this.messagesStorageKey, mid);\r\n  }\r\n\r\n  public async getMidsByMid(mid: number) {\r\n    return this.managers.appMessagesManager.getMidsByMessage(await this.getMessage(mid));\r\n  }\r\n\r\n  public getHistoryStorage(ignoreThreadId?: boolean) {\r\n    return this.managers.appMessagesManager.getHistoryStorageTransferable(this.peerId, ignoreThreadId ? undefined : this.threadId)\r\n    .then((historyStorageTransferable) => {\r\n      return {\r\n        ...historyStorageTransferable,\r\n        history: SlicedArray.fromJSON<number>(historyStorageTransferable.historySerialized)\r\n      }\r\n    });\r\n  }\r\n\r\n  public getHistoryMaxId() {\r\n    return this.getHistoryStorage().then((historyStorage) => historyStorage.maxId);\r\n  }\r\n\r\n  public async _isAnyGroup(peerId: PeerId) {\r\n    return peerId === rootScope.myId || peerId === REPLIES_PEER_ID || (await this.managers.appPeersManager.isAnyGroup(peerId));\r\n  }\r\n\r\n  public initSearch(query?: string) {\r\n    if(!this.peerId) return;\r\n\r\n    if(mediaSizes.isMobile) {\r\n      if(!this.search) {\r\n        this.search = new ChatSearch(this.topbar, this, query);\r\n      } else {\r\n        this.search.setQuery(query);\r\n      }\r\n    } else {\r\n      let tab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n      if(!tab) {\r\n        tab = appSidebarRight.createTab(AppPrivateSearchTab);\r\n      }\r\n\r\n      tab.open(this.peerId, this.threadId, this.bubbles.onDatePick, query);\r\n    }\r\n  }\r\n\r\n  public canSend(action?: ChatRights) {\r\n    return this.managers.appMessagesManager.canSendToPeer(this.peerId, this.threadId, action);\r\n  }\r\n\r\n  public isStartButtonNeeded() {\r\n    return Promise.all([\r\n      this.managers.appPeersManager.isBot(this.peerId),\r\n      this.managers.appMessagesManager.getDialogOnly(this.peerId),\r\n      this.getHistoryStorage(true)\r\n    ]).then(([isBot, dialog, historyStorage]) => {\r\n      return isBot && !dialog && !historyStorage.history.length;\r\n    });\r\n  }\r\n\r\n  public getMessageSendingParams() {\r\n    return {\r\n      threadId: this.threadId,\r\n      replyToMsgId: this.input.replyToMsgId,\r\n      scheduleDate: this.input.scheduleDate,\r\n      sendSilent: this.input.sendSilent,\r\n      sendAsPeerId: this.input.sendAsPeerId\r\n    };\r\n  }\r\n\r\n  public isOurMessage(message: Message.message | Message.messageService) {\r\n    return message.fromId === rootScope.myId || (message.pFlags.out && this.isMegagroup);\r\n  }\r\n\r\n  public isOutMessage(message: Message.message | Message.messageService) {\r\n    const fwdFrom = (message as Message.message).fwd_from;\r\n    const isOut = this.isOurMessage(message) && (!fwdFrom || this.peerId !== rootScope.myId);\r\n    return isOut;\r\n  }\r\n\r\n  public isAvatarNeeded(message: Message.message | Message.messageService) {\r\n    return this.isAnyGroup && !this.isOutMessage(message);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { State } from \"../config/state\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport type ChatAutoDownloadSettings = {\r\n  photo: number,\r\n  video: number,\r\n  file: number\r\n};\r\n\r\nexport default async function getAutoDownloadSettingsByPeerId(peerId: PeerId): Promise<ChatAutoDownloadSettings> {\r\n  let type: keyof State['settings']['autoDownload'];\r\n\r\n  let photoSizeMax = 0, videoSizeMax = 0, fileSizeMax = 0;\r\n  const settings = rootScope.settings;\r\n  const appPeersManager = rootScope.managers.appPeersManager;\r\n  if(!settings.autoDownloadNew.pFlags.disabled && peerId) {\r\n    if(peerId.isUser()) {\r\n      if(await appPeersManager.isContact(peerId)) {\r\n        type = 'contacts';\r\n      } else {\r\n        type = 'private';\r\n      }\r\n    } else if(await appPeersManager.isBroadcast(peerId)) {\r\n      type = 'channels';\r\n    } else {\r\n      type = 'groups';\r\n    }\r\n    \r\n    if(settings.autoDownload.photo[type]) photoSizeMax = settings.autoDownloadNew.photo_size_max;\r\n    if(settings.autoDownload.video[type]) videoSizeMax = settings.autoDownloadNew.video_size_max;\r\n    if(settings.autoDownload.file[type]) fileSizeMax = settings.autoDownloadNew.file_size_max;\r\n  }\r\n\r\n  return {\r\n    photo: photoSizeMax,\r\n    video: videoSizeMax,\r\n    file: fileSizeMax\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppImManager } from \"../../lib/appManagers/appImManager\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_APPLE, IS_MOBILE } from \"../../environment/userAgent\";\r\nimport appNavigationController from \"../appNavigationController\";\r\nimport { _i18n } from \"../../lib/langPack\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport getSelectedNodes from \"../../helpers/dom/getSelectedNodes\";\r\nimport isSelectionEmpty from \"../../helpers/dom/isSelectionEmpty\";\r\nimport { MarkdownType, markdownTags } from \"../../helpers/dom/getRichElementValue\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport clamp from \"../../helpers/number/clamp\";\r\nimport matchUrl from \"../../lib/richTextProcessor/matchUrl\";\r\nimport matchUrlProtocol from \"../../lib/richTextProcessor/matchUrlProtocol\";\r\n//import { logger } from \"../../lib/logger\";\r\n\r\nexport default class MarkupTooltip {\r\n  public container: HTMLElement;\r\n  private wrapper: HTMLElement;\r\n  private buttons: {[type in MarkdownType]: HTMLElement} = {} as any;\r\n  private linkBackButton: HTMLElement;\r\n  private linkApplyButton: HTMLButtonElement;\r\n  private hideTimeout: number;\r\n  private addedListener = false;\r\n  private waitingForMouseUp = false;\r\n  private linkInput: HTMLInputElement;\r\n  private savedRange: Range;\r\n  private mouseUpCounter: number = 0;\r\n  //private log: ReturnType<typeof logger>;\r\n\r\n  constructor(private appImManager: AppImManager) {\r\n    //this.log = logger('MARKUP');\r\n  }\r\n\r\n  private init() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('markup-tooltip', 'z-depth-1', 'hide');\r\n\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add('markup-tooltip-wrapper');\r\n    \r\n    const tools1 = document.createElement('div');\r\n    const tools2 = document.createElement('div');\r\n    tools1.classList.add('markup-tooltip-tools');\r\n    tools2.classList.add('markup-tooltip-tools');\r\n\r\n    const arr = ['bold', 'italic', 'underline', 'strikethrough', 'monospace', 'spoiler', 'link'] as (keyof MarkupTooltip['buttons'])[];\r\n    arr.forEach((c) => {\r\n      const button = ButtonIcon(c, {noRipple: true});\r\n      tools1.append(this.buttons[c] = button);\r\n\r\n      if(c !== 'link') {\r\n        button.addEventListener('mousedown', (e) => {\r\n          cancelEvent(e); \r\n          this.appImManager.chat.input.applyMarkdown(c);\r\n          this.cancelClosening();\r\n          \r\n          /* this.mouseUpCounter = 0;\r\n          this.setMouseUpEvent(); */\r\n          //this.hide();\r\n        });\r\n      } else {\r\n        attachClickEvent(button, (e) => {\r\n          cancelEvent(e);\r\n          this.showLinkEditor();\r\n          this.cancelClosening();\r\n        });\r\n      }\r\n    });\r\n\r\n    this.linkBackButton = ButtonIcon('left', {noRipple: true});\r\n    this.linkInput = document.createElement('input');\r\n    _i18n(this.linkInput, 'MarkupTooltip.LinkPlaceholder', undefined, 'placeholder');\r\n    this.linkInput.classList.add('input-clear');\r\n    this.linkInput.addEventListener('keydown', (e) => {\r\n      const valid = !this.linkInput.value.length || !!matchUrl(this.linkInput.value);///^(http)|(https):\\/\\//i.test(this.linkInput.value);\r\n\r\n      if(e.key === 'Enter') {\r\n        if(!valid) {\r\n          if(this.linkInput.classList.contains('error')) {\r\n            this.linkInput.classList.remove('error');\r\n            void this.linkInput.offsetLeft; // reflow\r\n          }\r\n\r\n          this.linkInput.classList.add('error');\r\n        } else {\r\n          this.applyLink(e);\r\n        }\r\n      }\r\n    });\r\n\r\n    this.linkInput.addEventListener('input', (e) => {\r\n      const valid = this.isLinkValid();\r\n\r\n      this.linkInput.classList.toggle('is-valid', valid);\r\n      this.linkInput.classList.remove('error');\r\n    });\r\n\r\n    this.linkBackButton.addEventListener('mousedown', (e) => {\r\n      //this.log('linkBackButton click');\r\n      cancelEvent(e);\r\n      this.container.classList.remove('is-link');\r\n      //input.value = '';\r\n      this.resetSelection();\r\n      this.setTooltipPosition();\r\n      this.cancelClosening();\r\n    });\r\n\r\n    this.linkApplyButton = ButtonIcon('check markup-tooltip-link-apply', {noRipple: true});\r\n    this.linkApplyButton.addEventListener('mousedown', (e) => {\r\n      //this.log('linkApplyButton click');\r\n      this.applyLink(e);\r\n    });\r\n\r\n    const applyDiv = document.createElement('div');\r\n    applyDiv.classList.add('markup-tooltip-link-apply-container');\r\n    \r\n    const delimiter1 = document.createElement('span');\r\n    const delimiter2 = document.createElement('span');\r\n    const delimiter3 = document.createElement('span');\r\n    delimiter1.classList.add('markup-tooltip-delimiter');\r\n    delimiter2.classList.add('markup-tooltip-delimiter');\r\n    delimiter3.classList.add('markup-tooltip-delimiter');\r\n    tools1.insertBefore(delimiter1, this.buttons.link);\r\n    applyDiv.append(delimiter3, this.linkApplyButton);\r\n    tools2.append(this.linkBackButton, delimiter2, this.linkInput, applyDiv);\r\n    //tools1.insertBefore(delimiter2, this.buttons.link.nextSibling);\r\n\r\n    this.wrapper.append(tools1, tools2);\r\n    this.container.append(this.wrapper);\r\n    document.body.append(this.container);\r\n    \r\n    window.addEventListener('resize', () => {\r\n      this.hide();\r\n    });\r\n  }\r\n\r\n  public showLinkEditor() {\r\n    if(!this.container || !this.container.classList.contains('is-visible')) { // * if not inited yet (Ctrl+A + Ctrl+K)\r\n      this.show();\r\n    }\r\n\r\n    const button = this.buttons.link;\r\n    this.container.classList.add('is-link');\r\n\r\n    const selection = document.getSelection();\r\n    this.savedRange = selection.getRangeAt(0);\r\n    \r\n    if(button.classList.contains('active')) {\r\n      const startContainer = this.savedRange.startContainer;\r\n      const anchor = startContainer.parentElement as HTMLAnchorElement;\r\n      this.linkInput.value = anchor.href;\r\n    } else {\r\n      this.linkInput.value = '';\r\n    }\r\n\r\n    this.setTooltipPosition(true);\r\n\r\n    setTimeout(() => {\r\n      this.linkInput.focus(); // !!! instant focus will break animation\r\n    }, 200);\r\n    this.linkInput.classList.toggle('is-valid', this.isLinkValid());\r\n  }\r\n\r\n  private applyLink(e: Event) {\r\n    cancelEvent(e);\r\n    this.resetSelection();\r\n    let url = this.linkInput.value;\r\n    if(url && !matchUrlProtocol(url)) {\r\n      url = 'https://' + url;\r\n    }\r\n    this.appImManager.chat.input.applyMarkdown('link', url);\r\n    setTimeout(() => {\r\n      this.hide();\r\n    }, 0);\r\n  }\r\n\r\n  private isLinkValid() {\r\n    return !this.linkInput.value.length || !!matchUrl(this.linkInput.value);\r\n  }\r\n\r\n  private resetSelection(range: Range = this.savedRange) {\r\n    const selection = window.getSelection();\r\n    selection.removeAllRanges();\r\n    selection.addRange(range);\r\n    this.appImManager.chat.input.messageInput.focus();\r\n  }\r\n\r\n  public hide() {\r\n    //return;\r\n\r\n    if(this.init) return;\r\n\r\n    this.container.classList.remove('is-visible');\r\n    //document.removeEventListener('mouseup', this.onMouseUp);\r\n    document.removeEventListener('mouseup', this.onMouseUpSingle);\r\n    this.waitingForMouseUp = false;\r\n\r\n    appNavigationController.removeByType('markup');\r\n\r\n    if(this.hideTimeout) clearTimeout(this.hideTimeout);\r\n    this.hideTimeout = window.setTimeout(() => {\r\n      this.hideTimeout = undefined;\r\n      this.container.classList.add('hide');\r\n      this.container.classList.remove('is-link');\r\n    }, 200);\r\n  }\r\n\r\n  public getActiveMarkupButton() {\r\n    const nodes = getSelectedNodes();\r\n    const parents = [...new Set(nodes.map((node) => node.parentNode))];\r\n    //if(parents.length > 1 && parents) return [];\r\n\r\n    const currentMarkups: Set<HTMLElement> = new Set();\r\n    (parents as HTMLElement[]).forEach((node) => {\r\n      for(const type in markdownTags) {\r\n        const tag = markdownTags[type as MarkdownType];\r\n        const closest = node.closest(tag.match + ', [contenteditable]');\r\n        if(closest !== this.appImManager.chat.input.messageInput) {\r\n          currentMarkups.add(this.buttons[type as MarkdownType]);\r\n        }\r\n      }\r\n    });\r\n    \r\n\r\n    return [...currentMarkups];\r\n  }\r\n\r\n  public setActiveMarkupButton() {\r\n    const activeButtons = this.getActiveMarkupButton();\r\n\r\n    for(const i in this.buttons) {\r\n      // @ts-ignore\r\n      const button = this.buttons[i];\r\n      button.classList.toggle('active', activeButtons.includes(button));\r\n    }\r\n  }\r\n\r\n  private setTooltipPosition(isLinkToggle = false) {\r\n    const selection = document.getSelection();\r\n    const range = selection.getRangeAt(0);\r\n\r\n    const bodyRect = document.body.getBoundingClientRect();\r\n    const selectionRect = range.getBoundingClientRect();\r\n    const inputRect = this.appImManager.chat.input.rowsWrapper.getBoundingClientRect();\r\n\r\n    this.container.style.maxWidth = inputRect.width + 'px';\r\n\r\n    const visibleRect = getVisibleRect(undefined, this.appImManager.chat.input.messageInput, false, selectionRect);\r\n\r\n    const selectionTop = visibleRect.rect.top/* selectionRect.top */ + (bodyRect.top * -1);\r\n    \r\n    const currentTools = this.container.classList.contains('is-link') ? this.wrapper.lastElementChild : this.wrapper.firstElementChild;\r\n\r\n    const sizesRect = currentTools.getBoundingClientRect();\r\n    const top = selectionTop - sizesRect.height - 8;\r\n    \r\n    const minX = inputRect.left;\r\n    const maxX = (inputRect.left + inputRect.width) - Math.min(inputRect.width, sizesRect.width);\r\n    let left: number;\r\n    if(isLinkToggle) {\r\n      const containerRect = this.container.getBoundingClientRect();\r\n      left = clamp(containerRect.left, minX, maxX);\r\n    } else {\r\n      const x = selectionRect.left + (selectionRect.width - sizesRect.width) / 2;\r\n      left = clamp(x, minX, maxX);\r\n    }\r\n\r\n    /* const isClamped = x !== minX && x !== maxX && (left === minX || left === maxX || this.container.getBoundingClientRect().left >= maxX);\r\n\r\n    if(isLinkToggle && this.container.classList.contains('is-link') && !isClamped) return; */\r\n    \r\n    this.container.style.transform = `translate3d(${left}px, ${top}px, 0)`;\r\n  }\r\n\r\n  public show() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    if(isSelectionEmpty()) {\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    if(this.hideTimeout !== undefined) {\r\n      clearTimeout(this.hideTimeout);\r\n    }\r\n\r\n    if(this.container.classList.contains('is-visible')) {\r\n      return;\r\n    }\r\n\r\n    this.setActiveMarkupButton();\r\n    \r\n    this.container.classList.remove('is-link');\r\n    const isFirstShow = this.container.classList.contains('hide');\r\n    if(isFirstShow) {\r\n      this.container.classList.remove('hide');\r\n      this.container.classList.add('no-transition');\r\n    }\r\n    \r\n    this.setTooltipPosition();\r\n    \r\n    if(isFirstShow) {\r\n      void this.container.offsetLeft; // reflow\r\n      this.container.classList.remove('no-transition');\r\n    }\r\n    \r\n    this.container.classList.add('is-visible');\r\n\r\n    if(!IS_MOBILE) {\r\n      appNavigationController.pushItem({\r\n        type: 'markup',\r\n        onPop: () => {\r\n          this.hide();\r\n        }\r\n      });\r\n    }\r\n\r\n    //this.log('selection', selectionRect, activeButton);\r\n  }\r\n\r\n  /* private onMouseUp = (e: Event) => {\r\n    this.log('onMouseUp');\r\n    if(findUpClassName(e.target, 'markup-tooltip')) return;\r\n\r\n    this.hide();\r\n    //document.removeEventListener('mouseup', this.onMouseUp);\r\n  }; */\r\n\r\n  private onMouseUpSingle = (e?: Event) => {\r\n    //this.log('onMouseUpSingle');\r\n    this.waitingForMouseUp = false;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      e && cancelEvent(e);\r\n      if(this.mouseUpCounter++ === 0) {\r\n        this.resetSelection(this.savedRange);\r\n      } else {\r\n        this.hide();\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.show();\r\n\r\n    /* !isTouchSupported && document.addEventListener('mouseup', this.onMouseUp); */\r\n  };\r\n\r\n  public setMouseUpEvent() {\r\n    if(this.waitingForMouseUp) return;\r\n    this.waitingForMouseUp = true;\r\n\r\n    //this.log('setMouseUpEvent');\r\n\r\n    document.addEventListener('mouseup', this.onMouseUpSingle, {once: true});\r\n  }\r\n\r\n  public cancelClosening() {\r\n    if(IS_TOUCH_SUPPORTED && !IS_APPLE) {\r\n      document.removeEventListener('mouseup', this.onMouseUpSingle);\r\n      document.addEventListener('mouseup', (e) => {\r\n        cancelEvent(e);\r\n        this.mouseUpCounter = 1;\r\n        this.waitingForMouseUp = false;\r\n        this.setMouseUpEvent();\r\n      }, {once: true});\r\n    }\r\n  }\r\n\r\n  public handleSelection() {\r\n    if(this.addedListener) return;\r\n    this.addedListener = true;\r\n    document.addEventListener('selectionchange', (e) => {\r\n      //this.log('selectionchange');\r\n\r\n      if(document.activeElement === this.linkInput) {\r\n        return;\r\n      }\r\n\r\n      const messageInput = this.appImManager.chat.input.messageInput;\r\n      if(document.activeElement !== messageInput) {\r\n        this.hide();\r\n        return;\r\n      }\r\n\r\n      const selection = document.getSelection();\r\n      if(isSelectionEmpty(selection)) {\r\n        this.hide();\r\n        return;\r\n      }\r\n\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        if(IS_APPLE) {\r\n          this.show();\r\n          this.setTooltipPosition(); // * because can skip this in .show();\r\n        } else {\r\n          if(this.mouseUpCounter === 2) {\r\n            this.mouseUpCounter = 0;\r\n            return;\r\n          }\r\n\r\n          this.savedRange = selection.getRangeAt(0);\r\n          this.setMouseUpEvent();\r\n          /* document.addEventListener('touchend', (e) => {\r\n            cancelEvent(e);\r\n            this.resetSelection(range);\r\n            this.show();\r\n          }, {once: true, passive: false}); */\r\n        }\r\n      } else if(this.container && this.container.classList.contains('is-visible')) {\r\n        this.setTooltipPosition();\r\n      } else if(messageInput.matches(':active')) {\r\n        this.setMouseUpEvent();\r\n      } else {\r\n        this.show();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getSelectedNodes() {\r\n  const nodes: Node[] = [];\r\n  const selection = window.getSelection();\r\n  for(let i = 0; i < selection.rangeCount; ++i) {\r\n    const range = selection.getRangeAt(i);\r\n    let {startContainer, endContainer} = range;\r\n    if(endContainer.nodeType !== 3) endContainer = endContainer.firstChild;\r\n    \r\n    while(startContainer && startContainer !== endContainer) {\r\n      nodes.push(startContainer.nodeType === 3 ? startContainer : startContainer.firstChild);\r\n      startContainer = startContainer.nextSibling;\r\n    }\r\n    \r\n    if(nodes[nodes.length - 1] !== endContainer) {\r\n      nodes.push(endContainer);\r\n    }\r\n  }\r\n\r\n  // * filter null's due to <br>\r\n  return nodes.filter((node) => !!node);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// generate a path's arc data parameter\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\n// http://www.w3.org/TR/SVG/paths.html#PathDataEllipticalArcCommands\r\nfunction arcParameter(rx: number, ry: number, xAxisRotation: number, largeArcFlag: number, sweepFlag: number, x: number, y: number) {\r\n  return [rx, ',', ry, ' ',\r\n          xAxisRotation, ' ',\r\n          largeArcFlag, ',',\r\n          sweepFlag, ' ',\r\n          x, ',', y ].join('');\r\n}\r\n\r\nexport default function generatePathData(x: number, y: number, width: number, height: number, tl: number, tr: number, br: number, bl: number) {\r\n  const data: string[] = [];\r\n\r\n  // start point in top-middle of the rectangle\r\n  data.push('M' + (x + width / 2) + ',' + y);\r\n\r\n  // next we go to the right\r\n  data.push('H' + (x + width - tr));\r\n\r\n  if(tr > 0) {\r\n    // now we draw the arc in the top-right corner\r\n    data.push('A' + arcParameter(tr, tr, 0, 0, 1, (x + width), (y + tr)));\r\n  }\r\n\r\n  // next we go down\r\n  data.push('V' + (y + height - br));\r\n\r\n  if(br > 0) {\r\n    // now we draw the arc in the lower-right corner\r\n    data.push('A' + arcParameter(br, br, 0, 0, 1, (x + width - br), (y + height)));\r\n  }\r\n\r\n  // now we go to the left\r\n  data.push('H' + (x + bl));\r\n\r\n  if(bl > 0) {\r\n    // now we draw the arc in the lower-left corner\r\n    data.push('A' + arcParameter(bl, bl, 0, 0, 1, (x + 0), (y + height - bl)));\r\n  }\r\n\r\n  // next we go up\r\n  data.push('V' + (y + tl));\r\n\r\n  if(tl > 0) {\r\n    // now we draw the arc in the top-left corner\r\n    data.push('A' + arcParameter(tl, tl, 0, 0, 1, (x + tl), (y + 0)));\r\n  }\r\n\r\n  // and we close the path\r\n  data.push('Z');\r\n\r\n  return data.join(' ');\r\n}\r\n\r\nMOUNT_CLASS_TO.generatePathData = generatePathData;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport generatePathData from \"../../helpers/generatePathData\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../../lib/langPack\";\r\n\r\nexport default class ChatDragAndDrop {\r\n  container: HTMLDivElement;\r\n  svg: SVGSVGElement;\r\n  outlineWrapper: HTMLDivElement;\r\n  path: SVGPathElement;\r\n\r\n  constructor(appendTo: HTMLElement, private options: {\r\n    icon?: string,\r\n    header: LangPackKey,\r\n    headerArgs?: FormatterArguments,\r\n    subtitle?: LangPackKey,\r\n    onDrop: (e: DragEvent) => void\r\n  }) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('drop', 'z-depth-1');\r\n\r\n    this.outlineWrapper = document.createElement('div');\r\n    this.outlineWrapper.classList.add('drop-outline-wrapper');\r\n\r\n    this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n    this.svg.classList.add('drop-outline');\r\n\r\n    this.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.path.classList.add('drop-outline-path');\r\n\r\n    let dropIcon: HTMLElement;\r\n    if(options.icon) {\r\n      dropIcon = document.createElement('div');\r\n      dropIcon.classList.add('drop-icon', 'tgico-' + options.icon);\r\n    }\r\n\r\n    const dropHeader = document.createElement('div');\r\n    dropHeader.classList.add('drop-header');\r\n    dropHeader.append(i18n(options.header, options.headerArgs));\r\n\r\n    let dropSubtitle: HTMLElement;\r\n    if(options.subtitle) {\r\n      dropSubtitle = document.createElement('div');\r\n      dropSubtitle.classList.add('drop-subtitle');\r\n      dropSubtitle.append(i18n(options.subtitle));\r\n    }\r\n\r\n    this.svg.append(this.path);\r\n    this.outlineWrapper.append(this.svg);\r\n\r\n    this.container.append(...[this.outlineWrapper, dropIcon, dropHeader, dropSubtitle].filter(Boolean));\r\n    appendTo.append(this.container);\r\n\r\n    this.container.addEventListener('dragover', this.onDragOver);\r\n    this.container.addEventListener('dragleave', this.onDragLeave);\r\n    this.container.addEventListener('drop', this.onDrop);\r\n  }\r\n\r\n  onDragOver = (e: DragEvent) => {\r\n    this.container.classList.add('is-dragover');\r\n    //SetTransition(this.container, 'is-dragover', true, 500);\r\n  };\r\n\r\n  onDragLeave = (e: DragEvent) => {\r\n    this.container.classList.remove('is-dragover');\r\n    //SetTransition(this.container, 'is-dragover', false, 500);\r\n  };\r\n\r\n  onDrop = (e: DragEvent) => {\r\n    this.options.onDrop(e);\r\n  };\r\n\r\n  destroy() {\r\n    delete this.options;\r\n    this.container.remove();\r\n    this.container.removeEventListener('dragover', this.onDragOver);\r\n    this.container.removeEventListener('dragleave', this.onDragLeave);\r\n    this.container.removeEventListener('drop', this.onDrop);\r\n  }\r\n\r\n  setPath() {\r\n    const rect = this.outlineWrapper.getBoundingClientRect();\r\n    this.svg.setAttributeNS(null, 'preserveAspectRatio', 'none');\r\n    this.svg.setAttributeNS(null, 'viewBox', `0 0 ${rect.width} ${rect.height}`);\r\n    this.svg.setAttributeNS(null, 'width', `${rect.width}`);\r\n    this.svg.setAttributeNS(null, 'height', `${rect.height}`);\r\n\r\n    const radius = 10;\r\n    //const strokeWidth = 2;\r\n    const sizeX = rect.width - radius;\r\n    const sizeY = rect.height - radius;\r\n    const pos = radius / 2;\r\n    const d = generatePathData(pos, pos, sizeX, sizeY, radius, radius, radius, radius);\r\n    this.path.setAttributeNS(null, 'd', d);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { doubleRaf } from \"../schedulers\";\r\n\r\nexport default function disableTransition(elements: HTMLElement[]) {\r\n  elements.forEach((el) => el.classList.add('no-transition'));\r\n\r\n  doubleRaf().then(() => {\r\n    elements.forEach((el) => el.classList.remove('no-transition'));\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nexport const MAX_SPEED = 8.2;\r\nexport const MIN_SPEED = 0.8;\r\n\r\n// import { MIN_SPEED, MAX_SPEED } from './BlobDrawable';\r\n\r\ntype Radius = number[];\r\n\r\nexport default class LineBlobDrawable {\r\n  public maxRadius: number;\r\n  public minRadius: number;\r\n  private N: number;\r\n  private radius: Radius;\r\n  private radiusNext: Radius;\r\n  private progress: number[];\r\n  private speed: number[];\r\n  \r\n  constructor(n: number) {\r\n    this.maxRadius = 10;\r\n    this.minRadius = 0;\r\n    \r\n    this.N = n;\r\n    this.radius = new Array(n + 1);\r\n    \r\n    this.radiusNext = new Array(n + 1);\r\n    this.progress = new Array(n + 1);\r\n    this.speed = new Array(n + 1);\r\n    \r\n    for(let i = 0; i <= n; i++) {\r\n      this.generateBlob(this.radius, i);\r\n      this.generateBlob(this.radiusNext, i);\r\n      this.progress[i] = 0;\r\n    }\r\n  }\r\n  \r\n  private generateBlob(radius: Radius, i: number) {\r\n    const {maxRadius, minRadius, speed} = this;\r\n    \r\n    const radDif = maxRadius - minRadius;\r\n    radius[i] = minRadius + Math.random() * radDif;\r\n    speed[i] = 0.017 + 0.003 * Math.random();\r\n  }\r\n  \r\n  private generateNextBlob() {\r\n    const {radius, radiusNext, progress, N} = this;\r\n    for(let i = 0; i < N; i++) {\r\n      this.generateBlob(radius, i);\r\n      this.generateBlob(radiusNext, i);\r\n      progress[i] = 0.0;\r\n    }\r\n  }\r\n  \r\n  public update(amplitude: number, speedScale: number) {\r\n    const {N, progress, speed, radius, radiusNext} = this;\r\n    for(let i = 0; i <= N; i++) {\r\n      progress[i] += (speed[i] * MIN_SPEED) + amplitude * speed[i] * MAX_SPEED * speedScale;\r\n      if(progress[i] >= 1.0) {\r\n        progress[i] = 0.0;\r\n        radius[i] = radiusNext[i];\r\n        this.generateBlob(radiusNext, i);\r\n      }\r\n    }\r\n  }\r\n  \r\n  public draw(left: number, top: number, right: number, bottom: number, canvas: HTMLCanvasElement, paint: (ctx: CanvasRenderingContext2D) => void, pinnedTop: number, progressToPinned: number) {\r\n    if(canvas.getContext) {\r\n      const ctx = canvas.getContext('2d');\r\n      // ctx.globalAlpha = 0.5;\r\n      // ctx.lineWidth = 1;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(right, bottom);\r\n      ctx.lineTo(left, bottom);\r\n      \r\n      const {radius, radiusNext, N} = this;\r\n      for(let i = 0; i <= N; i++) {\r\n        if(i === 0) {\r\n          const progress = this.progress[i];\r\n          const r1 = radius[i] * (1.0 - progress) + radiusNext[i] * progress;\r\n          const y = (top - r1) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          ctx.lineTo(left, y);\r\n        } else {\r\n          const progress = this.progress[i - 1];\r\n          const r1 = radius[i - 1] * (1.0 - progress) + radiusNext[i - 1] * progress;\r\n          const progressNext = this.progress[i];\r\n          const r2 = radius[i] * (1.0 - progressNext) + radiusNext[i] * progressNext;\r\n          const x1 = (right - left) / N * (i - 1);\r\n          const x2 = (right - left) / N * i;\r\n          const cx = x1 + (x2 - x1) / 2;\r\n          \r\n          const y1 = (top - r1) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          const y2 = (top - r2) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          ctx.bezierCurveTo(cx, y1, cx, y2, x2, y2);\r\n          if(i === N) {\r\n            ctx.lineTo(right, bottom);\r\n          }\r\n        }\r\n      }\r\n      \r\n      // ctx.scale(1.0, 1.0);\r\n      paint(ctx);\r\n      ctx.fill();\r\n      ctx.closePath();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport GROUP_CALL_STATE from '../lib/calls/groupCallState';\r\nimport LineBlobDrawable from './lineBlobDrawable';\r\n\r\nexport class WeavingState {\r\n  public shader: (ctx: CanvasRenderingContext2D, left: number, top: number, right: number, bottom: number) => void;\r\n  \r\n  constructor(public stateId: GROUP_CALL_STATE) {\r\n    this.createGradient(stateId);\r\n  }\r\n  \r\n  public createGradient(stateId: GROUP_CALL_STATE) {\r\n    this.shader = (ctx, left, top, right, bottom) => {\r\n      ctx.fillStyle = WeavingState.getGradientFromType(ctx, stateId, left, top, right, bottom);\r\n    };\r\n  }\r\n  \r\n  // Android colors\r\n  static getGradientFromType(ctx: CanvasRenderingContext2D, type: GROUP_CALL_STATE, x0: number, y0: number, x1: number, y1: number) {\r\n    const gradient = ctx.createLinearGradient(x0, y0, x1, y1);\r\n    if(type === GROUP_CALL_STATE.MUTED_BY_ADMIN) {\r\n      gradient.addColorStop(0, '#F05459');\r\n      gradient.addColorStop(.4, '#766EE9');\r\n      gradient.addColorStop(1, '#57A4FE');\r\n    } else if(type === GROUP_CALL_STATE.UNMUTED) {\r\n      gradient.addColorStop(0, '#52CE5D');\r\n      gradient.addColorStop(1, '#00B1C0');\r\n    } else if(type === GROUP_CALL_STATE.MUTED) {\r\n      gradient.addColorStop(0, '#0976E3');\r\n      gradient.addColorStop(1, '#2BCEFF');\r\n    } else if(type === GROUP_CALL_STATE.CONNECTING) {\r\n      gradient.addColorStop(0, '#8599aa');\r\n      gradient.addColorStop(1, '#8599aa');\r\n    }\r\n    \r\n    return gradient;\r\n  }\r\n  \r\n  update(height: number, width: number, dt: number, amplitude: number) {\r\n    // TODO: move gradient here\r\n  }\r\n}\r\n\r\nexport default class TopbarWeave {\r\n  private focused: boolean;\r\n  private resizing: boolean;\r\n  private lastUpdateTime: number;\r\n  private amplitude: number;\r\n  private amplitude2: number;\r\n  \r\n  private states: Map<GROUP_CALL_STATE, WeavingState>;\r\n  private previousState: WeavingState;\r\n  private currentState: WeavingState;\r\n  private progressToState: number;\r\n  \r\n  private scale: number;\r\n  private left: number;\r\n  private top: number;\r\n  private right: number;\r\n  private bottom: number;\r\n  \r\n  private mounted: boolean;\r\n  private media: MediaQueryList;\r\n  \r\n  private container: HTMLDivElement;\r\n  private canvas: HTMLCanvasElement;\r\n  \r\n  private resizeHandler: number;\r\n  private raf: number;\r\n\r\n  private lbd: LineBlobDrawable;\r\n  private lbd1: LineBlobDrawable;\r\n  private lbd2: LineBlobDrawable;\r\n\r\n  private animateToAmplitude: number;\r\n  private animateAmplitudeDiff: number;\r\n  private animateAmplitudeDiff2: number;\r\n  \r\n  constructor() {\r\n    this.focused = true;\r\n    this.resizing = false;\r\n    this.lastUpdateTime = Date.now();\r\n    this.amplitude = 0.0;\r\n    this.amplitude2 = 0.0;\r\n    \r\n    this.states = new Map([\r\n      [GROUP_CALL_STATE.UNMUTED, new WeavingState(GROUP_CALL_STATE.UNMUTED)],\r\n      [GROUP_CALL_STATE.MUTED, new WeavingState(GROUP_CALL_STATE.MUTED)],\r\n      [GROUP_CALL_STATE.MUTED_BY_ADMIN, new WeavingState(GROUP_CALL_STATE.MUTED_BY_ADMIN)],\r\n      [GROUP_CALL_STATE.CONNECTING, new WeavingState(GROUP_CALL_STATE.CONNECTING)],\r\n    ]);\r\n    this.previousState = null;\r\n    this.currentState = this.states.get(GROUP_CALL_STATE.CONNECTING);\r\n    this.progressToState = 1.0;\r\n  }\r\n  \r\n  public componentDidMount() {\r\n    if(this.mounted) {\r\n      return;\r\n    }\r\n\r\n    this.mounted = true;\r\n    // window.addEventListener('blur', this.handleBlur);\r\n    // window.addEventListener('focus', this.handleFocus);\r\n    window.addEventListener('resize', this.handleResize);\r\n    this.media = window.matchMedia('screen and (min-resolution: 2dppx)');\r\n    this.media.addEventListener('change', this.handleDevicePixelRatioChanged);\r\n    \r\n    this.setSize();\r\n    this.forceUpdate();\r\n    \r\n    this.lbd = new LineBlobDrawable(3);\r\n    this.lbd1 = new LineBlobDrawable(7);\r\n    this.lbd2 = new LineBlobDrawable(8);\r\n    this.setAmplitude(this.amplitude);\r\n    \r\n    this.draw();\r\n  }\r\n  \r\n  public componentWillUnmount() {\r\n    this.mounted = false;\r\n    // window.removeEventListener('blur', this.handleBlur);\r\n    // window.removeEventListener('focus', this.handleFocus);\r\n    window.removeEventListener('resize', this.handleResize);\r\n    this.media.addEventListener('change', this.handleDevicePixelRatioChanged);\r\n\r\n    const {canvas} = this;\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n  }\r\n\r\n  private setSize() {\r\n    this.scale = window.devicePixelRatio;\r\n    this.top = 20 * this.scale;\r\n    this.right = (this.mounted ? this.container.offsetWidth : 1261) * this.scale;\r\n    this.bottom = (this.mounted ? this.container.offsetHeight : 68) * this.scale;\r\n    this.left = 0 * this.scale;\r\n    this.setCanvasSize();\r\n  }\r\n\r\n  private setCanvasSize() {\r\n    this.canvas.width = this.right;\r\n    this.canvas.height = this.bottom;\r\n  }\r\n  \r\n  private handleDevicePixelRatioChanged = (e: Event) => {\r\n    this.setSize();\r\n    this.forceUpdate();\r\n  }\r\n  \r\n  private handleResize = () => {\r\n    if(this.resizeHandler) {\r\n      clearTimeout(this.resizeHandler);\r\n      this.resizeHandler = null;\r\n    }\r\n    \r\n    this.resizing = true;\r\n    this.resizeCanvas();\r\n    this.resizeHandler = window.setTimeout(() => {\r\n      this.resizing = false;\r\n      this.invokeDraw();\r\n    }, 250);\r\n  }\r\n  \r\n  private resizeCanvas() {\r\n    this.scale = window.devicePixelRatio;\r\n    this.right = this.container.offsetWidth * this.scale;\r\n    \r\n    this.forceUpdate();\r\n    this.invokeDraw();\r\n  }\r\n  \r\n  public handleFocus = () => {\r\n    this.focused = true;\r\n    this.invokeDraw();\r\n  }\r\n  \r\n  public handleBlur = () => {\r\n    this.focused = false;\r\n  }\r\n  \r\n  private invokeDraw = () => {\r\n    if(this.raf) return;\r\n    \r\n    this.draw();\r\n  }\r\n  \r\n  private draw = (force = false) => {\r\n    this.raf = null;\r\n    if(!this.mounted) {\r\n      return;\r\n    }\r\n    const {lbd, lbd1, lbd2, scale, left, top, right, bottom, currentState, previousState, focused, resizing, canvas} = this;\r\n    if(!focused && !resizing && this.progressToState >= 1.0) {\r\n      return;\r\n    }\r\n    \r\n    // console.log('[top] draw', [focused, resizing, this.mounted]);\r\n    \r\n    const newTime = Date.now();\r\n    let dt = (newTime - this.lastUpdateTime);\r\n    if(dt > 20) {\r\n      dt = 17;\r\n    }\r\n    \r\n    // console.log('draw start', this.amplitude, this.animateToAmplitude);\r\n    if(this.animateToAmplitude !== this.amplitude) {\r\n      this.amplitude += this.animateAmplitudeDiff * dt;\r\n      if(this.animateAmplitudeDiff > 0) {\r\n        if(this.amplitude > this.animateToAmplitude) {\r\n          this.amplitude = this.animateToAmplitude;\r\n        }\r\n      } else {\r\n        if(this.amplitude < this.animateToAmplitude) {\r\n          this.amplitude = this.animateToAmplitude;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(this.animateToAmplitude !== this.amplitude2) {\r\n      this.amplitude2 += this.animateAmplitudeDiff2 * dt;\r\n      if(this.animateAmplitudeDiff2 > 0) {\r\n        if(this.amplitude2 > this.animateToAmplitude) {\r\n          this.amplitude2 = this.animateToAmplitude;\r\n        }\r\n      } else {\r\n        if(this.amplitude2 < this.animateToAmplitude) {\r\n          this.amplitude2 = this.animateToAmplitude;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(previousState) {\r\n      this.progressToState += dt / 250;\r\n      if(this.progressToState > 1) {\r\n        this.progressToState = 1;\r\n        this.previousState = null;\r\n      }\r\n    }\r\n\r\n    const {amplitude, amplitude2, progressToState} = this;\r\n    \r\n    const top1 = 6 * amplitude2 * scale;\r\n    const top2 = 6 * amplitude2 * scale;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    \r\n    lbd.minRadius = 0;\r\n    lbd.maxRadius = (2 + 2 * amplitude) * scale;\r\n    lbd1.minRadius = 0;\r\n    lbd1.maxRadius = (3 + 9 * amplitude) * scale;\r\n    lbd2.minRadius = 0;\r\n    lbd2.maxRadius = (3 + 9 * amplitude) * scale;\r\n    \r\n    lbd.update(amplitude, 0.3);\r\n    lbd1.update(amplitude, 0.7);\r\n    lbd2.update(amplitude, 0.7);\r\n    \r\n    for(let i = 0; i < 2; i++) {\r\n      if(i === 0 && !previousState) {\r\n        continue;\r\n      }\r\n      \r\n      let alpha = 1;\r\n      let state: WeavingState = null;\r\n      if(i === 0) {\r\n        alpha = 1 - progressToState;\r\n        state = previousState;\r\n        // previousState.setToPaint(paint);\r\n      } else {\r\n        alpha = previousState ? progressToState : 1;\r\n        currentState.update(bottom - top, right - left, dt, amplitude);\r\n        state = currentState;\r\n        // currentState.setToPaint(paint);\r\n      }\r\n      \r\n      const paint1 = (ctx: CanvasRenderingContext2D) => {\r\n        ctx.globalAlpha = 0.3 * alpha;\r\n        state.shader(ctx, left, top, right, bottom);\r\n      };\r\n      const paint = (ctx: CanvasRenderingContext2D) => {\r\n        ctx.globalAlpha = i === 0 ? 1 : alpha;\r\n        state.shader(ctx, left, top, right, bottom);\r\n      };\r\n      \r\n      lbd1.draw(left, top - top1, right, bottom, canvas, paint1, top, 1.0);\r\n      lbd2.draw(left, top - top2, right, bottom, canvas, paint1, top, 1.0);\r\n      lbd.draw(left, top, right, bottom, canvas, paint, top, 1.0);\r\n    }\r\n    \r\n    if(!force) {\r\n      this.raf = requestAnimationFrame(() => this.draw());\r\n    }\r\n  };\r\n  \r\n  public setCurrentState = (stateId: GROUP_CALL_STATE, animated: boolean) => {\r\n    const {currentState, states} = this;\r\n    \r\n    if(currentState?.stateId === stateId) {\r\n      return;\r\n    }\r\n    \r\n    this.previousState = animated ? currentState : null;\r\n    this.currentState = states.get(stateId);\r\n    this.progressToState = this.previousState ? 0.0 : 1.0;\r\n  };\r\n  \r\n  public setAmplitude(value: number) {\r\n    const {amplitude} = this;\r\n    this.animateToAmplitude = value;\r\n    this.animateAmplitudeDiff = (value - amplitude) / 250;\r\n    this.animateAmplitudeDiff2 = (value - amplitude) / 120;\r\n  }\r\n\r\n  private forceUpdate() {\r\n    this.setCanvasSize();\r\n  }\r\n  \r\n  public render(className: string) {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className);\r\n\r\n    const canvas = this.canvas = document.createElement('canvas');\r\n    canvas.classList.add(className + '-canvas');\r\n\r\n    container.append(canvas);\r\n\r\n    return container;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport type CustomProperty = string;\r\n\r\nexport class CustomProperties {\r\n  private cache: {[k in CustomProperty]?: string};\r\n  private computedStyle: CSSStyleDeclaration;\r\n\r\n  constructor() {\r\n    this.cache = {};\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      this.computedStyle = undefined;\r\n      const cache = this.cache;\r\n      this.cache = {};\r\n\r\n      for(let i in cache) {\r\n        this.getProperty(i);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getProperty(name: CustomProperty) {\r\n    let value = this.cache[name];\r\n    if(value) {\r\n      return value;\r\n    }\r\n\r\n    if(!this.computedStyle) {\r\n      this.computedStyle = window.getComputedStyle(document.documentElement);\r\n    }\r\n\r\n    value = this.computedStyle.getPropertyValue('--' + name).trim();\r\n    return this.cache[name] = value;\r\n  }\r\n}\r\n\r\nconst customProperties = new CustomProperties();\r\nexport default customProperties;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport noop from \"../../helpers/noop\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport rootScope from \"../rootScope\";\r\nimport lottieLoader, { LottieAssetName } from \"./lottieLoader\";\r\nimport type RLottiePlayer from \"./rlottiePlayer\";\r\nimport { RLottieColor } from \"./rlottiePlayer\";\r\n\r\nexport type RLottieIconOptions = {\r\n  width: number,\r\n  height: number,\r\n  container?: HTMLElement,\r\n  skipAnimation?: boolean\r\n};\r\n\r\nexport type RLottieIconItemPartOptions = {\r\n  startFrame: number,\r\n  endFrame: number,\r\n  name?: string\r\n};\r\n\r\nexport type RLottieIconItemOptions = {\r\n  name: LottieAssetName,\r\n  parts: RLottieIconItemPartOptions[],\r\n  initFrame?: number,\r\n  player?: RLottiePlayer,\r\n  autoplay?: boolean,\r\n  color?: RLottieColor,\r\n  inverseColor?: RLottieColor,\r\n};\r\n\r\nexport class RLottieIconItemPart implements RLottieIconItemPartOptions {\r\n  public startFrame: number;\r\n  public endFrame: number;\r\n  public name?: string;\r\n  \r\n  constructor(public item: RLottieIconItem, options: RLottieIconItemPartOptions) {\r\n    safeAssign(this, options);\r\n  }\r\n\r\n  public play(callback?: () => void) {\r\n    return this.item.playPart(this, callback);\r\n  }\r\n}\r\n\r\n// export type RLottieIconItemPart = RLottieIconItemPartOptions;\r\n\r\nexport class RLottieIconItem implements RLottieIconItemOptions {\r\n  public name: LottieAssetName;\r\n  public parts: RLottieIconItemPart[];\r\n  public player: RLottiePlayer;\r\n  public initFrame: number;\r\n  public autoplay: boolean;\r\n  public color: RLottieColor;\r\n  public inverseColor: RLottieColor;\r\n  public loadPromise: Promise<void>;\r\n  public onLoadForPart: () => void;\r\n  public onLoadForColor: () => void;\r\n\r\n  constructor(public icon: RLottieIcon, options: RLottieIconItemOptions) {\r\n    this.autoplay = false;\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.parts = this.parts.map((options) => this.createPart(options));\r\n  }\r\n\r\n  public load() {\r\n    let loadPromise = this.loadPromise;\r\n    if(loadPromise) {\r\n      return loadPromise;\r\n    }\r\n\r\n    const {container, canvas, width, height} = this.icon;\r\n    loadPromise = lottieLoader.loadAnimationAsAsset({\r\n      container,\r\n      canvas,\r\n      width,\r\n      height,\r\n      group: 'none',\r\n      loop: false,\r\n      autoplay: this.autoplay ?? false,\r\n      initFrame: this.initFrame,\r\n      skipFirstFrameRendering: this.initFrame === undefined,\r\n      color: this.color,\r\n      inverseColor: this.inverseColor\r\n    }, this.name).then((player) => {\r\n      return lottieLoader.waitForFirstFrame(player);\r\n    }).then((player) => {\r\n      this.player = player;\r\n\r\n      if(this.onLoadForColor) {\r\n        this.onLoadForColor();\r\n        this.onLoadForColor = undefined;\r\n      }\r\n\r\n      if(this.onLoadForPart) {\r\n        this.onLoadForPart();\r\n        this.onLoadForPart = undefined;\r\n      }\r\n    });\r\n\r\n    this.loadPromise = loadPromise;\r\n    this.icon.loadPromises.set(this.name, loadPromise);\r\n    return loadPromise;\r\n  }\r\n\r\n  public createPart(options: RLottieIconItemPartOptions) {\r\n    return new RLottieIconItemPart(this, options);\r\n  }\r\n\r\n  public getPart(index: string | number | RLottieIconItemPart) {\r\n    if(index instanceof RLottieIconItemPart) return index;\r\n    else if(typeof(index) === 'string') return this.parts.find((part) => part.name === index);\r\n    else return this.parts[index];\r\n  }\r\n\r\n  public playPart(part: RLottieIconItemPart, callback?: () => void) {\r\n    return this.icon.playPart(this, part, callback);\r\n  }\r\n}\r\n\r\nexport default class RLottieIcon {\r\n  public container: HTMLElement;\r\n  public canvas: HTMLCanvasElement;\r\n  public width: number;\r\n  public height: number;\r\n\r\n  protected items: Map<LottieAssetName, RLottieIconItem>;\r\n  public loadPromises: Map<LottieAssetName, Promise<void>>;\r\n\r\n  protected skipAnimation: boolean;\r\n\r\n  constructor(options: RLottieIconOptions) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.container) this.container = document.createElement('div');\r\n    this.container.classList.add('rlottie-icon');\r\n\r\n    const {width, height} = this;\r\n    this.container.style.width = width + 'px';\r\n    this.container.style.height = height + 'px';\r\n\r\n    const canvas = this.canvas = document.createElement('canvas');\r\n    canvas.classList.add('rlottie');\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n\r\n    this.items = new Map();\r\n    this.loadPromises = new Map();\r\n  }\r\n\r\n  public get loadPromise() {\r\n    return Promise.all([...this.loadPromises.values()]).then(noop);\r\n  }\r\n\r\n  public getItem(name?: LottieAssetName): RLottieIconItem {\r\n    return !name && this.items.size === 1 ? this.items.values().next().value : this.items.get(name);\r\n  }\r\n\r\n  public add(options: Omit<RLottieIconItemOptions, 'player'>) {\r\n    const item = new RLottieIconItem(this, options);\r\n    this.items.set(options.name, item);\r\n\r\n    return item;\r\n  }\r\n\r\n  public playPart(item: RLottieIconItem, index: Parameters<RLottieIconItem['getPart']>[0], callback?: () => void) {\r\n    if(!item.player) {\r\n      item.onLoadForPart = () => {\r\n        this.playPart(item, index, callback);\r\n      };\r\n\r\n      return;\r\n    }\r\n    \r\n    const part = item.getPart(index);\r\n    item.player.playPart({\r\n      from: rootScope.settings.animationsEnabled && !this.skipAnimation ? part.startFrame : part.endFrame, \r\n      to: part.endFrame,\r\n      callback\r\n    });\r\n  }\r\n\r\n  /* public playToPart(item: RLottieIconItem, index: Parameters<RLottieIconItem['getPart']>[0], toEnd: boolean) {\r\n    if(!item.player) return;\r\n    const part = item.getPart(index);\r\n    const toFrame = toEnd ? part.endFrame : part.startFrame;\r\n    item.player.playToFrame({\r\n      frame: toFrame\r\n    });\r\n  } */\r\n  \r\n  public static generateEqualParts(length: number, frameCount: number): RLottieIconItemPartOptions[] {\r\n    return new Array(length).fill(0).map((_, idx) => {\r\n      const startFrame = idx * frameCount;\r\n      return {startFrame, endFrame: startFrame + frameCount - 1};\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport noop from \"../helpers/noop\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { LottieAssetName } from \"../lib/rlottie/lottieLoader\";\r\nimport RLottieIcon, { RLottieIconItemPartOptions, RLottieIconItemPart } from \"../lib/rlottie/rlottieIcon\";\r\nimport { RLottieColor } from \"../lib/rlottie/rlottiePlayer\";\r\n\r\nexport type SuperRLottieIconAddItemOptions = {name: LottieAssetName, parts: RLottieIconItemPartOptions};\r\nexport type SuperRLottieIconGetInfoResult = RLottieIconItemPart;\r\nexport class SuperRLottieIcon<Options extends {\r\n  PartState: any,\r\n  ColorState?: any,\r\n  Items?: {\r\n    name: string\r\n  }[]\r\n}> extends RLottieIcon {\r\n  protected getPart: (state: Options['PartState'], prevState?: Options['PartState']) => SuperRLottieIconGetInfoResult;\r\n  protected getColor?: (state: Options['ColorState'], prevState?: Options['ColorState']) => RLottieColor;\r\n\r\n  protected partState: Options['PartState'];\r\n  protected colorState: Options['ColorState'];\r\n  protected loaded: boolean;\r\n\r\n  constructor(options: {\r\n    width: number,\r\n    height: number,\r\n    skipAnimation?: boolean,\r\n    getPart: (state: Options['PartState'], prevState?: Options['PartState']) => SuperRLottieIconGetInfoResult,\r\n    getColor?: (state: Options['ColorState'], prevState?: Options['ColorState']) => RLottieColor,\r\n  }) {\r\n    super({\r\n      width: options.width,\r\n      height: options.height\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    // hook the first call\r\n    /* const originalFunction = this.setState.bind(this);\r\n    this.setState = (partState, colorState) => {\r\n      this.setState = originalFunction;\r\n      this.load(partState, colorState);\r\n      return originalFunction(partState, colorState);\r\n    }; */\r\n  }\r\n\r\n  public load(partState: Options['PartState'], colorState?: Options['ColorState']) {\r\n    if(this.loaded) {\r\n      return this.loadPromise;\r\n    }\r\n\r\n    this.loaded = true;\r\n    this.partState = partState;\r\n    this.colorState = colorState;\r\n\r\n    const part = this.getPart(partState);\r\n    const color = colorState !== undefined && this.getColor && this.getColor(colorState);\r\n\r\n    const item = part.item;\r\n    item.initFrame = part.endFrame;\r\n    item.color = color;\r\n\r\n    const promises = [...this.items.values()].map((item) => item.load());\r\n    return Promise.all(promises).then(noop);\r\n  }\r\n\r\n  /**\r\n   * Will redirect setting color state to part callback to synchronize the rendering\r\n   */\r\n  public setState(partState: Options['PartState'], colorState?: Options['ColorState'], partCallback?: () => void) {\r\n    if(!this.loaded) this.load(partState, colorState);\r\n\r\n    let changedPartState = false, changedColorState = false;\r\n    if(partState !== undefined) changedPartState = this.setPartState(partState, colorState, partCallback);\r\n    else if(colorState !== undefined) changedColorState = this.setColorState(colorState);\r\n\r\n    return changedPartState || changedColorState;\r\n  }\r\n\r\n  public setPartState(state: Options['PartState'], colorState?: Options['ColorState'], callback?: () => void) {\r\n    const {partState: prevState} = this;\r\n    if(prevState === state) {\r\n      return colorState !== undefined ? this.setColorState(colorState) : false;\r\n    }\r\n\r\n    if(colorState !== undefined) {\r\n      this.setColorState(colorState, false);\r\n    }\r\n\r\n    this.partState = state;\r\n\r\n    const part = this.getPart(state, prevState);\r\n    part.play(callback);\r\n\r\n    return true;\r\n  }\r\n\r\n  public setColorState(state: Options['ColorState'], renderIfPaused = true) {\r\n    const {colorState: prevState} = this;\r\n    if(prevState === state || !this.getColor) {\r\n      return false;\r\n    }\r\n\r\n    this.colorState = state;\r\n    \r\n    const item = this.getItem();\r\n    const color = this.getColor(state, prevState);\r\n    const invoke = () => {\r\n      item.player.setColor(color, renderIfPaused);\r\n    };\r\n    \r\n    if(item.player) {\r\n      invoke();\r\n    } else {\r\n      item.onLoadForColor = invoke;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public destroy() {\r\n    this.items.forEach((item) => {\r\n      item.loadPromise.then(() => {\r\n        item.player.remove();\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { RLottieIconItemPartOptions } from \"../../lib/rlottie/rlottieIcon\";\r\nimport { GROUP_CALL_MICROPHONE_BUTTON_STATE } from \".\";\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallMicrophoneIcon extends SuperRLottieIcon<{\r\n  PartState: GROUP_CALL_MICROPHONE_BUTTON_STATE\r\n}> {\r\n  constructor() {\r\n    super({\r\n      width: 36,\r\n      height: 36,\r\n      getPart: (state, prevState) => {\r\n        const states = GROUP_CALL_MICROPHONE_BUTTON_STATE;\r\n        let partName: string;\r\n        switch(state) {\r\n          case states.HAND:\r\n            partName = prevState === states.MUTED ? 'muted-to-hand' : 'unmuted-to-hand';\r\n            break;\r\n          case states.MUTED:\r\n            partName = prevState === states.HAND ? 'hand-to-muted' : 'mute';\r\n            break;\r\n          case states.UNMUTED:\r\n            partName = 'unmute';\r\n            break;\r\n        }\r\n\r\n        return this.getItem().getPart(partName);\r\n      }\r\n    });\r\n\r\n    const className = 'group-call-microphone-icon';\r\n    this.container.classList.add(className + '-container');\r\n\r\n    const parts: RLottieIconItemPartOptions[] = [{\r\n      startFrame: 0,\r\n      endFrame: 35,\r\n      name: 'hand-to-muted'\r\n    }, {\r\n      startFrame: 36,\r\n      endFrame: 68,\r\n      name: 'unmute'\r\n    }, {\r\n      startFrame: 69,\r\n      endFrame: 98,\r\n      name: 'mute'\r\n    }, {\r\n      startFrame: 99,\r\n      endFrame: 135,\r\n      name: 'muted-to-hand'\r\n    }, {\r\n      startFrame: 136,\r\n      endFrame: 172,\r\n      name: 'unmuted-to-hand'\r\n    }, {\r\n      startFrame: 173,\r\n      endFrame: 201,\r\n      name: 'scheduled-crossing'\r\n    }, {\r\n      startFrame: 202,\r\n      endFrame: 236,\r\n      name: 'scheduled-to-muted'\r\n    }, {\r\n      startFrame: 237,\r\n      endFrame: 273,\r\n      name: 'scheduled-to-hand'\r\n    }, {\r\n      startFrame: 274,\r\n      endFrame: 310,\r\n      name: 'scheduled-crossed-to-hand'\r\n    }, {\r\n      startFrame: 311,\r\n      endFrame: 343,\r\n      name: 'scheduled-uncrossing'\r\n    }, {\r\n      startFrame: 344,\r\n      endFrame: 375,\r\n      name: 'scheduled-to-muted'\r\n    }, {\r\n      startFrame: 376,\r\n      endFrame: 403,\r\n      name: 'play-to-muted'\r\n    }];\r\n\r\n    this.add({\r\n      name: 'voip_filled',\r\n      parts\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport RLottieIcon from \"../../lib/rlottie/rlottieIcon\";\r\nimport { GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE, GROUP_CALL_PARTICIPANT_MUTED_STATE, getColorByMutedState, clearMutedStateModifier } from \".\";\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallParticipantMutedIcon extends SuperRLottieIcon<{\r\n  PartState: GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE, \r\n  ColorState: GROUP_CALL_PARTICIPANT_MUTED_STATE\r\n}> {\r\n  constructor(private colored: boolean) {\r\n    super({\r\n      width: 32,\r\n      height: 32,\r\n      getPart: (state, prevState) => {\r\n        const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n\r\n        let index: number;\r\n        switch(state) {\r\n          case states.HAND:\r\n            index = 3;\r\n            break;\r\n          case states.MUTED:\r\n            index = prevState === states.HAND ? 0 : 2;\r\n            break;\r\n          case states.UNMUTED:\r\n            index = 1;\r\n            break;\r\n        }\r\n\r\n        return this.getItem().getPart(index);\r\n      },\r\n      getColor: colored ? (state, prevState) => {\r\n        return getColorByMutedState(state);\r\n      } : undefined\r\n    });\r\n\r\n    const className = 'group-call-participant-muted-icon';\r\n    this.container.classList.add(className + '-container');\r\n\r\n    const parts = RLottieIcon.generateEqualParts(4, 21);\r\n    this.add({\r\n      name: 'voice_outlined2',\r\n      parts\r\n    });\r\n  }\r\n\r\n  public setState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE) {\r\n    return super.setState(clearMutedStateModifier(state), state);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \"../popups\";\r\nimport { hexToRgb } from \"../../helpers/color\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport customProperties from \"../../helpers/dom/customProperties\";\r\nimport { GroupCall, GroupCallParticipant } from \"../../layer\";\r\nimport type { AppChatsManager } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppGroupCallsManager } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport type { AppPeersManager } from \"../../lib/appManagers/appPeersManager\";\r\nimport GROUP_CALL_STATE from \"../../lib/calls/groupCallState\";\r\nimport { RLottieColor } from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport GroupCallMicrophoneIcon from \"./microphoneIcon\";\r\nimport GroupCallParticipantsElement from \"./participants\";\r\nimport GroupCallParticipantsVideoElement from \"./participantVideos\";\r\nimport PopupPeer from \"../popups/peer\";\r\nimport GroupCallDescriptionElement from \"./description\";\r\nimport GroupCallTitleElement from \"./title\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { MovableState } from \"../movableElement\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport { IS_APPLE_MOBILE } from \"../../environment/userAgent\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport IS_SCREEN_SHARING_SUPPORTED from \"../../environment/screenSharingSupport\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport makeButton from \"../call/button\";\r\nimport MovablePanel from \"../../helpers/movablePanel\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport toggleClassName from \"../../helpers/toggleClassName\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport groupCallsController from \"../../lib/calls/groupCallsController\";\r\n\r\nexport enum GROUP_CALL_PARTICIPANT_MUTED_STATE {\r\n  UNMUTED,\r\n  MUTED,\r\n  MUTED_FOR_ME,\r\n  MUTED_BY_ADMIN,\r\n  HAND\r\n}\r\n\r\nexport type GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE = Exclude<GROUP_CALL_PARTICIPANT_MUTED_STATE, GROUP_CALL_PARTICIPANT_MUTED_STATE.MUTED_BY_ADMIN | GROUP_CALL_PARTICIPANT_MUTED_STATE.MUTED_FOR_ME>;\r\n\r\nexport function getGroupCallParticipantMutedState(participant: GroupCallParticipant) {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  if(participant.pFlags.muted_by_you) {\r\n    return states.MUTED_FOR_ME;\r\n  } else if(participant.raise_hand_rating !== undefined) {\r\n    return states.HAND;\r\n  } else if(participant.pFlags.muted) {\r\n    return participant.pFlags.can_self_unmute ? states.MUTED : states.MUTED_BY_ADMIN;\r\n  } else {\r\n    return states.UNMUTED;\r\n  }\r\n}\r\n\r\nexport function clearMutedStateModifier(state: GROUP_CALL_PARTICIPANT_MUTED_STATE): GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  switch(state) {\r\n    case states.MUTED_BY_ADMIN:\r\n    case states.MUTED_FOR_ME:\r\n      return states.MUTED;\r\n    default:\r\n      return state;\r\n  }\r\n}\r\n\r\nexport function getColorByMutedState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE) {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  let color: RLottieColor, colorStr: 'blue' | 'green' | 'secondary' | 'red';\r\n  switch(state) {\r\n    case states.HAND:\r\n      colorStr = 'blue';\r\n      break;\r\n    case states.MUTED:\r\n    case states.MUTED_FOR_ME:\r\n    case states.MUTED_BY_ADMIN:\r\n      colorStr = state === states.MUTED ? 'secondary' : 'red';\r\n      break;\r\n    case states.UNMUTED:\r\n      colorStr = 'green';\r\n      break;\r\n  }\r\n\r\n  const propertyValue = customProperties.getProperty('gc-' + colorStr + '-text-color');\r\n  color = hexToRgb(propertyValue);\r\n\r\n  return color;\r\n}\r\n\r\nexport enum GROUP_CALL_MICROPHONE_BUTTON_STATE {\r\n  HAND,\r\n  MUTED,\r\n  UNMUTED,\r\n}\r\n\r\nexport function getGroupCallMicrophoneButtonState(groupCall: GroupCall.groupCall, participant: GroupCallParticipant) {\r\n  const states = GROUP_CALL_MICROPHONE_BUTTON_STATE;\r\n  if(!participant.pFlags.can_self_unmute) {\r\n    return states.HAND;\r\n  } else if(participant.pFlags.muted) {\r\n    return states.MUTED\r\n  } else {\r\n    return states.UNMUTED;\r\n  }\r\n}\r\n\r\nlet previousState: MovableState = {\r\n  width: 420,\r\n  height: 640\r\n};\r\n\r\nconst className = 'group-call';\r\n\r\nexport default class PopupGroupCall extends PopupElement {\r\n  private instance: GroupCallInstance;\r\n  private groupCallTitle: GroupCallTitleElement;\r\n  private groupCallDescription: GroupCallDescriptionElement;\r\n  private groupCallBodyHeaderDescription: GroupCallDescriptionElement;\r\n  private groupCallParticipants: GroupCallParticipantsElement;\r\n  private groupCallParticipantsVideo: GroupCallParticipantsVideoElement;\r\n  private groupCallMicrophoneIcon: GroupCallMicrophoneIcon;\r\n  private videosCount: number;\r\n  private btnFullScreen: HTMLButtonElement;\r\n  private btnExitFullScreen: HTMLButtonElement;\r\n  private btnInvite: HTMLButtonElement;\r\n  private btnShowColumn: HTMLButtonElement;\r\n  private movablePanel: MovablePanel;\r\n  private buttonsContainer: HTMLDivElement;\r\n  private btnFullScreen2: HTMLButtonElement;\r\n  private btnVideo: HTMLDivElement;\r\n  private btnScreen: HTMLDivElement;\r\n\r\n  constructor() {\r\n    super('popup-group-call', undefined, {\r\n      body: true,\r\n      withoutOverlay: true,\r\n      closable: true\r\n    });\r\n\r\n    this.videosCount = 0;\r\n    this.container.classList.add(className, 'night');\r\n\r\n    const instance = this.instance = groupCallsController.groupCall;\r\n    const {listenerSetter} = this;\r\n\r\n    if(!IS_APPLE_MOBILE) {\r\n      const btnFullScreen = this.btnFullScreen = ButtonIcon('fullscreen');\r\n      const btnFullScreen2 = this.btnFullScreen2 = ButtonIcon('fullscreen ' + className + '-cfs');\r\n      const btnExitFullScreen = this.btnExitFullScreen = ButtonIcon('smallscreen');\r\n  \r\n      attachClickEvent(btnFullScreen, this.onFullScreenClick, {listenerSetter});\r\n      attachClickEvent(btnFullScreen2, this.onFullScreenClick, {listenerSetter});\r\n  \r\n      attachClickEvent(btnExitFullScreen, () => {\r\n        cancelFullScreen();\r\n      }, {listenerSetter});\r\n  \r\n      addFullScreenListener(this.container, this.onFullScreenChange, listenerSetter);\r\n    }\r\n\r\n    const btnInvite = this.btnInvite = ButtonIcon('adduser');\r\n    const btnShowColumn = this.btnShowColumn = ButtonIcon('rightpanel ' + className + '-only-big');\r\n\r\n    attachClickEvent(btnShowColumn, this.toggleRightColumn, {listenerSetter});\r\n\r\n    const headerInfo = document.createElement('div');\r\n    headerInfo.classList.add(className + '-header-info');\r\n\r\n    this.title.classList.add(className + '-header-title');\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(className + '-header-subtitle');\r\n\r\n    headerInfo.append(this.title, subtitle);\r\n\r\n    this.header.classList.add(className + '-header');\r\n    this.header.append(...[this.btnExitFullScreen, headerInfo/* , btnInvite */, this.btnFullScreen, btnShowColumn].filter(Boolean));\r\n\r\n    const newHeader = this.header.cloneNode(false) as HTMLElement;\r\n    const newHeaderInfo = headerInfo.cloneNode(false) as HTMLElement;\r\n    const newHeaderTitle = this.title.cloneNode(false) as HTMLElement;\r\n\r\n    newHeaderInfo.append(newHeaderTitle);\r\n\r\n    const btnHideColumn = ButtonIcon('rightpanel');\r\n    newHeader.append(...[btnHideColumn, newHeaderInfo, this.btnFullScreen2].filter(Boolean));\r\n\r\n    attachClickEvent(btnHideColumn, this.toggleRightColumn, {listenerSetter});\r\n\r\n    this.body.prepend(newHeader);\r\n\r\n    const videosScrollable = new Scrollable(undefined);\r\n    videosScrollable.container.classList.add('group-call-big-video-container');\r\n    this.container.append(videosScrollable.container);\r\n\r\n    this.groupCallTitle = new GroupCallTitleElement(this.title);\r\n    this.groupCallDescription = new GroupCallDescriptionElement(subtitle);\r\n    this.groupCallBodyHeaderDescription = new GroupCallDescriptionElement(newHeaderTitle);\r\n    this.constructButtons();\r\n\r\n    this.groupCallParticipantsVideo = new GroupCallParticipantsVideoElement({\r\n      appendTo: videosScrollable.container,\r\n      instance,\r\n      listenerSetter,\r\n      displayPinned: true,\r\n      onLengthChange: (length) => {\r\n        this.videosCount = length;\r\n        this.toggleBigLayout();\r\n      },\r\n      managers: this.managers\r\n    });\r\n    this.groupCallParticipants = new GroupCallParticipantsElement({\r\n      appendTo: this.body,\r\n      instance,\r\n      listenerSetter,\r\n      managers: this.managers\r\n    });\r\n\r\n    this.movablePanel = new MovablePanel({\r\n      listenerSetter,\r\n      movableOptions: {\r\n        minWidth: 400,\r\n        minHeight: 480,\r\n        element: this.element,\r\n        verifyTouchTarget: (e) => {\r\n          const target = e.target;\r\n          if(findUpClassName(target, 'chatlist') || \r\n            findUpClassName(target, 'group-call-button') || \r\n            findUpClassName(target, 'btn-icon') ||\r\n            findUpClassName(target, 'group-call-participants-video-container') ||\r\n            isFullScreen()) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      },\r\n      onResize: () => this.toggleBigLayout(),\r\n      previousState\r\n    });\r\n\r\n    listenerSetter.add(instance)('state', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('group_call_update', (groupCall) => {\r\n      if(this.instance?.id === groupCall.id) {\r\n        this.updateInstance();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(instance)('pinned', () => {\r\n      this.setHasPinned();\r\n    });\r\n\r\n    listenerSetter.add(this.groupCallParticipantsVideo)('toggleControls', this.onToggleControls);\r\n\r\n    this.addEventListener('close', () => {\r\n      const {movablePanel} = this;\r\n      previousState = movablePanel.state;\r\n\r\n      this.groupCallParticipantsVideo.destroy();\r\n      this.groupCallParticipants.destroy();\r\n      this.groupCallMicrophoneIcon.destroy();\r\n\r\n      movablePanel.destroy();\r\n    });\r\n\r\n    this.toggleRightColumn();\r\n    this.onFullScreenChange();\r\n\r\n    this.updateInstance();\r\n  }\r\n\r\n  private constructButtons() {\r\n    const buttons = this.buttonsContainer = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons');\r\n\r\n    const _makeButton = makeButton.bind(null, className, this.listenerSetter);\r\n\r\n    const btnVideo = this.btnVideo = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.Video',\r\n      callback: this.onVideoClick,\r\n      icon: 'videocamera_filled'\r\n    });\r\n\r\n    const btnScreen = this.btnScreen = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.Screencast',\r\n      callback: this.onScreenClick,\r\n      icon: 'sharescreen_filled'\r\n    });\r\n\r\n    btnScreen.classList.toggle('hide', !IS_SCREEN_SHARING_SUPPORTED);\r\n\r\n    const btnMute = _makeButton({\r\n      noRipple: true,\r\n      callback: throttle(this.onMuteClick, 600, true)\r\n    });\r\n    btnMute.classList.add(className + '-microphone-button');\r\n\r\n    const microphoneIcon = this.groupCallMicrophoneIcon = new GroupCallMicrophoneIcon();\r\n    btnMute.append(microphoneIcon.container);\r\n\r\n    const btnMore = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.More'\r\n      icon: 'settings_filled'\r\n    });\r\n\r\n    btnMore.classList.add('btn-disabled');\r\n    btnMore.classList.toggle('hide', !IS_SCREEN_SHARING_SUPPORTED);\r\n\r\n    const btnLeave = _makeButton({\r\n      // text: 'VoiceChat.Leave',\r\n      isDanger: true,\r\n      callback: this.onLeaveClick,\r\n      icon: 'close'\r\n    });\r\n\r\n    buttons.append(btnVideo, btnScreen, btnMute, btnMore, btnLeave);\r\n\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private onFullScreenClick = () => {\r\n    requestFullScreen(this.container);\r\n  };\r\n\r\n  private onToggleControls = (show: boolean) => {\r\n    this.container.classList.toggle('show-controls', show);\r\n    this.buttonsContainer.classList.toggle('show-controls', show);\r\n  };\r\n\r\n  private toggleDisability = toggleClassName.bind(null, 'btn-disabled');\r\n\r\n  private onVideoClick = () => {\r\n    const toggle = this.toggleDisability([this.btnVideo], true);\r\n    this.instance.toggleVideoSharing().finally(() => {\r\n      toggle();\r\n    });\r\n  };\r\n\r\n  private onScreenClick = () => {\r\n    const toggle = this.toggleDisability([this.btnScreen], true);\r\n    this.instance.toggleScreenSharing().finally(() => {\r\n      toggle();\r\n    });\r\n  };\r\n\r\n  private onMuteClick = () => {\r\n    const participant = this.instance.participant;\r\n    if(!participant.pFlags.can_self_unmute) {\r\n      if(participant.raise_hand_rating === undefined) {\r\n        this.instance.changeRaiseHand(true);\r\n      }\r\n    } else {\r\n      this.instance.toggleMuted();\r\n    }\r\n  };\r\n  \r\n  private onLeaveClick = async() => {\r\n    const hangUp = (discard: boolean) => {\r\n      this.instance.hangUp(discard);\r\n    };\r\n\r\n    if(await this.managers.appChatsManager.hasRights(this.instance.chatId, 'manage_call')) {\r\n      new PopupPeer('popup-end-video-chat', {\r\n        titleLangKey: 'VoiceChat.End.Title',\r\n        descriptionLangKey: 'VoiceChat.End.Text',\r\n        checkboxes: [{\r\n          text: 'VoiceChat.End.Third'\r\n        }],\r\n        buttons: [{\r\n          langKey: 'VoiceChat.End.OK',\r\n          callback: (checkboxes) => {\r\n            hangUp(!!checkboxes.size);\r\n          },\r\n          isDanger: true,\r\n        }]\r\n      }).show();\r\n    } else {\r\n      hangUp(false);\r\n    }\r\n  };\r\n\r\n  public getContainer() {\r\n    return this.container;\r\n  }\r\n\r\n  private onFullScreenChange = () => {\r\n    this.toggleBigLayout();\r\n    const isFull = isFullScreen();\r\n\r\n    const {btnFullScreen, btnExitFullScreen} = this;\r\n\r\n    const wasFullScreen = this.container.classList.contains('is-full-screen');\r\n    this.container.classList.toggle('is-full-screen', isFull);\r\n    btnFullScreen && btnFullScreen.classList.toggle('hide', isFull);\r\n    btnExitFullScreen && btnExitFullScreen.classList.toggle('hide', !isFull);\r\n    this.btnClose.classList.toggle('hide', isFull);\r\n\r\n    if(isFull !== wasFullScreen) {\r\n      animationIntersector.checkAnimations(isFull);\r\n\r\n      themeController.setThemeColor(isFull ? '#000000' : undefined);\r\n    }\r\n  };\r\n\r\n  private toggleBigLayout = () => {\r\n    const isFull = isFullScreen();\r\n    const movable = this.movablePanel?.movable;\r\n    const isBig = (isFull || !!(movable && movable.width >= 680)) && !!this.videosCount;\r\n\r\n    /* if(!isBig && isFull) {\r\n      cancelFullScreen();\r\n      return;\r\n    } */\r\n\r\n    const wasBig = this.container.classList.contains('is-big-layout');\r\n    let buttons: HTMLElement[];\r\n    if(isBig && !wasBig) { // fix buttons transition to 0 opacity\r\n      buttons = Array.from(this.buttonsContainer.children) as HTMLElement[];\r\n      buttons.forEach((element) => {\r\n        element.style.opacity = '0';\r\n      });\r\n\r\n      void this.buttonsContainer.offsetLeft;\r\n    }\r\n\r\n    this.container.classList.toggle('is-big-layout', isBig);\r\n    this.btnInvite.classList.toggle('hide', isBig);\r\n    this.btnShowColumn.classList.toggle('hide', !isBig);\r\n\r\n    if(buttons) {\r\n      // window.requestAnimationFrame(() => {\r\n        buttons.forEach((element) => {\r\n          element.style.opacity = '';\r\n        });\r\n      // });\r\n    }\r\n  };\r\n\r\n  private toggleRightColumn = () => {\r\n    this.container.classList.toggle('is-right-column-shown');\r\n  };\r\n\r\n  private setHasPinned() {\r\n    this.container.classList.toggle('has-pinned', !!this.instance.pinnedSource);\r\n  }\r\n\r\n  private updateInstance() {\r\n    if(this.instance.state === GROUP_CALL_STATE.CLOSED) {\r\n      if(this.container.classList.contains('is-full-screen')) {\r\n        cancelFullScreen();\r\n      }\r\n\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    const {participant, groupCall} = this.instance;\r\n    if(!participant) {\r\n      return;\r\n    }\r\n\r\n    this.setTitle();\r\n    this.setDescription();\r\n    this.setHasPinned();\r\n\r\n    const microphoneButtonState = getGroupCallMicrophoneButtonState(groupCall as any, participant);\r\n    this.container.dataset.micState = microphoneButtonState === GROUP_CALL_MICROPHONE_BUTTON_STATE.HAND ? 'hand' : (microphoneButtonState === GROUP_CALL_MICROPHONE_BUTTON_STATE.MUTED ? 'muted' : 'unmuted');\r\n    this.groupCallMicrophoneIcon.setState(microphoneButtonState);\r\n  }\r\n\r\n  private setTitle() {\r\n    this.groupCallTitle.update(this.instance);\r\n  }\r\n\r\n  private setDescription() {\r\n    this.groupCallDescription.update(this.instance);\r\n    this.groupCallBodyHeaderDescription.update(this.instance);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { GROUP_CALL_PARTICIPANT_MUTED_STATE } from \".\";\r\nimport { GroupCallParticipantVideoType } from \"./participantVideo\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nconst className = 'group-call-participant-status';\r\nexport default class GroupCallParticipantStatusElement {\r\n  public container: HTMLElement;\r\n\r\n  constructor(private withIcons: GroupCallParticipantVideoType[]) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n  }\r\n\r\n  public setState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE, participant: GroupCallParticipant) {\r\n    const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n    const icons = this.withIcons.filter((type) => !!participant[type]).map((type) => {\r\n      const iconClassName = `tgico-${type === 'presentation' ? 'listscreenshare' : 'videocamera_filled'}`;\r\n      const i = document.createElement('i');\r\n      i.classList.add(className + '-icon', className + '-icon-' + type, iconClassName);\r\n      return i;\r\n    });\r\n\r\n    let element2: HTMLElement, actionClassName: string;\r\n    if(state === states.MUTED_FOR_ME) {\r\n      element2 = i18n('VoiceChat.Status.MutedForYou');\r\n      actionClassName = 'is-muted';\r\n    } else if(state === states.UNMUTED) {\r\n      element2 = i18n('VoiceChat.Status.Speaking');\r\n      actionClassName = 'is-speaking';\r\n    } else if(state === states.HAND) {\r\n      element2 = i18n('VoiceChat.Status.WantsSpeak');\r\n      actionClassName = 'is-waiting';\r\n    } else if(participant.about && !icons.length) {\r\n      setInnerHTML(this.container, wrapEmojiText(participant.about));\r\n      return;\r\n    } else {\r\n      element2 = i18n('VoiceChat.Status.Listening');\r\n      actionClassName = 'is-listening';\r\n    }\r\n\r\n    const span = document.createElement('span');\r\n    span.classList.add(className, actionClassName);\r\n    span.append(...icons, element2);\r\n    \r\n    replaceContent(this.container, span);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport SortedList, { SortedElementBase } from \"../../helpers/sortedList\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport appDialogsManager, { DialogDom, AppDialogsManager } from \"../../lib/appManagers/appDialogsManager\";\r\nimport { getGroupCallParticipantMutedState } from \".\";\r\nimport GroupCallParticipantMutedIcon from \"./participantMutedIcon\";\r\nimport GroupCallParticipantStatusElement from \"./participantStatus\";\r\nimport type GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\n\r\ninterface SortedParticipant extends SortedElementBase {\r\n  dom: DialogDom,\r\n  mutedIcon: GroupCallParticipantMutedIcon,\r\n  status: GroupCallParticipantStatusElement\r\n}\r\n\r\nexport default class GroupCallParticipantsList extends SortedList<SortedParticipant> {\r\n  public list: HTMLUListElement;\r\n  \r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected avatarSize = 54;\r\n  protected rippleEnabled = true;\r\n  protected autonomous = true;\r\n  protected createChatListOptions: Parameters<AppDialogsManager['createChatList']>[0] = {/* new: true,  */dialogSize: 72};\r\n\r\n  constructor(private instance: GroupCallInstance) {\r\n    super({\r\n      getIndex: async(element) => (await this.instance.getParticipantByPeerId(element.id)).date,\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onElementDestroy(element);\r\n      },\r\n      onUpdate: async(element) => {\r\n        const participant = await this.instance.getParticipantByPeerId(element.id);\r\n        const state = getGroupCallParticipantMutedState(participant);\r\n\r\n        element.mutedIcon.setState(state);\r\n        element.status.setState(state, participant);\r\n      },\r\n      onSort: (element, idx) => {\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n      },\r\n      onElementCreate: (base) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: base.id,\r\n          container: false,\r\n          avatarSize: this.avatarSize,\r\n          autonomous: this.autonomous,\r\n          meAsSaved: false,\r\n          rippleEnabled: this.rippleEnabled,\r\n          lazyLoadQueue: this.lazyLoadQueue\r\n        });\r\n\r\n        const className = 'group-call-participant';\r\n        dom.listEl.classList.add(className);\r\n\r\n        const mutedIcon = new GroupCallParticipantMutedIcon(true);\r\n        const status = new GroupCallParticipantStatusElement(['presentation', 'video']);\r\n        replaceContent(dom.lastMessageSpan, status.container);\r\n        dom.listEl.append(mutedIcon.container);\r\n        (base as SortedParticipant).mutedIcon = mutedIcon;\r\n        (base as SortedParticipant).status = status;\r\n\r\n        /* instance.getParticipantByPeerId(base.id).then((participant) => {\r\n          const mutedState = getGroupCallParticipantMutedState(participant);\r\n\r\n          mutedIcon.setState(mutedState);\r\n          status.setState(mutedState, participant);\r\n        }); */\r\n        \r\n        (base as SortedParticipant).dom = dom;\r\n\r\n        return base as SortedParticipant;\r\n      },\r\n      updateElementWith: fastRaf\r\n    });\r\n\r\n    this.list = appDialogsManager.createChatList(this.createChatListOptions);\r\n  }\r\n\r\n  public destroy() {\r\n    this.elements.forEach((element) => {\r\n      this.onElementDestroy(element);\r\n    });\r\n  }\r\n\r\n  protected onElementDestroy(element: SortedParticipant) {\r\n    element.mutedIcon.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport EventListenerBase from \"../eventListenerBase\";\r\nimport ListenerSetter from \"../listenerSetter\";\r\nimport safeAssign from \"../object/safeAssign\";\r\nimport findUpClassName from \"./findUpClassName\";\r\n\r\nexport default class ControlsHover extends EventListenerBase<{\r\n  toggleControls: (show: boolean) => void\r\n}> {\r\n  protected hideControlsTimeout: number;\r\n  protected controlsLocked: boolean;\r\n\r\n  protected canHideControls: () => boolean;\r\n  protected element: HTMLElement;\r\n  protected listenerSetter: ListenerSetter;\r\n  protected showOnLeaveToClassName: string;\r\n  protected ignoreClickClassName: string;\r\n\r\n  constructor() {\r\n    super(false);\r\n    this.hideControlsTimeout = 0;\r\n  }\r\n  \r\n  public setup(options: {\r\n    element: HTMLElement, \r\n    listenerSetter: ListenerSetter, \r\n    canHideControls?: () => boolean,\r\n    showOnLeaveToClassName?: string,\r\n    ignoreClickClassName?: string\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const {listenerSetter, element} = this;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      listenerSetter.add(element)('click', (e) => {\r\n        if(this.ignoreClickClassName && findUpClassName(e.target, this.ignoreClickClassName)) {\r\n          return;\r\n        }\r\n\r\n        this.toggleControls();\r\n      });\r\n\r\n      /* listenerSetter.add(player)('touchstart', () => {\r\n        showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(player)('touchend', () => {\r\n        if(player.classList.contains('is-playing')) {\r\n          showControls();\r\n        }\r\n      }); */\r\n    } else {\r\n      listenerSetter.add(element)('mousemove', () => {\r\n        this.showControls();\r\n      });\r\n\r\n      listenerSetter.add(element)('mouseenter', () => {\r\n        this.showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(element)('mouseleave', (e) => {\r\n        if(e.relatedTarget && this.showOnLeaveToClassName && findUpClassName(e.relatedTarget, this.showOnLeaveToClassName)) {\r\n          this.showControls(false);\r\n          return;\r\n        }\r\n        \r\n        this.hideControls();\r\n      });\r\n    }\r\n  }\r\n\r\n  public hideControls = (setHideTimeout = false) => {\r\n    if(setHideTimeout) {\r\n      if(!this.hideControlsTimeout) {\r\n        this.hideControlsTimeout = window.setTimeout(this.hideControls, 3e3);\r\n      }\r\n\r\n      return;\r\n    }\r\n    \r\n    clearTimeout(this.hideControlsTimeout);\r\n    this.hideControlsTimeout = 0;\r\n\r\n    const isShown = this.element.classList.contains('show-controls');\r\n    if(this.controlsLocked !== false) {\r\n      if((this.canHideControls ? !this.canHideControls() : false) || !isShown || this.controlsLocked) {\r\n        return;\r\n      }\r\n    } else if(!isShown) {\r\n      return;\r\n    }\r\n    \r\n    this.dispatchEvent('toggleControls', false);\r\n    this.element.classList.remove('show-controls');\r\n  };\r\n  \r\n  public showControls = (setHideTimeout = true) => {\r\n    if(this.hideControlsTimeout) {\r\n      clearTimeout(this.hideControlsTimeout);\r\n      this.hideControlsTimeout = 0;\r\n    } else if(!this.element.classList.contains('show-controls') && this.controlsLocked !== false) {\r\n      this.dispatchEvent('toggleControls', true);\r\n      this.element.classList.add('show-controls');\r\n    }\r\n\r\n    if(!setHideTimeout || this.controlsLocked) {\r\n      return;\r\n    }\r\n\r\n    this.hideControlsTimeout = window.setTimeout(this.hideControls, 3e3);\r\n  };\r\n\r\n  public toggleControls = (show?: boolean) => {\r\n    const isShown = this.element.classList.contains('show-controls');\r\n\r\n    if(show === undefined) {\r\n      if(isShown) this.hideControls();\r\n      else this.showControls();\r\n    } else if(show === isShown) return;\r\n    else if(show === false) this.hideControls();\r\n    else this.showControls();\r\n  };\r\n\r\n  public lockControls(visible: boolean) {\r\n    this.controlsLocked = visible;\r\n\r\n    this.element.classList.toggle('disable-hover', visible === false);\r\n    this.toggleControls(visible);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../../helpers/animation\";\r\n\r\nexport default function callVideoCanvasBlur(video: HTMLVideoElement) {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.classList.add('call-video-blur');\r\n  const size = 16;\r\n  canvas.width = size;\r\n  canvas.height = size;\r\n\r\n  const ctx = canvas.getContext('2d');\r\n  ctx.filter = 'blur(2px)';\r\n  const renderFrame = () => {\r\n    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, canvas.width, canvas.height);\r\n  };\r\n\r\n  animate(() => {\r\n    renderFrame();\r\n    return canvas.isConnected;\r\n  });\r\n\r\n  renderFrame();\r\n\r\n  return canvas;\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport type { GroupCallOutputSource } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { getGroupCallParticipantMutedState } from \".\";\r\nimport GroupCallParticipantMutedIcon from \"./participantMutedIcon\";\r\nimport GroupCallParticipantStatusElement from \"./participantStatus\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport callVideoCanvasBlur from \"../call/videoCanvasBlur\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nconst className = 'group-call-participant-video';\r\n\r\nexport type GroupCallParticipantVideoType = 'video' | 'presentation';\r\nexport default class GroupCallParticipantVideoElement {\r\n  public container: HTMLElement;\r\n  private peerTitle: PeerTitle;\r\n  private subtitle: HTMLElement;\r\n  private info: HTMLElement;\r\n  private left: HTMLElement;\r\n  private right: HTMLElement;\r\n  private header: HTMLElement;\r\n  private groupCallParticipantMutedIcon: GroupCallParticipantMutedIcon;\r\n  private groupCallParticipantStatus: GroupCallParticipantStatusElement;\r\n\r\n  constructor(private managers: AppManagers, private instance: GroupCallInstance, public source: GroupCallOutputSource) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n\r\n    this.info = document.createElement('div');\r\n    this.info.classList.add(className + '-info');\r\n\r\n    this.left = document.createElement('div');\r\n    this.left.classList.add(className + '-info-left');\r\n\r\n    this.right = document.createElement('div');\r\n    this.right.classList.add(className + '-info-right');\r\n\r\n    this.info.append(this.left, this.right);\r\n    \r\n    this.container.append(this.info);\r\n  }\r\n\r\n  public setPinned(value: boolean) {\r\n    if(!value) {\r\n      if(this.header) {\r\n        this.header.remove();\r\n        this.header = undefined;\r\n      }\r\n\r\n      return;\r\n    } else if(this.header) {\r\n      return;\r\n    }\r\n    \r\n    // if(!this.header) {\r\n      this.header = document.createElement('div');\r\n      this.header.classList.add(className + '-header');\r\n  \r\n      const icon = document.createElement('i');\r\n      icon.classList.add('group-call-pin-icon', 'tgico-pin');\r\n      this.header.append(icon);\r\n  \r\n      this.container.append(this.header);\r\n    // }\r\n    \r\n    // this.container.classList.toggle('is-pinned', value);\r\n  }\r\n\r\n  public setParticipant(participant: GroupCallParticipant, type: GroupCallParticipantVideoType, video: HTMLVideoElement) {\r\n    let peerTitleElement: HTMLElement;\r\n    if(participant.pFlags.self) {\r\n      peerTitleElement = i18n('VoiceChat.Status.You');\r\n      peerTitleElement.classList.add('peer-title');\r\n    } else {\r\n      this.peerTitle = new PeerTitle({\r\n        peerId: getPeerId(participant.peer)\r\n      });\r\n\r\n      peerTitleElement = this.peerTitle.element;\r\n    }\r\n\r\n    this.groupCallParticipantMutedIcon = new GroupCallParticipantMutedIcon(false);\r\n    this.groupCallParticipantStatus = new GroupCallParticipantStatusElement([type]);\r\n\r\n    this.left.append(peerTitleElement, this.groupCallParticipantStatus.container);\r\n\r\n    this.right.append(this.groupCallParticipantMutedIcon.container);\r\n\r\n    video.classList.add(className, 'call-video');\r\n\r\n    if(video.paused) {\r\n      video.play();\r\n    }\r\n\r\n    const canvas = callVideoCanvasBlur(video);\r\n    canvas.classList.add(className + '-blur');\r\n    \r\n    this.container.prepend(canvas, video);\r\n\r\n    this.updateParticipant(participant);\r\n  }\r\n\r\n  public updateParticipant(participant: GroupCallParticipant) {\r\n    const state = getGroupCallParticipantMutedState(participant);\r\n\r\n    this.groupCallParticipantMutedIcon.setState(state);\r\n    this.groupCallParticipantStatus.setState(state, participant);\r\n  }\r\n\r\n  public destroy() {\r\n    this.groupCallParticipantMutedIcon.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ControlsHover from \"../../helpers/dom/controlsHover\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport { GroupCallOutputSource } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport GroupCallParticipantVideoElement, { GroupCallParticipantVideoType } from \"./participantVideo\";\r\n\r\nexport default class GroupCallParticipantsVideoElement extends ControlsHover {\r\n  private container: HTMLDivElement;\r\n  private instance: GroupCallInstance;\r\n  private participantsElements: Map<PeerId, Map<GroupCallParticipantVideoType, GroupCallParticipantVideoElement>>;\r\n  private displayPinned: boolean;\r\n  private containers: Map<HTMLElement, GroupCallParticipantVideoElement>;\r\n  private onLengthChange: (length: number) => void;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    instance: GroupCallInstance,\r\n    listenerSetter: ListenerSetter,\r\n    displayPinned: boolean,\r\n    onLengthChange?: GroupCallParticipantsVideoElement['onLengthChange'],\r\n    managers: AppManagers\r\n  }) {\r\n    super();\r\n    safeAssign(this, options);\r\n\r\n    const className = 'group-call-participants-video';\r\n    const container = this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n    \r\n    options.appendTo.append(container);\r\n\r\n    this.participantsElements = new Map();\r\n    this.containers = new Map();\r\n\r\n    const {listenerSetter} = this;\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        this.updateParticipant(participant);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(this.instance)('pinned', (source) => {\r\n      this.participantsElements.forEach((map) => {\r\n        map.forEach((element) => {\r\n          this.setElementDisplay(element, source);\r\n        });\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.container, (e) => {\r\n      const container = findUpClassName(e.target, 'group-call-participant-video-container');\r\n      if(!container) {\r\n        return;\r\n      }\r\n\r\n      const element = this.containers.get(container);\r\n      if(this.instance.pinnedSource === element.source) {\r\n        this.instance.unpinAll();\r\n        return;  \r\n      }\r\n      \r\n      this.instance.pinSource(element.source);\r\n    }, {listenerSetter});\r\n\r\n    this.setInstance(this.instance);\r\n\r\n    this.setup({\r\n      element: container,\r\n      listenerSetter: listenerSetter,\r\n      showOnLeaveToClassName: 'group-call-buttons'\r\n    });\r\n  }\r\n\r\n  private shouldDisplayElement(element: GroupCallParticipantVideoElement, pinnedSource: GroupCallOutputSource) {\r\n    return this.displayPinned ? !pinnedSource || element.source === pinnedSource : pinnedSource && element.source !== pinnedSource;\r\n  }\r\n\r\n  private setElementDisplay(element: GroupCallParticipantVideoElement, pinnedSource: GroupCallOutputSource) {\r\n    const shouldDisplay = this.shouldDisplayElement(element, pinnedSource);\r\n    element.container.classList.toggle('video-hidden', !shouldDisplay);\r\n\r\n    const isPinned = element.source === pinnedSource;\r\n    element.setPinned(isPinned);\r\n  }\r\n\r\n  private updateParticipant(participant: GroupCallParticipant) {\r\n    const peerId = getPeerId(participant.peer);\r\n    const types: GroupCallParticipantVideoType[] = ['video', 'presentation'];\r\n    const hasAnyVideo = types.some((type) => !!participant[type]);\r\n    let participantElements = this.participantsElements.get(peerId);\r\n    if(!hasAnyVideo && !participantElements) {\r\n      return;\r\n    }\r\n\r\n    if(!participantElements) {\r\n      this.participantsElements.set(peerId, participantElements = new Map());\r\n    }\r\n\r\n    types.forEach((type) => {\r\n      let element = participantElements.get(type);\r\n      const participantVideo = participant[type];\r\n      if(!!participantVideo === !!element) {\r\n        if(element) {\r\n          element.updateParticipant(participant);\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      if(participantVideo) {\r\n        const result = this.instance.getVideoElementFromParticipantByType(participant, type);\r\n        if(!result) {\r\n          return;\r\n        }\r\n\r\n        const {video, source} = result;\r\n\r\n        element = new GroupCallParticipantVideoElement(this.managers, this.instance, source);\r\n\r\n        this.containers.set(element.container, element);\r\n\r\n        this.setElementDisplay(element, this.instance.pinnedSource);\r\n        participantElements.set(type, element);\r\n        element.setParticipant(participant, type, video);\r\n    \r\n        this.container.prepend(element.container);\r\n      } else {\r\n        participantElements.delete(type);\r\n        element.container.remove();\r\n        \r\n        if(!participantElements.size) {\r\n          this.participantsElements.delete(peerId);\r\n          this.containers.delete(element.container);\r\n          element.destroy();\r\n        }\r\n      }\r\n\r\n      this._onLengthChange();\r\n    });\r\n  }\r\n\r\n  private _onLengthChange() {\r\n    const length = this.container.childElementCount;\r\n    this.container.dataset.length = '' + length;\r\n    this.container.dataset.layout = length <= 2 ? '1' : (length === 3 ? '3' : '4');\r\n\r\n    this.onLengthChange && this.onLengthChange(length);\r\n  }\r\n\r\n  public async setInstance(instance: GroupCallInstance) {\r\n    (await instance.participants).forEach((participant) => {\r\n      this.updateParticipant(participant);\r\n    });\r\n  }\r\n\r\n  public destroy() {\r\n    this.containers.forEach((element) => {\r\n      element.destroy();\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupGroupCall from \".\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport { addFullScreenListener, isFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport noop from \"../../helpers/noop\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport positionMenu from \"../../helpers/positionMenu\";\r\nimport ScrollableLoader from \"../../helpers/scrollableLoader\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport type { AppChatsManager } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppGroupCallsManager } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport type { AppPeersManager } from \"../../lib/appManagers/appPeersManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupElement from \"../popups\";\r\nimport Scrollable from \"../scrollable\";\r\nimport GroupCallParticipantsList from \"./participantsList\";\r\nimport GroupCallParticipantsVideoElement from \"./participantVideos\";\r\n\r\nexport class GroupCallParticipantContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify: (peerId: PeerId) => boolean | Promise<boolean>})[];\r\n  private element: HTMLDivElement;\r\n  private chatId: ChatId;\r\n  private targetPeerId: PeerId;\r\n  private participant: GroupCallParticipant;\r\n  private instance: GroupCallInstance;\r\n  private canManageCall: boolean;\r\n  private managers: AppManagers;\r\n  \r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    onContextElement: HTMLElement,\r\n    managers: AppManagers,\r\n    instance: GroupCallInstance,\r\n  }) {\r\n    this.buttons = [{\r\n      icon: 'gc_microphoneoff',\r\n      text: 'VoiceChat.MutePeer',\r\n      verify: () => this.canManageCall && this.participant.pFlags.can_self_unmute,\r\n      onClick: () => this.toggleParticipantMuted(true)\r\n    }, {\r\n      icon: 'gc_microphone',\r\n      text: 'VoiceChat.UnmutePeer',\r\n      verify: () => this.canManageCall && !this.participant.pFlags.can_self_unmute,\r\n      onClick: () => this.toggleParticipantMuted(false)\r\n    }, {\r\n      icon: 'gc_microphoneoff',\r\n      text: 'VoiceChat.MuteForMe',\r\n      verify: () => !this.canManageCall && !this.participant.pFlags.muted_by_you,\r\n      onClick: () => this.toggleParticipantMuted(true)\r\n    }, {\r\n      icon: 'gc_microphone',\r\n      text: 'VoiceChat.UnmuteForMe',\r\n      verify: () => !this.canManageCall && this.participant.pFlags.muted_by_you,\r\n      onClick: () => this.toggleParticipantMuted(false)\r\n    }, {\r\n      icon: 'newprivate',\r\n      text: 'VoiceChat.OpenProfile',\r\n      verify: () => true,\r\n      onClick: this.onOpenProfileClick\r\n    }, {\r\n      icon: 'deleteuser danger',\r\n      text: 'VoiceChat.RemovePeer',\r\n      verify: () => this.managers.appChatsManager.hasRights(this.chatId, 'ban_users'),\r\n      onClick: async() => {\r\n        confirmationPopup({\r\n          peerId: this.targetPeerId,\r\n          title: new PeerTitle({peerId: this.targetPeerId}).element,\r\n          descriptionLangKey: await this.managers.appChatsManager.isBroadcast(this.chatId) ? 'VoiceChat.RemovePeer.Confirm.Channel' : 'VoiceChat.RemovePeer.Confirm',\r\n          descriptionLangArgs: [new PeerTitle({peerId: this.targetPeerId}).element],\r\n          button: {\r\n            langKey: 'VoiceChat.RemovePeer.Confirm.OK',\r\n            isDanger: true\r\n          }\r\n        }).then(() => {\r\n          this.managers.appChatsManager.kickFromChat(this.chatId, this.targetPeerId);\r\n        }, noop);\r\n      }\r\n    }];\r\n\r\n    const {listenerSetter} = options;\r\n    this.managers = options.managers;\r\n    this.instance = options.instance;\r\n    this.chatId = this.instance.chatId;\r\n  \r\n    this.element = ButtonMenu(this.buttons, listenerSetter);\r\n    this.element.classList.add('group-call-participant-menu', 'night');\r\n\r\n    attachContextMenuListener(options.onContextElement, async(e: any) => {\r\n      const li = findUpClassName(e.target, 'group-call-participant');\r\n      if(!li) {\r\n        return;\r\n      }\r\n\r\n      if(this.element.parentElement !== appendTo) {\r\n        appendTo.append(this.element);\r\n      }\r\n\r\n      cancelEvent(e);\r\n\r\n      const peerId = this.targetPeerId = li.dataset.peerId.toPeerId();\r\n      this.participant = await this.instance.getParticipantByPeerId(peerId);\r\n      if(this.participant.pFlags.self) {\r\n        return;\r\n      }\r\n\r\n      this.canManageCall = await this.managers.appChatsManager.hasRights(this.chatId, 'manage_call');\r\n\r\n      await filterAsync(this.buttons, async(button) => {\r\n        const good = await button.verify(peerId);\r\n        button.element.classList.toggle('hide', !good);\r\n        return good;\r\n      });\r\n      \r\n      positionMenu((e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent, this.element, 'right');\r\n      contextMenuController.openBtnMenu(this.element);\r\n    }, listenerSetter);\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        const peerId = getPeerId(participant.peer);\r\n        if(this.targetPeerId === peerId) {\r\n          contextMenuController.closeBtnMenu();\r\n        }\r\n      }\r\n    });\r\n\r\n    let appendTo: HTMLElement = document.body;\r\n    addFullScreenListener(document.body, () => {\r\n      const isFull = isFullScreen();\r\n      appendTo = isFull ? PopupElement.getPopups(PopupGroupCall)[0].getContainer(): document.body;\r\n\r\n      if(!isFull) {\r\n        contextMenuController.closeBtnMenu();\r\n      }\r\n    }, listenerSetter);\r\n  }\r\n\r\n  private onOpenProfileClick = () => {\r\n    const popup = PopupElement.getPopups(PopupGroupCall)[0];\r\n    if(popup) {\r\n      popup.hide();\r\n    }\r\n\r\n    appImManager.setInnerPeer({peerId: this.targetPeerId});\r\n  };\r\n\r\n  private toggleParticipantMuted = (muted: boolean) => {\r\n    this.instance.editParticipant(this.participant, {\r\n      muted\r\n    });\r\n  };\r\n};\r\n\r\nexport default class GroupCallParticipantsElement {\r\n  private container: HTMLDivElement;\r\n  private sortedList: GroupCallParticipantsList;\r\n  private instance: GroupCallInstance;\r\n  private listenerSetter: ListenerSetter;\r\n  private groupCallParticipantsVideo: GroupCallParticipantsVideoElement;\r\n  private contextMenu: GroupCallParticipantContextMenu;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    instance: GroupCallInstance,\r\n    listenerSetter: ListenerSetter,\r\n    managers: AppManagers\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const className = 'group-call-participants';\r\n\r\n    const scrollable = new Scrollable(undefined);\r\n    scrollable.container.classList.add(className + '-scrollable');\r\n\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className);\r\n\r\n    // const invite = Button(`btn-primary btn-transparent ${className}-invite`, {icon: 'adduser', text: 'VoiceChat.Invite.InviteMembers'});\r\n\r\n    const sortedList = this.sortedList = new GroupCallParticipantsList(this.instance);\r\n    \r\n    const {instance, listenerSetter} = this;\r\n    this.contextMenu = new GroupCallParticipantContextMenu({\r\n      ...options,\r\n      onContextElement: sortedList.list,\r\n      listenerSetter,\r\n      instance\r\n    });\r\n\r\n    this.groupCallParticipantsVideo = new GroupCallParticipantsVideoElement({\r\n      ...options,\r\n      appendTo: scrollable.container,\r\n      displayPinned: false\r\n    });\r\n\r\n    scrollable.append(/* invite,  */sortedList.list);\r\n    container.append(scrollable.container);\r\n\r\n    options.appendTo.append(container);\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        this.updateParticipant(participant);\r\n      }\r\n    });\r\n\r\n    const scrollableLoader = new ScrollableLoader({\r\n      scrollable,\r\n      getPromise: () => {\r\n        return this.managers.appGroupCallsManager.getGroupCallParticipants(this.instance.id).then(({participants, isEnd}) => {\r\n          participants.forEach((participant) => {\r\n            this.updateParticipant(participant);\r\n          });\r\n          \r\n          return isEnd;\r\n        });\r\n      }\r\n    });\r\n\r\n    this.setInstance(instance);\r\n  }\r\n\r\n  private updateParticipant(participant: GroupCallParticipant) {\r\n    const peerId = getPeerId(participant.peer);\r\n    const has = this.sortedList.has(peerId);\r\n    if(participant.pFlags.left) {\r\n      if(has) {\r\n        this.sortedList.delete(peerId);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!has) {\r\n      this.sortedList.add(peerId);\r\n      return;\r\n    }\r\n\r\n    this.sortedList.update(peerId);\r\n  }\r\n\r\n  public async setInstance(instance: GroupCallInstance) {\r\n    // @ts-ignore\r\n    /* const users = appUsersManager.users;\r\n    for(const userId in users) {\r\n      const participant: GroupCallParticipant = {\r\n        _: 'groupCallParticipant',\r\n        date: 0,\r\n        peer: {_: 'peerUser', user_id: userId.toPeerId()},\r\n        pFlags: {\r\n          muted: true\r\n        },\r\n        source: 1\r\n      };\r\n\r\n      instance.participants.set(userId.toPeerId(), participant);\r\n      this.updateParticipant(participant);\r\n    } */\r\n    const participants = await instance.participants;\r\n    participants.forEach((participant) => {\r\n      this.updateParticipant(participant);\r\n    });\r\n  }\r\n  \r\n  public destroy() {\r\n    this.sortedList.destroy();\r\n    this.groupCallParticipantsVideo.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCall } from \"../../layer\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport GROUP_CALL_STATE from \"../../lib/calls/groupCallState\";\r\nimport I18n, { LangPackKey, FormatterArguments } from \"../../lib/langPack\";\r\n\r\nexport default class GroupCallDescriptionElement {\r\n  private descriptionIntl: I18n.IntlElement;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.descriptionIntl = new I18n.IntlElement({\r\n      key: 'VoiceChat.Status.Connecting'\r\n    });\r\n\r\n    this.descriptionIntl.element.classList.add('group-call-description');\r\n  }\r\n\r\n  public detach() {\r\n    this.descriptionIntl.element.remove();\r\n  }\r\n\r\n  public update(instance: GroupCallInstance) {\r\n    const {state} = instance;\r\n\r\n    let key: LangPackKey, args: FormatterArguments;\r\n    if(state === GROUP_CALL_STATE.CONNECTING) {\r\n      key = 'VoiceChat.Status.Connecting';\r\n    } else {\r\n      key = 'VoiceChat.Status.Members';\r\n      args = [(instance.groupCall as GroupCall.groupCall).participants_count];\r\n    }\r\n\r\n    const {descriptionIntl} = this;\r\n    descriptionIntl.compareAndUpdate({\r\n      key,\r\n      args\r\n    });\r\n\r\n    if(!this.descriptionIntl.element.parentElement) {\r\n      this.appendTo.append(this.descriptionIntl.element);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { GroupCall } from \"../../layer\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default class GroupCallTitleElement {\r\n  private peerTitle: PeerTitle;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.peerTitle = new PeerTitle({peerId: 0});\r\n  }\r\n\r\n  public update(instance: GroupCallInstance) {\r\n    const {peerTitle, appendTo} = this;\r\n    const groupCall = instance.groupCall as GroupCall.groupCall;\r\n    const peerId = instance.chatId.toPeerId(true);\r\n    if(groupCall.title) {\r\n      setInnerHTML(appendTo, wrapEmojiText(groupCall.title));\r\n    } else {\r\n      if(peerTitle.peerId !== peerId) {\r\n        peerTitle.peerId = peerId;\r\n        peerTitle.update();\r\n      }\r\n\r\n      if(peerTitle.element.parentElement !== appendTo) {\r\n        appendTo.append(peerTitle.element);\r\n      }\r\n    } \r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport ripple from \"../ripple\";\r\n\r\nexport default function makeButton(className: string, listenerSetter: ListenerSetter, options: {\r\n  text?: LangPackKey | HTMLElement,\r\n  isDanger?: boolean,\r\n  noRipple?: boolean,\r\n  callback?: () => void,\r\n  icon?: string,\r\n  isConfirm?: boolean,\r\n}) {\r\n  const _className = className + '-button';\r\n  const buttonDiv = document.createElement('div');\r\n  buttonDiv.classList.add(_className, 'call-button', 'rp-overflow');\r\n\r\n  if(options.icon) {\r\n    buttonDiv.classList.add('tgico-' + options.icon);\r\n  }\r\n\r\n  if(!options.noRipple) {\r\n    ripple(buttonDiv);\r\n  }\r\n\r\n  if(options.isDanger) {\r\n    buttonDiv.classList.add(_className + '-red');\r\n  }\r\n\r\n  if(options.isConfirm) {\r\n    buttonDiv.classList.add(_className + '-green');\r\n  }\r\n\r\n  if(options.callback) {\r\n    attachClickEvent(buttonDiv, options.callback, {listenerSetter});\r\n  }\r\n\r\n  let ret = buttonDiv;\r\n  if(options.text) {\r\n    const div = document.createElement('div');\r\n    div.classList.add(_className + '-container', 'call-button-container');\r\n\r\n    const textEl = typeof(options.text) === 'string' ? i18n(options.text) : options.text;\r\n    textEl.classList.add(_className + '-text', 'call-button-text');\r\n\r\n    div.append(buttonDiv, textEl);\r\n\r\n    ret = div;\r\n  }\r\n\r\n  return ret;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\n\r\ntype ResizeSide = 'n' | 'e' | 's' | 'w' | 'ne' | 'se' | 'sw' | 'nw';\r\nexport type MovableState = {\r\n  top?: number;\r\n  left?: number;\r\n  width: number;\r\n  height: number;\r\n};\r\n\r\nconst className = 'movable-element';\r\nconst resizeHandlerClassName = className + '-resize-handler';\r\n\r\nexport type MovableElementOptions = {\r\n  minWidth: MovableElement['minWidth'],\r\n  minHeight: MovableElement['minHeight'],\r\n  element: MovableElement['element'],\r\n  verifyTouchTarget?: MovableElement['verifyTouchTarget']\r\n};\r\n\r\nexport default class MovableElement extends EventListenerBase<{\r\n  resize: () => void\r\n}> {\r\n  private minWidth: number;\r\n  private minHeight: number;\r\n  private element: HTMLElement;\r\n  private verifyTouchTarget: (e: TouchEvent | MouseEvent) => boolean;\r\n\r\n  private top: number;\r\n  private left: number;\r\n  private _width: number;\r\n  private _height: number;\r\n\r\n  private swipeHandler: SwipeHandler;\r\n  private handlers: HTMLElement[];\r\n\r\n  constructor(options: MovableElementOptions) {\r\n    super(true);\r\n    safeAssign(this, options);\r\n    \r\n    this.top = this.left = this.width = this.height = 0;\r\n    this.element.classList.add(className);\r\n  \r\n    this.addResizeHandlers();\r\n    this.setSwipeHandler();\r\n\r\n    mediaSizes.addEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private onResize = () => {\r\n    this.fixDimensions();\r\n    this.fixPosition();\r\n    this.setPosition();\r\n  };\r\n\r\n  public destroyElements() {\r\n    this.element.classList.remove(className);\r\n\r\n    if(this.handlers) {\r\n      this.handlers.forEach((handler) => {\r\n        handler.remove();\r\n      });\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    mediaSizes.removeEventListener('resize', this.onResize);\r\n    this.swipeHandler.removeListeners();\r\n  }\r\n\r\n  private addResizeHandlers() {\r\n    const sides: ResizeSide[] = ['n', 'e', 's', 'w', 'ne', 'se', 'sw', 'nw'];\r\n    this.handlers = sides.map((side) => {\r\n      const div = document.createElement('div');\r\n      div.dataset.side = side;\r\n      div.classList.add(resizeHandlerClassName, resizeHandlerClassName + '-side-' + side);\r\n      this.element.append(div);\r\n      return div;\r\n    });\r\n  }\r\n\r\n  private setSwipeHandler() {\r\n    let startTop: number, startLeft: number, startWidth: number, startHeight: number, resizingSide: ResizeSide;\r\n    const swipeHandler = this.swipeHandler = new SwipeHandler({\r\n      element: this.element,\r\n      onSwipe: (xDiff, yDiff, e) => {\r\n        xDiff *= -1; // to right will be positive\r\n        yDiff *= -1; // to bottom will be positive\r\n        // console.log(xDiff, yDiff, e);\r\n\r\n        if(resizingSide) {\r\n          if(resizingSide.includes('e') || resizingSide.includes('w')) {\r\n            const isEnlarging = resizingSide.includes('e') && xDiff > 0 || resizingSide.includes('w') && xDiff < 0;\r\n            const resizeDiff = Math.abs(xDiff) * (isEnlarging ? 1 : -1);\r\n\r\n            const maxPossible = resizingSide.includes('e') ? windowSize.width - startLeft : startWidth + startLeft;\r\n            this.width = Math.min(maxPossible, startWidth + resizeDiff);\r\n          }\r\n\r\n          if(resizingSide.includes('n') || resizingSide.includes('s')) {\r\n            const isEnlarging = resizingSide.includes('s') && yDiff > 0 || resizingSide.includes('n') && yDiff < 0;\r\n            const resizeDiff = Math.abs(yDiff) * (isEnlarging ? 1 : -1);\r\n\r\n            const maxPossible = resizingSide.includes('s') ? windowSize.height - startTop : startHeight + startTop;\r\n            this.height = Math.min(maxPossible, startHeight + resizeDiff);\r\n          }\r\n\r\n          this.fixDimensions();\r\n\r\n          if(resizingSide.includes('w')) {\r\n            this.left = Math.min(startLeft + startWidth - this.minWidth, startLeft + xDiff);\r\n          }\r\n\r\n          if(resizingSide.includes('n')) {\r\n            this.top = Math.min(startTop + startHeight - this.minHeight, startTop + yDiff);\r\n          }\r\n        } else {\r\n          this.top = startTop + yDiff;\r\n          this.left = startLeft + xDiff;\r\n        }\r\n\r\n        this.fixPosition();\r\n        this.setPosition();\r\n      },\r\n      verifyTouchTarget: (e) => {\r\n        const target = e.target;\r\n        if(this.verifyTouchTarget && !this.verifyTouchTarget(e)) {\r\n          return false;\r\n        }\r\n\r\n        const resizeHandler = findUpClassName(target, resizeHandlerClassName);\r\n        if(resizeHandler) {\r\n          resizingSide = resizeHandler.dataset.side as ResizeSide;\r\n          swipeHandler.setCursor('');\r\n        } else {\r\n          resizingSide = undefined;\r\n          swipeHandler.setCursor('grabbing');\r\n        }\r\n\r\n        return true;\r\n      },\r\n      onFirstSwipe: () => {\r\n        startTop = this.top;\r\n        startLeft = this.left;\r\n        startWidth = this.width;\r\n        startHeight = this.height;\r\n      }\r\n    });\r\n  }\r\n\r\n  public setPositionToCenter() {\r\n    this.top = (windowSize.height / 2) - (this.height / 2);\r\n    this.left = (windowSize.width / 2) - (this.width / 2);\r\n    this.setPosition();\r\n  }\r\n\r\n  private fixDimensions() {\r\n    this.width = clamp(this.width, this.minWidth, windowSize.width);\r\n    this.height = clamp(this.height, this.minHeight, windowSize.height);\r\n  }\r\n\r\n  private fixPosition() {\r\n    this.top = clamp(this.top, 0, windowSize.height - this.height);\r\n    this.left = clamp(this.left, 0, windowSize.width - this.width);\r\n  }\r\n\r\n  private setPosition() {\r\n    this.element.style.top = this.top + 'px';\r\n    this.element.style.left = this.left + 'px';\r\n    this.element.style.right = 'auto';\r\n    this.element.style.bottom = 'auto';\r\n    this.element.style.width = this.width + 'px';\r\n    this.element.style.height = this.height + 'px';\r\n\r\n    this.dispatchEvent('resize');\r\n  }\r\n\r\n  public get width() {\r\n    return this._width;\r\n  }\r\n\r\n  public get height() {\r\n    return this._height;\r\n  }\r\n\r\n  private set width(value: number) {\r\n    this._width = value;\r\n  }\r\n\r\n  private set height(value: number) {\r\n    this._height = value;\r\n  }\r\n\r\n  public get state(): MovableState {\r\n    const {top, left, width, height} = this;\r\n    return {\r\n      top,\r\n      left,\r\n      width,\r\n      height\r\n    };\r\n  }\r\n\r\n  public set state(state: MovableState) {\r\n    const {top, left, width, height} = state;\r\n    this.top = top;\r\n    this.left = left;\r\n    this.width = width;\r\n    this.height = height;\r\n    this.onResize();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MovableElement, { MovableElementOptions, MovableState } from \"../components/movableElement\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport ListenerSetter from \"./listenerSetter\";\r\nimport mediaSizes, { ScreenSize } from \"./mediaSizes\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport default class MovablePanel {\r\n  #movable: MovableElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private previousState: MovableState;\r\n  private onResize: () => void;\r\n  private movableOptions: MovableElementOptions;\r\n  \r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    previousState: MovableState,\r\n    onResize?: () => void,\r\n    movableOptions: MovableElementOptions\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.toggleMovable(!IS_TOUCH_SUPPORTED);\r\n\r\n    this.listenerSetter.add(mediaSizes)('changeScreen', (from, to) => {\r\n      if(to === ScreenSize.mobile || from === ScreenSize.mobile) {\r\n        this.toggleMovable(!IS_TOUCH_SUPPORTED);\r\n      }\r\n    });\r\n  }\r\n\r\n  public destroy() {\r\n    const movable = this.movable;\r\n    if(movable) {\r\n      movable.destroy();\r\n    }\r\n  }\r\n\r\n  public get movable() {\r\n    return this.#movable;\r\n  }\r\n\r\n  public get state() {\r\n    return this.movable ? this.movable.state : this.previousState;\r\n  }\r\n\r\n  public set state(state: MovableState) {\r\n    this.previousState = state;\r\n  }\r\n\r\n  private toggleMovable(enabled: boolean) {\r\n    let {movable} = this;\r\n    if(enabled) {\r\n      if(movable) {\r\n        return;\r\n      }\r\n\r\n      movable = this.#movable = new MovableElement(this.movableOptions);\r\n  \r\n      movable.state = this.previousState;\r\n      if(this.previousState.top === undefined) {\r\n        movable.setPositionToCenter();\r\n      }\r\n  \r\n      if(this.onResize) {\r\n        this.listenerSetter.add(movable)('resize', this.onResize);\r\n      }\r\n    } else {\r\n      if(!movable) {\r\n        return;\r\n      }\r\n\r\n      this.previousState = movable.state;\r\n      movable.destroyElements();\r\n      movable.destroy();\r\n      this.#movable = undefined;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function toggleClassName(className: string, elements: HTMLElement[], disable: boolean) {\r\n  elements.forEach((element) => {\r\n    element.classList.toggle(className, disable);\r\n  });\r\n\r\n  return () => toggleClassName(className, elements, !disable);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nenum CALL_STATE {\r\n  CONNECTED,\r\n  CONNECTING,\r\n  EXCHANGING_KEYS,\r\n  PENDING,\r\n  REQUESTING,\r\n  CLOSING,\r\n  CLOSED\r\n}\r\n\r\nexport default CALL_STATE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport toHHMMSS from \"../../helpers/string/toHHMMSS\";\r\nimport CALL_STATE from \"../../lib/calls/callState\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\n\r\nexport default class CallDescriptionElement {\r\n  private container: HTMLElement;\r\n  private state: CALL_STATE;\r\n  private interval: number;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('call-description');\r\n  }\r\n\r\n  public detach() {\r\n    if(this.interval !== undefined) {\r\n      clearInterval(this.interval);\r\n      this.interval = undefined;\r\n    }\r\n\r\n    this.container.remove();\r\n    this.state = undefined;\r\n  }\r\n\r\n  public update(instance: any) {\r\n    const {connectionState} = instance;\r\n\r\n    if(this.state === connectionState) {\r\n      return;\r\n    }\r\n\r\n    this.state = connectionState;\r\n\r\n    let element: HTMLElement;\r\n    if(connectionState === CALL_STATE.CONNECTED) {\r\n      element = document.createElement('span');\r\n      element.classList.add('call-description-duration');\r\n\r\n      const setTime = () => {\r\n        element.innerText = toHHMMSS(instance.duration, true);\r\n      };\r\n\r\n      this.interval = window.setInterval(setTime, 1000);\r\n      setTime();\r\n    } else {\r\n      let langPackKey: LangPackKey;\r\n      switch(connectionState) {\r\n        case CALL_STATE.PENDING:\r\n          langPackKey = instance.isOutgoing ? 'Call.StatusRinging' : 'Call.StatusCalling';\r\n          break;\r\n        case CALL_STATE.REQUESTING:\r\n          langPackKey = 'Call.StatusRequesting';\r\n          break;\r\n        case CALL_STATE.EXCHANGING_KEYS:\r\n          langPackKey = 'VoipExchangingKeys';\r\n          break;\r\n        case CALL_STATE.CLOSED:\r\n          langPackKey = instance.connectedAt !== undefined ? 'Call.StatusEnded' : 'Call.StatusFailed';\r\n          break;\r\n        default:\r\n          langPackKey = 'Call.StatusConnecting';\r\n          break;\r\n      }\r\n\r\n      element = i18n(langPackKey);\r\n      if(this.interval !== undefined) {\r\n        clearInterval(this.interval);\r\n        this.interval = undefined;\r\n      }\r\n    }\r\n\r\n    this.container.classList.toggle('has-duration', connectionState === CALL_STATE.CONNECTED);\r\n    replaceContent(this.container, element);\r\n\r\n    if(!this.container.parentElement) {\r\n      this.appendTo.append(this.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallMicrophoneIconMini extends SuperRLottieIcon<{\r\n  PartState: boolean,\r\n  ColorState: boolean,\r\n  Items: {\r\n    name: 'voice_mini'\r\n  }[]\r\n}> {\r\n  constructor(colored?: boolean, skipAnimation?: boolean) {\r\n    super({\r\n      width: 36,\r\n      height: 36,\r\n      getPart: (state) => {\r\n        return this.getItem().getPart(state ? 'unmute' : 'mute');\r\n      },\r\n      getColor: colored ? (state) => {\r\n        return state ? [255, 255, 255] : [158, 158, 158];\r\n      } : undefined,\r\n      skipAnimation\r\n    });\r\n\r\n    this.add({\r\n      name: 'voice_mini',\r\n      parts: [{\r\n        startFrame: 0,\r\n        endFrame: 35,\r\n        name: 'hand-to-muted'\r\n      }, {\r\n        startFrame: 36,\r\n        endFrame: 68,\r\n        name: 'unmute'\r\n      }, {\r\n        startFrame: 69,\r\n        endFrame: 98,\r\n        name: 'mute'\r\n      }, {\r\n        startFrame: 99,\r\n        endFrame: 135,\r\n        name: 'muted-to-hand'\r\n      }, {\r\n        startFrame: 136,\r\n        endFrame: 171,\r\n        name: 'unmuted-to-hand'\r\n      }]\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_SCREEN_SHARING_SUPPORTED from \"../../environment/screenSharingSupport\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ControlsHover from \"../../helpers/dom/controlsHover\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport MovablePanel from \"../../helpers/movablePanel\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport toggleClassName from \"../../helpers/toggleClassName\";\r\nimport CallInstance from \"../../lib/calls/callInstance\";\r\nimport CALL_STATE from \"../../lib/calls/callState\";\r\nimport I18n, { i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport GroupCallMicrophoneIconMini from \"../groupCall/microphoneIconMini\";\r\nimport { MovableState } from \"../movableElement\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupElement from \"../popups\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport makeButton from \"./button\";\r\nimport CallDescriptionElement from \"./description\";\r\nimport callVideoCanvasBlur from \"./videoCanvasBlur\";\r\n\r\nconst className = 'call';\r\n\r\nconst MIN_WIDTH = 400;\r\nconst MIN_HEIGHT = 580;\r\n\r\nconst INIT_STATE: MovableState = {\r\n  width: MIN_WIDTH,\r\n  height: MIN_HEIGHT\r\n};\r\n\r\nlet previousState: MovableState = {...INIT_STATE};\r\n\r\nexport default class PopupCall extends PopupElement {\r\n  private peerId: PeerId;\r\n\r\n  private description: CallDescriptionElement;\r\n  private emojisSubtitle: HTMLElement;\r\n  \r\n  private partyStates: HTMLElement;\r\n  private partyMutedState: HTMLElement;\r\n\r\n  private firstButtonsRow: HTMLElement;\r\n  private secondButtonsRow: HTMLElement;\r\n\r\n  private declineI18nElement: I18n.IntlElement;\r\n\r\n  private makeButton: (options: Parameters<typeof makeButton>[2]) => HTMLElement;\r\n  private btnAccept: HTMLElement;\r\n  private btnDecline: HTMLElement;\r\n  private btnVideo: HTMLElement;\r\n  private btnScreen: HTMLElement;\r\n  private btnMute: HTMLElement;\r\n  private btnFullScreen: HTMLButtonElement;\r\n  private btnExitFullScreen: HTMLButtonElement;\r\n\r\n  private movablePanel: MovablePanel;\r\n  private microphoneIcon: GroupCallMicrophoneIconMini;\r\n  private muteI18nElement: I18n.IntlElement;\r\n\r\n  private videoContainers: {\r\n    input?: HTMLElement,\r\n    output?: HTMLElement\r\n  };\r\n\r\n  private controlsHover: ControlsHover;\r\n\r\n  constructor(private instance: CallInstance) {\r\n    super('popup-call', undefined, {\r\n      withoutOverlay: true,\r\n      closable: true\r\n    });\r\n\r\n    this.videoContainers = {};\r\n\r\n    const {container, listenerSetter} = this;\r\n    container.classList.add(className, 'night');\r\n\r\n    const avatarContainer = document.createElement('div');\r\n    avatarContainer.classList.add(className + '-avatar');\r\n\r\n    const peerId = this.peerId = this.instance.interlocutorUserId.toPeerId();\r\n    const avatar = new AvatarElement();\r\n    avatar.classList.add('avatar-full');\r\n    avatar.updateWithOptions({\r\n      isBig: true,\r\n      peerId: peerId\r\n    });\r\n    avatarContainer.append(avatar);\r\n\r\n    const title = new PeerTitle({\r\n      peerId\r\n    }).element;\r\n\r\n    title.classList.add(className + '-title');\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(className + '-subtitle');\r\n\r\n    const description = this.description = new CallDescriptionElement(subtitle);\r\n\r\n    const emojisSubtitle = this.emojisSubtitle = document.createElement('div');\r\n    emojisSubtitle.classList.add(className + '-emojis');\r\n\r\n    container.append(avatarContainer, title, subtitle);\r\n    \r\n    if(!IS_MOBILE) {\r\n      this.btnFullScreen = ButtonIcon('fullscreen');\r\n      this.btnExitFullScreen = ButtonIcon('smallscreen hide');\r\n      attachClickEvent(this.btnFullScreen, this.onFullScreenClick, {listenerSetter});\r\n      attachClickEvent(this.btnExitFullScreen, () => cancelFullScreen(), {listenerSetter});\r\n      addFullScreenListener(this.container, this.onFullScreenChange, listenerSetter);\r\n      this.header.prepend(this.btnExitFullScreen);\r\n      this.header.append(this.btnFullScreen);\r\n\r\n      container.append(emojisSubtitle);\r\n    } else {\r\n      this.header.append(emojisSubtitle);\r\n    }\r\n\r\n    this.partyStates = document.createElement('div');\r\n    this.partyStates.classList.add(className + '-party-states');\r\n\r\n    this.partyMutedState = document.createElement('div');\r\n    this.partyMutedState.classList.add(className + '-party-state');\r\n    const stateText = i18n('VoipUserMicrophoneIsOff', [new PeerTitle({peerId, onlyFirstName: true, limitSymbols: 18}).element]);\r\n    stateText.classList.add(className + '-party-state-text');\r\n    const mutedIcon = new GroupCallMicrophoneIconMini(false, true);\r\n    mutedIcon.setState(false, false);\r\n    this.partyMutedState.append(\r\n      mutedIcon.container, \r\n      stateText\r\n    );\r\n\r\n    this.partyStates.append(this.partyMutedState);\r\n    this.container.append(this.partyStates);\r\n\r\n    this.makeButton = makeButton.bind(null, className, this.listenerSetter);\r\n    this.constructFirstButtons();\r\n    this.constructSecondButtons();\r\n\r\n    listenerSetter.add(instance)('state', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    listenerSetter.add(instance)('mediaState', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    this.movablePanel = new MovablePanel({\r\n      listenerSetter,\r\n      movableOptions: {\r\n        minWidth: MIN_WIDTH,\r\n        minHeight: MIN_HEIGHT,\r\n        element: this.element,\r\n        verifyTouchTarget: (e) => {\r\n          const target = e.target;\r\n          if(findUpClassName(target, 'call-button') || \r\n            findUpClassName(target, 'btn-icon') ||\r\n            isFullScreen()) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      },\r\n      // onResize: () => this.toggleBigLayout(),\r\n      previousState: !this.instance.wasTryingToJoin && !this.instance.isOutgoing ? {...INIT_STATE} : previousState\r\n    });\r\n\r\n    const movableElement = this.movablePanel.movable;\r\n    if(movableElement) {\r\n      this.listenerSetter.add(movableElement)('resize', () => {\r\n        this.resizeVideoContainers();\r\n      });\r\n    }\r\n\r\n    const controlsHover = this.controlsHover = new ControlsHover();\r\n    controlsHover.setup({\r\n      element: this.container,\r\n      listenerSetter: this.listenerSetter,\r\n      showOnLeaveToClassName: 'call-buttons'\r\n    });\r\n    controlsHover.showControls(false);\r\n\r\n    this.addEventListener('close', () => {\r\n      const {movablePanel} = this;\r\n      previousState = movablePanel.state;\r\n\r\n      this.microphoneIcon.destroy();\r\n\r\n      movablePanel.destroy();\r\n    });\r\n\r\n    this.updateInstance();\r\n  }\r\n\r\n  public getCallInstance() {\r\n    return this.instance;\r\n  }\r\n\r\n  private constructFirstButtons() {\r\n    const buttons = this.firstButtonsRow = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons', 'is-first');\r\n\r\n    const toggleDisability = toggleClassName.bind(null, 'btn-disabled');\r\n    \r\n    const btnVideo = this.btnVideo = this.makeButton({\r\n      text: 'Call.Camera',\r\n      icon: 'videocamera_filled',\r\n      callback: () => {\r\n        const toggle = toggleDisability([btnVideo, btnScreen], true);\r\n        this.instance.toggleVideoSharing().finally(toggle);\r\n      }\r\n    });\r\n\r\n    const btnScreen = this.btnScreen = this.makeButton({\r\n      text: 'Call.Screen',\r\n      icon: 'sharescreen_filled',\r\n      callback: () => {\r\n        const toggle = toggleDisability([btnVideo, btnScreen], true);\r\n        this.instance.toggleScreenSharing().finally(toggle);\r\n      }\r\n    });\r\n\r\n    if(!IS_SCREEN_SHARING_SUPPORTED) {\r\n      btnScreen.classList.add('hide');\r\n      this.container.classList.add('no-screen');\r\n    }\r\n\r\n    this.muteI18nElement = new I18n.IntlElement({\r\n      key: 'Call.Mute'\r\n    });\r\n    const btnMute = this.btnMute = this.makeButton({\r\n      text: this.muteI18nElement.element,\r\n      callback: () => {\r\n        this.instance.toggleMuted();\r\n      }\r\n    });\r\n\r\n    const microphoneIcon = this.microphoneIcon = new GroupCallMicrophoneIconMini(true, true);\r\n    btnMute.firstElementChild.append(microphoneIcon.container);\r\n\r\n    // btnVideo.classList.add('disabled');\r\n    // btnScreen.classList.add('disabled');\r\n\r\n    buttons.append(btnVideo, btnScreen, btnMute);\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private constructSecondButtons() {\r\n    const buttons = this.secondButtonsRow = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons', 'is-second');\r\n    \r\n    this.declineI18nElement = new I18n.IntlElement({\r\n      key: 'Call.Decline'\r\n    });\r\n    const btnDecline = this.btnDecline = this.makeButton({\r\n      text: this.declineI18nElement.element,\r\n      icon: 'endcall_filled',\r\n      callback: () => {\r\n        this.instance.hangUp('phoneCallDiscardReasonHangup');\r\n      },\r\n      isDanger: true\r\n    });\r\n\r\n    const btnAccept = this.btnAccept = this.makeButton({\r\n      text: 'Call.Accept',\r\n      icon: 'phone_filled',\r\n      callback: () => {\r\n        this.instance.acceptCall();\r\n      },\r\n      isConfirm: true,\r\n    });\r\n\r\n    buttons.append(btnDecline, btnAccept);\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private onFullScreenClick = () => {\r\n    requestFullScreen(this.container);\r\n  };\r\n\r\n  private onFullScreenChange = () => {\r\n    const isFull = isFullScreen();\r\n\r\n    const {btnFullScreen, btnExitFullScreen} = this;\r\n\r\n    const wasFullScreen = this.container.classList.contains('is-full-screen');\r\n    this.container.classList.toggle('is-full-screen', isFull);\r\n    btnFullScreen && btnFullScreen.classList.toggle('hide', isFull);\r\n    btnExitFullScreen && btnExitFullScreen.classList.toggle('hide', !isFull);\r\n    this.btnClose.classList.toggle('hide', isFull);\r\n\r\n    if(isFull !== wasFullScreen) {\r\n      animationIntersector.checkAnimations(isFull);\r\n\r\n      themeController.setThemeColor(isFull ? '#000000' : undefined);\r\n\r\n      this.resizeVideoContainers();\r\n    }\r\n  };\r\n\r\n  private createVideoContainer(video: HTMLVideoElement) {\r\n    const _className = className + '-video';\r\n    const container = document.createElement('div');\r\n    container.classList.add(_className + '-container');\r\n\r\n    video.classList.add(_className);\r\n    if(video.paused) {\r\n      video.play();\r\n    }\r\n\r\n    attachClickEvent(container, () => {\r\n      if(!container.classList.contains('small')) {\r\n        return;\r\n      }\r\n\r\n      const big = Object.values(this.videoContainers).find((container) => !container.classList.contains('small'));\r\n      big.classList.add('small');\r\n      big.style.cssText = container.style.cssText;\r\n      container.classList.remove('small');\r\n      container.style.cssText = '';\r\n\r\n      this.resizeVideoContainers();\r\n    });\r\n\r\n    const canvas = callVideoCanvasBlur(video);\r\n    canvas.classList.add(_className + '-blur');\r\n\r\n    container.append(canvas, video);\r\n\r\n    return container;\r\n  }\r\n\r\n  private updateInstance() {\r\n    const {instance} = this;\r\n    const {connectionState} = instance;\r\n    if(connectionState === CALL_STATE.CLOSED) {\r\n      if(this.container.classList.contains('is-full-screen')) {\r\n        cancelFullScreen();\r\n      }\r\n\r\n      this.btnVideo.classList.add('disabled');\r\n\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    const isPendingIncoming = !instance.isOutgoing && connectionState === CALL_STATE.PENDING;\r\n    this.declineI18nElement.compareAndUpdate({\r\n      key: connectionState === CALL_STATE.PENDING ? 'Call.Decline' : 'Call.End'\r\n    });\r\n    this.btnAccept.classList.toggle('disable', !isPendingIncoming);\r\n    this.btnAccept.classList.toggle('hide-me', !isPendingIncoming);\r\n    this.container.classList.toggle('two-button-rows', isPendingIncoming);\r\n\r\n    const isMuted = instance.isMuted;\r\n    const onFrame = () => {\r\n      this.btnMute.firstElementChild.classList.toggle('active', isMuted);\r\n    };\r\n\r\n    const player = this.microphoneIcon.getItem().player;\r\n    this.microphoneIcon.setState(!isMuted, !isMuted, onFrame);\r\n    if(!player) {\r\n      onFrame();\r\n    }\r\n\r\n    this.muteI18nElement.compareAndUpdate({\r\n      key: isMuted ? 'VoipUnmute' : 'Call.Mute'\r\n    });\r\n\r\n    const isSharingVideo = instance.isSharingVideo;\r\n    this.btnVideo.firstElementChild.classList.toggle('active', isSharingVideo);\r\n\r\n    const isSharingScreen = instance.isSharingScreen;\r\n    this.btnScreen.firstElementChild.classList.toggle('active', isSharingScreen);\r\n\r\n    const outputState = instance.getMediaState('output');\r\n\r\n    SetTransition(this.partyMutedState, 'is-visible', !!outputState?.muted, 300);\r\n\r\n    const containers = this.videoContainers;\r\n    const oldContainers = {...containers};\r\n    ['input' as const, 'output' as const].forEach((type) => {\r\n      const mediaState = instance.getMediaState(type);\r\n      const video = instance.getVideoElement(type) as HTMLVideoElement;\r\n\r\n      const hasFrame = !!(video && video.videoWidth && video.videoHeight);\r\n      if(video && !hasFrame && !video.dataset.hasPromise) {\r\n        video.dataset.hasPromise = '1';\r\n        // container.classList.add('hide');\r\n        onMediaLoad(video).then(() => {\r\n          delete video.dataset.hasPromise;\r\n          this.updateInstance();\r\n          // this.resizeVideoContainers();\r\n          // container.classList.remove('hide');\r\n        });\r\n      }\r\n\r\n      const isActive = !!video && hasFrame && !!(mediaState && (mediaState.videoState === 'active' || mediaState.screencastState === 'active'));\r\n      let videoContainer = containers[type];\r\n\r\n      if(isActive && video && !videoContainer) {\r\n        videoContainer = containers[type] = this.createVideoContainer(video);\r\n        this.container.append(videoContainer);\r\n      }\r\n\r\n      if(!isActive && videoContainer) {\r\n        videoContainer.remove();\r\n        delete containers[type];\r\n      }\r\n    });\r\n\r\n    {\r\n      const input = containers.input;\r\n      const output = containers.output;\r\n      if(Object.keys(oldContainers).length !== Object.keys(containers).length && input) {\r\n        input.classList.toggle('small', !!output);\r\n      }\r\n\r\n      if(output && !input) {\r\n        output.classList.remove('small');\r\n      }\r\n    }\r\n\r\n    this.resizeVideoContainers();\r\n\r\n    this.container.classList.toggle('no-video', !Object.keys(containers).length);\r\n\r\n    if(!this.emojisSubtitle.textContent && connectionState < CALL_STATE.EXCHANGING_KEYS) {\r\n      Promise.resolve(instance.getEmojisFingerprint()).then((emojis) => {\r\n        this.emojisSubtitle.append(wrapEmojiText(emojis.join('')));\r\n      });\r\n    }\r\n\r\n    this.setDescription();\r\n  }\r\n\r\n  private resizeVideoContainers() {\r\n    Object.values(this.videoContainers).forEach((container) => {\r\n      const isSmall = container.classList.contains('small');\r\n      if(isSmall) {\r\n        const video = container.querySelector('video');\r\n        const popupWidth = this.movablePanel.state;\r\n        const MAX_WIDTH_PX = 240;\r\n        const MAX_HEIGHT_PX = 240;\r\n        \r\n        const isVertical = video.videoHeight > video.videoWidth;\r\n        const MAX_SIZE = isVertical ? MAX_HEIGHT_PX : MAX_WIDTH_PX;\r\n\r\n        const biggestSideSize = 1 / 3 * (isFullScreen() ? 0xFFFF : (isVertical ? popupWidth.height : popupWidth.width));\r\n        const widthRatio = isVertical ? video.videoWidth / video.videoHeight : 1;\r\n        const heightRatio = isVertical ? 1 : video.videoHeight / video.videoWidth;\r\n        container.style.width = biggestSideSize * widthRatio + 'px';\r\n        container.style.height = biggestSideSize * heightRatio + 'px';\r\n        container.style.maxWidth = MAX_SIZE * widthRatio + 'px';\r\n        container.style.maxHeight = MAX_SIZE * heightRatio + 'px';\r\n      } else {\r\n        container.style.cssText = '';\r\n      }\r\n    });\r\n  }\r\n\r\n  private setDescription() {\r\n    this.description.update(this.instance);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \"../sdp\";\r\nimport { CallSignalingData, P2PVideoCodec } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function parseSignalingData(sdp: SDP) {\r\n  const info = parseMediaSectionInfo(sdp, sdp.media[0]);\r\n  \r\n  const data: CallSignalingData.initialSetup = {\r\n    '@type': 'InitialSetup',\r\n    fingerprints: [info.fingerprint],\r\n    ufrag: info.ufrag,\r\n    pwd: info.pwd,\r\n    audio: undefined,\r\n    video: undefined,\r\n    screencast: undefined\r\n  };\r\n  \r\n  const convertNumber = (number: number) => '' + number;\r\n  \r\n  for(const section of sdp.media) {\r\n    const mediaType = section.mediaType;\r\n    if(mediaType === 'application' || !section.isSending) {\r\n      continue;\r\n    }\r\n    \r\n    const codec: P2PVideoCodec = data[mediaType === 'video' && data['video'] ? 'screencast' : mediaType] = {} as any;\r\n    const info = parseMediaSectionInfo(sdp, section);\r\n    codec.ssrc = convertNumber(info.source);\r\n    \r\n    if(info.sourceGroups) {\r\n      codec.ssrcGroups = info.sourceGroups.map((sourceGroup) => ({semantics: sourceGroup.semantics, ssrcs: sourceGroup.sources.map(convertNumber)}));\r\n    }\r\n    \r\n    const rtpExtensions: P2PVideoCodec['rtpExtensions'] = codec.rtpExtensions = [];\r\n    section.attributes.get('extmap').forEach((attribute) => {\r\n      rtpExtensions.push({\r\n        id: +attribute.key,\r\n        uri: attribute.value\r\n      });\r\n    });\r\n    \r\n    const payloadTypesMap: Map<number, P2PVideoCodec['payloadTypes'][0]> = new Map();\r\n    \r\n    const getPayloadType = (id: number) => {\r\n      let payloadType = payloadTypesMap.get(id);\r\n      if(!payloadType) {\r\n        payloadTypesMap.set(id, payloadType = {\r\n          id\r\n        } as any);\r\n      }\r\n      \r\n      return payloadType;\r\n    };\r\n    \r\n    section.attributes.get('rtpmap').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      const splitted = attribute.value.split('/');\r\n      const [name, clockrate, channels] = splitted;\r\n      payloadType.name = name;\r\n      payloadType.clockrate = +clockrate;\r\n      payloadType.channels = channels ? +channels : 0;\r\n    });\r\n    \r\n    section.attributes.get('rtcp-fb').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      payloadType.feedbackTypes = attribute.lines.map((line) => {\r\n        const splitted = line.split(' ');\r\n        const [type, subtype] = splitted;\r\n        return {\r\n          type,\r\n          subtype: subtype || ''\r\n        };\r\n      });\r\n    });\r\n    \r\n    section.attributes.get('fmtp').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      const parameters: P2PVideoCodec['payloadTypes'][0]['parameters'] = payloadType.parameters = {};\r\n      const splitted = attribute.value.split(';');\r\n      for(const str of splitted) {\r\n        const [key, value] = str.split('=');\r\n        parameters[key] = value;\r\n      }\r\n    });\r\n    \r\n    codec.payloadTypes = Array.from(payloadTypesMap.values());\r\n\r\n    /* if(codec.payloadTypes.length > 5) {\r\n      codec.payloadTypes.length = Math.min(codec.payloadTypes.length, 5);\r\n    } */\r\n  }\r\n  \r\n  return data;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport CallConnectionInstanceBase, { CallConnectionInstanceOptions } from \"./callConnectionInstanceBase\";\r\nimport CallInstance from \"./callInstance\";\r\nimport parseSignalingData from \"./helpers/parseSignalingData\";\r\nimport { parseSdp } from \"./sdp/utils\";\r\n\r\nexport default class CallConnectionInstance extends CallConnectionInstanceBase {\r\n  private call: CallInstance;\r\n\r\n  constructor(options: CallConnectionInstanceOptions & {\r\n    call: CallConnectionInstance['call']\r\n  }) {\r\n    super(options);\r\n  }\r\n\r\n  protected async negotiateInternal() {\r\n    const {connection, call} = this;\r\n\r\n    if(!connection.localDescription && !connection.remoteDescription && !call.isOutgoing) {\r\n      return;\r\n    }\r\n\r\n    let descriptionInit: RTCSessionDescriptionInit;\r\n    if(call.offerReceived) {\r\n      call.offerReceived = false;\r\n\r\n      const answer = descriptionInit = await connection.createAnswer();\r\n\r\n      this.log('[sdp] local', answer.type, answer.sdp);\r\n      await connection.setLocalDescription(answer);\r\n\r\n      this.log('[InitialSetup] send 2');\r\n    } else {\r\n      const offer = descriptionInit = await connection.createOffer();\r\n\r\n      this.log('[sdp] local', offer.sdp);\r\n      await connection.setLocalDescription(offer);\r\n\r\n      call.offerSent = true;\r\n\r\n      this.log('[InitialSetup] send 0');\r\n    }\r\n\r\n    const initialSetup = parseSignalingData(parseSdp(descriptionInit.sdp));\r\n    call.sendCallSignalingData(initialSetup);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\n\r\nexport type CallAudioAssetName = \"call_busy.mp3\" | \"call_connect.mp3\" | \"call_end.mp3\" | \"call_incoming.mp3\" | \"call_outgoing.mp3\" | \"voip_failed.mp3\" | \"voip_connecting.mp3\";\r\n\r\nlet audioAsset: AudioAssetPlayer<CallAudioAssetName>;\r\nexport default function getCallAudioAsset() {\r\n  return audioAsset ??= new AudioAssetPlayer([\r\n    'call_busy.mp3',\r\n    'call_connect.mp3',\r\n    'call_end.mp3',\r\n    'call_incoming.mp3',\r\n    'call_outgoing.mp3',\r\n    'voip_failed.mp3'\r\n  ]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getCallAudioAsset, { CallAudioAssetName } from \"../../components/call/getAudioAsset\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport insertInDescendSortedArray from \"../../helpers/array/insertInDescendSortedArray\";\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\nimport bytesCmp from \"../../helpers/bytes/bytesCmp\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { PhoneCallProtocol } from \"../../layer\";\r\nimport { CallId } from \"../appManagers/appCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallInstance from \"./callInstance\";\r\nimport CALL_STATE from \"./callState\";\r\n\r\nconst CALL_REQUEST_TIMEOUT = 45e3;\r\n\r\nexport class CallsController extends EventListenerBase<{\r\n  instance: (details: {hasCurrent: boolean, instance: CallInstance}) => void,\r\n  accepting: (instance: CallInstance) => void, // это костыль. используется при параллельном вызове, чтобы заменить звонок в topbarCall\r\n  incompatible: (userId: UserId) => void,\r\n}> {\r\n  private log: ReturnType<typeof logger>;\r\n  private managers: AppManagers;\r\n  private audioAsset: AudioAssetPlayer<CallAudioAssetName>;\r\n  private instances: Map<CallId, CallInstance>;\r\n  private sortedInstances: Array<CallInstance>;\r\n  private tempId: number;\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    this.log = logger('CC');\r\n\r\n    if(!IS_CALL_SUPPORTED) {\r\n      return;\r\n    }\r\n\r\n    this.audioAsset = getCallAudioAsset();\r\n    this.tempId = 0;\r\n    this.instances = new Map();\r\n    this.sortedInstances = [];\r\n\r\n    rootScope.addEventListener('call_update', async(call) => {\r\n      let instance = this.instances.get(call.id);\r\n\r\n      if(instance) {\r\n        instance.setPhoneCall(call);\r\n      }\r\n    \r\n      switch(call._) {\r\n        case 'phoneCallDiscarded': {\r\n          if(instance) {\r\n            instance.hangUp(call.reason?._, true);\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'phoneCallAccepted': {\r\n          if(instance) {\r\n            /* if(!this.verifyProtocolCompatibility(call.protocol)) {\r\n              instance.hangUp('phoneCallDiscardReasonDisconnect');\r\n              rootScope.dispatchEvent('call_incompatible', instance.interlocutorUserId);\r\n              break;\r\n            } */\r\n\r\n            instance.confirmCall();\r\n          }\r\n\r\n          break;\r\n        }\r\n        \r\n        case 'phoneCallRequested': {\r\n          if(!instance) {\r\n            /* if(!this.verifyProtocolCompatibility(call.protocol)) {\r\n              rootScope.dispatchEvent('call_incompatible', call.admin_id);\r\n              break;\r\n            } */\r\n\r\n            instance = this.createCallInstance({\r\n              isOutgoing: false,\r\n              interlocutorUserId: call.admin_id\r\n            });\r\n        \r\n            instance.overrideConnectionState(CALL_STATE.PENDING);\r\n            instance.setPhoneCall(call);\r\n            instance.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonMissed');\r\n          }\r\n          \r\n          break;\r\n        }\r\n\r\n        case 'phoneCall': {\r\n          if(!instance || instance.encryptionKey) {\r\n            break;\r\n          }\r\n\r\n          const g_a = instance.dh.g_a = call.g_a_or_b;\r\n          const dh = instance.dh;\r\n          const g_a_hash = await apiManagerProxy.invokeCrypto('sha256', g_a);\r\n          if(!bytesCmp(dh.g_a_hash, g_a_hash)) {\r\n            this.log.error('Incorrect g_a_hash', dh.g_a_hash, g_a_hash);\r\n            break;\r\n          }\r\n\r\n          const {key, key_fingerprint} = await this.managers.appCallsManager.computeKey(g_a, dh.b, dh.p);\r\n          if(call.key_fingerprint !== key_fingerprint) {\r\n            this.log.error('Incorrect key fingerprint', call.key_fingerprint, key_fingerprint);\r\n            break;\r\n          }\r\n\r\n          instance.encryptionKey = key;\r\n          instance.joinCall();\r\n\r\n          break;\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('call_signaling', ({callId, data}) => {\r\n      const instance = this.instances.get(callId);\r\n      if(instance?.id !== callId) {\r\n        return;\r\n      }\r\n      \r\n      instance.onUpdatePhoneCallSignalingData(data);\r\n    });\r\n  }\r\n\r\n  public get currentCall() {\r\n    return this.sortedInstances[0];\r\n  }\r\n\r\n  public getCallByUserId(userId: UserId) {\r\n    for(const [callId, instance] of this.instances) {\r\n      if(instance.interlocutorUserId === userId) {\r\n        return instance;\r\n      }\r\n    }\r\n  }\r\n\r\n  private createCallInstance(options: {\r\n    isOutgoing: boolean,\r\n    interlocutorUserId: UserId,\r\n    protocol?: PhoneCallProtocol\r\n  }) {\r\n    const call = new CallInstance({\r\n      managers: this.managers,\r\n      ...options,\r\n    });\r\n\r\n    call.addEventListener('state', (state) => {\r\n      const currentCall = this.currentCall;\r\n      if(state === CALL_STATE.CLOSED) {\r\n        this.instances.delete(call.id);\r\n        indexOfAndSplice(this.sortedInstances, call);\r\n      } else {\r\n        insertInDescendSortedArray(this.sortedInstances, call, 'sortIndex');\r\n      }\r\n\r\n      if(state === CALL_STATE.EXCHANGING_KEYS) {\r\n        call.wasTryingToJoin = true;\r\n      }\r\n\r\n      const hasConnected = call.connectedAt !== undefined;\r\n      if(state === CALL_STATE.EXCHANGING_KEYS || (state === CALL_STATE.CONNECTING && hasConnected)) {\r\n        call.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonDisconnect');\r\n      } else {\r\n        call.clearHangUpTimeout();\r\n      }\r\n\r\n      if(currentCall === call || !currentCall) {\r\n        if(state === CALL_STATE.CLOSED) {\r\n          if(!call.isOutgoing && !call.wasTryingToJoin) { // incoming call has been accepted on other device or ended\r\n            this.audioAsset.stopSound();\r\n          } else if(call.wasTryingToJoin && !hasConnected) { // something has happened during the key exchanging\r\n            this.audioAsset.playSound('voip_failed.mp3');\r\n          } else {\r\n            this.audioAsset.playSound(call.discardReason === 'phoneCallDiscardReasonBusy' ? 'call_busy.mp3' : 'call_end.mp3');\r\n          }\r\n        } else if(state === CALL_STATE.PENDING) {\r\n          this.audioAsset.playSound(call.isOutgoing ? 'call_outgoing.mp3' : 'call_incoming.mp3', true);\r\n        } else if(state === CALL_STATE.EXCHANGING_KEYS) {\r\n          this.audioAsset.playSoundIfDifferent('call_connect.mp3');\r\n        } else if(state === CALL_STATE.CONNECTING) {\r\n          if(call.duration) {\r\n            this.audioAsset.playSound('voip_connecting.mp3', true);\r\n          }\r\n        } else {\r\n          this.audioAsset.stopSound();\r\n        }\r\n      }\r\n    });\r\n\r\n    call.addEventListener('id', (id, prevId) => {\r\n      if(prevId !== undefined) {\r\n        this.instances.delete(prevId);\r\n      }\r\n\r\n      const hasCurrent = !!this.currentCall;\r\n      this.instances.set(id, call);\r\n\r\n      if(prevId === undefined) {\r\n        this.dispatchEvent('instance', {instance: call, hasCurrent: hasCurrent});\r\n      }\r\n    });\r\n\r\n    return call;\r\n  }\r\n\r\n  public async startCallInternal(userId: UserId, isVideo: boolean) {\r\n    this.log('p2pStartCallInternal', userId, isVideo);\r\n    \r\n    const fullInfo = await this.managers.appProfileManager.getProfile(userId);\r\n    if(!fullInfo) return;\r\n    \r\n    const {video_calls_available} = fullInfo.pFlags;\r\n    \r\n    const call = this.createCallInstance({\r\n      isOutgoing: true,\r\n      interlocutorUserId: userId\r\n    });\r\n\r\n    call.requestInputSource(true, !!(isVideo && video_calls_available), false);\r\n\r\n    call.overrideConnectionState(CALL_STATE.REQUESTING);\r\n    call.setPhoneCall({\r\n      _: 'phoneCallWaiting',\r\n      access_hash: '',\r\n      admin_id: NULL_PEER_ID,\r\n      date: tsNow(true),\r\n      id: --this.tempId,\r\n      participant_id: userId,\r\n      protocol: call.protocol,\r\n      pFlags: {\r\n        video: isVideo || undefined\r\n      }\r\n    });\r\n\r\n    // return;\r\n    this.managers.appCallsManager.generateDh().then(async(dh) => {\r\n      call.dh = dh;\r\n\r\n      return this.managers.appCallsManager.requestCall(userId, call.protocol, call.dh.g_a_hash, isVideo && video_calls_available);\r\n    }).then((phoneCall) => {\r\n      call.overrideConnectionState(CALL_STATE.PENDING);\r\n      call.setPhoneCall(phoneCall);\r\n      call.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonHangup');\r\n    });\r\n  }\r\n}\r\n\r\nconst callsController = new CallsController();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.callsController = callsController);\r\nexport default callsController;\r\n","const subtle = typeof(window) !== 'undefined' && 'crypto' in window ? window.crypto.subtle : self.crypto.subtle;\r\n\r\nexport default subtle;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport bufferConcats from '../../../helpers/bytes/bufferConcats';\r\nimport subtle from '../../crypto/subtle';\r\nimport sha256 from '../../crypto/utils/sha256';\r\n\r\nconst kMaxIncomingPacketSize = 128 * 1024 * 1024;\r\n\r\nexport default class P2PEncryptor {\r\n  private type: 'Signaling';\r\n  private counter: number;\r\n  private seqMap: Map<number, number>;\r\n  \r\n  constructor(private isOutgoing: boolean, private p2pKey: Uint8Array) {\r\n    this.type = 'Signaling';\r\n    this.counter = 0;\r\n    this.seqMap = new Map();\r\n  }\r\n  \r\n  private concatSHA256(parts: Uint8Array[]) {\r\n    return sha256(bufferConcats(...parts));\r\n  }\r\n  \r\n  private async encryptPrepared(buffer: Uint8Array) {\r\n    const result = {\r\n      counter: 0, //this.counterFromSeq(this.readSeq(buffer)),\r\n      bytes: new Uint8Array(16 + buffer.length)\r\n    };\r\n    \r\n    const x = (this.isOutgoing ? 0 : 8) + (this.type === 'Signaling' ? 128 : 0);\r\n    const key = this.p2pKey;\r\n    \r\n    const msgKeyLarge = await this.concatSHA256([key.subarray(x + 88, x + 88 + 32), buffer]);\r\n    const msgKey = result.bytes;\r\n    for(let i = 0; i < 16; ++i) {\r\n      msgKey[i] = msgKeyLarge[i + 8];\r\n    }\r\n    \r\n    const aesKeyIv = await this.prepareAesKeyIv(key, msgKey, x);\r\n    \r\n    const bytes = await this.aesProcessCtr(buffer, buffer.length, aesKeyIv, true);\r\n    \r\n    result.bytes = new Uint8Array([...result.bytes.subarray(0, 16), ...bytes]);\r\n    \r\n    return result;\r\n  }\r\n  \r\n  public encryptRawPacket(buffer: Uint8Array) {\r\n    const seq = ++this.counter;\r\n    const arr = new ArrayBuffer(4);\r\n    const view = new DataView(arr);\r\n    view.setUint32(0, seq >>> 0, false); // byteOffset = 0; litteEndian = false\r\n    \r\n    const result = new Uint8Array([...new Uint8Array(arr), ...buffer]);\r\n    \r\n    return this.encryptPrepared(result);\r\n  }\r\n  \r\n  private async prepareAesKeyIv(key: Uint8Array, msgKey: Uint8Array, x: number) {\r\n    const [sha256a, sha256b] = await Promise.all([\r\n      this.concatSHA256([\r\n        msgKey.subarray(0, 16),\r\n        key.subarray(x, x + 36)\r\n      ]),\r\n\r\n      this.concatSHA256([\r\n        key.subarray(40 + x, 40 + x + 36),\r\n        msgKey.subarray(0, 16)\r\n      ])\r\n    ]);\r\n    \r\n    return {\r\n      key: new Uint8Array([\r\n        ...sha256a.subarray(0, 8),\r\n        ...sha256b.subarray(8, 8 + 16),\r\n        ...sha256a.subarray(24, 24 + 8)\r\n      ]),\r\n      iv: new Uint8Array([\r\n        ...sha256b.subarray(0, 4),\r\n        ...sha256a.subarray(8, 8 + 8),\r\n        ...sha256b.subarray(24, 24 + 4)\r\n      ])\r\n    };\r\n  }\r\n  \r\n  private async aesProcessCtr(encryptedData: Uint8Array, dataSize: number, aesKeyIv: {key: Uint8Array, iv: Uint8Array}, encrypt = true) {\r\n    const cryptoKey = await subtle.importKey(\r\n      'raw',\r\n      aesKeyIv.key,\r\n      {name: 'AES-CTR'},\r\n      false,\r\n      [encrypt ? 'encrypt' : 'decrypt']\r\n    );\r\n    \r\n    const buffer: ArrayBuffer = await subtle[encrypt ? 'encrypt' : 'decrypt']({\r\n        name: 'AES-CTR',\r\n        counter: aesKeyIv.iv,\r\n        length: aesKeyIv.iv.length * 8\r\n      },\r\n      cryptoKey,\r\n      encryptedData\r\n    );\r\n\r\n    return new Uint8Array(buffer);\r\n  }\r\n  \r\n  private constTimeIsDifferent(a: Uint8Array, b: Uint8Array, count: number) {\r\n    let msgKeyEquals = true;\r\n    for(let i = 0; i < count; ++i) {\r\n      if(a[i] !== b[i]) {\r\n        msgKeyEquals = false;\r\n      }\r\n    }\r\n    \r\n    return !msgKeyEquals;\r\n  }\r\n  \r\n  public async decryptRawPacket(buffer: Uint8Array) {\r\n    if(buffer.length < 21 || buffer.length > kMaxIncomingPacketSize) {\r\n      return;\r\n    }\r\n    \r\n    const {isOutgoing, type} = this;\r\n    \r\n    const x = (isOutgoing ? 8 : 0) + (type === 'Signaling' ? 128 : 0);\r\n    const key = this.p2pKey;\r\n    \r\n    const msgKey = buffer.subarray(0, 16);\r\n    const encryptedData = buffer.subarray(16);\r\n    const encryptedDataSize = buffer.length - 16;\r\n    \r\n    const aesKeyIv = await this.prepareAesKeyIv(key, msgKey, x);\r\n    \r\n    const decryptionBuffer = await this.aesProcessCtr(encryptedData, encryptedDataSize, aesKeyIv, false);\r\n    \r\n    const msgKeyLarge = await this.concatSHA256([\r\n      key.subarray(88 + x, 88 + x + 32),\r\n      decryptionBuffer\r\n    ]);\r\n    \r\n    if(this.constTimeIsDifferent(msgKeyLarge.subarray(8), msgKey, 16)) {\r\n      return;\r\n    }\r\n    \r\n    const dataView = new DataView(decryptionBuffer.buffer);\r\n    const seq = dataView.getUint32(0);\r\n    if(this.seqMap.has(seq)) {\r\n      return;\r\n    }\r\n    this.seqMap.set(seq, seq);\r\n    \r\n    return decryptionBuffer.slice(4);\r\n  }\r\n}\r\n","import convertToUint8Array from \"../../../helpers/bytes/convertToUint8Array\";\r\nimport subtle from \"../subtle\";\r\n//import sha256 from '@cryptography/sha256';\r\n\r\nexport default function sha256(bytes: Parameters<typeof convertToUint8Array>[0]) {\r\n  return subtle.digest('SHA-256', convertToUint8Array(bytes)).then((b) => {\r\n    //console.log('legacy', performance.now() - perfS);\r\n    return new Uint8Array(b);\r\n  });\r\n  /* //console.log('SHA-256 hash start');\r\n\r\n  let perfS = performance.now();\r\n  \r\n\r\n  let perfD = performance.now();\r\n  let words = typeof(bytes) === 'string' ? bytes : bytesToWordss(bytes as any);\r\n  let hash = sha256(words);\r\n  console.log('darutkin', performance.now() - perfD);\r\n\r\n  //console.log('SHA-256 hash finish', hash, sha256(words, 'hex'));\r\n\r\n  return bytesFromWordss(hash); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport StringFromLineBuilder from '../stringFromLineBuilder';\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport default class ChromeP2PSdpBuilder {\r\n  static generateOffer(info: any) {\r\n    const {fingerprints, ufrag, pwd, audio, video} = info;\r\n    audio.type = 'audio';\r\n    video.type = 'video';\r\n    const media = [audio, video];\r\n\r\n    const stringBuilder = new StringFromLineBuilder();\r\n    stringBuilder.add(\r\n      'v=0', \r\n      'o=- 1 2 IN IP4 127.0.0.1',\r\n      's=-',\r\n      't=0 0'\r\n    );\r\n\r\n    if(fingerprints) {\r\n      fingerprints.forEach((x: any) => {\r\n        const {hash, fingerprint, setup} = x;\r\n        stringBuilder.add(\r\n          `a=fingerprint:${hash} ${fingerprint}`, \r\n          `a=setup:${setup}`\r\n        );\r\n      });\r\n    }\r\n    if(ufrag && pwd) {\r\n      stringBuilder.add(\r\n        `a=ice-ufrag:${ufrag}`,\r\n        `a=ice-pwd:${pwd}`\r\n      );\r\n    }\r\n\r\n    stringBuilder.add(\r\n      'a=group:BUNDLE 0 1 2', \r\n      'a=extmap-allow-mixed', \r\n      'a=msid-semantic: WMS *'\r\n    );\r\n    const streamName = 'stream' + media.map((x) => x.ssrc).join('_');\r\n    for(let i = 0; i < media.length; i++) {\r\n      const m = media[i];\r\n      const {type, ssrc, ssrcGroups, payloadTypes, rtpExtensions} = m;\r\n      switch(type) {\r\n        case 'audio': {\r\n          stringBuilder.add(\r\n            `m=audio 56930 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} audio${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n\r\n          break;\r\n        }\r\n\r\n        case 'video': {\r\n          stringBuilder.add(\r\n            `m=video 61986 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} video${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux', \r\n            'a=rtcp-rsize',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    stringBuilder.add(addDataChannel(2));\r\n    return stringBuilder.finalize();\r\n  }\r\n\r\n  static generateAnswer(info: any) {\r\n    const {fingerprints, ufrag, pwd, audio, video} = info;\r\n    audio.type = 'audio';\r\n    video.type = 'video';\r\n    const media = [audio, video];\r\n\r\n    const stringBuilder = new StringFromLineBuilder();\r\n    stringBuilder.add(\r\n      'v=0',\r\n      'o=- 1 2 IN IP4 127.0.0.1',\r\n      's=-',\r\n      't=0 0',\r\n    );\r\n\r\n    if(fingerprints) {\r\n      fingerprints.forEach((x: any) => {\r\n        const {hash, fingerprint, setup} = x;\r\n        stringBuilder.add(\r\n          `a=fingerprint:${hash} ${fingerprint}`,\r\n          `a=setup:${setup}`\r\n        );\r\n      });\r\n    }\r\n    if(ufrag && pwd) {\r\n      stringBuilder.add(\r\n        `a=ice-ufrag:${ufrag}`,\r\n        `a=ice-pwd:${pwd}`\r\n      );\r\n    }\r\n\r\n    stringBuilder.add(\r\n      'a=group:BUNDLE 0 1 2',\r\n      'a=extmap-allow-mixed',\r\n      'a=msid-semantic: WMS *'\r\n    );\r\n    const streamName = 'stream' + media.map((x) => x.ssrc).join('_');\r\n    for(let i = 0; i < media.length; i++) {\r\n      const m = media[i];\r\n      const {type, ssrc, ssrcGroups, payloadTypes, rtpExtensions} = m;\r\n      switch(type) {\r\n        case 'audio': {\r\n          stringBuilder.add(\r\n            `m=audio 56930 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} audio${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n\r\n        case 'video': {\r\n          stringBuilder.add(\r\n            `m=video 61986 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} video${ssrc}`);\r\n          }\r\n\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            'a=rtcp-rsize',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    stringBuilder.add(addDataChannel(2));\r\n    return stringBuilder.finalize();\r\n  }\r\n}\r\n","/*\r\n*  Copyright (c) 2018-present, Evgeny Nadymov\r\n*\r\n* This source code is licensed under the GPL v.3.0 license found in the\r\n* LICENSE file in the root directory of this source tree.\r\n*/\r\n\r\nimport ChromeP2PSdpBuilder from './chromeP2PSdpBuilder';\r\nimport { FirefoxP2PSdpBuilder } from './firefoxP2PSdpBuilder';\r\nimport { SafariP2PSdpBuilder } from './safariP2PSdpBuilder';\r\n// import { TG_CALLS_SDP_STRING } from '../../Stores/CallStore';\r\n\r\nexport function p2pParseCandidate(candidate) {\r\n  if(!candidate || !candidate.startsWith('candidate:')) {\r\n    return;\r\n  }\r\n  \r\n  const sdpString = candidate;\r\n  candidate = candidate.substr('candidate:'.length);\r\n  \r\n  const [foundation, component, protocol, priority, ip, port, ...other] = candidate.split(' ');\r\n  const c = {\r\n    sdpString,\r\n    foundation,\r\n    component,\r\n    protocol,\r\n    priority,\r\n    address: { ip, port }\r\n  };\r\n  \r\n  for(let i = 0; i < other.length; i += 2) {\r\n    switch(other[i]) {\r\n      case 'typ': {\r\n        c.type = other[i + 1];\r\n        break;\r\n      }\r\n      case 'raddr': {\r\n        if(!c.relAddress) {\r\n          c.relAddress = {};\r\n        }\r\n        \r\n        c.relAddress.ip = other[i + 1];\r\n        break;\r\n      }\r\n      case 'rport': {\r\n        if(!c.relAddress) {\r\n          c.relAddress = {};\r\n        }\r\n        \r\n        c.relAddress.port = other[i + 1];\r\n        break;\r\n      }\r\n      case 'generation': {\r\n        c.generation = other[i + 1];\r\n        break;\r\n      }\r\n      case 'tcptype': {\r\n        c.tcpType = other[i + 1];\r\n        break;\r\n      }\r\n      case 'network-id': {\r\n        c.networkId = other[i + 1];\r\n        break;\r\n      }\r\n      case 'network-cost': {\r\n        c.networkCost = other[i + 1];\r\n        break;\r\n      }\r\n      case 'ufrag': {\r\n        c.username = other[i + 1];\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return c;\r\n}\r\n\r\nexport function p2pParseSdp(sdp) {\r\n  const lines = sdp.split('\\r\\n');\r\n  const lookup = (prefix, force = true, lineFrom = 0, lineTo = Number.MAX_VALUE) => {\r\n    if (lineTo === -1) {\r\n      lineTo = Number.MAX_VALUE;\r\n    }\r\n    for (let i = lineFrom; i < lines.length && i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith(prefix)) {\r\n        return line.substr(prefix.length);\r\n      }\r\n    }\r\n    \r\n    if (force) {\r\n      console.error(\"Can't find prefix\", prefix);\r\n    }\r\n    \r\n    return null;\r\n  };\r\n  const findIndex = (prefix, lineFrom = 0, lineTo = Number.MAX_VALUE) => {\r\n    if (lineTo === -1) {\r\n      lineTo = Number.MAX_VALUE;\r\n    }\r\n    for (let i = lineFrom; i < lines.length && i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith(prefix)) {\r\n        return i;\r\n      }\r\n    }\r\n    \r\n    return -1;\r\n  };\r\n  \r\n  const pwdIndex = findIndex('a=ice-pwd:');\r\n  const ufragIndex = findIndex('a=ice-ufrag:');\r\n  if (pwdIndex === -1 && ufragIndex === -1) {\r\n    return {\r\n      // sessionId: lookup('o=').split(' ')[1],\r\n      ufrag: null,\r\n      pwd: null,\r\n      fingerprints: []\r\n    };\r\n  }\r\n  \r\n  const info = {\r\n    // sessionId: lookup('o=').split(' ')[1],\r\n    ufrag: null,\r\n    pwd: null,\r\n    fingerprints: []\r\n  };\r\n  \r\n  let mediaIndex = findIndex('m=');\r\n  const fingerprint = lookup('a=fingerprint:', false);\r\n  const setup = lookup('a=setup:', false);\r\n  if (fingerprint && setup) {\r\n    info.fingerprints.push({\r\n      hash: fingerprint.split(' ')[0],\r\n      fingerprint: fingerprint.split(' ')[1],\r\n      setup\r\n    });\r\n  }\r\n  \r\n  const ufrag = lookup('a=ice-ufrag:', false);\r\n  const pwd = lookup('a=ice-pwd:', false);\r\n  if (ufrag && pwd) {\r\n    info.ufrag = ufrag;\r\n    info.pwd = pwd;\r\n  }\r\n  \r\n  while (mediaIndex !== -1) {\r\n    let nextMediaIndex = findIndex('m=', mediaIndex + 1);\r\n    \r\n    const extmap = [];\r\n    const types = [];\r\n    const mediaType = lookup('m=', true, mediaIndex, nextMediaIndex).split(' ')[0];\r\n    const media = {\r\n      // type: lookup('m=', true, mediaIndex, nextMediaIndex).split(' ')[0],\r\n      // mid: lookup('a=mid:', true, mediaIndex, nextMediaIndex),\r\n      // dir: findDirection(mediaIndex, nextMediaIndex),\r\n      rtpExtensions: extmap,\r\n      payloadTypes: types\r\n    }\r\n    \r\n    const lineTo = nextMediaIndex === -1 ? lines.length : nextMediaIndex;\r\n    const fmtp = new Map();\r\n    const rtcpFb = new Map();\r\n    for (let i = mediaIndex; i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith('a=extmap:')) {\r\n        const [ id, uri ] = line.substr('a=extmap:'.length).split(' ');\r\n        extmap.push({ id: parseInt(id), uri });\r\n      } else if (line.startsWith('a=fmtp:')) {\r\n        const [ id, str ] = line.substr('a=fmtp:'.length).split(' ');\r\n        const obj = { };\r\n        const arr =  str.split(';').map(x => {\r\n          const [ key, value ] = x.split('=');\r\n          obj[key] = value;\r\n          return { [key]: value };\r\n        });\r\n        fmtp.set(parseInt(id), obj);\r\n      } else if (line.startsWith('a=rtcp-fb:')) {\r\n        const [ id, type = '', subtype = '' ] = line.substr('a=rtcp-fb:'.length).split(' ');\r\n        if (rtcpFb.has(parseInt(id))) {\r\n          rtcpFb.get(parseInt(id)).push({ type, subtype });\r\n        } else {\r\n          rtcpFb.set(parseInt(id), [{ type, subtype }])\r\n        }\r\n      } else if (line.startsWith('a=rtpmap')) {\r\n        const [ id, str ] = line.substr('a=rtpmap:'.length).split(' ');\r\n        const [ name, clockrate, channels = '0' ] = str.split('/');\r\n        const obj = { id: parseInt(id), name, clockrate: parseInt(clockrate), channels: parseInt(channels) };\r\n        \r\n        types.push(obj);\r\n      }\r\n    }\r\n    \r\n    for (let i = 0; i < types.length; i++) {\r\n      const { id } = types[i];\r\n      if (rtcpFb.has(id)) {\r\n        types[i].feedbackTypes = rtcpFb.get(id);\r\n      }\r\n      if (fmtp.has(id)) {\r\n        types[i].parameters = fmtp.get(id);\r\n      }\r\n    }\r\n    \r\n    const ssrc = lookup('a=ssrc:', false, mediaIndex, nextMediaIndex);\r\n    if (ssrc) {\r\n      media.ssrc = ssrc.split(' ')[0];\r\n    }\r\n    \r\n    const ssrcGroup = lookup('a=ssrc-group:', false, mediaIndex, nextMediaIndex);\r\n    if (ssrcGroup) {\r\n      const [ semantics, ...ssrcs ] = ssrcGroup.split(' ');\r\n      media.ssrcGroups = [{\r\n        semantics,\r\n        ssrcs\r\n      }]\r\n    }\r\n    \r\n    switch (mediaType) {\r\n      case 'audio': {\r\n        info.audio = media;\r\n        break;\r\n      }\r\n      case 'video': {\r\n        info.video = media;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    mediaIndex = nextMediaIndex;\r\n  }\r\n\r\n  if(!info.video.ssrcGroups) {\r\n    info.video.ssrcGroups = [];\r\n  }\r\n\r\n  info['@type'] = 'InitialSetup';\r\n  \r\n  // console.log('[p2pParseSdp]', sdp, info);\r\n  return info;\r\n}\r\n\r\nexport function isFirefox() {\r\n  return navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n}\r\n\r\nfunction isSafari() {\r\n  return navigator.userAgent.toLowerCase().indexOf('safari') > -1 && navigator.userAgent.toLowerCase().indexOf('chrome') === -1;\r\n}\r\n\r\nexport function addExtmap(extmap) {\r\n  let sdp = [];\r\n  // return sdp;\r\n  for (let j = 0; j < extmap.length; j++) {\r\n    const ext = extmap[j];\r\n    const { id, uri } = ext;\r\n    // if (isFirefox() && uri.indexOf(''))\r\n    console.log('[extmap] add', id, uri);\r\n    sdp.push(`a=extmap:${id} ${uri}`);\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addPayloadTypes(types) {\r\n  let sdp = [];\r\n  console.log('[SDP] addPayloadTypes', types);\r\n  for (let i = 0; i < types.length; i++) {\r\n    const type = types[i];\r\n    const { id, name, clockrate, channels, feedbackTypes, parameters } = type;\r\n    sdp.push(`a=rtpmap:${id} ${name}/${clockrate}${channels ? '/' + channels : ''}`);\r\n    if (feedbackTypes) {\r\n      feedbackTypes.forEach(x => {\r\n        const { type, subtype } = x;\r\n        sdp.push(`a=rtcp-fb:${id} ${[type, subtype].join(' ')}`);\r\n      });\r\n    }\r\n    if (parameters) {\r\n      const fmtp = [];\r\n      Object.getOwnPropertyNames(parameters).forEach(pName => {\r\n        fmtp.push(`${pName}=${parameters[pName]}`);\r\n      });\r\n      \r\n      sdp.push(`a=fmtp:${id} ${fmtp.join(';')}`);\r\n    }\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addSsrc(type, ssrc, ssrcGroups, streamName) {\r\n  let sdp = [];\r\n  \r\n  if (ssrcGroups && ssrcGroups.length > 0) {\r\n    ssrcGroups.forEach(ssrcGroup => {\r\n      if (ssrcGroup && ssrcGroup.ssrcs.length > 0) {\r\n        sdp.push(`a=ssrc-group:${ssrcGroup.semantics} ${ssrcGroup.ssrcs.join(' ')}`);\r\n        ssrcGroup.ssrcs.forEach(ssrc => {\r\n          sdp.push(\r\n            `a=ssrc:${ssrc} cname:stream${ssrc}`,\r\n            `a=ssrc:${ssrc} msid:${streamName} ${type}${ssrc}`,\r\n            `a=ssrc:${ssrc} mslabel:${type}${ssrc}`,\r\n            `a=ssrc:${ssrc} label:${type}${ssrc}`\r\n          );\r\n        });\r\n      }\r\n    });\r\n  } else if (ssrc) {\r\n    sdp.push(\r\n      `a=ssrc:${ssrc} cname:stream${ssrc}`,\r\n      `a=ssrc:${ssrc} msid:${streamName} ${type}${ssrc}`,\r\n      `a=ssrc:${ssrc} mslabel:${type}${ssrc}`,\r\n      `a=ssrc:${ssrc} label:${type}${ssrc}`\r\n    );\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addDataChannel(mid) {\r\n  return `m=application 9 UDP/DTLS/SCTP webrtc-datachannel\r\nc=IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:2\r\na=sctp-port:5000\r\na=max-message-size:262144`;\r\n}\r\n\r\nexport class P2PSdpBuilder {\r\n  static generateCandidate(info) {\r\n    if (!info) return null;\r\n    \r\n    const { sdpString, sdpMLineIndex, sdpMid, foundation, component, protocol, priority, address, type, relAddress, generation, tcpType, networkId, networkCost, username } = info;\r\n    if (/* TG_CALLS_SDP_STRING */true) {\r\n      if (sdpString) {\r\n        return {\r\n          candidate: sdpString,\r\n          sdpMLineIndex,\r\n          sdpMid\r\n        };\r\n      }\r\n    }\r\n    throw 'no sdpString';\r\n    \r\n    let candidate = `candidate:${foundation} ${component} ${protocol} ${priority} ${address.ip} ${address.port}`;\r\n    const attrs = []\r\n    if (type) {\r\n      attrs.push(`typ ${type}`);\r\n    }\r\n    if (relAddress) {\r\n      attrs.push(`raddr ${relAddress.ip}`);\r\n      attrs.push(`rport ${relAddress.port}`);\r\n    }\r\n    if (tcpType) {\r\n      attrs.push(`tcptype ${tcpType}`);\r\n    }\r\n    if (generation) {\r\n      attrs.push(`generation ${generation}`);\r\n    }\r\n    if (username) {\r\n      attrs.push(`ufrag ${username}`);\r\n    }\r\n    if (networkId) {\r\n      attrs.push(`network-id ${networkId}`);\r\n    }\r\n    if (networkCost) {\r\n      attrs.push(`network-cost ${networkCost}`);\r\n    }\r\n    if (attrs.length > 0) {\r\n      candidate += ` ${attrs.join(' ')}`;\r\n    }\r\n    \r\n    return { candidate, sdpMid, sdpMLineIndex };\r\n  }\r\n  \r\n  static generateOffer(info) {\r\n    if (isFirefox()) {\r\n      return FirefoxP2PSdpBuilder.generateOffer(info);\r\n    } else if (isSafari()) {\r\n      return SafariP2PSdpBuilder.generateOffer(info);\r\n    }\r\n    \r\n    return ChromeP2PSdpBuilder.generateOffer(info);\r\n  }\r\n  \r\n  static generateAnswer(info) {\r\n    if (isFirefox()) {\r\n      return FirefoxP2PSdpBuilder.generateAnswer(info);\r\n    } else if (isSafari()) {\r\n      return SafariP2PSdpBuilder.generateAnswer(info);\r\n    }\r\n    \r\n    return ChromeP2PSdpBuilder.generateAnswer(info);\r\n  }\r\n}","/*\r\n *  Copyright (c) 2018-present, Evgeny Nadymov\r\n *\r\n * This source code is licensed under the GPL v.3.0 license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\r\n\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport class FirefoxP2PSdpBuilder {\r\n    static generateOffer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        let sdp = `v=0\r\no=- 1 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=ice-options:trickle\r\na=msid-semantic:WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n\r\n    static generateAnswer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        let sdp = `v=0\r\no=- 1 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=ice-options:trickle\r\na=msid-semantic:WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, mid, ssrc, ssrcGroups, payloadTypes, dir, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n}","/*\r\n *  Copyright (c) 2018-present, Evgeny Nadymov\r\n *\r\n * This source code is licensed under the GPL v.3.0 license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\r\n\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport class SafariP2PSdpBuilder {\r\n    static generateOffer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        if (!media.length) {\r\n            return `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=msid-semantic: WMS\r\n`;\r\n        }\r\n\r\n        let sdp = `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} audio${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} video${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n\r\n    static generateAnswer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        if (!media.length) {\r\n            return `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=msid-semantic: WMS\r\n`;\r\n        }\r\n\r\n        let sdp = `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} audio${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} video${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ctx from \"../../environment/ctx\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { GroupCallParticipantVideoSourceGroup, PhoneCall, PhoneCallDiscardReason, PhoneCallProtocol, Update } from \"../../layer\";\r\nimport { emojiFromCodePoints } from \"../../vendor/emoji\";\r\nimport type { CallId } from \"../appManagers/appCallsManager\";\r\nimport type { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport CallConnectionInstance from \"./callConnectionInstance\";\r\nimport CallInstanceBase from \"./callInstanceBase\";\r\nimport callsController from \"./callsController\";\r\nimport CALL_STATE from \"./callState\";\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS } from \"./constants\";\r\nimport parseSignalingData from \"./helpers/parseSignalingData\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport localConferenceDescription, { ConferenceEntry, generateSsrc } from \"./localConferenceDescription\";\r\nimport getCallProtocol from \"./p2P/getCallProtocol\";\r\nimport getRtcConfiguration from \"./p2P/getRtcConfiguration\";\r\nimport P2PEncryptor from \"./p2P/p2PEncryptor\";\r\nimport { p2pParseCandidate, P2PSdpBuilder } from \"./p2P/p2PSdpBuilder\";\r\nimport { parseSdp } from \"./sdp/utils\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { AudioCodec, CallMediaState, CallSignalingData, DiffieHellmanInfo, P2PAudioCodec, P2PVideoCodec, VideoCodec } from \"./types\";\r\n\r\nexport default class CallInstance extends CallInstanceBase<{\r\n  state: (state: CALL_STATE) => void,\r\n  id: (id: CallId, prevId: CallId) => void,\r\n  muted: (muted: boolean) => void,\r\n  mediaState: (mediaState: CallMediaState) => void,\r\n  acceptCallOverride: () => Promise<boolean>,\r\n}> {\r\n  public dh: Partial<DiffieHellmanInfo.a & DiffieHellmanInfo.b>;\r\n  public id: CallId;\r\n  public call: PhoneCall;\r\n  public interlocutorUserId: UserId;\r\n  public protocol: PhoneCallProtocol;\r\n  public isOutgoing: boolean;\r\n  public encryptionKey: Uint8Array;\r\n  public connectionInstance: CallConnectionInstance;\r\n  public encryptor: P2PEncryptor;\r\n  public decryptor: P2PEncryptor;\r\n  public candidates: RTCIceCandidate[];\r\n\r\n  public offerReceived: boolean;\r\n  public offerSent: boolean;\r\n  \r\n  public createdParticipantEntries: boolean;\r\n  public release: () => Promise<void>;\r\n  public _connectionState: CALL_STATE;\r\n\r\n  public createdAt: number;\r\n  public connectedAt: number;\r\n  public discardReason: string;\r\n\r\n  private managers: AppManagers;\r\n  \r\n  private hangUpTimeout: number;\r\n\r\n  private mediaStates: {\r\n    input: CallMediaState,\r\n    output?: CallMediaState\r\n  };\r\n\r\n  private sendMediaState: () => Promise<void>;\r\n\r\n  private decryptQueue: Uint8Array[];\r\n  \r\n  private getEmojisFingerprintPromise: Promise<CallInstance['emojisFingerprint']>;\r\n  private emojisFingerprint: [string, string, string, string];\r\n\r\n  private wasStartingScreen: boolean;\r\n  private wasStartingVideo: boolean;\r\n  public wasTryingToJoin: boolean;\r\n\r\n  public streamManager: StreamManager;\r\n\r\n  constructor(options: {\r\n    isOutgoing: boolean,\r\n    interlocutorUserId: UserId,\r\n    managers: CallInstance['managers'],\r\n    protocol?: PhoneCallProtocol\r\n  }) {\r\n    super();\r\n\r\n    this.log = logger('CALL');\r\n\r\n    if(!this.protocol) {\r\n      this.protocol = getCallProtocol();\r\n    }\r\n\r\n    safeAssign(this, options);\r\n    \r\n    this.createdAt = Date.now();\r\n    this.offerReceived = false;\r\n    this.offerSent = false;\r\n    this.decryptQueue = [];\r\n    this.candidates = [];\r\n\r\n    this.addEventListener('state', (state) => {\r\n      this.log('state', CALL_STATE[state]);\r\n\r\n      if(state === CALL_STATE.CLOSED) {\r\n        this.cleanup();\r\n      }\r\n    });\r\n\r\n    const streamManager = this.streamManager = new StreamManager(GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS);\r\n    streamManager.direction = 'sendrecv';\r\n    streamManager.types.push('screencast');\r\n    if(!this.isOutgoing) {\r\n      streamManager.locked = true;\r\n      streamManager.canCreateConferenceEntry = false;\r\n    }\r\n\r\n    let mediaState: CallMediaState = {\r\n      '@type': 'MediaState',\r\n      type: 'input',\r\n      lowBattery: false,\r\n      muted: true,\r\n      screencastState: 'inactive',\r\n      videoRotation: 0,\r\n      videoState: 'inactive'\r\n    };\r\n\r\n    const self = this;\r\n    mediaState = new Proxy(mediaState, {\r\n      set: function(target, key, value) {\r\n        // @ts-ignore\r\n        target[key] = value;\r\n        self.setMediaState(mediaState);\r\n        self.sendMediaState();\r\n        return true;\r\n      }\r\n    });\r\n\r\n    this.mediaStates = {\r\n      input: mediaState\r\n    };\r\n\r\n    this.sendMediaState = debounce(this._sendMediaState.bind(this), 0, false, true);\r\n  }\r\n\r\n  get connectionState() {\r\n    const {_connectionState, connectionInstance} = this;\r\n    if(_connectionState !== undefined) {\r\n      return _connectionState;\r\n    } else if(!connectionInstance) {\r\n      return CALL_STATE.CONNECTING;\r\n    } else {\r\n      const {iceConnectionState} = connectionInstance.connection;\r\n      if(iceConnectionState === 'closed') {\r\n        return CALL_STATE.CLOSED;\r\n      } else if(iceConnectionState !== 'connected' && (!IS_SAFARI || iceConnectionState !== 'completed')) {\r\n        return CALL_STATE.CONNECTING;\r\n      } else {\r\n        return CALL_STATE.CONNECTED;\r\n      }\r\n    }\r\n  }\r\n\r\n  get sortIndex() {\r\n    const connectionState = this.connectionState;\r\n    const state = CALL_STATE.CLOSED - connectionState + 1;\r\n    let index = state * 10000000000000;\r\n    index += 2147483647000 - (connectionState === CALL_STATE.PENDING && this.isOutgoing ? 0 : this.createdAt);\r\n    return index;\r\n  }\r\n\r\n  public getVideoElement(type: CallMediaState['type']) {\r\n    if(type === 'input') return this.elements.get('main');\r\n    else {\r\n      const mediaState = this.getMediaState('output');\r\n      if(!mediaState) {\r\n        return;\r\n      }\r\n\r\n      const type: WebRTCLineType = mediaState.videoState === 'active' ? 'video' : (mediaState.screencastState === 'active' ? 'screencast' : undefined);\r\n      if(!type) {\r\n        return;\r\n      }\r\n\r\n      const entry = this.description.findEntry((entry) => entry.type === type);\r\n      if(!entry) {\r\n        return;\r\n      }\r\n\r\n      return this.elements.get('' + entry.recvEntry.source);\r\n    }\r\n  }\r\n\r\n  public async startScreenSharingInternal() {\r\n    try {\r\n      this.wasStartingScreen = true;\r\n      this.wasStartingVideo = false;\r\n      this.streamManager.types = ['audio', 'screencast'];\r\n      await this.requestScreen();\r\n    } catch(err) {\r\n      this.log.error('startScreenSharing error', err);\r\n    }\r\n  }\r\n\r\n  public async toggleScreenSharing() {\r\n    if(this.isSharingVideo) {\r\n      await this.stopVideoSharing();\r\n    }\r\n\r\n    if(this.isSharingScreen) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startScreenSharingInternal();\r\n    }\r\n  }\r\n\r\n  public async startVideoSharingInternal() {\r\n    try {\r\n      this.wasStartingScreen = false;\r\n      this.wasStartingVideo = true;\r\n      this.streamManager.types = ['audio', 'video'];\r\n      await this.requestInputSource(false, true, false);\r\n    } catch(err) {\r\n      this.log.error('startVideoSharing error', err);\r\n    }\r\n  }\r\n\r\n  public async stopVideoSharing() {\r\n    const mediaState = this.getMediaState('input');\r\n    mediaState.videoState = mediaState.screencastState = 'inactive';\r\n\r\n    const {streamManager, description} = this;\r\n    const track = streamManager.inputStream.getVideoTracks()[0];\r\n    if(track) {\r\n      stopTrack(track);\r\n      streamManager.appendToConference(description); // clear sender track\r\n    }\r\n  }\r\n\r\n  public async toggleVideoSharing() {\r\n    if(this.isSharingScreen) {\r\n      await this.stopVideoSharing();\r\n    }\r\n\r\n    if(this.isSharingVideo) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startVideoSharingInternal();\r\n    }\r\n  }\r\n\r\n  public getMediaState(type: CallMediaState['type']) {\r\n    return this.mediaStates[type];\r\n  }\r\n\r\n  public setMediaState(mediaState: CallMediaState) {\r\n    this.mediaStates[mediaState.type] = mediaState;\r\n    this.dispatchEvent('mediaState', mediaState);\r\n  }\r\n\r\n  public isSharingVideoType(type: 'video' | 'screencast') {\r\n    try {\r\n      const hasVideoTrack = super.isSharingVideo;\r\n      return hasVideoTrack && !!((this.wasStartingScreen && type === 'screencast') || (this.wasStartingVideo && type === 'video'));\r\n\r\n      // ! it will be used before the track appears\r\n      // return !!this.description.entries.find((entry) => entry.type === type && entry.transceiver.sender.track.enabled);\r\n    } catch(err) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public get isSharingVideo() {\r\n    return this.isSharingVideoType('video');\r\n  }\r\n\r\n  public get isSharingScreen() {\r\n    return this.isSharingVideoType('screencast');\r\n  }\r\n\r\n  public get isMuted() {\r\n    const audioTrack = this.streamManager.inputStream.getAudioTracks()[0];\r\n    return !audioTrack?.enabled;\r\n  }\r\n\r\n  public get isClosing() {\r\n    const {connectionState} = this;\r\n    return connectionState === CALL_STATE.CLOSING || connectionState === CALL_STATE.CLOSED;\r\n  }\r\n\r\n  public get description(): localConferenceDescription {\r\n    return this.connectionInstance?.description;\r\n  }\r\n\r\n  public setHangUpTimeout(timeout: number, reason: PhoneCallDiscardReason['_']) {\r\n    this.clearHangUpTimeout();\r\n    this.hangUpTimeout = ctx.setTimeout(() => {\r\n      this.hangUpTimeout = undefined;\r\n      this.hangUp(reason);\r\n    }, timeout);\r\n  }\r\n\r\n  public clearHangUpTimeout() {\r\n    if(this.hangUpTimeout !== undefined) {\r\n      clearTimeout(this.hangUpTimeout);\r\n      this.hangUpTimeout = undefined;\r\n    }\r\n  }\r\n\r\n  public setPhoneCall(phoneCall: PhoneCall) {\r\n    this.call = phoneCall;\r\n\r\n    const {id} = phoneCall;\r\n    if(this.id !== id) {\r\n      const prevId = this.id;\r\n      this.id = id;\r\n      this.dispatchEvent('id', id, prevId);\r\n    }\r\n  }\r\n\r\n  public async acceptCall() {\r\n    const canAccept = (await Promise.all(this.dispatchResultableEvent('acceptCallOverride')))[0] ?? true;\r\n    if(this.isClosing || !canAccept) {\r\n      return;\r\n    }\r\n    \r\n    // this.clearHangUpTimeout();\r\n    this.overrideConnectionState(CALL_STATE.EXCHANGING_KEYS);\r\n\r\n    const call = this.call as PhoneCall.phoneCallRequested;\r\n    this.requestInputSource(true, !!call.pFlags.video, false);\r\n\r\n    const g_a_hash = call.g_a_hash;\r\n    this.managers.appCallsManager.generateDh().then(async(dh) => {\r\n      this.dh = { // ! it is correct\r\n        g_a_hash,\r\n        b: dh.a,\r\n        g_b: dh.g_a,\r\n        g_b_hash: dh.g_a_hash,\r\n        p: dh.p,\r\n      };\r\n\r\n      return this.managers.apiManager.invokeApi('phone.acceptCall', {\r\n        peer: await this.managers.appCallsManager.getCallInput(this.id),\r\n        protocol: this.protocol,\r\n        g_b: this.dh.g_b\r\n      });\r\n    }).then(async(phonePhoneCall) => {\r\n      await this.managers.appCallsManager.savePhonePhoneCall(phonePhoneCall);\r\n    }).catch((err) => {\r\n      this.log.error('accept call error', err);\r\n      // if(err.type === 'CALL_PROTOCOL_COMPAT_LAYER_INVALID') {\r\n\r\n      // }\r\n\r\n      this.hangUp('phoneCallDiscardReasonHangup');\r\n    });\r\n  }\r\n\r\n  public joinCall() {\r\n    this.log('joinCall');\r\n\r\n    this.getEmojisFingerprint();\r\n\r\n    this.overrideConnectionState();\r\n    \r\n    const {isOutgoing, encryptionKey, streamManager} = this;\r\n    \r\n    const configuration = getRtcConfiguration(this.call as PhoneCall.phoneCall);\r\n    this.log('joinCall configuration', configuration);\r\n    if(!configuration) return;\r\n\r\n    const connectionInstance = this.connectionInstance = new CallConnectionInstance({\r\n      call: this,\r\n      streamManager,\r\n      log: this.log.bindPrefix('connection'),\r\n    });\r\n\r\n    const connection = connectionInstance.createPeerConnection(configuration);\r\n    connection.addEventListener('iceconnectionstatechange', () => {\r\n      const state = this.connectionState;\r\n      if(this.connectedAt === undefined && state === CALL_STATE.CONNECTED) {\r\n        this.connectedAt = Date.now();\r\n      }\r\n      \r\n      this.dispatchEvent('state', state);\r\n    });\r\n    connection.addEventListener('negotiationneeded', () => {\r\n      connectionInstance.negotiate();\r\n    });\r\n    connection.addEventListener('icecandidate', (event) => {\r\n      const {candidate} = event;\r\n      connection.log('onicecandidate', candidate);\r\n      if(candidate?.candidate) {\r\n        this.sendIceCandidate(candidate);\r\n      }\r\n    });\r\n    connection.addEventListener('track', (event) => {\r\n      const {track} = event;\r\n      connection.log('ontrack', track);\r\n      this.onTrack(event);\r\n    });\r\n\r\n    const description = connectionInstance.createDescription();\r\n    \r\n    this.encryptor = new P2PEncryptor(isOutgoing, encryptionKey);\r\n    this.decryptor = new P2PEncryptor(!isOutgoing, encryptionKey);\r\n\r\n    this.log('currentCall', this);\r\n\r\n    if(isOutgoing) {\r\n      connectionInstance.appendStreamToConference();\r\n    }\r\n    \r\n    this.createDataChannel();\r\n\r\n    this.processDecryptQueue();\r\n  }\r\n\r\n  private createDataChannelEntry() {\r\n    const dataChannelEntry = this.description.createEntry('application');\r\n    dataChannelEntry.setDirection('sendrecv');\r\n    dataChannelEntry.sendEntry = dataChannelEntry.recvEntry = dataChannelEntry; \r\n  }\r\n\r\n  private createDataChannel() {\r\n    if(this.connectionInstance.dataChannel) {\r\n      return;\r\n    }\r\n\r\n    const channel = this.connectionInstance.createDataChannel({\r\n      id: 0,\r\n      negotiated: true\r\n    });\r\n    channel.addEventListener('message', (e) => {\r\n      this.applyDataChannelData(JSON.parse(e.data));\r\n    });\r\n    channel.addEventListener('open', () => {\r\n      this.sendMediaState();\r\n    });\r\n  }\r\n\r\n  private applyDataChannelData(data: CallMediaState) {\r\n    switch(data['@type']) {\r\n      case 'MediaState': {\r\n        data.type = 'output';\r\n        this.log('got output media state', data);\r\n        this.setMediaState(data);\r\n        break;\r\n      }\r\n\r\n      default:\r\n        this.log.error('unknown data channel data:', data);\r\n        break;\r\n    }\r\n  }\r\n\r\n  private _sendMediaState() {\r\n    const {connectionInstance} = this;\r\n    if(!connectionInstance) return;\r\n\r\n    const mediaState = {...this.getMediaState('input')};\r\n    // mediaState.videoRotation = 90;\r\n    delete mediaState.type;\r\n    this.log('sendMediaState', mediaState);\r\n\r\n    connectionInstance.sendDataChannelData(mediaState);\r\n  }\r\n\r\n  public async sendCallSignalingData(data: CallSignalingData) {\r\n    /* if(data['@type'] === 'InitialSetup') {\r\n      this.filterNotVP8(data);\r\n    } */\r\n    \r\n    const json = JSON.stringify(data);\r\n    const arr = new TextEncoder().encode(json);\r\n    const {bytes} = await this.encryptor.encryptRawPacket(arr);\r\n    \r\n    this.log('sendCallSignalingData', this.id, json);\r\n    await this.managers.apiManager.invokeApi('phone.sendSignalingData', {\r\n      peer: await this.managers.appCallsManager.getCallInput(this.id),\r\n      data: bytes\r\n    });\r\n  }\r\n  \r\n  public sendIceCandidate(iceCandidate: RTCIceCandidate) {\r\n    this.log('sendIceCandidate', iceCandidate);\r\n    const {candidate, sdpMLineIndex} = iceCandidate;\r\n    if(sdpMLineIndex !== 0) {\r\n      return;\r\n    }\r\n    \r\n    const parsed = p2pParseCandidate(candidate);\r\n    // const parsed = {sdpString: candidate};\r\n    /* if(parsed.address.ip !== '') {\r\n      return;\r\n    } */\r\n\r\n    this.sendCallSignalingData({\r\n      '@type': 'Candidates', \r\n      candidates: [parsed]\r\n    });\r\n  }\r\n\r\n  public async confirmCall() {\r\n    const {protocol, id, call} = this;\r\n    const dh = this.dh as DiffieHellmanInfo.a;\r\n\r\n    // this.clearHangUpTimeout();\r\n    this.overrideConnectionState(CALL_STATE.EXCHANGING_KEYS);\r\n    const {key, key_fingerprint} = await this.managers.appCallsManager.computeKey((call as PhoneCall.phoneCallAccepted).g_b, dh.a, dh.p);\r\n    \r\n    const phonePhoneCall = await this.managers.apiManager.invokeApi('phone.confirmCall', {\r\n      peer: await this.managers.appCallsManager.getCallInput(id),\r\n      protocol: protocol,\r\n      g_a: dh.g_a,\r\n      key_fingerprint: key_fingerprint\r\n    });\r\n    \r\n    this.encryptionKey = key;\r\n    await this.managers.appCallsManager.savePhonePhoneCall(phonePhoneCall);\r\n    this.joinCall();\r\n  }\r\n\r\n  public getEmojisFingerprint() {\r\n    if(this.emojisFingerprint) return this.emojisFingerprint;\r\n    if(this.getEmojisFingerprintPromise) return this.getEmojisFingerprintPromise;\r\n    return this.getEmojisFingerprintPromise = apiManagerProxy.invokeCrypto('get-emojis-fingerprint', this.encryptionKey, this.dh.g_a).then((codePoints) => {\r\n      this.getEmojisFingerprintPromise = undefined;\r\n      return this.emojisFingerprint = codePoints.map((codePoints) => emojiFromCodePoints(codePoints)) as [string, string, string, string];\r\n    });\r\n  }\r\n\r\n  private unlockStreamManager() {\r\n    this.connectionInstance.streamManager.locked = false;\r\n    this.connectionInstance.appendStreamToConference();\r\n  }\r\n\r\n  private async doTheMagic() {\r\n    this.connectionInstance.appendStreamToConference();\r\n\r\n    const connection = this.connectionInstance.connection;\r\n\r\n    let answer = await connection.createAnswer();\r\n\r\n    this.log('[sdp] local', answer.type, answer.sdp);\r\n    await connection.setLocalDescription(answer);\r\n\r\n    connection.getTransceivers().filter((transceiver) => transceiver.direction === 'recvonly').forEach((transceiver) => {\r\n      const entry = this.connectionInstance.description.getEntryByMid(transceiver.mid);\r\n      entry.transceiver = entry.recvEntry.transceiver = transceiver;\r\n      transceiver.direction = 'sendrecv';\r\n    });\r\n\r\n    const isAnswer = false;\r\n\r\n    const description = this.description;\r\n    let bundle = description.entries.map((entry) => entry.mid);\r\n    const sdpDescription: RTCSessionDescriptionInit = {\r\n      type: isAnswer ? 'answer' : 'offer',\r\n      sdp: description.generateSdp({\r\n        bundle,\r\n        entries: description.entries.filter((entry) => bundle.includes(entry.mid)),\r\n        // isAnswer: isAnswer\r\n        isAnswer: !isAnswer\r\n      })\r\n    };\r\n\r\n    await connection.setRemoteDescription(sdpDescription);\r\n\r\n    answer = await connection.createAnswer();\r\n\r\n    await connection.setLocalDescription(answer);\r\n    \r\n    const initialSetup = parseSignalingData(parseSdp(answer.sdp));\r\n    this.log('[InitialSetup] send 1');\r\n    this.sendCallSignalingData(initialSetup);\r\n    \r\n    this.unlockStreamManager();\r\n  }\r\n\r\n  public overrideConnectionState(state?: CALL_STATE) {\r\n    this._connectionState = state;\r\n    this.dispatchEvent('state', this.connectionState);\r\n  }\r\n\r\n  public get duration() {\r\n    return this.connectedAt !== undefined ? (Date.now() - this.connectedAt) / 1000 | 0 : 0;\r\n  }\r\n\r\n  protected onInputStream(stream: MediaStream): void {\r\n    super.onInputStream(stream);\r\n\r\n    const videoTrack = stream.getVideoTracks()[0];\r\n    if(videoTrack) {\r\n      const state = this.getMediaState('input');\r\n\r\n      // handle starting camera\r\n      if(!this.wasStartingScreen && !this.wasStartingVideo) {\r\n        this.wasStartingVideo = true;\r\n      }\r\n\r\n      if(this.isSharingVideo) {\r\n        state.videoState = 'active';\r\n      } else if(this.isSharingScreen) {\r\n        state.screencastState = 'active';\r\n      }\r\n\r\n      videoTrack.addEventListener('ended', () => {\r\n        this.stopVideoSharing();\r\n      }, {once: true});\r\n    }\r\n\r\n    if(stream.getAudioTracks().length) {\r\n      this.onMutedChange();\r\n    }\r\n  }\r\n  \r\n  private onMutedChange() {\r\n    const isMuted = this.isMuted;\r\n    this.dispatchEvent('muted', isMuted);\r\n\r\n    const state = this.getMediaState('input');\r\n    state.muted = isMuted;\r\n  }\r\n\r\n  public toggleMuted(): Promise<void> {\r\n    return this.requestAudioSource(true).then(() => {\r\n      this.setMuted();\r\n      this.onMutedChange();\r\n    });\r\n  }\r\n\r\n  public async hangUp(discardReason?: PhoneCallDiscardReason['_'], discardedByOtherParty?: boolean) {\r\n    if(this.isClosing) {\r\n      return;\r\n    }\r\n\r\n    this.discardReason = discardReason;\r\n    this.log('hangUp', discardReason);\r\n    this.overrideConnectionState(CALL_STATE.CLOSED);\r\n\r\n    if(this.connectionInstance) {\r\n      this.connectionInstance.closeConnectionAndStream(true);\r\n    }\r\n\r\n    if(discardReason && !discardedByOtherParty) {\r\n      let hasVideo = false;\r\n      for(const type in this.mediaStates) {\r\n        const mediaState = this.mediaStates[type as 'input' | 'output'];\r\n        hasVideo = mediaState.videoState === 'active' || mediaState.screencastState === 'active' || hasVideo;\r\n      }\r\n\r\n      await this.managers.appCallsManager.discardCall(this.id, this.duration, discardReason, hasVideo);\r\n    }\r\n  }\r\n\r\n  private performCodec(_codec: P2PAudioCodec | P2PVideoCodec) {\r\n    const payloadTypes: AudioCodec['payload-types'] = _codec.payloadTypes.map((payloadType) => {\r\n      return {\r\n        ...payloadType,\r\n        'rtcp-fbs': payloadType.feedbackTypes\r\n      }\r\n    });\r\n    \r\n    const codec: AudioCodec = {\r\n      'rtp-hdrexts': _codec.rtpExtensions,\r\n      'payload-types': payloadTypes\r\n    };\r\n    \r\n    return codec;\r\n  }\r\n\r\n  private setDataToDescription(data: CallSignalingData.initialSetup) {\r\n    this.description.setData({\r\n      transport: {\r\n        pwd: data.pwd,\r\n        ufrag: data.ufrag,\r\n        fingerprints: data.fingerprints,\r\n        'rtcp-mux': true\r\n      },\r\n      audio: this.performCodec(data.audio),\r\n      video: data.video ? this.performCodec(data.video) as VideoCodec : undefined,\r\n      screencast: data.screencast ? this.performCodec(data.screencast) as VideoCodec : undefined\r\n    });\r\n  }\r\n\r\n  private filterNotVP8(initialSetup: CallSignalingData.initialSetup) {\r\n    if(!this.isOutgoing) { // only VP8 works now\r\n      [initialSetup.video, initialSetup.screencast].filter(Boolean).forEach((codec) => {\r\n        const payloadTypes = codec.payloadTypes;\r\n        const idx = payloadTypes.findIndex((payloadType) => payloadType.name === 'VP8');\r\n        const vp8PayloadType = payloadTypes[idx];\r\n        const rtxIdx = payloadTypes.findIndex((payloadType) => +payloadType.parameters?.apt === vp8PayloadType.id);\r\n        codec.payloadTypes = [payloadTypes[idx], payloadTypes[rtxIdx]];\r\n      });\r\n    }\r\n  }\r\n\r\n  public async applyCallSignalingData(data: CallSignalingData) {\r\n    this.log('applyCallSignalingData', this, data);\r\n    \r\n    const {connection, description} = this.connectionInstance;\r\n\r\n    switch(data['@type']) {\r\n      case 'InitialSetup': {\r\n        this.log('[sdp] InitialSetup', data);\r\n\r\n        this.filterNotVP8(data);\r\n        this.setDataToDescription(data);\r\n\r\n        const performSsrcGroups = (ssrcGroups: P2PVideoCodec['ssrcGroups']): GroupCallParticipantVideoSourceGroup[] => {\r\n          return ssrcGroups.map((ssrcGroup) => {\r\n            return {\r\n              _: 'groupCallParticipantVideoSourceGroup',\r\n              semantics: ssrcGroup.semantics,\r\n              sources: ssrcGroup.ssrcs.map((source) => +source)\r\n            };\r\n          });\r\n        };\r\n\r\n        const ssrcs = [\r\n          generateSsrc('audio', +data.audio.ssrc),\r\n          data.video ? generateSsrc('video', performSsrcGroups(data.video.ssrcGroups)) : undefined,\r\n          data.screencast ? generateSsrc('screencast', performSsrcGroups(data.screencast.ssrcGroups)) : undefined\r\n        ].filter(Boolean);\r\n\r\n        ssrcs.forEach((ssrc) => {\r\n          let entry = description.getEntryBySource(ssrc.source);\r\n          if(entry) {\r\n            return;\r\n          }\r\n          \r\n          const sendRecvEntry = description.findFreeSendRecvEntry(ssrc.type, false);\r\n          entry = new ConferenceEntry(sendRecvEntry.mid, ssrc.type);\r\n          entry.setDirection('sendrecv');\r\n          sendRecvEntry.recvEntry = entry;\r\n\r\n          description.setEntrySource(entry, ssrc.sourceGroups || ssrc.source);\r\n        });\r\n\r\n        this.createDataChannelEntry();\r\n\r\n        const isAnswer = this.offerSent;\r\n        this.offerSent = false;\r\n\r\n        let bundle = description.entries.map((entry) => entry.mid);\r\n        const sdpDescription: RTCSessionDescriptionInit = {\r\n          type: isAnswer ? 'answer' : 'offer',\r\n          sdp: description.generateSdp({\r\n            bundle,\r\n            entries: description.entries.filter((entry) => bundle.includes(entry.mid)),\r\n            // isAnswer: isAnswer\r\n            isAnswer: !isAnswer\r\n          })\r\n        };\r\n\r\n        this.log('[sdp] remote', sdpDescription.sdp);\r\n\r\n        await connection.setRemoteDescription(sdpDescription);\r\n\r\n        await this.tryToReleaseCandidates();\r\n\r\n        if(!isAnswer) {\r\n          await this.doTheMagic();\r\n        }\r\n\r\n        break;\r\n      }\r\n      \r\n      case 'Candidates': {\r\n        for(const candidate of data.candidates) {\r\n          const init: RTCIceCandidateInit = P2PSdpBuilder.generateCandidate(candidate);\r\n          init.sdpMLineIndex = 0;\r\n          const iceCandidate = new RTCIceCandidate(init);\r\n          this.candidates.push(iceCandidate);\r\n        }\r\n        \r\n        await this.tryToReleaseCandidates();\r\n        break;\r\n      }\r\n\r\n      default: {\r\n        this.log.error('unrecognized signaling data', data);\r\n      }\r\n    }\r\n  }\r\n\r\n  public async tryToReleaseCandidates() {\r\n    const {connectionInstance} = this;\r\n    if(!connectionInstance) {\r\n      return;\r\n    }\r\n\r\n    const {connection} = connectionInstance;\r\n    if(connection.remoteDescription) {\r\n      const promises: Promise<void>[] = this.candidates.map((candidate) => this.addIceCandidate(connection, candidate));\r\n      this.candidates.length = 0;\r\n\r\n      await Promise.all(promises);\r\n    } else {\r\n      this.log('[candidates] postpone');\r\n    }\r\n  }\r\n\r\n  private async addIceCandidate(connection: RTCPeerConnection, candidate: RTCIceCandidate) {\r\n    this.log('[candidate] start', candidate);\r\n    try {\r\n      // if(!candidate.address) return;\r\n      await connection.addIceCandidate(candidate);\r\n      this.log('[candidate] add', candidate);\r\n    } catch(e) {\r\n      this.log.error('[candidate] error', candidate, e);\r\n    }\r\n  }\r\n\r\n  private async processDecryptQueue() {\r\n    const {encryptor} = this;\r\n    if(!encryptor) {\r\n      this.log.warn('got encrypted signaling data before the encryption key');\r\n      return;\r\n    }\r\n\r\n    const length = this.decryptQueue.length;\r\n    if(!length) {\r\n      return;\r\n    }\r\n    \r\n    const queue = this.decryptQueue.slice();\r\n    this.decryptQueue.length = 0;\r\n    \r\n    for(const data of queue) {\r\n      const decryptedData = await encryptor.decryptRawPacket(data);\r\n      if(!decryptedData) {\r\n        continue;\r\n      }\r\n\r\n      // this.log('[update] updateNewCallSignalingData', update, decryptedData);\r\n      \r\n      const str = new TextDecoder().decode(decryptedData);\r\n      try {\r\n        const signalingData: CallSignalingData = JSON.parse(str);\r\n        this.log('[update] updateNewCallSignalingData', signalingData);\r\n        this.applyCallSignalingData(signalingData);\r\n      } catch(err) {\r\n        this.log.error('wrong signaling data', str);\r\n        this.hangUp('phoneCallDiscardReasonDisconnect');\r\n        callsController.dispatchEvent('incompatible', this.interlocutorUserId);\r\n      }\r\n    }\r\n  }\r\n\r\n  public onUpdatePhoneCallSignalingData(data: Uint8Array) {\r\n    this.decryptQueue.push(data);\r\n    this.processDecryptQueue();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { PhoneCallProtocol } from \"../../../layer\";\r\n\r\nexport default function getCallProtocol(): PhoneCallProtocol {\r\n  return {\r\n    _: 'phoneCallProtocol',\r\n    pFlags: {\r\n      udp_p2p: true,\r\n      udp_reflector: true\r\n    },\r\n    min_layer: 92,\r\n    max_layer: 92,\r\n    library_versions: ['4.0.0']\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { PhoneCall } from \"../../../layer\";\r\n\r\nexport default function getRtcConfiguration(call: PhoneCall.phoneCall): RTCConfiguration {\r\n  const iceServers: RTCIceServer[] = [];\r\n  call.connections.forEach((connection) => {\r\n    switch(connection._) {\r\n      /* case 'callServerTypeTelegramReflector': {\r\n        break;\r\n      } */\r\n      case 'phoneConnectionWebrtc': {\r\n        const {ip, ipv6, port, username, password} = connection;\r\n        const urls: string[] = [];\r\n        if(connection.pFlags.turn) {\r\n          if(ip) {\r\n            urls.push(`turn:${ip}:${port}`);\r\n          }\r\n          if(ipv6) {\r\n            urls.push(`turn:[${ipv6}]:${port}`);\r\n          }\r\n        } else if(connection.pFlags.stun) {\r\n          if(ip) {\r\n            urls.push(`stun:${ip}:${port}`);\r\n          }\r\n          if(ipv6) {\r\n            urls.push(`stun:[${ipv6}]:${port}`);\r\n          }\r\n        }\r\n        \r\n        if(urls.length > 0) {\r\n          iceServers.push({\r\n            urls,\r\n            username,\r\n            credential: password\r\n          });\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  });\r\n  \r\n  return {\r\n    iceServers,\r\n    iceTransportPolicy: call.pFlags.p2p_allowed ? 'all' : 'relay'\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport GROUP_CALL_STATE from \"../lib/calls/groupCallState\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport TopbarWeave from \"./topbarWeave\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport PopupGroupCall from \"./groupCall\";\r\nimport GroupCallDescriptionElement from \"./groupCall/description\";\r\nimport GroupCallTitleElement from \"./groupCall/title\";\r\nimport PopupElement from \"./popups\";\r\nimport throttle from \"../helpers/schedulers/throttle\";\r\nimport GroupCallInstance from \"../lib/calls/groupCallInstance\";\r\nimport CALL_STATE from \"../lib/calls/callState\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport CallDescriptionElement from \"./call/description\";\r\nimport PopupCall from \"./call\";\r\nimport GroupCallMicrophoneIconMini from \"./groupCall/microphoneIconMini\";\r\nimport CallInstance from \"../lib/calls/callInstance\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport groupCallsController from \"../lib/calls/groupCallsController\";\r\nimport StreamManager from \"../lib/calls/streamManager\";\r\nimport callsController from \"../lib/calls/callsController\";\r\n\r\nfunction convertCallStateToGroupState(state: CALL_STATE, isMuted: boolean) {\r\n  switch(state) {\r\n    case CALL_STATE.CLOSING:\r\n    case CALL_STATE.CLOSED:\r\n      return GROUP_CALL_STATE.CLOSED;\r\n    case CALL_STATE.CONNECTED:\r\n      return isMuted ? GROUP_CALL_STATE.MUTED : GROUP_CALL_STATE.UNMUTED;\r\n    default:\r\n      return GROUP_CALL_STATE.CONNECTING;\r\n  }\r\n}\r\n\r\nconst CLASS_NAME = 'topbar-call';\r\n\r\nexport default class TopbarCall {\r\n  public container: HTMLElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private weave: TopbarWeave;\r\n  private center: HTMLDivElement;\r\n  private groupCallTitle: GroupCallTitleElement;\r\n  private groupCallDescription: GroupCallDescriptionElement;\r\n  private groupCallMicrophoneIconMini: GroupCallMicrophoneIconMini;\r\n  private callDescription: CallDescriptionElement;\r\n  \r\n  private currentDescription: GroupCallDescriptionElement | CallDescriptionElement;\r\n\r\n  private instance: GroupCallInstance | any/* CallInstance */;\r\n  private instanceListenerSetter: ListenerSetter;\r\n  \r\n  constructor(\r\n    private managers: AppManagers\r\n  ) {\r\n    const listenerSetter = this.listenerSetter = new ListenerSetter();\r\n\r\n    listenerSetter.add(callsController)('instance', ({instance}) => {\r\n      if(!this.instance) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(callsController)('accepting', (instance) => {\r\n      if(this.instance !== instance) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(groupCallsController)('instance', (instance) => {\r\n      this.updateInstance(instance);\r\n    });\r\n    \r\n    listenerSetter.add(rootScope)('group_call_update', (groupCall) => {\r\n      const instance = groupCallsController.groupCall;\r\n      if(instance?.id === groupCall.id) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(StreamManager.ANALYSER_LISTENER)('amplitude', ({amplitudes, type}) => {\r\n      const {weave} = this;\r\n      if(!amplitudes.length || !weave/*  || type !== 'input' */) return;\r\n\r\n      let max = 0;\r\n      for(let i = 0; i < amplitudes.length; ++i) {\r\n        const {type, value} = amplitudes[i];\r\n        max = value > max ? value : max;\r\n      }\r\n\r\n      weave.setAmplitude(max);\r\n    });\r\n  }\r\n\r\n  private onState = () => {\r\n    this.updateInstance(this.instance);\r\n  };\r\n\r\n  private clearCurrentInstance() {\r\n    if(!this.instance) return;\r\n    this.center.textContent = '';\r\n    \r\n    if(this.currentDescription) {\r\n      this.currentDescription.detach();\r\n      this.currentDescription = undefined;\r\n    }\r\n\r\n    this.instance = undefined;\r\n    this.instanceListenerSetter.removeAll();\r\n  }\r\n\r\n  private updateInstance(instance: TopbarCall['instance']) {\r\n    if(this.construct) {\r\n      this.construct();\r\n      this.construct = undefined;\r\n    }\r\n\r\n    const isChangingInstance = this.instance !== instance;\r\n    if(isChangingInstance) {\r\n      this.clearCurrentInstance();\r\n      \r\n      this.instance = instance;\r\n      this.instanceListenerSetter = new ListenerSetter();\r\n\r\n      this.instanceListenerSetter.add(instance as GroupCallInstance)('state', this.onState);\r\n\r\n      if(instance instanceof GroupCallInstance) {\r\n        this.currentDescription = this.groupCallDescription;\r\n      } else {\r\n        this.currentDescription = this.callDescription;\r\n        this.instanceListenerSetter.add(instance)('muted', this.onState);\r\n      }\r\n\r\n      this.container.classList.toggle('is-call', !(instance instanceof GroupCallInstance));\r\n    }\r\n\r\n    const isMuted = this.instance.isMuted;\r\n    let state = instance instanceof GroupCallInstance ? instance.state : convertCallStateToGroupState(instance.connectionState, isMuted);\r\n\r\n    const {weave} = this;\r\n\r\n    weave.componentDidMount();\r\n    \r\n    const isClosed = state === GROUP_CALL_STATE.CLOSED;\r\n    if((!document.body.classList.contains('is-calling') || isChangingInstance) || isClosed) {\r\n      if(isClosed) {\r\n        weave.setAmplitude(0);\r\n      }\r\n\r\n      SetTransition(document.body, 'is-calling', !isClosed, 250, isClosed ? () => {\r\n        weave.componentWillUnmount();\r\n\r\n        this.clearCurrentInstance();\r\n      }: undefined);\r\n    }\r\n    \r\n    if(isClosed) {\r\n      return;\r\n    }\r\n    \r\n    weave.setCurrentState(state, true);\r\n    // if(state === GROUP_CALL_STATE.CONNECTING) {\r\n    //   weave.setCurrentState(state, true);\r\n    // } else {\r\n    //   /* var a = 0;\r\n    //   animate(() => {\r\n    //     a += 0.1;\r\n    //     if(a > 1) a = 0;\r\n    //     weave.setAmplitude(a);\r\n    //     return true;\r\n    //   });\r\n    //   weave.setAmplitude(1); */\r\n    //   weave.setCurrentState(state, true);\r\n    // }\r\n    \r\n    this.setTitle(instance);\r\n    this.setDescription(instance);\r\n    this.groupCallMicrophoneIconMini.setState(!isMuted);\r\n  }\r\n\r\n  private setDescription(instance: TopbarCall['instance']) {\r\n    return this.currentDescription.update(instance as any);\r\n  }\r\n\r\n  private setTitle(instance: TopbarCall['instance']) {\r\n    if(instance instanceof GroupCallInstance) {\r\n      return this.groupCallTitle.update(instance);\r\n    } else {\r\n      replaceContent(this.center, new PeerTitle({peerId: instance.interlocutorUserId.toPeerId()}).element);\r\n    }\r\n  }\r\n\r\n  private construct() {\r\n    const {listenerSetter} = this;\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add('sidebar-header', CLASS_NAME + '-container');\r\n\r\n    const left = document.createElement('div');\r\n    left.classList.add(CLASS_NAME + '-left');\r\n\r\n    const groupCallMicrophoneIconMini = this.groupCallMicrophoneIconMini = new GroupCallMicrophoneIconMini();\r\n    \r\n    const mute = ButtonIcon();\r\n    mute.append(groupCallMicrophoneIconMini.container);\r\n    left.append(mute);\r\n\r\n    const throttledMuteClick = throttle(() => {\r\n      this.instance.toggleMuted();\r\n    }, 600, true);\r\n    \r\n    attachClickEvent(mute, (e) => {\r\n      cancelEvent(e);\r\n      throttledMuteClick();\r\n    }, {listenerSetter});\r\n    \r\n    const center = this.center = document.createElement('div');\r\n    center.classList.add(CLASS_NAME + '-center');\r\n    \r\n    this.groupCallTitle = new GroupCallTitleElement(center);\r\n    this.groupCallDescription = new GroupCallDescriptionElement(left);\r\n\r\n    this.callDescription = new CallDescriptionElement(left);\r\n    \r\n    const right = document.createElement('div');\r\n    right.classList.add(CLASS_NAME + '-right');\r\n    \r\n    const end = ButtonIcon('endcall_filled');\r\n    right.append(end);\r\n    \r\n    attachClickEvent(end, (e) => {\r\n      cancelEvent(e);\r\n\r\n      const {instance} = this;\r\n      if(!instance) {\r\n        return;\r\n      }\r\n\r\n      if(instance instanceof GroupCallInstance) {\r\n        instance.hangUp();\r\n      } else {\r\n        instance.hangUp('phoneCallDiscardReasonHangup');\r\n      }\r\n    }, {listenerSetter});\r\n\r\n    attachClickEvent(container, () => {\r\n      if(this.instance instanceof GroupCallInstance) {\r\n        if(PopupElement.getPopups(PopupGroupCall).length) {\r\n          return;\r\n        }\r\n        \r\n        new PopupGroupCall().show();\r\n      } else if(this.instance instanceof CallInstance) {\r\n        const popups = PopupElement.getPopups(PopupCall);\r\n        if(popups.find((popup) => popup.getCallInstance() === this.instance)) {\r\n          return;\r\n        }\r\n\r\n        new PopupCall(this.instance).show();\r\n      }\r\n    }, {listenerSetter});\r\n    \r\n    container.append(left, center, right);\r\n\r\n    const weave = this.weave = new TopbarWeave();\r\n    const weaveContainer = weave.render(CLASS_NAME + '-weave');\r\n    container.prepend(weaveContainer);\r\n    \r\n    document.getElementById('column-center').prepend(container);\r\n    weave.componentDidMount();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { fontFamily } from \"../../components/middleEllipsis\";\r\nimport getPeerTitle from \"../../components/wrappers/getPeerTitle\";\r\nimport wrapMessageForReply from \"../../components/wrappers/messageForReply\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport IS_VIBRATE_SUPPORTED from \"../../environment/vibrateSupport\";\r\nimport deferredPromise, { CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport idleController from \"../../helpers/idleController\";\r\nimport deepEqual from \"../../helpers/object/deepEqual\";\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { Message, MessagePeerReaction, PeerNotifySettings } from \"../../layer\";\r\nimport I18n, { FormatterArguments, LangPackKey } from \"../langPack\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport singleInstance from \"../mtproto/singleInstance\";\r\nimport webPushApiManager, { PushSubscriptionNotify } from \"../mtproto/webPushApiManager\";\r\nimport fixEmoji from \"../richTextProcessor/fixEmoji\";\r\nimport wrapPlainText from \"../richTextProcessor/wrapPlainText\";\r\nimport rootScope from \"../rootScope\";\r\nimport appImManager from \"./appImManager\";\r\nimport appRuntimeManager from \"./appRuntimeManager\";\r\nimport { AppManagers } from \"./managers\";\r\nimport generateMessageId from \"./utils/messageId/generateMessageId\";\r\nimport getPeerId from \"./utils/peers/getPeerId\";\r\n\r\ntype MyNotification = Notification & {\r\n  hidden?: boolean,\r\n  show?: () => void,\r\n};\r\n\r\nexport type NotifyOptions = Partial<{\r\n  tag: string;\r\n  image: string;\r\n  key: string;\r\n  title: string;\r\n  message: string;\r\n  silent: boolean;\r\n  onclick: () => void;\r\n  noIncrement: boolean;\r\n}>;\r\n\r\nexport type NotificationSettings = {\r\n  nodesktop: boolean,\r\n  volume: number,\r\n  novibrate: boolean,\r\n  nopreview: boolean,\r\n  nopush: boolean,\r\n  nosound: boolean\r\n};\r\n\r\nexport class UiNotificationsManager {\r\n  private notificationsUiSupport: boolean;\r\n  private notificationsShown: {[key: string]: MyNotification | true} = {};\r\n  private notificationIndex = 0;\r\n  private notificationsCount = 0;\r\n  private soundsPlayed: {[tag: string]: number} = {};\r\n  private vibrateSupport = IS_VIBRATE_SUPPORTED;\r\n  private nextSoundAt: number;\r\n  private prevSoundVolume: number;\r\n\r\n  private faviconEl: HTMLLinkElement = document.head.querySelector('link[rel=\"icon\"]');\r\n\r\n  private titleBackup = document.title;\r\n  private titleChanged = false;\r\n  private titleInterval: number;\r\n  private prevFavicon: string;\r\n\r\n  private notifySoundEl: HTMLElement;\r\n\r\n  private stopped = false;\r\n\r\n  private topMessagesDeferred: CancellablePromise<void>;\r\n\r\n  private settings: NotificationSettings = {} as any;\r\n\r\n  private registeredDevice: any;\r\n  private pushInited = false;\r\n  \r\n  private managers: AppManagers;\r\n  private setAppBadge: (contents?: any) => Promise<void>;\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    navigator.vibrate = navigator.vibrate || (navigator as any).mozVibrate || (navigator as any).webkitVibrate;\r\n    this.setAppBadge = (navigator as any).setAppBadge && (navigator as any).setAppBadge.bind(navigator);\r\n    this.setAppBadge && this.setAppBadge(0);\r\n\r\n    this.notificationsUiSupport = ('Notification' in window) || ('mozNotification' in navigator);\r\n\r\n    this.notifySoundEl = document.createElement('div');\r\n    this.notifySoundEl.id = 'notify-sound';\r\n    document.body.append(this.notifySoundEl);\r\n\r\n    this.topMessagesDeferred = deferredPromise<void>();\r\n\r\n    singleInstance.addEventListener('deactivated', () => {\r\n      this.stop();\r\n    });\r\n\r\n    singleInstance.addEventListener('activated', () => {\r\n      if(this.stopped) {\r\n        this.start();\r\n      }\r\n    });\r\n\r\n    idleController.addEventListener('change', (idle) => {\r\n      if(this.stopped) {\r\n        return;\r\n      }\r\n\r\n      if(!idle) {\r\n        this.clear();\r\n      }\r\n\r\n      this.toggleToggler();\r\n    });\r\n\r\n    rootScope.addEventListener('notification_reset', (peerString) => {\r\n      this.soundReset(peerString);\r\n    });\r\n\r\n    rootScope.addEventListener('notification_cancel', (str) => {\r\n      this.cancel(str);\r\n    });\r\n    \r\n    if(this.setAppBadge) {\r\n      rootScope.addEventListener('folder_unread', (folder) => {\r\n        if(folder.id === 0) {\r\n          this.setAppBadge(folder.unreadUnmutedPeerIds.size);\r\n        }\r\n      });\r\n    }\r\n\r\n    webPushApiManager.addEventListener('push_init', (tokenData) => {\r\n      this.pushInited = true;\r\n      if(!this.settings.nodesktop && !this.settings.nopush) {\r\n        if(tokenData) {\r\n          this.registerDevice(tokenData);\r\n        } else {\r\n          webPushApiManager.subscribe();\r\n        }\r\n      } else {\r\n        this.unregisterDevice(tokenData);\r\n      }\r\n    });\r\n    webPushApiManager.addEventListener('push_subscribe', (tokenData) => {\r\n      this.registerDevice(tokenData);\r\n    });\r\n    webPushApiManager.addEventListener('push_unsubscribe', (tokenData) => {\r\n      this.unregisterDevice(tokenData);\r\n    });\r\n\r\n    rootScope.addEventListener('dialogs_multiupdate', () => {\r\n      //unregisterTopMsgs()\r\n      this.topMessagesDeferred.resolve();\r\n    }, {once: true});\r\n\r\n    webPushApiManager.addEventListener('push_notification_click', (notificationData) => {\r\n      if(notificationData.action === 'push_settings') {\r\n        /* this.topMessagesDeferred.then(() => {\r\n          $modal.open({\r\n            templateUrl: templateUrl('settings_modal'),\r\n            controller: 'SettingsModalController',\r\n            windowClass: 'settings_modal_window mobile_modal',\r\n            backdrop: 'single'\r\n          })\r\n        }); */\r\n        return;\r\n      }\r\n\r\n      if(notificationData.action === 'mute1d') {\r\n        this.managers.apiManager.invokeApi('account.updateDeviceLocked', {\r\n          period: 86400\r\n        }).then(() => {\r\n          // var toastData = toaster.pop({\r\n          //   type: 'info',\r\n          //   body: _('push_action_mute1d_success'),\r\n          //   bodyOutputType: 'trustedHtml',\r\n          //   clickHandler: () => {\r\n          //     toaster.clear(toastData)\r\n          //   },\r\n          //   showCloseButton: false\r\n          // })\r\n        });\r\n\r\n        return;\r\n      }\r\n\r\n      const peerId = notificationData.custom && notificationData.custom.peerId.toPeerId();\r\n      console.log('click', notificationData, peerId);\r\n      if(peerId) {\r\n        this.topMessagesDeferred.then(async() => {\r\n          if(notificationData.custom.channel_id &&\r\n              !(await this.managers.appChatsManager.hasChat(notificationData.custom.channel_id))) {\r\n            return;\r\n          }\r\n\r\n          if(peerId.isUser() && !(await this.managers.appUsersManager.hasUser(peerId))) {\r\n            return;\r\n          }\r\n\r\n          appImManager.setInnerPeer({\r\n            peerId,\r\n            lastMsgId: generateMessageId(+notificationData.custom.msg_id)\r\n          });\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public async buildNotification({message, fwdCount, peerReaction, peerTypeNotifySettings}: {\r\n    message: Message.message | Message.messageService,\r\n    fwdCount?: number,\r\n    peerReaction?: MessagePeerReaction,\r\n    peerTypeNotifySettings?: PeerNotifySettings\r\n  }) {\r\n    const peerId = message.peerId;\r\n    const isAnyChat = peerId.isAnyChat();\r\n    const notification: NotifyOptions = {};\r\n    const peerString = await this.managers.appPeersManager.getPeerString(peerId);\r\n    let notificationMessage: string;\r\n\r\n    if(peerTypeNotifySettings.show_previews) {\r\n      if(message._ === 'message' && message.fwd_from && fwdCount > 1) {\r\n        notificationMessage = I18n.format('Notifications.Forwarded', true, [fwdCount]);\r\n      } else {\r\n        notificationMessage = await wrapMessageForReply(message, undefined, undefined, true);\r\n\r\n        if(peerReaction) {\r\n          const langPackKey: LangPackKey = /* isAnyChat ? 'Notification.Group.Reacted' :  */'Notification.Contact.Reacted';\r\n          const args: FormatterArguments = [\r\n            fixEmoji(peerReaction.reaction), // can be plain heart\r\n            notificationMessage\r\n          ];\r\n  \r\n          /* if(isAnyChat) {\r\n            args.unshift(appPeersManager.getPeerTitle(message.fromId, true));\r\n          } */\r\n  \r\n          notificationMessage = I18n.format(langPackKey, true, args);\r\n        }\r\n      }\r\n    } else {\r\n      notificationMessage = I18n.format('Notifications.New', true);\r\n    }\r\n\r\n    if(peerReaction) {\r\n      notification.noIncrement = true;\r\n      notification.silent = true;\r\n    }\r\n\r\n    const notificationFromPeerId = peerReaction ? getPeerId(peerReaction.peer_id) : message.fromId;\r\n    notification.title = await getPeerTitle(peerId, true, undefined, undefined, this.managers);\r\n    if(isAnyChat && notificationFromPeerId !== message.peerId) {\r\n      notification.title = await getPeerTitle(notificationFromPeerId, true, undefined, undefined, this.managers) +\r\n        ' @ ' +\r\n        notification.title;\r\n    }\r\n\r\n    notification.title = wrapPlainText(notification.title);\r\n\r\n    notification.onclick = () => {\r\n      appImManager.setInnerPeer({peerId, lastMsgId: message.mid});\r\n    };\r\n\r\n    notification.message = notificationMessage;\r\n    notification.key = 'msg' + message.mid;\r\n    notification.tag = peerString;\r\n    notification.silent = true;//message.pFlags.silent || false;\r\n\r\n    const peerPhoto = await this.managers.appPeersManager.getPeerPhoto(peerId);\r\n    if(peerPhoto) {\r\n      this.managers.appAvatarsManager.loadAvatar(peerId, peerPhoto, 'photo_small').then((url) => {\r\n        // ! WARNING, message can be already read\r\n        if(message.pFlags.unread || peerReaction) {\r\n          notification.image = url;\r\n          this.notify(notification);\r\n        }\r\n      });\r\n    } else {\r\n      this.notify(notification);\r\n    }\r\n  }\r\n\r\n  private toggleToggler(enable = idleController.isIdle) {\r\n    if(IS_MOBILE) return;\r\n\r\n    const resetTitle = (isBlink?: boolean) => {\r\n      this.titleChanged = false;\r\n      document.title = this.titleBackup;\r\n      this.setFavicon();\r\n    };\r\n\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n\r\n    if(!enable) {\r\n      resetTitle();\r\n    } else {\r\n      this.titleInterval = window.setInterval(() => {\r\n        const count = this.notificationsCount;\r\n        if(!count) {\r\n          this.toggleToggler(false);\r\n        } else if(this.titleChanged) {\r\n          resetTitle(true);\r\n        } else {\r\n          this.titleChanged = true;\r\n          document.title = I18n.format('Notifications.Count', true, [count]);\r\n          //this.setFavicon('assets/img/favicon_unread.ico');\r\n\r\n          // fetch('assets/img/favicon.ico')\r\n          // .then((res) => res.blob())\r\n          // .then((blob) => {\r\n            // const img = document.createElement('img');\r\n            // img.src = URL.createObjectURL(blob);\r\n\r\n            const canvas = document.createElement('canvas');\r\n            canvas.width = 32 * window.devicePixelRatio;\r\n            canvas.height = canvas.width;\r\n  \r\n            const ctx = canvas.getContext('2d');\r\n            ctx.beginPath();\r\n            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, 2 * Math.PI, false);\r\n            ctx.fillStyle = '#3390ec';\r\n            ctx.fill();\r\n\r\n            let fontSize = 24;\r\n            let str = '' + count;\r\n            if(count < 10) {\r\n              fontSize = 22;\r\n            } else if(count < 100) {\r\n              fontSize = 20;\r\n            } else {\r\n              str = '99+';\r\n              fontSize = 16;\r\n            }\r\n\r\n            fontSize *= window.devicePixelRatio;\r\n            \r\n            ctx.font = `700 ${fontSize}px ${fontFamily}`;\r\n            ctx.textBaseline = 'middle';\r\n            ctx.textAlign = 'center';\r\n            ctx.fillStyle = 'white';\r\n            ctx.fillText(str, canvas.width / 2, canvas.height * .5625);\r\n\r\n            /* const ctx = canvas.getContext('2d');\r\n            ctx.drawImage(img, 0, 0, canvas.width, canvas.height); */\r\n  \r\n            this.setFavicon(canvas.toDataURL());\r\n          // });\r\n        }\r\n      }, 1000);\r\n    }\r\n  }\r\n\r\n  private setFavicon(href: string = 'assets/img/favicon.ico') {\r\n    if(this.prevFavicon === href) {\r\n      return;\r\n    }\r\n\r\n    const link = this.faviconEl.cloneNode() as HTMLLinkElement;\r\n    link.href = href;\r\n    this.faviconEl.parentNode.replaceChild(link, this.faviconEl);\r\n    this.faviconEl = link;\r\n\r\n    this.prevFavicon = href;\r\n  }\r\n\r\n  public notify(data: NotifyOptions) {\r\n    //console.log('notify', data, rootScope.idle.isIDLE, this.notificationsUiSupport, this.stopped);\r\n    \r\n    if(this.stopped) {\r\n      return;\r\n    }\r\n\r\n    // FFOS Notification blob src bug workaround\r\n    /* if(Config.Navigator.ffos && !Config.Navigator.ffos2p) {\r\n      data.image = 'https://telegram.org/img/t_logo.png'\r\n    }\r\n    else if (data.image && !angular.isString(data.image)) {\r\n      if (Config.Navigator.ffos2p) {\r\n        FileManager.getDataUrl(data.image, 'image/jpeg').then(function (url) {\r\n          data.image = url\r\n          notify(data)\r\n        })\r\n        return false\r\n      } else {\r\n        data.image = FileManager.getUrl(data.image, 'image/jpeg')\r\n      }\r\n    }\r\n    else */ if(!data.image) {\r\n      data.image = 'assets/img/logo_filled_rounded.png';\r\n    }\r\n    // console.log('notify image', data.image)\r\n\r\n    if(!data.noIncrement) {\r\n      ++this.notificationsCount;\r\n    }\r\n\r\n    if(!this.titleInterval) {\r\n      this.toggleToggler();\r\n    }\r\n\r\n    const idx = ++this.notificationIndex;\r\n    const key = data.key || 'k' + idx;\r\n    this.notificationsShown[key] = true;\r\n\r\n    const now = tsNow();\r\n    if(this.settings.volume > 0 && !this.settings.nosound/* &&\r\n      (\r\n        !data.tag ||\r\n        !this.soundsPlayed[data.tag] ||\r\n        now > this.soundsPlayed[data.tag] + 60000\r\n      ) */\r\n    ) {\r\n      this.testSound(this.settings.volume);\r\n      this.soundsPlayed[data.tag] = now;\r\n    }\r\n\r\n    if(!this.notificationsUiSupport ||\r\n      'Notification' in window && Notification.permission !== 'granted') {\r\n      return false;\r\n    }\r\n\r\n    if(this.settings.nodesktop) {\r\n      if(this.vibrateSupport && !this.settings.novibrate) {\r\n        navigator.vibrate([200, 100, 200]);\r\n        return;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    let notification: MyNotification;\r\n\r\n    if('Notification' in window) {\r\n      try {\r\n        if(data.tag) {\r\n          for(let i in this.notificationsShown) {\r\n            const notification = this.notificationsShown[i];\r\n            if(typeof(notification) !== 'boolean' && notification.tag === data.tag) {\r\n              notification.hidden = true;\r\n            }\r\n          }\r\n        }\r\n\r\n        notification = new Notification(data.title, {\r\n          icon: data.image || '',\r\n          body: data.message || '',\r\n          tag: data.tag || '',\r\n          silent: data.silent || false\r\n        });\r\n\r\n        //console.log('notify constructed notification');\r\n      } catch(e) {\r\n        this.notificationsUiSupport = false;\r\n        webPushApiManager.setLocalNotificationsDisabled();\r\n        return;\r\n      }\r\n    } /* else if('mozNotification' in navigator) {\r\n      notification = navigator.mozNotification.createNotification(data.title, data.message || '', data.image || '')\r\n    } else if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n      window.external.msSiteModeSetIconOverlay('img/icons/icon16.png', data.title)\r\n      window.external.msSiteModeActivate()\r\n      notification = {\r\n        index: idx\r\n      }\r\n    } */ else {\r\n      return;\r\n    }\r\n\r\n    notification.onclick = () => {\r\n      notification.close();\r\n      appRuntimeManager.focus();\r\n      this.clear();\r\n      if(data.onclick) {\r\n        data.onclick();\r\n      }\r\n    };\r\n\r\n    notification.onclose = () => {\r\n      if(!notification.hidden) {\r\n        delete this.notificationsShown[key];\r\n        this.clear();\r\n      }\r\n    };\r\n\r\n    if(notification.show) {\r\n      notification.show();\r\n    }\r\n    this.notificationsShown[key] = notification;\r\n\r\n    if(!IS_MOBILE) {\r\n      setTimeout(() => {\r\n        this.hide(key);\r\n      }, 8000);\r\n    }\r\n  }\r\n\r\n  public updateLocalSettings = () => {\r\n    const keys = ['notify_nodesktop', 'notify_volume', 'notify_novibrate', 'notify_nopreview', 'notify_nopush'];\r\n    const promises = keys.map(() => undefined);\r\n    // const promises = keys.map((k) => stateStorage.get(k as any));\r\n    Promise.all(promises)\r\n    .then((updSettings) => {\r\n      this.settings.nodesktop = updSettings[0];\r\n      this.settings.volume = updSettings[1] === undefined ? 0.5 : updSettings[1];\r\n      this.settings.novibrate = updSettings[2];\r\n      this.settings.nopreview = updSettings[3];\r\n      this.settings.nopush = updSettings[4];\r\n\r\n      if(this.pushInited) {\r\n        const needPush = !this.settings.nopush && !this.settings.nodesktop && webPushApiManager.isAvailable || false;\r\n        const hasPush = this.registeredDevice !== false;\r\n        if(needPush !== hasPush) {\r\n          if(needPush) {\r\n            webPushApiManager.subscribe();\r\n          } else {\r\n            webPushApiManager.unsubscribe();\r\n          }\r\n        }\r\n      }\r\n\r\n      webPushApiManager.setSettings(this.settings);\r\n    });\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      this.settings.nosound = !state.settings.notifications.sound;\r\n    });\r\n  }\r\n\r\n  public getLocalSettings() {\r\n    return this.settings;\r\n  }\r\n\r\n  private hide(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification && typeof(notification) !== 'boolean') {\r\n      try {\r\n        if(notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }\r\n      } catch(e) {}\r\n    }\r\n  }\r\n\r\n  public soundReset(tag: string) {\r\n    delete this.soundsPlayed[tag];\r\n  }\r\n\r\n  private requestPermission = () => {\r\n    Notification.requestPermission();\r\n    window.removeEventListener('click', this.requestPermission);\r\n  };\r\n\r\n  public testSound(volume: number) {\r\n    const now = tsNow();\r\n    if(this.nextSoundAt && now < this.nextSoundAt && this.prevSoundVolume === volume) {\r\n      return;\r\n    }\r\n\r\n    this.nextSoundAt = now + 1000;\r\n    this.prevSoundVolume = volume;\r\n    const filename = 'assets/audio/notification.mp3';\r\n    const audio = document.createElement('audio');\r\n    audio.autoplay = true;\r\n    audio.setAttribute('mozaudiochannel', 'notification');\r\n    audio.volume = volume;\r\n    audio.innerHTML = `\r\n      <source src=\"${filename}\" type=\"audio/mpeg\" />\r\n      <embed hidden=\"true\" autostart=\"true\" loop=\"false\" volume=\"${volume * 100}\" src=\"${filename}\" />\r\n    `;\r\n    this.notifySoundEl.append(audio);\r\n\r\n    audio.addEventListener('ended', () => {\r\n      audio.remove();\r\n    }, {once: true});\r\n  }\r\n\r\n  public cancel(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification) {\r\n      if(this.notificationsCount > 0) {\r\n        --this.notificationsCount;\r\n      }\r\n\r\n      try {\r\n        if(typeof(notification) !== 'boolean' && notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }/*  else if(notificationsMsSiteMode &&\r\n          notification.index === notificationIndex) {\r\n          window.external.msSiteModeClearIconOverlay()\r\n        } */\r\n      } catch(e) {}\r\n\r\n      delete this.notificationsShown[key];\r\n    }\r\n  }\r\n\r\n  public clear() {\r\n    /* if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n    } else { */\r\n      for(const i in this.notificationsShown) {\r\n        const notification = this.notificationsShown[i];\r\n        try {\r\n          if(typeof(notification) !== 'boolean' && notification.close) {\r\n            notification.close();\r\n          }\r\n        } catch(e) {}\r\n      }\r\n    /* } */\r\n    this.notificationsShown = {};\r\n    this.notificationsCount = 0;\r\n\r\n    webPushApiManager.hidePushNotifications();\r\n  }\r\n\r\n  public start() {\r\n    this.updateLocalSettings();\r\n    rootScope.addEventListener('settings_updated', this.updateLocalSettings);\r\n    webPushApiManager.start();\r\n\r\n    if(!this.notificationsUiSupport) {\r\n      return false;\r\n    }\r\n\r\n    if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {\r\n      window.addEventListener('click', this.requestPermission);\r\n    }\r\n\r\n    try {\r\n      if('onbeforeunload' in window) {\r\n        window.addEventListener('beforeunload', this.clear);\r\n      }\r\n    } catch(e) {}\r\n  }\r\n\r\n  private stop() {\r\n    this.clear();\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n    this.setFavicon();\r\n    this.stopped = true;\r\n  }\r\n\r\n  private registerDevice(tokenData: PushSubscriptionNotify) {\r\n    if(this.registeredDevice && deepEqual(this.registeredDevice, tokenData)) {\r\n      return false;\r\n    }\r\n\r\n    this.managers.apiManager.invokeApi('account.registerDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: [],\r\n      app_sandbox: false,\r\n      secret: new Uint8Array()\r\n    }).then(() => {\r\n      this.registeredDevice = tokenData;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n\r\n  private unregisterDevice(tokenData: PushSubscriptionNotify) {\r\n    if(!this.registeredDevice) {\r\n      return false;\r\n    }\r\n\r\n    this.managers.apiManager.invokeApi('account.unregisterDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: []\r\n    }).then(() => {\r\n      this.registeredDevice = false;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n}\r\n\r\nconst uiNotificationsManager = new UiNotificationsManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.uiNotificationsManager = uiNotificationsManager);\r\nexport default uiNotificationsManager;\r\n","export default async function getFilesFromEvent(e: ClipboardEvent | DragEvent, onlyTypes = false): Promise<any[]> {\r\n  const files: any[] = [];\r\n\r\n  const scanFiles = async(entry: any, item: DataTransferItem) => {\r\n    if(entry.isDirectory) {\r\n      const directoryReader = entry.createReader();\r\n      await new Promise<void>((resolve, reject) => {\r\n        directoryReader.readEntries(async(entries: any) => {\r\n          for(const entry of entries) {\r\n            await scanFiles(entry, item);\r\n          }\r\n\r\n          resolve();\r\n        });\r\n      });\r\n    } else if(entry) {\r\n      if(onlyTypes) {\r\n        files.push(entry.type);\r\n      } else {\r\n        const itemFile = item.getAsFile(); // * Safari can't handle entry.file with pasting\r\n        const file = entry instanceof File ? \r\n          entry : \r\n          (\r\n            entry instanceof DataTransferItem ? \r\n              entry.getAsFile() : \r\n              await new Promise((resolve, reject) => entry.file(resolve, (err: any) => resolve(itemFile)))\r\n          );\r\n\r\n        /* if(!onlyTypes) {\r\n          console.log('getFilesFromEvent: got file', item, file);\r\n        } */\r\n\r\n        if(!file) return;\r\n        files.push(file);\r\n      }\r\n    }\r\n  };\r\n\r\n  if(e instanceof DragEvent && e.dataTransfer.files && !e.dataTransfer.items) {\r\n    for(let i = 0; i < e.dataTransfer.files.length; i++) {\r\n      const file = e.dataTransfer.files[i];\r\n      files.push(onlyTypes ? file.type : file);\r\n    }\r\n  } else {\r\n    // @ts-ignore\r\n    const items = (e.dataTransfer || e.clipboardData || e.originalEvent.clipboardData).items;\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(let i = 0; i < items.length; ++i) {\r\n      const item: DataTransferItem = items[i];\r\n      if(item.kind === 'file') {\r\n        const entry = (onlyTypes ? item : item.webkitGetAsEntry()) || item.getAsFile();\r\n        promises.push(scanFiles(entry, item));\r\n      }\r\n    }\r\n    \r\n    await Promise.all(promises);\r\n  }\r\n\r\n  /* if(!onlyTypes) {\r\n    console.log('getFilesFromEvent: got files:', e, files);\r\n  } */\r\n  \r\n  return files;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport animationIntersector from '../../components/animationIntersector';\r\nimport appSidebarLeft, { LEFT_COLUMN_ACTIVE_CLASSNAME } from \"../../components/sidebarLeft\";\r\nimport appSidebarRight, { RIGHT_COLUMN_ACTIVE_CLASSNAME } from '../../components/sidebarRight';\r\nimport mediaSizes, { ScreenSize } from '../../helpers/mediaSizes';\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport rootScope from '../rootScope';\r\nimport Chat, { ChatType } from '../../components/chat/chat';\r\nimport PopupNewMedia, { getCurrentNewMediaPopup } from '../../components/popups/newMedia';\r\nimport MarkupTooltip from '../../components/chat/markupTooltip';\r\nimport IS_TOUCH_SUPPORTED from '../../environment/touchSupport';\r\nimport SetTransition from '../../components/singleTransition';\r\nimport ChatDragAndDrop from '../../components/chat/dragAndDrop';\r\nimport { doubleRaf } from '../../helpers/schedulers';\r\nimport lottieLoader from '../rlottie/lottieLoader';\r\nimport useHeavyAnimationCheck, { dispatchHeavyAnimationEvent } from '../../hooks/useHeavyAnimationCheck';\r\nimport stateStorage from '../stateStorage';\r\nimport { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport appNavigationController from '../../components/appNavigationController';\r\nimport AppPrivateSearchTab from '../../components/sidebarRight/tabs/search';\r\nimport I18n, { i18n, join, LangPackKey } from '../langPack';\r\nimport { ChatFull, ChatInvite, ChatParticipant, ChatParticipants, SendMessageAction } from '../../layer';\r\nimport { hslaStringToHex } from '../../helpers/color';\r\nimport PeerTitle from '../../components/peerTitle';\r\nimport PopupPeer from '../../components/popups/peer';\r\nimport blurActiveElement from '../../helpers/dom/blurActiveElement';\r\nimport cancelEvent from '../../helpers/dom/cancelEvent';\r\nimport disableTransition from '../../helpers/dom/disableTransition';\r\nimport placeCaretAtEnd from '../../helpers/dom/placeCaretAtEnd';\r\nimport replaceContent from '../../helpers/dom/replaceContent';\r\nimport whichChild from '../../helpers/dom/whichChild';\r\nimport PopupElement from '../../components/popups';\r\nimport singleInstance, { InstanceDeactivateReason, SingleInstance } from '../mtproto/singleInstance';\r\nimport PopupStickers from '../../components/popups/stickers';\r\nimport PopupJoinChatInvite from '../../components/popups/joinChatInvite';\r\nimport { toast, toastNew } from '../../components/toast';\r\nimport debounce from '../../helpers/schedulers/debounce';\r\nimport pause from '../../helpers/schedulers/pause';\r\nimport { InternalLink, InternalLinkTypeMap, INTERNAL_LINK_TYPE } from './internalLink';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport { NULL_PEER_ID } from '../mtproto/mtproto_config';\r\nimport telegramMeWebManager from '../mtproto/telegramMeWebManager';\r\nimport { ONE_DAY } from '../../helpers/date';\r\nimport type { GroupCallId, MyGroupCall } from './appGroupCallsManager';\r\nimport TopbarCall from '../../components/topbarCall';\r\nimport confirmationPopup from '../../components/confirmationPopup';\r\nimport IS_GROUP_CALL_SUPPORTED from '../../environment/groupCallSupport';\r\nimport IS_CALL_SUPPORTED from '../../environment/callSupport';\r\nimport { CallType } from '../calls/types';\r\nimport { Modify, SendMessageEmojiInteractionData } from '../../types';\r\nimport htmlToSpan from '../../helpers/dom/htmlToSpan';\r\nimport getVisibleRect from '../../helpers/dom/getVisibleRect';\r\nimport { simulateClickEvent } from '../../helpers/dom/clickEvent';\r\nimport PopupCall from '../../components/call';\r\nimport copy from '../../helpers/object/copy';\r\nimport getObjectKeysAndSort from '../../helpers/object/getObjectKeysAndSort';\r\nimport type GroupCallInstance from '../calls/groupCallInstance';\r\nimport type CallInstance from '../calls/callInstance';\r\nimport numberThousandSplitter from '../../helpers/number/numberThousandSplitter';\r\nimport ChatBackgroundPatternRenderer from '../../components/chat/patternRenderer';\r\nimport { IS_FIREFOX } from '../../environment/userAgent';\r\nimport compareVersion from '../../helpers/compareVersion';\r\nimport { AppManagers } from './managers';\r\nimport uiNotificationsManager from './uiNotificationsManager';\r\nimport appMediaPlaybackController from '../../components/appMediaPlaybackController';\r\nimport { PHONE_NUMBER_REG_EXP } from '../richTextProcessor';\r\nimport wrapEmojiText from '../richTextProcessor/wrapEmojiText';\r\nimport wrapRichText from '../richTextProcessor/wrapRichText';\r\nimport wrapUrl from '../richTextProcessor/wrapUrl';\r\nimport generateMessageId from './utils/messageId/generateMessageId';\r\nimport getUserStatusString from '../../components/wrappers/getUserStatusString';\r\nimport getChatMembersString from '../../components/wrappers/getChatMembersString';\r\nimport { STATE_INIT } from '../../config/state';\r\nimport CacheStorageController from '../cacheStorage';\r\nimport themeController from '../../helpers/themeController';\r\nimport overlayCounter from '../../helpers/overlayCounter';\r\nimport appDialogsManager from './appDialogsManager';\r\nimport idleController from '../../helpers/idleController';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport { AckedResult } from '../mtproto/superMessagePort';\r\nimport groupCallsController from '../calls/groupCallsController';\r\nimport callsController from '../calls/callsController';\r\nimport getFilesFromEvent from '../../helpers/files/getFilesFromEvent';\r\nimport apiManagerProxy from '../mtproto/mtprotoworker';\r\nimport wrapPeerTitle from '../../components/wrappers/peerTitle';\r\nimport appRuntimeManager from './appRuntimeManager';\r\n\r\nexport const CHAT_ANIMATION_GROUP = 'chat';\r\n\r\nexport type ChatSavedPosition = {\r\n  mids: number[], \r\n  top: number\r\n};\r\n\r\nexport type ChatSetPeerOptions = {\r\n  peerId?: PeerId, \r\n  lastMsgId?: number, \r\n  threadId?: number,\r\n  startParam?: string\r\n};\r\n\r\nexport type ChatSetInnerPeerOptions = Modify<ChatSetPeerOptions, {\r\n  peerId: PeerId\r\n}> & {\r\n  type?: ChatType\r\n};\r\n\r\nexport class AppImManager extends EventListenerBase<{\r\n  chat_changing: (details: {from: Chat, to: Chat}) => void,\r\n  peer_changed: (peerId: PeerId) => void,\r\n  peer_changing: (chat: Chat) => void,\r\n}> {\r\n  public columnEl = document.getElementById('column-center') as HTMLDivElement;\r\n  public chatsContainer: HTMLElement;\r\n\r\n  public offline = false;\r\n  public updateStatusInterval = 0;\r\n\r\n  public log: ReturnType<typeof logger>;\r\n\r\n  public setPeerPromise: Promise<void> = null;\r\n\r\n  public tabId = -1;\r\n  \r\n  public chats: Chat[] = [];\r\n  private prevTab: HTMLElement;\r\n  private chatsSelectTabDebounced: () => void;\r\n  \r\n  public markupTooltip: MarkupTooltip;\r\n  private backgroundPromises: {[slug: string]: Promise<string>};\r\n  \r\n  private topbarCall: TopbarCall;\r\n  public emojiAnimationContainer: HTMLDivElement;\r\n\r\n  private lastBackgroundUrl: string;\r\n\r\n  public managers: AppManagers;\r\n  \r\n  public cacheStorage = new CacheStorageController('cachedFiles');\r\n\r\n  get myId() {\r\n    return rootScope.myId;\r\n  }\r\n\r\n  get chat(): Chat {\r\n    return this.chats[this.chats.length - 1];\r\n  }\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    const {\r\n      apiUpdatesManager\r\n    } = managers;\r\n    apiUpdatesManager.attach(I18n.lastRequestedLangCode);\r\n    \r\n    appMediaPlaybackController.construct(managers);\r\n    uiNotificationsManager.construct(managers);\r\n    // uiNotificationsManager.start();\r\n\r\n    this.log = logger('IM', LogTypes.Log | LogTypes.Warn | LogTypes.Debug | LogTypes.Error);\r\n\r\n    this.backgroundPromises = {};\r\n    STATE_INIT.settings.themes.forEach((theme) => {\r\n      if(theme.background.slug) {\r\n        const url = 'assets/img/' + theme.background.slug + '.svg' + (IS_FIREFOX ? '?1' : '');\r\n        this.backgroundPromises[theme.background.slug] = Promise.resolve(url);\r\n      }\r\n    });\r\n\r\n    this.selectTab(0);\r\n\r\n    idleController.addEventListener('change', (idle) => {\r\n      this.offline = idle;\r\n      this.updateStatus();\r\n      if(idle) {\r\n        clearInterval(this.updateStatusInterval);\r\n      } else {\r\n        this.updateStatusInterval = window.setInterval(() => this.updateStatus(), 50e3);\r\n      }\r\n    });\r\n    \r\n    this.chatsContainer = document.createElement('div');\r\n    this.chatsContainer.classList.add('chats-container', 'tabs-container');\r\n    this.chatsContainer.dataset.animation = 'navigation';\r\n\r\n    this.emojiAnimationContainer = document.createElement('div');\r\n    this.emojiAnimationContainer.classList.add('emoji-animation-container');\r\n    this.appendEmojiAnimationContainer(mediaSizes.activeScreen);\r\n\r\n    this.columnEl.append(this.chatsContainer);\r\n    \r\n    this.createNewChat();\r\n    this.chatsSelectTab(this.chat.container);\r\n\r\n    appNavigationController.onHashChange = this.onHashChange;\r\n    //window.addEventListener('hashchange', this.onHashChange);\r\n\r\n    this.setSettings();\r\n    rootScope.addEventListener('settings_updated', this.setSettings);\r\n\r\n    useHeavyAnimationCheck(() => {\r\n      animationIntersector.setOnlyOnePlayableGroup('lock');\r\n      animationIntersector.checkAnimations(true);\r\n    }, () => {\r\n      animationIntersector.setOnlyOnePlayableGroup('');\r\n      animationIntersector.checkAnimations(false);\r\n    });\r\n\r\n    if(IS_FIREFOX && apiManagerProxy.oldVersion && compareVersion(apiManagerProxy.oldVersion, '1.4.3') === -1) {\r\n      this.deleteFilesIterative((response) => {\r\n        return response.headers.get('Content-Type') === 'image/svg+xml';\r\n      }).then(() => {\r\n        this.applyCurrentTheme();\r\n      });\r\n    } else {\r\n      this.applyCurrentTheme();\r\n    }\r\n\r\n    // * fix simultaneous opened both sidebars, can happen when floating sidebar is opened with left sidebar\r\n    mediaSizes.addEventListener('changeScreen', (from, to) => {\r\n      if(document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME) \r\n        && document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME)) {\r\n        appSidebarRight.toggleSidebar(false);\r\n      }\r\n\r\n      this.appendEmojiAnimationContainer(to);\r\n    });\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      // const perf = performance.now();\r\n      const rect = this.chatsContainer.getBoundingClientRect();\r\n      ChatBackgroundPatternRenderer.resizeInstances(rect.width, rect.height).then(() => {\r\n        // this.log.warn('resize bg time:', performance.now() - perf);\r\n        // for(const chat of this.chats) {\r\n        //   if(chat.renderDarkPattern) {\r\n        //     chat.renderDarkPattern();\r\n        //   }\r\n        // }\r\n      });\r\n    });\r\n\r\n    this.addEventListener('peer_changing', (chat) => {\r\n      this.saveChatPosition(chat);\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      this.applyCurrentTheme();\r\n    });\r\n\r\n    rootScope.addEventListener('choosing_sticker', (choosing) => {\r\n      this.setChoosingStickerTyping(!choosing);\r\n    });\r\n\r\n    rootScope.addEventListener('peer_typings', ({peerId, typings}) => {\r\n      const chat = this.chat;\r\n      if(\r\n        !chat || \r\n        chat.peerId !== peerId || \r\n        overlayCounter.isOverlayActive || (\r\n          mediaSizes.activeScreen === ScreenSize.mobile && \r\n          this.tabId !== 1\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      const typing = typings.find((typing) => typing.action._ === 'sendMessageEmojiInteraction');\r\n      if(typing?.action?._ === 'sendMessageEmojiInteraction') {\r\n        const action = typing.action;\r\n        const bubble = chat.bubbles.bubbles[generateMessageId(typing.action.msg_id)];\r\n        if(bubble && bubble.classList.contains('emoji-big') && bubble.classList.contains('sticker') && getVisibleRect(bubble, chat.bubbles.scrollable.container)) {\r\n          const stickerWrapper: HTMLElement = bubble.querySelector('.media-sticker-wrapper:not(.bubble-hover-reaction-sticker):not(.reaction-sticker)');\r\n\r\n          const data: SendMessageEmojiInteractionData = JSON.parse(action.interaction.data);\r\n          data.a.forEach((a) => {\r\n            setTimeout(() => {\r\n              simulateClickEvent(stickerWrapper);\r\n            }, a.t * 1000);\r\n          });\r\n          \r\n          this.managers.appMessagesManager.setTyping(peerId, {\r\n            _: 'sendMessageEmojiInteractionSeen',\r\n            emoticon: action.emoticon\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    const onInstanceDeactivated = (reason: InstanceDeactivateReason) => {\r\n      const isUpdated = reason === 'version';\r\n      const popup = new PopupElement('popup-instance-deactivated', undefined, {overlayClosable: true});\r\n      const c = document.createElement('div');\r\n      c.classList.add('instance-deactivated-container');\r\n      (popup as any).container.replaceWith(c);\r\n\r\n      const header = document.createElement('div');\r\n      header.classList.add('header');\r\n      header.append(i18n(isUpdated ? 'Deactivated.Version.Title' : 'Deactivated.Title'));\r\n\r\n      const subtitle = document.createElement('div');\r\n      subtitle.classList.add('subtitle');\r\n      subtitle.append(i18n(isUpdated ? 'Deactivated.Version.Subtitle' : 'Deactivated.Subtitle'));\r\n\r\n      c.append(header, subtitle);\r\n\r\n      document.body.classList.add('deactivated');\r\n\r\n      const onClose = isUpdated ? () => {\r\n        appRuntimeManager.reload();\r\n      } : () => {\r\n        document.body.classList.add('deactivated-backwards');\r\n\r\n        singleInstance.activateInstance();\r\n\r\n        setTimeout(() => {\r\n          document.body.classList.remove('deactivated', 'deactivated-backwards');\r\n        }, 333);\r\n      };\r\n\r\n      popup.addEventListener('close', onClose);\r\n      popup.show();\r\n    };\r\n\r\n    singleInstance.addEventListener('deactivated', onInstanceDeactivated);\r\n    if(singleInstance.deactivatedReason) {\r\n      onInstanceDeactivated(singleInstance.deactivatedReason);\r\n    }\r\n\r\n    // remove scroll listener when setting chat to tray\r\n    this.addEventListener('chat_changing', ({to}) => {\r\n      this.toggleChatGradientAnimation(to);\r\n    });\r\n\r\n    rootScope.addEventListener('service_notification', (update) => {\r\n      confirmationPopup({\r\n        button: {langKey: 'OK', isCancel: true},\r\n        description: wrapRichText(update.message)\r\n      });\r\n    });\r\n    \r\n    apiManagerProxy.addEventListener('notificationBuild', (options) => {\r\n      if(this.chat.peerId === options.message.peerId && !idleController.isIdle) {\r\n        return;\r\n      }\r\n      \r\n      uiNotificationsManager.buildNotification(options);\r\n    });\r\n\r\n    this.addEventListener('peer_changed', async(peerId) => {\r\n      document.body.classList.toggle('has-chat', !!peerId);\r\n\r\n      let str: string;\r\n      if(peerId) {\r\n        const username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n        str = username ? '@' + username : '' + peerId;\r\n      }\r\n\r\n      appNavigationController.overrideHash(str);\r\n\r\n      apiManagerProxy.updateTabState('chatPeerIds', this.chats.map((chat) => chat.peerId).filter(Boolean));\r\n    });\r\n\r\n    // stateStorage.get('chatPositions').then((c) => {\r\n      stateStorage.setToCache('chatPositions', /* c ||  */{});\r\n    // });\r\n\r\n    if(IS_CALL_SUPPORTED || IS_GROUP_CALL_SUPPORTED) {\r\n      this.topbarCall = new TopbarCall(managers);\r\n    }\r\n\r\n    if(IS_CALL_SUPPORTED) {\r\n      callsController.addEventListener('instance', ({instance/* , hasCurrent */}) => {\r\n        // if(hasCurrent) {\r\n          // return;\r\n        // }\r\n        \r\n        const popup = new PopupCall(instance);\r\n\r\n        instance.addEventListener('acceptCallOverride', () => {\r\n          return this.discardCurrentCall(instance.interlocutorUserId.toPeerId(), undefined, instance)\r\n          .then(() => {\r\n            callsController.dispatchEvent('accepting', instance);\r\n            return true;\r\n          })\r\n          .catch(() => false);\r\n        });\r\n\r\n        popup.addEventListener('close', () => {\r\n          const currentCall = callsController.currentCall;\r\n          if(currentCall && currentCall !== instance && !instance.wasTryingToJoin) {\r\n            instance.hangUp('phoneCallDiscardReasonBusy');\r\n          }\r\n        }, {once: true});\r\n\r\n        popup.show();\r\n      });\r\n\r\n      callsController.addEventListener('incompatible', (userId) => {\r\n        toastNew({\r\n          langPackKey: 'VoipPeerIncompatible', \r\n          langPackArguments: [\r\n            new PeerTitle({peerId: userId.toPeerId()}).element\r\n          ]\r\n        });\r\n      });\r\n    }\r\n\r\n    // ! do not remove this line \r\n    // ! instance can be deactivated before the UI starts, because it waits in background for RAF that is delayed\r\n    singleInstance.activateInstance();\r\n\r\n    const setAuthorized = () => {\r\n      telegramMeWebManager.setAuthorized(true);\r\n    };\r\n\r\n    setInterval(setAuthorized, ONE_DAY);\r\n    setAuthorized();\r\n\r\n    this.addAnchorListener<{}>({\r\n      name: 'showMaskedAlert', \r\n      callback: (params, element) => {\r\n        const href = element.href;\r\n\r\n        const a = element.cloneNode(true) as HTMLAnchorElement;\r\n        a.className = 'anchor-url';\r\n        a.innerText = href;\r\n        a.removeAttribute('onclick');\r\n\r\n        new PopupPeer('popup-masked-url', {\r\n          titleLangKey: 'OpenUrlTitle',\r\n          descriptionLangKey: 'OpenUrlAlert2',\r\n          descriptionLangArgs: [a],\r\n          buttons: [{\r\n            langKey: 'Open',\r\n            callback: () => {\r\n              a.click();\r\n            },\r\n          }]\r\n        }).show();\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{uriParams: {command: string, bot: string}}>({\r\n      name: 'execBotCommand', \r\n      callback: ({uriParams}) => {\r\n        const {command, bot} = uriParams;\r\n\r\n        /* const promise = bot ? this.openUsername(bot).then(() => this.chat.peerId) : Promise.resolve(this.chat.peerId);\r\n        promise.then((peerId) => {\r\n          this.managers.appMessagesManager.sendText(peerId, '/' + command);\r\n        }); */\r\n\r\n        this.managers.appMessagesManager.sendText(this.chat.peerId, '/' + command + (bot ? '@' + bot : ''));\r\n\r\n        //console.log(command, bot);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{uriParams: {hashtag: string}}>({\r\n      name: 'searchByHashtag', \r\n      callback: ({uriParams}) => {\r\n        const {hashtag} = uriParams;\r\n        if(!hashtag) {\r\n          return;\r\n        }\r\n\r\n        this.chat.initSearch('#' + hashtag + ' ');\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{pathnameParams: ['addstickers', string]}>({\r\n      name: 'addstickers', \r\n      callback: ({pathnameParams}) => {\r\n        const link: InternalLink = {\r\n          _: INTERNAL_LINK_TYPE.STICKER_SET,\r\n          set: pathnameParams[1]\r\n        };\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    // Support old t.me/joinchat/asd and new t.me/+asd\r\n    this.addAnchorListener<{pathnameParams: ['joinchat', string]}>({\r\n      name: 'joinchat', \r\n      callback: ({pathnameParams}) => {\r\n        const link: InternalLink = {\r\n          _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n          invite: pathnameParams[1] || decodeURIComponent(pathnameParams[0]).slice(1)\r\n        };\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    if(IS_GROUP_CALL_SUPPORTED) {\r\n      this.addAnchorListener<{\r\n        uriParams: Omit<InternalLink.InternalLinkVoiceChat, '_'>\r\n      }>({\r\n        name: 'voicechat',\r\n        protocol: 'tg',\r\n        callback: ({uriParams}) => {\r\n          const link = this.makeLink(INTERNAL_LINK_TYPE.VOICE_CHAT, uriParams);\r\n          this.processInternalLink(link);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.addAnchorListener<{\r\n    //   pathnameParams: ['c', string, string],\r\n    //   uriParams: {thread?: number}\r\n    // } | {\r\n    //   pathnameParams: [string, string?],\r\n    //   uriParams: {comment?: number}\r\n      pathnameParams: ['c', string, string] | [string, string?],\r\n      uriParams: {thread?: string, comment?: string} | {comment?: string, start?: string}\r\n    }>({\r\n      name: 'im',\r\n      callback: async({pathnameParams, uriParams}) => {\r\n        let link: InternalLink;\r\n        if(PHONE_NUMBER_REG_EXP.test(pathnameParams[0])) {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.USER_PHONE_NUMBER,\r\n            phone: pathnameParams[0].slice(1)\r\n          };\r\n        } else if(pathnameParams[0] === 'c') {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.PRIVATE_POST,\r\n            channel: pathnameParams[1],\r\n            post: pathnameParams[2],\r\n            thread: 'thread' in uriParams && uriParams.thread,\r\n            comment: uriParams.comment\r\n          };\r\n        } else {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.MESSAGE,\r\n            domain: pathnameParams[0],\r\n            post: pathnameParams[1],\r\n            comment: uriParams.comment,\r\n            start: 'start' in uriParams ? uriParams.start : undefined\r\n          };\r\n        }\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        domain: string,\r\n\r\n        // telegrampassport\r\n        scope?: string,\r\n        nonce?: string,\r\n        payload?: string,\r\n        bot_id?: string,\r\n        public_key?: string,\r\n        callback_url?: string,\r\n\r\n        // regular\r\n        start?: string,\r\n        startgroup?: string,\r\n        game?: string,\r\n        voicechat?: string,\r\n        post?: string,\r\n        thread?: string,\r\n        comment?: string,\r\n        phone?: string\r\n      }\r\n    }>({\r\n      name: 'resolve',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        let link: InternalLink;\r\n        if(uriParams.phone) {\r\n          link = this.makeLink(INTERNAL_LINK_TYPE.USER_PHONE_NUMBER, uriParams as Required<typeof uriParams>);\r\n        } else if(uriParams.domain === 'telegrampassport') {\r\n\r\n        } else {\r\n          link = this.makeLink(INTERNAL_LINK_TYPE.MESSAGE, uriParams);\r\n        }\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        channel: string,\r\n        post: string,\r\n        thread?: string,\r\n        comment?: string\r\n      }\r\n    }>({\r\n      name: 'privatepost',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        const link = this.makeLink(INTERNAL_LINK_TYPE.PRIVATE_POST, uriParams);\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        set: string\r\n      }\r\n    }>({\r\n      name: 'addstickers',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        const link = this.makeLink(INTERNAL_LINK_TYPE.STICKER_SET, uriParams);\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    ['joinchat' as const, 'join' as const].forEach((name) => {\r\n      this.addAnchorListener<{\r\n        uriParams: {\r\n          invite: string\r\n        }\r\n      }>({\r\n        name,\r\n        protocol: 'tg',\r\n        callback: ({uriParams}) => {\r\n          const link = this.makeLink(INTERNAL_LINK_TYPE.JOIN_CHAT, uriParams);\r\n          this.processInternalLink(link);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.onHashChange(true);\r\n    this.attachKeydownListener();\r\n  }\r\n\r\n  private deleteFilesIterative(callback: (response: Response) => boolean) {\r\n    return this.cacheStorage.timeoutOperation((cache) => {\r\n      const perf = performance.now();\r\n      return cache.keys().then((requests) => {\r\n        const promises = requests.map((request) => {\r\n          return cache.match(request).then((response) => {\r\n            return callback(response);\r\n          });\r\n        });\r\n\r\n        return Promise.all(promises).then((values) => {\r\n          values.map((isBad, idx) => {\r\n            if(!isBad) {\r\n              return;\r\n            }\r\n\r\n            const request = requests[idx];\r\n            return cache.delete(request);\r\n          });\r\n\r\n          return Promise.all(values.filter(Boolean));\r\n        });\r\n      }).then(() => {\r\n        this.log('deleted files', performance.now() - perf);\r\n      });\r\n    });\r\n  }\r\n\r\n  private toggleChatGradientAnimation(activatingChat: Chat) {\r\n    this.chats.forEach((chat) => {\r\n      if(chat.gradientRenderer) {\r\n        chat.gradientRenderer.scrollAnimate(rootScope.settings.animationsEnabled && chat === activatingChat);\r\n      }\r\n    });\r\n  }\r\n\r\n  private appendEmojiAnimationContainer(screen: ScreenSize) {\r\n    const appendTo = screen === ScreenSize.mobile ? this.columnEl : document.body;\r\n    if(this.emojiAnimationContainer.parentElement !== appendTo) {\r\n      appendTo.append(this.emojiAnimationContainer)\r\n    }\r\n  }\r\n\r\n  private attachKeydownListener() {\r\n    const IGNORE_KEYS = new Set(['PageUp', 'PageDown', 'Meta', 'Control']);\r\n    const onKeyDown = (e: KeyboardEvent) => {\r\n      const key = e.key;\r\n      if(overlayCounter.isOverlayActive || IGNORE_KEYS.has(key)) return;\r\n      \r\n      const target = e.target as HTMLElement;\r\n      \r\n      //if(target.tagName === 'INPUT') return;\r\n      \r\n      //this.log('onkeydown', e, document.activeElement);\r\n\r\n      const chat = this.chat;\r\n\r\n      if(e.code === 'KeyC' && (e.ctrlKey || e.metaKey) && target.tagName !== 'INPUT') {\r\n        return;\r\n      } else if(e.altKey && (key === 'ArrowUp' || key === 'ArrowDown')) {\r\n        cancelEvent(e);\r\n        this.managers.dialogsStorage.getNextDialog(this.chat.peerId, key === 'ArrowDown', appDialogsManager.filterId).then((dialog) => {\r\n          if(dialog) {\r\n            this.setPeer({peerId: dialog.peerId});\r\n          }\r\n        });\r\n      } else if(key === 'ArrowUp' && this.chat.type !== 'scheduled') {\r\n        if(!chat.input.editMsgId && chat.input.isInputEmpty()) {\r\n          this.managers.appMessagesManager.getFirstMessageToEdit(chat.peerId, chat.threadId).then((message) => {\r\n            if(message) {\r\n              chat.input.initMessageEditing(message.mid);\r\n              cancelEvent(e); // * prevent from scrolling\r\n            }\r\n          });\r\n        } else {\r\n          return;\r\n        }\r\n      } else if(key === 'ArrowDown') {\r\n        return;\r\n      }\r\n      \r\n      if(\r\n        chat?.input?.messageInput && \r\n        e.target !== chat.input.messageInput && \r\n        target.tagName !== 'INPUT' && \r\n        !target.hasAttribute('contenteditable') && \r\n        !IS_TOUCH_SUPPORTED && \r\n        (!mediaSizes.isMobile || this.tabId === 1) && \r\n        !chat.selection.isSelecting && \r\n        !chat.input.recording\r\n      ) {\r\n        chat.input.messageInput.focus();\r\n        placeCaretAtEnd(chat.input.messageInput);\r\n\r\n        // clone and dispatch same event to new input. it is needed for sending message if input was blurred\r\n        const newEvent = new KeyboardEvent(e.type, e);\r\n        chat.input.messageInput.dispatchEvent(newEvent);\r\n      }\r\n    };\r\n    \r\n    document.body.addEventListener('keydown', onKeyDown);\r\n  }\r\n\r\n  private makeLink<T extends INTERNAL_LINK_TYPE>(type: T, uriParams: Omit<InternalLinkTypeMap[T], '_'>) {\r\n    return {\r\n      _: type,\r\n      ...uriParams\r\n    } as any as InternalLinkTypeMap[T];\r\n  }\r\n\r\n  public async processInternalLink(link: InternalLink) {\r\n    switch(link?._) {\r\n      case INTERNAL_LINK_TYPE.MESSAGE: {\r\n        const postId = link.post ? generateMessageId(+link.post) : undefined;\r\n        const commentId = link.comment ? generateMessageId(+link.comment) : undefined;\r\n\r\n        this.openUsername({\r\n          userName: link.domain, \r\n          lastMsgId: postId, \r\n          commentId,\r\n          startParam: link.start\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.PRIVATE_POST: {\r\n        const chatId = link.channel.toChatId();\r\n        const peerId = chatId.toPeerId(true);\r\n\r\n        const chat = await this.managers.appChatsManager.getChat(chatId);\r\n        if(chat.deleted) {\r\n          try {\r\n            await this.managers.appChatsManager.resolveChannel(chatId);\r\n          } catch(err) {\r\n            toastNew({langPackKey: 'LinkNotFound'});\r\n            throw err;\r\n          }\r\n        }\r\n\r\n        const postId = generateMessageId(+link.post);\r\n        const threadId = link.thread ? generateMessageId(+link.thread) : undefined;\r\n\r\n        if(threadId) this.openThread(peerId, postId, threadId);\r\n        else this.setInnerPeer({\r\n          peerId,\r\n          lastMsgId: postId,\r\n          threadId\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.STICKER_SET: {\r\n        new PopupStickers({id: link.set}).show();\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.JOIN_CHAT: {\r\n        this.managers.appChatsManager.checkChatInvite(link.invite).then((chatInvite) => {\r\n          if((chatInvite as ChatInvite.chatInvitePeek).chat) {\r\n            this.managers.appChatsManager.saveApiChat((chatInvite as ChatInvite.chatInvitePeek).chat, true);\r\n          }\r\n\r\n          // console.log(chatInvite);\r\n\r\n          if(chatInvite._ === 'chatInviteAlready' ||\r\n            chatInvite._ === 'chatInvitePeek'/*  && chatInvite.expires > tsNow(true) */) {\r\n            this.setInnerPeer({\r\n              peerId: chatInvite.chat.id.toPeerId(true)\r\n            });\r\n            return;\r\n          }\r\n\r\n          new PopupJoinChatInvite(link.invite, chatInvite);\r\n        }, (err) => {\r\n          if(err.type === 'INVITE_HASH_EXPIRED') {\r\n            toast(i18n('InviteExpired'));\r\n          }\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.VOICE_CHAT: {\r\n        if(IS_GROUP_CALL_SUPPORTED) {\r\n          this.joinGroupCall(link.chat_id.toPeerId(true), link.id);\r\n        }\r\n        \r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.USER_PHONE_NUMBER: {\r\n        this.managers.appUsersManager.resolvePhone(link.phone).then((user) => {\r\n          this.setInnerPeer({\r\n            peerId: user.id.toPeerId(false)\r\n          });\r\n        }).catch((err) => {\r\n          if(err.type === 'PHONE_NOT_OCCUPIED') {\r\n            toastNew({langPackKey: 'Alert.UserDoesntExists'});\r\n          }\r\n        });\r\n\r\n        break;\r\n      }\r\n\r\n      default: {\r\n        this.log.warn('Not supported internal link:', link);\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  public openUrl(url: string) {\r\n    const {url: wrappedUrl, onclick} = wrapUrl(url);\r\n    const a = document.createElement('a');\r\n    a.href = wrappedUrl;\r\n    \r\n    (window as any)[onclick](a);\r\n  }\r\n\r\n  private addAnchorListener<Params extends {pathnameParams?: any, uriParams?: any}>(options: {\r\n    name: 'showMaskedAlert' | 'execBotCommand' | 'searchByHashtag' | 'addstickers' | 'im' |\r\n          'resolve' | 'privatepost' | 'addstickers' | 'voicechat' | 'joinchat' | 'join', \r\n    protocol?: 'tg',\r\n    callback: (params: Params, element?: HTMLAnchorElement) => boolean | any, \r\n    noPathnameParams?: boolean,\r\n    noUriParams?: boolean\r\n  }) {\r\n    (window as any)[(options.protocol ? options.protocol + '_' : '') + options.name] = (element?: HTMLAnchorElement/* , e: Event */) => {\r\n      cancelEvent(null);\r\n\r\n      const href = element.href;\r\n      let pathnameParams: any[];\r\n      let uriParams: any;\r\n\r\n      if(!options.noPathnameParams) pathnameParams = new URL(element.href).pathname.split('/').slice(1);\r\n      if(!options.noUriParams) uriParams = this.parseUriParams(href);\r\n\r\n      const res = options.callback({pathnameParams, uriParams} as Params, element);\r\n      return res === undefined ? res : false;\r\n    };\r\n  }\r\n\r\n  private parseUriParams(uri: string, splitted = uri.split('?')) {\r\n    const params: any = {};\r\n    if(!splitted[1]) return params;\r\n    splitted[1].split('&').forEach((item) => {\r\n      params[item.split('=')[0]] = decodeURIComponent(item.split('=')[1]);\r\n    });\r\n\r\n    return params;\r\n  }\r\n\r\n  private onHashChange = (saveState?: boolean) => {\r\n    const hash = location.hash;\r\n    if(!saveState) {\r\n      appNavigationController.replaceState();\r\n    }\r\n\r\n    const splitted = hash.split('?');\r\n    const params = this.parseUriParams(hash, splitted);\r\n    this.log('hashchange', hash, splitted[0], params);\r\n    if(!hash) {\r\n      return;\r\n    }\r\n\r\n    if(params.tgaddr) {\r\n      const {onclick} = wrapUrl(params.tgaddr);\r\n      if(onclick) {\r\n        const a = document.createElement('a');\r\n        a.href = params.tgaddr;\r\n        (window as any)[onclick](a);\r\n      }\r\n      return;\r\n    }\r\n\r\n    switch(splitted[0]) {\r\n      default: {\r\n        params.p = splitted[0].slice(1);\r\n      }\r\n\r\n      case '#/im': {\r\n        const p: string = params.p;\r\n        let postId = params.post !== undefined ? generateMessageId(+params.post) : undefined;\r\n\r\n        switch(p[0]) {\r\n          case '@': {\r\n            this.openUsername({\r\n              userName: p, \r\n              lastMsgId: postId\r\n            });\r\n            break;\r\n          }\r\n\r\n          default: { // peerId\r\n            this.setInnerPeer({\r\n              peerId: postId ? p.toPeerId(true) : p.toPeerId(), \r\n              lastMsgId: postId\r\n            });\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    //appNavigationController.replaceState();\r\n    //location.hash = '';\r\n  };\r\n\r\n  public openUsername(options: {\r\n    userName: string, \r\n    lastMsgId?: number, \r\n    threadId?: number, \r\n    commentId?: number,\r\n    startParam?: string\r\n  }) {\r\n    const {userName, lastMsgId, threadId, commentId, startParam} = options;\r\n    return this.managers.appUsersManager.resolveUsername(userName).then((peer) => {\r\n      const isUser = peer._ === 'user';\r\n      const peerId = peer.id.toPeerId(!isUser);\r\n\r\n      if(threadId) {\r\n        return this.openThread(peerId, lastMsgId, threadId);\r\n      } else if(commentId) {\r\n        return this.openComment(peerId, lastMsgId, commentId);\r\n      }\r\n      \r\n      return this.setInnerPeer({\r\n        peerId,\r\n        lastMsgId,\r\n        startParam: startParam\r\n      });\r\n    }, (err) => {\r\n      if(err.type === 'USERNAME_NOT_OCCUPIED') {\r\n        toastNew({langPackKey: 'NoUsernameFound'});\r\n      } else if(err.type === 'USERNAME_INVALID') {\r\n        toastNew({langPackKey: 'Alert.UserDoesntExists'});\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Opens thread when peerId of discussion group is known\r\n   */\r\n  public openThread(peerId: PeerId, lastMsgId: number, threadId: number) {\r\n    return this.managers.appMessagesManager.wrapSingleMessage(peerId, threadId).then((message) => {\r\n      // const message: Message = this.managers.appMessagesManager.getMessageByPeer(peerId, threadId);\r\n      if(!message) {\r\n        lastMsgId = undefined;\r\n      } else {\r\n        this.managers.appMessagesManager.generateThreadServiceStartMessage(message);\r\n      }\r\n\r\n      return this.setInnerPeer({\r\n        peerId,\r\n        lastMsgId,\r\n        threadId,\r\n        type: 'discussion'\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Opens comment directly from original channel\r\n   */\r\n  public openComment(peerId: PeerId, msgId: number, commentId: number) {\r\n    return this.managers.appMessagesManager.getDiscussionMessage(peerId, msgId).then((message) => {\r\n      return this.openThread(message.peerId, commentId, message.mid);\r\n    });\r\n  }\r\n\r\n  public async callUser(userId: UserId, type: CallType) {\r\n    const call = callsController.getCallByUserId(userId);\r\n    if(call) {\r\n      return;\r\n    }\r\n    \r\n    const userFull = await this.managers.appProfileManager.getProfile(userId);\r\n    if(userFull.pFlags.phone_calls_private) {\r\n      confirmationPopup({\r\n        descriptionLangKey: 'Call.PrivacyErrorMessage',\r\n        descriptionLangArgs: [new PeerTitle({peerId: userId.toPeerId()}).element],\r\n        button: {\r\n          langKey: 'OK',\r\n          isCancel: true\r\n        }\r\n      });\r\n\r\n      return;\r\n    }\r\n\r\n    await this.discardCurrentCall(userId.toPeerId());\r\n\r\n    callsController.startCallInternal(userId, type === 'video');\r\n  }\r\n\r\n  private discardCurrentCall(toPeerId: PeerId, ignoreGroupCall?: GroupCallInstance, ignoreCall?: CallInstance) {\r\n    if(groupCallsController.groupCall && groupCallsController.groupCall !== ignoreGroupCall) return this.discardGroupCallConfirmation(toPeerId);\r\n    else if(callsController.currentCall && callsController.currentCall !== ignoreCall) return this.discardCallConfirmation(toPeerId);\r\n    else return Promise.resolve();\r\n  }\r\n\r\n  private async discardCallConfirmation(toPeerId: PeerId) {\r\n    const currentCall = callsController.currentCall;\r\n    if(currentCall) {\r\n      await confirmationPopup({\r\n        titleLangKey: 'Call.Confirm.Discard.Call.Header',\r\n        descriptionLangKey: toPeerId.isUser() ? 'Call.Confirm.Discard.Call.ToCall.Text' : 'Call.Confirm.Discard.Call.ToVoice.Text',\r\n        descriptionLangArgs: [\r\n          new PeerTitle({peerId: currentCall.interlocutorUserId.toPeerId(false)}).element, \r\n          new PeerTitle({peerId: toPeerId}).element\r\n        ],\r\n        button: {\r\n          langKey: 'OK'\r\n        }\r\n      });\r\n\r\n      if(!currentCall.isClosing) {\r\n        await currentCall.hangUp('phoneCallDiscardReasonDisconnect');\r\n      }\r\n    }\r\n  }\r\n\r\n  private async discardGroupCallConfirmation(toPeerId: PeerId) {\r\n    const currentGroupCall = groupCallsController.groupCall;\r\n    if(currentGroupCall) {\r\n      await confirmationPopup({\r\n        titleLangKey: 'Call.Confirm.Discard.Voice.Header',\r\n        descriptionLangKey: toPeerId.isUser() ? 'Call.Confirm.Discard.Voice.ToCall.Text' : 'Call.Confirm.Discard.Voice.ToVoice.Text',\r\n        descriptionLangArgs: [\r\n          new PeerTitle({peerId: currentGroupCall.chatId.toPeerId(true)}).element, \r\n          new PeerTitle({peerId: toPeerId}).element\r\n        ],\r\n        button: {\r\n          langKey: 'OK'\r\n        }\r\n      });\r\n\r\n      if(groupCallsController.groupCall === currentGroupCall) {\r\n        await currentGroupCall.hangUp();\r\n      }\r\n    }\r\n  }\r\n\r\n  public async joinGroupCall(peerId: PeerId, groupCallId?: GroupCallId) {\r\n    const chatId = peerId.toChatId();\r\n    const hasRights = this.managers.appChatsManager.hasRights(chatId, 'manage_call');\r\n    const next = async() => {\r\n      const chatFull = await this.managers.appProfileManager.getChatFull(chatId);\r\n      let call: MyGroupCall;\r\n      if(!chatFull.call) {\r\n        if(!hasRights) {\r\n          return;\r\n        }\r\n  \r\n        call = await this.managers.appGroupCallsManager.createGroupCall(chatId);\r\n      } else {\r\n        call = chatFull.call;\r\n      }\r\n  \r\n      groupCallsController.joinGroupCall(chatId, call.id, true, false);\r\n    };\r\n\r\n    if(groupCallId) {\r\n      const groupCall = await this.managers.appGroupCallsManager.getGroupCallFull(groupCallId);\r\n      if(groupCall._ === 'groupCallDiscarded') {\r\n        if(!hasRights) {\r\n          toastNew({\r\n            langPackKey: 'VoiceChat.Chat.Ended'\r\n          });\r\n\r\n          return;\r\n        }\r\n\r\n        await confirmationPopup({\r\n          descriptionLangKey: 'VoiceChat.Chat.StartNew',\r\n          button: {\r\n            langKey: 'VoiceChat.Chat.StartNew.OK'\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    // await this.discardCurrentCall(peerId);\r\n\r\n    next();\r\n  };\r\n\r\n  public setCurrentBackground(broadcastEvent = false): ReturnType<AppImManager['setBackground']> {\r\n    const theme = themeController.getTheme();\r\n\r\n    if(theme.background.slug) {\r\n      const defaultTheme = STATE_INIT.settings.themes.find((t) => t.name === theme.name);\r\n      // const isDefaultBackground = theme.background.blur === defaultTheme.background.blur && \r\n        // theme.background.slug === defaultTheme.background.slug;\r\n\r\n      // if(!isDefaultBackground) {\r\n        return this.getBackground(theme.background.slug).then((url) => {\r\n          return this.setBackground(url, broadcastEvent);\r\n        }, () => { // * if NO_ENTRY_FOUND\r\n          theme.background = copy(defaultTheme.background); // * reset background\r\n          return this.setCurrentBackground(true);\r\n        });\r\n      // }\r\n    }\r\n    \r\n    return this.setBackground('', broadcastEvent);\r\n  }\r\n\r\n  private getBackground(slug: string) {\r\n    if(this.backgroundPromises[slug]) return this.backgroundPromises[slug];\r\n    return this.backgroundPromises[slug] = this.cacheStorage.getFile('backgrounds/' + slug).then((blob) => {\r\n      return URL.createObjectURL(blob);\r\n    });\r\n  }\r\n\r\n  public setBackground(url: string, broadcastEvent = true): Promise<void> {\r\n    this.lastBackgroundUrl = url;\r\n    const promises = this.chats.map((chat) => chat.setBackground(url));\r\n    return promises[promises.length - 1].then(() => {\r\n      if(broadcastEvent) {\r\n        rootScope.dispatchEvent('background_change');\r\n      }\r\n    });\r\n  }\r\n\r\n  public saveChatPosition(chat: Chat) {\r\n    if(!(['chat', 'discussion'] as ChatType[]).includes(chat.type) || !chat.peerId) {\r\n      return;\r\n    }\r\n\r\n    //const bubble = chat.bubbles.getBubbleByPoint('top');\r\n    //if(bubble) {\r\n      //const top = bubble.getBoundingClientRect().top;\r\n      const chatBubbles = chat.bubbles;\r\n      const key = chat.peerId + (chat.threadId ? '_' + chat.threadId : '');\r\n      const chatPositions = stateStorage.getFromCache('chatPositions');\r\n      if(!(chatBubbles.scrollable.getDistanceToEnd() <= 16 && chatBubbles.scrollable.loadedAll.bottom) && chatBubbles.getRenderedLength()) {\r\n        chatBubbles.sliceViewport(true);\r\n        const top = chatBubbles.scrollable.scrollTop;\r\n        \r\n        const position = {\r\n          mids: getObjectKeysAndSort(chatBubbles.bubbles, 'desc').filter((mid) => !chatBubbles.skippedMids.has(mid)),\r\n          top\r\n        };\r\n\r\n        chatPositions[key] = position;\r\n\r\n        this.log('saved chat position:', position);\r\n      } else {\r\n        delete chatPositions[key];\r\n\r\n        this.log('deleted chat position');\r\n      }\r\n\r\n      stateStorage.set({chatPositions}, true);\r\n    //}\r\n  }\r\n\r\n  public getChatSavedPosition(chat: Chat): ChatSavedPosition {\r\n    if(!(['chat', 'discussion'] as ChatType[]).includes(chat.type) || !chat.peerId) {\r\n      return;\r\n    }\r\n    \r\n    const key = chat.peerId + (chat.threadId ? '_' + chat.threadId : '');\r\n    const cache = stateStorage.getFromCache('chatPositions');\r\n    return cache && cache[key];\r\n  }\r\n\r\n  public applyCurrentTheme(slug?: string, backgroundUrl?: string, broadcastEvent?: boolean) {\r\n    if(backgroundUrl) {\r\n      this.backgroundPromises[slug] = Promise.resolve(backgroundUrl);\r\n    }\r\n\r\n    themeController.setTheme();\r\n    \r\n    return this.setCurrentBackground(broadcastEvent === undefined ? !!slug : broadcastEvent);\r\n  }\r\n\r\n  private setSettings = () => {\r\n    document.documentElement.style.setProperty('--messages-text-size', rootScope.settings.messagesTextSize + 'px');\r\n    \r\n    document.body.classList.toggle('animation-level-0', !rootScope.settings.animationsEnabled);\r\n    document.body.classList.toggle('animation-level-1', false);\r\n    document.body.classList.toggle('animation-level-2', rootScope.settings.animationsEnabled);\r\n\r\n    this.chatsSelectTabDebounced = debounce(() => {\r\n      const topbar = this.chat.topbar;\r\n      if(topbar.pinnedMessage) { // * буду молиться богам, чтобы это ничего не сломало, но это исправляет получение пиннеда после анимации\r\n        topbar.pinnedMessage.setCorrectIndex(0);\r\n      }\r\n\r\n      this.managers.apiFileManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId);\r\n    }, rootScope.settings.animationsEnabled ? 250 : 0, false, true);\r\n\r\n    lottieLoader.setLoop(rootScope.settings.stickers.loop);\r\n    animationIntersector.checkAnimations(false);\r\n    \r\n    for(const chat of this.chats) {\r\n      chat.setAutoDownloadMedia();\r\n    }\r\n    \r\n    I18n.setTimeFormat(rootScope.settings.timeFormat);\r\n\r\n    this.toggleChatGradientAnimation(this.chat);\r\n  };\r\n\r\n  // * не могу использовать тут TransitionSlider, так как мне нужен отрисованный блок рядом \r\n  // * (или под текущим чатом) чтобы правильно отрендерить чат (напр. scrollTop)\r\n  private chatsSelectTab(tab: HTMLElement, animate?: boolean) {\r\n    if(this.prevTab === tab) {\r\n      return;\r\n    }\r\n\r\n    if(animate === false && this.prevTab) { // * will be used for Safari iOS history swipe\r\n      disableTransition([tab, this.prevTab].filter(Boolean));\r\n    }\r\n\r\n    if(this.prevTab) {\r\n      this.prevTab.classList.remove('active');\r\n      this.chatsSelectTabDebounced();\r\n\r\n      // ! нужно переделать на animation, так как при лаге анимация будет длиться не 250мс\r\n      if(rootScope.settings.animationsEnabled && animate !== false) { \r\n        dispatchHeavyAnimationEvent(pause(250 + 150), 250 + 150);\r\n      }\r\n\r\n      const prevIdx = whichChild(this.prevTab);\r\n      const idx = whichChild(tab);\r\n      if(idx > prevIdx) {\r\n        appNavigationController.pushItem({\r\n          type: 'chat', \r\n          onPop: (canAnimate) => {\r\n            this.setPeer({}, canAnimate);\r\n            blurActiveElement();\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    tab.classList.add('active');\r\n    this.prevTab = tab;\r\n  }\r\n\r\n  private init() {\r\n    document.addEventListener('paste', this.onDocumentPaste, true);\r\n    \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.attachDragAndDropListeners();\r\n    }\r\n\r\n    //if(!isTouchSupported) {\r\n      this.markupTooltip = new MarkupTooltip(this);\r\n      this.markupTooltip.handleSelection();\r\n    //}\r\n  }\r\n\r\n  private attachDragAndDropListeners() {\r\n    const drops: ChatDragAndDrop[] = [];\r\n    const mediaDrops: ChatDragAndDrop[] = [];\r\n    let mounted = false;\r\n    const toggle = async(e: DragEvent, mount: boolean) => {\r\n      if(mount === mounted) return;\r\n\r\n      const _types = e.dataTransfer.types;\r\n      // @ts-ignore\r\n      const isFiles = _types.contains ? _types.contains('Files') : _types.indexOf('Files') >= 0;\r\n\r\n      const newMediaPopup = getCurrentNewMediaPopup();\r\n      const types: string[] = await getFilesFromEvent(e, true);\r\n      if(!isFiles || (!(await this.canDrag()) && !newMediaPopup)) { // * skip dragging text case\r\n        counter = 0;\r\n        return;\r\n      }\r\n\r\n      const _dropsContainer = newMediaPopup ? mediaDropsContainer : dropsContainer;\r\n      const _drops = newMediaPopup ? mediaDrops : drops;\r\n\r\n      if(mount && !_drops.length) {\r\n        const force = isFiles && !types.length; // * can't get file items not from 'drop' on Safari\r\n        \r\n        const foundMedia = types.filter((t) => MEDIA_MIME_TYPES_SUPPORTED.has(t)).length;\r\n        // const foundDocuments = types.length - foundMedia;\r\n  \r\n        this.log('drag files', types);\r\n\r\n        if(newMediaPopup) {\r\n          newMediaPopup.appendDrops(_dropsContainer);\r\n\r\n          if(types.length || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              header: 'Preview.Dragging.AddItems',\r\n              headerArgs: [types.length],\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'document');\r\n              }\r\n            }));\r\n          }\r\n        } else {\r\n          if(types.length || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              icon: 'dragfiles',\r\n              header: 'Chat.DropTitle',\r\n              subtitle: 'Chat.DropAsFilesDesc',\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'document');\r\n              }\r\n            }));\r\n          }\r\n    \r\n          // if((foundMedia && !foundDocuments) || force) {\r\n          if(foundMedia || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              icon: 'dragmedia',\r\n              header: 'Chat.DropTitle',\r\n              subtitle: 'Chat.DropQuickDesc',\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'media');\r\n              }\r\n            }));\r\n          }\r\n\r\n          this.chat.container.append(_dropsContainer);\r\n        }\r\n      }\r\n\r\n      //if(!mount) return;\r\n\r\n      SetTransition(_dropsContainer, 'is-visible', mount, 200, () => {\r\n        if(!mount) {\r\n          _drops.forEach((drop) => {\r\n            drop.destroy();\r\n          });\r\n\r\n          _drops.length = 0;\r\n        }\r\n      });\r\n\r\n      if(mount) {\r\n        _drops.forEach((drop) => {\r\n          drop.setPath();\r\n        });\r\n      } else {\r\n        counter = 0;\r\n      }\r\n\r\n      document.body.classList.toggle('is-dragging', mount);\r\n      mounted = mount;\r\n    };\r\n\r\n    /* document.body.addEventListener('dragover', (e) => {\r\n      cancelEvent(e);\r\n    }); */\r\n\r\n    let counter = 0;\r\n    document.body.addEventListener('dragenter', (e) => {\r\n      counter++;\r\n    });\r\n\r\n    document.body.addEventListener('dragover', (e) => {\r\n      //this.log('dragover', e/* , e.dataTransfer.types[0] */);\r\n      toggle(e, true);\r\n      cancelEvent(e);\r\n    });\r\n\r\n    document.body.addEventListener('dragleave', (e) => {\r\n      //this.log('dragleave', e, counter);\r\n      //if((e.pageX <= 0 || e.pageX >= this.managers.appPhotosManager.windowW) || (e.pageY <= 0 || e.pageY >= this.managers.appPhotosManager.windowH)) {\r\n      counter--;\r\n      if(counter === 0) { \r\n      //if(!findUpClassName(e.target, 'drops-container')) {\r\n        toggle(e, false);\r\n      }\r\n    });\r\n\r\n    const dropsContainer = document.createElement('div');\r\n    dropsContainer.classList.add('drops-container');\r\n\r\n    const mediaDropsContainer = dropsContainer.cloneNode(true) as HTMLElement;\r\n  }\r\n\r\n  private async canDrag() {\r\n    const chat = this.chat;\r\n    const peerId = chat?.peerId;\r\n    return !(!peerId || overlayCounter.isOverlayActive || !(await chat.canSend('send_media')));\r\n  }\r\n\r\n  private onDocumentPaste = async(e: ClipboardEvent | DragEvent, attachType?: 'media' | 'document') => {\r\n    const newMediaPopup = getCurrentNewMediaPopup();\r\n\r\n    //console.log('document paste');\r\n    //console.log('item', event.clipboardData.getData());\r\n\r\n    if(e instanceof DragEvent) {\r\n      const _types = e.dataTransfer.types;\r\n      // @ts-ignore\r\n      const isFiles = _types.contains ? _types.contains('Files') : _types.indexOf('Files') >= 0;\r\n      if(isFiles) {\r\n        cancelEvent(e);\r\n      }\r\n    }\r\n    \r\n    const files = await getFilesFromEvent(e);\r\n    if(!(await this.canDrag()) && !newMediaPopup) return;\r\n    if(files.length) {\r\n      if(newMediaPopup) {\r\n        newMediaPopup.addFiles(files);\r\n        return;\r\n      }\r\n  \r\n      const chatInput = this.chat.input;\r\n      chatInput.willAttachType = attachType || (MEDIA_MIME_TYPES_SUPPORTED.has(files[0].type) ? 'media' : 'document');\r\n      PopupElement.createPopup(PopupNewMedia, this.chat, files, chatInput.willAttachType);\r\n    }\r\n  };\r\n\r\n  public selectTab(id: number, animate?: boolean) {\r\n    if(animate === false) { // * will be used for Safari iOS history swipe\r\n      disableTransition([appSidebarLeft.sidebarEl, this.columnEl, appSidebarRight.sidebarEl]);\r\n    }\r\n\r\n    document.body.classList.toggle(LEFT_COLUMN_ACTIVE_CLASSNAME, id === 0);\r\n\r\n    const prevTabId = this.tabId;\r\n\r\n    this.log('selectTab', id, prevTabId);\r\n\r\n    let animationPromise: Promise<any> = rootScope.settings.animationsEnabled ? doubleRaf() : Promise.resolve();\r\n    if(prevTabId !== -1 && prevTabId !== id && rootScope.settings.animationsEnabled && animate !== false && mediaSizes.activeScreen !== ScreenSize.large) {\r\n      const transitionTime = (mediaSizes.isMobile ? 250 : 200) + 100; // * cause transition time could be > 250ms\r\n      animationPromise = pause(transitionTime);\r\n      dispatchHeavyAnimationEvent(animationPromise, transitionTime);\r\n\r\n      // ! it's very heavy operation. will blink in firefox\r\n      /* this.columnEl.classList.add('disable-hover');\r\n      animationPromise.finally(() => {\r\n        this.columnEl.classList.remove('disable-hover');\r\n      }); */\r\n    }\r\n\r\n    this.tabId = id;\r\n    blurActiveElement();\r\n    if(mediaSizes.isMobile && prevTabId === 2 && id < 2) {\r\n      document.body.classList.remove(RIGHT_COLUMN_ACTIVE_CLASSNAME);\r\n    }\r\n\r\n    if(prevTabId !== -1 && id > prevTabId) {\r\n      if(id < 2 || !appNavigationController.findItemByType('im')) {\r\n        appNavigationController.pushItem({\r\n          type: 'im', \r\n          onPop: (canAnimate) => {\r\n            //this.selectTab(prevTabId, !isSafari);\r\n            this.setPeer({}, canAnimate);\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    const onImTabChange = (window as any).onImTabChange;\r\n    onImTabChange && onImTabChange(id);\r\n\r\n    //this._selectTab(id, mediaSizes.isMobile);\r\n    //document.body.classList.toggle(RIGHT_COLUMN_ACTIVE_CLASSNAME, id === 2);\r\n\r\n    return animationPromise;\r\n  }\r\n  \r\n  public updateStatus() {\r\n    return this.managers.appUsersManager.updateMyOnlineStatus(this.offline);\r\n  }\r\n\r\n  private createNewChat() {\r\n    const chat = new Chat(\r\n      this, \r\n      this.managers\r\n    );\r\n\r\n    if(this.chats.length) {\r\n      chat.setBackground(this.lastBackgroundUrl, true);\r\n    }\r\n\r\n    this.chats.push(chat);\r\n\r\n    return chat;\r\n  }\r\n\r\n  private spliceChats(fromIndex: number, justReturn = true, animate?: boolean, spliced?: Chat[]) {\r\n    if(fromIndex >= this.chats.length) return;\r\n\r\n    const chatFrom = this.chat;\r\n    if(this.chats.length > 1 && justReturn) {\r\n      this.dispatchEvent('peer_changing', this.chat);\r\n    }\r\n\r\n    if(!spliced) {\r\n      spliced = this.chats.splice(fromIndex, this.chats.length - fromIndex);\r\n    }\r\n\r\n    const chatTo = this.chat;\r\n    this.dispatchEvent('chat_changing', {from: chatFrom, to: chatTo});\r\n\r\n    // * -1 because one item is being sliced when closing the chat by calling .removeByType\r\n    for(let i = 0; i < spliced.length - 1; ++i) {\r\n      appNavigationController.removeByType('chat', true);\r\n    }\r\n\r\n    // * fix middle chat z-index on animation\r\n    if(spliced.length > 1) {\r\n      spliced.slice(0, -1).forEach((chat) => {\r\n        chat.container.remove();\r\n      });\r\n    }\r\n\r\n    this.chatsSelectTab(chatTo.container, animate);\r\n\r\n    if(justReturn) {\r\n      this.dispatchEvent('peer_changed', chatTo.peerId);\r\n\r\n      const searchTab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n      if(searchTab) {\r\n        searchTab.close();\r\n      }\r\n\r\n      appSidebarRight.replaceSharedMediaTab(chatTo.sharedMediaTab);\r\n    }\r\n\r\n    spliced.forEach((chat) => {\r\n      chat.beforeDestroy();\r\n    });\r\n    \r\n    setTimeout(() => {\r\n      //chat.setPeer(0);\r\n      spliced.forEach((chat) => {\r\n        chat.destroy();\r\n      });\r\n    }, 250 + 100);\r\n  }\r\n\r\n  public async setPeer(options: ChatSetPeerOptions = {}, animate?: boolean): Promise<boolean> {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    options.peerId ??= NULL_PEER_ID;\r\n\r\n    const {peerId, lastMsgId} = options;\r\n\r\n    const chat = this.chat;\r\n    const chatIndex = this.chats.indexOf(chat);\r\n\r\n    if(!peerId) {\r\n      if(chatIndex > 0) {\r\n        this.spliceChats(chatIndex, undefined, animate);\r\n        return;\r\n      } else if(mediaSizes.activeScreen === ScreenSize.medium) { // * floating sidebar case\r\n        this.selectTab(+!this.tabId, animate);\r\n        return;\r\n      }\r\n    } else if(chatIndex > 0 && chat.peerId && chat.peerId !== peerId) {\r\n      // const firstChat = this.chats[0];\r\n      // if(firstChat.peerId !== chat.peerId) {\r\n        /* // * slice idx > 0, set background and slice first, so new one will be the first\r\n        const spliced = this.chats.splice(1, this.chats.length - 1);\r\n        this.createNewChat();\r\n        this.chats.splice(0, 1); */\r\n        const spliced = this.chats.splice(1, this.chats.length - 1);\r\n        if(this.chat.peerId === peerId) {\r\n          this.spliceChats(0, true, true, spliced);\r\n          return;\r\n        } else {\r\n          const ret = this.setPeer(options);\r\n          this.spliceChats(0, false, false, spliced);\r\n          return ret;\r\n        }\r\n      // } else {\r\n      //   this.spliceChats(1, false, animate);\r\n      // }\r\n\r\n      //return ret;\r\n    }\r\n\r\n    // * don't reset peer if returning\r\n    if(peerId === chat.peerId && mediaSizes.activeScreen <= ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n      this.selectTab(1, animate);\r\n      return false;\r\n    }\r\n\r\n    if(peerId || mediaSizes.activeScreen !== ScreenSize.mobile) {\r\n      const result = await chat.setPeer(peerId, lastMsgId, options.startParam);\r\n\r\n      // * wait for cached render\r\n      const promise = result?.cached ? result.promise : Promise.resolve();\r\n      if(peerId) {\r\n        Promise.all([\r\n          promise,\r\n          chat.setBackgroundPromise\r\n        ]).then(() => {\r\n          //window.requestAnimationFrame(() => {\r\n          setTimeout(() => { // * setTimeout is better here\r\n            setTimeout(() => {\r\n              this.chatsSelectTab(this.chat.container);\r\n            }, 0);\r\n            this.selectTab(1, animate);\r\n          }, 0);\r\n        });\r\n      }\r\n    }\r\n\r\n    if(!peerId) {\r\n      this.selectTab(0, animate);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public setInnerPeer(options: ChatSetInnerPeerOptions) {\r\n    const {peerId} = options;\r\n    if(peerId === NULL_PEER_ID || !peerId) {\r\n      return;\r\n    }\r\n\r\n    if(options.threadId) {\r\n      options.type = 'discussion';\r\n    }\r\n\r\n    const type = options.type ??= 'chat';\r\n\r\n    // * prevent opening already opened peer\r\n    const existingIndex = this.chats.findIndex((chat) => chat.peerId === peerId && chat.type === type);\r\n    if(existingIndex !== -1) {\r\n      this.spliceChats(existingIndex + 1);\r\n      return this.setPeer(options);\r\n    }\r\n\r\n    const oldChat = this.chat;\r\n    let chat = oldChat;\r\n    if(oldChat.inited) { // * use first not inited chat\r\n      chat = this.createNewChat();\r\n    }\r\n\r\n    if(type) {\r\n      chat.setType(type);\r\n\r\n      if(options.threadId) {\r\n        chat.threadId = options.threadId;\r\n      }\r\n    }\r\n\r\n    this.dispatchEvent('chat_changing', {from: oldChat, to: chat});\r\n\r\n    //this.chatsSelectTab(chat.container);\r\n\r\n    return this.setPeer(options);\r\n  }\r\n\r\n  public openScheduled(peerId: PeerId) {\r\n    this.setInnerPeer({\r\n      peerId, \r\n      type: 'scheduled'\r\n    });\r\n  }\r\n\r\n  private getTypingElement(action: SendMessageAction) {\r\n    const el = document.createElement('span');\r\n    let c = 'peer-typing';\r\n    el.classList.add(c);\r\n    el.dataset.action = action._;\r\n    switch(action._) {\r\n      case 'sendMessageTypingAction': {\r\n      //default: {\r\n        c += '-text';\r\n        for(let i = 0; i < 3; ++i) {\r\n          const dot = document.createElement('span');\r\n          dot.className = c + '-dot';\r\n          el.append(dot);\r\n        }\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageUploadAudioAction':\r\n      case 'sendMessageUploadDocumentAction':\r\n      case 'sendMessageUploadRoundAction':\r\n      case 'sendMessageUploadVideoAction':\r\n      case 'sendMessageUploadPhotoAction': {\r\n        c += '-upload';\r\n        /* const trail = document.createElement('span');\r\n        trail.className = c + '-trail';\r\n        el.append(trail); */\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageRecordAudioAction':\r\n      case 'sendMessageRecordRoundAction':\r\n      case 'sendMessageRecordVideoAction': {\r\n        c += '-record';\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageEmojiInteractionSeen':\r\n      case 'sendMessageChooseStickerAction': {\r\n        c += '-choosing-sticker';\r\n        for(let i = 0; i < 2; ++i) {\r\n          const eye = document.createElement('div');\r\n          eye.className = c + '-eye';\r\n          el.append(eye);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n\r\n    el.classList.add(c);\r\n\r\n    return el;\r\n  }\r\n\r\n  public async getPeerTyping(peerId: PeerId, container?: HTMLElement) {\r\n    // const log = this.log.bindPrefix('getPeerTyping-' + peerId);\r\n    // log('getting peer typing');\r\n\r\n    const isUser = peerId.isUser();\r\n    if(isUser && await this.managers.appUsersManager.isBot(peerId)) {\r\n      // log('a bot');\r\n      return;\r\n    }\r\n\r\n    const typings = await this.managers.appProfileManager.getPeerTypings(peerId);\r\n    if(!typings?.length) {\r\n      // log('have no typing');\r\n      return;\r\n    }\r\n\r\n    const typing = typings[0];\r\n\r\n    const langPackKeys: {\r\n      [peerType in 'private' | 'chat' | 'multi']?: Partial<{[action in SendMessageAction['_']]: LangPackKey}>\r\n    } = {\r\n      private: {\r\n        'sendMessageTypingAction': 'Peer.Activity.User.TypingText',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.User.SendingFile',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.User.SendingFile',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.User.SendingPhoto',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.User.SendingVideo',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.User.SendingVideo',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.User.RecordingVideo',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.User.RecordingAudio',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.User.RecordingVideo',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.User.PlayingGame',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.User.ChoosingSticker',\r\n        'sendMessageEmojiInteractionSeen': 'Peer.Activity.User.EnjoyingAnimations'\r\n      },\r\n      chat: {\r\n        'sendMessageTypingAction': 'Peer.Activity.Chat.TypingText',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.Chat.SendingFile',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.Chat.SendingFile',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.Chat.SendingPhoto',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.Chat.SendingVideo',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.Chat.SendingVideo',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.Chat.RecordingVideo',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.Chat.RecordingAudio',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.Chat.RecordingVideo',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.Chat.PlayingGame',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.Chat.ChoosingSticker',\r\n        'sendMessageEmojiInteractionSeen': 'Peer.Activity.Chat.EnjoyingAnimations'\r\n      },\r\n      multi: {\r\n        'sendMessageTypingAction': 'Peer.Activity.Chat.Multi.TypingText1',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.Chat.Multi.SendingFile1',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.Chat.Multi.SendingFile1',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.Chat.Multi.SendingPhoto1',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.Chat.Multi.SendingVideo1',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.Chat.Multi.SendingVideo1',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.Chat.Multi.RecordingVideo1',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.Chat.Multi.RecordingAudio1',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.Chat.Multi.RecordingVideo1',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.Chat.Multi.PlayingGame1',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.Chat.Multi.ChoosingSticker1'\r\n      }\r\n    };\r\n\r\n    const mapa = isUser ? langPackKeys.private : (typings.length > 1 ? langPackKeys.multi : langPackKeys.chat);\r\n    let action = typing.action;\r\n\r\n    if(typings.length > 1) {\r\n      const s: any = {};\r\n      typings.forEach((typing) => {\r\n        const type = typing.action._;\r\n        if(s[type] === undefined) s[type] = 0;\r\n        ++s[type];\r\n      });\r\n\r\n      if(Object.keys(s).length > 1) {\r\n        action = {\r\n          _: 'sendMessageTypingAction'\r\n        };\r\n      }\r\n    }\r\n\r\n    const langPackKey = mapa[action._];\r\n    if(!langPackKey) {\r\n      // log('no langPackKey');\r\n      return;\r\n    }\r\n\r\n    let peerTitlePromise: Promise<any>;\r\n    let args: any[];\r\n    if(peerId.isAnyChat()) {\r\n      const peerTitle = new PeerTitle();\r\n      peerTitlePromise = peerTitle.update({peerId: typing.userId.toPeerId(false), onlyFirstName: true});\r\n      args = [\r\n        peerTitle.element,\r\n        typings.length - 1\r\n      ];\r\n\r\n      await peerTitlePromise;\r\n    }\r\n\r\n    if(!container) {\r\n      container = document.createElement('span');\r\n      container.classList.add('online', 'peer-typing-container');\r\n    }\r\n\r\n    container.classList.toggle('peer-typing-flex', action._ === 'sendMessageChooseStickerAction' || action._ === 'sendMessageEmojiInteractionSeen');\r\n\r\n    let typingElement = container.firstElementChild as HTMLElement;\r\n    if(!typingElement) {\r\n      typingElement = this.getTypingElement(action);\r\n      container.prepend(typingElement);\r\n    } else {\r\n      if(typingElement.dataset.action !== action._) {\r\n        typingElement.replaceWith(this.getTypingElement(action));\r\n      }\r\n    }\r\n\r\n    if(action._ === 'sendMessageEmojiInteractionSeen') {\r\n      if(args) {\r\n        args.pop();\r\n      } else {\r\n        args = [];\r\n      }\r\n\r\n      const span = htmlToSpan(wrapEmojiText(action.emoticon));\r\n      args.push(span);\r\n    }\r\n\r\n    const descriptionElement = i18n(langPackKey, args);\r\n    descriptionElement.classList.add('peer-typing-description');\r\n\r\n    if(container.childElementCount > 1) container.lastElementChild.replaceWith(descriptionElement);\r\n    else container.append(descriptionElement);\r\n    \r\n    // log('returning typing');\r\n    return container;\r\n  }\r\n\r\n  private async getChatStatus(chatId: ChatId): Promise<AckedResult<HTMLElement>> {\r\n    const typingEl = await this.getPeerTyping(chatId.toPeerId(true));\r\n    if(typingEl) {\r\n      return {cached: true, result: Promise.resolve(typingEl)};\r\n    }\r\n\r\n    const result = await this.managers.acknowledged.appProfileManager.getChatFull(chatId);\r\n    const dooo = async(chatInfo: ChatFull) => {\r\n      // this.chat.log('chatInfo res:', chatInfo);\r\n\r\n      const participants_count = (chatInfo as ChatFull.channelFull).participants_count || \r\n        ((chatInfo as ChatFull.chatFull).participants as ChatParticipants.chatParticipants)?.participants?.length || \r\n        1;\r\n      //if(participants_count) {\r\n        let subtitle = await getChatMembersString(chatId);\r\n  \r\n        if(participants_count < 2) {\r\n          return subtitle;\r\n        }\r\n  \r\n        const onlines = await this.managers.appProfileManager.getOnlines(chatId);\r\n        if(onlines > 1) {\r\n          const span = document.createElement('span');\r\n          \r\n          span.append(...join([subtitle, i18n('OnlineCount', [numberThousandSplitter(onlines)])], false));\r\n          subtitle = span;\r\n        }\r\n  \r\n        return subtitle;\r\n      //}\r\n    }; \r\n\r\n    const promise = Promise.resolve(result.result).then(dooo);\r\n    return {\r\n      cached: result.cached,\r\n      result: promise\r\n    };\r\n  }\r\n\r\n  private async getUserStatus(userId: UserId, ignoreSelf?: boolean) {\r\n    const result: AckedResult<HTMLElement> = {\r\n      cached: true,\r\n      result: Promise.resolve(undefined as HTMLElement)\r\n    };\r\n\r\n    const user = await this.managers.appUsersManager.getUser(userId);\r\n    if(!user || (user.pFlags.self && !ignoreSelf)) {\r\n      return result;\r\n    }\r\n\r\n    const subtitle = getUserStatusString(user);\r\n\r\n    if(!user.pFlags.bot) {\r\n      let typingEl = await this.getPeerTyping(userId.toPeerId());\r\n      if(!typingEl && user.status?._ === 'userStatusOnline') {\r\n        typingEl = document.createElement('span');\r\n        typingEl.classList.add('online');\r\n        typingEl.append(subtitle);\r\n      }\r\n\r\n      if(typingEl) {\r\n        result.result = Promise.resolve(typingEl);\r\n        return result;\r\n      }\r\n    }\r\n    \r\n    result.result = Promise.resolve(subtitle);\r\n    return result;\r\n  }\r\n\r\n  private async getPeerStatus(peerId: PeerId, ignoreSelf?: boolean) {\r\n    if(!peerId) return;\r\n    let promise: Promise<AckedResult<HTMLElement>>;\r\n    if(peerId.isAnyChat()) {\r\n      promise = this.getChatStatus(peerId.toChatId());\r\n    } else {\r\n      promise = this.getUserStatus(peerId.toUserId(), ignoreSelf);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public async setPeerStatus(\r\n    peerId: PeerId, \r\n    element: HTMLElement, \r\n    needClear: boolean, \r\n    useWhitespace: boolean, \r\n    middleware: () => boolean, \r\n    ignoreSelf?: boolean\r\n  ) {\r\n    // const log = this.log.bindPrefix('status-' + peerId);\r\n    // log('setting status', element);\r\n\r\n    if(!needClear) {\r\n      // * good good good\r\n      const typingContainer = element.querySelector('.peer-typing-container') as HTMLElement;\r\n      if(typingContainer && await this.getPeerTyping(peerId, typingContainer)) {\r\n        // log('already have a status');\r\n        return;\r\n      }\r\n    }\r\n    \r\n    const result = await this.getPeerStatus(peerId, ignoreSelf);\r\n    // log('getPeerStatus result', result);\r\n    if(!middleware()) {\r\n      // log.warn('middleware');\r\n      return;\r\n    }\r\n\r\n    const set = async() => {\r\n      const subtitle = result && await result.result;\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n  \r\n      return () => replaceContent(element, subtitle || placeholder);\r\n    };\r\n    \r\n    const placeholder = useWhitespace ? '‎' : ''; // ! HERE U CAN FIND WHITESPACE\r\n    if(!result || result.cached) {\r\n      return await set();\r\n    } else if(needClear) {\r\n      return () => {\r\n        element.textContent = placeholder;\r\n        return set().then((callback) => callback && callback());\r\n      };\r\n    }\r\n  }\r\n\r\n  public setChoosingStickerTyping(cancel: boolean) {\r\n    this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: cancel ? 'sendMessageCancelAction' : 'sendMessageChooseStickerAction'});\r\n  }\r\n}\r\n\r\nconst appImManager = new AppImManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.appImManager = appImManager);\r\nexport default appImManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appMediaPlaybackController from \"../components/appMediaPlaybackController\";\r\nimport { IS_APPLE_MOBILE, IS_MOBILE } from \"../environment/userAgent\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport ListenerSetter, { Listener } from \"../helpers/listenerSetter\";\r\nimport ButtonMenu from \"../components/buttonMenu\";\r\nimport { ButtonMenuToggleHandler } from \"../components/buttonMenuToggle\";\r\nimport rootScope from \"./rootScope\";\r\nimport ControlsHover from \"../helpers/dom/controlsHover\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../helpers/dom/fullScreen\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport MediaProgressLine from \"../components/mediaProgressLine\";\r\nimport VolumeSelector from \"../components/volumeSelector\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport overlayCounter from \"../helpers/overlayCounter\";\r\nimport onMediaLoad from \"../helpers/onMediaLoad\";\r\n\r\nexport default class VideoPlayer extends ControlsHover {\r\n  private static PLAYBACK_RATES = [0.5, 1, 1.5, 2];\r\n  private static PLAYBACK_RATES_ICONS = ['playback_05', 'playback_1x', 'playback_15', 'playback_2x'];\r\n\r\n  protected video: HTMLVideoElement;\r\n  protected wrapper: HTMLDivElement;\r\n  protected progress: MediaProgressLine;\r\n  protected skin: 'default';\r\n\r\n  protected listenerSetter: ListenerSetter;\r\n  protected playbackRateButton: HTMLElement;\r\n  protected pipButton: HTMLElement;\r\n\r\n  /* protected videoParent: HTMLElement;\r\n  protected videoWhichChild: number; */\r\n\r\n  protected onPlaybackRackMenuToggle?: (open: boolean) => void;\r\n  protected onPip?: (pip: boolean) => void;\r\n  protected onPipClose?: () => void;\r\n\r\n  constructor({video, play = false, streamable = false, duration, onPlaybackRackMenuToggle, onPip, onPipClose}: {\r\n    video: HTMLVideoElement, \r\n    play?: boolean, \r\n    streamable?: boolean, \r\n    duration?: number,\r\n    onPlaybackRackMenuToggle?: VideoPlayer['onPlaybackRackMenuToggle'],\r\n    onPip?: VideoPlayer['onPip'],\r\n    onPipClose?: VideoPlayer['onPipClose']\r\n  }) {\r\n    super();\r\n\r\n    this.video = video;\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add('ckin__player');\r\n\r\n    this.onPlaybackRackMenuToggle = onPlaybackRackMenuToggle;\r\n    this.onPip = onPip;\r\n    this.onPipClose = onPipClose;\r\n\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.setup({\r\n      element: this.wrapper, \r\n      listenerSetter: this.listenerSetter, \r\n      canHideControls: () => {\r\n        return !this.video.paused && (!this.playbackRateButton || !this.playbackRateButton.classList.contains('menu-open'));\r\n      },\r\n      showOnLeaveToClassName: 'media-viewer-caption',\r\n      ignoreClickClassName: 'ckin__controls'\r\n    });\r\n\r\n    video.parentNode.insertBefore(this.wrapper, video);\r\n    this.wrapper.appendChild(video);\r\n\r\n    this.skin = 'default';\r\n\r\n    this.stylePlayer(duration);\r\n    this.setBtnMenuToggle();\r\n\r\n    if(this.skin === 'default') {\r\n      const controls = this.wrapper.querySelector('.default__controls.ckin__controls') as HTMLDivElement;\r\n      this.progress = new MediaProgressLine(video, streamable);\r\n      controls.prepend(this.progress.container);\r\n    }\r\n\r\n    if(play/*  && video.paused */) {\r\n      const promise = video.play();\r\n      promise.catch((err: Error) => {\r\n        if(err.name === 'NotAllowedError') {\r\n          video.muted = true;\r\n          video.autoplay = true;\r\n          video.play();\r\n        }\r\n      }).finally(() => { // due to autoplay, play will not call\r\n        this.wrapper.classList.toggle('is-playing', !this.video.paused);\r\n      });\r\n      //(this.wrapper.querySelector('.toggle') as HTMLButtonElement).click();\r\n    }\r\n  }\r\n\r\n  private stylePlayer(initDuration: number) {\r\n    const {wrapper, video, skin, listenerSetter} = this;\r\n\r\n    wrapper.classList.add(skin);\r\n  \r\n    const html = this.buildControls();\r\n    wrapper.insertAdjacentHTML('beforeend', html);\r\n    let timeDuration: HTMLElement;\r\n  \r\n    if(skin === 'default') {\r\n      this.playbackRateButton = this.wrapper.querySelector('.playback-rate') as HTMLElement;\r\n      this.pipButton = this.wrapper.querySelector('.pip') as HTMLElement;\r\n      \r\n      const toggle = wrapper.querySelectorAll('.toggle') as NodeListOf<HTMLElement>;\r\n      const fullScreenButton = wrapper.querySelector('.fullscreen') as HTMLElement;\r\n      const timeElapsed = wrapper.querySelector('#time-elapsed');\r\n      timeDuration = wrapper.querySelector('#time-duration') as HTMLElement;\r\n      timeDuration.innerHTML = toHHMMSS(video.duration | 0);\r\n\r\n      const volumeSelector = new VolumeSelector(listenerSetter);\r\n\r\n      const leftControls = wrapper.querySelector('.left-controls');\r\n      volumeSelector.btn.classList.remove('btn-icon');\r\n      leftControls.insertBefore(volumeSelector.btn, timeElapsed.parentElement);\r\n\r\n      Array.from(toggle).forEach((button) => {\r\n        listenerSetter.add(button)('click', () => {\r\n          this.togglePlay();\r\n        });\r\n      });\r\n\r\n      if(this.pipButton) {\r\n        listenerSetter.add(this.pipButton)('click', () => {\r\n          this.video.requestPictureInPicture();\r\n        });\r\n\r\n        const onPip = (pip: boolean) => {\r\n          this.wrapper.style.visibility = pip ? 'hidden': '';\r\n          if(this.onPip) {\r\n            this.onPip(pip);\r\n          }\r\n        };\r\n\r\n        const debounceTime = 20;\r\n        const debouncedPip = debounce(onPip, debounceTime, false, true);\r\n\r\n        listenerSetter.add(video)('enterpictureinpicture', () => {\r\n          debouncedPip(true);\r\n\r\n          listenerSetter.add(video)('leavepictureinpicture', () => {\r\n            const onPause = () => {\r\n              clearTimeout(timeout);\r\n              if(this.onPipClose) {\r\n                this.onPipClose();\r\n              }\r\n            };\r\n            const listener = listenerSetter.add(video)('pause', onPause, {once: true}) as any as Listener;\r\n            const timeout = setTimeout(() => {\r\n              listenerSetter.remove(listener);\r\n            }, debounceTime);\r\n          }, {once: true});\r\n        });\r\n\r\n        listenerSetter.add(video)('leavepictureinpicture', () => {\r\n          debouncedPip(false);\r\n        });\r\n      }\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        listenerSetter.add(video)('click', () => {\r\n          this.togglePlay();\r\n        });\r\n\r\n        listenerSetter.add(document)('keydown', (e: KeyboardEvent) => {\r\n          if(overlayCounter.overlaysActive > 1 || document.pictureInPictureElement === video) { // forward popup is active, etc\r\n            return;\r\n          }\r\n\r\n          const {key, code} = e;\r\n\r\n          let good = true;\r\n          if(code === 'KeyF') {\r\n            this.toggleFullScreen();\r\n          } else if(code === 'KeyM') {\r\n            appMediaPlaybackController.muted = !appMediaPlaybackController.muted;\r\n          } else if(code === 'Space') {\r\n            this.togglePlay();\r\n          } else if(e.altKey && (code === 'Equal' || code === 'Minus')) {\r\n            const add = code === 'Equal' ? 1 : -1;\r\n            const playbackRate = appMediaPlaybackController.playbackRate;\r\n            const idx = VideoPlayer.PLAYBACK_RATES.indexOf(playbackRate);\r\n            const nextIdx = idx + add;\r\n            if(nextIdx >= 0 && nextIdx < VideoPlayer.PLAYBACK_RATES.length) {\r\n              appMediaPlaybackController.playbackRate = VideoPlayer.PLAYBACK_RATES[nextIdx];\r\n            }\r\n          } else if(wrapper.classList.contains('ckin__fullscreen') && (key === 'ArrowLeft' || key === 'ArrowRight')) {\r\n            if(key === 'ArrowLeft') appMediaPlaybackController.seekBackward({action: 'seekbackward'});\r\n            else appMediaPlaybackController.seekForward({action: 'seekforward'});\r\n          } else {\r\n            good = false;\r\n          }\r\n\r\n          if(good) {\r\n            cancelEvent(e);\r\n            return false;\r\n          }\r\n        });\r\n      }\r\n\r\n      listenerSetter.add(video)('dblclick', () => {\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          this.toggleFullScreen();\r\n        }\r\n      });\r\n\r\n      listenerSetter.add(fullScreenButton)('click', () => {\r\n        this.toggleFullScreen();\r\n      });\r\n\r\n      addFullScreenListener(wrapper, this.onFullScreen.bind(this, fullScreenButton), listenerSetter);\r\n\r\n      listenerSetter.add(video)('timeupdate', () => {\r\n        timeElapsed.innerHTML = toHHMMSS(video.currentTime | 0);\r\n      });\r\n\r\n      listenerSetter.add(video)('play', () => {\r\n        wrapper.classList.add('played');\r\n\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          listenerSetter.add(video)('play', () => {\r\n            this.hideControls(true);\r\n          });\r\n        }\r\n      }, {once: true});\r\n\r\n      listenerSetter.add(video)('pause', () => {\r\n        this.showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(appMediaPlaybackController)('playbackParams', () => {\r\n        this.setPlaybackRateIcon();\r\n      });\r\n    }\r\n\r\n    listenerSetter.add(video)('play', () => {\r\n      wrapper.classList.add('is-playing');\r\n    });\r\n\r\n    listenerSetter.add(video)('pause', () => {\r\n      wrapper.classList.remove('is-playing');\r\n    });\r\n\r\n    if(video.duration || initDuration) {\r\n      timeDuration.innerHTML = toHHMMSS(Math.round(video.duration || initDuration));\r\n    } else {\r\n      onMediaLoad(video).then(() => {\r\n        timeDuration.innerHTML = toHHMMSS(Math.round(video.duration));\r\n      });\r\n    }\r\n  }\r\n\r\n  protected togglePlay() {\r\n    this.video[this.video.paused ? 'play' : 'pause']();\r\n  }\r\n\r\n  private buildControls() {\r\n    const skin = this.skin;\r\n    if(skin === 'default') {\r\n      return `\r\n      <button class=\"${skin}__button--big toggle tgico\" title=\"Toggle Play\"></button>\r\n      <div class=\"${skin}__gradient-bottom ckin__controls\"></div>\r\n      <div class=\"${skin}__controls ckin__controls\">\r\n        <div class=\"bottom-controls\">\r\n          <div class=\"left-controls\">\r\n            <button class=\"btn-icon ${skin}__button toggle tgico\" title=\"Toggle Video\"></button>\r\n            <div class=\"time\">\r\n              <time id=\"time-elapsed\">0:00</time>\r\n              <span> / </span>\r\n              <time id=\"time-duration\">0:00</time>\r\n            </div>\r\n          </div>\r\n          <div class=\"right-controls\">\r\n            <button class=\"btn-icon ${skin}__button btn-menu-toggle playback-rate night\" title=\"Playback Rate\"></button>\r\n            ${!IS_MOBILE && document.pictureInPictureEnabled ? `<button class=\"btn-icon ${skin}__button pip tgico-pip\" title=\"Picture-in-Picture\"></button>` : ''}\r\n            <button class=\"btn-icon ${skin}__button fullscreen tgico-fullscreen\" title=\"Full Screen\"></button>\r\n          </div>\r\n        </div>\r\n      </div>`;\r\n    }\r\n  }\r\n\r\n  protected setBtnMenuToggle() {\r\n    const buttons: Parameters<typeof ButtonMenu>[0] = VideoPlayer.PLAYBACK_RATES.map((rate, idx) => {\r\n      return { \r\n        // icon: VideoPlayer.PLAYBACK_RATES_ICONS[idx],\r\n        regularText: rate + 'x', \r\n        onClick: () => {\r\n          appMediaPlaybackController.playbackRate = rate;\r\n        }\r\n      };\r\n    });\r\n    const btnMenu = ButtonMenu(buttons);\r\n    btnMenu.classList.add('top-left');\r\n    ButtonMenuToggleHandler(\r\n      this.playbackRateButton, \r\n      this.onPlaybackRackMenuToggle ? () => {\r\n        this.onPlaybackRackMenuToggle(true);\r\n      } : undefined, \r\n      undefined, \r\n      this.onPlaybackRackMenuToggle ? () => {\r\n        this.onPlaybackRackMenuToggle(false);\r\n      } : undefined\r\n    );\r\n    this.playbackRateButton.append(btnMenu);\r\n\r\n    this.setPlaybackRateIcon();\r\n  }\r\n\r\n  protected setPlaybackRateIcon() {\r\n    const playbackRateButton = this.playbackRateButton;\r\n    VideoPlayer.PLAYBACK_RATES_ICONS.forEach((className) => {\r\n      className = 'tgico-' + className;\r\n      playbackRateButton.classList.remove(className);\r\n    });\r\n\r\n    let idx = VideoPlayer.PLAYBACK_RATES.indexOf(appMediaPlaybackController.playbackRate);\r\n    if(idx === -1) idx = VideoPlayer.PLAYBACK_RATES.indexOf(1);\r\n\r\n    playbackRateButton.classList.add('tgico-' + VideoPlayer.PLAYBACK_RATES_ICONS[idx]);\r\n  }\r\n  \r\n  protected toggleFullScreen() {\r\n    const player = this.wrapper;\r\n\r\n    // * https://caniuse.com/#feat=fullscreen\r\n    if(IS_APPLE_MOBILE) {\r\n      const video = this.video as any;\r\n      video.webkitEnterFullscreen();\r\n      video.enterFullscreen();\r\n      return;\r\n    }\r\n    \r\n    if(!isFullScreen()) {\r\n      /* const videoParent = this.video.parentElement;\r\n      const videoWhichChild = whichChild(this.video);\r\n      const needVideoRemount = videoParent !== player;\r\n\r\n      if(needVideoRemount) {\r\n        this.videoParent = videoParent;\r\n        this.videoWhichChild = videoWhichChild;\r\n        player.prepend(this.video);\r\n      } */\r\n  \r\n      requestFullScreen(player);\r\n    } else {\r\n      /* if(this.videoParent) {\r\n        const {videoWhichChild, videoParent} = this;\r\n        if(!videoWhichChild) {\r\n          videoParent.prepend(this.video);\r\n        } else {\r\n          videoParent.insertBefore(this.video, videoParent.children[videoWhichChild]);\r\n        }\r\n\r\n        this.videoParent = null;\r\n        this.videoWhichChild = -1;\r\n      } */\r\n  \r\n      cancelFullScreen();\r\n    }\r\n  }\r\n  \r\n  protected onFullScreen(fullScreenButton: HTMLElement) {\r\n    const isFull = isFullScreen();\r\n    this.wrapper.classList.toggle('ckin__fullscreen', isFull);\r\n    if(!isFull) {\r\n      fullScreenButton.classList.remove('tgico-smallscreen');\r\n      fullScreenButton.classList.add('tgico-fullscreen');\r\n      fullScreenButton.setAttribute('title', 'Full Screen');\r\n    } else {\r\n      fullScreenButton.classList.remove('tgico-fullscreen');\r\n      fullScreenButton.classList.add('tgico-smallscreen');\r\n      fullScreenButton.setAttribute('title', 'Exit Full Screen');\r\n    }\r\n  }\r\n\r\n  public cleanup() {\r\n    super.cleanup();\r\n    this.listenerSetter.removeAll();\r\n    this.progress.removeListeners();\r\n    this.onPlaybackRackMenuToggle = this.onPip = undefined;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport deferredPromise from \"../helpers/cancellablePromise\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport { IS_MOBILE_SAFARI, IS_SAFARI } from \"../environment/userAgent\";\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { logger } from \"../lib/logger\";\r\nimport VideoPlayer from \"../lib/mediaPlayer\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport animationIntersector from \"./animationIntersector\";\r\nimport appMediaPlaybackController, { AppMediaPlaybackController } from \"./appMediaPlaybackController\";\r\nimport AvatarElement from \"./avatar\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport ButtonMenuToggle from \"./buttonMenuToggle\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\nimport { formatFullSentTime } from \"../helpers/date\";\r\nimport appNavigationController, { NavigationItem } from \"./appNavigationController\";\r\nimport { Message } from \"../layer\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport renderImageFromUrl, { renderImageFromUrlPromise } from \"../helpers/dom/renderImageFromUrl\";\r\nimport getVisibleRect from \"../helpers/dom/getVisibleRect\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport fillPropertyValue from \"../helpers/fillPropertyValue\";\r\nimport generatePathData from \"../helpers/generatePathData\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport { doubleRaf, fastRaf } from \"../helpers/schedulers\";\r\nimport RangeSelector from \"./rangeSelector\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport ListLoader from \"../helpers/listLoader\";\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport { MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport { isFullScreen } from \"../helpers/dom/fullScreen\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport SearchListLoader from \"../helpers/searchListLoader\";\r\nimport createVideo from \"../helpers/dom/createVideo\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getStrippedThumbIfNeeded from \"../helpers/getStrippedThumbIfNeeded\";\r\nimport setAttachmentSize from \"../helpers/setAttachmentSize\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport LazyLoadQueueBase from \"./lazyLoadQueueBase\";\r\nimport overlayCounter from \"../helpers/overlayCounter\";\r\nimport { ThumbCache } from \"../lib/storages/thumbs\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport wrapPeerTitle from \"./wrappers/peerTitle\";\r\n\r\nconst ZOOM_STEP = 0.5;\r\nconst ZOOM_INITIAL_VALUE = 1;\r\nconst ZOOM_MIN_VALUE = 0.5;\r\nconst ZOOM_MAX_VALUE = 4;\r\n\r\n// TODO: масштабирование картинок (не SVG) при ресайзе, и правильный возврат на исходную позицию\r\n// TODO: картинки \"обрезаются\" если возвращаются или появляются с места, где есть их перекрытие (топбар, поле ввода)\r\n// TODO: видео в мобильной вёрстке, если показываются элементы управления: если свайпнуть в сторону, то элементы вернутся на место, т.е. прыгнут - это не ок, надо бы замаскировать\r\n\r\nexport const MEDIA_VIEWER_CLASSNAME = 'media-viewer';\r\n\r\nexport default class AppMediaViewerBase<\r\n  ContentAdditionType extends string, \r\n  ButtonsAdditionType extends string, \r\n  TargetType extends {element: HTMLElement\r\n}> extends EventListenerBase<{\r\n  setMoverBefore: () => void,\r\n  setMoverAfter: () => void\r\n}> {\r\n  protected wholeDiv: HTMLElement;\r\n  protected overlaysDiv: HTMLElement;\r\n  protected author: {[k in 'container' | 'avatarEl' | 'nameEl' | 'date']: HTMLElement} = {} as any;\r\n  protected content: {[k in 'main' | 'container' | 'media' | 'mover' | ContentAdditionType]: HTMLElement} = {} as any;\r\n  protected buttons: {[k in 'download' | 'close' | 'prev' | 'next' | 'mobile-close' | 'zoom' | ButtonsAdditionType]: HTMLElement} = {} as any;\r\n  protected topbar: HTMLElement;\r\n  protected moversContainer: HTMLElement;\r\n  \r\n  protected tempId = 0;\r\n  protected preloader: ProgressivePreloader = null;\r\n  protected preloaderStreamable: ProgressivePreloader = null;\r\n\r\n  //protected targetContainer: HTMLElement = null;\r\n  //protected loadMore: () => void = null;\r\n\r\n  protected log: ReturnType<typeof logger>; \r\n\r\n  protected isFirstOpen = true;\r\n\r\n  // protected needLoadMore = true;\r\n\r\n  protected pageEl = document.getElementById('page-chats') as HTMLDivElement;\r\n\r\n  protected setMoverPromise: Promise<void>;\r\n  protected setMoverAnimationPromise: Promise<void>;\r\n\r\n  protected lazyLoadQueue: LazyLoadQueueBase;\r\n\r\n  protected highlightSwitchersTimeout: number;\r\n\r\n  protected onDownloadClick: (e: MouseEvent) => void;\r\n  protected onPrevClick: (target: TargetType) => void;\r\n  protected onNextClick: (target: TargetType) => void;\r\n\r\n  protected videoPlayer: VideoPlayer;\r\n\r\n  protected zoomElements: {\r\n    container: HTMLElement,\r\n    btnOut: HTMLElement,\r\n    btnIn: HTMLElement,\r\n    rangeSelector: RangeSelector\r\n  } = {} as any;\r\n  // protected zoomValue = ZOOM_INITIAL_VALUE;\r\n  protected zoomSwipeHandler: SwipeHandler;\r\n  protected zoomSwipeStartX = 0;\r\n  protected zoomSwipeStartY = 0;\r\n  protected zoomSwipeX = 0;\r\n  protected zoomSwipeY = 0;\r\n  \r\n  protected ctrlKeyDown: boolean;\r\n  protected releaseSingleMedia: ReturnType<AppMediaPlaybackController['setSingleMedia']>;\r\n  protected navigationItem: NavigationItem;\r\n\r\n  protected managers: AppManagers;\r\n\r\n  get target() {\r\n    return this.listLoader.current;\r\n  }\r\n\r\n  set target(value) {\r\n    this.listLoader.current = value;\r\n  }\r\n\r\n  constructor(\r\n    protected listLoader: ListLoader<TargetType, any>, \r\n    topButtons: Array<keyof AppMediaViewerBase<ContentAdditionType, ButtonsAdditionType, TargetType>['buttons']>\r\n  ) {\r\n    super(false);\r\n\r\n    this.managers = rootScope.managers;\r\n\r\n    this.log = logger('AMV');\r\n    this.preloader = new ProgressivePreloader();\r\n    this.preloaderStreamable = new ProgressivePreloader({\r\n      cancelable: false,\r\n      streamable: true\r\n    });\r\n    this.preloader.construct();\r\n    this.preloaderStreamable.construct();\r\n    this.lazyLoadQueue = new LazyLoadQueueBase();\r\n\r\n    this.wholeDiv = document.createElement('div');\r\n    this.wholeDiv.classList.add(MEDIA_VIEWER_CLASSNAME + '-whole');\r\n\r\n    this.overlaysDiv = document.createElement('div');\r\n    this.overlaysDiv.classList.add('overlays');\r\n\r\n    const mainDiv = document.createElement('div');\r\n    mainDiv.classList.add(MEDIA_VIEWER_CLASSNAME);\r\n\r\n    const topbar = this.topbar = document.createElement('div');\r\n    topbar.classList.add(MEDIA_VIEWER_CLASSNAME + '-topbar', MEDIA_VIEWER_CLASSNAME + '-appear');\r\n\r\n    const topbarLeft = document.createElement('div');\r\n    topbarLeft.classList.add(MEDIA_VIEWER_CLASSNAME + '-topbar-left');\r\n\r\n    this.buttons['mobile-close'] = ButtonIcon('close', {onlyMobile: true});\r\n    \r\n    // * author\r\n    this.author.container = document.createElement('div');\r\n    this.author.container.classList.add(MEDIA_VIEWER_CLASSNAME + '-author', 'no-select');\r\n    const authorRight = document.createElement('div');\r\n    \r\n    this.author.avatarEl = new AvatarElement();\r\n    this.author.avatarEl.classList.add(MEDIA_VIEWER_CLASSNAME + '-userpic', 'avatar-44');\r\n    \r\n    this.author.nameEl = document.createElement('div');\r\n    this.author.nameEl.classList.add(MEDIA_VIEWER_CLASSNAME + '-name');\r\n    \r\n    this.author.date = document.createElement('div');\r\n    this.author.date.classList.add(MEDIA_VIEWER_CLASSNAME + '-date');\r\n    \r\n    authorRight.append(this.author.nameEl, this.author.date);\r\n    \r\n    this.author.container.append(this.author.avatarEl, authorRight);\r\n    \r\n    // * buttons\r\n    const buttonsDiv = document.createElement('div');\r\n    buttonsDiv.classList.add(MEDIA_VIEWER_CLASSNAME + '-buttons');\r\n    \r\n    topButtons.concat(['download', 'zoom', 'close']).forEach((name) => {\r\n      const button = ButtonIcon(name, {noRipple: true});\r\n      this.buttons[name] = button;\r\n      buttonsDiv.append(button);\r\n    });\r\n\r\n    this.buttons.zoom.classList.add('zoom-in');\r\n\r\n    // * zoom\r\n    this.zoomElements.container = document.createElement('div');\r\n    this.zoomElements.container.classList.add('zoom-container');\r\n\r\n    this.zoomElements.btnOut = ButtonIcon('zoomout', {noRipple: true});\r\n    attachClickEvent(this.zoomElements.btnOut, () => this.changeZoom(false));\r\n    this.zoomElements.btnIn = ButtonIcon('zoomin', {noRipple: true});\r\n    attachClickEvent(this.zoomElements.btnIn, () => this.changeZoom(true));\r\n\r\n    this.zoomElements.rangeSelector = new RangeSelector({\r\n      step: ZOOM_STEP, \r\n      min: ZOOM_MIN_VALUE, \r\n      max: ZOOM_MAX_VALUE, \r\n      withTransition: true\r\n    }, ZOOM_INITIAL_VALUE);\r\n    this.zoomElements.rangeSelector.setListeners();\r\n    this.zoomElements.rangeSelector.setHandlers({\r\n      onScrub: this.setZoomValue,\r\n      onMouseUp: () => this.setZoomValue()\r\n    });\r\n\r\n    this.zoomElements.container.append(this.zoomElements.btnOut, this.zoomElements.rangeSelector.container, this.zoomElements.btnIn);\r\n\r\n    this.wholeDiv.append(this.zoomElements.container);\r\n\r\n    // * content\r\n    this.content.main = document.createElement('div');\r\n    this.content.main.classList.add(MEDIA_VIEWER_CLASSNAME + '-content');\r\n\r\n    this.content.container = document.createElement('div');\r\n    this.content.container.classList.add(MEDIA_VIEWER_CLASSNAME + '-container');\r\n\r\n    this.content.media = document.createElement('div');\r\n    this.content.media.classList.add(MEDIA_VIEWER_CLASSNAME + '-media');\r\n\r\n    this.content.container.append(this.content.media);\r\n\r\n    this.content.main.append(this.content.container);\r\n    mainDiv.append(this.content.main);\r\n    this.overlaysDiv.append(mainDiv);\r\n    // * overlays end\r\n    \r\n    topbarLeft.append(this.buttons['mobile-close'], this.author.container);\r\n    topbar.append(topbarLeft, buttonsDiv);\r\n\r\n    this.buttons.prev = document.createElement('div');\r\n    this.buttons.prev.className = `${MEDIA_VIEWER_CLASSNAME}-switcher ${MEDIA_VIEWER_CLASSNAME}-switcher-left`;\r\n    this.buttons.prev.innerHTML = `<span class=\"tgico-down ${MEDIA_VIEWER_CLASSNAME}-prev-button\"></span>`;\r\n\r\n    this.buttons.next = document.createElement('div');\r\n    this.buttons.next.className = `${MEDIA_VIEWER_CLASSNAME}-switcher ${MEDIA_VIEWER_CLASSNAME}-switcher-right`;\r\n    this.buttons.next.innerHTML = `<span class=\"tgico-down ${MEDIA_VIEWER_CLASSNAME}-next-button\"></span>`;\r\n\r\n    this.moversContainer = document.createElement('div');\r\n    this.moversContainer.classList.add(MEDIA_VIEWER_CLASSNAME + '-movers');\r\n\r\n    this.wholeDiv.append(this.overlaysDiv, this.buttons.prev, this.buttons.next, this.topbar, this.moversContainer);\r\n\r\n    // * constructing html end\r\n\r\n    this.listLoader.onLoadedMore = () => {\r\n      this.buttons.prev.classList.toggle('hide', !this.listLoader.previous.length);\r\n      this.buttons.next.classList.toggle('hide', !this.listLoader.next.length);\r\n    };\r\n\r\n    this.setNewMover();\r\n  }\r\n\r\n  protected setListeners() {\r\n    attachClickEvent(this.buttons.download, this.onDownloadClick);\r\n    [this.buttons.close, this.buttons['mobile-close'], this.preloaderStreamable.preloader].forEach((el) => {\r\n      attachClickEvent(el, this.close.bind(this));\r\n    });\r\n\r\n    ([[-1, this.buttons.prev], [1, this.buttons.next]] as [number, HTMLElement][]).forEach(([moveLength, button]) => {\r\n      // attachClickEvent(button, (e) => {\r\n      button.addEventListener('click', (e) => {\r\n        cancelEvent(e);\r\n        if(this.setMoverPromise) return;\r\n  \r\n        this.listLoader.go(moveLength);\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.buttons.zoom, () => {\r\n      if(this.isZooming()) this.toggleZoom(false);\r\n      else {\r\n        this.changeZoom(true);\r\n      }\r\n    });\r\n\r\n    // ! cannot use the function because it'll cancel slide event on touch devices\r\n    // attachClickEvent(this.wholeDiv, this.onClick);\r\n    this.wholeDiv.addEventListener('click', this.onClick);\r\n\r\n    this.listLoader.onJump = (item, older) => {\r\n      if(older) this.onNextClick(item);\r\n      else this.onPrevClick(item);\r\n    };\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      const swipeHandler = new SwipeHandler({\r\n        element: this.wholeDiv, \r\n        onSwipe: (xDiff, yDiff) => {\r\n          if(isFullScreen()) {\r\n            return;\r\n          }\r\n          //console.log(xDiff, yDiff);\r\n\r\n          const percents = Math.abs(xDiff) / windowSize.width;\r\n          if(percents > .2 || xDiff > 125) {\r\n            //console.log('will swipe', xDiff);\r\n\r\n            if(xDiff < 0) {\r\n              this.buttons.prev.click();\r\n            } else {\r\n              this.buttons.next.click();\r\n            }\r\n\r\n            return true;\r\n          }\r\n\r\n          const percentsY = Math.abs(yDiff) / windowSize.height;\r\n          if(percentsY > .2 || yDiff > 125) {\r\n            this.close();\r\n            return true;\r\n          }\r\n\r\n          return false;\r\n        }, \r\n        verifyTouchTarget: (evt) => {\r\n          // * Fix for seek input\r\n          if((evt.target as HTMLElement).tagName === 'INPUT' || findUpClassName(evt.target, 'media-viewer-caption')) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  protected toggleZoom(enable?: boolean) {\r\n    const isVisible = this.isZooming();\r\n    if(this.zoomElements.rangeSelector.mousedown || this.ctrlKeyDown) {\r\n      enable = true;\r\n    }\r\n\r\n    if(isVisible === enable) return;\r\n\r\n    if(enable === undefined) {\r\n      enable = !isVisible;\r\n    }\r\n\r\n    this.buttons.zoom.classList.toggle('zoom-in', !enable);\r\n    this.zoomElements.container.classList.toggle('is-visible', enable);\r\n    const zoomValue = enable ? this.zoomElements.rangeSelector.value : 1;\r\n    this.setZoomValue(zoomValue);\r\n    this.zoomElements.rangeSelector.setProgress(zoomValue);\r\n\r\n    if(this.videoPlayer) {\r\n      this.videoPlayer.lockControls(enable ? false : undefined);\r\n    }\r\n\r\n    if(enable) {\r\n      if(!this.zoomSwipeHandler) {\r\n        let lastDiffX: number, lastDiffY: number;\r\n        const multiplier = -1;\r\n        this.zoomSwipeHandler = new SwipeHandler({\r\n          element: this.moversContainer,\r\n          onFirstSwipe: () => {\r\n            lastDiffX = lastDiffY = 0;\r\n            this.moversContainer.classList.add('no-transition');\r\n          },\r\n          onSwipe: (xDiff, yDiff) => {\r\n            [xDiff, yDiff] = [xDiff * multiplier, yDiff * multiplier];\r\n            this.zoomSwipeX += xDiff - lastDiffX;\r\n            this.zoomSwipeY += yDiff - lastDiffY;\r\n            [lastDiffX, lastDiffY] = [xDiff, yDiff];\r\n\r\n            this.setZoomValue();\r\n          },\r\n          onReset: () => {\r\n            this.moversContainer.classList.remove('no-transition');\r\n          },\r\n          cursor: 'move'\r\n        });\r\n      } else {\r\n        this.zoomSwipeHandler.setListeners();\r\n      }\r\n      \r\n      this.zoomElements.rangeSelector.setProgress(zoomValue);\r\n    } else if(!enable) {\r\n      this.zoomSwipeHandler.removeListeners();\r\n    }\r\n  }\r\n\r\n  protected changeZoom(add: boolean) {\r\n    this.zoomElements.rangeSelector.addProgress(ZOOM_STEP * (add ? 1 : -1));\r\n    this.setZoomValue();\r\n  }\r\n\r\n  protected setZoomValue = (value = this.zoomElements.rangeSelector.value) => {\r\n    // this.zoomValue = value;\r\n    if(value === ZOOM_INITIAL_VALUE) {\r\n      this.zoomSwipeX = 0;\r\n      this.zoomSwipeY = 0;\r\n    }\r\n\r\n    this.moversContainer.style.transform = `matrix(${value}, 0, 0, ${value}, ${this.zoomSwipeX}, ${this.zoomSwipeY})`;\r\n\r\n    this.zoomElements.btnOut.classList.toggle('inactive', value === ZOOM_MIN_VALUE);\r\n    this.zoomElements.btnIn.classList.toggle('inactive', value === ZOOM_MAX_VALUE);\r\n\r\n    this.toggleZoom(value !== ZOOM_INITIAL_VALUE);\r\n  };\r\n\r\n  protected isZooming() {\r\n    return this.zoomElements.container.classList.contains('is-visible');\r\n  }\r\n\r\n  protected setBtnMenuToggle(buttons: ButtonMenuItemOptions[]) {\r\n    const btnMenuToggle = ButtonMenuToggle({onlyMobile: true}, 'bottom-left', buttons);\r\n    this.topbar.append(btnMenuToggle);\r\n  }\r\n\r\n  public close(e?: MouseEvent) {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.setMoverAnimationPromise) return Promise.reject();\r\n\r\n    if(this.navigationItem) {\r\n      appNavigationController.removeItem(this.navigationItem);\r\n    }\r\n\r\n    this.lazyLoadQueue.clear();\r\n\r\n    const promise = this.setMoverToTarget(this.target?.element, true).then(({onAnimationEnd}) => onAnimationEnd);\r\n\r\n    this.listLoader.reset();\r\n    (this.listLoader as SearchListLoader<any>).cleanup && (this.listLoader as SearchListLoader<any>).cleanup();\r\n    this.setMoverPromise = null;\r\n    this.tempId = -1;\r\n    if((window as any).appMediaViewer === this) {\r\n      (window as any).appMediaViewer = undefined;\r\n    }\r\n\r\n    /* if(appSidebarRight.historyTabIDs.slice(-1)[0] === AppSidebarRight.SLIDERITEMSIDS.forward) {\r\n      promise.then(() => {\r\n        appSidebarRight.forwardTab.closeBtn.click();\r\n      });\r\n    } */\r\n\r\n    this.removeGlobalListeners();\r\n\r\n    this.zoomSwipeHandler = undefined;\r\n\r\n    promise.finally(() => {\r\n      this.wholeDiv.remove();\r\n      this.toggleOverlay(false);\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  protected toggleOverlay(active: boolean) {\r\n    overlayCounter.isOverlayActive = active;\r\n    animationIntersector.checkAnimations(active);\r\n  }\r\n\r\n  protected toggleGlobalListeners(active: boolean) {\r\n    if(active) this.setGlobalListeners();\r\n    else this.removeGlobalListeners();\r\n  }\r\n\r\n  protected removeGlobalListeners() {\r\n    if(this.zoomSwipeHandler) {\r\n      this.zoomSwipeHandler.removeListeners();\r\n    }\r\n\r\n    window.removeEventListener('keydown', this.onKeyDown);\r\n    window.removeEventListener('keyup', this.onKeyUp);\r\n    window.removeEventListener('wheel', this.onWheel, {capture: true});\r\n  }\r\n\r\n  protected setGlobalListeners() {\r\n    if(this.isZooming()) {\r\n      this.zoomSwipeHandler.setListeners();\r\n    }\r\n\r\n    window.addEventListener('keydown', this.onKeyDown);\r\n    window.addEventListener('keyup', this.onKeyUp);\r\n    if(!IS_TOUCH_SUPPORTED) window.addEventListener('wheel', this.onWheel, {passive: false, capture: true});\r\n  }\r\n\r\n  onClick = (e: MouseEvent) => {\r\n    if(this.setMoverAnimationPromise) return;\r\n\r\n    const target = e.target as HTMLElement;\r\n    if(target.tagName === 'A') return;\r\n    cancelEvent(e);\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      if(this.highlightSwitchersTimeout) {\r\n        clearTimeout(this.highlightSwitchersTimeout);\r\n      } else {\r\n        this.wholeDiv.classList.add('highlight-switchers');\r\n      }\r\n\r\n      this.highlightSwitchersTimeout = window.setTimeout(() => {\r\n        this.wholeDiv.classList.remove('highlight-switchers');\r\n        this.highlightSwitchersTimeout = 0;\r\n      }, 3e3);\r\n      \r\n      return;\r\n    }\r\n\r\n    const isZooming = this.isZooming();\r\n    let mover: HTMLElement = null;\r\n    const classNames = ['ckin__player', 'media-viewer-buttons', 'media-viewer-author', 'media-viewer-caption', 'zoom-container'];\r\n    if(isZooming) {\r\n      classNames.push('media-viewer-movers');\r\n    }\r\n\r\n    classNames.find((s) => {\r\n      try {\r\n        mover = findUpClassName(target, s);\r\n        if(mover) return true;\r\n      } catch(err) {return false;}\r\n    });\r\n\r\n    if(/* target === this.mediaViewerDiv */!mover || (!isZooming && (target.tagName === 'IMG' || target.tagName === 'image'))) {\r\n      this.close();\r\n    }\r\n  };\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    //this.log('onKeyDown', e);\r\n    if(overlayCounter.overlaysActive > 1) {\r\n      return;\r\n    }\r\n\r\n    const key = e.key;\r\n    \r\n    let good = true;\r\n    if(key === 'ArrowRight') {\r\n      this.buttons.next.click();\r\n    } else if(key === 'ArrowLeft') {\r\n      this.buttons.prev.click();\r\n    } else if(key === '-' || key === '=') {\r\n      if(this.ctrlKeyDown) {\r\n        this.changeZoom(key === '=');\r\n      }\r\n    } else {\r\n      good = false;\r\n    }\r\n\r\n    if(e.ctrlKey || e.metaKey) {\r\n      this.ctrlKeyDown = true;\r\n    }\r\n\r\n    if(good) {\r\n      cancelEvent(e);\r\n    }\r\n  };\r\n\r\n  private onKeyUp = (e: KeyboardEvent) => {\r\n    if(overlayCounter.overlaysActive > 1) {\r\n      return;\r\n    }\r\n\r\n    if(!(e.ctrlKey || e.metaKey)) {\r\n      this.ctrlKeyDown = false;\r\n\r\n      if(this.isZooming()) {\r\n        this.setZoomValue();\r\n      }\r\n    }\r\n  };\r\n\r\n  private onWheel = (e: WheelEvent) => {\r\n    if(overlayCounter.overlaysActive > 1 || (findUpClassName(e.target, 'media-viewer-caption') && !this.ctrlKeyDown)) {\r\n      return;\r\n    }\r\n\r\n    cancelEvent(e);\r\n\r\n    if(this.ctrlKeyDown) {\r\n      const scrollingUp = e.deltaY < 0;\r\n      // if(!scrollingUp && !this.isZooming()) return;\r\n      this.changeZoom(!!scrollingUp);\r\n    }\r\n  };\r\n\r\n  protected async setMoverToTarget(target: HTMLElement, closing = false, fromRight = 0) {\r\n    this.dispatchEvent('setMoverBefore');\r\n\r\n    const mover = this.content.mover;\r\n\r\n    if(!closing) {\r\n      mover.innerHTML = '';\r\n      //mover.append(this.buttons.prev, this.buttons.next);\r\n    }\r\n    \r\n    const zoomValue = this.isZooming() && closing /* && false */ ? this.zoomElements.rangeSelector.value : ZOOM_INITIAL_VALUE;\r\n    /* if(!(zoomValue > 1 && closing)) */ this.removeCenterFromMover(mover);\r\n\r\n    const wasActive = fromRight !== 0;\r\n\r\n    const delay = rootScope.settings.animationsEnabled ? (wasActive ? 350 : 200) : 0;\r\n    //let delay = wasActive ? 350 : 10000;\r\n\r\n    /* if(wasActive) {\r\n      this.moveTheMover(mover);\r\n      mover = this.setNewMover();\r\n    } */\r\n\r\n    /* if(DEBUG) {\r\n      this.log('setMoverToTarget', target, closing, wasActive, fromRight);\r\n    } */\r\n\r\n    let realParent: HTMLElement;\r\n\r\n    let rect: DOMRect;\r\n    if(target) {\r\n      if(target instanceof AvatarElement || target.classList.contains('grid-item')/*  || target.classList.contains('document-ico') */) {\r\n        realParent = target;\r\n        rect = target.getBoundingClientRect();\r\n      } else if(target instanceof SVGImageElement || target.parentElement instanceof SVGForeignObjectElement) {\r\n        realParent = findUpClassName(target, 'attachment');\r\n        rect = realParent.getBoundingClientRect();\r\n      } else if(target.classList.contains('profile-avatars-avatar')) {\r\n        realParent = findUpClassName(target, 'profile-avatars-container');\r\n        rect = realParent.getBoundingClientRect();\r\n\r\n        // * if not active avatar\r\n        if(closing && target.getBoundingClientRect().left !== rect.left) {\r\n          target = realParent = rect = undefined;\r\n        }\r\n      }\r\n    }\r\n\r\n    if(!target) {\r\n      target = this.content.media;\r\n    }\r\n\r\n    if(!rect) {\r\n      realParent = target.parentElement as HTMLElement;\r\n      rect = target.getBoundingClientRect();\r\n    }\r\n\r\n    let needOpacity = false;\r\n    if(target !== this.content.media && !target.classList.contains('profile-avatars-avatar')) {\r\n      const overflowElement = findUpClassName(realParent, 'scrollable');\r\n      const visibleRect = getVisibleRect(realParent, overflowElement, true);\r\n\r\n      if(closing && (!visibleRect || visibleRect.overflow.vertical === 2 || visibleRect.overflow.horizontal === 2)) {\r\n        target = this.content.media;\r\n        realParent = target.parentElement as HTMLElement;\r\n        rect = target.getBoundingClientRect();\r\n      } else if(visibleRect && (visibleRect.overflow.vertical === 1 || visibleRect.overflow.horizontal === 1)) {\r\n        needOpacity = true;\r\n      }\r\n    }\r\n\r\n    const containerRect = this.content.media.getBoundingClientRect();\r\n    \r\n    let transform = '';\r\n    let left: number;\r\n    let top: number;\r\n\r\n    if(wasActive) {\r\n      left = fromRight === 1 ? windowSize.width : -containerRect.width;\r\n      top = containerRect.top;\r\n    } else {\r\n      left = rect.left;\r\n      top = rect.top;\r\n    }\r\n\r\n    /* if(zoomValue > 1) { // 33\r\n      // const diffX = (rect.width * zoomValue - rect.width) / 4;\r\n      const diffX = (rect.width * zoomValue - rect.width) / 2;\r\n      const diffY = (rect.height * zoomValue - rect.height) / 4;\r\n      // left -= diffX;\r\n      // top += diffY;\r\n    } */\r\n\r\n    transform += `translate3d(${left}px,${top}px,0) `;\r\n\r\n    /* if(wasActive) {\r\n      left = fromRight === 1 ? appPhotosManager.windowW / 2 : -(containerRect.width + appPhotosManager.windowW / 2);\r\n      transform += `translate(${left}px,-50%) `;\r\n    } else {\r\n      left = rect.left - (appPhotosManager.windowW / 2);\r\n      top = rect.top - (appPhotosManager.windowH / 2);\r\n      transform += `translate(${left}px,${top}px) `;\r\n    } */\r\n\r\n    let aspecter: HTMLDivElement;\r\n    if(target instanceof HTMLImageElement || target instanceof HTMLVideoElement || target.tagName === 'DIV') {\r\n      if(mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter')) {\r\n        aspecter = mover.firstElementChild as HTMLDivElement;\r\n\r\n        const player = aspecter.querySelector('.ckin__player');\r\n        if(player) {\r\n          const video = player.firstElementChild as HTMLVideoElement;\r\n          aspecter.append(video);\r\n          player.remove();\r\n        }\r\n\r\n        if(!aspecter.style.cssText) { // всё из-за видео, элементы управления скейлятся, так бы можно было этого не делать\r\n          mover.classList.remove('active');\r\n          this.setFullAspect(aspecter, containerRect, rect);\r\n          void mover.offsetLeft; // reflow\r\n          mover.classList.add('active');\r\n        }\r\n      } else {\r\n        aspecter = document.createElement('div');\r\n        aspecter.classList.add('media-viewer-aspecter'/* , 'disable-hover' */);\r\n        mover.prepend(aspecter);\r\n      }\r\n      \r\n      aspecter.style.cssText = `width: ${rect.width}px; height: ${rect.height}px; transform: scale3d(${containerRect.width / rect.width}, ${containerRect.height / rect.height}, 1);`;\r\n    }\r\n\r\n    mover.style.width = containerRect.width + 'px';\r\n    mover.style.height = containerRect.height + 'px';\r\n\r\n    // const scaleX = rect.width / (containerRect.width * zoomValue);\r\n    // const scaleY = rect.height / (containerRect.height * zoomValue);\r\n    const scaleX = rect.width / containerRect.width;\r\n    const scaleY = rect.height / containerRect.height;\r\n    if(!wasActive) {\r\n      transform += `scale3d(${scaleX},${scaleY},1) `;\r\n    }\r\n\r\n    let borderRadius = window.getComputedStyle(realParent).getPropertyValue('border-radius');\r\n    const brSplitted = fillPropertyValue(borderRadius) as string[];\r\n    borderRadius = brSplitted.map((r) => (parseInt(r) / scaleX) + 'px').join(' ');\r\n    if(!wasActive) {\r\n      mover.style.borderRadius = borderRadius;\r\n    }\r\n    //let borderRadius = '0px 0px 0px 0px';\r\n\r\n    if(closing && zoomValue !== 1) {\r\n      // const width = this.moversContainer.scrollWidth * scaleX;\r\n      // const height = this.moversContainer.scrollHeight * scaleY;\r\n      const willBeLeft = windowSize.width / 2 - rect.width / 2;\r\n      const willBeTop = windowSize.height / 2 - rect.height / 2;\r\n      const left = rect.left - willBeLeft/*  + (width - rect.width) / 2 */;\r\n      const top = rect.top - willBeTop/*  + (height - rect.height) / 2 */;\r\n      this.moversContainer.style.transform = `matrix(${scaleX}, 0, 0, ${scaleY}, ${left}, ${top})`;\r\n    } else {\r\n      mover.style.transform = transform;\r\n    }\r\n\r\n    needOpacity && (mover.style.opacity = '0'/* !closing ? '0' : '' */);\r\n\r\n    /* if(wasActive) {\r\n      this.log('setMoverToTarget', mover.style.transform);\r\n    } */\r\n\r\n    let path: SVGPathElement;\r\n    const isOut = target.classList.contains('is-out');\r\n\r\n    const deferred = this.setMoverAnimationPromise = deferredPromise<void>();\r\n    const ret = {onAnimationEnd: deferred};\r\n\r\n    const timeout = setTimeout(() => {\r\n      if(!deferred.isFulfilled && !deferred.isRejected) {\r\n        deferred.resolve();\r\n      }\r\n    }, 1000);\r\n\r\n    deferred.finally(() => {\r\n      this.dispatchEvent('setMoverAfter');\r\n\r\n      if(this.setMoverAnimationPromise === deferred) {\r\n        this.setMoverAnimationPromise = null;\r\n      }\r\n      \r\n      clearTimeout(timeout);\r\n    });\r\n\r\n    if(!closing) {\r\n      let mediaElement: HTMLImageElement | HTMLVideoElement;\r\n      let src: string;\r\n\r\n      if(target instanceof HTMLVideoElement) {\r\n        const elements = Array.from(target.parentElement.querySelectorAll('img')) as HTMLImageElement[];\r\n        if(elements.length) {\r\n          target = elements.pop();\r\n        }\r\n      }\r\n\r\n      if(target.tagName === 'DIV' || target.tagName === 'AVATAR-ELEMENT') { // useContainerAsTarget\r\n        const images = Array.from(target.querySelectorAll('img')) as HTMLImageElement[];\r\n        const image = images.pop();\r\n        if(image) {\r\n          mediaElement = new Image();\r\n          src = image.src;\r\n          mover.append(mediaElement);\r\n        }\r\n        /* mediaElement = new Image();\r\n        src = target.style.backgroundImage.slice(5, -2); */\r\n        \r\n      } else if(target instanceof HTMLImageElement) {\r\n        mediaElement = new Image();\r\n        src = target.src;\r\n      } else if(target instanceof HTMLVideoElement) {\r\n        mediaElement = createVideo();\r\n        mediaElement.src = target.src;\r\n      } else if(target instanceof SVGSVGElement) {\r\n        const clipId = target.dataset.clipId;\r\n        const newClipId = clipId + '-mv';\r\n\r\n        const {width, height} = containerRect;\r\n\r\n        const newSvg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n        newSvg.setAttributeNS(null, 'width', '' + width);\r\n        newSvg.setAttributeNS(null, 'height', '' + height);\r\n\r\n        // нижние два свойства для масштабирования\r\n        newSvg.setAttributeNS(null, 'viewBox', `0 0 ${width} ${height}`);\r\n        newSvg.setAttributeNS(null, 'preserveAspectRatio', 'xMidYMid meet');\r\n\r\n        newSvg.insertAdjacentHTML('beforeend', target.firstElementChild.outerHTML.replace(clipId, newClipId));\r\n        newSvg.insertAdjacentHTML('beforeend', target.lastElementChild.outerHTML.replace(clipId, newClipId));\r\n\r\n        // теперь надо выставить новую позицию для хвостика\r\n        const defs = newSvg.firstElementChild;\r\n        const use = defs.firstElementChild.firstElementChild as SVGUseElement;\r\n        if(use instanceof SVGUseElement) {\r\n          let transform = use.getAttributeNS(null, 'transform');\r\n          transform = transform.replace(/translate\\((.+?), (.+?)\\) scale\\((.+?), (.+?)\\)/, (match, x, y, sX, sY) => {\r\n            x = +x;\r\n            if(x !== 2) {\r\n              x = width - (2 / scaleX);\r\n            } else {\r\n              x = 2 / scaleX;\r\n            }\r\n            \r\n            y = height;\r\n  \r\n            return `translate(${x}, ${y}) scale(${+sX / scaleX}, ${+sY / scaleY})`;\r\n          });\r\n          use.setAttributeNS(null, 'transform', transform);\r\n  \r\n          // и новый RECT\r\n          path = defs.firstElementChild.lastElementChild as SVGPathElement;\r\n\r\n          // код ниже нужен только чтобы скрыть моргание до момента как сработает таймаут\r\n          let d: string;\r\n          const br: [number, number, number, number] = borderRadius.split(' ').map((v) => parseInt(v)) as any;\r\n          if(isOut) d = generatePathData(0, 0, width - 9 / scaleX, height, ...br);\r\n          else d = generatePathData(9 / scaleX, 0, width - 9 / scaleX, height, ...br);\r\n          path.setAttributeNS(null, 'd', d);\r\n        }\r\n\r\n        const foreignObject = newSvg.lastElementChild;\r\n        foreignObject.setAttributeNS(null, 'width', '' + containerRect.width);\r\n        foreignObject.setAttributeNS(null, 'height', '' + containerRect.height);\r\n        \r\n        mover.prepend(newSvg);\r\n      }\r\n\r\n      if(aspecter) {\r\n        aspecter.style.borderRadius = borderRadius;\r\n\r\n        if(mediaElement) {\r\n          aspecter.append(mediaElement);\r\n        }\r\n      }\r\n\r\n      mediaElement = mover.querySelector('video, img');\r\n      if(mediaElement instanceof HTMLImageElement) {\r\n        mediaElement.classList.add('thumbnail');\r\n        if(!aspecter) {\r\n          mediaElement.style.width = containerRect.width + 'px';\r\n          mediaElement.style.height = containerRect.height + 'px';\r\n        }\r\n\r\n        if(src) {\r\n          await renderImageFromUrlPromise(mediaElement, src);\r\n        }\r\n      }/*  else if(mediaElement instanceof HTMLVideoElement && mediaElement.firstElementChild && ((mediaElement.firstElementChild as HTMLSourceElement).src || src)) {\r\n        await new Promise((resolve, reject) => {\r\n          mediaElement.addEventListener('loadeddata', resolve);\r\n\r\n          if(src) {\r\n            (mediaElement.firstElementChild as HTMLSourceElement).src = src;\r\n          }\r\n        });\r\n      } */\r\n  \r\n      mover.style.display = '';\r\n\r\n      fastRaf(() => {\r\n        mover.classList.add(wasActive ? 'moving' : 'active');\r\n      });\r\n    } else {\r\n      /* if(mover.classList.contains('center')) {\r\n        mover.classList.remove('center');\r\n        void mover.offsetLeft; // reflow\r\n      } */\r\n      \r\n      if(target instanceof SVGSVGElement) {\r\n        path = mover.querySelector('path');\r\n\r\n        if(path) {\r\n          this.sizeTailPath(path, containerRect, scaleX, delay, false, isOut, borderRadius);\r\n        }\r\n      }\r\n\r\n      if(target.classList.contains('media-viewer-media')) {\r\n        mover.classList.add('hiding');\r\n      }\r\n\r\n      this.toggleWholeActive(false);\r\n\r\n      //return ret;\r\n\r\n      setTimeout(() => {\r\n        mover.style.borderRadius = borderRadius;\r\n\r\n        if(mover.firstElementChild) {\r\n          (mover.firstElementChild as HTMLElement).style.borderRadius = borderRadius;\r\n        }\r\n      }, delay / 2);\r\n\r\n      setTimeout(() => {\r\n        mover.innerHTML = '';\r\n        mover.classList.remove('moving', 'active', 'hiding');\r\n        mover.style.cssText = 'display: none;';\r\n\r\n        deferred.resolve();\r\n      }, delay);\r\n\r\n      mover.classList.remove('opening');\r\n\r\n      return ret;\r\n    }\r\n\r\n    mover.classList.add('opening');\r\n\r\n    //await new Promise((resolve) => setTimeout(resolve, 0));\r\n    //await new Promise((resolve) => window.requestAnimationFrame(resolve));\r\n    // * одного RAF'а недостаточно, иногда анимация с одним не срабатывает (преимущественно на мобильных)\r\n    await doubleRaf();\r\n\r\n    // чтобы проверить установленную позицию - раскомментировать\r\n    // throw '';\r\n\r\n    //await new Promise((resolve) => setTimeout(resolve, 5e3));\r\n\r\n    mover.style.transform = `translate3d(${containerRect.left}px,${containerRect.top}px,0) scale3d(1,1,1)`;\r\n    //mover.style.transform = `translate(-50%,-50%) scale(1,1)`;\r\n    needOpacity && (mover.style.opacity = ''/* closing ? '0' : '' */);\r\n\r\n    if(aspecter) {\r\n      this.setFullAspect(aspecter, containerRect, rect);\r\n    }\r\n\r\n    //throw '';\r\n\r\n    setTimeout(() => {\r\n      mover.style.borderRadius = '';\r\n\r\n      if(mover.firstElementChild) {\r\n        (mover.firstElementChild as HTMLElement).style.borderRadius = '';\r\n      }\r\n    }, 0/* delay / 2 */);\r\n\r\n    mover.dataset.timeout = '' + setTimeout(() => {\r\n      mover.classList.remove('moving', 'opening');\r\n\r\n      if(aspecter) { // всё из-за видео, элементы управления скейлятся, так бы можно было этого не делать\r\n        if(mover.querySelector('video') || true) {\r\n          mover.classList.remove('active');\r\n          aspecter.style.cssText = '';\r\n          void mover.offsetLeft; // reflow\r\n        }\r\n        \r\n        //aspecter.classList.remove('disable-hover');\r\n      }\r\n\r\n      // эти строки нужны для установки центральной позиции, в случае ресайза это будет нужно\r\n      mover.classList.add('center', 'no-transition');\r\n      /* mover.style.left = mover.style.top = '50%';\r\n      mover.style.transform = 'translate(-50%, -50%)';\r\n      void mover.offsetLeft; // reflow */\r\n\r\n      // это уже нужно для будущих анимаций\r\n      mover.classList.add('active');\r\n      delete mover.dataset.timeout;\r\n\r\n      deferred.resolve();\r\n    }, delay);\r\n\r\n    if(path) {\r\n      this.sizeTailPath(path, containerRect, scaleX, delay, true, isOut, borderRadius);\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  protected toggleWholeActive(active: boolean) {\r\n    if(active) {\r\n      this.wholeDiv.classList.add('active');\r\n    } else {\r\n      this.wholeDiv.classList.add('backwards');\r\n      setTimeout(() => {\r\n        this.wholeDiv.classList.remove('active');\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  protected setFullAspect(aspecter: HTMLDivElement, containerRect: DOMRect, rect: DOMRect) {\r\n    /* let media = aspecter.firstElementChild;\r\n    let proportion: number;\r\n    if(media instanceof HTMLImageElement) {\r\n      proportion = media.naturalWidth / media.naturalHeight;\r\n    } else if(media instanceof HTMLVideoElement) {\r\n      proportion = media.videoWidth / media.videoHeight;\r\n    } */\r\n    const proportion = containerRect.width / containerRect.height;\r\n\r\n    let {width, height} = rect;\r\n    /* if(proportion === 1) {\r\n      aspecter.style.cssText = '';\r\n    } else { */\r\n      if(proportion > 0) {\r\n        width = height * proportion;\r\n      } else {\r\n        height = width * proportion;\r\n      }\r\n\r\n      //this.log('will set style aspecter:', `width: ${width}px; height: ${height}px; transform: scale(${containerRect.width / width}, ${containerRect.height / height});`);\r\n\r\n      aspecter.style.cssText = `width: ${width}px; height: ${height}px; transform: scale3d(${containerRect.width / width}, ${containerRect.height / height}, 1);`;\r\n    //}\r\n  }\r\n\r\n  protected sizeTailPath(path: SVGPathElement, rect: DOMRect, scaleX: number, delay: number, upscale: boolean, isOut: boolean, borderRadius: string) {\r\n    const start = Date.now();\r\n    const {width, height} = rect;\r\n    delay = delay / 2;\r\n\r\n    const br = borderRadius.split(' ').map((v) => parseInt(v));\r\n\r\n    const step = () => {\r\n      const diff = Date.now() - start;\r\n\r\n      let progress = delay ? diff / delay : 1;\r\n      if(progress > 1) progress = 1;\r\n      if(upscale) progress = 1 - progress;\r\n\r\n      const _br: [number, number, number, number] = br.map((v) => v * progress) as any;\r\n\r\n      let d: string;\r\n      if(isOut) d = generatePathData(0, 0, width - (9 / scaleX * progress), height, ..._br);\r\n      else d = generatePathData(9 / scaleX * progress, 0, width/* width - (9 / scaleX * progress) */, height, ..._br);\r\n      path.setAttributeNS(null, 'd', d);\r\n\r\n      if(diff < delay) fastRaf(step);\r\n    };\r\n    \r\n    //window.requestAnimationFrame(step);\r\n    step();\r\n  }\r\n\r\n  protected removeCenterFromMover(mover: HTMLElement) {\r\n    if(mover.classList.contains('center')) {\r\n      //const rect = mover.getBoundingClientRect();\r\n      const rect = this.content.media.getBoundingClientRect();\r\n      mover.style.transform = `translate3d(${rect.left}px,${rect.top}px,0)`;\r\n      mover.classList.remove('center');\r\n      void mover.offsetLeft; // reflow\r\n      mover.classList.remove('no-transition');\r\n    }\r\n  }\r\n\r\n  protected moveTheMover(mover: HTMLElement, toLeft = true) {\r\n    const windowW = windowSize.width;\r\n\r\n    this.removeCenterFromMover(mover);\r\n\r\n    //mover.classList.remove('active');\r\n    mover.classList.add('moving');\r\n\r\n    if(mover.dataset.timeout) { // и это тоже всё из-за скейла видео, так бы это не нужно было\r\n      clearTimeout(+mover.dataset.timeout);\r\n    }\r\n\r\n    const rect = mover.getBoundingClientRect();\r\n\r\n    const newTransform = mover.style.transform.replace(/translate3d\\((.+?),/, (match, p1) => {\r\n      const x = toLeft ? -rect.width : windowW;\r\n      //const x = toLeft ? -(rect.right + (rect.width / 2)) : windowW / 2;\r\n\r\n      return match.replace(p1, x + 'px');\r\n    });\r\n\r\n    ////////this.log('set newTransform:', newTransform, mover.style.transform, toLeft);\r\n    mover.style.transform = newTransform;\r\n\r\n    setTimeout(() => {\r\n      mover.remove();\r\n    }, 350);\r\n  }\r\n\r\n  protected setNewMover() {\r\n    const newMover = document.createElement('div');\r\n    newMover.classList.add('media-viewer-mover');\r\n    newMover.style.display = 'none';\r\n\r\n    if(this.content.mover) {\r\n      const oldMover = this.content.mover;\r\n      oldMover.parentElement.append(newMover);\r\n    } else {\r\n      this.moversContainer.append(newMover);\r\n    }\r\n\r\n    return this.content.mover = newMover;\r\n  }\r\n\r\n  protected updateMediaSource(target: HTMLElement, url: string, tagName: 'video' | 'img') {\r\n    //if(target instanceof SVGSVGElement) {\r\n      const el = target.tagName.toLowerCase() === tagName ? target : target.querySelector(tagName) as HTMLElement;\r\n      if(el && !findUpClassName(target, 'document')) {\r\n        if(findUpClassName(target, 'attachment')) {\r\n          // two parentElements because element can be contained in aspecter\r\n          const preloader = target.parentElement.parentElement.querySelector('.preloader-container') as HTMLElement;\r\n          if(preloader) {\r\n            if(tagName === 'video') {\r\n              if(preloader.classList.contains('manual')) {\r\n                preloader.click();\r\n                // return;\r\n              }\r\n    \r\n              return;\r\n            }\r\n            \r\n            preloader.remove();\r\n          }\r\n        }\r\n\r\n        renderImageFromUrl(el, url);\r\n\r\n        // ! костыль, но он тут даже и не нужен\r\n        if(el.classList.contains('thumbnail') && el.parentElement.classList.contains('media-container-aspecter')) {\r\n          el.classList.remove('thumbnail');\r\n        }\r\n      }\r\n    /* } else {\r\n\r\n    } */\r\n  }\r\n\r\n  protected setAuthorInfo(fromId: PeerId | string, timestamp: number) {\r\n    const isPeerId = fromId.isPeerId();\r\n    let wrapTitlePromise: Promise<HTMLElement> | HTMLElement;\r\n    if(isPeerId) {\r\n      wrapTitlePromise = wrapPeerTitle({\r\n        peerId: fromId as PeerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      })\r\n    } else {\r\n      const title = wrapTitlePromise = document.createElement('span');\r\n      title.append(wrapEmojiText(fromId));\r\n      title.classList.add('peer-title');\r\n    }\r\n\r\n    let oldAvatar = this.author.avatarEl;\r\n    const newAvatar = this.author.avatarEl = (oldAvatar.cloneNode() as AvatarElement);\r\n\r\n    return Promise.all([\r\n      (this.author.avatarEl as AvatarElement).updateWithOptions({\r\n        peerId: fromId as PeerId || NULL_PEER_ID,\r\n        peerTitle: isPeerId ? undefined : '' + fromId\r\n      }),\r\n\r\n      wrapTitlePromise\r\n    ]).then(([_, title]) => {\r\n      if(this.author.avatarEl !== newAvatar) {\r\n        return;\r\n      }\r\n\r\n      replaceContent(this.author.date, formatFullSentTime(timestamp));\r\n      replaceContent(this.author.nameEl, title);\r\n      oldAvatar.replaceWith(this.author.avatarEl);\r\n    });\r\n  }\r\n  \r\n  protected async _openMedia(\r\n    media: MyDocument | MyPhoto, \r\n    timestamp: number, \r\n    fromId: PeerId | string, \r\n    fromRight: number, \r\n    target?: HTMLElement, \r\n    reverse = false, \r\n    prevTargets: TargetType[] = [], \r\n    nextTargets: TargetType[] = [], \r\n    message?: MyMessage\r\n    /* , needLoadMore = true */\r\n  ) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    /* if(DEBUG) {\r\n      this.log('openMedia:', media, fromId, prevTargets, nextTargets);\r\n    } */\r\n\r\n    const setAuthorPromise = this.setAuthorInfo(fromId, timestamp);\r\n    \r\n    const isDocument = media._ === 'document';\r\n    const isVideo = isDocument && media.mime_type && ((['video', 'gif'] as MyDocument['type'][]).includes(media.type) || media.mime_type.indexOf('video/') === 0);\r\n\r\n    if(this.isFirstOpen) {\r\n      //this.targetContainer = targetContainer;\r\n      // this.needLoadMore = needLoadMore;\r\n      this.isFirstOpen = false;\r\n      this.listLoader.setTargets(prevTargets, nextTargets, reverse);\r\n      (window as any).appMediaViewer = this;\r\n      //this.loadMore = loadMore;\r\n\r\n      /* if(appSidebarRight.historyTabIDs.slice(-1)[0] === AppSidebarRight.SLIDERITEMSIDS.forward) {\r\n        appSidebarRight.forwardTab.closeBtn.click();\r\n        await new Promise((resolve) => setTimeout(resolve, 200));\r\n      } */\r\n    }\r\n\r\n    if(this.listLoader.next.length < 10) {\r\n      setTimeout(() => {\r\n        this.listLoader.load(true);\r\n      }, 0);\r\n    }\r\n\r\n    //if(prevTarget && (!prevTarget.parentElement || !this.isElementVisible(this.targetContainer, prevTarget))) prevTarget = null;\r\n    //if(nextTarget && (!nextTarget.parentElement || !this.isElementVisible(this.targetContainer, nextTarget))) nextTarget = null;\r\n\r\n    this.buttons.prev.classList.toggle('hide', !this.listLoader.previous.length);\r\n    this.buttons.next.classList.toggle('hide', !this.listLoader.next.length);\r\n    \r\n    const container = this.content.media;\r\n    const useContainerAsTarget = !target || target === container;\r\n    if(useContainerAsTarget) target = container;\r\n\r\n    this.target = {element: target} as any;\r\n    const tempId = ++this.tempId;\r\n\r\n    if(container.firstElementChild) {\r\n      container.innerHTML = '';\r\n    }\r\n    \r\n    // ok set\r\n\r\n    const wasActive = fromRight !== 0;\r\n    if(wasActive) {\r\n      this.moveTheMover(this.content.mover, fromRight === 1);\r\n      this.setNewMover();\r\n    } else {\r\n      this.toggleOverlay(true);\r\n      this.setGlobalListeners();\r\n      await setAuthorPromise;\r\n\r\n      if(!this.wholeDiv.parentElement) {\r\n        this.pageEl.insertBefore(this.wholeDiv, document.getElementById('main-columns'));\r\n        void this.wholeDiv.offsetLeft; // reflow\r\n      }\r\n\r\n      this.toggleWholeActive(true);\r\n\r\n      if(!IS_MOBILE_SAFARI) {\r\n        this.navigationItem = {\r\n          type: 'media',\r\n          onPop: (canAnimate) => {\r\n            if(this.setMoverAnimationPromise) {\r\n              return false;\r\n            }\r\n            \r\n            this.close();\r\n          }\r\n        };\r\n\r\n        appNavigationController.pushItem(this.navigationItem);\r\n      }\r\n    }\r\n\r\n    ////////this.log('wasActive:', wasActive);\r\n\r\n    const mover = this.content.mover;\r\n\r\n    const maxWidth = windowSize.width;\r\n    //const maxWidth = this.pageEl.scrollWidth;\r\n    // TODO: const maxHeight = mediaSizes.isMobile ? appPhotosManager.windowH : appPhotosManager.windowH - 100;\r\n    let padding = 0;\r\n    const windowH = windowSize.height;\r\n    if(windowH < 1000000 && !mediaSizes.isMobile) {\r\n      padding = 120;\r\n    }\r\n    const maxHeight = windowH - 120 - padding;\r\n    let thumbPromise: Promise<any> = Promise.resolve();\r\n    const size = setAttachmentSize(media, container, maxWidth, maxHeight, mediaSizes.isMobile ? false : true, undefined, !!(isDocument && media.w && media.h)).photoSize;\r\n    if(useContainerAsTarget) {\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(media, size.type);\r\n      let img: HTMLImageElement | HTMLCanvasElement;\r\n      if(cacheContext.downloaded) {\r\n        img = new Image();\r\n        img.src = cacheContext.url;\r\n      } else {\r\n        const gotThumb = getStrippedThumbIfNeeded(media, cacheContext, true);\r\n        if(gotThumb) {\r\n          thumbPromise = gotThumb.loadPromise;\r\n          img = gotThumb.image;\r\n        }\r\n      }\r\n\r\n      if(img) {\r\n        img.classList.add('thumbnail');\r\n        container.append(img);\r\n      }\r\n    }\r\n\r\n    // need after setAttachmentSize\r\n    /* if(useContainerAsTarget) {\r\n      target = target.querySelector('img, video') || target;\r\n    } */\r\n\r\n    const supportsStreaming: boolean = !!(isDocument && media.supportsStreaming);\r\n    const preloader = supportsStreaming ? this.preloaderStreamable : this.preloader;\r\n\r\n    const getCacheContext = () => {\r\n      return this.managers.thumbsStorage.getCacheContext(media, size?.type);\r\n    };\r\n\r\n    let setMoverPromise: Promise<void>;\r\n    if(isVideo) {\r\n      ////////this.log('will wrap video', media, size);\r\n\r\n      // потому что для safari нужно создать элемент из event'а\r\n      // const video = document.createElement('video');\r\n      const useController = message && media.type !== 'gif';\r\n      const video = /* useController ? \r\n        appMediaPlaybackController.addMedia(message, false, true) as HTMLVideoElement : \r\n         */createVideo({pip: useController});\r\n\r\n      const set = () => this.setMoverToTarget(target, false, fromRight).then(({onAnimationEnd}) => {\r\n      //return; // set and don't move\r\n      //if(wasActive) return;\r\n        //return;\r\n  \r\n        const div = mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter') ? mover.firstElementChild : mover;\r\n        //const video = mover.querySelector('video') || document.createElement('video');\r\n  \r\n        const moverVideo = mover.querySelector('video');\r\n        if(moverVideo) {\r\n          moverVideo.remove();\r\n        }\r\n  \r\n        //video.src = '';\r\n  \r\n        video.setAttribute('playsinline', 'true');\r\n  \r\n        // * fix for playing video if viewer is closed (https://contest.com/javascript-web-bonus/entry1425#issue11629)\r\n        video.addEventListener('timeupdate', () => {\r\n          if(this.tempId !== tempId) {\r\n            video.pause();\r\n          }\r\n        });\r\n\r\n        this.addEventListener('setMoverAfter', () => {\r\n          video.src = '';\r\n          video.load();\r\n        }, {once: true});\r\n  \r\n        if(IS_SAFARI) {\r\n          // test stream\r\n          // video.controls = true;\r\n          video.autoplay = true;\r\n        }\r\n  \r\n        if(media.type === 'gif') {\r\n          video.muted = true;\r\n          video.autoplay = true;\r\n          video.loop = true;\r\n        } else if(media.duration < 60) {\r\n          video.loop = true;\r\n        }\r\n  \r\n        // if(!video.parentElement) {\r\n          div.append(video);\r\n        // }\r\n  \r\n        const canPlayThrough = new Promise((resolve) => {\r\n          video.addEventListener('canplay', resolve, {once: true});\r\n        });\r\n  \r\n        const createPlayer = () => {\r\n          if(media.type !== 'gif') {\r\n            video.dataset.ckin = 'default';\r\n            video.dataset.overlay = '1';\r\n\r\n            Promise.all([canPlayThrough, onAnimationEnd]).then(() => {\r\n              if(this.tempId !== tempId) {\r\n                return;\r\n              }\r\n  \r\n              // const play = useController ? appMediaPlaybackController.willBePlayedMedia === video : true;\r\n              const play = true;\r\n              const player = this.videoPlayer = new VideoPlayer({\r\n                video, \r\n                play, \r\n                streamable: supportsStreaming,\r\n                onPlaybackRackMenuToggle: (open) => {\r\n                  this.wholeDiv.classList.toggle('hide-caption', !!open);\r\n                },\r\n                onPip: (pip) => {\r\n                  const otherMediaViewer = (window as any).appMediaViewer;\r\n                  if(!pip && otherMediaViewer && otherMediaViewer !== this) {\r\n                    this.releaseSingleMedia = undefined;\r\n                    this.close();\r\n                    return;\r\n                  }\r\n\r\n                  const mover = this.moversContainer.lastElementChild as HTMLElement;\r\n                  mover.classList.toggle('hiding', pip);\r\n                  this.toggleWholeActive(!pip);\r\n                  this.toggleOverlay(!pip);\r\n                  this.toggleGlobalListeners(!pip);\r\n\r\n                  if(this.navigationItem) {\r\n                    if(pip) appNavigationController.removeItem(this.navigationItem);\r\n                    else appNavigationController.pushItem(this.navigationItem);\r\n                  }\r\n\r\n                  if(useController) {\r\n                    if(pip) {\r\n                      // appMediaPlaybackController.toggleSwitchers(true);\r\n\r\n                      this.releaseSingleMedia(false);\r\n                      this.releaseSingleMedia = undefined;\r\n\r\n                      appMediaPlaybackController.setPictureInPicture(video);\r\n                    } else {\r\n                      this.releaseSingleMedia = appMediaPlaybackController.setSingleMedia(video, message as Message.message);\r\n                    }\r\n                  }\r\n                },\r\n                onPipClose: () => {\r\n                  // this.target = undefined;\r\n                  // this.toggleWholeActive(false);\r\n                  // this.toggleOverlay(false);\r\n                  this.close();\r\n                }\r\n              });\r\n              player.addEventListener('toggleControls', (show) => {\r\n                this.wholeDiv.classList.toggle('has-video-controls', show);\r\n              });\r\n\r\n              this.addEventListener('setMoverBefore', () => {\r\n                this.wholeDiv.classList.remove('has-video-controls');\r\n                this.videoPlayer.cleanup();\r\n                this.videoPlayer = undefined;\r\n              }, {once: true});\r\n\r\n              if(this.isZooming()) {\r\n                this.videoPlayer.lockControls(false);\r\n              }\r\n              /* div.append(video);\r\n              mover.append(player.wrapper); */\r\n            });\r\n          }\r\n        };\r\n  \r\n        if(supportsStreaming) {\r\n          onAnimationEnd.then(() => {\r\n            if(video.readyState < video.HAVE_FUTURE_DATA) {\r\n              console.log('ppp 1');\r\n              preloader.attach(mover, true);\r\n            }\r\n  \r\n            /* canPlayThrough.then(() => {\r\n              preloader.detach();\r\n            }); */\r\n          });\r\n  \r\n          const attachCanPlay = () => {\r\n            video.addEventListener('canplay', () => {\r\n              console.log('ppp 2');\r\n              preloader.detach();\r\n              video.parentElement.classList.remove('is-buffering');\r\n            }, {once: true});\r\n          };\r\n  \r\n          video.addEventListener('waiting', () => {\r\n            const loading = video.networkState === video.NETWORK_LOADING;\r\n            const isntEnoughData = video.readyState < video.HAVE_FUTURE_DATA;\r\n  \r\n            //this.log('video waiting for progress', loading, isntEnoughData);\r\n            if(loading && isntEnoughData) {\r\n              attachCanPlay();\r\n  \r\n              console.log('ppp 3');\r\n              preloader.attach(mover, true);\r\n  \r\n              // поставлю класс для плеера, чтобы убрать большую иконку пока прелоадер на месте\r\n              video.parentElement.classList.add('is-buffering');\r\n            }\r\n          });\r\n\r\n          if(this.wholeDiv.classList.contains('no-forwards')) {\r\n            video.addEventListener('contextmenu', (e) => {\r\n              cancelEvent(e);\r\n            });\r\n          }\r\n  \r\n          attachCanPlay();\r\n        }\r\n        \r\n        //if(!video.src || media.url !== video.src) {\r\n          const load = async() => {\r\n            /* if(useController) {\r\n              appMediaPlaybackController.resolveWaitingForLoadMedia(message.peerId, message.mid, message.pFlags.is_scheduled);\r\n            } */\r\n\r\n            const promise: Promise<any> = supportsStreaming ? Promise.resolve() : appDownloadManager.downloadMediaURL({media});\r\n            \r\n            if(!supportsStreaming) {\r\n              onAnimationEnd.then(async() => {\r\n                if(!(await getCacheContext()).url) {\r\n                  console.log('ppp 4');\r\n                  preloader.attach(mover, true, promise);\r\n                }\r\n              });\r\n            }\r\n  \r\n            Promise.all([promise, onAnimationEnd]).then(async() => {\r\n              if(this.tempId !== tempId) {\r\n                this.log.warn('media viewer changed video');\r\n                return;\r\n              }\r\n\r\n              const url = (await getCacheContext()).url;\r\n\r\n              video.addEventListener('error', () => {\r\n                if(video.error.code !== 4) {\r\n                  this.log.error(\"Error \" + video.error.code + \"; details: \" + video.error.message);\r\n                }\r\n      \r\n                if(preloader) {\r\n                  preloader.detach();\r\n                }\r\n              }, {once: true});\r\n\r\n              if(target instanceof SVGSVGElement/*  && (video.parentElement || !isSafari) */) { // if video exists\r\n                //if(!video.parentElement) {\r\n                  div.firstElementChild.lastElementChild.append(video);\r\n                //}\r\n              } else {\r\n                renderImageFromUrl(video, url);\r\n              }\r\n\r\n              // * have to set options (especially playbackRate) after src\r\n              // * https://github.com/videojs/video.js/issues/2516\r\n              if(useController) {\r\n                this.releaseSingleMedia = appMediaPlaybackController.setSingleMedia(video, message as Message.message);\r\n\r\n                this.addEventListener('setMoverBefore', () => {\r\n                  if(this.releaseSingleMedia) {\r\n                    this.releaseSingleMedia();\r\n                    this.releaseSingleMedia = undefined;\r\n                  }\r\n                }, {once: true});\r\n              }\r\n\r\n              this.updateMediaSource(target, url, 'video');\r\n\r\n              createPlayer();\r\n            });\r\n  \r\n            return promise;\r\n          };\r\n  \r\n          this.lazyLoadQueue.unshift({load});\r\n        //} else createPlayer();\r\n      });\r\n\r\n      setMoverPromise = thumbPromise.then(set);\r\n    } else {\r\n      const set = () => this.setMoverToTarget(target, false, fromRight).then(({onAnimationEnd}) => {\r\n      //return; // set and don't move\r\n      //if(wasActive) return;\r\n        //return;\r\n        \r\n        const load = async() => {\r\n          const cancellablePromise = isDocument ? appDownloadManager.downloadMediaURL({media}) : appDownloadManager.downloadMediaURL({media, thumb: size});\r\n  \r\n          onAnimationEnd.then(async() => {\r\n            if(!(await getCacheContext()).url) {\r\n              this.preloader.attachPromise(cancellablePromise);\r\n              //this.preloader.attach(mover, true, cancellablePromise);\r\n            }\r\n          });\r\n          \r\n          Promise.all([onAnimationEnd, cancellablePromise]).then(async() => {\r\n            if(this.tempId !== tempId) {\r\n              this.log.warn('media viewer changed photo');\r\n              return;\r\n            }\r\n            \r\n            ///////this.log('indochina', blob);\r\n    \r\n            const url = (await getCacheContext()).url;\r\n            if(target instanceof SVGSVGElement) {\r\n              this.updateMediaSource(target, url, 'img');\r\n              this.updateMediaSource(mover, url, 'img');\r\n  \r\n              if(mediaSizes.isMobile) {\r\n                const imgs = mover.querySelectorAll('img');\r\n                if(imgs && imgs.length) {\r\n                  imgs.forEach((img) => {\r\n                    img.classList.remove('thumbnail'); // может здесь это вообще не нужно\r\n                  });\r\n                }\r\n              }\r\n            } else {\r\n              const div = mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter') ? mover.firstElementChild : mover;\r\n              const haveImage = div.firstElementChild?.tagName === 'IMG' ? div.firstElementChild as HTMLImageElement : null;\r\n              if(!haveImage || haveImage.src !== url)  {\r\n                let image = new Image();\r\n                image.classList.add('thumbnail');\r\n    \r\n                //this.log('will renderImageFromUrl:', image, div, target);\r\n    \r\n                renderImageFromUrl(image, url, () => {\r\n                  this.updateMediaSource(target, url, 'img');\r\n  \r\n                  if(haveImage) {\r\n                    fastRaf(() => {\r\n                      haveImage.remove();\r\n                    });\r\n                  }\r\n    \r\n                  div.append(image);\r\n                });\r\n              }\r\n            }\r\n    \r\n            //this.preloader.detach();\r\n          }).catch((err) => {\r\n            this.log.error(err);\r\n            this.preloader.attach(mover);\r\n            this.preloader.setManual();\r\n          });\r\n  \r\n          return cancellablePromise;\r\n        };\r\n  \r\n        this.lazyLoadQueue.unshift({load});\r\n      });\r\n\r\n      setMoverPromise = thumbPromise.then(set);\r\n    }\r\n\r\n    return this.setMoverPromise = setMoverPromise.catch(() => {\r\n      this.setMoverAnimationPromise = null;\r\n    }).finally(() => {\r\n      this.setMoverPromise = null;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function fillPropertyValue(str: string) {\r\n  let splitted = str.split(' ');\r\n  if(splitted.length !== 4) {\r\n    if(!splitted[0]) splitted[0] = '0px';\r\n    for(let i = splitted.length; i < 4; ++i) {\r\n      splitted[i] = splitted[i % 2] || splitted[0] || '0px';\r\n    }\r\n  }\r\n\r\n  return splitted;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MEDIA_MIME_TYPES_SUPPORTED from \"../environment/mediaMimeTypesSupport\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport SearchListLoader from \"../helpers/searchListLoader\";\r\nimport { Message } from \"../layer\";\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport { MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport { MediaSearchContext } from \"./appMediaPlaybackController\";\r\nimport AppMediaViewerBase, { MEDIA_VIEWER_CLASSNAME } from \"./appMediaViewerBase\";\r\nimport { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupDeleteMessages from \"./popups/deleteMessages\";\r\nimport PopupForward from \"./popups/forward\";\r\nimport Scrollable from \"./scrollable\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport AppSharedMediaTab from \"./sidebarRight/tabs/sharedMedia\";\r\n\r\ntype AppMediaViewerTargetType = {\r\n  element: HTMLElement,\r\n  mid: number,\r\n  peerId: PeerId\r\n};\r\nexport default class AppMediaViewer extends AppMediaViewerBase<'caption', 'delete' | 'forward', AppMediaViewerTargetType> {\r\n  protected listLoader: SearchListLoader<AppMediaViewerTargetType>;\r\n  protected btnMenuForward: ButtonMenuItemOptions;\r\n  protected btnMenuDownload: ButtonMenuItemOptions;\r\n  protected btnMenuDelete: ButtonMenuItemOptions;\r\n\r\n  get searchContext() {\r\n    return this.listLoader.searchContext;\r\n  }\r\n\r\n  constructor() {\r\n    super(new SearchListLoader({\r\n      processItem: (item) => {\r\n        const isForDocument = this.searchContext.inputFilter._ === 'inputMessagesFilterDocument';\r\n        const {mid, peerId} = item;\r\n        const media: MyPhoto | MyDocument = getMediaFromMessage(item);\r\n\r\n        if(!media) return;\r\n        \r\n        if(isForDocument && !AppMediaViewer.isMediaCompatibleForDocumentViewer(media)) {\r\n          return;\r\n        }\r\n\r\n        return {element: null as HTMLElement, mid, peerId};\r\n      }\r\n    }), ['delete', 'forward']);\r\n\r\n    this.listLoader.onEmptied = () => {\r\n      this.close();\r\n    };\r\n\r\n    /* const stub = document.createElement('div');\r\n    stub.classList.add(MEDIA_VIEWER_CLASSNAME + '-stub');\r\n    this.content.main.prepend(stub); */\r\n\r\n    this.content.caption = document.createElement('div');\r\n    this.content.caption.classList.add(MEDIA_VIEWER_CLASSNAME + '-caption'/* , 'media-viewer-stub' */);\r\n\r\n    let captionTimeout: number;\r\n    const setCaptionTimeout = () => {\r\n      if(captionTimeout) {\r\n        clearTimeout(captionTimeout);\r\n      }\r\n\r\n      captionTimeout = window.setTimeout(() => {\r\n        captionTimeout = undefined;\r\n        this.content.caption.classList.remove('is-focused');\r\n      }, 800);\r\n    };\r\n    this.content.caption.addEventListener('touchstart', () => {\r\n      if(!mediaSizes.isMobile) return;\r\n\r\n      this.content.caption.classList.add('is-focused');\r\n      \r\n      if(captionTimeout) {\r\n        clearTimeout(captionTimeout);\r\n        captionTimeout = undefined;\r\n      }\r\n      \r\n      document.addEventListener('touchend', setCaptionTimeout, {once: true});\r\n    });\r\n\r\n    const captionScrollable = new Scrollable(this.content.caption);\r\n    captionScrollable.onAdditionalScroll = setCaptionTimeout;\r\n\r\n    //this.content.main.append(this.content.caption);\r\n    this.wholeDiv.append(this.content.caption);\r\n\r\n    attachClickEvent(this.buttons.delete, this.onDeleteClick);\r\n\r\n    const buttons: ButtonMenuItemOptions[] = [this.btnMenuForward = {\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick\r\n    }, this.btnMenuDownload = {\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: this.onDownloadClick\r\n    }, this.btnMenuDelete = {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick\r\n    }];\r\n\r\n    this.setBtnMenuToggle(buttons);\r\n\r\n    // * constructing html end\r\n    \r\n    this.setListeners();\r\n  }\r\n\r\n  protected setListeners() {\r\n    super.setListeners();\r\n    attachClickEvent(this.buttons.forward, this.onForwardClick);\r\n    attachClickEvent(this.author.container, this.onAuthorClick);\r\n\r\n    const onCaptionClick = (e: MouseEvent) => {\r\n      if(e.target instanceof HTMLAnchorElement) { // close viewer if it's t.me/ redirect\r\n        const onclick = (e.target as HTMLElement).getAttribute('onclick');\r\n        if(!onclick || onclick.includes('showMaskedAlert')) {\r\n          return;\r\n        }\r\n\r\n        cancelEvent(e);\r\n\r\n        this.close().then(() => {\r\n          detachClickEvent(this.content.caption, onCaptionClick, {capture: true});\r\n          (e.target as HTMLAnchorElement).click();\r\n        });\r\n\r\n        return false;\r\n      }\r\n    };\r\n\r\n    attachClickEvent(this.content.caption, onCaptionClick, {capture: true});\r\n  }\r\n\r\n  /* public close(e?: MouseEvent) {\r\n    const good = !this.setMoverAnimationPromise;\r\n    const promise = super.close(e);\r\n\r\n    if(good) { // clear\r\n      this.currentMessageId = 0;\r\n      this.peerId = 0;\r\n    }\r\n\r\n    return promise;\r\n  } */\r\n\r\n  protected getMessageByPeer(peerId: PeerId, mid: number) {\r\n    return this.searchContext.isScheduled ? this.managers.appMessagesManager.getScheduledMessageByPeer(peerId, mid) : this.managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n  }\r\n\r\n  onPrevClick = async(target: AppMediaViewerTargetType) => {\r\n    this.openMedia(await this.getMessageByPeer(target.peerId, target.mid), target.element, -1);\r\n  };\r\n\r\n  onNextClick = async(target: AppMediaViewerTargetType) => {\r\n    this.openMedia(await this.getMessageByPeer(target.peerId, target.mid), target.element, 1);\r\n  };\r\n\r\n  onDeleteClick = () => {\r\n    const target = this.target;\r\n    new PopupDeleteMessages(target.peerId, [target.mid], 'chat', () => {\r\n      this.target = {element: this.content.media} as any;\r\n      this.close();\r\n    });\r\n  };\r\n\r\n  onForwardClick = () => {\r\n    const target = this.target;\r\n    if(target.mid) {\r\n      //appSidebarRight.forwardTab.open([target.mid]);\r\n      new PopupForward({\r\n        [target.peerId]: [target.mid]\r\n      }, () => {\r\n        return this.close();\r\n      });\r\n    }\r\n  };\r\n\r\n  onAuthorClick = async(e: MouseEvent) => {\r\n    const {mid, peerId} = this.target;\r\n    if(mid && mid !== Number.MAX_SAFE_INTEGER) {\r\n      const threadId = this.searchContext.threadId;\r\n      const message = await this.getMessageByPeer(peerId, mid);\r\n      this.close(e)\r\n      //.then(() => mediaSizes.isMobile ? appSidebarRight.sharedMediaTab.closeBtn.click() : Promise.resolve())\r\n      .then(async() => {\r\n        if(mediaSizes.isMobile) {\r\n          const tab = appSidebarRight.getTab(AppSharedMediaTab);\r\n          if(tab) {\r\n            tab.close();\r\n          }\r\n        }\r\n        \r\n        appImManager.setInnerPeer({\r\n          peerId: message.peerId, \r\n          lastMsgId: mid, \r\n          type: threadId ? 'discussion' : undefined, \r\n          threadId\r\n        });\r\n      });\r\n    }\r\n  };\r\n\r\n  onDownloadClick = async() => {\r\n    const {peerId, mid} = this.target;\r\n    const message = await this.getMessageByPeer(peerId, mid);\r\n    const media = getMediaFromMessage(message);\r\n    if(!media) return;\r\n    appDownloadManager.downloadToDisc({media, queueId: appImManager.chat.bubbles.lazyLoadQueue.queueId});\r\n  };\r\n\r\n  private setCaption(message: MyMessage) {\r\n    const caption = (message as Message.message).message;\r\n    let html: Parameters<typeof setInnerHTML>[1] = '';\r\n    if(caption) {\r\n      html = wrapRichText(caption, {\r\n        entities: (message as Message.message).totalEntities\r\n      });\r\n    }\r\n    \r\n    // html = 'Dandelion are a family of flowering plants that grow in many parts of the world.';\r\n    setInnerHTML(this.content.caption.firstElementChild, html);\r\n    this.content.caption.classList.toggle('hide', !caption);\r\n    // this.content.container.classList.toggle('with-caption', !!caption);\r\n  }\r\n\r\n  public setSearchContext(context: MediaSearchContext) {\r\n    this.listLoader.setSearchContext(context);\r\n\r\n    return this;\r\n  }\r\n\r\n  public async openMedia(message: MyMessage, target?: HTMLElement, fromRight = 0, reverse = false, \r\n    prevTargets: AppMediaViewerTargetType[] = [], nextTargets: AppMediaViewerTargetType[] = []/* , needLoadMore = true */) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    const mid = message.mid;\r\n    const fromId = (message as Message.message).fwd_from && !message.fromId ? (message as Message.message).fwd_from.from_name : message.fromId;\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const cantForwardMessage = message._ === 'messageService' || !this.managers.appMessagesManager.canForward(message);\r\n    [this.buttons.forward, this.btnMenuForward.element].forEach((button) => {\r\n      button.classList.toggle('hide', cantForwardMessage);\r\n    });\r\n\r\n    this.wholeDiv.classList.toggle('no-forwards', cantForwardMessage);\r\n    \r\n    const cantDownloadMessage = cantForwardMessage;\r\n    [this.buttons.download, this.btnMenuDownload.element].forEach((button) => {\r\n      button.classList.toggle('hide', cantDownloadMessage);\r\n    });\r\n\r\n    const canDeleteMessage = this.managers.appMessagesManager.canDeleteMessage(message);\r\n    [this.buttons.delete, this.btnMenuDelete.element].forEach((button) => {\r\n      button.classList.toggle('hide', !canDeleteMessage);\r\n    });\r\n\r\n    this.setCaption(message);\r\n    const promise = super._openMedia(media, message.date, fromId, fromRight, target, reverse, prevTargets, nextTargets, message/* , needLoadMore */);\r\n    this.target.mid = mid;\r\n    this.target.peerId = message.peerId;\r\n\r\n    return promise;\r\n  }\r\n\r\n  public static isMediaCompatibleForDocumentViewer(media: MyPhoto | MyDocument) {\r\n    return media._ === 'photo' || MEDIA_MIME_TYPES_SUPPORTED.has(media.mime_type);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Photo } from \"../layer\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport ListLoader, { ListLoaderOptions } from \"./listLoader\";\r\n\r\nexport default class AvatarListLoader<Item extends {photoId: Photo.photo['id']}> extends ListLoader<Item, any> {\r\n  private peerId: PeerId;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: Omit<ListLoaderOptions<Item, any>, 'loadMore'> & {peerId: PeerId, managers: AppManagers}) {\r\n    super({\r\n      ...options,\r\n      loadMore: (anchor, older, loadCount) => {\r\n        if(this.peerId.isAnyChat() || !older) return Promise.resolve({count: 0, items: []}); // ! это значит, что открыло аватар чата, но следующих фотографий нет.\r\n\r\n        const maxId = anchor?.photoId;\r\n        return this.managers.appPhotosManager.getUserPhotos(this.peerId, maxId, loadCount).then((value) => {\r\n          const items = value.photos.map((photoId) => {\r\n            return {element: null as HTMLElement, photoId} as any;\r\n          });\r\n\r\n          return {count: value.count, items};\r\n        });\r\n      }\r\n    });\r\n\r\n    this.loadedAllUp = true;\r\n    this.peerId = options.peerId;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarListLoader from \"../helpers/avatarListLoader\";\r\nimport { Photo } from \"../layer\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport AppMediaViewerBase from \"./appMediaViewerBase\";\r\n\r\ntype AppMediaViewerAvatarTargetType = {element: HTMLElement, photoId: Photo.photo['id']};\r\nexport default class AppMediaViewerAvatar extends AppMediaViewerBase<'', 'delete', AppMediaViewerAvatarTargetType> {\r\n  public peerId: PeerId;\r\n\r\n  constructor(peerId: PeerId) {\r\n    super(new AvatarListLoader({peerId, managers: rootScope.managers}), [/* 'delete' */]);\r\n\r\n    this.peerId = peerId;\r\n\r\n    this.setBtnMenuToggle([{\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: this.onDownloadClick\r\n    }/* , {\r\n      icon: 'delete danger btn-disabled',\r\n      text: 'Delete',\r\n      onClick: () => {}\r\n    } */]);\r\n\r\n    // * constructing html end\r\n    \r\n    this.setListeners();\r\n  }\r\n\r\n  onPrevClick = (target: AppMediaViewerAvatarTargetType) => {\r\n    this.openMedia(target.photoId, target.element, -1);\r\n  };\r\n\r\n  onNextClick = (target: AppMediaViewerAvatarTargetType) => {\r\n    this.openMedia(target.photoId, target.element, 1);\r\n  };\r\n\r\n  onDownloadClick = async() => {\r\n    appDownloadManager.downloadToDisc({\r\n      media: await this.managers.appPhotosManager.getPhoto(this.target.photoId), \r\n      queueId: appImManager.chat.bubbles.lazyLoadQueue.queueId\r\n    });\r\n  };\r\n\r\n  public async openMedia(photoId: Photo.photo['id'], target?: HTMLElement, fromRight = 0, prevTargets?: AppMediaViewerAvatarTargetType[], nextTargets?: AppMediaViewerAvatarTargetType[]) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    const photo = await this.managers.appPhotosManager.getPhoto(photoId);\r\n    const ret = super._openMedia(photo, photo.date, this.peerId, fromRight, target, false, prevTargets, nextTargets);\r\n    this.target.photoId = photo.id;\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { Message, Photo } from \"../layer\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport AppMediaViewer from \"./appMediaViewer\";\r\nimport AppMediaViewerAvatar from \"./appMediaViewerAvatar\";\r\nimport isObject from \"../helpers/object/isObject\";\r\nimport { ArgumentTypes } from \"../types\";\r\nimport putPhoto from \"./putPhoto\";\r\nimport { recordPromise } from \"../helpers/recordPromise\";\r\n\r\nconst onAvatarUpdate = (peerId: PeerId) => {\r\n  (Array.from(document.querySelectorAll('avatar-element[data-peer-id=\"' + peerId + '\"]')) as AvatarElement[]).forEach((elem) => {\r\n    //console.log('updating avatar:', elem);\r\n    elem.update();\r\n  });\r\n};\r\n\r\nrootScope.addEventListener('avatar_update', onAvatarUpdate);\r\nrootScope.addEventListener('peer_title_edit', async(peerId) => {\r\n  if(!(await rootScope.managers.appAvatarsManager.isAvatarCached(peerId))) {\r\n    onAvatarUpdate(peerId);\r\n  }\r\n});\r\n\r\nexport async function openAvatarViewer(\r\n  target: HTMLElement, \r\n  peerId: PeerId, \r\n  middleware: () => boolean, \r\n  message?: any, \r\n  prevTargets?: {element: HTMLElement, item: Photo.photo['id'] | Message.messageService}[], \r\n  nextTargets?: typeof prevTargets\r\n) {\r\n  let photo = await rootScope.managers.appProfileManager.getFullPhoto(peerId);\r\n  if(!middleware() || !photo) {\r\n    return;\r\n  }\r\n\r\n  const getTarget = () => {\r\n    const good = Array.from(target.querySelectorAll('img')).find((img) => !img.classList.contains('emoji'));\r\n    return good ? target : null;\r\n  };\r\n\r\n  if(peerId.isAnyChat()) {\r\n    const hadMessage = !!message;\r\n    const inputFilter = 'inputMessagesFilterChatPhotos';\r\n    if(!message) {\r\n      message = await rootScope.managers.appMessagesManager.getSearch({\r\n        peerId, \r\n        inputFilter: {_: inputFilter}, \r\n        maxId: 0, \r\n        limit: 1 \r\n      }).then((value) => {\r\n        //console.log(lol);\r\n        // ! by descend\r\n        return value.history[0];\r\n      });\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(message) {\r\n      // ! гений в деле, костылируем (но это гениально)\r\n      const messagePhoto = message.action.photo;\r\n      if(messagePhoto.id !== photo.id) {\r\n        if(!hadMessage) {\r\n          message = rootScope.managers.appMessagesManager.generateFakeAvatarMessage(peerId, photo);\r\n        } else {\r\n          \r\n        }\r\n      }\r\n\r\n      const f = (arr: typeof prevTargets) => arr.map((el) => ({\r\n        element: el.element,\r\n        mid: (el.item as Message.messageService).mid,\r\n        peerId: (el.item as Message.messageService).peerId\r\n      }));\r\n\r\n      new AppMediaViewer()\r\n      .setSearchContext({\r\n        peerId,\r\n        inputFilter: {_: inputFilter},\r\n      })\r\n      .openMedia(message, getTarget(), undefined, undefined, prevTargets ? f(prevTargets) : undefined, nextTargets ? f(nextTargets) : undefined);\r\n\r\n      return;\r\n    }\r\n  }\r\n\r\n  if(photo) {\r\n    if(!isObject(message) && message) {\r\n      photo = await rootScope.managers.appPhotosManager.getPhoto(message);\r\n    }\r\n    \r\n    const f = (arr: typeof prevTargets) => arr.map((el) => ({\r\n      element: el.element,\r\n      photoId: el.item as string\r\n    }));\r\n\r\n    new AppMediaViewerAvatar(peerId).openMedia(\r\n      photo.id, \r\n      getTarget(), \r\n      undefined, \r\n      prevTargets ? f(prevTargets) : undefined, \r\n      nextTargets ? f(nextTargets) : undefined\r\n    );\r\n  }\r\n}\r\n\r\nconst believeMe: Map<PeerId, Set<AvatarElement>> = new Map();\r\nconst seen: Set<PeerId> = new Set();\r\n\r\nexport default class AvatarElement extends HTMLElement {\r\n  public peerId: PeerId;\r\n  public isDialog: boolean;\r\n  public peerTitle: string;\r\n  public loadPromises: Promise<any>[];\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public isBig: boolean;\r\n  private addedToQueue = false;\r\n\r\n  disconnectedCallback() {\r\n    // браузер вызывает этот метод при удалении элемента из документа\r\n    // (может вызываться много раз, если элемент многократно добавляется/удаляется)\r\n    const set = believeMe.get(this.peerId);\r\n    if(set && set.has(this)) {\r\n      set.delete(this);\r\n      if(!set.size) {\r\n        believeMe.delete(this.peerId);\r\n      }\r\n    }\r\n\r\n    if(this.lazyLoadQueue) {\r\n      this.lazyLoadQueue.unobserve(this);\r\n    }\r\n  }\r\n\r\n  public attachClickEvent() {\r\n    let loading = false;\r\n    attachClickEvent(this, async(e) => {\r\n      cancelEvent(e);\r\n      if(loading) return;\r\n      //console.log('avatar clicked');\r\n      const peerId = this.peerId;\r\n      loading = true;\r\n      await openAvatarViewer(this, this.peerId, () => this.peerId === peerId);\r\n      loading = false;\r\n    });\r\n  }\r\n\r\n  public updateOptions(options: Partial<ArgumentTypes<AvatarElement['updateWithOptions']>[0]>) {\r\n    for(let i in options) {\r\n      // @ts-ignore\r\n      this[i] = options[i];\r\n    }\r\n  }\r\n\r\n  public updateWithOptions(options: {\r\n    peerId: PeerId,\r\n    isDialog?: boolean,\r\n    isBig?: boolean,\r\n    peerTitle?: string,\r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[]\r\n  }) {\r\n    const wasPeerId = this.peerId;\r\n    this.updateOptions(options);\r\n    const newPeerId = this.peerId;\r\n\r\n    if(wasPeerId === newPeerId) {\r\n      return;\r\n    }\r\n\r\n    this.peerId = /* rootScope.managers.appPeersManager.getPeerMigratedTo(newPeerId) ||  */newPeerId;\r\n    this.dataset.peerId = '' + newPeerId;\r\n\r\n    if(wasPeerId) {\r\n      const set = believeMe.get(wasPeerId);\r\n      if(set) {\r\n        set.delete(this);\r\n        if(!set.size) {\r\n          believeMe.delete(wasPeerId);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this.update();\r\n  }\r\n\r\n  private r(onlyThumb = false) {\r\n    const promise = putPhoto(this, this.peerId, this.isDialog, this.peerTitle, onlyThumb, this.isBig);\r\n    // recordPromise(promise, 'avatar putPhoto-' + this.peerId);\r\n\r\n    if(this.loadPromises) {\r\n      this.loadPromises.push(promise);\r\n\r\n      promise.finally(() => {\r\n        this.loadPromises = undefined;\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public update() {\r\n    if(this.lazyLoadQueue) {\r\n      if(!seen.has(this.peerId)) {\r\n        if(this.addedToQueue) return;\r\n        this.addedToQueue = true;\r\n        \r\n        let set = believeMe.get(this.peerId);\r\n        if(!set) {\r\n          set = new Set();\r\n          believeMe.set(this.peerId, set);\r\n        }\r\n  \r\n        set.add(this);\r\n\r\n        this.lazyLoadQueue.push({\r\n          div: this, \r\n          load: () => {\r\n            seen.add(this.peerId);\r\n            return this.update();\r\n          }\r\n        });\r\n\r\n        return this.r(true);\r\n      } else if(this.addedToQueue) {\r\n        this.lazyLoadQueue.unobserve(this);\r\n      }\r\n    } \r\n    \r\n    seen.add(this.peerId);\r\n    \r\n    const promise = this.r();\r\n\r\n    if(this.addedToQueue) {\r\n      promise.finally(() => {\r\n        this.addedToQueue = false;\r\n      });\r\n    }\r\n\r\n    const set = believeMe.get(this.peerId);\r\n    if(set) {\r\n      set.delete(this);\r\n      const arr = Array.from(set);\r\n      believeMe.delete(this.peerId);\r\n      \r\n\r\n      for(let i = 0, length = arr.length; i < length; ++i) {\r\n        arr[i].update();\r\n      }\r\n    }\r\n\r\n    return promise;\r\n  }\r\n}\r\n\r\ncustomElements.define('avatar-element', AvatarElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../lib/appManagers/appDialogsManager\";\r\nimport type { Dialog } from \"../lib/appManagers/appMessagesManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupDeleteDialog from \"./popups/deleteDialog\";\r\nimport { i18n } from \"../lib/langPack\";\r\nimport findUpTag from \"../helpers/dom/findUpTag\";\r\nimport PopupPeer from \"./popups/peer\";\r\nimport AppChatFoldersTab from \"./sidebarLeft/tabs/chatFolders\";\r\nimport appSidebarLeft from \"./sidebarLeft\";\r\nimport { toastNew } from \"./toast\";\r\nimport PopupMute from \"./popups/mute\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport positionMenu from \"../helpers/positionMenu\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\n\r\nexport default class DialogsContextMenu {\r\n  private element: HTMLElement;\r\n  private buttons: (ButtonMenuItemOptions & {verify: () => boolean | Promise<boolean>})[];\r\n\r\n  private selectedId: PeerId;\r\n  private filterId: number;\r\n  private dialog: Dialog;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  private init() {\r\n    this.buttons = [{\r\n      icon: 'unread',\r\n      text: 'MarkAsUnread',\r\n      onClick: this.onUnreadClick,\r\n      verify: async() => !(await this.managers.appMessagesManager.isDialogUnread(this.dialog))\r\n    }, {\r\n      icon: 'readchats',\r\n      text: 'MarkAsRead',\r\n      onClick: this.onUnreadClick,\r\n      verify: () => this.managers.appMessagesManager.isDialogUnread(this.dialog)\r\n    }, {\r\n      icon: 'pin',\r\n      text: 'ChatList.Context.Pin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => {\r\n        const isPinned = this.filterId > 1 ? \r\n          (await this.managers.appMessagesManager.getFilter(this.filterId)).pinnedPeerIds.includes(this.dialog.peerId) : \r\n          !!this.dialog.pFlags?.pinned;\r\n        return !isPinned;\r\n      }\r\n    }, {\r\n      icon: 'unpin',\r\n      text: 'ChatList.Context.Unpin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => {\r\n        const isPinned = this.filterId > 1 ? \r\n          (await this.managers.appMessagesManager.getFilter(this.filterId)).pinnedPeerIds.includes(this.dialog.peerId) : \r\n          !!this.dialog.pFlags?.pinned;\r\n        return isPinned;\r\n      }\r\n    }, {\r\n      icon: 'mute',\r\n      text: 'ChatList.Context.Mute',\r\n      onClick: this.onMuteClick,\r\n      verify: async() => {\r\n        return this.selectedId !== rootScope.myId && !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.dialog.peerId)); \r\n      }\r\n    }, {\r\n      icon: 'unmute',\r\n      text: 'ChatList.Context.Unmute',\r\n      onClick: this.onUnmuteClick,\r\n      verify: async() => {\r\n        return this.selectedId !== rootScope.myId && (await this.managers.appNotificationsManager.isPeerLocalMuted(this.dialog.peerId)); \r\n      }\r\n    }, {\r\n      icon: 'archive',\r\n      text: 'Archive',\r\n      onClick: this.onArchiveClick,\r\n      verify: () => this.filterId === 0 && this.selectedId !== rootScope.myId\r\n    }, {\r\n      icon: 'unarchive',\r\n      text: 'Unarchive',\r\n      onClick: this.onArchiveClick,\r\n      verify: () => this.filterId === 1 && this.selectedId !== rootScope.myId\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => true\r\n    }];\r\n\r\n    this.element = ButtonMenu(this.buttons);\r\n    this.element.id = 'dialogs-contextmenu';\r\n    this.element.classList.add('contextmenu');\r\n    document.getElementById('page-chats').append(this.element);\r\n  }\r\n\r\n  private onArchiveClick = async() => {\r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(this.selectedId);\r\n    if(dialog) {\r\n      this.managers.appMessagesManager.editPeerFolders([dialog.peerId], +!dialog.folder_id);\r\n    }\r\n  };\r\n\r\n  private onPinClick = () => {\r\n    this.managers.appMessagesManager.toggleDialogPin(this.selectedId, this.filterId).catch(async(err) => {\r\n      if(err.type === 'PINNED_DIALOGS_TOO_MUCH') {\r\n        if(this.filterId >= 1) {\r\n          toastNew({langPackKey: 'PinFolderLimitReached'});\r\n        } else {\r\n          const config = await this.managers.apiManager.getConfig();\r\n          new PopupPeer('pinned-dialogs-too-much', {\r\n            buttons: [{\r\n              langKey: 'OK',\r\n              isCancel: true\r\n            }, {\r\n              langKey: 'FiltersSetupPinAlert',\r\n              callback: () => {\r\n                appSidebarLeft.createTab(AppChatFoldersTab);\r\n              }\r\n            }],\r\n            descriptionLangKey: 'PinToTopLimitReached2',\r\n            descriptionLangArgs: [i18n('Chats', [config.pinned_dialogs_count_max])]\r\n          }).show();\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  private onUnmuteClick = () => {\r\n    this.managers.appMessagesManager.togglePeerMute(this.selectedId, false);\r\n  };\r\n  \r\n  private onMuteClick = () => {\r\n    new PopupMute(this.selectedId);\r\n  };\r\n\r\n  private onUnreadClick = async() => {\r\n    const selectedId = this.selectedId;\r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(selectedId);\r\n    if(!dialog) return;\r\n\r\n    if(dialog.unread_count) {\r\n      this.managers.appMessagesManager.readHistory(selectedId, dialog.top_message);\r\n      this.managers.appMessagesManager.markDialogUnread(selectedId, true);\r\n    } else {\r\n      this.managers.appMessagesManager.markDialogUnread(selectedId);\r\n    }\r\n  };\r\n\r\n  private onDeleteClick = () => {\r\n    new PopupDeleteDialog(this.selectedId/* , 'delete' */);\r\n  };\r\n\r\n  onContextMenu = (e: MouseEvent | Touch) => {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    let li: HTMLElement = null;\r\n    \r\n    try {\r\n      li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n    } catch(e) {}\r\n    \r\n    if(!li) return;\r\n\r\n    if(e instanceof MouseEvent) e.preventDefault();\r\n    if(this.element.classList.contains('active')) {\r\n      return false;\r\n    }\r\n    if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n    const r = async() => {\r\n      this.filterId = appDialogsManager.filterId;\r\n      this.selectedId = li.dataset.peerId.toPeerId();\r\n      this.dialog = await this.managers.appMessagesManager.getDialogOnly(this.selectedId);\r\n  \r\n      await Promise.all(this.buttons.map(async(button) => {\r\n        const good = await button.verify();\r\n  \r\n        button.element.classList.toggle('hide', !good);\r\n      }));\r\n  \r\n      // delete button\r\n      this.buttons[this.buttons.length - 1].element.lastChild.replaceWith(i18n(await this.managers.appPeersManager.getDeleteButtonText(this.selectedId)));\r\n  \r\n      li.classList.add('menu-open');\r\n      positionMenu(e, this.element);\r\n      contextMenuController.openBtnMenu(this.element, () => {\r\n        li.classList.remove('menu-open');\r\n        this.selectedId = this.dialog = this.filterId = undefined;\r\n      });\r\n    };\r\n\r\n    r();\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message } from \"../layer\";\r\n/* import findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Transition from \"./transition\"; */\r\n\r\nexport enum SENDING_STATUS {\r\n  Error = -1,\r\n  Pending,\r\n  Sent,\r\n  Read\r\n}\r\n\r\nexport function getSendingStatus(message: Message.message | Message.messageService) {\r\n  return message.pFlags.is_outgoing ? \r\n    SENDING_STATUS.Pending : (\r\n      message.pFlags.unread ? \r\n      SENDING_STATUS.Sent : \r\n      SENDING_STATUS.Read\r\n    );\r\n}\r\n\r\nexport function setSendingStatus(\r\n  container: HTMLElement, \r\n  message?: Message.message | Message.messageService, \r\n  disableAnimationIfRippleFound?: boolean\r\n) {\r\n  let className: 'check' | 'checks' | 'sending';\r\n  if(message?.pFlags.out) {\r\n    if(message.pFlags.is_outgoing) {\r\n      className = 'sending';\r\n    } else if(message.pFlags.unread) {\r\n      className = 'check';\r\n    } else {\r\n      className = 'checks';\r\n    }\r\n  }\r\n\r\n  if(!className) {\r\n    container.textContent = '';\r\n    return;\r\n  }\r\n  \r\n  const iconClassName = 'tgico-' + className;\r\n  const lastElement = container.lastElementChild as HTMLElement;\r\n  if(lastElement && lastElement.classList.contains(iconClassName)) {\r\n    return;\r\n  }\r\n  \r\n  const element = document.createElement('i');\r\n  element.classList.add('sending-status-icon', /* 'transition-item', */ iconClassName);\r\n  container.append(element);\r\n\r\n  if(lastElement) {\r\n    lastElement.remove();\r\n  }\r\n\r\n  /* if(!lastElement) {\r\n    element.classList.add('active');\r\n    return;\r\n  }\r\n\r\n  const select = Transition(container, undefined, 350, () => {\r\n    lastElement.remove();\r\n  }, false, true, false);\r\n\r\n  let animate = rootScope.settings.animationsEnabled && className !== 'sending' && !lastElement.classList.contains('tgico-sending');\r\n  if(disableAnimationIfRippleFound && animate) {\r\n    const parent = findUpClassName(container, 'rp');\r\n    if(parent.querySelector('.c-ripple__circle') || parent.matches(':hover')) {\r\n      animate = false;\r\n    }\r\n  }\r\n\r\n  select(element, animate, lastElement); */\r\n\r\n  /* SetTransition(lastElement, 'is-visible', false, 350, () => {\r\n    // lastElement.remove();\r\n  }, 2);\r\n  SetTransition(element, 'is-visible', true, 350, undefined, 2); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport App from \"../config/app\";\r\nimport DEBUG from \"../config/debug\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { LangPackKey, i18n } from \"../lib/langPack\";\r\nimport { logger } from \"../lib/logger\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Button from \"./button\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport sessionStorage from '../lib/sessionStorage';\r\nimport { ConnectionStatus } from \"../lib/mtproto/connectionStatus\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport singleInstance from \"../lib/mtproto/singleInstance\";\r\n\r\nexport default class ConnectionStatusComponent {\r\n  public static CHANGE_STATE_DELAY = 1000;\r\n\r\n  private statusContainer: HTMLElement;\r\n  private statusEl: HTMLElement;\r\n  private statusPreloader: ProgressivePreloader;\r\n\r\n  private currentLangPackKey: LangPackKey;\r\n\r\n  private hadConnect = false;\r\n  private retryAt: number;\r\n  private connecting = false;\r\n  private timedOut = false;\r\n  private updating = false;\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  private setFirstConnectionTimeout: number;\r\n  private setStateTimeout: number;\r\n\r\n  constructor(private managers: AppManagers, chatsContainer: HTMLElement) {\r\n    this.log = logger('CS', undefined, undefined);\r\n  \r\n    this.statusContainer = document.createElement('div');\r\n    this.statusContainer.classList.add('connection-status'/* , 'hide' */);\r\n\r\n    this.statusEl = Button('btn-primary bg-warning connection-status-button', {noRipple: true});\r\n    this.statusPreloader = new ProgressivePreloader({cancelable: false});\r\n    this.statusPreloader.constructContainer({color: 'transparent', bold: true});\r\n    this.statusContainer.append(this.statusEl);\r\n\r\n    chatsContainer.prepend(this.statusContainer);\r\n\r\n    rootScope.addEventListener('connection_status_change', (status) => {\r\n      console.log(status);\r\n\r\n      this.setConnectionStatus();\r\n    });\r\n\r\n    rootScope.addEventListener('state_synchronizing', (channelId) => {\r\n      if(!channelId) {\r\n        this.updating = true;\r\n        DEBUG && this.log('updating', this.updating);\r\n        this.setState();\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('state_synchronized', (channelId) => {\r\n      DEBUG && this.log('state_synchronized', channelId);\r\n      if(!channelId) {\r\n        this.updating = false;\r\n        DEBUG && this.log('updating', this.updating);\r\n        this.setState();\r\n      }\r\n    });\r\n\r\n    this.setFirstConnectionTimeout = window.setTimeout(this.setConnectionStatus, ConnectionStatusComponent.CHANGE_STATE_DELAY + 1e3);\r\n\r\n    /* let bool = true;\r\n    document.addEventListener('dblclick', () => {\r\n      const dcId = 2;\r\n      rootScope.dispatchEvent('connection_status_change', {\r\n        dcId: dcId,\r\n        isFileDownload: false,\r\n        isFileNetworker: false,\r\n        isFileUpload: false,\r\n        name: \"NET-\" + dcId,\r\n        status: bool ? (bool = false, ConnectionStatus.Closed) : (bool = true, ConnectionStatus.Connected),\r\n        _: \"networkerStatus\"\r\n      });\r\n    }); */\r\n  }\r\n\r\n  private setConnectionStatus = () => {\r\n    Promise.all([\r\n      sessionStorage.get('dc'),\r\n      rootScope.managers.rootScope.getConnectionStatus()\r\n    ]).then(([baseDcId, connectionStatus]) => {\r\n      if(!baseDcId) {\r\n        baseDcId = App.baseDcId;\r\n      }\r\n      \r\n      if(this.setFirstConnectionTimeout) {\r\n        clearTimeout(this.setFirstConnectionTimeout);\r\n        this.setFirstConnectionTimeout = 0;\r\n      }\r\n\r\n      const status = connectionStatus['NET-' + baseDcId];\r\n      const online = status && status.status === ConnectionStatus.Connected;\r\n\r\n      if(this.connecting && online) {\r\n        this.managers.apiUpdatesManager.forceGetDifference();\r\n      }\r\n\r\n      if(online && !this.hadConnect) {\r\n        this.hadConnect = true;\r\n      }\r\n      \r\n      this.timedOut = status && status.status === ConnectionStatus.TimedOut;\r\n      this.connecting = !online;\r\n      this.retryAt = status && status.retryAt;\r\n      DEBUG && this.log('connecting', this.connecting);\r\n      this.setState();\r\n    });\r\n  };\r\n\r\n  private setStatusText = (langPackKey: LangPackKey, args?: any[]) => {\r\n    if(this.currentLangPackKey === langPackKey) return;\r\n    this.currentLangPackKey = langPackKey;\r\n    replaceContent(this.statusEl, i18n(langPackKey, args));\r\n    this.statusPreloader.attach(this.statusEl);\r\n  };\r\n\r\n  private getA(langPackKey: LangPackKey, callback: () => void) {\r\n    const a = document.createElement('a');\r\n    a.classList.add('force-reconnect');\r\n    a.append(i18n(langPackKey));\r\n    attachClickEvent(a, (e) => {\r\n      cancelEvent(e);\r\n      callback();\r\n    });\r\n\r\n    return a;\r\n  }\r\n\r\n  private setState = () => {\r\n    if(singleInstance.deactivatedReason) {\r\n      return;\r\n    }\r\n\r\n    const timeout = ConnectionStatusComponent.CHANGE_STATE_DELAY;\r\n    if(this.connecting) {\r\n      if(this.timedOut) {\r\n        const a = this.getA('ConnectionStatus.ForceReconnect', () => this.managers.networkerFactory.forceReconnect());\r\n        this.setStatusText('ConnectionStatus.TimedOut', [a]);\r\n      } else if(this.hadConnect) {\r\n        if(this.retryAt !== undefined) {\r\n          const timerSpan = document.createElement('span');\r\n          const retryAt = this.retryAt;\r\n          const setTime = () => {\r\n            const now = Date.now();\r\n            timerSpan.innerText = '' + Math.round((retryAt - now) / 1000);\r\n            if(now > retryAt) {\r\n              clearInterval(interval);\r\n            }\r\n          };\r\n          const interval = setInterval(setTime, 1e3);\r\n          setTime();\r\n  \r\n          const a = this.getA('ConnectionStatus.Reconnect', () => this.managers.networkerFactory.forceReconnectTimeout());\r\n          this.setStatusText('ConnectionStatus.ReconnectIn', [timerSpan, a]);\r\n        } else {\r\n          this.setStatusText('ConnectionStatus.Reconnecting');\r\n        }\r\n      } else {\r\n        this.setStatusText('ConnectionStatus.Waiting');\r\n      }\r\n    } else if(this.updating) {\r\n      this.setStatusText('Updating');\r\n    }\r\n\r\n    DEBUG && this.log('setState', this.connecting || this.updating);\r\n    window.requestAnimationFrame(() => {\r\n      if(this.setStateTimeout) clearTimeout(this.setStateTimeout);\r\n\r\n      const cb = () => {\r\n        SetTransition(this.statusContainer, 'is-shown', this.connecting || this.updating, 200);\r\n        this.setStateTimeout = 0;\r\n        DEBUG && this.log('setState: isShown:', this.connecting || this.updating);\r\n      };\r\n\r\n      this.setStateTimeout = window.setTimeout(cb, timeout);\r\n      //cb();\r\n      /* if(timeout) this.setStateTimeout = window.setTimeout(cb, timeout);\r\n      else cb(); */\r\n    });\r\n  };\r\n}\r\n","// https://spicyyoghurt.com/tools/easing-functions\r\nexport default function easeInOutSine(t: number, b: number, c: number, d: number) {\r\n  return t >= d ? b + c : -c / 2 * (Math.cos(Math.PI * t / d) - 1) + b;\r\n}\r\n","export default function roundRect(\r\n  ctx: CanvasRenderingContext2D, \r\n  x: number, \r\n  y: number, \r\n  width: number, \r\n  height: number, \r\n  radius: {[k in 'tl' | 'tr' | 'br' | 'bl']?: number} | number, \r\n  fill?: boolean, \r\n  stroke?: boolean\r\n) {\r\n  const dpr = ctx.canvas.dpr;\r\n  if(dpr) {\r\n    x *= dpr;\r\n    y *= dpr;\r\n    width *= dpr;\r\n    height *= dpr;\r\n  }\r\n\r\n  if(typeof(radius) === 'number') {\r\n    if(dpr) radius *= dpr;\r\n    radius = {tl: radius, tr: radius, br: radius, bl: radius};\r\n  } else {\r\n    const defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};\r\n    for(const side in defaultRadius) {\r\n      // @ts-ignore\r\n      radius[side] = radius[side] ? (dpr ? radius[side] * dpr : radius[side]) : defaultRadius[side];\r\n    }\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.moveTo(x + radius.tl, y);\r\n  ctx.lineTo(x + width - radius.tr, y);\r\n  ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);\r\n  ctx.lineTo(x + width, y + height - radius.br);\r\n  ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);\r\n  ctx.lineTo(x + radius.bl, y + height);\r\n  ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);\r\n  ctx.lineTo(x, y + radius.tl);\r\n  ctx.quadraticCurveTo(x, y, x + radius.tl, y);\r\n  ctx.closePath();\r\n\r\n  if(fill) {\r\n    ctx.fill();\r\n  }\r\n\r\n  if(stroke) {\r\n    ctx.stroke();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../helpers/animation\";\r\nimport customProperties from \"../helpers/dom/customProperties\";\r\nimport easeInOutSine from \"../helpers/easing/easeInOutSine\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport roundRect from \"../helpers/canvas/roundRect\";\r\n\r\nconst DPR = window.devicePixelRatio;\r\nconst SIZE = 20 * DPR;\r\nconst MARGIN = 2.5 * DPR;\r\nconst WIDTH = 2 * DPR;\r\nconst RADIUS = 1 * DPR;\r\nconst LENGTH = 3;\r\n\r\nconst MIN_HEIGHT = 4;\r\nconst MAX_HEIGHT = 12;\r\nconst DURATION = 1000;\r\n\r\nexport default function groupCallActiveIcon(isActive = false) {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = canvas.height = SIZE;\r\n  const context = canvas.getContext('2d');\r\n  \r\n  const TOTAL_WIDTH = LENGTH * WIDTH + (LENGTH - 1) * MARGIN;\r\n  const START_X = (SIZE - TOTAL_WIDTH) / 2;\r\n  \r\n  const startTime = Date.now();\r\n  let wasMounted = false;\r\n  // let hadRound = false;\r\n  const renderFrame = () => {\r\n    if(!canvas.isConnected) {\r\n      if(wasMounted) {\r\n        return false;\r\n      }\r\n    } else if(!wasMounted) {\r\n      wasMounted = canvas.isConnected;\r\n    }\r\n    \r\n    const time = Date.now();\r\n    // if(((time - startTime) / DURATION) >= 1) {\r\n    //   hadRound = true;\r\n    // }\r\n    \r\n    const progress = easeInOutSine((time - startTime) % DURATION, 0, 1, DURATION);\r\n    \r\n    context.clearRect(0, 0, SIZE, SIZE);\r\n    context.fillStyle = isActive && !mediaSizes.isMobile ? customProperties.getProperty('primary-color') : '#fff';\r\n\r\n    for(let i = 0; i < LENGTH; ++i) {\r\n      const x = START_X + (i * WIDTH) + (i * MARGIN);\r\n\r\n      let itemProgress: number;\r\n      if(progress >= .5) {\r\n        itemProgress = i % 2 ? 2 - progress * 2 : (progress - .5) * 2;\r\n      } else {\r\n        itemProgress = i % 2 ? progress * 2 : 1 - progress * 2;\r\n      }\r\n\r\n      let height = MIN_HEIGHT + (itemProgress * (MAX_HEIGHT - MIN_HEIGHT));\r\n      /* if(!hadRound && i === 1) {\r\n        console.log('call status animation', itemProgress, height, progress, progress >= .5);\r\n      } */\r\n      \r\n      height *= DPR;\r\n      const y = (SIZE - height) / 2;\r\n      \r\n      roundRect(context, x, y, WIDTH, height, RADIUS, true);\r\n    }\r\n\r\n    return true;\r\n  };\r\n\r\n  return {\r\n    canvas,\r\n    startAnimation: () => {\r\n      animate(renderFrame);\r\n      renderFrame();\r\n    },\r\n    setActive: (active: boolean) => {\r\n      isActive = active;\r\n      renderFrame();\r\n    }\r\n  };\r\n}\r\n","import customProperties from \"../dom/customProperties\";\r\nimport clamp from \"../number/clamp\";\r\n\r\nexport default class Shimmer {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private font = \"30pt Helvetica\";\r\n  private currTime = Date.now();\r\n  private diffTime = 0;\r\n  private spread = 0;\r\n  private paused = false;\r\n  private pausedTime = 0;\r\n  private pauseInterval = 850;\r\n  private lightSource = 0;\r\n  private inc = 0.032;\r\n  private lightSpread = 0.55;\r\n  private animations = ['slide','slide','slide','slide'];\r\n  private currentAnimationIndex = 0;\r\n  private text: string;\r\n  private fillStyle: CanvasRenderingContext2D['fillStyle'];\r\n  \r\n  private keepTime() {\r\n    this.diffTime = Date.now() - this.currTime;\r\n    this.currTime = Date.now();\r\n  }\r\n  \r\n  private cycleAnimation() {\r\n    ++this.currentAnimationIndex;\r\n    if(this.currentAnimationIndex >= this.animations.length) {\r\n      this.currentAnimationIndex = 0;\r\n    }\r\n  }\r\n  \r\n  private animate() {\r\n    const currentAnimation = this.animations[this.currentAnimationIndex];\r\n    if(currentAnimation === 'glow') {\r\n      return this.animateGlow(); // return glow style\r\n    } else if(currentAnimation === 'slide') {\r\n      return this.animateSlide(); // return slide gradient\r\n    } else {\r\n      console.log(\"unknown animation type: \" + String(currentAnimation));\r\n    }\r\n  }\r\n  \r\n  private animateGlow() {\r\n    var glowEnd = 255, \r\n      rgbStart = 68,\r\n      r = rgbStart,\r\n      g = r,\r\n      b = r,\r\n      increment = 10,\r\n      interval = 800;\r\n\r\n    return () => {\r\n      var smartInc = increment * (this.diffTime / (1000 / 60));\r\n      if(this.paused) {\r\n        if((Date.now() - this.pausedTime) > interval){\r\n          r = rgbStart;\r\n          this.cycleAnimation()\r\n          this.paused = false;\r\n        }\r\n      } else {\r\n        r = parseInt('' + (r + smartInc));\r\n        if(r >= glowEnd){\r\n          this.paused = true;\r\n          this.pausedTime = Date.now()\r\n        }\r\n      }\r\n      return \"rgb(\"+ r + \",\" + r + \",\" + r + \")\";\r\n    };\r\n  }\r\n  \r\n  private animateSlide(): CanvasGradient {\r\n    var gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, 0),\r\n      smartInc = this.inc * (this.diffTime / (1000 / 60)),\r\n      lightLeft,\r\n      lightRight,\r\n      lightCenter;\r\n    if(this.paused) {\r\n      if((Date.now() - this.pausedTime) > this.pauseInterval) {\r\n        this.lightSource = -0.6; \r\n        this.cycleAnimation()\r\n        this.paused = false;\r\n        return this.animateSlide();\r\n      }\r\n    } else {\r\n      this.lightSource += smartInc;\r\n      if(this.lightSource > (1 + this.lightSpread)) { \r\n        this.paused = true;\r\n        this.pausedTime = Date.now();\r\n      }\r\n    }\r\n    // lighting positions:\r\n    lightCenter = clamp(this.lightSource, 0, 1);\r\n    lightLeft = clamp(this.lightSource - this.lightSpread, 0, 1);\r\n    lightRight = clamp(this.lightSource + this.lightSpread, 0, 1);\r\n    \r\n    const backgroundColor = customProperties.getProperty('background-color-true');\r\n    const shimmerColor = customProperties.getProperty('surface-color');\r\n    gradient.addColorStop(lightLeft, backgroundColor);\r\n    gradient.addColorStop(lightCenter, shimmerColor);\r\n    gradient.addColorStop(lightRight, backgroundColor);\r\n    \r\n    return gradient;\r\n  }\r\n  \r\n  public settings(dict: Partial<{\r\n    canvas: Shimmer['canvas'],\r\n    fillStyle: Shimmer['fillStyle'],\r\n    font: Shimmer['font'],\r\n    lightSpread: Shimmer['lightSpread'],\r\n    inc: Shimmer['inc'],\r\n    animations: Shimmer['animations'],\r\n    text: Shimmer['text']\r\n  }> = {}) {\r\n    this.canvas = dict.canvas ?? document.createElement('canvas');\r\n    this.ctx = this.canvas.getContext('2d');\r\n    this.font = dict.font ?? this.font;\r\n    this.lightSpread = dict.lightSpread ?? this.lightSpread;\r\n    this.inc = dict.inc ?? this.inc;\r\n    this.animations = dict.animations ?? this.animations;\r\n    this.text = dict.text ?? this.text;\r\n    this.fillStyle = dict.fillStyle;\r\n\r\n    this.canvas.classList.add('shimmer-canvas');\r\n  }\r\n  \r\n  public on() {\r\n    const {width, height} = this.canvas;\r\n    // record the time we ran:\r\n    this.keepTime();\r\n    // clear and fill the canvas:\r\n    this.ctx.clearRect(0, 0, width, height);\r\n\r\n    if(this.font) {\r\n      this.ctx.font = this.font;\r\n    }\r\n\r\n    this.ctx.fillStyle = this.animate() as any;\r\n    this.ctx.fillRect(0, 0, width, height);\r\n\r\n    if(this.fillStyle) {\r\n      this.ctx.fillStyle = this.fillStyle;\r\n      this.ctx.fillRect(0, 0, width, height);\r\n    }\r\n\r\n    if(this.text) {\r\n      this.ctx.fillText(this.text, 50, 50);\r\n    }\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { animate } from \"./animation\";\r\nimport { drawCircleFromStart } from \"./canvas/drawCircle\";\r\nimport roundRect from \"./canvas/roundRect\";\r\nimport Shimmer from \"./canvas/shimmer\";\r\nimport customProperties from \"./dom/customProperties\";\r\nimport easeInOutSine from \"./easing/easeInOutSine\";\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nexport default class DialogsPlaceholder {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private shimmer: Shimmer;\r\n  private tempId: number;\r\n  private detachTime: number;\r\n  \r\n  private length: number;\r\n  private dialogHeight: number;\r\n  private availableLength: number;\r\n\r\n  private avatarSize: number;\r\n  private marginVertical: number;\r\n  private lineHeight: number;\r\n  private lineBorderRadius: number;\r\n  private lineMarginVertical: number;\r\n  private statusWidth: number;\r\n  private generatedValues: {\r\n    firstLineWidth: number,\r\n    secondLineWidth: number,\r\n    statusWidth: number\r\n  }[];\r\n  \r\n  private getRectFrom: Element;\r\n  private onRemove: () => void;\r\n  private blockScrollable: Scrollable;\r\n\r\n  constructor() {\r\n    this.shimmer = new Shimmer();\r\n    this.tempId = 0;\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.classList.add('dialogs-placeholder-canvas');\r\n    this.ctx = this.canvas.getContext('2d');\r\n\r\n    this.generatedValues = [];\r\n    this.avatarSize = 54;\r\n    this.marginVertical = 9;\r\n    this.lineHeight = 10;\r\n    this.lineBorderRadius = 6;\r\n    this.lineMarginVertical = 8;\r\n    this.statusWidth = 24;\r\n  }\r\n\r\n  public attach({container, rect, getRectFrom, onRemove, blockScrollable}: {\r\n    container: HTMLElement, \r\n    rect?: {width: number, height: number},\r\n    getRectFrom?: HTMLElement,\r\n    onRemove?: DialogsPlaceholder['onRemove'],\r\n    blockScrollable?: DialogsPlaceholder['blockScrollable']\r\n  }) {\r\n    const {canvas} = this;\r\n\r\n    this.onRemove = onRemove;\r\n    this.getRectFrom = getRectFrom || container;\r\n    if(this.blockScrollable = blockScrollable) {\r\n      blockScrollable.container.style.overflowY = 'hidden';\r\n    }\r\n    \r\n    this.updateCanvasSize(rect);\r\n    this.startAnimation();\r\n    container.append(canvas);\r\n  }\r\n\r\n  public detach(availableLength: number) {\r\n    if(this.detachTime) {\r\n      return;\r\n    }\r\n    \r\n    this.availableLength = availableLength;\r\n    this.detachTime = Date.now();\r\n    \r\n    if(!rootScope.settings.animationsEnabled) {\r\n      this.remove();\r\n    }\r\n  }\r\n\r\n  public remove() {\r\n    this.stopAnimation();\r\n\r\n    if(this.canvas.parentElement) {\r\n      this.canvas.remove();\r\n\r\n      if(this.onRemove) {\r\n        this.onRemove();\r\n        this.onRemove = undefined;\r\n      }\r\n\r\n      if(this.blockScrollable) {\r\n        this.blockScrollable.container.style.overflowY = '';\r\n        this.blockScrollable = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  private updateCanvasSize(rect: {width: number, height: number} = this.getRectFrom.getBoundingClientRect()) {\r\n    const {canvas} = this;\r\n    const dpr = canvas.dpr = window.devicePixelRatio;\r\n    canvas.width = rect.width * dpr;\r\n    canvas.height = rect.height * dpr;\r\n    canvas.style.width = rect.width + 'px';\r\n    canvas.style.height = rect.height + 'px';\r\n  }\r\n\r\n  private renderDetachAnimationFrame() {\r\n    const {\r\n      canvas, \r\n      ctx, \r\n      detachTime, \r\n      length, \r\n      availableLength\r\n    } = this;\r\n\r\n    if(!detachTime) {\r\n      return;\r\n    } else if(!rootScope.settings.animationsEnabled) {\r\n      this.remove();\r\n      return;\r\n    }\r\n\r\n    const {width} = canvas;\r\n\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n\r\n    // ctx.fillStyle = 'rgba(0, 0, 0, 0)';\r\n    // ctx.fillRect(0, 0, width, height);\r\n\r\n    // const DURATION = 500;\r\n    // const DELAY = DURATION;\r\n    const DURATION = 150;\r\n    const DELAY = 15;\r\n    const elapsedTime = Date.now() - detachTime;\r\n    let completed = true;\r\n    for(let i = 0; i < length; ++i) {\r\n      const delay = availableLength < length && i >= availableLength ? DELAY * (availableLength - 1) : DELAY * i;\r\n      const elapsedRowTime = elapsedTime - delay;\r\n      if(elapsedRowTime <= 0) {\r\n        completed = false;\r\n        continue;\r\n      }\r\n\r\n      const progress = easeInOutSine(elapsedRowTime, 0, 1, DURATION);\r\n\r\n      ctx.beginPath();\r\n      ctx.rect(0, this.dialogHeight * i, width, this.dialogHeight);\r\n      ctx.fillStyle = `rgba(0, 0, 0, ${progress})`;\r\n      ctx.fill();\r\n\r\n      if(progress < 1) {\r\n        completed = false;\r\n      }\r\n    }\r\n\r\n    // const totalRadius = Math.sqrt(width ** 2 + height ** 2);\r\n    // const gradient = ctx.createRadialGradient(\r\n    //   0, 0, 0, \r\n    //   0, 0, totalRadius);\r\n    // gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');\r\n    // gradient.addColorStop(progress, 'rgba(0, 0, 0, 0)');\r\n    // gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');\r\n\r\n    // const gradient = ctx.createLinearGradient(0, 0, 0, height);\r\n    // gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');\r\n    // gradient.addColorStop(progress, 'rgba(0, 0, 0, 0)');\r\n    // gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');\r\n    \r\n    // ctx.fillStyle = gradient;\r\n    // ctx.fillRect(0, 0, width, height);\r\n\r\n    ctx.globalCompositeOperation = 'source-over';\r\n\r\n    if(completed) {\r\n      this.remove();\r\n    }\r\n  }\r\n\r\n  private renderFrame() {\r\n    this.shimmer.on();\r\n    this.renderDetachAnimationFrame();\r\n  }\r\n\r\n  private startAnimation() {\r\n    const {canvas, shimmer} = this;\r\n    const tempId = ++this.tempId;\r\n    const pattern = this.createPattern();\r\n\r\n    shimmer.settings({\r\n      canvas,\r\n      fillStyle: pattern\r\n    });\r\n\r\n    const middleware = () => {\r\n      return this.tempId === tempId;\r\n    };\r\n\r\n    this.renderFrame();\r\n    animate(() => {\r\n      if(!middleware()) {\r\n        return false;\r\n      }\r\n\r\n      // ! should've removed the loop if animations are disabled\r\n      if(rootScope.settings.animationsEnabled) {\r\n        this.renderFrame();\r\n      }\r\n\r\n      // ! tempId can be changed during renderFrame\r\n      return middleware();\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', this.onThemeChange);\r\n    mediaSizes.addEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private stopAnimation() {\r\n    ++this.tempId;\r\n    rootScope.removeEventListener('theme_change', this.onThemeChange);\r\n    mediaSizes.removeEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private onThemeChange = () => {\r\n    this.stopAnimation();\r\n    this.startAnimation();\r\n  };\r\n\r\n  private onResize = () => {\r\n    const {canvas} = this;\r\n    const {width, height, dpr} = canvas;\r\n    this.updateCanvasSize();\r\n    if(canvas.width === width && canvas.height === height && canvas.dpr === dpr) {\r\n      return;\r\n    }\r\n    \r\n    this.stopAnimation();\r\n    this.startAnimation();\r\n  };\r\n\r\n  private createPattern() {\r\n    const {canvas, ctx} = this;\r\n\r\n    const patternCanvas = document.createElement('canvas');\r\n    const patternContext = patternCanvas.getContext('2d');\r\n    const dpr = canvas.dpr;\r\n    patternCanvas.dpr = dpr;\r\n    patternCanvas.width = canvas.width;\r\n    patternCanvas.height = canvas.height;\r\n    \r\n    patternContext.fillStyle = customProperties.getProperty('surface-color');\r\n    patternContext.fillRect(0, 0, patternCanvas.width, patternCanvas.height);\r\n    \r\n    patternContext.fillStyle = '#000';\r\n    patternContext.globalCompositeOperation = 'destination-out';\r\n    \r\n    const dialogHeight = this.dialogHeight = (this.avatarSize + this.marginVertical * 2) * dpr;\r\n    const length = this.length = Math.ceil(canvas.height / dialogHeight);\r\n    for(let i = 0; i < length; ++i) {\r\n      this.drawChat(patternContext, i, i * dialogHeight);\r\n    }\r\n\r\n    return ctx.createPattern(patternCanvas, 'no-repeat');\r\n  }\r\n\r\n  private drawChat(ctx: CanvasRenderingContext2D, i: number, y: number) {\r\n    let generatedValues = this.generatedValues[i];\r\n    if(!generatedValues) {\r\n      generatedValues = this.generatedValues[i] = {\r\n        firstLineWidth: 40 + Math.random() * 100, // 120\r\n        secondLineWidth: 120 + Math.random() * 130, // 240\r\n        statusWidth: 24 + Math.random() * 16,\r\n      };\r\n    }\r\n    \r\n    const {\r\n      firstLineWidth,\r\n      secondLineWidth,\r\n      statusWidth\r\n    } = generatedValues;\r\n\r\n    const {canvas} = ctx;\r\n    const {dpr} = canvas;\r\n    y /= dpr;\r\n\r\n    const {\r\n      avatarSize, \r\n      marginVertical, \r\n      lineHeight, \r\n      lineBorderRadius, \r\n      lineMarginVertical, \r\n    } = this;\r\n\r\n    let marginLeft = 17;\r\n    drawCircleFromStart(ctx, marginLeft, y + marginVertical, avatarSize / 2, true);\r\n\r\n    marginLeft += avatarSize + 10;\r\n    roundRect(ctx, marginLeft, y + marginVertical + lineMarginVertical, firstLineWidth, lineHeight, lineBorderRadius, true);\r\n    roundRect(ctx, marginLeft, y + marginVertical + avatarSize - lineHeight - lineMarginVertical, secondLineWidth, lineHeight, lineBorderRadius, true);\r\n\r\n    roundRect(ctx, canvas.width / dpr - 24 - statusWidth, y + marginVertical + lineMarginVertical, statusWidth, lineHeight, lineBorderRadius, true);\r\n  }\r\n}\r\n","export default function drawCircle(ctx: CanvasRenderingContext2D, x: number, y: number, radius: number, fill?: boolean, stroke?: boolean) {\r\n  const dpr = ctx.canvas.dpr;\r\n  if(dpr) {\r\n    x *= dpr;\r\n    y *= dpr;\r\n    radius *= dpr;\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.arc(x, y, radius, 0, 2 * Math.PI, false);\r\n  ctx.closePath();\r\n\r\n  if(fill) {\r\n    ctx.fill();\r\n  }\r\n\r\n  if(stroke) {\r\n    ctx.stroke();\r\n  }\r\n}\r\n\r\nexport function drawCircleFromStart(ctx: CanvasRenderingContext2D, x: number, y: number, radius: number, fill?: boolean, stroke?: boolean) {\r\n  return drawCircle(ctx, x + radius, y + radius, radius, fill, stroke);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDialogFilter as DialogFilter, MyDialogFilter } from \"../storages/filters\";\r\nimport type LazyLoadQueue from \"../../components/lazyLoadQueue\";\r\nimport type { Dialog, MyMessage } from \"./appMessagesManager\";\r\nimport type { MyPhoto } from \"./appPhotosManager\";\r\nimport type { MyDocument } from \"./appDocsManager\";\r\nimport type { State } from \"../../config/state\";\r\nimport AvatarElement from \"../../components/avatar\";\r\nimport DialogsContextMenu from \"../../components/dialogsContextMenu\";\r\nimport { horizontalMenu } from \"../../components/horizontalMenu\";\r\nimport ripple from \"../../components/ripple\";\r\nimport Scrollable, { ScrollableX, SliceSides } from \"../../components/scrollable\";\r\nimport { formatDateAccordingToTodayNew } from \"../../helpers/date\";\r\nimport { IS_MOBILE_SAFARI, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport appImManager from \"./appImManager\";\r\nimport Button from \"../../components/button\";\r\nimport SetTransition from \"../../components/singleTransition\";\r\nimport { MyDraftMessage } from \"./appDraftsManager\";\r\nimport DEBUG, { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport PeerTitle from \"../../components/peerTitle\";\r\nimport I18n, { FormatterArguments, i18n, LangPackKey, _i18n } from \"../langPack\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport lottieLoader from \"../rlottie/lottieLoader\";\r\nimport { wrapPhoto } from \"../../components/wrappers\";\r\nimport AppEditFolderTab from \"../../components/sidebarLeft/tabs/editFolder\";\r\nimport appSidebarLeft, { SettingSection } from \"../../components/sidebarLeft\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport ConnectionStatusComponent from \"../../components/connectionStatus\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport { fastRafConventional, fastRafPromise } from \"../../helpers/schedulers\";\r\nimport SortedUserList from \"../../components/sortedUserList\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport handleTabSwipe from \"../../helpers/dom/handleTabSwipe\";\r\nimport windowSize from \"../../helpers/windowSize\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport { setSendingStatus } from \"../../components/sendingStatus\";\r\nimport SortedList, { SortedElementBase } from \"../../helpers/sortedList\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport groupCallActiveIcon from \"../../components/groupCallActiveIcon\";\r\nimport { Chat, Message, NotifyPeer } from \"../../layer\";\r\nimport IS_GROUP_CALL_SUPPORTED from \"../../environment/groupCallSupport\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport appNavigationController, { NavigationItem } from \"../../components/appNavigationController\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport generateTitleIcons from \"../../components/generateTitleIcons\";\r\nimport appMediaPlaybackController from \"../../components/appMediaPlaybackController\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"./managers\";\r\nimport appSidebarRight from \"../../components/sidebarRight\";\r\nimport PopupElement from \"../../components/popups\";\r\nimport choosePhotoSize from \"./utils/photos/choosePhotoSize\";\r\nimport wrapEmojiText from \"../richTextProcessor/wrapEmojiText\";\r\nimport wrapMessageForReply from \"../../components/wrappers/messageForReply\";\r\nimport isMessageRestricted from \"./utils/messages/isMessageRestricted\";\r\nimport getMediaFromMessage from \"./utils/messages/getMediaFromMessage\";\r\nimport getMessageSenderPeerIdOrName from \"./utils/messages/getMessageSenderPeerIdOrName\";\r\nimport wrapStickerEmoji from \"../../components/wrappers/stickerEmoji\";\r\nimport getDialogIndexKey from \"./utils/dialogs/getDialogIndexKey\";\r\nimport getProxiedManagers from \"./getProxiedManagers\";\r\nimport getDialogIndex from \"./utils/dialogs/getDialogIndex\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport deferredPromise, { CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport wrapPeerTitle from \"../../components/wrappers/peerTitle\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport appDownloadManager from \"./appDownloadManager\";\r\nimport groupCallsController from \"../calls/groupCallsController\";\r\nimport callsController from \"../calls/callsController\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport noop from \"../../helpers/noop\";\r\nimport DialogsPlaceholder from \"../../helpers/dialogsPlaceholder\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\n\r\nexport const DIALOG_LIST_ELEMENT_TAG = 'A';\r\n\r\nexport type DialogDom = {\r\n  avatarEl: AvatarElement,\r\n  captionDiv: HTMLDivElement,\r\n  titleSpan: HTMLSpanElement,\r\n  titleSpanContainer: HTMLSpanElement,\r\n  statusSpan: HTMLSpanElement,\r\n  lastTimeSpan: HTMLSpanElement,\r\n  unreadBadge: HTMLElement,\r\n  callIcon?: ReturnType<typeof groupCallActiveIcon>,\r\n  mentionsBadge?: HTMLElement,\r\n  lastMessageSpan: HTMLSpanElement,\r\n  containerEl: HTMLElement,\r\n  listEl: HTMLElement,\r\n  subtitleEl: HTMLElement,\r\n\r\n  setLastMessagePromise?: CancellablePromise<void>,\r\n  setUnreadMessagePromise?: CancellablePromise<void>\r\n};\r\n\r\ninterface SortedDialog extends SortedElementBase {\r\n  dom: DialogDom,\r\n  loadPromises?: Promise<any>[]\r\n}\r\n\r\nfunction setPromiseMiddleware<T extends {[smth in K as K]?: CancellablePromise<void>}, K extends keyof T>(obj: T, key: K) {\r\n  const oldPromise = obj[key];\r\n  if(oldPromise) {\r\n    oldPromise.reject();\r\n  }\r\n\r\n  // @ts-ignore\r\n  const deferred = obj[key] = deferredPromise<void>();\r\n  deferred.catch(() => {}).finally(() => {\r\n    if(obj[key] === deferred) {\r\n      delete obj[key];\r\n    }\r\n  });\r\n\r\n  const middleware = middlewarePromise(() => obj[key] === deferred);\r\n  return {deferred, middleware};\r\n}\r\n\r\nclass SortedDialogList extends SortedList<SortedDialog> {\r\n  constructor(\r\n    public managers: AppManagers,\r\n    public list: HTMLUListElement, \r\n    public indexKey: ReturnType<typeof getDialogIndexKey>,\r\n    public onListLengthChange?: () => void,\r\n  ) {\r\n    super({\r\n      getIndex: (element) => managers.dialogsStorage.getDialogIndex(element.id, this.indexKey),\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onListLengthChange && this.onListLengthChange();\r\n      },\r\n      onSort: (element, idx) => {\r\n        const willChangeLength = element.dom.listEl.parentElement !== this.list;\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n\r\n        if(willChangeLength) {\r\n          this.onListLengthChange && this.onListLengthChange();\r\n        }\r\n      },\r\n      onElementCreate: (base, batch) => {\r\n        const loadPromises: Promise<any>[] = batch ? [] : undefined;\r\n\r\n        const {dom} = appDialogsManager.addListDialog({peerId: base.id, loadPromises, isBatch: batch});\r\n        (base as SortedDialog).dom = dom;\r\n\r\n        if(loadPromises?.length) {\r\n          (base as SortedDialog).loadPromises = loadPromises;\r\n          Promise.all(loadPromises).finally(() => {\r\n            delete (base as SortedDialog).loadPromises;\r\n          });\r\n        }\r\n\r\n        return base as SortedDialog;\r\n      },\r\n      updateElementWith: fastRafConventional\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    this.list.innerHTML = '';\r\n    super.clear();\r\n  }\r\n}\r\n\r\n//const testScroll = false;\r\n//let testTopSlice = 1;\r\n\r\nexport class AppDialogsManager {\r\n  private chatsContainer = document.getElementById('chatlist-container') as HTMLDivElement;\r\n\r\n  private loadDialogsPromise: Promise<{cached: boolean, renderPromise: AppDialogsManager['loadDialogsRenderPromise']}>;\r\n  private loadDialogsRenderPromise: Promise<void>;\r\n\r\n  private scroll: Scrollable = null;\r\n  \r\n  private log = logger('DIALOGS', LogTypes.Log | LogTypes.Error | LogTypes.Warn | LogTypes.Debug);\r\n\r\n  private contextMenu: DialogsContextMenu;\r\n\r\n  private sortedList: SortedDialogList;\r\n  public placeholders: {[filterId: number]: DialogsPlaceholder} = {};\r\n  public sortedLists: {[filterId: number]: SortedDialogList} = {};\r\n  public scrollables: {[filterId: number]: Scrollable} = {};\r\n  public filterId: number;\r\n  private folders: {[k in 'menu' | 'container' | 'menuScrollContainer']: HTMLElement} = {\r\n    menu: document.getElementById('folders-tabs'),\r\n    menuScrollContainer: null,\r\n    container: document.getElementById('folders-container')\r\n  };\r\n  private filtersRendered: {\r\n    [filterId: string]: {\r\n      menu: HTMLElement, \r\n      container: HTMLElement,\r\n      unread: HTMLElement,\r\n      title: HTMLElement\r\n    }\r\n  } = {};\r\n  private showFiltersPromise: Promise<void>;\r\n\r\n  private sliceTimeout: number;\r\n\r\n  private lastActiveElements: Set<HTMLElement> = new Set();\r\n\r\n  private offsets: {top: number, bottom: number} = {top: 0, bottom: 0};\r\n  \r\n  private loadContacts: () => void;\r\n  private processContact: (peerId: PeerId) => void;\r\n\r\n  private indexKey: ReturnType<typeof getDialogIndexKey>;\r\n\r\n  private initedListeners = false;\r\n\r\n  private onListLengthChange: () => Promise<void>;\r\n  private loadedDialogsAtLeastOnce = false;\r\n  private allChatsIntlElement: I18n.IntlElement;\r\n\r\n  private emptyDialogsPlaceholderSubtitle: I18n.IntlElement;\r\n  private updateContactsLengthPromise: Promise<number>;\r\n\r\n  private filtersNavigationItem: NavigationItem;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    const managers = this.managers = getProxiedManagers();\r\n\r\n    this.contextMenu = new DialogsContextMenu(managers);\r\n\r\n    this.folders.menuScrollContainer = this.folders.menu.parentElement;\r\n\r\n    this.onListLengthChange = debounce(this._onListLengthChange, 100, false, true);\r\n\r\n    const bottomPart = document.createElement('div');\r\n    bottomPart.classList.add('connection-status-bottom');\r\n    bottomPart.append(this.folders.container);\r\n\r\n    /* if(isTouchSupported && isSafari) {\r\n      let allowUp: boolean, allowDown: boolean, slideBeginY: number;\r\n      const container = this.scroll.container;\r\n      container.addEventListener('touchstart', (event) => {\r\n        allowUp = container.scrollTop > 0;\r\n        allowDown = (container.scrollTop < container.scrollHeight - container.clientHeight);\r\n        // @ts-ignore\r\n        slideBeginY = event.pageY;\r\n      });\r\n      \r\n      container.addEventListener('touchmove', (event: any) => {\r\n        var up = (event.pageY > slideBeginY);\r\n        var down = (event.pageY < slideBeginY);\r\n        slideBeginY = event.pageY;\r\n        if((up && allowUp) || (down && allowDown)) {\r\n          event.stopPropagation();\r\n        } else if(up || down) {\r\n          event.preventDefault();\r\n        }\r\n      });\r\n    } */\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      handleTabSwipe({\r\n        element: this.folders.container,\r\n        onSwipe: (xDiff) => {\r\n          const prevId = selectTab.prevId();\r\n          selectTab(xDiff > 0 ? prevId + 1 : prevId - 1);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.allChatsIntlElement = new I18n.IntlElement({\r\n      key: 'FilterAllChatsShort'\r\n    });\r\n\r\n    /* if(testScroll) {\r\n      let i = 0;\r\n      let add = () => {\r\n        let li = document.createElement('li');\r\n        li.dataset.id = '' + i;\r\n        li.id = '' + i;\r\n        li.innerHTML = `<div class=\"rp\"><avatar-element style=\"background-color: rgb(166, 149, 231); font-size: 0px;\"><img src=\"assets/img/pepe.jpg\"></avatar-element><div class=\"user-caption\"><p><span class=\"user-title\">${i}</span><span><span class=\"message-status\"></span><span class=\"message-time\">18:33</span></span></p><p><span class=\"user-last-message\"><b>-_-_-_-: </b>qweasd</span><span></span></p></div></div>`;\r\n        i++;\r\n        this.scroll.append(li);\r\n      };\r\n      for(let i = 0; i < 500; ++i) {\r\n        add();\r\n      }\r\n      (window as any).addElement = add;\r\n    } */\r\n\r\n    rootScope.addEventListener('state_cleared', () => {\r\n      //setTimeout(() => \r\n      apiManagerProxy.getState().then(async(state) => {\r\n        this.loadedDialogsAtLeastOnce = false;\r\n\r\n        /* const clearPromises: Promise<any>[] = [];\r\n        for(const name in this.managers.appStateManager.storagesResults) {\r\n          const results = this.managers.appStateManager.storagesResults[name as keyof AppStateManager['storages']];\r\n          const storage = this.managers.appStateManager.storages[name as keyof AppStateManager['storages']];\r\n          results.length = 0;\r\n          clearPromises.push(storage.clear());\r\n        } */\r\n\r\n        this.sortedList.clear();\r\n        this.onTabChange();\r\n        this.onStateLoaded(state);\r\n      })//, 5000);\r\n    });\r\n\r\n    this.setFilterId(0, 0);\r\n    this.addFilter({\r\n      id: this.filterId,\r\n      title: '',\r\n      orderIndex: 0\r\n    });\r\n\r\n    const foldersScrollable = new ScrollableX(this.folders.menuScrollContainer);\r\n    bottomPart.prepend(this.folders.menuScrollContainer);\r\n    const selectTab = horizontalMenu(this.folders.menu, this.folders.container, (id, tabContent) => {\r\n      /* if(id !== 0) {\r\n        id += 1;\r\n      } */\r\n\r\n      id = +tabContent.dataset.filterId || 0;\r\n\r\n      if(!IS_MOBILE_SAFARI) {\r\n        if(id) {\r\n          if(!this.filtersNavigationItem) {\r\n            this.filtersNavigationItem = {\r\n              type: 'filters',\r\n              onPop: () => {\r\n                selectTab(0);\r\n                this.filtersNavigationItem = undefined;\r\n              }\r\n            };\r\n    \r\n            appNavigationController.spliceItems(1, 0, this.filtersNavigationItem);\r\n          }\r\n        } else if(this.filtersNavigationItem) {\r\n          appNavigationController.removeItem(this.filtersNavigationItem);\r\n          this.filtersNavigationItem = undefined;\r\n        }\r\n      }\r\n\r\n      if(this.filterId === id) return;\r\n\r\n      this.sortedLists[id].clear();\r\n      return this.setFilterIdAndChangeTab(id).then(({cached, renderPromise}) => {\r\n        if(cached) {\r\n          return renderPromise;\r\n        }\r\n      });\r\n    }, () => {\r\n      for(const folderId in this.sortedLists) {\r\n        if(+folderId !== this.filterId) {\r\n          this.sortedLists[folderId].clear();\r\n          const placeholder = this.placeholders[folderId];\r\n          if(placeholder) {\r\n            placeholder.remove();\r\n          }\r\n        }\r\n      }\r\n    }, undefined, foldersScrollable);\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      // * it should've had a better place :(\r\n      appMediaPlaybackController.setPlaybackParams(state.playbackParams);\r\n      appMediaPlaybackController.addEventListener('playbackParams', (params) => {\r\n        this.managers.appStateManager.pushToState('playbackParams', params);\r\n      });\r\n      \r\n      return this.onStateLoaded(state);\r\n    })/* .then(() => {\r\n      const isLoadedMain = this.managers.appMessagesManager.dialogsStorage.isDialogsLoaded(0);\r\n      const isLoadedArchive = this.managers.appMessagesManager.dialogsStorage.isDialogsLoaded(1);\r\n      const wasLoaded = isLoadedMain || isLoadedArchive;\r\n      const a: Promise<any> = isLoadedMain ? Promise.resolve() : this.managers.appMessagesManager.getConversationsAll('', 0);\r\n      const b: Promise<any> = isLoadedArchive ? Promise.resolve() : this.managers.appMessagesManager.getConversationsAll('', 1);\r\n      a.finally(() => {\r\n        b.then(() => {\r\n          if(wasLoaded) {\r\n            (apiUpdatesManager.updatesState.syncLoading || Promise.resolve()).then(() => {\r\n              this.managers.appMessagesManager.refreshConversations();\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }) */;\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      this.changeFiltersAllChatsKey();\r\n    });\r\n\r\n    new ConnectionStatusComponent(this.managers, this.chatsContainer);\r\n    this.chatsContainer.append(bottomPart);\r\n\r\n    setTimeout(() => {\r\n      lottieLoader.loadLottieWorkers();\r\n    }, 200);\r\n\r\n    PopupElement.MANAGERS = rootScope.managers = managers;\r\n    appDownloadManager.construct(managers);\r\n    appSidebarLeft.construct(managers);\r\n    appSidebarRight.construct(managers);\r\n    groupCallsController.construct(managers);\r\n    callsController.construct(managers);\r\n    appImManager.construct(managers);\r\n\r\n    // start\r\n\r\n    this.sortedList = this.sortedLists[this.filterId];\r\n    this.scroll = this.scrollables[this.filterId];\r\n\r\n    //selectTab(0);\r\n    (this.folders.menu.firstElementChild as HTMLElement).click();\r\n  }\r\n\r\n  public get chatList() {\r\n    return this.sortedList.list;\r\n  }\r\n\r\n  public setFilterId(filterId: number, orderIndex: MyDialogFilter['orderIndex']) {\r\n    this.indexKey = getDialogIndexKey(orderIndex);\r\n    this.filterId = filterId;\r\n  }\r\n\r\n  public async setFilterIdAndChangeTab(filterId: number) {\r\n    this.indexKey = await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(filterId);\r\n    this.filterId = filterId;\r\n    return this.onTabChange();\r\n  }\r\n\r\n  private setOnlineStatus(element: HTMLElement, online: boolean) {\r\n    const className = 'is-online';\r\n    const hasClassName = element.classList.contains(className);\r\n    !hasClassName && online && element.classList.add(className);\r\n    SetTransition(element, 'is-visible', online, 250, online ? undefined : () => {\r\n      element.classList.remove(className);\r\n    }, online && !hasClassName ? 2 : 0);\r\n  }\r\n\r\n  private initListeners() {\r\n    rootScope.addEventListener('user_update', async(userId) => {\r\n      //console.log('updating user:', user, dialog);\r\n      \r\n      const peerId = userId.toPeerId();\r\n      const dom = this.getDialogDom(peerId);\r\n      if(dom && peerId !== rootScope.myId && !(await this.managers.appUsersManager.isBot(userId))) {\r\n        const user = await this.managers.appUsersManager.getUser(userId);\r\n        const online = user.status?._ === 'userStatusOnline';\r\n        this.setOnlineStatus(dom.avatarEl, online);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('chat_update', async(chatId) => {\r\n      const peerId = chatId.toPeerId(true);\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(peerId);\r\n      if(dialog) {\r\n        this.processDialogForCallStatus(dialog);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('folder_unread', (folder) => {\r\n      this.setFilterUnreadCount(folder.id);\r\n    });\r\n\r\n    rootScope.addEventListener('contacts_update', (userId) => {\r\n      this.processContact && this.processContact(userId.toPeerId());\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_flush', ({dialog}) => {\r\n      if(!dialog) {\r\n        return;\r\n      }\r\n\r\n      this.setLastMessageN({\r\n        dialog, \r\n        setUnread: true\r\n      });\r\n      this.validateDialogForFilter(dialog);\r\n      this.setFiltersUnreadCount();\r\n    });\r\n\r\n    rootScope.addEventListener('dialogs_multiupdate', (dialogs) => {\r\n      for(const peerId in dialogs) {\r\n        const dialog = dialogs[peerId];\r\n        this.updateDialog(dialog);\r\n\r\n        if(this.processContact) {\r\n          this.processContact(peerId.toPeerId());\r\n        }\r\n\r\n        this.validateDialogForFilter(dialog);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_drop', ({peerId}) => {\r\n      this.deleteDialog(peerId);\r\n\r\n      if(this.processContact) {\r\n        this.processContact(peerId);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_unread', ({dialog}) => {\r\n      if(!dialog) {\r\n        return;\r\n      }\r\n\r\n      this.setUnreadMessagesN({dialog});\r\n      this.validateDialogForFilter(dialog);\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_notify_settings', (dialog) => {\r\n      this.validateDialogForFilter(dialog);\r\n      this.setUnreadMessagesN({dialog}); // возможно это не нужно, но нужно менять is-muted\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_draft', ({dialog, drop, peerId}) => {\r\n      if(drop) {\r\n        this.sortedList.delete(peerId);\r\n      } else {\r\n        this.updateDialog(dialog);\r\n      }\r\n\r\n      if(this.processContact) {\r\n        this.processContact(peerId);\r\n      }\r\n    });\r\n\r\n    appImManager.addEventListener('peer_changed', (peerId) => {\r\n      //const perf = performance.now();\r\n      for(const element of this.lastActiveElements) {\r\n        if(element.dataset.peerId.toPeerId() !== peerId) {\r\n          this.setDialogActive(element, false);\r\n        }\r\n      }\r\n\r\n      const elements = Array.from(document.querySelectorAll(`[data-autonomous=\"0\"] .chatlist-chat[data-peer-id=\"${peerId}\"]`)) as HTMLElement[];\r\n      elements.forEach((element) => {\r\n        this.setDialogActive(element, true);\r\n      });\r\n      //this.log('peer_changed total time:', performance.now() - perf);\r\n    });\r\n\r\n    rootScope.addEventListener('filter_update', async(filter) => {\r\n      if(!this.filtersRendered[filter.id]) {\r\n        this.addFilter(filter);\r\n        return;\r\n      } else if(filter.id === this.filterId) { // это нет тут смысла вызывать, так как будет dialogs_multiupdate\r\n        const dialogs = await this.managers.dialogsStorage.getCachedDialogs(true);\r\n        await this.validateListForFilter();\r\n        for(let i = 0, length = dialogs.length; i < length; ++i) {\r\n          const dialog = dialogs[i];\r\n          this.updateDialog(dialog);\r\n        }\r\n      }\r\n\r\n      const elements = this.filtersRendered[filter.id];\r\n      setInnerHTML(elements.title, wrapEmojiText(filter.title));\r\n    });\r\n\r\n    rootScope.addEventListener('filter_delete', (filter) => {\r\n      const elements = this.filtersRendered[filter.id];\r\n      if(!elements) return;\r\n\r\n      // set tab\r\n      //(this.folders.menu.firstElementChild.children[Math.max(0, filter.id - 2)] as HTMLElement).click();\r\n      (this.folders.menu.firstElementChild as HTMLElement).click();\r\n\r\n      elements.container.remove();\r\n      elements.menu.remove();\r\n      \r\n      delete this.sortedLists[filter.id];\r\n      delete this.scrollables[filter.id];\r\n      delete this.filtersRendered[filter.id];\r\n\r\n      this.onFiltersLengthChange();\r\n    });\r\n\r\n    rootScope.addEventListener('filter_order', async(order) => {\r\n      const containerToAppend = this.folders.menu as HTMLElement;\r\n      const r = await Promise.all(order.map(async(filterId) => {\r\n        return {\r\n          indexKey: await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(filterId), \r\n          filter: await this.managers.filtersStorage.getFilter(filterId)\r\n        };\r\n      }));\r\n\r\n      order.forEach((filterId, idx) => {\r\n        const {indexKey, filter} = r[idx];\r\n        const renderedFilter = this.filtersRendered[filterId];\r\n\r\n        const sortedList = this.sortedLists[filterId];\r\n        sortedList.indexKey = indexKey;\r\n\r\n        positionElementByIndex(renderedFilter.menu, containerToAppend, filter.orderIndex);\r\n        positionElementByIndex(renderedFilter.container, this.folders.container, filter.orderIndex);\r\n      });\r\n\r\n      this.indexKey = await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(this.filterId);\r\n\r\n      /* if(this.filterId) {\r\n        const tabIndex = order.indexOf(this.filterId) + 1;\r\n        selectTab.prevId = tabIndex;\r\n      } */\r\n    });\r\n\r\n    rootScope.addEventListener('peer_typings', async({peerId, typings}) => {\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(peerId);\r\n      if(!dialog) return;\r\n\r\n      if(typings.length) {\r\n        this.setTyping(dialog);\r\n      } else {\r\n        this.unsetTyping(dialog);\r\n      }\r\n    });\r\n  }\r\n\r\n  private setDialogActive(listEl: HTMLElement, active: boolean) {\r\n    // @ts-ignore\r\n    const dom = listEl.dialogDom as DialogDom;\r\n    listEl.classList.toggle('active', active);\r\n    if(active) {\r\n      this.lastActiveElements.add(listEl);\r\n    } else {\r\n      this.lastActiveElements.delete(listEl);\r\n    }\r\n\r\n    if(dom?.callIcon) {\r\n      dom.callIcon.setActive(active);\r\n    }\r\n  }\r\n\r\n  private async onStateLoaded(state: State) {\r\n    const loadDialogsPromise = this.onChatsScroll();\r\n\r\n    if(!this.initedListeners) {\r\n      this.initListeners();\r\n      this.initedListeners = true;\r\n    }\r\n\r\n    const haveFilters = !!(state.filters && Object.keys(state.filters).length);\r\n    const getDialogsFiltersPromise = haveFilters ? Promise.resolve(Object.values(state.filters).sort((a, b) => a.orderIndex - b.orderIndex)) : this.managers.filtersStorage.getDialogFilters();\r\n    const renderFiltersPromise = getDialogsFiltersPromise.then((filters) => {\r\n      for(const filter of filters) {\r\n        this.addFilter(filter);\r\n      }\r\n    });\r\n\r\n    if(haveFilters) {\r\n      await renderFiltersPromise;\r\n      if(this.showFiltersPromise) {\r\n        await this.showFiltersPromise;\r\n      }\r\n    }\r\n\r\n    this.managers.appNotificationsManager.getNotifyPeerTypeSettings();\r\n\r\n    await (await loadDialogsPromise).renderPromise;\r\n    this.managers.appMessagesManager.fillConversations();\r\n  }\r\n\r\n  /* private getOffset(side: 'top' | 'bottom'): {index: number, pos: number} {\r\n    if(!this.scroll.loadedAll[side]) {\r\n      const element = (side === 'top' ? this.chatList.firstElementChild : this.chatList.lastElementChild) as HTMLElement;\r\n      if(element) {\r\n        const peerId = element.dataset.peerId;\r\n        const dialog = this.managers.appMessagesManager.getDialogByPeerId(peerId);\r\n        return {index: dialog[0].index, pos: dialog[1]};\r\n      }\r\n    }\r\n\r\n    return {index: 0, pos: -1};\r\n  } */\r\n  private getOffsetIndex(side: 'top' | 'bottom') {\r\n    return {index: this.scroll.loadedAll[side] ? 0 : this.offsets[side]};\r\n  }\r\n\r\n  private isDialogMustBeInViewport(dialog: Dialog) {\r\n    if(dialog.migratedTo !== undefined || !this.testDialogForFilter(dialog)) return false;\r\n    //return true;\r\n    const topOffset = this.getOffsetIndex('top');\r\n    const bottomOffset = this.getOffsetIndex('bottom');\r\n    \r\n    if(!topOffset.index && !bottomOffset.index) {\r\n      return true;\r\n    }\r\n    \r\n    const index = getDialogIndex(dialog, this.indexKey);\r\n    return (!topOffset.index || index <= topOffset.index) && (!bottomOffset.index || index >= bottomOffset.index);\r\n  }\r\n\r\n  private deleteDialog(peerId: PeerId) {\r\n    this.sortedList.delete(peerId);\r\n  }\r\n\r\n  private updateDialog(dialog: Dialog) {\r\n    if(this.isDialogMustBeInViewport(dialog)) {\r\n      if(!this.sortedList.has(dialog.peerId)) {\r\n        this.sortedList.add(dialog.peerId);\r\n        return;\r\n      }\r\n    } else {\r\n      this.deleteDialog(dialog.peerId);\r\n      return;\r\n    }\r\n\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(dom) {\r\n      this.setLastMessageN({\r\n        dialog,\r\n        dom,\r\n        setUnread: true\r\n      });\r\n      this.sortedList.update(dialog.peerId);\r\n    }\r\n  }\r\n\r\n  public onTabChange = () => {\r\n    this.scroll = this.scrollables[this.filterId];\r\n    this.scroll.loadedAll.top = true;\r\n    this.scroll.loadedAll.bottom = false;\r\n    this.offsets.top = this.offsets.bottom = 0;\r\n    this.loadDialogsRenderPromise = undefined;\r\n    this.loadDialogsPromise = undefined;\r\n    this.sortedList = this.sortedLists[this.filterId];\r\n    return this.onChatsScroll();\r\n  };\r\n\r\n  private async setFilterUnreadCount(filterId: number) {\r\n    if(filterId === 0) {\r\n      return;\r\n    }\r\n\r\n    const unreadSpan = this.filtersRendered[filterId]?.unread;\r\n    if(!unreadSpan) {\r\n      return;\r\n    }\r\n\r\n    const {unreadUnmutedCount, unreadCount} = await this.managers.dialogsStorage.getFolderUnreadCount(filterId);\r\n    unreadSpan.classList.toggle('badge-gray', !unreadUnmutedCount);\r\n    unreadSpan.innerText = unreadCount ? '' + unreadCount : '';\r\n  }\r\n\r\n  private setFiltersUnreadCount() {\r\n    for(const filterId in this.filtersRendered) {\r\n      this.setFilterUnreadCount(+filterId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Удалит неподходящие чаты из списка, но не добавит их(!)\r\n   */\r\n  private async validateListForFilter() {\r\n    this.sortedList.getAll().forEach(async(element) => {\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(element.id);\r\n      if(!this.testDialogForFilter(dialog)) {\r\n        this.deleteDialog(element.id);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Удалит неподходящий чат из списка, но не добавит его(!)\r\n   */\r\n  private validateDialogForFilter(dialog: Dialog) {\r\n    if(!this.getDialogDom(dialog.peerId)) {\r\n      return;\r\n    }\r\n\r\n    if(!this.testDialogForFilter(dialog)) {\r\n      this.deleteDialog(dialog.peerId);\r\n    }\r\n  }\r\n\r\n  public testDialogForFilter(dialog: Dialog) {\r\n    if(\r\n      !dialog || \r\n      (this.filterId > 1 ? getDialogIndex(dialog, this.indexKey) === undefined : this.filterId !== dialog.folder_id)\r\n      // (filter && !(await this.managers.filtersStorage.testDialogForFilter(dialog, filter)))\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public generateScrollable(list: HTMLUListElement, filter: Parameters<AppDialogsManager['addFilter']>[0]) {\r\n    const filterId = filter.id;\r\n    const scrollable = new Scrollable(null, 'CL', 500);\r\n    scrollable.container.addEventListener('scroll', this.onChatsRegularScroll);\r\n    scrollable.container.dataset.filterId = '' + filterId;\r\n    scrollable.onScrolledTop = this.onChatsScrollTop;\r\n    scrollable.onScrolledBottom = this.onChatsScroll;\r\n    scrollable.setVirtualContainer(list);\r\n\r\n    const sortedDialogList = new SortedDialogList(\r\n      this.managers,\r\n      list, \r\n      getDialogIndexKey(filter.orderIndex),\r\n      this.onListLengthChange\r\n    );\r\n\r\n    this.scrollables[filterId] = scrollable;\r\n    this.sortedLists[filterId] = sortedDialogList;\r\n\r\n    // list.classList.add('hide');\r\n    // scrollable.container.style.backgroundColor = '#' + (Math.random() * (16 ** 6 - 1) | 0).toString(16);\r\n\r\n    return scrollable;\r\n  }\r\n\r\n  private addFilter(filter: Pick<DialogFilter, 'title' | 'id' | 'orderIndex'>) {\r\n    if(filter.id === 1) {\r\n      return;\r\n    }\r\n\r\n    const containerToAppend = this.folders.menu as HTMLElement;\r\n    const renderedFilter = this.filtersRendered[filter.id];\r\n    if(renderedFilter) {\r\n      positionElementByIndex(renderedFilter.menu, containerToAppend, filter.orderIndex);\r\n      positionElementByIndex(renderedFilter.container, this.folders.container, filter.orderIndex);\r\n      return;\r\n    }\r\n\r\n    const menuTab = document.createElement('div');\r\n    menuTab.classList.add('menu-horizontal-div-item');\r\n    const span = document.createElement('span');\r\n    const titleSpan = document.createElement('span');\r\n    titleSpan.classList.add('text-super');\r\n    if(filter.id === 0) titleSpan.append(this.allChatsIntlElement.element);\r\n    else setInnerHTML(titleSpan, wrapEmojiText(filter.title));\r\n    const unreadSpan = document.createElement('div');\r\n    unreadSpan.classList.add('badge', 'badge-20', 'badge-primary');\r\n    const i = document.createElement('i');\r\n    span.append(titleSpan, unreadSpan, i);\r\n    ripple(menuTab);\r\n    menuTab.append(span);\r\n\r\n    positionElementByIndex(menuTab, containerToAppend, filter.orderIndex);\r\n    //containerToAppend.append(li);\r\n\r\n    const ul = this.createChatList();\r\n    const scrollable = this.generateScrollable(ul, filter);\r\n\r\n    scrollable.container.classList.add('tabs-tab', 'chatlist-parts');\r\n\r\n    /* const parts = document.createElement('div');\r\n    parts.classList.add('chatlist-parts'); */\r\n    \r\n    const top = document.createElement('div');\r\n    top.classList.add('chatlist-top');\r\n    \r\n    const bottom = document.createElement('div');\r\n    bottom.classList.add('chatlist-bottom');\r\n\r\n    top.append(ul);\r\n    scrollable.container.append(top, bottom);\r\n    /* parts.append(top, bottom);\r\n    scrollable.container.append(parts); */\r\n    \r\n    const div = scrollable.container;\r\n    //this.folders.container.append(div);\r\n    positionElementByIndex(scrollable.container, this.folders.container, filter.orderIndex);\r\n\r\n    this.setListClickListener(ul, null, true);\r\n\r\n    this.filtersRendered[filter.id] = {\r\n      menu: menuTab,\r\n      container: div,\r\n      unread: unreadSpan,\r\n      title: titleSpan\r\n    };\r\n\r\n    this.onFiltersLengthChange();\r\n  }\r\n\r\n  private changeFiltersAllChatsKey() {\r\n    const scrollable = this.folders.menuScrollContainer.firstElementChild;\r\n    const key: LangPackKey = scrollable.scrollWidth > scrollable.clientWidth ? 'FilterAllChatsShort' : 'FilterAllChats';\r\n    this.allChatsIntlElement.compareAndUpdate({key});\r\n  }\r\n\r\n  private onFiltersLengthChange() {\r\n    if(!this.showFiltersPromise) {\r\n      this.showFiltersPromise = new Promise<void>((resolve) => {\r\n        window.setTimeout(() => {\r\n          const length = Object.keys(this.filtersRendered).length;\r\n          const show = length > 1;\r\n          const wasShowing = !this.folders.menuScrollContainer.classList.contains('hide');\r\n\r\n          if(show !== wasShowing) {\r\n            this.folders.menuScrollContainer.classList.toggle('hide', !show);\r\n            if(show && !wasShowing) {\r\n              this.setFiltersUnreadCount();\r\n            }\r\n\r\n            this.chatsContainer.classList.toggle('has-filters', show);\r\n          }\r\n\r\n          this.changeFiltersAllChatsKey();\r\n\r\n          this.showFiltersPromise = undefined;\r\n          resolve();\r\n        }, 0);\r\n      });\r\n    }\r\n\r\n    return this.showFiltersPromise;\r\n  }\r\n\r\n  private loadDialogs(side: SliceSides) {\r\n    /* if(testScroll) {\r\n      return;\r\n    } */\r\n\r\n    if(this.loadDialogsPromise || this.loadDialogsRenderPromise/*  || 1 === 1 */) return this.loadDialogsPromise;\r\n    else if(this.scroll.loadedAll[side]) {\r\n      return Promise.resolve({\r\n        cached: true,\r\n        renderPromise: Promise.resolve()\r\n      });\r\n    }\r\n\r\n    const cachedInfoPromise = deferredPromise<boolean>();\r\n    const renderPromise = new Promise<void>(async(resolve, reject) => {\r\n      const {chatList, filterId, indexKey} = this;\r\n      \r\n      //return;\r\n      \r\n      // let loadCount = 30/*this.chatsLoadCount */;\r\n      let loadCount = windowSize.height / 72 * 1.25 | 0;\r\n      let offsetIndex = 0;\r\n      \r\n      const {index: currentOffsetIndex} = this.getOffsetIndex(side);\r\n      if(currentOffsetIndex) {\r\n        if(side === 'top') {\r\n          const storage = await this.managers.dialogsStorage.getFolderDialogs(filterId, true);\r\n          const index = storage.findIndex((dialog) => getDialogIndex(dialog, indexKey) <= currentOffsetIndex);\r\n          const needIndex = Math.max(0, index - loadCount);\r\n          loadCount = index - needIndex;\r\n          offsetIndex = getDialogIndex(storage[needIndex], indexKey) + 1;\r\n        } else {\r\n          offsetIndex = currentOffsetIndex;\r\n        }\r\n      }\r\n      \r\n      //let offset = storage[storage.length - 1]?.index || 0;\r\n      \r\n      let placeholder = this.placeholders[filterId];\r\n      try {\r\n        const getConversationsResult = this.managers.acknowledged.appMessagesManager.getConversations('', offsetIndex, loadCount, filterId, true);\r\n        if(\r\n          !chatList.childElementCount && \r\n          !placeholder && \r\n          (\r\n            !this.loadedDialogsAtLeastOnce || \r\n            !(await getConversationsResult).cached\r\n          )\r\n        ) {\r\n          placeholder = this.placeholders[filterId] = new DialogsPlaceholder();\r\n          const getRectFrom = filterId === 1 ? this.chatsContainer : this.folders.container;\r\n          placeholder.attach({\r\n            container: chatList.parentElement, \r\n            getRectFrom, \r\n            onRemove: () => {\r\n              delete this.placeholders[filterId];\r\n            },\r\n            blockScrollable: this.scroll\r\n          });\r\n\r\n          cachedInfoPromise.resolve(false);\r\n        }\r\n  \r\n        const a = await getConversationsResult;\r\n        const result = await a.result;\r\n        if(this.loadDialogsRenderPromise !== renderPromise) {\r\n          reject();\r\n          cachedInfoPromise.reject();\r\n          return;\r\n        }\r\n\r\n        cachedInfoPromise.resolve(a.cached);\r\n  \r\n        //console.timeEnd('getDialogs time');\r\n  \r\n        // * loaded all\r\n        //if(!result.dialogs.length || chatList.childElementCount === result.count) {\r\n        // !result.dialogs.length не подходит, так как при супердревном диалоге getConversations его не выдаст.\r\n        //if(chatList.childElementCount === result.count) {\r\n        if(side === 'bottom') {\r\n          if(result.isEnd) {\r\n            this.scroll.loadedAll[side] = true;\r\n          }\r\n        } else if(result.isTopEnd) {\r\n          this.scroll.loadedAll[side] = true;\r\n        }\r\n\r\n        this.loadedDialogsAtLeastOnce = true;\r\n        \r\n        if(result.dialogs.length) {\r\n          const dialogs = side === 'top' ? result.dialogs.slice().reverse() : result.dialogs;\r\n  \r\n          const loadPromises: Promise<any>[] = [];\r\n\r\n          const callbacks: (() => void)[] = [];\r\n          const cccc = (callback: () => void) => {\r\n            callbacks.push(callback);\r\n          };\r\n\r\n          dialogs.forEach((dialog) => {\r\n            // :(\r\n            // const isBuggedDialog = !this.managers.appMessagesManager.getDialogOnly(dialog.peerId);\r\n            // if(isBuggedDialog) {\r\n            //   return;\r\n            // }\r\n\r\n            const element = this.sortedList.add(dialog.peerId, true, /* undefined, false,  */cccc, false);\r\n            if(element.loadPromises) {\r\n              loadPromises.push(...element.loadPromises);\r\n            }\r\n          });\r\n\r\n          loadPromises.push(fastRafPromise()); // it is needed here\r\n          await Promise.all(loadPromises).finally();\r\n          if(this.loadDialogsRenderPromise !== renderPromise) {\r\n            reject();\r\n            cachedInfoPromise.reject();\r\n            return;\r\n          }\r\n\r\n          callbacks.forEach((callback) => callback());\r\n        } else {\r\n          this.onListLengthChange();\r\n        }\r\n\r\n        const offsetDialog = result.dialogs[side === 'top' ? 0 : result.dialogs.length - 1];\r\n        if(offsetDialog) {\r\n          this.offsets[side] = getDialogIndex(offsetDialog, indexKey);\r\n        }\r\n\r\n        this.log.debug('getDialogs ' + loadCount + ' dialogs by offset:', offsetIndex, result, chatList.childElementCount);\r\n  \r\n        setTimeout(() => {\r\n          this.scroll.onScroll();\r\n        }, 0);\r\n      } catch(err) {\r\n        this.log.error(err);\r\n      }\r\n      \r\n      if(placeholder) {\r\n        // await pause(500);\r\n        placeholder.detach(chatList.childElementCount);\r\n      }\r\n      \r\n      resolve();\r\n    }).finally(() => {\r\n      if(this.loadDialogsRenderPromise === renderPromise) {\r\n        this.loadDialogsRenderPromise = undefined;\r\n        this.loadDialogsPromise = undefined;\r\n      }\r\n    });\r\n\r\n    this.loadDialogsRenderPromise = renderPromise;\r\n    return this.loadDialogsPromise = cachedInfoPromise.then((cached) => ({\r\n      cached,\r\n      renderPromise\r\n    }));\r\n  }\r\n\r\n  private generateEmptyPlaceholder(options: {\r\n    title: LangPackKey,\r\n    subtitle?: LangPackKey,\r\n    subtitleArgs?: FormatterArguments,\r\n    classNameType: string\r\n  }) {\r\n    const BASE_CLASS = 'empty-placeholder';\r\n    const container = document.createElement('div');\r\n    container.classList.add(BASE_CLASS, BASE_CLASS + '-' + options.classNameType);\r\n    \r\n    const header = document.createElement('div');\r\n    header.classList.add(BASE_CLASS + '-header');\r\n    _i18n(header, options.title);\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(BASE_CLASS + '-subtitle');\r\n    if(options.subtitle) {\r\n      _i18n(subtitle, options.subtitle, options.subtitleArgs);\r\n    }\r\n\r\n    container.append(header, subtitle);\r\n\r\n    return {container, header, subtitle};\r\n  }\r\n\r\n  private checkIfPlaceholderNeeded() {\r\n    if(this.filterId === 1) {\r\n      return;\r\n    }\r\n\r\n    const chatList = this.chatList;\r\n    const part = chatList.parentElement as HTMLElement;\r\n    let placeholderContainer = (Array.from(part.children) as HTMLElement[]).find((el) => el.matches('.empty-placeholder'));\r\n    const needPlaceholder = this.scroll.loadedAll.bottom && !chatList.childElementCount/*  || true */;\r\n    // chatList.style.display = 'none';\r\n\r\n    if(needPlaceholder && placeholderContainer) {\r\n      return;\r\n    } else if(!needPlaceholder) {\r\n      if(placeholderContainer) {\r\n        part.classList.remove('with-placeholder');\r\n        placeholderContainer.remove();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    let placeholder: ReturnType<AppDialogsManager['generateEmptyPlaceholder']>, type: 'dialogs' | 'folder';\r\n    if(!this.filterId) {\r\n      placeholder = this.generateEmptyPlaceholder({\r\n        title: 'ChatList.Main.EmptyPlaceholder.Title',\r\n        classNameType: type = 'dialogs'\r\n      });\r\n      \r\n      placeholderContainer = placeholder.container;\r\n      \r\n      const img = document.createElement('img');\r\n      img.classList.add('empty-placeholder-dialogs-icon');\r\n\r\n      this.emptyDialogsPlaceholderSubtitle = new I18n.IntlElement({\r\n        element: placeholder.subtitle\r\n      });\r\n      \r\n      Promise.all([\r\n        this.updateContactsLength(false),\r\n        renderImageFromUrlPromise(img, 'assets/img/EmptyChats.svg'),\r\n        fastRafPromise()\r\n      ]).then(([usersLength]) => {\r\n        placeholderContainer.classList.add('visible');\r\n        part.classList.toggle('has-contacts', !!usersLength);\r\n      });\r\n\r\n      placeholderContainer.prepend(img);\r\n    } else {\r\n      placeholder = this.generateEmptyPlaceholder({\r\n        title: 'FilterNoChatsToDisplay',\r\n        subtitle: 'FilterNoChatsToDisplayInfo',\r\n        classNameType: type = 'folder'\r\n      });\r\n\r\n      placeholderContainer = placeholder.container;\r\n\r\n      const div = document.createElement('div');\r\n      const emoji = '📂';\r\n      const size = 128;\r\n      wrapStickerEmoji({\r\n        div,\r\n        emoji: emoji,\r\n        width: size,\r\n        height: size\r\n      });\r\n\r\n      placeholderContainer.prepend(div);\r\n\r\n      const button = Button('btn-primary btn-color-primary btn-control tgico', {\r\n        text: 'FilterHeaderEdit',\r\n        icon: 'settings'\r\n      });\r\n\r\n      attachClickEvent(button, async() => {\r\n        appSidebarLeft.createTab(AppEditFolderTab).open(await this.managers.filtersStorage.getFilter(this.filterId));\r\n      });\r\n\r\n      placeholderContainer.append(button);\r\n    }\r\n\r\n    part.append(placeholderContainer);\r\n    part.classList.add('with-placeholder');\r\n    part.dataset.placeholderType = type;\r\n  }\r\n\r\n  private updateContactsLength(updatePartClassName: boolean) {\r\n    if(this.updateContactsLengthPromise) return this.updateContactsLengthPromise;\r\n    return this.updateContactsLengthPromise = this.managers.appUsersManager.getContacts().then((users) => {\r\n      const subtitle = this.emptyDialogsPlaceholderSubtitle;\r\n      if(subtitle) {\r\n        let key: LangPackKey, args: FormatterArguments;\r\n        \r\n        if(users.length/*  && false */) {\r\n          key = 'ChatList.Main.EmptyPlaceholder.Subtitle';\r\n          args = [i18n('Contacts.Count', [users.length])];\r\n        } else {\r\n          key = 'ChatList.Main.EmptyPlaceholder.SubtitleNoContacts';\r\n          args = [];\r\n        }\r\n\r\n        subtitle.compareAndUpdate({\r\n          key,\r\n          args\r\n        });\r\n      }\r\n\r\n      if(updatePartClassName) {\r\n        const chatList = this.chatList;\r\n        const part = chatList.parentElement as HTMLElement;\r\n        part.classList.toggle('has-contacts', !!users.length);\r\n      }\r\n\r\n      this.updateContactsLengthPromise = undefined;\r\n      \r\n      return users.length;\r\n    });\r\n  }\r\n\r\n  private removeContactsPlaceholder() {\r\n    const chatList = this.chatList;\r\n    const parts = chatList.parentElement.parentElement;\r\n    const bottom = chatList.parentElement.nextElementSibling as HTMLElement;\r\n    parts.classList.remove('with-contacts');\r\n    bottom.innerHTML = '';\r\n    this.loadContacts = undefined;\r\n    this.processContact = undefined;\r\n  }\r\n\r\n  private _onListLengthChange = () => {\r\n    if(!this.loadedDialogsAtLeastOnce) {\r\n      return;\r\n    }\r\n\r\n    this.checkIfPlaceholderNeeded();\r\n\r\n    if(this.filterId > 0) return;\r\n\r\n    const chatList = this.chatList;\r\n    const count = chatList.childElementCount;\r\n\r\n    const parts = chatList.parentElement.parentElement;\r\n    const bottom = chatList.parentElement.nextElementSibling as HTMLElement;\r\n    const hasContacts = !!bottom.childElementCount;\r\n    if(count >= 10) {\r\n      if(hasContacts) {\r\n        this.removeContactsPlaceholder();\r\n      }\r\n\r\n      return;\r\n    } else if(hasContacts) return;\r\n\r\n    parts.classList.add('with-contacts');\r\n\r\n    const section = new SettingSection({\r\n      name: 'Contacts',\r\n      noDelimiter: true,\r\n      fakeGradientDelimiter: true\r\n    });\r\n\r\n    section.container.classList.add('hide');\r\n\r\n    this.managers.appUsersManager.getContactsPeerIds(undefined, undefined, 'online').then((contacts) => {\r\n      let ready = false;\r\n      const onListLengthChange = () => {\r\n        if(ready) {\r\n          section.container.classList.toggle('hide', !sortedUserList.list.childElementCount);\r\n        }\r\n\r\n        this.updateContactsLength(true);\r\n      };\r\n\r\n      const sortedUserList = new SortedUserList({\r\n        avatarSize: 42, \r\n        createChatListOptions: {\r\n          dialogSize: 48,\r\n          new: true\r\n        },\r\n        autonomous: false, \r\n        onListLengthChange,\r\n        managers: this.managers\r\n      });\r\n\r\n      this.loadContacts = () => {\r\n        const pageCount = windowSize.height / 60 | 0;\r\n        const arr = contacts.splice(0, pageCount).filter(this.verifyPeerIdForContacts);\r\n\r\n        arr.forEach((peerId) => {\r\n          sortedUserList.add(peerId);\r\n        });\r\n\r\n        if(!contacts.length) {\r\n          this.loadContacts = undefined;\r\n        }\r\n      };\r\n\r\n      this.loadContacts();\r\n\r\n      this.processContact = (peerId) => {\r\n        if(peerId.isAnyChat()) {\r\n          return;\r\n        }\r\n\r\n        const good = this.verifyPeerIdForContacts(peerId);\r\n        const added = sortedUserList.has(peerId);\r\n        if(!added && good) sortedUserList.add(peerId);\r\n        else if(added && !good) sortedUserList.delete(peerId);\r\n      };\r\n\r\n      const list = sortedUserList.list;\r\n      list.classList.add('chatlist-new');\r\n      this.setListClickListener(list);\r\n      section.content.append(list);\r\n\r\n      ready = true;\r\n      onListLengthChange();\r\n    });\r\n\r\n    bottom.append(section.container);\r\n  };\r\n\r\n  private verifyPeerIdForContacts = async(peerId: PeerId) => {\r\n    return await this.managers.appPeersManager.isContact(peerId) && !(await this.managers.appMessagesManager.getDialogOnly(peerId));\r\n  };\r\n\r\n  public onChatsRegularScroll = () => {\r\n    // return;\r\n\r\n    if(this.sliceTimeout) clearTimeout(this.sliceTimeout);\r\n    this.sliceTimeout = window.setTimeout(() => {\r\n      this.sliceTimeout = undefined;\r\n\r\n      if(!this.chatList.childElementCount || this.processContact) {\r\n        return;\r\n      }\r\n\r\n      /* const observer = new IntersectionObserver((entries) => {\r\n        const \r\n      });\r\n\r\n      Array.from(this.chatList.children).forEach((el) => {\r\n        observer.observe(el);\r\n      }); */\r\n\r\n      fastRafConventional(() => {\r\n\r\n      const perf = performance.now();\r\n\r\n      const scrollTopWas = this.scroll.scrollTop;\r\n\r\n      const firstElementChild = this.chatList.firstElementChild;\r\n      const rectContainer = this.scroll.container.getBoundingClientRect();\r\n      const rectTarget = firstElementChild.getBoundingClientRect();\r\n      const children = Array.from(this.scroll.splitUp.children) as HTMLElement[];\r\n\r\n      // const padding = 8;\r\n      // const offsetTop = this.folders.container.offsetTop;\r\n      let offsetTop = this.scroll.splitUp.offsetTop;\r\n      if(offsetTop && scrollTopWas < offsetTop) offsetTop -= scrollTopWas;\r\n      // const offsetTop = scrollTopWas < padding ? padding - scrollTopWas : 0;\r\n      const firstY = rectContainer.y + offsetTop;\r\n      const lastY = rectContainer.y/*  - 8 */; // 8px - .chatlist padding-bottom\r\n      \r\n      const firstElement = findUpTag(document.elementFromPoint(Math.ceil(rectTarget.x), Math.ceil(firstY + 1)), firstElementChild.tagName) as HTMLElement;\r\n      const lastElement = findUpTag(document.elementFromPoint(Math.ceil(rectTarget.x), Math.floor(lastY + rectContainer.height - 1)), firstElementChild.tagName) as HTMLElement;\r\n\r\n      //alert('got element:' + rect.y);\r\n\r\n      if(!firstElement || !lastElement) {\r\n        return;\r\n      }\r\n\r\n      //alert('got element:' + !!firstElement);\r\n\r\n      const firstElementRect = firstElement.getBoundingClientRect();\r\n      const elementOverflow = firstElementRect.y - firstY;\r\n\r\n      const sliced: HTMLElement[] = [];\r\n      const firstIndex = children.indexOf(firstElement);\r\n      const lastIndex = children.indexOf(lastElement);\r\n\r\n      const saveLength = 10;\r\n\r\n      const sliceFromStart = IS_SAFARI ? [] : children.slice(0, Math.max(0, firstIndex - saveLength));\r\n      const sliceFromEnd = children.slice(lastIndex + saveLength);\r\n\r\n      /* if(sliceFromStart.length !== sliceFromEnd.length) {\r\n        console.log('not equal', sliceFromStart.length, sliceFromEnd.length);\r\n      }\r\n\r\n      if(sliceFromStart.length > sliceFromEnd.length) {\r\n        const diff = sliceFromStart.length - sliceFromEnd.length;\r\n        sliceFromStart.splice(0, diff);\r\n      } else if(sliceFromEnd.length > sliceFromStart.length) {\r\n        const diff = sliceFromEnd.length - sliceFromStart.length;\r\n        sliceFromEnd.splice(sliceFromEnd.length - diff, diff);\r\n      } */\r\n\r\n      if(sliceFromStart.length) {\r\n        this.scroll.loadedAll.top = false;\r\n      }\r\n\r\n      if(sliceFromEnd.length) {\r\n        this.scroll.loadedAll.bottom = false;\r\n      }\r\n\r\n      sliced.push(...sliceFromStart);\r\n      sliced.push(...sliceFromEnd);\r\n\r\n      sliced.forEach((el) => {\r\n        const peerId = el.dataset.peerId.toPeerId();\r\n        this.deleteDialog(peerId);\r\n      });\r\n\r\n      this.setOffsets();\r\n\r\n      //this.log('[slicer] elements', firstElement, lastElement, rect, sliced, sliceFromStart.length, sliceFromEnd.length);\r\n\r\n      //this.log('[slicer] reset scrollTop', this.scroll.scrollTop, firstElement.offsetTop, firstElementRect.y, rect.y, elementOverflow);\r\n\r\n      //alert('left length:' + children.length);\r\n\r\n      this.scroll.scrollTop = firstElement.offsetTop - elementOverflow;\r\n\r\n      this.log('slice time', performance.now() - perf);\r\n      /* const firstElementRect = firstElement.getBoundingClientRect();\r\n      const scrollTop =  */\r\n\r\n      //this.scroll.scrollIntoView(firstElement, false);\r\n    });\r\n    }, 200);\r\n  };\r\n\r\n  private async setOffsets() {\r\n    const chatList = this.chatList;\r\n    const firstDialog = await this.getDialogFromElement(chatList.firstElementChild as HTMLElement);\r\n    const lastDialog = await this.getDialogFromElement(chatList.lastElementChild as HTMLElement);\r\n\r\n    const indexKey = this.indexKey;\r\n    this.offsets.top = getDialogIndex(firstDialog, indexKey);\r\n    this.offsets.bottom = getDialogIndex(lastDialog, indexKey);\r\n  }\r\n\r\n  private getDialogFromElement(element: HTMLElement) {\r\n    return this.managers.appMessagesManager.getDialogOnly(element.dataset.peerId.toPeerId());\r\n  }\r\n\r\n  public onChatsScrollTop = () => {\r\n    return this.onChatsScroll('top');\r\n  };\r\n  \r\n  public onChatsScroll = (side: SliceSides = 'bottom') => {\r\n    if(this.scroll.loadedAll[side]) {\r\n      if(this.loadContacts) {\r\n        this.loadContacts();\r\n      }\r\n    }\r\n\r\n    this.log('onChatsScroll', side);\r\n    return this.loadDialogs(side);\r\n  };\r\n\r\n  public setListClickListener(list: HTMLUListElement, onFound?: () => void, withContext = false, autonomous = false, openInner = false) {\r\n    let lastActiveListElement: HTMLElement;\r\n\r\n    const setPeerFunc = (openInner ? appImManager.setInnerPeer : appImManager.setPeer).bind(appImManager);\r\n\r\n    list.dataset.autonomous = '' + +autonomous;\r\n    list.addEventListener('mousedown', (e) => {\r\n      if(e.button !== 0) return;\r\n      \r\n      this.log('dialogs click list');\r\n      const target = e.target as HTMLElement;\r\n      const elem = findUpTag(target, DIALOG_LIST_ELEMENT_TAG);\r\n      \r\n      if(!elem) {\r\n        return;\r\n      }\r\n\r\n      const peerId = elem.dataset.peerId.toPeerId();\r\n\r\n      if(e.ctrlKey || e.metaKey) {\r\n        window.open((elem as HTMLAnchorElement).href || ('#' + peerId), '_blank');\r\n        cancelEvent(e);\r\n        return;\r\n      }\r\n\r\n      if(autonomous) {\r\n        const sameElement = lastActiveListElement === elem;\r\n        if(lastActiveListElement && !sameElement) {\r\n          lastActiveListElement.classList.remove('active');\r\n        }\r\n\r\n        if(elem) {\r\n          elem.classList.add('active');\r\n          lastActiveListElement = elem;\r\n          this.lastActiveElements.add(elem);\r\n        }\r\n      }\r\n\r\n      if(elem) {\r\n        if(onFound) onFound();\r\n\r\n        const lastMsgId = +elem.dataset.mid || undefined;\r\n\r\n        setPeerFunc({\r\n          peerId, lastMsgId\r\n        });\r\n      } else {\r\n        setPeerFunc();\r\n      }\r\n    }, {capture: true});\r\n\r\n    // cancel link click\r\n    list.addEventListener('click', (e) => {\r\n      if(e.button === 0) {\r\n        cancelEvent(e);\r\n      }\r\n    }, {capture: true});\r\n\r\n    if(DEBUG) {\r\n      list.addEventListener('dblclick', (e) => {\r\n        const li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n        if(li) {\r\n          const peerId = li.dataset.peerId.toPeerId();\r\n          this.log('debug dialog:', this.managers.appMessagesManager.getDialogByPeerId(peerId));\r\n        }\r\n      });\r\n    }\r\n\r\n    if(withContext) {\r\n      attachContextMenuListener(list, this.contextMenu.onContextMenu);\r\n    }\r\n  }\r\n\r\n  public createChatList(options: {\r\n    // avatarSize?: number,\r\n    // handheldsSize?: number,\r\n    // size?: number,\r\n    new?: boolean,\r\n    dialogSize?: number,\r\n    ignoreClick?: boolean\r\n  } = {}) {\r\n    const list = document.createElement('ul');\r\n    list.classList.add('chatlist'/* , \r\n      'chatlist-avatar-' + (options.avatarSize || 54) *//* , 'chatlist-' + (options.size || 72) */);\r\n\r\n    if(options.new) {\r\n      list.classList.add('chatlist-new');\r\n    }\r\n\r\n    if(options.dialogSize) {\r\n      list.classList.add('chatlist-' + options.dialogSize);\r\n    }\r\n\r\n    // if(options.ignoreClick) {\r\n    //   list.classList.add('disable-hover');\r\n    // }\r\n\r\n    /* if(options.handheldsSize) {\r\n      list.classList.add('chatlist-handhelds-' + options.handheldsSize);\r\n    } */\r\n\r\n    return list;\r\n  }\r\n\r\n  public setLastMessageN(options: {\r\n    dialog: Dialog, \r\n    lastMessage?: Message.message | Message.messageService, \r\n    dom?: DialogDom, \r\n    highlightWord?: string, \r\n    isBatch?: boolean,\r\n    setUnread?: boolean\r\n  }) {\r\n    const promise = this.setLastMessage(options.dialog, options.lastMessage, options.dom, options.highlightWord, options.isBatch, options.setUnread);\r\n    return promise.catch(noop);\r\n  }\r\n\r\n  private async setLastMessage(\r\n    dialog: Dialog, \r\n    lastMessage: Message.message | Message.messageService, \r\n    dom: DialogDom, \r\n    highlightWord?: string, \r\n    isBatch = false,\r\n    setUnread = false\r\n  ) {\r\n    if(!dom) {\r\n      dom = this.getDialogDom(dialog.peerId);\r\n\r\n      if(!dom) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    const {deferred: promise, middleware} = setPromiseMiddleware(dom, 'setLastMessagePromise');\r\n\r\n    let draftMessage: MyDraftMessage;\r\n    if(!lastMessage) {\r\n      if(dialog.draft?._ === 'draftMessage') {\r\n        draftMessage = dialog.draft;\r\n      }\r\n\r\n      lastMessage = dialog.topMessage;\r\n      if(!lastMessage || lastMessage.mid !== dialog.top_message) {\r\n        const promise = this.managers.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message);\r\n        lastMessage = await middleware(promise);\r\n      }\r\n    }\r\n\r\n    if(setUnread) {\r\n      this.setUnreadMessagesN({dialog, dom, isBatch, setLastMessagePromise: promise});\r\n    }\r\n\r\n    if(!lastMessage/*  || (lastMessage._ === 'messageService' && !lastMessage.rReply) */) {\r\n      dom.lastMessageSpan.textContent = '';\r\n      dom.lastTimeSpan.textContent = '';\r\n      delete dom.listEl.dataset.mid;\r\n\r\n      promise.resolve();\r\n      return;\r\n    }\r\n\r\n    const peerId = dialog.peerId;\r\n    const isRestricted = lastMessage && isMessageRestricted(lastMessage as Message.message);\r\n\r\n    /* if(!dom.lastMessageSpan.classList.contains('user-typing')) */ {\r\n      let mediaContainer: HTMLElement;\r\n      const willPrepend: (Promise<any> | HTMLElement)[] = [];\r\n      if(lastMessage && !draftMessage && !isRestricted) {\r\n        const media: MyDocument | MyPhoto = getMediaFromMessage(lastMessage);\r\n        const videoTypes: Set<MyDocument['type']> = new Set(['video', 'gif', 'round']);\r\n        if(media && (media._ === 'photo' || videoTypes.has(media.type))) {\r\n          const size = choosePhotoSize(media, 20, 20);\r\n\r\n          if(size._ !== 'photoSizeEmpty') {\r\n            mediaContainer = document.createElement('div');\r\n            mediaContainer.classList.add('dialog-subtitle-media');\r\n\r\n            if((media as MyDocument).type === 'round') {\r\n              mediaContainer.classList.add('is-round');\r\n            }\r\n            \r\n            willPrepend.push(wrapPhoto({\r\n              photo: media,\r\n              message: lastMessage,\r\n              container: mediaContainer,\r\n              withoutPreloader: true,\r\n              size\r\n            }).then(() => mediaContainer));\r\n\r\n            if(videoTypes.has((media as MyDocument).type)) {\r\n              const playIcon = document.createElement('span');\r\n              playIcon.classList.add('tgico-play');\r\n\r\n              mediaContainer.append(playIcon);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      /* if(lastMessage.from_id === auth.id) { // You:  */\r\n      if(draftMessage) {\r\n        const bold = document.createElement('b');\r\n        bold.classList.add('danger');\r\n        bold.append(i18n('Draft'), ': ');\r\n        willPrepend.unshift(bold);\r\n      } else if(peerId.isAnyChat() && peerId !== lastMessage.fromId && !(lastMessage as Message.messageService).action) {\r\n        const senderBold = document.createElement('b');\r\n\r\n        if(lastMessage.fromId === rootScope.myId) {\r\n          senderBold.append(i18n('FromYou'));\r\n          willPrepend.unshift(senderBold);\r\n        } else {\r\n          //str = sender.first_name || sender.last_name || sender.username;\r\n          const p = middleware(wrapPeerTitle({\r\n            peerId: lastMessage.fromId,\r\n            onlyFirstName: true,\r\n          })).then((element) => {\r\n            senderBold.prepend(element);\r\n            return senderBold;\r\n          }, noop);\r\n\r\n          willPrepend.unshift(p);\r\n        }\r\n\r\n        senderBold.append(': ');\r\n        //console.log(sender, senderBold.innerText);\r\n      }\r\n\r\n      const withoutMediaType = !!mediaContainer && !!(lastMessage as Message.message)?.message;\r\n\r\n      let fragment: DocumentFragment;\r\n      if(highlightWord && (lastMessage as Message.message).message) {\r\n        fragment = await middleware(wrapMessageForReply(lastMessage, undefined, undefined, false, highlightWord, withoutMediaType));\r\n      } else if(draftMessage) {\r\n        fragment = await middleware(wrapMessageForReply(draftMessage));\r\n      } else if(lastMessage) {\r\n        fragment = await middleware(wrapMessageForReply(lastMessage, undefined, undefined, false, undefined, withoutMediaType));\r\n      } else { // rare case\r\n        fragment = document.createDocumentFragment();\r\n      }\r\n\r\n      if(willPrepend.length) {\r\n        const elements = await middleware(Promise.all(willPrepend));\r\n        fragment.prepend(...elements);\r\n      }\r\n\r\n      replaceContent(dom.lastMessageSpan, fragment);\r\n    }\r\n\r\n    if(lastMessage || draftMessage/*  && lastMessage._ !== 'draftMessage' */) {\r\n      const date = draftMessage ? Math.max(draftMessage.date, lastMessage.date || 0) : lastMessage.date;\r\n      replaceContent(dom.lastTimeSpan, formatDateAccordingToTodayNew(new Date(date * 1000)));\r\n    } else dom.lastTimeSpan.textContent = '';\r\n\r\n    if(setUnread !== null && !setUnread) { // means search\r\n      dom.listEl.dataset.mid = '' + lastMessage.mid;\r\n    }\r\n\r\n    promise.resolve();\r\n  }\r\n\r\n  private setUnreadMessagesN(options: {\r\n    dialog: Dialog,\r\n    dom?: DialogDom,\r\n    isBatch?: boolean,\r\n    setLastMessagePromise?: Promise<void>\r\n  }) {\r\n    return this.setUnreadMessages(options.dialog, options.dom, options.isBatch, options.setLastMessagePromise).catch(() => {});\r\n  }\r\n\r\n  private async setUnreadMessages(\r\n    dialog: Dialog, \r\n    dom = this.getDialogDom(dialog.peerId), \r\n    isBatch = false,\r\n    setLastMessagePromise?: Promise<void>\r\n  ) {\r\n    if(!dom) {\r\n      //this.log.error('setUnreadMessages no dom!', dialog);\r\n      return;\r\n    }\r\n\r\n    const {deferred, middleware} = setPromiseMiddleware(dom, 'setUnreadMessagePromise');\r\n\r\n    const isMuted = await middleware(this.managers.appNotificationsManager.isPeerLocalMuted(dialog.peerId, true));\r\n    const wasMuted = dom.listEl.classList.contains('is-muted');\r\n\r\n    let setStatusMessage: MyMessage;\r\n    if(dialog.draft?._ !== 'draftMessage') {\r\n      const lastMessage: MyMessage = await middleware(this.managers.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message));\r\n      if(lastMessage && lastMessage.pFlags.out && lastMessage.peerId !== rootScope.myId) {\r\n        setStatusMessage = lastMessage;\r\n      }\r\n    }\r\n\r\n    const filter = await middleware(this.managers.filtersStorage.getFilter(this.filterId));\r\n    let isPinned: boolean;\r\n    if(filter) {\r\n      isPinned = filter.pinnedPeerIds.indexOf(dialog.peerId) !== -1;\r\n    } else {\r\n      isPinned = !!dialog.pFlags.pinned;\r\n    }\r\n\r\n    const isDialogUnread = await middleware(this.managers.appMessagesManager.isDialogUnread(dialog));\r\n    const hasUnreadBadge = isPinned || isDialogUnread;\r\n    // dom.messageEl.classList.toggle('has-badge', hasBadge);\r\n\r\n    // * have to await all promises before modifying something\r\n\r\n    if(setLastMessagePromise) {\r\n      try {\r\n        await middleware(setLastMessagePromise);\r\n      } catch(err) {\r\n        // return;\r\n      }\r\n    }\r\n\r\n    const transitionDuration = isBatch ? 0 : 200;\r\n\r\n    if(isMuted !== wasMuted) {\r\n      SetTransition(dom.listEl, 'is-muted', isMuted, transitionDuration);\r\n    }\r\n\r\n    setSendingStatus(dom.statusSpan, setStatusMessage, true);\r\n\r\n    const isUnreadBadgeMounted = isInDOM(dom.unreadBadge);\r\n    if(hasUnreadBadge && !isUnreadBadgeMounted) {\r\n      dom.subtitleEl.append(dom.unreadBadge);\r\n    }\r\n\r\n    const hasMentionsBadge = dialog.unread_mentions_count && (dialog.unread_mentions_count > 1 || dialog.unread_count > 1);\r\n    const isMentionBadgeMounted = dom.mentionsBadge && isInDOM(dom.mentionsBadge);\r\n    if(hasMentionsBadge) {\r\n      if(!dom.mentionsBadge) {\r\n        dom.mentionsBadge = document.createElement('div');\r\n        dom.mentionsBadge.className = 'dialog-subtitle-badge badge badge-24 mention mention-badge';\r\n        dom.mentionsBadge.innerText = '@';\r\n        dom.subtitleEl.insertBefore(dom.mentionsBadge, dom.lastMessageSpan.nextSibling);\r\n      }\r\n    }\r\n\r\n    SetTransition(dom.unreadBadge, 'is-visible', hasUnreadBadge, transitionDuration, hasUnreadBadge ? undefined : () => {\r\n      dom.unreadBadge.remove();\r\n    }, !isUnreadBadgeMounted ? 2 : 0);\r\n\r\n    if(dom.mentionsBadge) {\r\n      SetTransition(dom.mentionsBadge, 'is-visible', hasMentionsBadge, transitionDuration, hasMentionsBadge ? undefined : () => {\r\n        dom.mentionsBadge.remove();\r\n        delete dom.mentionsBadge;\r\n      }, !isMentionBadgeMounted ? 2 : 0);\r\n    }\r\n\r\n    if(!hasUnreadBadge) {\r\n      deferred.resolve();\r\n      return;\r\n    }\r\n\r\n    if(isPinned) {\r\n      dom.unreadBadge.classList.add('tgico-chatspinned', 'tgico');\r\n    } else {\r\n      dom.unreadBadge.classList.remove('tgico-chatspinned', 'tgico');\r\n    }\r\n\r\n    let isUnread = true, isMention = false;\r\n    if(dialog.unread_mentions_count && dialog.unread_count === 1) {\r\n      dom.unreadBadge.innerText = '@';\r\n      isMention = true;\r\n      // dom.unreadBadge.classList.add('tgico-mention', 'tgico');\r\n    } else if(isDialogUnread) {\r\n      //dom.unreadMessagesSpan.innerText = '' + (dialog.unread_count ? formatNumber(dialog.unread_count, 1) : ' ');\r\n      dom.unreadBadge.innerText = '' + (dialog.unread_count || ' ');\r\n    } else {\r\n      dom.unreadBadge.innerText = '';\r\n      isUnread = false;\r\n    }\r\n\r\n    dom.unreadBadge.classList.toggle('unread', isUnread);\r\n    dom.unreadBadge.classList.toggle('mention', isMention);\r\n    deferred.resolve();\r\n  }\r\n\r\n  private getDialogDom(peerId: PeerId) {\r\n    // return this.doms[peerId];\r\n    const element = this.sortedList.get(peerId);\r\n    return element?.dom;\r\n  }\r\n\r\n  private async getDialog(dialog: Dialog | PeerId) {\r\n    if(typeof(dialog) !== 'object') {\r\n      const originalDialog = await this.managers.appMessagesManager.getDialogOnly(dialog);\r\n      if(!originalDialog) {\r\n        const peerId = dialog || NULL_PEER_ID;\r\n        return {\r\n          peerId,\r\n          peer: await this.managers.appPeersManager.getOutputPeer(peerId),\r\n          pFlags: {}\r\n        } as any as Dialog;\r\n      }\r\n\r\n      return originalDialog;\r\n    }\r\n    \r\n    return dialog as Dialog;\r\n  }\r\n\r\n  private setCallStatus(dom: DialogDom, visible: boolean) {\r\n    let {callIcon, listEl} = dom;\r\n    if(!callIcon && visible) {\r\n      const {canvas, startAnimation} = dom.callIcon = callIcon = groupCallActiveIcon(listEl.classList.contains('active'));\r\n      canvas.classList.add('dialog-group-call-icon');\r\n      listEl.append(canvas);\r\n      startAnimation();\r\n    }\r\n\r\n    if(!callIcon) {\r\n      return;\r\n    }\r\n\r\n    SetTransition(dom.callIcon.canvas, 'is-visible', visible, 200, visible ? undefined : () => {\r\n      dom.callIcon.canvas.remove();\r\n      dom.callIcon = undefined;\r\n    }, visible ? 2 : 0);\r\n  }\r\n\r\n  public addListDialog(options: Parameters<AppDialogsManager['addDialogNew']>[0] & {isBatch?: boolean}) {\r\n    options.autonomous = false;\r\n    \r\n    const ret = this.addDialogNew(options);\r\n    \r\n    if(ret) {\r\n      const promise = this.getDialog(options.peerId).then((dialog) => {\r\n        const {peerId} = dialog;\r\n        const promises: Promise<any>[] = [];\r\n        if(!peerId.isUser()) {\r\n          promises.push(this.processDialogForCallStatus(dialog, ret.dom));\r\n        }\r\n\r\n        if(peerId !== rootScope.myId && peerId.isUser()) {\r\n          promises.push(this.managers.appUsersManager.getUser(peerId).then((user) => {\r\n            if(user.status?._ === 'userStatusOnline') {\r\n              this.setOnlineStatus(ret.dom.avatarEl, true);\r\n            }\r\n          }));\r\n        }\r\n  \r\n        promises.push(this.setLastMessageN({\r\n          dialog,\r\n          dom: ret.dom,\r\n          isBatch: options.isBatch,\r\n          setUnread: true\r\n        }));\r\n\r\n        return Promise.all(promises);\r\n      });\r\n\r\n      if(options.loadPromises) {\r\n        options.loadPromises.push(promise);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  private async processDialogForCallStatus(dialog: Dialog, dom?: DialogDom) {\r\n    if(!IS_GROUP_CALL_SUPPORTED) {\r\n      return;\r\n    }\r\n\r\n    if(!dom) dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) return;\r\n    \r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(dialog.peerId.toChatId());\r\n    this.setCallStatus(dom, !!(chat.pFlags.call_active && chat.pFlags.call_not_empty));\r\n  }\r\n\r\n  /**\r\n   * use for rendering search result\r\n   */\r\n  public addDialogAndSetLastMessage(options: Omit<Parameters<AppDialogsManager['addDialogNew']>[0], 'dialog'> & {\r\n    message: MyMessage, \r\n    peerId: PeerId,\r\n    query?: string\r\n  }) {\r\n    const {peerId, message, query} = options;\r\n    const ret = this.addDialogNew({\r\n      ...options,\r\n      ...getMessageSenderPeerIdOrName(message),\r\n      peerId,\r\n    });\r\n\r\n    this.setLastMessage({_: 'dialog', peerId} as any, message, ret.dom, query);\r\n\r\n    if(message.peerId !== peerId) {\r\n      ret.dom.listEl.dataset.peerId = '' + message.peerId;\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public addDialogNew(options: {\r\n    peerId: Parameters<AppDialogsManager['addDialog']>[0],\r\n    container?: Parameters<AppDialogsManager['addDialog']>[1],\r\n    rippleEnabled?: boolean,\r\n    onlyFirstName?: boolean,\r\n    meAsSaved?: boolean,\r\n    append?: boolean,\r\n    avatarSize?: number,\r\n    autonomous?: boolean,\r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[],\r\n    fromName?: string\r\n  }) {\r\n    return this.addDialog(options.peerId, options.container, options.rippleEnabled, options.onlyFirstName, options.meAsSaved, options.append, options.avatarSize, options.autonomous, options.lazyLoadQueue, options.loadPromises, options.fromName);\r\n  }\r\n\r\n  public addDialog(\r\n    peerId: PeerId, \r\n    container?: HTMLElement | Scrollable | DocumentFragment | false, \r\n    rippleEnabled = true, \r\n    onlyFirstName = false, \r\n    meAsSaved = true, \r\n    append = true, \r\n    avatarSize = 54, \r\n    autonomous = !!container, \r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[],\r\n    fromName?: string\r\n  ) {\r\n    // const dialog = await this.getDialog(_dialog);\r\n    const avatarEl = new AvatarElement();\r\n    avatarEl.classList.add('dialog-avatar', 'avatar-' + avatarSize);\r\n    avatarEl.updateWithOptions({\r\n      loadPromises,\r\n      lazyLoadQueue,\r\n      isDialog: !!meAsSaved,\r\n      peerId,\r\n      peerTitle: fromName\r\n    });\r\n\r\n    const captionDiv = document.createElement('div');\r\n    captionDiv.classList.add('user-caption');\r\n\r\n    const titleSpanContainer = document.createElement('span');\r\n    titleSpanContainer.classList.add('user-title');\r\n\r\n    const peerTitle = new PeerTitle();\r\n    const peerTitlePromise = peerTitle.update({\r\n      peerId,\r\n      fromName,\r\n      dialog: meAsSaved,\r\n      onlyFirstName,\r\n      plainText: false\r\n    });\r\n\r\n    if(loadPromises) {\r\n      loadPromises.push(peerTitlePromise);\r\n    }\r\n\r\n    titleSpanContainer.append(peerTitle.element);\r\n    //p.classList.add('')\r\n\r\n    // в других случаях иконка верификации не нужна (а первый - это главные чатлисты)\r\n    //if(!container) {\r\n      \r\n      // for muted icon\r\n      titleSpanContainer.classList.add('tgico'); // * эта строка будет актуальна только для !container, но ладно\r\n      \r\n      const titleIconsPromise = generateTitleIcons(peerId).then((elements) => {\r\n        titleSpanContainer.append(...elements);\r\n      });\r\n\r\n      if(loadPromises) {\r\n        loadPromises.push(titleIconsPromise);\r\n      }\r\n    //}\r\n    \r\n    const span = document.createElement('span');\r\n    span.classList.add('user-last-message');\r\n    span.setAttribute('dir', 'auto');\r\n\r\n    //captionDiv.append(titleSpan);\r\n    //captionDiv.append(span);\r\n\r\n    const li = document.createElement(DIALOG_LIST_ELEMENT_TAG);\r\n    li.classList.add('chatlist-chat');\r\n    if(!autonomous) (li as HTMLAnchorElement).href = '#' + peerId;\r\n    if(rippleEnabled) {\r\n      ripple(li);\r\n    }\r\n\r\n    li.append(avatarEl, captionDiv);\r\n    li.dataset.peerId = '' + peerId;\r\n\r\n    const statusSpan = document.createElement('span');\r\n    statusSpan.classList.add('message-status', 'sending-status'/* , 'transition', 'reveal' */);\r\n\r\n    const lastTimeSpan = document.createElement('span');\r\n    lastTimeSpan.classList.add('message-time');\r\n\r\n    const unreadBadge = document.createElement('div');\r\n    unreadBadge.className = 'dialog-subtitle-badge badge badge-24';\r\n\r\n    const titleP = document.createElement('p');\r\n    titleP.classList.add('dialog-title');\r\n\r\n    const rightSpan = document.createElement('span');\r\n    rightSpan.classList.add('dialog-title-details');\r\n    rightSpan.append(statusSpan, lastTimeSpan);\r\n    titleP.append(titleSpanContainer, rightSpan);\r\n\r\n    const subtitleEl = document.createElement('p');\r\n    subtitleEl.classList.add('dialog-subtitle');\r\n    subtitleEl.append(span);\r\n\r\n    captionDiv.append(titleP, subtitleEl);\r\n\r\n    const dom: DialogDom = {\r\n      avatarEl,\r\n      captionDiv,\r\n      titleSpan: peerTitle.element,\r\n      titleSpanContainer,\r\n      statusSpan,\r\n      lastTimeSpan,\r\n      unreadBadge,\r\n      lastMessageSpan: span,\r\n      containerEl: li,\r\n      listEl: li,\r\n      subtitleEl\r\n    };\r\n\r\n    /* let good = false;\r\n    for(const folderId in this.chatLists) {\r\n      if(this.chatLists[folderId] === container) {\r\n        good = true;\r\n      }\r\n    } */\r\n    if(container) {\r\n      const method = append ? 'append' : 'prepend';\r\n      container[method](li);\r\n    }\r\n\r\n    if(!autonomous) {\r\n      // @ts-ignore\r\n      li.dialogDom = dom;\r\n\r\n      if(appImManager.chat?.peerId === peerId) {\r\n        this.setDialogActive(li, true);\r\n      }\r\n    } \r\n    \r\n    return {dom};\r\n  }\r\n\r\n  public async setTyping(dialog: Dialog) {\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) {\r\n      return;\r\n    }\r\n\r\n    const oldTypingElement = dom.lastMessageSpan.querySelector('.peer-typing-container') as HTMLElement;\r\n    const newTypingElement = await appImManager.getPeerTyping(dialog.peerId, oldTypingElement);\r\n    if(!oldTypingElement && newTypingElement) {\r\n      replaceContent(dom.lastMessageSpan, newTypingElement);\r\n      dom.lastMessageSpan.classList.add('user-typing');\r\n    }\r\n  }\r\n\r\n  public unsetTyping(dialog: Dialog) {\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) {\r\n      return;\r\n    }\r\n\r\n    dom.lastMessageSpan.classList.remove('user-typing');\r\n    this.setLastMessageN({\r\n      dialog, \r\n      lastMessage: null, \r\n      dom,\r\n      setUnread: null\r\n    });\r\n  }\r\n}\r\n\r\nconst appDialogsManager = new AppDialogsManager();\r\nMOUNT_CLASS_TO.appDialogsManager = appDialogsManager;\r\nexport default appDialogsManager;\r\n","!function(e,t){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define([],t):\"object\"==typeof exports?exports.Recorder=t():e.Recorder=t()}(\"undefined\"!=typeof self?self:this,(function(){return function(e){var t={};function o(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var n in e)o.d(i,n,function(t){return e[t]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,\"a\",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p=\"\",o(o.s=0)}([function(e,t,o){\"use strict\";(function(t){var o=t.AudioContext||t.webkitAudioContext,i=function(e){if(!i.isRecordingSupported())throw new Error(\"Recording is not supported in this browser\");e||(e={}),this.state=\"inactive\",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:\"encoderWorker.min.js\",encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,reuseWorker:!1,wavBitDepth:16},e),this.encodedSamplePosition=0};i.isRecordingSupported=function(){return o&&t.navigator&&t.navigator.mediaDevices&&t.navigator.mediaDevices.getUserMedia&&t.WebAssembly},i.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach((function(e){e.stop()})):this.stream.stop(),delete this.stream),this.audioContext&&this.closeAudioContext&&(this.audioContext.close(),delete this.audioContext)},i.prototype.encodeBuffers=function(e){if(\"recording\"===this.state){for(var t=[],o=0;o<e.numberOfChannels;o++)t[o]=e.getChannelData(o);this.encoder.postMessage({command:\"encode\",buffers:t})}},i.prototype.initAudioContext=function(e){return e&&e.context?(this.audioContext=e.context,this.closeAudioContext=!1):(this.audioContext=new o,this.closeAudioContext=!0),this.audioContext},i.prototype.initAudioGraph=function(){this.encodeBuffers=function(){delete this.encodeBuffers},this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.connect(this.audioContext.destination),this.scriptProcessorNode.onaudioprocess=e=>{this.encodeBuffers(e.inputBuffer)},this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain),this.recordingGainNode.connect(this.scriptProcessorNode)},i.prototype.initSourceNode=function(e){return e&&e.context?t.Promise.resolve(e):t.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(e=>(this.stream=e,this.audioContext.createMediaStreamSource(e)))},i.prototype.loadWorker=function(){this.encoder||(this.encoder=new t.Worker(this.config.encoderPath))},i.prototype.initWorker=function(){var e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,this.loadWorker(),new Promise((t,o)=>{var i=o=>{switch(o.data.message){case\"ready\":t();break;case\"page\":this.encodedSamplePosition=o.data.samplePosition,e(o.data.page);break;case\"done\":this.encoder.removeEventListener(\"message\",i),this.finish()}};this.encoder.addEventListener(\"message\",i),this.encoder.postMessage(Object.assign({command:\"init\",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))})},i.prototype.pause=function(e){if(\"recording\"===this.state){if(this.state=\"paused\",e&&this.config.streamPages){var t=this.encoder;return new Promise((e,o)=>{var i=o=>{\"flushed\"===o.data.message&&(t.removeEventListener(\"message\",i),this.onpause(),e())};t.addEventListener(\"message\",i),t.postMessage({command:\"flush\"})})}return this.onpause(),Promise.resolve()}},i.prototype.resume=function(){\"paused\"===this.state&&(this.state=\"recording\",this.onresume())},i.prototype.setRecordingGain=function(e){this.config.recordingGain=e,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.setMonitorGain=function(e){this.config.monitorGain=e,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.start=function(e){if(\"inactive\"===this.state)return this.initAudioContext(e),this.initAudioGraph(),this.encodedSamplePosition=0,this.initWorker().then(()=>this.initSourceNode(e)).then(e=>{this.sourceNode=e,this.state=\"recording\",this.onstart(),this.encoder.postMessage({command:\"getHeaderPages\"}),this.sourceNode.connect(this.monitorGainNode),this.sourceNode.connect(this.recordingGainNode)})},i.prototype.stop=function(){if(\"inactive\"!==this.state){this.state=\"inactive\",this.monitorGainNode.disconnect(),this.scriptProcessorNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode.disconnect(),this.clearStream();var e=this.encoder;return new Promise(t=>{var o=i=>{\"done\"===i.data.message&&(e.removeEventListener(\"message\",o),t())};e.addEventListener(\"message\",o),e.postMessage({command:\"done\"}),this.config.reuseWorker||e.postMessage({command:\"close\"})})}return Promise.resolve()},i.prototype.destroyWorker=function(){\"inactive\"===this.state&&this.encoder&&(this.encoder.postMessage({command:\"close\"}),delete this.encoder)},i.prototype.storePage=function(e){this.recordedPages.push(e),this.totalLength+=e.length},i.prototype.streamPage=function(e){this.ondataavailable(e)},i.prototype.finish=function(){if(!this.config.streamPages){var e=new Uint8Array(this.totalLength);this.recordedPages.reduce((function(t,o){return e.set(o,t),t+o.length}),0),this.ondataavailable(e)}this.onstop(),this.config.reuseWorker||delete this.encoder},i.prototype.ondataavailable=function(){},i.prototype.onpause=function(){},i.prototype.onresume=function(){},i.prototype.onstart=function(){},i.prototype.onstop=function(){},e.exports=i}).call(this,o(1))},function(e,t){var o;o=function(){return this}();try{o=o||new Function(\"return this\")()}catch(e){\"object\"==typeof window&&(o=window)}e.exports=o}])}));"],"names":["className","options","button","document","createElement","asDiv","icon","noRipple","rippleSquare","classList","add","onlyMobile","disabled","setAttribute","text","append","CodeInputField","constructor","super","plainText","input","this","type","autocomplete","lastLength","addEventListener","e","remove","setLabel","value","replace","slice","length","setValueSilently","onFill","PasswordMonkey","passwordInputField","size","needFrame","container","load","loadPromise","loop","autoplay","width","height","noCache","then","_animation","animation","currentFrame","direction","setSpeed","pause","onVisibilityClickAdditional","passwordVisible","setDirection","curFrame","play","TrackingMonkey","inputField","max","playAnimation","frame","Math","min","round","idleAnimation","stop","canvas","style","display","Promise","all","PasswordInputField","onVisibilityClick","toggleVisible","toggle","name","stealthy","tabIndex","parentElement","prepend","insertBefore","cloneNode","nextSibling","putPreloader","elem","returnDiv","html","div","innerHTML","appendChild","insertAdjacentHTML","lastElementChild","setButtonLoader","removeAttribute","rippleClickId","ripple","callback","resolve","onEnd","attachListenerTo","querySelector","handler","r","contains","drawRipple","clientX","clientY","startTime","Date","now","clickId","duration","window","getComputedStyle","getPropertyValue","elapsedTime","cb","delay","setTimeout","removeEventListener","touchStartFired","requestAnimationFrame","rect","getBoundingClientRect","clickX","left","clickY","top","sqrt","abs","x","y","isRippleUnneeded","target","includes","tagName","touchEnd","touches","once","cancelBubble","stopPropagation","passive","dataset","badCharsRe","trimRe","C2L","clearBadCharsAndTrim","cleanSearchText","latinize","processSearchText","clearBadChars","ignoreCase","hasTag","includeTag","charAt","originalText","ch","latinizeCh","latinizeString","toLowerCase","fixCyrillic","CLICK_EVENT_NAME","attachClickEvent","listenerSetter","bind","touchMouseDown","detachClickEvent","simulateClickEvent","htmlToSpan","span","sequentialDom","promises","raf","scheduled","do","kind","promise","scheduleFlush","undefined","measure","mutate","mutateElement","element","isConnected","read","write","SearchGroup","clearable","clickable","autonomous","onFound","list","nameEl","clear","setActive","childElementCount","AppSearch","searchInput","searchGroups","onSearch","minMsgId","loadedCount","foundCount","searchPromise","searchTimeout","query","listsContainer","threadId","scrollable","i","messages","setVirtualContainer","onChange","reset","searchMore","onScrolledBottom","trim","peerId","beginSearch","focus","maxId","inputFilter","_","limit","res","count","history","mid","shift","searchGroup","forEach","message","fromId","avatarSize","meAsSaved","err","console","error","replaceContent","catch","InputSearch","placeholder","prevValue","timeout","onInput","clearTimeout","onClearClick","onClear","searchIcon","clearBtn","SliderSuperTab","slider","destroyable","_constructor","header","closeBtn","title","content","addTab","close","closeTab","open","args","init","result","selectTab","onCloseAfterTimeout","tabs","delete","removeAll","setTitle","key","SliderSuperTabEventable","eventListener","dispatchEvent","cleanup","SidebarSlider","historyTabIds","canHideFirst","onCloseBtnClick","appNavigationController","navigationType","id","animate","isNavigation","closingId","pop","onCloseTab","tab","_selectTab","safeAssign","Map","tabsContainer","sidebarEl","Array","from","querySelectorAll","el","get","onOpen","onOpenAfterTimeout","onPop","canAnimate","push","removeTabFromHistory","indexOfAndSplice","sliceTabsUntilTab","tabConstructor","preserveTab","getTab","find","t","isTabExists","onClose","createTab","ctor","doNotAppend","managers","AvatarEdit","getContext","clearRect","months","days","ONE_DAY","getWeekNumber","date","d","UTC","getFullYear","getMonth","getDate","dayNum","getUTCDay","setUTCDate","getUTCDate","yearStart","getUTCFullYear","ceil","getTime","formatDateAccordingToTodayNew","time","today","timestamp","hour","minute","year","day","month","weekday","formatFullSentTimeRaw","timeEl","formatTime","dateEl","capitalize","textTransform","formatFullSentTime","fragment","createDocumentFragment","getFullDate","joiner","monthAsNumber","getHours","getMinutes","noSeconds","getSeconds","leadingZero","noTime","minYear","yearPattern","RegExp","monthYearOrDayPattern","yearOrDayAndMonthPattern","shortDate","longDate","numberOfDaysEachMonth","fillTipDates","dates","q","indexOf","setFullYear","setHours","minDate","maxDate","dayOfWeek","c","setDate","formatWeekLong","getDay","getDayOfWeek","distance","setTime","matches","exec","g1","g2","k","createForDayMonth","createForMonthYear","selectedYear","currentYear","g3","parseInt","validDateForMonth","formatterYearMax","k1","setMonth","formatterMonthYear","formatterDayMonth","getUserStatusString","user","pFlags","bot","support","status","was_online","diff","AppNewGroupTab","uploadAvatar","isGeoChat","avatarEdit","_upload","section","SettingSection","inputWrapper","groupNameInputField","label","maxLength","groupLocationInputField","canBeEdited","valueCheck","userLocationCoords","userLocationAddress","nextBtn","appChatsManager","createChannel","about","geo_point","address","megagroup","chatId","inputFile","editPhoto","peerIds","inviteToChannel","createChat","map","toUserId","toPeerId","chatsSection","nameArgs","new","startLocating","userId","dom","rippleEnabled","lastMessageSpan","appUsersManager","getUser","navigator","geolocation","getCurrentPosition","location","lat","coords","latitude","long","longitude","uri","fetch","response","json","display_name","GeolocationPositionError","VisibilityIntersector","onVisibilityChange","items","locked","observer","IntersectionObserver","entries","changed","entry","isIntersecting","set","visible","smth","getVisible","clearVisible","isVisible","disconnect","refresh","targets","keys","observe","refreshVisible","unobserve","unlock","unlockAndRefresh","lock","findAndSpliceAll","array","verify","out","idx","findIndex","splice","LazyLoadQueueIntersector","parallelLimit","queue","inProcess","Set","intersector","loadItem","item","addElement","method","setProcessQueueTimeout","intersectorTimeout","processQueue","unshift","LazyLoadQueue","wasSeen","getItem","findAndSplice","processItem","hasOwnProperty","choosePhotoSize","photo","boxWidth","boxHeight","useBytes","pushDocumentSize","devicePixelRatio","bestPhotoSize","sizes","thumbs","concat","w","h","photoSize","calcImageInBox","accumulate","arr","initialValue","reduce","acc","Layouter","maxWidth","minWidth","spacing","maxHeight","ratios","countRatios","proportions","countProportions","averageRatio","maxSizeRatio","layout","ComplexLayouter","layoutTwo","layoutThree","layoutFour","layoutTwoTopBottom","layoutTwoLeftRightEqual","layoutTwoLeftRight","layoutThreeLeftAndOther","layoutThreeTopAndOther","layoutFourTopAndOther","layoutFourLeftAndOther","geometry","sides","RectPart","minimalWidth","secondWidth","firstWidth","firstHeight","thirdHeight","secondHeight","rightWidth","leftWidth","thirdWidth","h0","w0","w2","w1","h1","h2","static","ratio","join","cropRatios","clamp","attempts","multiHeight","offset","sum","pushAttempt","lineCounts","heights","first","second","third","fourth","optimalAttempt","optimalDiff","attempt","counts","lineCount","totalHeight","minLineHeight","bad1","bad2","line","optimalCounts","optimalHeights","rowCount","index","row","colCount","lineHeight","col","prepareAlbum","widthItem","heightItem","children","borderTopLeftRadius","borderBottomLeftRadius","borderTopRightRadius","borderBottomRightRadius","forMedia","mediaDiv","loadedURLs","url","HTMLImageElement","HTMLVideoElement","src","SVGImageElement","setAttributeNS","backgroundImage","renderImageFromUrl","useCache","isImage","loader","Image","renderImageFromUrlPromise","renderImageWithFadeIn","image","needFadeIn","aspecter","thumbImage","ProgressivePreloader","tempId","detached","isUpload","cancelable","streamable","tryAgainOnFail","attachMethod","onClick","cancelEvent","preloader","loadFunc","cancel","constructContainer","color","bold","constructDownloadIcon","construct","totalLength","downloadSvg","cancelSvg","previousElementSibling","circle","firstElementChild","setDownloadFunction","func","setManual","setProgress","attachPromise","notify","notifyAll","detach","attach","addNotifyListener","details","percents","done","total","useRafs","isInDOM","getTotalLength","strokeDasharray","heavyQueue","processingQueue","addHeavyTask","processHeavyQueue","todo","results","reject","f","start","performance","possiblePromise","process","apply","context","realResult","timedChunk","finally","requireBlurPromise","fastBlurFunc","processBlurNext","img","radius","iterations","ctx","alpha","filter","drawImage","m","default","cache","dataUri","cached","onload","JPEG_HEADER","bytesFromHex","JPEG_TAIL","getPreviewURLFromBytes","bytes","isSticker","mimeType","Uint8Array","IS_SAFARI","btoa","String","fromCharCode","bytesToDataURL","getPreviewURLFromThumb","thumb","getImageFromStrippedThumb","useBlur","getStrippedThumbIfNeeded","cacheContext","ignoreCache","downloaded","setAttachmentSize","noZoom","isDocument","boxSize","aspect","isFit","aspectCovered","reply_to_mid","media","webpage","replies","comments","channel_id","toChatId","wrapPhoto","withTail","isOut","lazyLoadQueue","middleware","withoutPreloader","loadPromises","autoDownloadSize","noBlur","noThumb","noFadeIn","blurAfter","full","images","noAutoDownload","mediaSizes","loadThumbPromise","isGif","mime_type","thumbsStorage","getCacheContext","gotThumb","uploadingFileName","appDownloadManager","renderOnLoad","onLoad","toDataURL","canAttachPreloader","haveToDownload","queueId","onlyCache","getDownloadPromise","renderPromise","download","render","createVideo","video","pip","disablePictureInPicture","throttleWithRaf","fn","schedulerFn","waiting","_args","throttleWith","toHHMMSS","str","leadZero","sec_num","hours","floor","minutes","seconds","getTextWidth","font","measureText","testQueue","fontFamily","pendingTest","setTestQueue","testElement","getElementWidth","sizeType","mapped","firstTime","textLength","multiplier","textWidth","elementWidth","textContent","fontWeight","newElementWidth","widthChanged","smallerText","smallerWidth","smallerTextLength","half","half1","substr","half2","capture","MiddleEllipsisElement","HTMLElement","connectedCallback","disconnectedCallback","formatBytes","decimals","dm","log","parseFloat","pow","toFixed","attachGrabListeners","onStart","onMove","onMouseMove","event","pageX","pageY","onMouseUp","onMouseDown","onTouchMove","preventDefault","isTouch","onTouchEnd","onTouchStart","customElements","define","RangeSelector","mousedown","events","withTransition","useTransform","vertical","scrub","seek","setFilled","onScrub","filled","step","stepStr","setHandlers","setListeners","_removeListeners","addProgress","transform","rectMax","offsetAxisValue","bottom","removeListeners","MediaProgressLine","progressRAF","onLoadedData","onEnded","onPlay","paused","cancelAnimationFrame","setLoadProgress","onTimeUpdate","onProgress","setMedia","filledLoad","currentTime","wasPlaying","setSeekMax","scrubTime","appMediaPlaybackController","buf","buffered","numRanges","nearestStart","end","getMessageSenderPeerIdOrName","fromName","fwd_from","from_name","weakMap","WeakMap","peerTitle","update","PeerTitle","onlyFirstName","dialog","setOptions","limitSymbols","setInnerHTML","wrapEmojiText","getPeerTitle","wrapSenderToPeer","senderTitle","fromMe","wrapSentTime","constructDownloadPreloader","mids","attr","findMediaTargets","anchor","anchorMid","prev","next","isBubbles","findUpClassName","justAudioSelector","selectors","prefix","s","selector","elements","mediaItems","reverse","AudioElement","withTime","voiceAsMusic","showSender","doc","getMediaFromMessage","isRealVoice","isVoice","isOutgoing","is_outgoing","durationStr","downloadDiv","media_unread","onTypeLoad","audioEl","waveform","attributes","attribute","valueCount","dataView","DataView","buffer","byteIndex","bitShift","getUint16","decodeWaveform","svg","svgContainer","availW","barHeightMax","minW","maxW","createElementNS","normValue","wfSize","barCount","maxValue","maxDelta","barX","sumI","bar_value","barWidth","createWaveformBars","fakeSvgContainer","waveformContainer","timeDiv","progress","audio","throttledTimeUpdate","addAudioListener","readyPromise","mousemove","offsetX","MouseEvent","targetTouches","noop","wrapVoiceMessage","descriptionEl","audioAttribute","parts","performer","titleEl","middleEllipsisEl","file_name","subtitleDiv","launched","progressLine","supportsStreaming","lastChild","replaceWith","wrapAudio","audioTimeDiv","autoload","readyState","HAVE_CURRENT_DATA","onTypeDisconnect","getTimeStr","innerText","togglePlay","hadSearchContext","searchContext","useSearch","imgs","wrapped","autoDownload","shouldPlay","is_scheduled","onDownloadInit","pauseListener","deferred","Error","playListener","roundVideoCircumference","wrapVideo","noInfo","group","onlyPreview","noPlayButton","isAlbumItem","canAutoplay","spanTime","spanPlay","needPlayButton","photoRes","muted","divRound","halfSize","strokeWidth","PI","strokeDashoffset","globalVideo","onPaused","onFrame","foreignObject","getAttributeNS","uploadFileName","renderDeferred","code","isFulfilled","onMediaLoad","animationIntersector","videoWidth","loadPhotoThumbFunc","apiFileManager","downloadMediaURL","wrapAlbum","attachmentDiv","uploading","chat","thumbPromise","to","wrapDocument","audioElement","extSplitted","split","ext","isArray","docDiv","docId","icoDiv","hadContext","fileName","wrapPlainText","descriptionParts","nameDiv","_downloadDiv","save","isTrusted","appDocsManager","getDoc","canOpenAfter","downloadFileName","getDownloadMediaDetails","isDownloading","uploadPromise","savingLottiePreview","saveLottiePreview","toneIndex","saving","toBlob","blob","wrapStickerAnimation","side","skipRatio","animationDiv","stickerPromise","withThumb","assumeType","frameNo","maxFrame","onScroll","vibrate","generateRandomSigned","random","randomOffsetX","randomOffsetY","stableOffsetX","setPosition","right","onlyThumb","emoji","needUpscale","asStatic","stickerType","sticker","lottieLoader","isAnimated","isThumbNeededForType","lottieCachedThumb","getLottieCachedThumb","haveThumbCached","afterRender","path","num","getPathFromBytes","stickerThumbConverted","webpWorkerController","saveWebPConvertedStrippedThumb","animationData","data","a","v","sendInteractionThrottled","appStickersManager","preloadAnimatedEmojiStickerAnimation","getAnimatedEmojiSoundDocument","restart","isUser","getAnimatedEmojiSticker","bubble","throttle","appMessagesManager","setTyping","msg_id","getServerMessageId","emoticon","interaction","JSON","stringify","isSavingLottiePreview","EditPeer","_disabled","isChanged","changedLength","requiredLength","requiredValidLength","inputFields","isValid","required","handleChange","toggleAttribute","withoutAvatar","avatarElem","updateWithOptions","doNotEditAvatar","lockWithPromise","unlockOnSuccess","RadioForm","radios","form","checked","Row","freezed","radioField","checkboxField","subtitle","subtitleLangKey","subtitleLangArgs","havePadding","isToggle","titleRight","noCheckboxSubtitle","titleLangKey","titleRightSecondary","titleRightEl","navigationTab","createMedia","RadioFormFromRows","rows","copyTextToClipboard","clipboard","writeText","textArea","position","body","select","execCommand","removeChild","fallbackCopyTextToClipboard","RadioField","alignRight","stateKey","state","getDeepProperty","main","langKey","Event","bubbles","toastEl","toast","toastNew","langPackKey","langPackArguments","isUsernameValid","username","test","UsernameInputField","checkUsernameDebounced","debounce","checkUsername","getValue","originalValue","setState","I","setError","invalidText","head","checkUsernamePromise","available","availableText","takenText","isValidToChange","PopupPeer","buttons","overlayClosable","avatarEl","AvatarElement","isDialog","noTitle","titleLangArgs","descriptionLangKey","description","p","descriptionLangArgs","checkboxes","o","withRipple","original","nextElementSibling","AppChatTypeTab","isBroadcast","privateRow","publicRow","privateSection","publicSection","getChat","linkRow","chatFull","exported_invite","link","btnRevoke","toggleDisability","appProfileManager","getChatInviteLink","show","caption","noDelimiter","linkInputField","applyBtn","migrateChat","channelId","updateUsername","setOriginalValue","toggleNoForwards","onChatUpdate","noforwards","ScrollableLoader","loading","loaded","getPromise","checkForTriggers","windowSize","visualViewport","innerWidth","innerHeight","filterAsync","Boolean","numberThousandSplitter","toString","getChatMembersString","getCachedFullChat","participants_count","participants","broadcast","AppSelectPeers","chatsContainer","selected","folderId","offsetIndex","loadedWhat","renderedPeerIds","peerType","multiSelect","exceptSelf","tempIds","selfPresence","needSwitchList","cachedContacts","getMoreResults","renderResultsFunc","renderResults","splitUp","notRendered","has","filterPeerTypeBy","isPeerId","appPeersManager","getPeer","deleted","innerContainer","topContainer","selectedContainer","selectedScrollable","li","click","sectionNameLangPackKey","noShadow","findUpAttribute","checkbox","debouncedInput","generateDelimiter","appendTo","getResultsPromise","onFirstRender","renderSaved","testSelfSearch","getTempId","getMoreDialogs","dialogs","archived","pageCount","getConversations","newOffsetIndex","getDialogIndex","chatRightsAction","filterByRights","isEnd","contacts","getMoreContacts","peer","canSendToUser","hasRights","isGlobalSearch","getContactsPeerIds","searchContacts","searchResult","resultPeerIds","my_results","filterUnique","getMoreChannelParticipants","channelParticipants","getChannelParticipants","participant","getParticipantPeerId","isNonContactUser","containerEl","subtitleEl","isAnyChat","scroll","insertAdjacentElement","scrollIntoViewNew","offsetWidth","onAnimationEnd","getSelected","addInitial","values","forceDirection","PopupPickUser","closable","onSelect","hide","peerTypes","AppUserPermissionsTab","destroyListener","ChatPermissions","rights","takeOut","deepEqual","banned_rights","editBanned","btnDeleteException","clearChannelParticipantBannedRights","btnDelete","kickFromChannel","flags","exceptionText","toggleWith","defaultBannedRights","default_banned_rights","copy","defaultRights","combineParticipantBannedRights","restrictionText","info","mainFlag","restriction","until_date","flag","AppGroupPermissionsTab","chatPermissions","editChatDefaultBannedRights","addExceptionRow","openPermissions","getChannelParticipant","generateContentElement","findUpTag","DIALOG_LIST_ELEMENT_TAG","setSubtitle","bannedRights","cantWhat","getPeerId","listEl","setLength","exceptionsCount","setLoader","isChannel","migrateFrom","migrateTo","PopupDeleteDialog","peerTitleElement","getDialogType","callbackLeave","flush","leave","flushHistory","callbackDelete","descriptionArgs","isDanger","textArgs","AppChatReactionsTab","availableReactions","appReactionsManager","getActiveAvailableReactions","getChatFull","originalReactions","available_reactions","enabledReactions","toggleSection","toggleCheckboxField","toggleRow","reactionsSection","checkboxFields","availableReaction","reaction","saveReactionsDebounced","wrapStickerToRow","static_icon","every","saveReactions","newReactions","sort","setChatAvailableReactions","AppEditChatTab","_init","chatUpdateListeners","addChatUpdateListener","canChangeType","canChangePermissions","chatNameInputField","descriptionInputField","editPeer","chatTypeRow","setChatTypeSubtitle","reactionsRow","setReactionsLength","availableReactionsLength","getAvailableReactions","inactive","reactions","permissionsRow","setPermissionsLength","getChatTyped","editTitle","editAbout","race","signMessagesCheckboxField","signatures","toggleSignatures","showChatHistoryCheckboxField","togglePreHistoryHidden","hidden_prehistory","formatUserPhone","phone","formatPhoneNumber","formatted","AppEditContactTab","isNew","isContact","nameInputField","lastNameInputField","setDraftValue","first_name","last_name","notificationsCheckboxField","togglePeerMute","enabled","appNotificationsManager","isMuted","notify_settings","profileNameDiv","profileSubtitleDiv","phoneRow","notificationsRow","isPeerLocalMuted","addContact","deleteContacts","AppAddMembersTab","sel","skippable","attachToPromise","removeLoader","ret","isPrivacy","selectedPeerIds","generateFakeIcon","isScam","generateTitleIcons","verified","use","use2","generateVerifiedIcon","fake","scam","DialogColorsFg","DialogColors","DialogColorsMap","getPeerColorById","pic","getAbbreviation","onlyFirst","splitted","last","putAvatar","renderThumbPromise","isFullLoaded","stripped_thumb","putPhoto","isBig","myId","getPeerPhoto","avatarAvailable","avatarRendered","appAvatarsManager","isAvatarCached","abbr","getPeerInitials","ContextMenuController","openedMenu","diffX","diffY","closeBtnMenu","menuOverlay","openedMenuOnClose","IS_MOBILE_SAFARI","isOpened","openBtnMenu","menuElement","getEvent","attachGlobalListenerTo","RESET_GLOBAL","SwipeHandler","cursor","listenerOptions","hadMove","xDown","yDown","handleMove","setCursorTo","onReset","handleStart","_e","verifyTouchTarget","xUp","yUp","xDiff","yDiff","setProperty","onFirstSwipe","onSwipeResult","onSwipe","setCursor","PeerProfileAvatars","photoId","avatar","BASE_CLASS","avatars","appPhotosManager","getPhoto","action","draggable","loadCallback","intersectionObserver","loadCallbacks","gradient","arrowPrevious","arrowNext","checkScrollTop","scrollTop","SWITCH_ZONE","freeze","listLoader","previous","current","prevTargets","nextTargets","openAvatarViewer","toRight","offsetLeft","go","cancelNextClick","lastDiffX","minX","swipeHandler","lastX","SCALE","TRANSLATE_TEMPLATE","addIndex","loadNearestToTarget","setPeer","loadCount","loadMore","older","getUserPhotos","photos","getSearch","Number","MAX_SAFE_INTEGER","backLimit","filterChatPhotosMessages","chat_photo","generateFakeAvatarMessage","onJump","activeTab","photo_id","wrapPeerTitle","setText","PeerProfile","setPeerStatus","needClear","bio","getProfileByPeerId","notifications","setMoreDetails","fillUsername","self","fillUserPhone","setAvatar","setPeerStatusInterval","setInterval","cleanupHTML","clearSetMoreDetailsTimeout","canBeDetailed","oldAvatars","getPeerUsername","fillNotifications","fillRows","icons","fillProfileElements","cleaned","_setMoreDetails","peerFull","wrapRichText","exportedInvite","setMoreDetailsTimeout","override","isRestricted","acknowledged","setPromise","destroy","clearInterval","historiesStorage","AppSharedMediaTab","newCloseBtn","animatedCloseIcon","transitionContainer","transitionFirstItem","editBtn","transitionLastItem","secondTitle","profile","onAdditionalScroll","searchSuper","nav","setIsSharedMedia","isSharedMedia","transition","cleanScrollPositions","isHeavyAnimationInProgress","toggleEditBtn","renderNewMessages","msgs","deleteDeletedMessages","AppSearchSuper","mediaTabs","onChangeTab","mediaTab","btnAddMembers","scrollStartCallback","showConfirmation","b","onError","addChatUser","filtered","filterMessagesByType","usedFromHistory","performSearchResult","selection","isSelecting","toggleByElement","canViewMembers","setLoadMutex","loadMutex","peerChanged","setQuery","historyStorage","loadSidebarMedia","single","justLoad","RIGHT_COLUMN_ACTIVE_CLASSNAME","appSidebarRight","getElementById","isColumnProportionSet","toggleSidebar","setColumnProportion","createSharedMediaTab","replaceSharedMediaTab","previousTab","sharedMediaTab","proportion","scrollWidth","documentElement","enable","active","willChange","animationPromise","AppPollResultsTab","resultsDiv","poll","appPollsManager","getPoll","quiz","question","voters","total_voters","roundPercents","hr","answer","answers","answerEl","answerTitle","answerPercents","minHeight","getVotes","option","votesList","votes","vote","user_id","showMore","next_offset","down","CLASS_NAME","StackedAvatars","avatarContainer","AVATAR_CLASS_NAME","updateOptions","parentNode","lineTotalLength","minIndex","minRemainder","remainder","maxRemainder","pollElement","isClosed","closed","performResults","chosenIndexes","PollElement","setMaxLength","resizePolls","hideQuizHint","onHide","prevQuizHint","prevQuizHintOnHide","prevQuizHintTimeout","isListenerSet","isQuiz","isRetracted","isPublic","isMultiple","chosingIndexes","sentVote","MAX_LENGTH","MAX_OFFSET","svgLines","setLineProgress","descKey","public_voters","multiple_choice","multipleSelect","descDiv","typeDiv","avatarsDiv","close_period","close_date","timeLeftDiv","quizTimer","circumference","period","closeTime","quizInterval","timeLeft","stroke","getResults","answerDivs","numberDivs","footerDiv","viewResults","votersCountDiv","sendVoteBtn","sendVotes","canVote","setVotersCount","clickHandler","initQuizHint","solution","solution_entities","toggleHint","textEl","entities","setQuizHint","correctResult","correct","chosen","answerIndex","foundIndex","indexes","sendVotePromise","sendVote","setResults","recent_voters","stackedAvatars","isVoted","hideSendVoteBtn","hideViewResultsBtn","maxPercents","getPercentValue","iterate","fullTime","times","votersCount","DivAndCaption","fill","border","htmlToDocumentFragment","DocumentFragment","template","platforms","ignore","getRestrictionReason","reasons","reason","platform","escapeRegExp","isMessageRestricted","restriction_reason","CALL_DURATION_LANG_KEYS","formatCallDuration","plain","showLast","modulus","formatDuration","strings","wrapJoinVoiceChatAnchor","onclick","wrapUrl","call","access_hash","href","wrapMessageActionTextNew","unsafeMessage","noLinebreaks","getNameDivHTML","endsWith","post","users","schedule_date","daysToStart","tomorrowDate","pinnedMessage","getMessageByPeer","savedFrom","dir","wrapMessageForReply","fetchMessageReplyTo","originalMessage","storageKey","isMessageIsTopMessage","getDialogOnly","joined","anchorHTML","domain","langPack","waited","wrapMessageActionTextNewUnsafe","usingMids","highlightWord","withoutMediaType","hasAlbumKey","addPart","part","totalEntities","usingFullAlbum","grouped_id","getMidsByMessage","albumText","getAlbumText","game","stickerEmojiRaw","actionWrapped","match","found","regExp","sortEntities","messageWrapped","noLinks","noTextFormat","MEDIA_SIZE","wrapReplyDivAndCaption","mediaEl","isRound","mediaChildren","CHAT_ANIMATION_GROUP","child","ReplyContainer","isMediaSet","wrapReply","setColorPeerId","replyContainer","fillPromise","hex","g","wrapStickerSetThumb","downloadOptions","getStickerSetThumbDownloadOptions","animated","videos","URL","createObjectURL","getStickerSet","stickerSet","documents","previousMedia","_size","positionElementByIndex","pos","prevPos","whichChild","SortedList","updateElementWith","updateListWith","sorted","clean","_updateList","onSort","updateList","canUpdate","getAll","batch","updateBatch","base","onElementCreate","noScheduler","onDelete","getIndex","onUpdate","insertInDescendSortedArray","SortedUserList","getUserStatusForSort","onListLengthChange","willChangeLength","createChatListOptions","doTimeout","good","SORT_INTERVAL","_cancelContextMenuOpening","_cancelContextMenuOpeningTimeout","cancelContextMenuOpening","attachContextMenuListener","removeManual","IS_APPLE","onCancel","handleHorizontalSwipe","cancelY","isSwipingBackSafari","handleTabSwipe","ButtonMenuItem","noCheckboxClickListener","textElement","regularText","keepOpen","menu","PopupForward","peerIdMids","overrideOnSelect","PopupDeleteMessages","onConfirm","revoke","deleteScheduledMessages","deleteMessages","titleArgs","isMegagroup","_hasRights","canRevoke","PopupSendNow","sendScheduledMessages","cancelSelection","getSelection","empty","removeAllRanges","accumulateMapSet","AppSelection","selectedMids","targetLookupClassName","verifyTarget","seen","selecting","firstTarget","processElement","checkBetween","seenSet","isSelected","isMidSelected","seenLength","findUpAsChild","elementsBetween","getElementsBetween","toggleByMid","canceledSelection","getElementFromTarget","verifyMouseMoveTarget","listenElement","documentListenerOptions","firstRect","lastRect","isHigher","parent","lookupBetweenParentClassName","lookupBetweenElementsQuery","firstIndex","lastIndex","doNotAnimate","onCancelSelection","toggleSelection","attachListeners","selectedText","createRange","verifyTouchLongPress","isElementShouldBeSelected","appendCheckbox","toggleElementCheckbox","hasCheckbox","getCheckboxInputFromElement","updateContainer","forceSelection","cantForward","cantDelete","cantSend","isScheduled","cantForwardDeleteMids","onUpdateContainer","toggleCheckboxes","wasSelecting","blurActiveElement","forwards","onToggleSelection","updateElementSelection","toggleMid","unselect","deleteSelectedMids","SearchSelection","contentTab","selectionCountEl","selectionGotoBtn","selectionForwardBtn","selectionDeleteBtn","navScrollableContainer","selectionContainer","btnCancel","attachClickOptions","lastMsgId","obj","fromPeerId","isPrivate","transitionElement","opacity","ChatSelection","recording","canSelectBubble","isGroupedBubbleSelected","getMidsFromGroupContainer","getBubbleGroupedItems","groupContainer","isGroupedSelected","isGroupedMidsSelected","mounted","getMountedBubble","needTranslateX","widthFrom","widthTo","center","selectionInputWrapper","selectionSendNowBtn","selectionLeft","selectionRight","translateButtonsX","inputContainer","skippedMids","isGrouped","groupedCheckboxInput","wrapWebPageDescription","webPage","shortDescriptionText","wrapWebPageTitle","shortTitle","author","site_name","positionMenu","additionalPadding","getScrollWidthFromElement","menuWidth","scrollHeight","menuHeight","windowWidth","windowHeight","paddingTop","paddingRight","paddingBottom","paddingLeft","verticalSide","maxTop","maxLeft","minLeft","intermediateX","intermediateY","possibleSides","SearchContextMenu","attachTo","onGotoClick","onForwardClick","onSelectClick","onClearSelectionClick","onDeleteClick","withSelection","canForward","canDeleteMessage","prevTabId","urlsToRevoke","nextRates","loadedChats","firstLoad","logger","monthContainers","mediaTabsMap","asChatList","groupByMonth","hideEmptyTabs","onTransitionStart","onTransitionEnd","searchContextMenu","navScrollable","tabsMenu","menuTab","unlockScroll","prevId","lockers","lockTouchScroll","searchGroupMedia","canLoadMediaTab","horizontalMenu","tabContent","skipScroll","startCallback","newMediaTab","fromMediaTab","offsetTop","rect2","onMediaClick","targetClassName","warn","AppMediaViewer","setSearchContext","copySearchContext","openMedia","inputMessagesFilterPhotoVideo","inputMessagesFilterDocument","useHeavyAnimationCheck","filterMessagesByInputFilter","processEmptyFilter","setLastMessagePromise","lastMessage","processPhotoVideoFilter","processDocumentFilter","processUrlFilter","entity","display_url","sliced","matchUrl","same","hostname","hash","previewDiv","subtitleFragment","HTMLAnchorElement","decodeURIComponent","firstChild","elemsToAppend","sharedMediaDiv","processCallback","awaited","monthContainer","getMonthContainerByTimestamp","afterPerforming","loadChats","inputMessagesFilterEmpty","showMembersCount","titleSpan","arg","globalContacts","intlElement","isShort","renderRecentSearch","recent","recentSearch","getTopPeers","peers","people","loadMembers","renderParticipants","membersList","LOAD_COUNT","loadType","used","slicedLength","ids","notFilteredMessages","nextRate","next_rate","loadFirstTime","filters","counters","getSearchCounters","firstMediaTab","counter","membersTab","loadFirstTimePromise","toLoad","dateTimestamp","containers","dateElement","haveTimestamps","getObjectKeysAndSort","goFirst","revokeObjectURL","newInputFilter","ButtonMenuToggleHandler","btnMenu","getPrivacyRulesDetails","rules","types","allowPeers","chats","disallowPeers","rule","PrivacyType","PrivacySection","onRadioChange","captions","captionElement","radioSection","exceptions","radioRows","skipTypes","noExceptions","generateSection","exceptionTexts","exception","_peerIds","newPeerIds","generateStr","splitPeersByType","appPrivacyManager","getPrivacy","inputKey","setRadio","chatKey","usersKey","getUserInput","setPrivacy","AppPrivacyPhoneNumberTab","getSelf","captionEl","mePath","anchorCopy","phoneSection","sCaption","wrapStickerEmoji","AppTwoStepVerificationSetTab","stickerContainer","inputContent","btnReturn","AppSettingsTab","canFocus","isFirstInput","AppTwoStepVerificationEmailConfirmationTab","isFirst","email","codeInputField","passwordManager","confirmPasswordEmail","goNext","btnChange","btnResend","disable","cancelPasswordEmail","AppTwoStepVerificationEmailTab","resendPasswordEmail","onContinueClick","btnContinue","btnSkip","E","toggleButtons","updateSettings","hint","currentPassword","plainPassword","newPassword","symbols","isCancel","AppTwoStepVerificationHintTab","onSkipClick","saveHint","AppTwoStepVerificationReEnterPasswordTab","monkey","verifyInput","AppTwoStepVerificationEnterPasswordTab","has_password","labelText","getStateInterval","getState","_state","check","auth","AppTwoStepVerificationTab","btnChangePassword","btnDisablePassword","btnSetRecoveryEmail","has_recovery","btnSetPassword","AppPrivacyLastSeenTab","AppPrivacyProfilePhotoTab","AppPrivacyForwardMessagesTab","AppPrivacyAddToGroupsTab","AppPrivacyCallsTab","AppActiveSessionsTab","Session","app_name","app_version","ip","country","date_active","date_created","midtitle","device_model","system_version","authorizations","session","btnTerminate","apiManager","invokeApi","otherSection","onTerminateClick","AppBlockedUsersTab","btnAdd","toggleBlock","blocked","getBlocked","convertKeyToInputKey","toUpperCase","AppPrivacyAndSecurityTab","SUBTITLE","blockedPeerIds","blockedUsersRow","passwordState","twoFactorRow","email_unconfirmed_pattern","activeSessionsRow","updateActiveSessions","setBlockedCount","updateBlocked","rowsByKeys","numberVisibilityRow","lastSeenTimeRow","photoVisibilityRow","callRow","linkAccountRow","groupChatsAddRow","updatePrivacyRow","disallowLength","allowLength","settings","sensitive_can_change","sensitive_enabled","sensitiveRow","_enabled","deleteButton","appDraftsManager","clearAllDrafts","auths","averageColorFromCanvas","pixel","pixels","getImageData","pixelsLength","outPixel","Uint8ClampedArray","highlightningColor","rgba","l","ChatBackgroundGradientRenderer","_width","_height","_tails","_scrollTails","_curve","_positions","_phases","onWheel","_animatingToNextPosition","_scrollDelta","deltaY","_onWheelRAF","drawOnWheel","changeTail","curPos","curPosition","_phase","_tail","drawGradient","drawNextPositionAnimated","frames","_frames","drawImageData","leftLength","_incrementalCurve","hexToRgb","getPositions","positions","getNextPositions","phase","curveMax","curve","distances","nextPos","tail","getGradientImageData","_hctx","createImageData","centerDistanceY","centerDistanceY2","centerDistanceX","swirlFactor","theta","sinTheta","sin","cosTheta","cos","pixelX","pixelY","distanceSum","_colors","distanceX","distanceY","putImageData","_ctx","_hc","colors","getAttribute","_canvas","fillStyle","fillRect","toNextPosition","tails","nextPhaseOnIdx","inc","curves","scrollAnimate","_addedScrollListener","createCanvas","gradientRenderer","ColorPicker","hue","saturation","lightness","onGrabStart","boxDragger","onGrabEnd","box","sliders","hueDragger","hexInputField","rgbInputField","inputs","valid","setColor","rgbRegExp","attachBoxListeners","attachHueListeners","boxRect","saturationHandler","hueRect","hueHandler","updateHexInput","updateRgbInput","rgb","boxX","percentY","boxY","percentHue","hueX","updatePicker","getCurrentColor","rgbaArray","hexa","hsl","hsla","maxX","maxY","posX","posY","lightnessX","lightnessY","AppBackgroundColorTab","_applyColor","updateColorPicker","colorPicker","background","theme","intensity","slug","appStateManager","pushToState","onColorChange","applyColor","themeController","gridSection","grid","backgroundColor","isColored","scaleMediaElement","mediaSize","aspectFitted","quality","AppBackgroundTab","clicked","wallPapersByElement","elementsByKey","onUploadClick","accept","file","files","requestFile","naturalWidth","naturalHeight","File","wallPaper","prepareWallPaperUpload","uploadWallPaper","uploadDeferred","newKey","getWallPaperKey","setBackgroundDocument","addWallPaper","onResetClick","defaultTheme","blurCheckboxField","blur","onGridClick","wallpaper","saveToCache","_tempId","onReady","getPixelPromise","imageUrl","averageColor","create","getColorsFromWallPaper","getWallPaperKeyFromTheme","uploadButton","colorButton","resetButton","pattern","getWallPapers","wallPapers","gridContainer","background_color","second_background_color","third_background_color","fourth_background_color","hasFile","isDark","dark","webkitMaskImage","ANIMATION_GROUP","PopupStickers","stickerSetInput","onStickersClick","fileId","h6","stickersDiv","stickersFooter","btn","loadStickerSet","installed_date","toggleStickerSet","AppQuickReactionTab","getQuickReaction","quickReaction","setDefaultReaction","RangeSettingSelector","minValue","writeValue","valueDiv","valueContainer","range","AppGeneralSettingsTab","chatBackgroundButton","animationsCheckboxField","enterRow","ctrlEnterRow","kilometersRow","milesRow","formats","format","runFirst","getNextTimeout","_callback","run","eachTimeout","eachMinute","toLocaleTimeString","suggestCheckboxField","bigCheckboxField","renderQuickReaction","loopCheckboxField","stickerSets","stickersContent","renderStickerSet","getAllStickers","allStickers","sets","AppEditProfileTab","appConfig","getAppConfig","firstNameInputField","bioInputField","about_length_limit_premium","about_length_limit_default","usernameInputField","setProfileUrl","profileUrlContainer","profileUrlAnchor","updateProfile","uploadProfilePhoto","userFull","getProfile","AppIncludedChatsTab","getContacts","foundInFilters","dialogsByFilters","onSelectChange","confirmBtn","cmp","forEachReverse","pinnedPeerIds","pinned_peers","other","otherLegacy","getInputPeerById","editFolderTab","setFilter","filtersStorage","getDialogFilters","dialogsStorage","getFolderDialogs","categoriesSection","exclude_muted","ico","exclude_archived","exclude_read","non_contacts","groups","broadcasts","bots","selectedPeers","includePeerIds","excludePeerIds","addedInitial","_add","originalFilter","AppEditFolderTab","deleteFolderButton","updateDialogFilter","bool","menuBtn","inputSection","generateList","h2Text","categories","includedFlagsContainer","excludedFlagsContainer","include","include_peers","createDialogFilter","editCheckForChange","reloadMissingPromises","reloadMissingPeerIds","loadAnimationPromise","player","onCreateOpen","onEditOpen","documentFragmentToHTML","wrapDraftText","ul","ignoreClick","hasPeer","renderMore","_length","exclude_peers","AppChatFoldersTab","filtersRendered","renderFolder","dialogFilter","Object","folder","channels","isAnyGroup","filterId","getFilter","orderIndex","createFolderBtn","foldersSection","suggestedSection","dialog_filters_limit_premium","dialog_filters_limit_default","onFiltersContainerUpdate","getSuggestedFilters","order","getSuggestedDialogsFilters","suggestedFilters","AppNotificationsTab","NotifySection","enabledRow","typeText","previewEnabledRow","inputNotifyPeer","getNotifySettings","notifySettings","applySettings","show_previews","mute","showPreviews","inputSettings","mute_until","updateNotifySettings","contactsSignUpRow","soundRow","sound","getContactSignUpNotification","setContactSignUpNotification","AppLanguageTab","invokeApiCacheable","lang_pack","languages","language","lang_code","native_name","confirmationPopup","cancelButton","autoDownloadPeerTypeSection","contactsCheckboxField","privateCheckboxField","groupsCheckboxField","channelsCheckboxField","AppAutoDownloadPhotoTab","AppAutoDownloadFileTab","debouncedSave","sizeMax","setByKey","MIN","MAX_RANGE","MAX","upTo","compareAndUpdate","AppAutoDownloadVideoTab","AUTO_DOWNLOAD_FOR_KEYS","private","AppDataAndStorageTab","autoCheckboxField","autoDownloadNew","setSubtitles","setAutoDownloadSubtitle","photoRow","videoRow","fileRow","file_size_max","openTab","onDisabledChange","gifsCheckboxField","videosCheckboxField","peerKeys","enabledKeys","isAll","logOut","edit","changeAvatarBtn","upload","updateChangeAvatarBtn","buttonsDiv","devicesRow","languageRow","buttonsSection","getAuthorizations","overwrite","getAuthorizationsPromise","AppNewChannelTab","channelNameInputField","channelDescriptionInputField","onLengthChange","PopupCreateContact","withConfirm","btnConfirm","importContact","telInputField","validate","country_code","AppContactsTab","inputSearch","openContacts","sortedUserList","createList","IS_MOBILE","renderPage","AppArchivedTab","wasFilterId","chatList","AppPeopleNearbyTab","isLocationWatched","parseDistance","retryBtn","latestLocationSaved","accuracy","getLocated","updates","orderedPeers","groupsCounter","usersCounter","peopleSection","locatedPeers","sortedList","errorCategory","startWatching","watchPosition","isLongitudeDifferent","isLatitudeDifferent","distanceCheck","calculateDistance","stopWatching","lat1","long1","lat2","long2","asin","formatNumber","LEFT_COLUMN_ACTIVE_CLASSNAME","fakeGradientDelimiter","delimiter","appSidebarLeft","sidebarHeader","onContactsClick","backBtn","btnArchive","isDialogsLoaded","themeCheckboxField","filteredButtons","sessionStorage","kz_version","toolsBtn","btnMenuFooter","rel","newBtnMenu","updateBtn","reload","initSearch","archivedCount","unreadPeerIds","navigationItem","noHistory","checkUpdateInterval","ok","hasUpdate","searchContainer","pickedElements","selectedPeerId","selectedMinDate","selectedMaxDate","updatePicked","removeProperty","helper","unselectEntity","renderEntity","dateData","pushRecentSearch","peopleContainer","hideNewBtnMenuTimeout","activeClassName","onFocus","clearRecentSearchBtn","clearRecentSearch","BubbleGroup","createAvatar","avatarLoadPromise","fwdFrom","fwdFromId","isForwardFromChannel","from_id","currentPeerId","firstTimestamp","firstItem","firstMid","lastTimestamp","lastItem","lastMid","updateClassNames","insertItem","sortGroupItemsKey","insertGroup","removeItem","mount","onItemUnmount","mountItem","onItemMount","unmountItem","dateContainer","getDateContainerByTimestamp","dateGroups","_group","dateGroupsLength","unmountedLength","STICKY_OFFSET","deleteEmptyDateGroups","BubbleGroups","itemsArr","itemsMap","newGroupDiff","sortItemsKey","sortGroupsKey","removeItemFromCache","removeAndUnmountBubble","getItemByBubble","siblings","getSiblingsAtIndex","modifiedGroups","previousSibling","canItemsBeGrouped","groupUngrouped","mountUnmountGroups","toMount","toUnmount","bad","partition","getLastGroup","changeBubbleMid","insertItemToArray","changeItemBubble","changeBubbleByBubble","item1","item2","itemIndex","findGroupSiblingByItem","findGroupSiblingInItems","previousItem","siblingGroupedItem","nextItem","addItemToGroup","addItemToCache","getMessageFromId","viaBotId","createItem","SERVICE_AS_REGULAR","getDateForDateContainer","groupMid","splitSiblingsOnGrouping","previousGroup","prepareForGrouping","hadGroup","foundItem","splittedGroups","PopupDatePicker","initDate","onPick","noButtons","selectedDate","onPrevClick","selectedMonth","minMonth","prevBtn","onNextClick","maxMonth","onDateClick","selectedEl","setTimeTitle","controlsDiv","monthTitle","monthsContainer","handleTimeInput","onOverflow","maxString","hoursInputField","minutesInputField","number","setMinutes","popupCenterer","timeOptions","sendDate","dateOptions","renderElement","firstDate","weekStartDate","dayIndex","clonedDate","showOverflowMonths","lines","StickyIntersector","observeHeaders","observeElements","headersObserver","targetInfo","boundingClientRect","stickyTarget","rootBoundsInfo","rootBounds","threshold","root","elementsObserver","addSentinel","sentinel","observeStickyHeaderChanges","headerSentinel","ReactionElement","reactionCount","_reactionCount","setCanRenderAvatars","canRenderAvatars","doNotRenderSticker","hadStickerContainer","getReaction","callbackify","center_icon","wrapPromise","wrapStickerPromise","renderCounter","displayOn","renderAvatars","recentReactions","peer_id","setIsChosen","isChosen","fireAroundAnimation","REACTION_INLINE_SIZE","REACTION_BLOCK_SIZE","around_animation","iconPlayer","aroundPlayer","REACTIONS_ELEMENTS","ReactionsElement","onConnectCallback","getReactionCount","reactionElement","getMessage","isPlaceholder","changeMessage","changedResults","hasReactions","availableReactionsResult","isReactionActive","some","totalReactions","can_see_list","reactionElementIdx","recent_reactions","handleChangedResults","childNodes","timeSpan","RepliesElement","updated","postKey","leftPart","recent_repliers","isUnread","read_max_id","max_id","textSpan","iconSpan","rippleContainer","subscribeRepliesThread","updateMessage","makeEdited","edited","makeSponsored","MessageRender","chatType","editedSpan","sponsoredSpan","reactionsElement","reactionsMessage","isSponsored","sponsored","isMessage","views","postAuthor","post_author","postViewsSpan","channelViews","edit_date","edit_hide","pinned","inner","clonedArgs","_reactionsElement","renderReplies","bubbleContainer","messageDiv","isFooter","repliesFooter","setReply","isReplacing","currentReplyDiv","replyToPeerId","reply_to","reply_to_peer_id","originalPeerTitle","titlePeerId","originalMessageFwdFromId","needUpdate","replyMid","getElementByPoint","horizontalSide","elementFromPoint","reflowScrollableElement","SEND_WHEN_ONLINE_TIMESTAMP","getVisibleRect","overflowElement","lookForSticky","overflowRect","overflowTop","overflowRight","overflowBottom","overflowLeft","sticky","overflow","horizontal","INTERNAL_LINK_TYPE","PopupJoinChatInvite","chatInvite","request_needed","importChatInvite","savePhoto","peopleCount","ScrollSaver","getSaved","clientHeight","findElements","containerRect","elementRect","replaceSaved","findAndSetElements","_save","scrollHeightMinusTop","onRestore","useReflow","setScrollTop","newScrollTop","setScrollTopSilently","restore","_restore","previousScrollHeightMinusTop","SuperIntersectionObserver","observing","observingQueue","freezedObservingNew","callbacks","toggleObservingNew","isMentionUnread","mentioned","middlewarePromise","throwWhat","getEmojiEntityFromEmoji","unicode","appendEmoji","unify","spanEmoji","kek","wrapSingleEmoji","fixEmoji","getEmojiFromElement","nodeType","nodeValue","EmojiTab","closeScrollTop","onContentClick","divs","category","emojis","titleDiv","itemsDiv","unified","emojiScroll","appEmojiManager","getRecentEmojis","hasRecent","activeId","EmoticonsDropdown","menuOnClick","stickyIntersector","setMenuActive","recentItemsDiv","LazyLoadQueueRepeat2","spliced","GifsMasonry","scrollPromise","processInvisibleDiv","processVisibleDiv","gifWidth","gifHeight","willUseWidth","GifsTab","gifsContainer","masonry","EMOTICONSSTICKERGROUP","getGifs","docs","LazyLoadQueueRepeat","_queue","SuperStickerRenderer","regularLazyLoadQueue","animatedDivs","checkAnimationContainer","renderSticker","observeAnimatedDiv","StickersTab","recentStickers","queueCategoryPush","categoryPush","categoryDiv","categoryTitle","superStickerRenderer","recentDiv","stickers","menuWrapper","menuScroll","getRecentStickers","pushRecentSticker","ANIMATIONGROUP","AppGifsTab","nextOffset","loadedAll","onGifsClick","search","gifsDiv","newSearch","gifBotPeerId","resolveUsername","appInlineBotsManager","getInlineResults","AppStickersTab","setsDiv","renderSet","countDiv","stickerDiv","renderFeatured","getFeaturedStickers","coveredSets","filterRendered","covered","searchStickerSets","DropdownHover","forceClose","inited","onMouseOut","displayTimeout","isActive","toElement","willBeActive","dispatchResultableEvent","attachButtonListener","onmouseout","onmouseover","tabId","onSelectTabClick","searchButton","deleteBtn","checkRights","tabsEl","tabsElements","canSendStickers","canSendToPeer","canSendGifs","savedRange","getGoodRange","emojiTab","stickersTab","gifsTab","HIDE_EMOJI_TAB","IS_APPLE_MOBILE","INIT_TAB_ID","addLazyLoadQueueRepeat","getSavedRange","rangeCount","activeElement","getRangeAt","jumpedTo","stuck","which","scrollLeft","clearDraft","emoticonsDropdown","IGNORE_ACTIONS","TEST_SCROLL_TIMES","TEST_SCROLL","PEER_CHANGED_ERROR","getMainMidForGrouped","ChatBubbles","unreadOut","bubblesNewByGroupedId","bubblesNew","dateMessages","scrolledDown","isScrollingTimeout","unreaded","unreadedSeen","messagesQueuePromise","messagesQueue","messagesQueueOnRenderAdditional","firstUnreadBubble","replyFollowHistory","isFirstLoad","passEntities","viewsMids","isTopPaddingSet","renderingMessages","bubblesToEject","bubblesToReplace","setPeerTempId","renderNewPromises","unreadedObserverCallback","onUnreadedInViewport","viewsObserverCallback","sendViewCountersDebounced","sponsoredMessage","random_id","viewSponsoredMessage","onBubblesMouseMove","unhoverPrevious","hoverBubble","hoverReaction","setHoverVisible","stickerWrapper","getGroupsFirstMessage","getMiddleware","getAvailableReactionsByMessage","select_animation","sendReaction","onBubblesClick","appImManager","setInnerPeer","chatInner","onDatePick","contactDiv","callDiv","callUser","spoiler","showDuration","spoilerTimeout","bubbleMid","reply_to_top_id","saved_from_msg_id","openThread","message1","getMessageWithReplies","getDiscussionMessage","via","setDraft","peerIdStr","messageId","documentDiv","groupedItem","SINGLE_MEDIA_CLASSNAME","isSingleMedia","isMediaCompatibleForDocumentViewer","parents","hasAspecter","albumItem","isReplyClick","replyToMid","reply_to_msg_id","ignoreHeavyAnimation","scrollDimensions","sliceViewportDebounced","topbar","setCorrectIndexThrottled","lastScrollDirection","setStickyDateManually","distanceToEnd","getDistanceToEnd","setPeerPromise","requestHistory","setMessageId","constructBubbles","bubbleGroups","sequential","messagesStorageKey","newItem","_items","groupBubbles","scrollingToBubble","scrollToEnd","deleteMessagesByIds","tempMessage","_bubble","groupedId","getMessagesByAlbum","reactionsElements","repliesElement","newDiv","safeRenderMessage","scrollToBubbleIfLast","deletedMids","wasMainMid","mainMid","scrollSaver","createScrollSaver","appendReactionsElementToBubble","dateMessage","dateBubble","previousStickyDate","sliceViewport","setScroll","attachContainerListeners","contextMenu","highlightBubble","replyAfter","shouldReply","canSend","_target","initMessageReply","constructPeerHelpers","renderNewMessage","setUnreadCount","updateUnreadByDialog","finishPeerChange","postViewsElements","different","postViews","incrementMessageViews","createResizeObserver","resizeObserver","wasHeight","resizing","skip","scrolled","rAF","onResizeEnd","offsetHeight","isScrolledDown","setEndRAF","ResizeObserver","contentRect","realDiff","_part","needScrollTop","destroyResizeObserver","setReactionsHoverListeners","overlayCounter","getRenderedLength","readUnreaded","readPromise","idleController","bubblesMaxId","getHistoryMaxId","readContents","readMessages","readHistory","constructPinnedHelpers","constructScheduledHelpers","getScheduledMessagesStorage","onGoDownClick","getBubbleByPoint","getGroupedBubble","groupId","getMidsByAlbum","findNextMountedBubbleByMsgId","filterCallback","_mid","foundMid","loadMoreHistory","getHistoryTopPromise","getHistoryBottomPromise","getHistory1","destroyScrollable","setLoaded","onScrolledTop","getHistoryStorage","readMaxId","readOutboxMaxId","msgId","permanent","ignoreOnScroll","emptyPlaceholderBubble","ignoreNextScrollEvent","setTopPadding","setPaddingTo","isPaddingNeeded","unsetPadding","_renderNewMessage","newMessage","replyTo","getLastBubble","performHistoryResult","scrollToBubbleEnd","scrollToBubble","forceDuration","fallbackToElementStartWhenCentering","isChangingHeight","messageInput","margin","axis","getNormalSize","dimensions","lastScrollPosition","datasetKey","createDateBubble","bubbleContent","serviceMsg","fakeBubble","bubblesToo","cleanupPlaceholders","attachedUnreadBubble","fetchNewPromise","getSponsoredMessagePromise","onAnimateLadder","resolveLadderAnimation","attachPlaceholderOnRender","cancelMeasure","samePeer","startParam","perf","bindPrefix","onChangePeer","topMessage","getPinnedMessagesMaxId","isTarget","followingUnread","savedPosition","overrideAdditionMsgId","getChatSavedPosition","getReadMaxIdIfUnread","unread_count","foundSlice","findSliceOffset","isJump","isStartButtonNeeded","setStartParam","setQueueId","messageEntityBotCommand","isBot","additionMsgId","maxBubbleId","oldChatInner","oldPlaceholderBubble","haveToScrollToBubble","fromUp","scrollFromDown","scrollFromUp","willScrollOnLoad","setPeerOptions","waitPromise","setPeerCached","mountedByLastMsgId","setCorrectIndex","lastBubble","onRenderScrollSet","afterSetPromise","setFetchReactionsInterval","setFetchHistoryInterval","onScrolledAllDown","unread_mark","markDialogUnread","fetchReactions","getMessagesReactions","needFetchInterval","isFetchIntervalNeeded","getNewHistory","isBottomEnd","historyMaxId","canWrite","renderMessagesQueue","setMessagesQueuePromise","renderQueue","renderQueuePromises","loadQueue","filterQueue","avatarPromises","updatePosition","timePromises","groupCollapsed","groupEnd","setUnreadDelimiter","restoreScroll","prepareToSaveScroll","ejectBubbles","oldBubble","local","updatePlaceholderPosition","isAvatarNeeded","additionalCallback","processResult","newBubble","originalPromise","renderMessage","albumMids","albumMessages","albumMustBeRenderedFull","our","isOurMessage","contentWrapper","unread","chat_id","is_single","messageMessage","messageMedia","richText","canHaveTail","isStandaloneMedia","needToSetHTML","emojiEntities","strLength","curr","forward","replyMarkup","reply_markup","containerDiv","rowDiv","buttonEl","botId","same_peer","checkSwitchReturn","popup","switchInlineQuery","column","callbackButtonClick","callbackAnswer","messageWithReplies","getMessageWithCommentReplies","withReplies","isOutMessage","nameContainer","canHideNameIfMedia","processingWebPage","IS_ANDROID","previewResizer","preview","quote","quoteTextDiv","strong","textDiv","isSquare","emojiSticker","animatedSticker","staticSticker","newNameContainer","getMidsByMid","wrapper","wrapGroupedDocuments","lastContainer","contact","contactDetails","contactNameDiv","contactNumberDiv","phone_number","wrapPoll","needName","titleVia","isHidden","goto","generateTail","documentContainer","documentMessageDiv","viewportSlice","getViewportSlice","deleteViewportSlice","historyResult","needReflowScroll","setLoadedPromises","firstSlice","lastSlice","both","processLocalMessageRender","getHistory","ackedResult","getScheduledMessages","animateAsLadder","additionMsgIds","isAdditionRender","targetMid","sortedMids","topIds","middleIds","bottomIds","setBubbles","lastMsDelay","elementsToAnimate","transitionDelay","topRes","middleRes","bottomRes","delays","renderEmptyPlaceholder","listElements","getRestrictionReasonText","getGreetingSticker","channel_post","generateMessageId","start_param","chat_invite","chat_invite_hash","JOIN_CHAT","invite","processInternalLink","creator","isWaitingForAnimation","noTransition","setOn","generateLocalMessageId","addOffset","generateLocalFirstMessage","service","getOutputPeer","saveMessages","storage","extraSize","invisibleTop","invisibleBottom","foundVisible","visibleRect","minTop","maxBottom","ignoreScrollSaving","invisible","checkPlaceholders","toggleSponsoredMessage","renderBotPlaceholder","checkIfEmptyPlaceholderNeeded","_log","getSponsoredMessage","sponsoredMessages","messagePromise","processPromise","bot_info","isBackLimit","resultPromise","isFirstMessageRender","serviceStartMessageId","getThreadServiceMessageId","sup","_promise","mustBeCount","PopupPinMessage","unpin","canUnpin","canPinMessage","oneSide","silent","unpinAllMessages","hidePinnedMessages","updatePinnedMessage","buttonText","getPinnedMessagesCount","pinButtonText","isSelectionEmpty","selectionRange","START_TO_END","preloadAnimatedEmojiSticker","PopupReportMessagesConfirm","reportMessages","STICKER_EMOJI","PopupReportMessages","preloadStickerPromise","buttonsEl","marginTop","PopupSponsored","PopupReactedList","canViewReadParticipants","canViewMessageReadParticipants","btnClose","loaders","hasAllReactions","createFakeReaction","hasReadParticipants","readUserIds","getMessageReadParticipants","chatlist","dialogSize","skipReadParticipants","skipReactionsList","getMessageReactionsListAndReadParticipants","combined","getReactionCached","allReactionsSticker","REACTION_CLASS_NAME","REACTIONS_CLASS_NAME","CAN_USE_TRANSFORM","ChatReactionsMenu","reactionsMap","players","onScrollProcessItem","reactionDiv","appear","widthContainer","reactionsContainer","reactionsScrollable","animationGroup","renderReaction","setVisible","canUseAnimations","scaleContainer","appearWrapper","selectWrapper","appear_animation","selectLoadPromise","selectPlayer","REACTION_SIZE","ChatContextMenu","onContextMenu","isSelectable","isTextSelected","isAnchorTarget","isUsernameTarget","selectedMid","isOverBubble","isTargetAGroupedItem","noForwards","viewerPeerId","canOpenReactedList","initResult","menuPadding","reactionsMenu","reactionsMenuPosition","isReactionsMenuVisible","offsetSize","nextVisiblePart","MIN_NEXT_VISIBLE_PART","minSize","onSendScheduledClick","onReplyClick","onEditClick","initMessageEditing","onCopyClick","onCopyAnchorLinkClick","onCopyLinkClick","threadMessage","onPinClick","onUnpinClick","onRetractVote","onStopPoll","stopPoll","attachListenerSetter","closest","filterButtons","setButtons","hasAttribute","notDirect","scheduleSending","editMessage","scheduleDate","onMessageSent","canEditMessage","getMessageFromStorage","hasTarget","isGoodType","viewsButton","isViewingReactions","participantsCount","reactedLength","i18nElem","fakeText","AVATAR_SIZE","MAX_AVATARS","PADDING_PER_AVATAR","visibility","reactionsCount","fakeElem","readParticipants","isFull","totalSize","SendMenu","sendMenuButtons","onSilentClick","onScheduleClick","sendMenu","openSide","onContextElement","setPeerId","PopupCreatePoll","onSubmitClick","send","radioLabel","isEmpty","isInputEmpty","questions","appendMoreField","correctAnswers","optionInputFields","labelOptions","questionInputField","sendSilent","dd","settingsCaption","anonymousCheckboxField","multipleCheckboxField","quizCheckboxField","quizSolutionField","quizElements","quizSolutionCaption","quizHr","quizSolutionContainer","quizSolutionSubtitle","onEscape","getFilledAnswers","HTMLInputElement","getRichValue","quizSolution","force","quizSolutionEntities","inputMediaPoll","getInputMediaPoll","sendOther","getMessageSendingParams","helperType","clearHelper","questionField","createPosterFromMedia","videoHeight","getGifDuration","arrayBuffer","currentPopup","getCurrentNewMediaPopup","PopupNewMedia","willAttachType","confirmShortcutIsSendShortcut","onKeyDown","placeCaretAtEnd","attachFile","willAttach","shouldCompress","params","itemDiv","attachMedia","attachDocument","sendFileDetails","config","getConfig","captionLengthMax","caption_length_max","mediaContainer","wasInputValue","messageInputField","attachFiles","appendDrops","appendGroupCheckboxField","groupCheckboxField","mediaCheckboxField","appendMediaCheckboxField","addFiles","toPush","_file","lastModified","isMedia","sendingParams","sendText","sendAlbum","assign","replyToMsgId","startsWith","source","objectURL","controls","audioDecodedByteCount","webkitAudioDecodedByteCount","noSound","onseeked","onerror","createPosterFromVideo","isPhoto","isAudio","finish","onRender","foundPhotos","foundVideos","foundFiles","n","appendMediaToContainer","firstType","albumContainer","HANDLE_EVENT","ACTIVE_CLASS_NAME","AXIS_Y_KEYS","AXIS_X_KEYS","AutocompleteHelper","hidden","onVisible","resetTarget","waitForKey","waitForKeySet","keyNames","getCurrentTarget","setCurrentTarget","scrollTo","hadTarget","fastSmoothScroll","getNextTargetX","currentTarget","isNext","nextTarget","handleArrowKey","property","endProperty","currentRect","targetRect","getNextTargetY","fireSelect","canContinue","attached","_onKeyDown","attachListNavigation","listType","noBlurOnPop","attachNavigation","controller","addHelper","toggleListNavigation","fromController","skipAnimation","hideOtherHelpers","StickersHelper","onChangeScreen","checkEmoticon","getStickersByEmoticon","ready","getMinDate","getMaxDate","PopupSchedule","canSendWhenOnline","btnSendWhenOnline","getRichValueWithCaret","field","withEntities","selNode","selOffset","startOffset","startContainer","endContainer","endOffset","possibleChildrenFocusOffset","node","alt","getRichElementValue","caretPos","combineSameEntities","EmojiHelper","chatInput","onEmojiSelected","checkQuery","firstChar","getBothEmojiKeywords","searchEmojis","AutocompletePeerHelper","doNotShow","listElement","BASE","BASE_CLASS_LIST_ELEMENT","processPeerFullForCommands","botInfos","commands","botInfo","command","indexObject","CommandsHelper","getReadyToSend","sendMessage","AutocompleteHelperController","helpers","preserveHelper","MentionsHelper","insertAtCaret","topMsgId","trimmed","getMentions","ReplyKeyboard","onBodyTouchStart","btnHover","checkAvailability","checkForceReply","touchListener","sendContact","getReplyMarkup","getHistoryStorageTransferable","InlineHelper","queryId","queryAndResultIds","generateQId","resultId","sendInlineResult","_checkQuery","botResults","query_id","gifsMasonry","isGallery","gallery","noCommands","separator","dcId","readBlobAsDataURL","dataURL","switch_pm","btnSwitchToPM","switchToPM","ChatBotCommands","setUserId","modifyAckedResult","acked","modifyAckedPromise","ChatSendAs","sendAsButtons","previousAvatar","onSendAsMenuToggle","updateButtons","sendAsPeerId","changeSendAsPeerId","executeButtonsUpdate","sendAsPeerIds","saveDefaultSendAs","updateAvatar","getDefaultSendAs","getChannelFull","channelFull","default_send_as","updateManual","updatingPromise","wasSkippingAnimation","auto","getSendAs","addedListener","POSTING_MEDIA_NOT_ALLOWED","ChatInput","lastUrl","lastTimeType","replyElements","willSendWebPage","recordCanceled","recordStartTime","lockRedo","canRedoFromHTML","undoHistory","executedHistory","canUndoFromHTML","onCancelRecordClick","recorder","opusDecodeController","onEmoticonsOpen","toggleClass","btnToggleEmoticons","onEmoticonsClose","isUserOnlineVisible","openScheduled","prepareDocumentExecute","undoRedo","needHTML","sameHTMLTimes","currentHTML","handleMarkdownShortcut","formatKeys","markupTooltip","applyMarkdown","showLinkEditor","shiftKey","onMessageInput","richValue","markdownEntities","parseMarkdown","mergeEntities","parseEntities","urlEntities","getWebPagePromise","appWebPagesManager","getWebPage","setTopInfo","noWebPage","onHelperCancel","helperFunc","botCommands","resetCurrentFormatting","updateBotCommandsToggle","editMsgId","saveDraftDebounced","checkAutocomplete","updateSendBtn","onBtnSendClick","forwarding","releaseMediaPlayback","setRecording","showDiscardPopup","btnCancelRecord","recordingOverlayListener","recordingNavigationItem","sourceNode","analyser","createAnalyser","connect","fftSize","frequencyData","frequencyBinCount","getByteFrequencyData","recordRippleEl","ms","recordTimeEl","needReturn","onHelperClick","forwardElements","rowsWrapperWrapper","rowsWrapper","fakeRowsWrapper","fakeSelectionWrapper","goDownBtn","controlContainer","iconBtn","cancelBtn","onHideAuthorClick","isChangingAuthor","canToggleHideAuthor","onHideCaptionClick","forwardButtons","hideSender","showCaption","hideCaption","changePeer","changeForwardRecipient","forwardBtnMenu","forwardWasDroppingAuthor","replyTitle","forwardHover","modifyArgs","newMessageWrapper","inputMessageContainer","goDownUnreadBadge","goMentionBtn","goMentionUnreadBadge","goToNextMention","btnScheduled","btnToggleReplyMarkup","replyKeyboard","botCommandsToggle","scaler","botCommandsIcon","attachMenuButtons","fileInput","attachMenu","multiple","autocompleteHelperController","stickersHelper","emojiHelper","commandsHelper","mentionsHelper","inlineHelper","btnSendContainer","btnSend","attachMessageInputField","previousQuery","onFakeInput","draft","saveDraft","encoderSampleRate","monitorGain","numberOfChannels","recordingGain","reuseWorker","onstop","ondataavailable","typedArray","dataBlob","Blob","sendFile","isVoiceMessage","botStartBtn","toggleBotStartBtnDisability","startBot","pinnedControlBtn","originalChat","pinnedMessageContainer","_center","neededFakeContainer","fakeWrapperTo","oldFakeWrapperTo","borderRadius","fakeSelectionRect","fakeRowsRect","scale","initTranslateX","br","getNeededFakeContainer","hasMentions","unread_mentions_count","tsNow","no_webpage","syncDraft","helperToo","clearInput","fromUpdate","getDraft","inputFake","wrappedDraft","myEntities","apiEntities","wrapDraft","setInputValue","createSendAs","firstChange","sendAs","updateOffset","getPlaceholderKey","updateMessageInputPlaceholder","previousSendAs","ackedPeerFull","ackedScheduledMids","setSendAsCallback","filteredAttachMenuButtons","filterAttachMenuButtons","placeholderKey","hasBotCommands","updateBotCommands","updateMessageInput","isAnonymousSending","oldInputField","attachMessageInputListeners","fixSafariStickyInputFocusing","isSendShortcutPressed","ctrlKey","metaKey","setStart","collapse","addRange","readAllHistory","commandsMap","italic","underline","strikethrough","monospace","saveExecuted","executed","haveThisType","isCollapsed","tag","commonAncestorContainer","setActiveMarkupButton","insertText","insertEntity","isHelper","fullValue","suffix","AUTO_COMPLETE_REG_EXP","matchIndex","newValue","hadEntities","insertLength","addEntities","caretEntity","insertCaretAtIndex","caret","originalNode","newNode","createTextNode","setStartAfter","insertNode","setCaretAt","_value","foundHelper","checkInlineAutocomplete","needPlaceholder","inlineMatch","btnPreloader","bot_inline_placeholder","inlinePlaceholder","helperWaitingForward","canSetDraft","fireEvent","clearValue","fixSafariStickyInput","clearReply","pushRecentEmoji","forwardMessages","dropAuthor","dropCaptions","isDroppingCaptions","sendMessageWithDocument","hideCaptionCheckboxField","replyFragment","initMessagesForward","fromPeerIdsMids","fromPeerIds","messagesWithCaptionsLength","peerTitles","titleKey","senderTitles","firstMessage","newReply","intl","peerTitleEl","wrapSingleMessage","_message","callerFunc","replyParent","oldReply","haveReply","CLASSNAME_BASE","PinnedContainer","floating","divAndCaption","wrapperUtils","attachOnCloseEvent","needClose","isFloating","setFloating","setUtilsWidth","VolumeSelector","onMuteClick","setVolume","volume","iconIndex","ICONS","ChatAudio","onPlaybackParams","playbackParams","fasterEl","playbackRate","repeatEl","onPause","toggleEl","onStop","onMediaPlay","isMusic","volumeSelector","prevEl","nextEl","attachClick","volumeProgressLineContainer","tunnel","progressWrapper","playingDetails","BAR_HEIGHTS","PinnedMessageBorder","drawRect","getClipPath","barHeight","GAP","clipPath","getBarHeight","ONE","TWO","THREE","FOUR","MORE","getMarkHeight","markHeight","getMarkTranslateY","getTrackTranslateY","trackHeight","getTrackHeight","cssText","clipPathId","markTranslateY","trackTranslateY","defs","mark","AnimatedSuper","getRow","animateFirst","clearRow","clearRows","currentIndex","DURATION","setNewRow","reflow","previousIndex","fromTop","ignorePrevious","previousRow","AnimatedCounter","previousNumber","getDecimal","animatedSuper","decimal","hideLeft","previousDecimalNumber","EMPTY_INDEX","setCount","previousByDecimal","decimalNumber","ChatPinnedMessage","pinnedMaxMid","pinnedMid","pinnedIndex","wasPinnedIndex","wasPinnedMediaIndex","waitForScrollBottom","loadedBottom","loadedTop","scrollDownListenerSetter","getCurrentIndexPromise","debug","isStatic","dAC","pinnedMessageBorder","animatedSubtitle","animatedMedia","animatedCounter","btnOpen","openPinned","setPinnedMessage","_setPinnedMessage","unsetScrollDownListener","testMid","isNeededMore","getCurrentIndex","LOAD_OFFSET","correctAfter","gotRest","getPinnedMessage","backLimited","offset_id_offset","setScrollDownListener","lastY","isDown","handleScrollSideEvent","refreshPosition","handleFollowingPinnedMessage","followPinnedMessage","isLast","writeTo","writeMediaTo","PopupMute","mutePeer","ONE_HOUR","radioForm","AudioAssetPlayer","assets","playSound","assetName","createAudio","playSoundIfDifferent","Audio","stopSound","cancelDelayedPlay","playSoundWithTimeout","audioAsset","getAudioConstraints","constraints","channelCount","constraint","mediaDevices","getSupportedConstraints","constraintSupported","getScreenConstraints","skipAudio","frameRate","getScreenStream","screenStream","getDisplayMedia","getVideoTracks","contentHint","getStream","stream","getUserMedia","getTracks","getStreamCached","_cache","screen","isScreen","stopTrack","track","StringFromLineBuilder","newLine","strs","word","addJoined","finalize","toTelegramSource","fromTelegramSource","fixMediaLineType","mediaType","getConnectionTypeForMediaType","generateMediaFirstLine","port","payloadIds","connectionType","SDPBuilder","addCandidate","foundation","component","protocol","priority","generation","performCandidate","addHeader","sId","bundleMids","bundle","addTransport","transport","skipCandidates","ufrag","pwd","fingerprint","fingerprints","setup","candidates","candidate","addSsrc","streamName","sourceGroups","addSource","ssrc","addMsid","ssrcGroup","sources","semantics","addSsrcEntry","isAnswer","isApplication","codec","isInactive","shouldBeSkipped","payloadTypes","hdrexts","hdrext","clockrate","parameters","fbs","fb","subtype","addConference","conference","sessionId","IS_FIREFOX","recvEntry","sendEntry","AudioStreamAnalyser","streamSource","createMediaStreamSource","gain","createGain","minDecibels","maxDecibels","smoothingTimeConstant","StreamManager","interval","getAmplitude","streamAnalyser","rms","analyse","amplitudes","ANALYSER_LISTENER","AudioContext","webkitAudioContext","outputStream","MediaStream","inputStream","canCreateConferenceEntry","addStream","addTrack","getSource","itemSource","removeTrack","finalizeAddingTrack","changeTimer","hasInputTrackKind","substring","handled","replaceInputAudio","oldTrack","timer","appendToConference","transceiverInit","streams","tracks","findEntry","createEntry","transceiver","createTransceiver","connection","mediaTrackType","trackIdx","sender","replaceTrack","CallInstanceBase","fixSafariAudio","isSharingAudio","streamManager","isSharingVideo","requestAudioSource","requestInputSource","isAudioGood","isVideoGood","onInputStream","requestScreen","getElement","endpoint","onTrack","tryAddTrack","saveInputVideoStream","isOutput","isVideo","elementEndpoint","useStream","srcObject","sinkId","outputDeviceId","setSinkId","setMuted","getAudioTracks","isClosing","ConferenceEntry","originalDirection","setPort","setEndpoint","addTransceiver","setSource","generateSsrc","LocalConferenceDescription","maxSeenId","entriesByMid","entriesBySource","entriesByPeerId","setData","deleteEntry","setEntrySource","setEntryPeerId","findFreeSendRecvEntry","isSending","getEntryByMid","getEntryBySource","getEntriesByPeerId","generateSdp","fromConference","CallConnectionInstanceBase","createPeerConnection","RTCPeerConnection","signalingState","connectionState","iceConnectionState","createDataChannel","dict","dataChannel","channel","createDescription","appendStreamToConference","closeConnection","closeConnectionAndStream","stopStream","negotiate","negotiating","negotiateInternal","sendDataChannelData","SDP","mediaSections","parsed","splitStringByLimitWithRest","UniqueNumberGenerator","generate","maxTries","_try","SDPAttributeSplitted","SDPMediaLineParts","SDPLine","mediaLineParts","SDPAttributeInner","missed","exists","rest","nestedMap","makeAttributes","innerParts","SDPAttributes","fillAttributes","attributesMap","linesArray","SDPMediaSection","mediaLine","isReceiving","lookupAttributeKeys","resultShouldBeArray","SDPSessionSection","parseSdp","createSection","sessionSection","lineStr","isIncorrectSdpLine","parseSdpLine","parseMediaSectionInfo","sdp","clientInfo","telegramSourceGroups","sdpLines","parseSourceGroups","raw","GROUP_CALL_STATE","GroupCallConnectionInstance","negotiateThrottled","iceServers","iceTransportPolicy","bundlePolicy","rtcpMuxPolicy","iceCandidatePoolSize","maybeUpdateRemoteVideoConstraints","updateConstraintsInterval","invokeJoinGroupCall","localSdp","mainChannels","groupCall","groupCallId","processedChannels","processed","sectionInfo","payload","processMediaSection","audioChannel","videoChannel","useChannel","parse","appGroupCallsManager","joinGroupCall","connections","extmap","performExtmap","filterServerCodecs","isNewConnection","originalOffer","createOffer","iceRestart","offer","hasMunged","skipAddingMulticast","generator","originalSsrcs","ssrcs","ssrcs2","ssrcsStrLines","ssrc2","addSimulcast","localMLine","codecIds","newData","newChannel","mungedSdp","fixLocalOffer","setLocalDescription","entriesToDelete","answerDescription","iceGatheringState","setRemoteDescription","updateConstraints","getTransceivers","setParameters","getParameters","degradationPreference","colibriClass","defaultConstraints","onStageEndpoints","addInputVideoStream","GroupCallInstance","isSpeakingMap","pinnedSources","participantsSsrcs","hadAutoPinnedSources","dispatchPinnedThrottled","pinnedSource","can_self_unmute","getCachedParticipants","isSharingScreen","presentation","pinSource","unpinSource","unpinAll","getParticipantByPeerId","toggleMuted","changeUserMuted","editParticipant","getVideoElementFromParticipantByType","source_groups","clone","createConnectionInstance","changeRaiseHand","raise","raiseHand","startScreenSharingInternal","connectionInstance","stopScreenSharing","startScreenSharing","startScreenSharingPromise","saveApiParticipant","leaveGroupCallPresentation","toggleScreenSharing","startVideoSharingInternal","videoPaused","videoStopped","startVideoSharing","startVideoSharingPromise","stopVideoSharing","toggleVideoSharing","hangUp","discard","rejoin","isDiscarded","isUpdatingMeInCurrentCall","raise_hand_rating","audio_source","audioSource","onParticipantUpdate","doNotDispatchParticipantUpdate","hasLeft","oldSsrcs","makeSsrcFromParticipant","makeSsrcsFromParticipant","modifiedTypes","oldSsrc","oldSource","oldEntry","GroupCallsController","currentGroupCall","setCurrentGroupCall","startConnectingSound","stopConnectingSound","joinVideo","createMainStreamManager","joinGroupCallInternal","getGroupCallFull","getGroupCallParticipants","handleUpdateGroupCallParticipants","updatingSdp","groupCallsController","ChatTopbar","verifyButtons","isMenuOpen","btnMore","deleteButtonText","getDeleteButtonText","menuButtons","buttonsToVerify","verifyVideoChatButton","call_active","verifyCallButton","getCachedFullUser","phone_calls_available","video_calls_available","onJoinGroupCallClick","onResize","resize","setUtilsRAF","chatUtils","chatAudio","setPeerStatusManual","btnBack","chatInfoContainer","chatInfo","person","avatarElement","btnJoin","btnPinned","btnCall","btnGroupCall","btnMute","btnSearch","pushButtonToVerify","onBtnBackClick","isFirstChat","constructUtils","linked_chat_id","onCallClick","chatContextMenuHintWasShown","contactPeerId","constructAvatar","joinChannel","setMutedState","isTopMessage","hiddenPinnedMessages","constructDiscussionHelpers","byCurrent","newAvatar","setTitleCallback","setStatusCallback","setTitleManual","wasAlreadyUsed","newPinnedMessage","AppPrivateSearchTab","appSearch","btnPickDate","ChatSearch","selectedIndex","onResultsClick","selectResult","onFooterClick","onUpClick","onDownClick","foundCountEl","upBtn","downBtn","footer","dateBtn","renderedCount","ChatBackgroundPatternRenderer","canvases","instance","INSTANCES","renderToCanvas","fillCanvas","crossOrigin","objectUrl","imageWidth","imageHeight","patternHeight","dpr","originalHeight","mask","globalCompositeOperation","centerY","topY","endY","bottomY","setCanvasDimensions","Chat","backgroundEl","Log","backgroundTempId","sharedMediaTabs","setBackground","patternRenderer","gradientCanvas","previousGradientRenderer","previousPatternRenderer","previousPatternCanvas","patternCanvas","isDarkPattern","getInstance","_gradientRenderer","setBackgroundPromise","setType","beforeDestroy","cleanupBackground","searchTab","_isAnyGroup","setAutoDownloadMedia","bubblesSetPeerPromise","destroySharedMediaTab","photoSizeMax","videoSizeMax","fileSizeMax","photo_size_max","video_size_max","getAutoDownloadSettingsByPeerId","callbacksPromise","setPrefix","ignoreThreadId","historyStorageTransferable","historySerialized","MarkupTooltip","waitingForMouseUp","mouseUpCounter","onMouseUpSingle","resetSelection","tools1","tools2","cancelClosening","linkBackButton","linkInput","applyLink","isLinkValid","setTooltipPosition","linkApplyButton","applyDiv","delimiter1","delimiter2","delimiter3","matchUrlProtocol","hideTimeout","getActiveMarkupButton","nodes","getSelectedNodes","currentMarkups","activeButtons","isLinkToggle","bodyRect","selectionRect","inputRect","selectionTop","sizesRect","isFirstShow","setMouseUpEvent","handleSelection","arcParameter","rx","ry","xAxisRotation","largeArcFlag","sweepFlag","generatePathData","tl","tr","bl","ChatDragAndDrop","dropIcon","onDragOver","onDragLeave","onDrop","outlineWrapper","dropHeader","dropSubtitle","headerArgs","setPath","disableTransition","LineBlobDrawable","maxRadius","minRadius","N","radiusNext","speed","generateBlob","radDif","generateNextBlob","amplitude","speedScale","draw","paint","pinnedTop","progressToPinned","beginPath","moveTo","lineTo","r1","progressNext","x1","x2","cx","y1","y2","bezierCurveTo","closePath","WeavingState","stateId","createGradient","shader","getGradientFromType","x0","y0","createLinearGradient","addColorStop","dt","TopbarWeave","handleDevicePixelRatioChanged","setSize","forceUpdate","handleResize","resizeHandler","resizeCanvas","invokeDraw","handleFocus","focused","handleBlur","lbd","lbd1","lbd2","currentState","previousState","progressToState","lastUpdateTime","animateToAmplitude","animateAmplitudeDiff","amplitude2","animateAmplitudeDiff2","top1","top2","paint1","globalAlpha","setCurrentState","states","componentDidMount","matchMedia","setAmplitude","componentWillUnmount","setCanvasSize","customProperties","computedStyle","getProperty","RLottieIconItemPart","playPart","RLottieIconItem","createPart","initFrame","skipFirstFrameRendering","inverseColor","onLoadForColor","onLoadForPart","getPart","RLottieIcon","startFrame","endFrame","frameCount","SuperRLottieIcon","partState","colorState","getColor","partCallback","changedPartState","changedColorState","setPartState","setColorState","prevState","renderIfPaused","invoke","GroupCallMicrophoneIcon","GROUP_CALL_MICROPHONE_BUTTON_STATE","partName","HAND","MUTED","UNMUTED","GroupCallParticipantMutedIcon","colored","GROUP_CALL_PARTICIPANT_MUTED_STATE","colorStr","MUTED_FOR_ME","MUTED_BY_ADMIN","propertyValue","getColorByMutedState","generateEqualParts","clearMutedStateModifier","GroupCallParticipantStatusElement","withIcons","iconClassName","element2","actionClassName","GroupCallParticipantsList","onElementDestroy","getGroupCallParticipantMutedState","mutedIcon","ControlsHover","hideControls","setHideTimeout","hideControlsTimeout","isShown","controlsLocked","canHideControls","showControls","toggleControls","ignoreClickClassName","relatedTarget","showOnLeaveToClassName","lockControls","callVideoCanvasBlur","renderFrame","GroupCallParticipantVideoElement","setPinned","setParticipant","groupCallParticipantMutedIcon","groupCallParticipantStatus","updateParticipant","GroupCallParticipantsVideoElement","participantsElements","setElementDisplay","setInstance","shouldDisplayElement","displayPinned","shouldDisplay","isPinned","hasAnyVideo","participantElements","participantVideo","_onLengthChange","GroupCallParticipantContextMenu","onOpenProfileClick","PopupGroupCall","targetPeerId","toggleParticipantMuted","canManageCall","muted_by_you","kickFromChat","getContainer","GroupCallParticipantsElement","groupCallParticipantsVideo","GroupCallDescriptionElement","descriptionIntl","GroupCallTitleElement","makeButton","_className","buttonDiv","isConfirm","resizeHandlerClassName","MovableElement","fixDimensions","fixPosition","addResizeHandlers","setSwipeHandler","destroyElements","handlers","startTop","startLeft","startWidth","startHeight","resizingSide","isEnlarging","resizeDiff","maxPossible","setPositionToCenter","MovablePanel","toggleMovable","movable","movableOptions","toggleClassName","withoutOverlay","onFullScreenClick","onToggleControls","buttonsContainer","onVideoClick","btnVideo","onScreenClick","btnScreen","onLeaveClick","onFullScreenChange","toggleBigLayout","btnFullScreen","btnExitFullScreen","wasFullScreen","movablePanel","videosCount","wasBig","btnInvite","btnShowColumn","toggleRightColumn","btnFullScreen2","headerInfo","newHeader","newHeaderInfo","newHeaderTitle","btnHideColumn","videosScrollable","groupCallTitle","groupCallDescription","groupCallBodyHeaderDescription","constructButtons","groupCallParticipants","updateInstance","setHasPinned","groupCallMicrophoneIcon","_makeButton","microphoneIcon","btnLeave","setDescription","microphoneButtonState","getGroupCallMicrophoneButtonState","micState","CALL_STATE","CallDescriptionElement","connectedAt","GroupCallMicrophoneIconMini","INIT_STATE","PopupCall","resizeVideoContainers","videoContainers","interlocutorUserId","emojisSubtitle","partyStates","partyMutedState","stateText","constructFirstButtons","constructSecondButtons","wasTryingToJoin","movableElement","controlsHover","getCallInstance","firstButtonsRow","muteI18nElement","secondButtonsRow","declineI18nElement","btnDecline","btnAccept","acceptCall","createVideoContainer","big","isPendingIncoming","outputState","getMediaState","oldContainers","mediaState","getVideoElement","hasFrame","hasPromise","videoState","screencastState","videoContainer","output","getEmojisFingerprint","popupWidth","MAX_WIDTH_PX","MAX_HEIGHT_PX","isVertical","MAX_SIZE","biggestSideSize","widthRatio","heightRatio","parseSignalingData","screencast","convertNumber","ssrcGroups","sourceGroup","rtpExtensions","payloadTypesMap","getPayloadType","payloadType","feedbackTypes","CallConnectionInstance","localDescription","remoteDescription","descriptionInit","offerReceived","createAnswer","offerSent","initialSetup","sendCallSignalingData","CALL_REQUEST_TIMEOUT","CallsController","instances","sortedInstances","setPhoneCall","confirmCall","createCallInstance","admin_id","overrideConnectionState","setHangUpTimeout","encryptionKey","g_a","dh","g_a_or_b","g_a_hash","bytesCmp","key_fingerprint","appCallsManager","computeKey","joinCall","callId","onUpdatePhoneCallSignalingData","currentCall","getCallByUserId","CallInstance","hasConnected","clearHangUpTimeout","discardReason","hasCurrent","startCallInternal","fullInfo","participant_id","generateDh","requestCall","phoneCall","callsController","crypto","subtle","P2PEncryptor","p2pKey","seqMap","concatSHA256","bufferConcats","convertToUint8Array","encryptPrepared","msgKeyLarge","subarray","msgKey","aesKeyIv","prepareAesKeyIv","aesProcessCtr","encryptRawPacket","seq","ArrayBuffer","setUint32","sha256a","sha256b","iv","encryptedData","dataSize","encrypt","cryptoKey","constTimeIsDifferent","msgKeyEquals","decryptRawPacket","encryptedDataSize","decryptionBuffer","getUint32","ChromeP2PSdpBuilder","stringBuilder","addExtmap","addPayloadTypes","FirefoxP2PSdpBuilder","SafariP2PSdpBuilder","isFirefox","userAgent","isSafari","j","fmtp","getOwnPropertyNames","pName","P2PSdpBuilder","sdpString","sdpMLineIndex","sdpMid","relAddress","tcpType","networkId","networkCost","generateOffer","generateAnswer","udp_p2p","udp_reflector","min_layer","max_layer","library_versions","createdAt","decryptQueue","lowBattery","videoRotation","Proxy","setMediaState","sendMediaState","mediaStates","_sendMediaState","_connectionState","sortIndex","wasStartingScreen","wasStartingVideo","isSharingVideoType","audioTrack","hangUpTimeout","canAccept","g_b","g_b_hash","getCallInput","phonePhoneCall","savePhonePhoneCall","configuration","ipv6","password","urls","turn","stun","credential","p2p_allowed","getRtcConfiguration","sendIceCandidate","encryptor","decryptor","processDecryptQueue","createDataChannelEntry","dataChannelEntry","negotiated","applyDataChannelData","TextEncoder","encode","iceCandidate","p2pParseCandidate","emojisFingerprint","getEmojisFingerprintPromise","codePoints","unlockStreamManager","doTheMagic","sdpDescription","videoTrack","onMutedChange","discardedByOtherParty","hasVideo","discardCall","performCodec","_codec","setDataToDescription","filterNotVP8","vp8PayloadType","rtxIdx","apt","applyCallSignalingData","performSsrcGroups","sendRecvEntry","tryToReleaseCandidates","generateCandidate","RTCIceCandidate","addIceCandidate","decryptedData","TextDecoder","decode","signalingData","TopbarCall","onState","weave","clearCurrentInstance","currentDescription","instanceListenerSetter","isChangingInstance","callDescription","convertCallStateToGroupState","groupCallMicrophoneIconMini","throttledMuteClick","weaveContainer","uiNotificationsManager","notificationsShown","notificationIndex","notificationsCount","soundsPlayed","vibrateSupport","faviconEl","titleBackup","titleChanged","stopped","pushInited","updateLocalSettings","updSettings","nodesktop","novibrate","nopreview","nopush","needPush","webPushApiManager","registeredDevice","nosound","requestPermission","Notification","mozVibrate","webkitVibrate","setAppBadge","notificationsUiSupport","notifySoundEl","topMessagesDeferred","singleInstance","idle","toggleToggler","peerString","soundReset","unreadUnmutedPeerIds","tokenData","unregisterDevice","registerDevice","notificationData","custom","hasChat","hasUser","buildNotification","fwdCount","peerReaction","peerTypeNotifySettings","notification","getPeerString","notificationMessage","noIncrement","notificationFromPeerId","peerPhoto","loadAvatar","resetTitle","isBlink","setFavicon","titleInterval","arc","fontSize","textBaseline","textAlign","fillText","prevFavicon","replaceChild","testSound","permission","appRuntimeManager","onclose","getLocalSettings","nextSoundAt","prevSoundVolume","filename","token_type","tokenType","token","tokenValue","other_uids","app_sandbox","secret","getFilesFromEvent","onlyTypes","scanFiles","isDirectory","directoryReader","createReader","readEntries","itemFile","getAsFile","DataTransferItem","DragEvent","dataTransfer","clipboardData","originalEvent","webkitGetAsEntry","AppImManager","columnEl","offline","updateStatusInterval","cacheStorage","onHashChange","saveState","parseUriParams","tgaddr","postId","openUsername","userName","setSettings","chatsSelectTabDebounced","toggleChatGradientAnimation","onDocumentPaste","attachType","newMediaPopup","_types","canDrag","apiUpdatesManager","backgroundPromises","updateStatus","emojiAnimationContainer","appendEmojiAnimationContainer","createNewChat","chatsSelectTab","compareVersion","deleteFilesIterative","headers","applyCurrentTheme","resizeInstances","saveChatPosition","choosing","setChoosingStickerTyping","typings","typing","onInstanceDeactivated","isUpdated","stateStorage","topbarCall","discardCurrentCall","setAuthorized","telegramMeWebManager","addAnchorListener","uriParams","hashtag","pathnameParams","STICKER_SET","makeLink","VOICE_CHAT","USER_PHONE_NUMBER","PRIVATE_POST","thread","comment","MESSAGE","attachKeydownListener","timeoutOperation","requests","request","isBad","activatingChat","IGNORE_KEYS","altKey","getFirstMessageToEdit","getNextDialog","newEvent","KeyboardEvent","commentId","resolveChannel","checkChatInvite","saveApiChat","resolvePhone","openUrl","wrappedUrl","noPathnameParams","pathname","noUriParams","openComment","generateThreadServiceStartMessage","phone_calls_private","ignoreGroupCall","ignoreCall","discardGroupCallConfirmation","discardCallConfirmation","createGroupCall","setCurrentBackground","broadcastEvent","getBackground","getFile","lastBackgroundUrl","chatBubbles","chatPositions","backgroundUrl","prevTab","prevIdx","attachDragAndDropListeners","drops","mediaDrops","isFiles","_dropsContainer","mediaDropsContainer","dropsContainer","_drops","foundMedia","drop","transitionTime","onImTabChange","updateMyOnlineStatus","spliceChats","fromIndex","justReturn","chatFrom","chatTo","chatIndex","existingIndex","oldChat","getTypingElement","dot","eye","getPeerTyping","getPeerTypings","langPackKeys","multi","mapa","peerTitlePromise","typingElement","descriptionElement","getChatStatus","typingEl","onlines","getOnlines","getUserStatus","ignoreSelf","getPeerStatus","useWhitespace","typingContainer","VideoPlayer","onPlaybackRackMenuToggle","onPip","onPipClose","playbackRateButton","skin","stylePlayer","setBtnMenuToggle","initDuration","buildControls","timeDuration","pipButton","fullScreenButton","timeElapsed","leftControls","requestPictureInPicture","debounceTime","debouncedPip","listener","pictureInPictureElement","toggleFullScreen","nextIdx","PLAYBACK_RATES","onFullScreen","setPlaybackRateIcon","pictureInPictureEnabled","rate","PLAYBACK_RATES_ICONS","webkitEnterFullscreen","enterFullscreen","AppMediaViewerBase","topButtons","preloaderStreamable","isFirstOpen","pageEl","zoomElements","zoomSwipeStartX","zoomSwipeStartY","zoomSwipeX","zoomSwipeY","setZoomValue","rangeSelector","moversContainer","btnOut","btnIn","toggleZoom","setMoverAnimationPromise","highlightSwitchersTimeout","wholeDiv","isZooming","mover","classNames","ctrlKeyDown","changeZoom","onKeyUp","scrollingUp","MEDIA_VIEWER_CLASSNAME","overlaysDiv","mainDiv","topbarLeft","authorRight","zoom","onLoadedMore","setNewMover","onDownloadClick","moveLength","setMoverPromise","evt","zoomValue","videoPlayer","zoomSwipeHandler","lastDiffY","btnMenuToggle","setMoverToTarget","appMediaViewer","removeGlobalListeners","toggleOverlay","toggleGlobalListeners","setGlobalListeners","closing","fromRight","removeCenterFromMover","wasActive","realParent","SVGForeignObjectElement","needOpacity","setFullAspect","scaleX","scaleY","brSplitted","fillPropertyValue","willBeLeft","willBeTop","isRejected","SVGSVGElement","sizeTailPath","toggleWholeActive","mediaElement","clipId","newClipId","newSvg","outerHTML","SVGUseElement","sX","sY","upscale","_br","moveTheMover","toLeft","windowW","newTransform","p1","newMover","updateMediaSource","setAuthorInfo","wrapTitlePromise","oldAvatar","_openMedia","setAuthorPromise","setTargets","useContainerAsTarget","padding","windowH","useController","moverVideo","canPlayThrough","createPlayer","ckin","overlay","otherMediaViewer","releaseSingleMedia","HAVE_FUTURE_DATA","attachCanPlay","networkState","NETWORK_LOADING","isntEnoughData","cancellablePromise","haveImage","captionTimeout","isForDocument","onAuthorClick","onEmptied","setCaptionTimeout","btnMenuForward","btnMenuDownload","btnMenuDelete","onCaptionClick","getScheduledMessageByPeer","setCaption","cantForwardMessage","cantDownloadMessage","AvatarListLoader","loadedAllUp","AppMediaViewerAvatar","onAvatarUpdate","getTarget","hadMessage","isObject","believeMe","addedToQueue","wasPeerId","newPeerId","DialogsContextMenu","onArchiveClick","selectedId","editPeerFolders","folder_id","toggleDialogPin","pinned_dialogs_count_max","onUnmuteClick","onUnreadClick","top_message","isDialogUnread","SENDING_STATUS","ConnectionStatusComponent","hadConnect","connecting","timedOut","updating","setConnectionStatus","rootScope","baseDcId","connectionStatus","setFirstConnectionTimeout","online","forceGetDifference","retryAt","setStatusText","currentLangPackKey","statusEl","statusPreloader","CHANGE_STATE_DELAY","getA","networkerFactory","forceReconnect","timerSpan","forceReconnectTimeout","setStateTimeout","statusContainer","easeInOutSine","roundRect","defaultRadius","quadraticCurveTo","DPR","SIZE","MARGIN","Shimmer","currTime","diffTime","spread","pausedTime","pauseInterval","lightSource","lightSpread","animations","currentAnimationIndex","keepTime","cycleAnimation","currentAnimation","animateGlow","animateSlide","smartInc","lightLeft","lightRight","lightCenter","shimmerColor","on","DialogsPlaceholder","onThemeChange","stopAnimation","startAnimation","updateCanvasSize","shimmer","generatedValues","marginVertical","lineBorderRadius","lineMarginVertical","statusWidth","getRectFrom","onRemove","blockScrollable","overflowY","availableLength","detachTime","renderDetachAnimationFrame","completed","elapsedRowTime","dialogHeight","createPattern","patternContext","drawChat","firstLineWidth","secondLineWidth","marginLeft","drawCircle","drawCircleFromStart","setPromiseMiddleware","oldPromise","SortedDialogList","indexKey","appDialogsManager","addListDialog","isBatch","AppDialogsManager","placeholders","sortedLists","scrollables","folders","menuScrollContainer","lastActiveElements","offsets","initedListeners","loadedDialogsAtLeastOnce","onTabChange","loadDialogsRenderPromise","loadDialogsPromise","onChatsScroll","_onListLengthChange","checkIfPlaceholderNeeded","hasContacts","removeContactsPlaceholder","updateContactsLength","loadContacts","verifyPeerIdForContacts","processContact","added","setListClickListener","onChatsRegularScroll","sliceTimeout","scrollTopWas","rectContainer","rectTarget","firstY","firstElement","lastElement","elementOverflow","sliceFromStart","sliceFromEnd","deleteDialog","setOffsets","onChatsScrollTop","loadDialogs","getProxiedManagers","bottomPart","allChatsIntlElement","onStateLoaded","setFilterId","addFilter","foldersScrollable","filtersNavigationItem","setFilterIdAndChangeTab","changeFiltersAllChatsKey","getDialogIndexKey","getDialogIndexKeyByFilterId","setOnlineStatus","hasClassName","initListeners","getDialogDom","processDialogForCallStatus","setFilterUnreadCount","setLastMessageN","setUnread","validateDialogForFilter","setFiltersUnreadCount","updateDialog","setUnreadMessagesN","setDialogActive","getCachedDialogs","validateListForFilter","onFiltersLengthChange","containerToAppend","renderedFilter","unsetTyping","dialogDom","callIcon","haveFilters","renderFiltersPromise","showFiltersPromise","getNotifyPeerTypeSettings","fillConversations","getOffsetIndex","isDialogMustBeInViewport","migratedTo","testDialogForFilter","topOffset","bottomOffset","unreadSpan","unreadUnmutedCount","unreadCount","getFolderUnreadCount","generateScrollable","sortedDialogList","createChatList","clientWidth","wasShowing","cachedInfoPromise","currentOffsetIndex","needIndex","getConversationsResult","isTopEnd","cccc","offsetDialog","generateEmptyPlaceholder","classNameType","subtitleArgs","placeholderContainer","emptyDialogsPlaceholderSubtitle","usersLength","placeholderType","updatePartClassName","updateContactsLengthPromise","firstDialog","getDialogFromElement","lastDialog","withContext","openInner","lastActiveListElement","setPeerFunc","sameElement","getDialogByPeerId","setLastMessage","draftMessage","lastTimeSpan","willPrepend","videoTypes","playIcon","senderBold","setUnreadMessages","wasMuted","setStatusMessage","hasUnreadBadge","transitionDuration","disableAnimationIfRippleFound","setSendingStatus","statusSpan","isUnreadBadgeMounted","unreadBadge","hasMentionsBadge","isMentionBadgeMounted","mentionsBadge","isMention","getDialog","originalDialog","setCallStatus","START_X","wasMounted","itemProgress","groupCallActiveIcon","addDialogNew","call_not_empty","addDialogAndSetLastMessage","addDialog","captionDiv","titleSpanContainer","titleIconsPromise","titleP","rightSpan","oldTypingElement","newTypingElement","module","exports","defineProperty","enumerable","Symbol","toStringTag","__esModule","prototype","isRecordingSupported","bufferLength","encoderApplication","encoderFrameSize","encoderPath","maxFramesPerPage","mediaTrackConstraints","resampleQuality","streamPages","wavBitDepth","encodedSamplePosition","WebAssembly","clearStream","audioContext","closeAudioContext","encodeBuffers","getChannelData","encoder","postMessage","buffers","initAudioContext","initAudioGraph","scriptProcessorNode","createScriptProcessor","destination","onaudioprocess","inputBuffer","monitorGainNode","setMonitorGain","recordingGainNode","setRecordingGain","initSourceNode","loadWorker","Worker","initWorker","streamPage","storePage","recordedPages","samplePosition","page","originalSampleRate","sampleRate","wavSampleRate","onpause","resume","onresume","setTargetAtTime","onstart","destroyWorker","Function"],"sourceRoot":""}